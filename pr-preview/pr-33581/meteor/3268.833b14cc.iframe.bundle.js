/*! For license information please see 3268.833b14cc.iframe.bundle.js.LICENSE.txt */
"use strict";(self.webpackChunk_rocket_chat_meteor=self.webpackChunk_rocket_chat_meteor||[]).push([[3268],{"./client/lib/VideoConfManager.ts":function(__unused_webpack_module,__webpack_exports__,__webpack_require__){__webpack_require__.d(__webpack_exports__,{X:function(){return VideoConfManager}});var _rocket_chat_emitter__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("./node_modules/@rocket.chat/emitter/dist/index.module.js"),meteor_meteor__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__("./.storybook/mocks/meteor.js"),_app_utils_client_lib_SDKClient__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__("./app/utils/client/lib/SDKClient.ts"),_utils_getConfig__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__("./client/lib/utils/getConfig.ts"),_excluded=["timeout","acceptTimeout"];function _typeof(o){return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(o){return typeof o}:function(o){return o&&"function"==typeof Symbol&&o.constructor===Symbol&&o!==Symbol.prototype?"symbol":typeof o},_typeof(o)}function _slicedToArray(r,e){return function _arrayWithHoles(r){if(Array.isArray(r))return r}(r)||function _iterableToArrayLimit(r,l){var t=null==r?null:"undefined"!=typeof Symbol&&r[Symbol.iterator]||r["@@iterator"];if(null!=t){var e,n,i,u,a=[],f=!0,o=!1;try{if(i=(t=t.call(r)).next,0===l){if(Object(t)!==t)return;f=!1}else for(;!(f=(e=i.call(t)).done)&&(a.push(e.value),a.length!==l);f=!0);}catch(r){o=!0,n=r}finally{try{if(!f&&null!=t.return&&(u=t.return(),Object(u)!==u))return}finally{if(o)throw n}}return a}}(r,e)||_unsupportedIterableToArray(r,e)||function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function _createForOfIteratorHelper(r,e){var t="undefined"!=typeof Symbol&&r[Symbol.iterator]||r["@@iterator"];if(!t){if(Array.isArray(r)||(t=_unsupportedIterableToArray(r))||e&&r&&"number"==typeof r.length){t&&(r=t);var _n=0,F=function F(){};return{s:F,n:function n(){return _n>=r.length?{done:!0}:{done:!1,value:r[_n++]}},e:function e(r){throw r},f:F}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,a=!0,u=!1;return{s:function s(){t=t.call(r)},n:function n(){var r=t.next();return a=r.done,r},e:function e(r){u=!0,o=r},f:function f(){try{a||null==t.return||t.return()}finally{if(u)throw o}}}}function _regeneratorRuntime(){_regeneratorRuntime=function _regeneratorRuntime(){return e};var t,e={},r=Object.prototype,n=r.hasOwnProperty,o=Object.defineProperty||function(t,e,r){t[e]=r.value},i="function"==typeof Symbol?Symbol:{},a=i.iterator||"@@iterator",c=i.asyncIterator||"@@asyncIterator",u=i.toStringTag||"@@toStringTag";function define(t,e,r){return Object.defineProperty(t,e,{value:r,enumerable:!0,configurable:!0,writable:!0}),t[e]}try{define({},"")}catch(t){define=function define(t,e,r){return t[e]=r}}function wrap(t,e,r,n){var i=e&&e.prototype instanceof Generator?e:Generator,a=Object.create(i.prototype),c=new Context(n||[]);return o(a,"_invoke",{value:makeInvokeMethod(t,r,c)}),a}function tryCatch(t,e,r){try{return{type:"normal",arg:t.call(e,r)}}catch(t){return{type:"throw",arg:t}}}e.wrap=wrap;var h="suspendedStart",l="suspendedYield",f="executing",s="completed",y={};function Generator(){}function GeneratorFunction(){}function GeneratorFunctionPrototype(){}var p={};define(p,a,(function(){return this}));var d=Object.getPrototypeOf,v=d&&d(d(values([])));v&&v!==r&&n.call(v,a)&&(p=v);var g=GeneratorFunctionPrototype.prototype=Generator.prototype=Object.create(p);function defineIteratorMethods(t){["next","throw","return"].forEach((function(e){define(t,e,(function(t){return this._invoke(e,t)}))}))}function AsyncIterator(t,e){function invoke(r,o,i,a){var c=tryCatch(t[r],t,o);if("throw"!==c.type){var u=c.arg,h=u.value;return h&&"object"==_typeof(h)&&n.call(h,"__await")?e.resolve(h.__await).then((function(t){invoke("next",t,i,a)}),(function(t){invoke("throw",t,i,a)})):e.resolve(h).then((function(t){u.value=t,i(u)}),(function(t){return invoke("throw",t,i,a)}))}a(c.arg)}var r;o(this,"_invoke",{value:function value(t,n){function callInvokeWithMethodAndArg(){return new e((function(e,r){invoke(t,n,e,r)}))}return r=r?r.then(callInvokeWithMethodAndArg,callInvokeWithMethodAndArg):callInvokeWithMethodAndArg()}})}function makeInvokeMethod(e,r,n){var o=h;return function(i,a){if(o===f)throw Error("Generator is already running");if(o===s){if("throw"===i)throw a;return{value:t,done:!0}}for(n.method=i,n.arg=a;;){var c=n.delegate;if(c){var u=maybeInvokeDelegate(c,n);if(u){if(u===y)continue;return u}}if("next"===n.method)n.sent=n._sent=n.arg;else if("throw"===n.method){if(o===h)throw o=s,n.arg;n.dispatchException(n.arg)}else"return"===n.method&&n.abrupt("return",n.arg);o=f;var p=tryCatch(e,r,n);if("normal"===p.type){if(o=n.done?s:l,p.arg===y)continue;return{value:p.arg,done:n.done}}"throw"===p.type&&(o=s,n.method="throw",n.arg=p.arg)}}}function maybeInvokeDelegate(e,r){var n=r.method,o=e.iterator[n];if(o===t)return r.delegate=null,"throw"===n&&e.iterator.return&&(r.method="return",r.arg=t,maybeInvokeDelegate(e,r),"throw"===r.method)||"return"!==n&&(r.method="throw",r.arg=new TypeError("The iterator does not provide a '"+n+"' method")),y;var i=tryCatch(o,e.iterator,r.arg);if("throw"===i.type)return r.method="throw",r.arg=i.arg,r.delegate=null,y;var a=i.arg;return a?a.done?(r[e.resultName]=a.value,r.next=e.nextLoc,"return"!==r.method&&(r.method="next",r.arg=t),r.delegate=null,y):a:(r.method="throw",r.arg=new TypeError("iterator result is not an object"),r.delegate=null,y)}function pushTryEntry(t){var e={tryLoc:t[0]};1 in t&&(e.catchLoc=t[1]),2 in t&&(e.finallyLoc=t[2],e.afterLoc=t[3]),this.tryEntries.push(e)}function resetTryEntry(t){var e=t.completion||{};e.type="normal",delete e.arg,t.completion=e}function Context(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(pushTryEntry,this),this.reset(!0)}function values(e){if(e||""===e){var r=e[a];if(r)return r.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var o=-1,i=function next(){for(;++o<e.length;)if(n.call(e,o))return next.value=e[o],next.done=!1,next;return next.value=t,next.done=!0,next};return i.next=i}}throw new TypeError(_typeof(e)+" is not iterable")}return GeneratorFunction.prototype=GeneratorFunctionPrototype,o(g,"constructor",{value:GeneratorFunctionPrototype,configurable:!0}),o(GeneratorFunctionPrototype,"constructor",{value:GeneratorFunction,configurable:!0}),GeneratorFunction.displayName=define(GeneratorFunctionPrototype,u,"GeneratorFunction"),e.isGeneratorFunction=function(t){var e="function"==typeof t&&t.constructor;return!!e&&(e===GeneratorFunction||"GeneratorFunction"===(e.displayName||e.name))},e.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,GeneratorFunctionPrototype):(t.__proto__=GeneratorFunctionPrototype,define(t,u,"GeneratorFunction")),t.prototype=Object.create(g),t},e.awrap=function(t){return{__await:t}},defineIteratorMethods(AsyncIterator.prototype),define(AsyncIterator.prototype,c,(function(){return this})),e.AsyncIterator=AsyncIterator,e.async=function(t,r,n,o,i){void 0===i&&(i=Promise);var a=new AsyncIterator(wrap(t,r,n,o),i);return e.isGeneratorFunction(r)?a:a.next().then((function(t){return t.done?t.value:a.next()}))},defineIteratorMethods(g),define(g,u,"Generator"),define(g,a,(function(){return this})),define(g,"toString",(function(){return"[object Generator]"})),e.keys=function(t){var e=Object(t),r=[];for(var n in e)r.push(n);return r.reverse(),function next(){for(;r.length;){var t=r.pop();if(t in e)return next.value=t,next.done=!1,next}return next.done=!0,next}},e.values=values,Context.prototype={constructor:Context,reset:function reset(e){if(this.prev=0,this.next=0,this.sent=this._sent=t,this.done=!1,this.delegate=null,this.method="next",this.arg=t,this.tryEntries.forEach(resetTryEntry),!e)for(var r in this)"t"===r.charAt(0)&&n.call(this,r)&&!isNaN(+r.slice(1))&&(this[r]=t)},stop:function stop(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function dispatchException(e){if(this.done)throw e;var r=this;function handle(n,o){return a.type="throw",a.arg=e,r.next=n,o&&(r.method="next",r.arg=t),!!o}for(var o=this.tryEntries.length-1;o>=0;--o){var i=this.tryEntries[o],a=i.completion;if("root"===i.tryLoc)return handle("end");if(i.tryLoc<=this.prev){var c=n.call(i,"catchLoc"),u=n.call(i,"finallyLoc");if(c&&u){if(this.prev<i.catchLoc)return handle(i.catchLoc,!0);if(this.prev<i.finallyLoc)return handle(i.finallyLoc)}else if(c){if(this.prev<i.catchLoc)return handle(i.catchLoc,!0)}else{if(!u)throw Error("try statement without catch or finally");if(this.prev<i.finallyLoc)return handle(i.finallyLoc)}}}},abrupt:function abrupt(t,e){for(var r=this.tryEntries.length-1;r>=0;--r){var o=this.tryEntries[r];if(o.tryLoc<=this.prev&&n.call(o,"finallyLoc")&&this.prev<o.finallyLoc){var i=o;break}}i&&("break"===t||"continue"===t)&&i.tryLoc<=e&&e<=i.finallyLoc&&(i=null);var a=i?i.completion:{};return a.type=t,a.arg=e,i?(this.method="next",this.next=i.finallyLoc,y):this.complete(a)},complete:function complete(t,e){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&e&&(this.next=e),y},finish:function finish(t){for(var e=this.tryEntries.length-1;e>=0;--e){var r=this.tryEntries[e];if(r.finallyLoc===t)return this.complete(r.completion,r.afterLoc),resetTryEntry(r),y}},catch:function _catch(t){for(var e=this.tryEntries.length-1;e>=0;--e){var r=this.tryEntries[e];if(r.tryLoc===t){var n=r.completion;if("throw"===n.type){var o=n.arg;resetTryEntry(r)}return o}}throw Error("illegal catch attempt")},delegateYield:function delegateYield(e,r,n){return this.delegate={iterator:values(e),resultName:r,nextLoc:n},"next"===this.method&&(this.arg=t),y}},e}function asyncGeneratorStep(n,t,e,r,o,a,c){try{var i=n[a](c),u=i.value}catch(n){return void e(n)}i.done?t(u):Promise.resolve(u).then(r,o)}function _asyncToGenerator(n){return function(){var t=this,e=arguments;return new Promise((function(r,o){var a=n.apply(t,e);function _next(n){asyncGeneratorStep(a,r,o,_next,_throw,"next",n)}function _throw(n){asyncGeneratorStep(a,r,o,_next,_throw,"throw",n)}_next(void 0)}))}}function ownKeys(e,r){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);r&&(o=o.filter((function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable}))),t.push.apply(t,o)}return t}function _objectSpread(e){for(var r=1;r<arguments.length;r++){var t=null!=arguments[r]?arguments[r]:{};r%2?ownKeys(Object(t),!0).forEach((function(r){_defineProperty(e,r,t[r])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):ownKeys(Object(t)).forEach((function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))}))}return e}function _toConsumableArray(r){return function _arrayWithoutHoles(r){if(Array.isArray(r))return _arrayLikeToArray(r)}(r)||function _iterableToArray(r){if("undefined"!=typeof Symbol&&null!=r[Symbol.iterator]||null!=r["@@iterator"])return Array.from(r)}(r)||_unsupportedIterableToArray(r)||function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function _unsupportedIterableToArray(r,a){if(r){if("string"==typeof r)return _arrayLikeToArray(r,a);var t={}.toString.call(r).slice(8,-1);return"Object"===t&&r.constructor&&(t=r.constructor.name),"Map"===t||"Set"===t?Array.from(r):"Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t)?_arrayLikeToArray(r,a):void 0}}function _arrayLikeToArray(r,a){(null==a||a>r.length)&&(a=r.length);for(var e=0,n=Array(a);e<a;e++)n[e]=r[e];return n}function _defineProperties(e,r){for(var t=0;t<r.length;t++){var o=r[t];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,_toPropertyKey(o.key),o)}}function _setPrototypeOf(t,e){return _setPrototypeOf=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t},_setPrototypeOf(t,e)}function _createSuper(t){var r=_isNativeReflectConstruct();return function(){var e,o=_getPrototypeOf(t);if(r){var s=_getPrototypeOf(this).constructor;e=Reflect.construct(o,arguments,s)}else e=o.apply(this,arguments);return function _possibleConstructorReturn(t,e){if(e&&("object"==_typeof(e)||"function"==typeof e))return e;if(void 0!==e)throw new TypeError("Derived constructors may only return object or undefined");return _assertThisInitialized(t)}(this,e)}}function _assertThisInitialized(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function _isNativeReflectConstruct(){try{var t=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(t){}return(_isNativeReflectConstruct=function _isNativeReflectConstruct(){return!!t})()}function _getPrototypeOf(t){return _getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(t){return t.__proto__||Object.getPrototypeOf(t)},_getPrototypeOf(t)}function _defineProperty(e,r,t){return(r=_toPropertyKey(r))in e?Object.defineProperty(e,r,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[r]=t,e}function _toPropertyKey(t){var i=function _toPrimitive(t,r){if("object"!=_typeof(t)||!t)return t;var e=t[Symbol.toPrimitive];if(void 0!==e){var i=e.call(t,r||"default");if("object"!=_typeof(i))return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===r?String:Number)(t)}(t,"string");return"symbol"==_typeof(i)?i:i+""}var debug=!(!(0,_utils_getConfig__WEBPACK_IMPORTED_MODULE_3__.z)("debug")&&!(0,_utils_getConfig__WEBPACK_IMPORTED_MODULE_3__.z)("debug-VideoConf")),VideoConfManager=new(function(_Emitter){!function _inherits(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),Object.defineProperty(t,"prototype",{writable:!1}),e&&_setPrototypeOf(t,e)}(VideoConfManager,_Emitter);var _connectUser,_notifyUser,_onVideoConfNotification,_giveUp,_callUser,_joinCall,_loadCapabilities,_startCall,_super=_createSuper(VideoConfManager);function VideoConfManager(){var _this;return function _classCallCheck(a,n){if(!(a instanceof n))throw new TypeError("Cannot call a class as a function")}(this,VideoConfManager),_defineProperty(_assertThisInitialized(_this=_super.call(this)),"userId",void 0),_defineProperty(_assertThisInitialized(_this),"currentCallHandler",void 0),_defineProperty(_assertThisInitialized(_this),"currentCallData",void 0),_defineProperty(_assertThisInitialized(_this),"startingNewCall",!1),_defineProperty(_assertThisInitialized(_this),"hooks",[]),_defineProperty(_assertThisInitialized(_this),"incomingDirectCalls",void 0),_defineProperty(_assertThisInitialized(_this),"dismissedCalls",void 0),_defineProperty(_assertThisInitialized(_this),"_preferences",void 0),_defineProperty(_assertThisInitialized(_this),"_capabilities",void 0),_this.incomingDirectCalls=new Map,_this.dismissedCalls=new Set,_this._preferences={mic:!0,cam:!1},_this._capabilities={},_this}return function _createClass(e,r,t){return r&&_defineProperties(e.prototype,r),t&&_defineProperties(e,t),Object.defineProperty(e,"prototype",{writable:!1}),e}(VideoConfManager,[{key:"preferences",get:function get(){return this._preferences}},{key:"capabilities",get:function get(){return this._capabilities}},{key:"isBusy",value:function isBusy(){return!!this.startingNewCall||this.isCalling()}},{key:"isRinging",value:function isRinging(){var _this2=this;return _toConsumableArray(this.incomingDirectCalls.values()).some((function(_ref){var callId=_ref.callId;return!_this2.isCallDismissed(callId)}))}},{key:"isCalling",value:function isCalling(){return!!(this.currentCallHandler||this.currentCallData&&!this.currentCallData.joined)}},{key:"getIncomingDirectCalls",value:function getIncomingDirectCalls(){var _this3=this;return _toConsumableArray(this.incomingDirectCalls.values()).filter((function(call){return!call.acceptTimeout})).map((function(_ref2){_ref2.timeout,_ref2.acceptTimeout;var call=function _objectWithoutProperties(e,t){if(null==e)return{};var o,r,i=function _objectWithoutPropertiesLoose(r,e){if(null==r)return{};var t={};for(var n in r)if({}.hasOwnProperty.call(r,n)){if(e.includes(n))continue;t[n]=r[n]}return t}(e,t);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);for(r=0;r<s.length;r++)o=s[r],t.includes(o)||{}.propertyIsEnumerable.call(e,o)&&(i[o]=e[o])}return i}(_ref2,_excluded);return _objectSpread(_objectSpread({},call),{},{dismissed:_this3.isCallDismissed(call.callId)})}))}},{key:"startCall",value:(_startCall=_asyncToGenerator(_regeneratorRuntime().mark((function _callee(roomId,title){var _yield$sdk$rest$post$,data,_this4=this;return _regeneratorRuntime().wrap((function _callee$(_context){for(;;)switch(_context.prev=_context.next){case 0:if(this.userId&&!this.isBusy()){_context.next=2;break}throw new Error("Video manager is busy.");case 2:return debug&&console.log("[VideoConf] Starting new call on room ".concat(roomId)),this.startingNewCall=!0,this.emit("calling/changed"),_context.next=7,_app_utils_client_lib_SDKClient__WEBPACK_IMPORTED_MODULE_2__.sdk.rest.post("/v1/video-conference.start",{roomId:roomId,title:title,allowRinging:!0}).catch((function(e){var _e$xhr;return debug&&console.error("[VideoConf] Failed to start new call on room ".concat(roomId)),_this4.startingNewCall=!1,_this4.emit("calling/changed"),_this4.emit("start/error",{error:(null==e||null===(_e$xhr=e.xhr)||void 0===_e$xhr||null===(_e$xhr=_e$xhr.responseJSON)||void 0===_e$xhr?void 0:_e$xhr.error)||"unknown-error"}),Promise.reject(e)}));case 7:_yield$sdk$rest$post$=_context.sent,data=_yield$sdk$rest$post$.data,this.startingNewCall=!1,this.emit("calling/changed"),"direct"!==data.type&&this.emit("calling/ended"),_context.t0=data.type,_context.next="direct"===_context.t0?15:"videoconference"===_context.t0?16:"livechat"===_context.t0?17:18;break;case 15:return _context.abrupt("return",this.callUser({uid:data.calleeId,rid:roomId,callId:data.callId}));case 16:case 17:return _context.abrupt("return",this.joinCall(data.callId));case 18:case"end":return _context.stop()}}),_callee,this)}))),function startCall(_x,_x2){return _startCall.apply(this,arguments)})},{key:"acceptIncomingCall",value:function acceptIncomingCall(callId){var _this5=this,callData=this.incomingDirectCalls.get(callId);if(!callData)throw new Error("Unable to find accepted call information.");callData.acceptTimeout?debug&&console.log("[VideoConf] We're already trying to accept call ".concat(callId,".")):(debug&&console.log("[VideoConf] Accepting incoming call ".concat(callId,".")),callData.timeout&&(clearTimeout(callData.timeout),this.setIncomingCallAttribute(callId,"timeout",void 0)),this.dismissIncomingCall(callId),this.setIncomingCallAttribute(callId,"acceptTimeout",setTimeout((function(){var updatedCallData=_this5.incomingDirectCalls.get(callId);null!=updatedCallData&&updatedCallData.acceptTimeout&&(debug&&console.log("[VideoConf] Attempt to accept call has timed out."),_this5.removeIncomingCall(callId),_this5.emit("direct/failed",{callId:callId,uid:callData.uid,rid:callData.rid}))}),5e3)),this.emit("incoming/changed"),debug&&console.log("[VideoConf] Notifying user ".concat(callData.uid," that we accept their call.")),this.userId&&this.notifyUser(callData.uid,"accepted",{callId:callId,uid:this.userId,rid:callData.rid}))}},{key:"rejectIncomingCall",value:function rejectIncomingCall(callId){this.dismissIncomingCall(callId);var callData=this.incomingDirectCalls.get(callId);callData&&(this.userId&&this.notifyUser(callData.uid,"rejected",{callId:callId,uid:this.userId,rid:callData.rid}),this.loseIncomingCall(callId))}},{key:"dismissedIncomingCalls",value:function dismissedIncomingCalls(){var _this6=this;_toConsumableArray(this.incomingDirectCalls.keys()).some((function(callId){return _this6.dismissedIncomingCallHelper(callId)}))&&(this.emit("ringing/changed"),this.emit("incoming/changed"))}},{key:"loadCapabilities",value:(_loadCapabilities=_asyncToGenerator(_regeneratorRuntime().mark((function _callee2(){var _yield$sdk$rest$get$c,capabilities;return _regeneratorRuntime().wrap((function _callee2$(_context2){for(;;)switch(_context2.prev=_context2.next){case 0:return _context2.next=2,_app_utils_client_lib_SDKClient__WEBPACK_IMPORTED_MODULE_2__.sdk.rest.get("/v1/video-conference.capabilities").catch((function(e){return debug&&console.error("[VideoConf] Failed to load video conference capabilities"),Promise.reject(e)}));case 2:_yield$sdk$rest$get$c=_context2.sent,capabilities=_yield$sdk$rest$get$c.capabilities,this._capabilities=capabilities||{},this.emit("capabilities/changed");case 6:case"end":return _context2.stop()}}),_callee2,this)}))),function loadCapabilities(){return _loadCapabilities.apply(this,arguments)})},{key:"setIncomingCallAttribute",value:function setIncomingCallAttribute(callId,attributeName,value){var callData=this.incomingDirectCalls.get(callId);if(callData){var newData=_objectSpread({},callData);void 0===value?delete newData[attributeName]:newData[attributeName]=value,debug&&console.log('[VideoConf] Updating attribute "'.concat(attributeName,'" of call "').concat(callId,'".')),this.incomingDirectCalls.set(callId,newData)}else debug&&console.error('[VideoConf] Cannot change attribute "'.concat(attributeName,'" of unknown call "').concat(callId,'".'))}},{key:"dismissedIncomingCallHelper",value:function dismissedIncomingCallHelper(callId){var _this7=this;return!this.isCallDismissed(callId)&&(debug&&console.log("[VideoConf] Dismissing call ".concat(callId)),this.dismissedCalls.add(callId),setTimeout((function(){return _this7.dismissedCalls.delete(callId)}),2e5),this.incomingDirectCalls.has(callId))}},{key:"dismissIncomingCall",value:function dismissIncomingCall(callId){return!!this.dismissedIncomingCallHelper(callId)&&(this.emit("ringing/changed"),this.emit("incoming/changed"),!0)}},{key:"updateUser",value:function updateUser(){var userId=meteor_meteor__WEBPACK_IMPORTED_MODULE_1__.fj.userId();this.userId!==userId?(debug&&console.log("[VideoConf] Logged user has changed."),this.userId&&this.disconnect(),userId&&this.connectUser(userId)):debug&&console.log("[VideoConf] Logged user has not changed, so we're not changing the hooks.")}},{key:"changePreference",value:function changePreference(key,value){this._preferences[key]=value,this.emit("preference/changed",{key:key,value:value})}},{key:"setPreferences",value:function setPreferences(prefs){for(var key in prefs)if(prefs.hasOwnProperty(key)){var prefKey=key;this.changePreference(prefKey,prefs[prefKey])}}},{key:"joinCall",value:(_joinCall=_asyncToGenerator(_regeneratorRuntime().mark((function _callee3(callId){var data,params,_yield$sdk$rest$post$2,url,providerName,_this8=this;return _regeneratorRuntime().wrap((function _callee3$(_context3){for(;;)switch(_context3.prev=_context3.next){case 0:return debug&&console.log("[VideoConf] Joining call ".concat(callId,".")),this.incomingDirectCalls.has(callId)&&(null!=(data=this.incomingDirectCalls.get(callId))&&data.acceptTimeout&&(debug&&console.log("[VideoConf] Clearing acceptance timeout"),clearTimeout(data.acceptTimeout)),this.removeIncomingCall(callId)),params={callId:callId,state:_objectSpread(_objectSpread({},void 0!==this._preferences.mic?{mic:this._preferences.mic}:{}),void 0!==this._preferences.cam?{cam:this._preferences.cam}:{})},_context3.next=5,_app_utils_client_lib_SDKClient__WEBPACK_IMPORTED_MODULE_2__.sdk.rest.post("/v1/video-conference.join",params).catch((function(e){var _e$xhr2;return debug&&console.error("[VideoConf] Failed to join call ".concat(callId)),_this8.emit("join/error",{error:(null==e||null===(_e$xhr2=e.xhr)||void 0===_e$xhr2||null===(_e$xhr2=_e$xhr2.responseJSON)||void 0===_e$xhr2?void 0:_e$xhr2.error)||"unknown-error"}),Promise.reject(e)}));case 5:if(_yield$sdk$rest$post$2=_context3.sent,url=_yield$sdk$rest$post$2.url,providerName=_yield$sdk$rest$post$2.providerName,url){_context3.next=10;break}throw new Error("Failed to get video conference URL.");case 10:debug&&console.log("[VideoConf] Opening ".concat(url,".")),this.emit("call/join",{url:url,callId:callId,providerName:providerName});case 12:case"end":return _context3.stop()}}),_callee3,this)}))),function joinCall(_x3){return _joinCall.apply(this,arguments)})},{key:"abortCall",value:function abortCall(){this.currentCallData&&this.giveUp(this.currentCallData)}},{key:"rejectIncomingCallsFromUser",value:function rejectIncomingCallsFromUser(userId){var _step,_iterator=_createForOfIteratorHelper(this.incomingDirectCalls);try{for(_iterator.s();!(_step=_iterator.n()).done;){var _step$value$=_slicedToArray(_step.value,2)[1],callId=_step$value$.callId;userId===_step$value$.uid&&(debug&&console.log("[VideoConf] Rejecting old incoming call from user ".concat(userId)),this.rejectIncomingCall(callId))}}catch(err){_iterator.e(err)}finally{_iterator.f()}}},{key:"callUser",value:(_callUser=_asyncToGenerator(_regeneratorRuntime().mark((function _callee4(_ref3){var uid,rid,callId,attempt,_this9=this;return _regeneratorRuntime().wrap((function _callee4$(_context4){for(;;)switch(_context4.prev=_context4.next){case 0:if(uid=_ref3.uid,rid=_ref3.rid,callId=_ref3.callId,!this.currentCallHandler&&!this.currentCallData){_context4.next=3;break}throw new Error("Video Conference State Error.");case 3:attempt=1,this.currentCallData={callId:callId,rid:rid,uid:uid},this.currentCallHandler=setInterval((function(){_this9.currentCallHandler?++attempt>10?_this9.giveUp({uid:uid,rid:rid,callId:callId}):(debug&&console.log("[VideoConf] Ringing user ".concat(uid,", attempt number ").concat(attempt,".")),_this9.userId&&_this9.notifyUser(uid,"call",{uid:_this9.userId,rid:rid,callId:callId})):debug&&console.warn("[VideoConf] Ringing interval was not properly cleared.")}),3e3),this.emit("calling/changed"),debug&&console.log("[VideoConf] Ringing user ".concat(uid," for the first time.")),this.userId&&this.notifyUser(uid,"call",{uid:this.userId,rid:rid,callId:callId});case 9:case"end":return _context4.stop()}}),_callee4,this)}))),function callUser(_x4){return _callUser.apply(this,arguments)})},{key:"giveUp",value:(_giveUp=_asyncToGenerator(_regeneratorRuntime().mark((function _callee5(_ref4){var _this$currentCallData,uid,rid,callId,joined;return _regeneratorRuntime().wrap((function _callee5$(_context5){for(;;)switch(_context5.prev=_context5.next){case 0:if(uid=_ref4.uid,rid=_ref4.rid,callId=_ref4.callId,joined=null===(_this$currentCallData=this.currentCallData)||void 0===_this$currentCallData?void 0:_this$currentCallData.joined,debug&&console.log("[VideoConf] Stop ringing user ".concat(uid,".")),this.currentCallHandler&&(clearInterval(this.currentCallHandler),this.currentCallHandler=void 0,this.currentCallData=void 0,this.emit("calling/changed")),debug&&console.log("[VideoConf] Notifying user ".concat(uid," that we are no longer calling.")),this.userId&&this.notifyUser(uid,"canceled",{uid:this.userId,rid:rid,callId:callId}),this.emit("direct/cancel",{uid:uid,rid:rid,callId:callId}),this.emit("direct/stopped",{uid:uid,rid:rid,callId:callId}),!joined){_context5.next=10;break}return _context5.abrupt("return");case 10:_app_utils_client_lib_SDKClient__WEBPACK_IMPORTED_MODULE_2__.sdk.rest.post("/v1/video-conference.cancel",{callId:callId});case 11:case"end":return _context5.stop()}}),_callee5,this)}))),function giveUp(_x5){return _giveUp.apply(this,arguments)})},{key:"disconnect",value:function disconnect(){debug&&console.log("[VideoConf] disconnecting user ".concat(this.userId));var _step2,_iterator2=_createForOfIteratorHelper(this.hooks);try{for(_iterator2.s();!(_step2=_iterator2.n()).done;){(0,_step2.value)()}}catch(err){_iterator2.e(err)}finally{_iterator2.f()}this.hooks=[],this.currentCallHandler&&(clearInterval(this.currentCallHandler),this.currentCallHandler=void 0),this.incomingDirectCalls.forEach((function(call){call.timeout&&clearTimeout(call.timeout),call.acceptTimeout&&clearTimeout(call.acceptTimeout)})),this.incomingDirectCalls.clear(),this.dismissedCalls.clear(),this.currentCallData=void 0,this._preferences={},this.emit("incoming/changed"),this.emit("ringing/changed"),this.emit("calling/changed")}},{key:"onVideoConfNotification",value:(_onVideoConfNotification=_asyncToGenerator(_regeneratorRuntime().mark((function _callee6(_ref5){var action,params;return _regeneratorRuntime().wrap((function _callee6$(_context6){for(;;)switch(_context6.prev=_context6.next){case 0:if(action=_ref5.action,params=_ref5.params,action&&"string"==typeof action){_context6.next=4;break}return debug&&console.error("[VideoConf] Invalid action received."),_context6.abrupt("return");case 4:if(params&&"object"===_typeof(params)&&params.callId&&params.uid&&params.rid){_context6.next=7;break}return debug&&console.error("[VideoConf] Invalid params received."),_context6.abrupt("return");case 7:_context6.t0=action,_context6.next="call"===_context6.t0?10:"canceled"===_context6.t0?11:"accepted"===_context6.t0?12:"rejected"===_context6.t0?13:"confirmed"===_context6.t0?14:"join"===_context6.t0?15:"end"===_context6.t0?16:17;break;case 10:return _context6.abrupt("return",this.onDirectCall(params));case 11:return _context6.abrupt("return",this.onDirectCallCanceled(params));case 12:return _context6.abrupt("return",this.onDirectCallAccepted(params));case 13:return _context6.abrupt("return",this.onDirectCallRejected(params));case 14:return _context6.abrupt("return",this.onDirectCallConfirmed(params));case 15:return _context6.abrupt("return",this.onDirectCallJoined(params));case 16:return _context6.abrupt("return",this.onDirectCallEnded(params));case 17:case"end":return _context6.stop()}}),_callee6,this)}))),function onVideoConfNotification(_x6){return _onVideoConfNotification.apply(this,arguments)})},{key:"notifyUser",value:(_notifyUser=_asyncToGenerator(_regeneratorRuntime().mark((function _callee7(uid,action,params){return _regeneratorRuntime().wrap((function _callee7$(_context7){for(;;)switch(_context7.prev=_context7.next){case 0:return _context7.abrupt("return",_app_utils_client_lib_SDKClient__WEBPACK_IMPORTED_MODULE_2__.sdk.publish("notify-user",["".concat(uid,"/video-conference"),{action:action,params:params}]));case 1:case"end":return _context7.stop()}}),_callee7)}))),function notifyUser(_x7,_x8,_x9){return _notifyUser.apply(this,arguments)})},{key:"connectUser",value:(_connectUser=_asyncToGenerator(_regeneratorRuntime().mark((function _callee8(userId){var _sdk$stream,stop,ready,_this10=this;return _regeneratorRuntime().wrap((function _callee8$(_context8){for(;;)switch(_context8.prev=_context8.next){case 0:return debug&&console.log("[VideoConf] connecting user ".concat(userId)),this.userId=userId,_sdk$stream=_app_utils_client_lib_SDKClient__WEBPACK_IMPORTED_MODULE_2__.sdk.stream("notify-user",["".concat(userId,"/video-conference")],(function(data){return _this10.onVideoConfNotification(data)})),stop=_sdk$stream.stop,ready=_sdk$stream.ready,_context8.next=5,ready();case 5:this.hooks.push(stop);case 6:case"end":return _context8.stop()}}),_callee8,this)}))),function connectUser(_x10){return _connectUser.apply(this,arguments)})},{key:"abortIncomingCall",value:function abortIncomingCall(callId){var _this$incomingDirectC;null!==(_this$incomingDirectC=this.incomingDirectCalls.get(callId))&&void 0!==_this$incomingDirectC&&_this$incomingDirectC.acceptTimeout||(debug&&console.log("[VideoConf] Canceling call ".concat(callId," due to ringing timeout.")),this.loseIncomingCall(callId))}},{key:"loseIncomingCall",value:function loseIncomingCall(callId){var lostCall=this.incomingDirectCalls.get(callId);lostCall?(this.removeIncomingCall(callId),debug&&console.log("[VideoConf] Call ".concat(callId," from ").concat(lostCall.uid," was lost.")),this.emit("direct/lost",{callId:callId,uid:lostCall.uid,rid:lostCall.rid})):debug&&console.warn("[VideoConf] Unable to cancel ".concat(callId," because we have no information about it."))}},{key:"removeIncomingCall",value:function removeIncomingCall(callId){if(debug&&console.log('[VideoConf] Removing call with id "'.concat(callId,'" from Incoming Calls list.')),this.incomingDirectCalls.has(callId)){var isRinging=this.isRinging(),callData=this.incomingDirectCalls.get(callId);null!=callData&&callData.timeout&&clearTimeout(callData.timeout),this.incomingDirectCalls.delete(callId),this.emit("incoming/changed"),isRinging!==this.isRinging()&&this.emit("ringing/changed")}}},{key:"createAbortTimeout",value:function createAbortTimeout(callId){var _this11=this;return setTimeout((function(){return _this11.abortIncomingCall(callId)}),1e4)}},{key:"startNewIncomingCall",value:function startNewIncomingCall(_ref6){var callId=_ref6.callId,uid=_ref6.uid,rid=_ref6.rid;this.isCallDismissed(callId)?debug&&console.log("[VideoConf] Ignoring dismissed call."):(this.rejectIncomingCallsFromUser(uid),debug&&console.log("[VideoConf] Storing this new call information."),this.incomingDirectCalls.set(callId,{callId:callId,uid:uid,rid:rid,timeout:this.createAbortTimeout(callId)}),this.emit("incoming/changed"),this.emit("ringing/changed"),this.emit("direct/ringing",{callId:callId,uid:uid,rid:rid}))}},{key:"refreshExistingIncomingCall",value:function refreshExistingIncomingCall(_ref7){var callId=_ref7.callId,uid=_ref7.uid,rid=_ref7.rid,existingData=this.incomingDirectCalls.get(callId);if(!existingData)throw new Error("Video Conference Manager State Error");debug&&console.log("[VideoConf] Resetting call timeout."),existingData.timeout&&clearTimeout(existingData.timeout),existingData.timeout=this.createAbortTimeout(callId),this.isCallDismissed(callId)||this.emit("direct/ringing",{callId:callId,uid:uid,rid:rid})}},{key:"onDirectCall",value:function onDirectCall(_ref8){var _this$incomingDirectC2,callId=_ref8.callId,uid=_ref8.uid,rid=_ref8.rid;null!==(_this$incomingDirectC2=this.incomingDirectCalls.get(callId))&&void 0!==_this$incomingDirectC2&&_this$incomingDirectC2.acceptTimeout||(debug&&console.log("[VideoConf] User ".concat(uid," is ringing with call ").concat(callId,".")),this.incomingDirectCalls.has(callId)?this.refreshExistingIncomingCall({callId:callId,uid:uid,rid:rid}):this.startNewIncomingCall({callId:callId,uid:uid,rid:rid}))}},{key:"onDirectCallCanceled",value:function onDirectCallCanceled(_ref9){var callId=_ref9.callId;debug&&console.log("[VideoConf] Call ".concat(callId," was canceled by the remote user."));var callData=this.incomingDirectCalls.get(callId);null!=callData&&callData.acceptTimeout&&(clearTimeout(callData.acceptTimeout),this.setIncomingCallAttribute(callId,"acceptTimeout",void 0)),this.loseIncomingCall(callId)}},{key:"onDirectCallAccepted",value:function onDirectCallAccepted(params){var _this$currentCallData2,skipConfirmation=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(params.callId&&params.callId===(null===(_this$currentCallData2=this.currentCallData)||void 0===_this$currentCallData2?void 0:_this$currentCallData2.callId)){debug&&console.log("[VideoConf] User ".concat(params.uid," has accepted our call ").concat(params.callId,".")),this.currentCallHandler&&(clearInterval(this.currentCallHandler),this.currentCallHandler=void 0);var callData=this.currentCallData;this.emit("direct/accepted",params),this.emit("direct/stopped",params),this.currentCallData=void 0,this.emit("calling/changed"),callData.joined||this.joinCall(params.callId),skipConfirmation||(debug&&console.log("[VideoConf] Notifying user ".concat(callData.uid," that they can join the call now.")),this.userId&&this.notifyUser(callData.uid,"confirmed",{callId:callData.callId,uid:this.userId,rid:callData.rid}))}else debug&&console.log("[VideoConf] User ".concat(params.uid," has accepted a call ").concat(params.callId," from us, but we're not calling."))}},{key:"onDirectCallConfirmed",value:function onDirectCallConfirmed(params){var _this$incomingDirectC3;params.callId&&null!==(_this$incomingDirectC3=this.incomingDirectCalls.get(params.callId))&&void 0!==_this$incomingDirectC3&&_this$incomingDirectC3.acceptTimeout?this.joinCall(params.callId):debug&&console.log("[VideoConf] User ".concat(params.uid," confirmed we can join ").concat(params.callId," but we aren't trying to join it."))}},{key:"onDirectCallJoined",value:function onDirectCallJoined(params){if(params.callId){var _this$currentCallData3;if(params.uid===this.userId)return(null===(_this$currentCallData3=this.currentCallData)||void 0===_this$currentCallData3?void 0:_this$currentCallData3.callId)===params.callId?(debug&&console.log("[VideoConf] We joined our own call (".concat(this.userId,") from somewhere else. Flagging the call appropriatelly.")),this.currentCallData.joined=!0,void this.emit("calling/changed")):void(this.incomingDirectCalls.has(params.callId)&&(debug&&console.log("[VideoConf] We joined the call ".concat(params.callId," from somewhere else. Dismissing it.")),this.dismissIncomingCall(params.callId),this.loseIncomingCall(params.callId)));debug&&console.log("[VideoConf] User ".concat(params.uid," has joined a call we started ").concat(params.callId,".")),this.onDirectCallAccepted(params,!0)}else debug&&console.log("[VideoConf] Invalid 'video-conference.join' event received: ".concat(params.callId,", ").concat(params.uid,"."))}},{key:"onDirectCallEnded",value:function onDirectCallEnded(params){var _this$currentCallData4;if(params.callId){var callData=this.incomingDirectCalls.get(params.callId);if(callData)return debug&&console.log("[VideoConf] Incoming call ended by the server: ".concat(params.callId,".")),callData.acceptTimeout&&(clearTimeout(callData.acceptTimeout),this.setIncomingCallAttribute(params.callId,"acceptTimeout",void 0)),void this.loseIncomingCall(params.callId);(null===(_this$currentCallData4=this.currentCallData)||void 0===_this$currentCallData4?void 0:_this$currentCallData4.callId)===params.callId?(debug&&console.log("[VideoConf] Outgoing call ended by the server: ".concat(params.callId,".")),this.currentCallData=void 0,this.currentCallHandler&&(clearInterval(this.currentCallHandler),this.currentCallHandler=void 0,this.emit("calling/changed"),this.emit("direct/stopped",params))):debug&&console.log("[VideoConf] Server sent a call ended event for a call we're not aware of: ".concat(params.callId,"."))}else debug&&console.log("[VideoConf] Invalid 'video-conference.end' event received: ".concat(params.callId,", ").concat(params.uid,"."))}},{key:"onDirectCallRejected",value:function onDirectCallRejected(params){var _this$currentCallData5;if(params.callId&&params.callId===(null===(_this$currentCallData5=this.currentCallData)||void 0===_this$currentCallData5?void 0:_this$currentCallData5.callId)){debug&&console.log("[VideoConf] User ".concat(params.uid," has rejected our call ").concat(params.callId,".")),this.currentCallHandler&&(clearInterval(this.currentCallHandler),this.currentCallHandler=void 0);var joined=this.currentCallData.joined;this.emit("direct/cancel",params),this.currentCallData=void 0,this.emit("direct/stopped",params),this.emit("calling/changed"),joined||_app_utils_client_lib_SDKClient__WEBPACK_IMPORTED_MODULE_2__.sdk.rest.post("/v1/video-conference.cancel",{callId:params.callId})}else debug&&console.log("[VideoConf] User ".concat(params.uid," has rejected a call ").concat(params.callId," from us, but we're not calling."))}},{key:"isCallDismissed",value:function isCallDismissed(callId){return this.dismissedCalls.has(callId)}}]),VideoConfManager}(_rocket_chat_emitter__WEBPACK_IMPORTED_MODULE_0__.v));meteor_meteor__WEBPACK_IMPORTED_MODULE_1__.fj.startup((function(){return meteor_meteor__WEBPACK_IMPORTED_MODULE_1__.JD.autorun((function(){return VideoConfManager.updateUser()}))}))}}]);