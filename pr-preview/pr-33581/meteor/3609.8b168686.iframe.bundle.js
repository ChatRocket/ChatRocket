/*! For license information please see 3609.8b168686.iframe.bundle.js.LICENSE.txt */
(self.webpackChunk_rocket_chat_meteor=self.webpackChunk_rocket_chat_meteor||[]).push([[3609,6768],{"./app/e2e/client/E2EEState.ts":function(__unused_webpack_module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.d(__webpack_exports__,{l:function(){return E2EEState}});var E2EEState=function(E2EEState){return E2EEState.NOT_STARTED="NOT_STARTED",E2EEState.DISABLED="DISABLED",E2EEState.LOADING_KEYS="LOADING_KEYS",E2EEState.READY="READY",E2EEState.SAVE_PASSWORD="SAVE_PASSWORD",E2EEState.ENTER_PASSWORD="ENTER_PASSWORD",E2EEState.ERROR="ERROR",E2EEState}({})},"./app/e2e/client/E2ERoomState.ts":function(__unused_webpack_module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.d(__webpack_exports__,{h:function(){return E2ERoomState}});var E2ERoomState=function(E2ERoomState){return E2ERoomState.NO_PASSWORD_SET="NO_PASSWORD_SET",E2ERoomState.NOT_STARTED="NOT_STARTED",E2ERoomState.DISABLED="DISABLED",E2ERoomState.HANDSHAKE="HANDSHAKE",E2ERoomState.ESTABLISHING="ESTABLISHING",E2ERoomState.CREATING_KEYS="CREATING_KEYS",E2ERoomState.WAITING_KEYS="WAITING_KEYS",E2ERoomState.KEYS_RECEIVED="KEYS_RECEIVED",E2ERoomState.READY="READY",E2ERoomState.ERROR="ERROR",E2ERoomState}({})},"./app/e2e/client/rocketchat.e2e.ts":function(__unused_webpack_module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.d(__webpack_exports__,{D:function(){return e2e}});var querystring=__webpack_require__("./node_modules/querystring/index.js"),url_url=__webpack_require__("./node_modules/url/url.js"),dist=__webpack_require__("../../packages/core-typings/dist/index.js"),index_module=__webpack_require__("./node_modules/@rocket.chat/emitter/dist/index.module.js"),ejson=__webpack_require__("./node_modules/ejson/index.js"),ejson_default=__webpack_require__.n(ejson),lodash=__webpack_require__("./node_modules/lodash/lodash.js"),lodash_default=__webpack_require__.n(lodash),meteor=__webpack_require__("./.storybook/mocks/meteor.js"),banners=__webpack_require__("./client/lib/banners.ts"),imperativeModal=__webpack_require__("./client/lib/imperativeModal.tsx"),toast=__webpack_require__("./client/lib/toast.ts"),mapMessageFromApi=__webpack_require__("./client/lib/utils/mapMessageFromApi.ts"),waitUntilFind=__webpack_require__("./client/lib/utils/waitUntilFind.ts"),fuselage=__webpack_require__("./node_modules/@rocket.chat/fuselage/index.js"),dist_index_module=__webpack_require__("./node_modules/@rocket.chat/fuselage-hooks/dist/index.module.js"),ui_contexts_dist=__webpack_require__("../../packages/ui-contexts/dist/index.js"),react=__webpack_require__("./node_modules/react/index.js"),GenericModal=__webpack_require__("./client/components/GenericModal/index.ts");function _extends(){return _extends=Object.assign?Object.assign.bind():function(n){for(var e=1;e<arguments.length;e++){var t=arguments[e];for(var r in t)({}).hasOwnProperty.call(t,r)&&(n[r]=t[r])}return n},_extends.apply(null,arguments)}function _slicedToArray(r,e){return function _arrayWithHoles(r){if(Array.isArray(r))return r}(r)||function _iterableToArrayLimit(r,l){var t=null==r?null:"undefined"!=typeof Symbol&&r[Symbol.iterator]||r["@@iterator"];if(null!=t){var e,n,i,u,a=[],f=!0,o=!1;try{if(i=(t=t.call(r)).next,0===l){if(Object(t)!==t)return;f=!1}else for(;!(f=(e=i.call(t)).done)&&(a.push(e.value),a.length!==l);f=!0);}catch(r){o=!0,n=r}finally{try{if(!f&&null!=t.return&&(u=t.return(),Object(u)!==u))return}finally{if(o)throw n}}return a}}(r,e)||function _unsupportedIterableToArray(r,a){if(r){if("string"==typeof r)return _arrayLikeToArray(r,a);var t={}.toString.call(r).slice(8,-1);return"Object"===t&&r.constructor&&(t=r.constructor.name),"Map"===t||"Set"===t?Array.from(r):"Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t)?_arrayLikeToArray(r,a):void 0}}(r,e)||function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function _arrayLikeToArray(r,a){(null==a||a>r.length)&&(a=r.length);for(var e=0,n=Array(a);e<a;e++)n[e]=r[e];return n}var EnterE2EPasswordModal=function EnterE2EPasswordModal(_ref){var onConfirm=_ref.onConfirm,onClose=_ref.onClose,onCancel=_ref.onCancel,t=(0,ui_contexts_dist.useTranslation)(),_useState2=_slicedToArray((0,react.useState)(""),2),password=_useState2[0],setPassword=_useState2[1],_useState4=_slicedToArray((0,react.useState)(),2),passwordError=_useState4[0],setPasswordError=_useState4[1],handleChange=(0,react.useCallback)((function(e){""!==e.target.value&&setPasswordError(void 0),setPassword(e.currentTarget.value)}),[setPassword]),handleConfirm=(0,dist_index_module.useMutableCallback)((function(e){if(e.preventDefault(),""!==password)return onConfirm(password);setPasswordError(t("Invalid_pass"))}));return react.createElement(GenericModal.A,{wrapperFunction:function wrapperFunction(props){return react.createElement(fuselage.Box,_extends({is:"form",onSubmit:handleConfirm},props))},variant:"warning",title:t("Enter_E2E_password"),icon:"warning",cancelText:t("Do_It_Later"),confirmText:t("Enable_encryption"),onClose:onClose,onCancel:onCancel},react.createElement(fuselage.Box,{dangerouslySetInnerHTML:{__html:t("E2E_password_request_text")}}),react.createElement(fuselage.FieldGroup,{mbs:24,w:"full"},react.createElement(fuselage.Field,null,react.createElement(fuselage.FieldRow,null,react.createElement(fuselage.PasswordInput,{error:passwordError,value:password,onChange:handleChange,placeholder:t("Please_enter_E2EE_password")})),react.createElement(fuselage.FieldError,null,passwordError))))},e2e_EnterE2EPasswordModal=EnterE2EPasswordModal;EnterE2EPasswordModal.__docgenInfo={description:"",methods:[],displayName:"EnterE2EPasswordModal",props:{onConfirm:{required:!0,tsType:{name:"signature",type:"function",raw:"(password: string) => void",signature:{arguments:[{type:{name:"string"},name:"password"}],return:{name:"void"}}},description:""},onClose:{required:!0,tsType:{name:"signature",type:"function",raw:"() => void",signature:{arguments:[],return:{name:"void"}}},description:""},onCancel:{required:!0,tsType:{name:"signature",type:"function",raw:"() => void",signature:{arguments:[],return:{name:"void"}}},description:""}}};var ui_client_dist=__webpack_require__("../../packages/ui-client/dist/index.js"),SaveE2EPasswordModal=function SaveE2EPasswordModal(_ref){var randomPassword=_ref.randomPassword,onClose=_ref.onClose,onCancel=_ref.onCancel,onConfirm=_ref.onConfirm,t=(0,ui_contexts_dist.useTranslation)(),_useClipboard=(0,dist_index_module.useClipboard)(randomPassword),copy=_useClipboard.copy,hasCopied=_useClipboard.hasCopied;return react.createElement(GenericModal.A,{onClose:onClose,onCancel:onCancel,onConfirm:onConfirm,cancelText:t("Do_It_Later"),confirmText:t("I_Saved_My_Password"),variant:"warning",title:t("Save_your_encryption_password"),annotation:t("You_can_do_from_account_preferences")},react.createElement("p",null,react.createElement("span",{dangerouslySetInnerHTML:{__html:t("E2E_password_reveal_text",{randomPassword:randomPassword})}}),react.createElement(ui_client_dist.Gr,{to:"https://go.rocket.chat/i/e2ee-guide",mis:4},t("Learn_more_about_E2EE"))),react.createElement(fuselage.Box,{is:"p",fontWeight:"bold",mb:20},t("E2E_password_save_text")),react.createElement("p",null,t("Your_E2EE_password_is")),react.createElement(fuselage.CodeSnippet,{buttonText:t(hasCopied?"Copied":"Copy"),buttonDisabled:hasCopied,onClick:function onClick(){return copy()},mbs:8},randomPassword))},e2e_SaveE2EPasswordModal=SaveE2EPasswordModal;SaveE2EPasswordModal.__docgenInfo={description:"",methods:[],displayName:"SaveE2EPasswordModal",props:{randomPassword:{required:!0,tsType:{name:"string"},description:""},onClose:{required:!0,tsType:{name:"signature",type:"function",raw:"() => void",signature:{arguments:[],return:{name:"void"}}},description:""},onCancel:{required:!0,tsType:{name:"signature",type:"function",raw:"() => void",signature:{arguments:[],return:{name:"void"}}},description:""},onConfirm:{required:!0,tsType:{name:"signature",type:"function",raw:"() => void",signature:{arguments:[],return:{name:"void"}}},description:""}}};var getUserDisplayName=__webpack_require__("./lib/getUserDisplayName.ts");function _typeof(o){return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(o){return typeof o}:function(o){return o&&"function"==typeof Symbol&&o.constructor===Symbol&&o!==Symbol.prototype?"symbol":typeof o},_typeof(o)}function ownKeys(e,r){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);r&&(o=o.filter((function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable}))),t.push.apply(t,o)}return t}function _objectSpread(e){for(var r=1;r<arguments.length;r++){var t=null!=arguments[r]?arguments[r]:{};r%2?ownKeys(Object(t),!0).forEach((function(r){_defineProperty(e,r,t[r])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):ownKeys(Object(t)).forEach((function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))}))}return e}function _defineProperty(e,r,t){return(r=function _toPropertyKey(t){var i=function _toPrimitive(t,r){if("object"!=_typeof(t)||!t)return t;var e=t[Symbol.toPrimitive];if(void 0!==e){var i=e.call(t,r||"default");if("object"!=_typeof(i))return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===r?String:Number)(t)}(t,"string");return"symbol"==_typeof(i)?i:i+""}(r))in e?Object.defineProperty(e,r,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[r]=t,e}function createQuoteAttachment(message,messageLink,useRealName,userAvatarUrl){return _objectSpread(_objectSpread({text:message.msg,md:message.md},(0,dist.isTranslatedMessage)(message)&&{translations:null==message?void 0:message.translations}),{},{message_link:messageLink,author_name:message.alias||(0,getUserDisplayName.N)(message.u.name,message.u.username,useRealName),author_icon:userAvatarUrl,attachments:message.attachments||[],ts:message.ts})}var isTruthy=__webpack_require__("./lib/isTruthy.ts"),client=__webpack_require__("./app/models/client/index.ts"),settings_client=__webpack_require__("./app/settings/client/index.ts"),utils_client=__webpack_require__("./app/utils/client/index.ts"),SDKClient=__webpack_require__("./app/utils/client/lib/SDKClient.ts"),i18n=__webpack_require__("./app/utils/lib/i18n.ts"),E2EEState=__webpack_require__("./app/e2e/client/E2EEState.ts"),main_client=__webpack_require__("../../packages/random/dist/main.client.js"),bytebuffer=__webpack_require__("./node_modules/bytebuffer/dist/bytebuffer.js"),bytebuffer_default=__webpack_require__.n(bytebuffer);function _regeneratorRuntime(){_regeneratorRuntime=function _regeneratorRuntime(){return e};var t,e={},r=Object.prototype,n=r.hasOwnProperty,o=Object.defineProperty||function(t,e,r){t[e]=r.value},i="function"==typeof Symbol?Symbol:{},a=i.iterator||"@@iterator",c=i.asyncIterator||"@@asyncIterator",u=i.toStringTag||"@@toStringTag";function define(t,e,r){return Object.defineProperty(t,e,{value:r,enumerable:!0,configurable:!0,writable:!0}),t[e]}try{define({},"")}catch(t){define=function define(t,e,r){return t[e]=r}}function wrap(t,e,r,n){var i=e&&e.prototype instanceof Generator?e:Generator,a=Object.create(i.prototype),c=new Context(n||[]);return o(a,"_invoke",{value:makeInvokeMethod(t,r,c)}),a}function tryCatch(t,e,r){try{return{type:"normal",arg:t.call(e,r)}}catch(t){return{type:"throw",arg:t}}}e.wrap=wrap;var h="suspendedStart",l="suspendedYield",f="executing",s="completed",y={};function Generator(){}function GeneratorFunction(){}function GeneratorFunctionPrototype(){}var p={};define(p,a,(function(){return this}));var d=Object.getPrototypeOf,v=d&&d(d(values([])));v&&v!==r&&n.call(v,a)&&(p=v);var g=GeneratorFunctionPrototype.prototype=Generator.prototype=Object.create(p);function defineIteratorMethods(t){["next","throw","return"].forEach((function(e){define(t,e,(function(t){return this._invoke(e,t)}))}))}function AsyncIterator(t,e){function invoke(r,o,i,a){var c=tryCatch(t[r],t,o);if("throw"!==c.type){var u=c.arg,h=u.value;return h&&"object"==helper_typeof(h)&&n.call(h,"__await")?e.resolve(h.__await).then((function(t){invoke("next",t,i,a)}),(function(t){invoke("throw",t,i,a)})):e.resolve(h).then((function(t){u.value=t,i(u)}),(function(t){return invoke("throw",t,i,a)}))}a(c.arg)}var r;o(this,"_invoke",{value:function value(t,n){function callInvokeWithMethodAndArg(){return new e((function(e,r){invoke(t,n,e,r)}))}return r=r?r.then(callInvokeWithMethodAndArg,callInvokeWithMethodAndArg):callInvokeWithMethodAndArg()}})}function makeInvokeMethod(e,r,n){var o=h;return function(i,a){if(o===f)throw Error("Generator is already running");if(o===s){if("throw"===i)throw a;return{value:t,done:!0}}for(n.method=i,n.arg=a;;){var c=n.delegate;if(c){var u=maybeInvokeDelegate(c,n);if(u){if(u===y)continue;return u}}if("next"===n.method)n.sent=n._sent=n.arg;else if("throw"===n.method){if(o===h)throw o=s,n.arg;n.dispatchException(n.arg)}else"return"===n.method&&n.abrupt("return",n.arg);o=f;var p=tryCatch(e,r,n);if("normal"===p.type){if(o=n.done?s:l,p.arg===y)continue;return{value:p.arg,done:n.done}}"throw"===p.type&&(o=s,n.method="throw",n.arg=p.arg)}}}function maybeInvokeDelegate(e,r){var n=r.method,o=e.iterator[n];if(o===t)return r.delegate=null,"throw"===n&&e.iterator.return&&(r.method="return",r.arg=t,maybeInvokeDelegate(e,r),"throw"===r.method)||"return"!==n&&(r.method="throw",r.arg=new TypeError("The iterator does not provide a '"+n+"' method")),y;var i=tryCatch(o,e.iterator,r.arg);if("throw"===i.type)return r.method="throw",r.arg=i.arg,r.delegate=null,y;var a=i.arg;return a?a.done?(r[e.resultName]=a.value,r.next=e.nextLoc,"return"!==r.method&&(r.method="next",r.arg=t),r.delegate=null,y):a:(r.method="throw",r.arg=new TypeError("iterator result is not an object"),r.delegate=null,y)}function pushTryEntry(t){var e={tryLoc:t[0]};1 in t&&(e.catchLoc=t[1]),2 in t&&(e.finallyLoc=t[2],e.afterLoc=t[3]),this.tryEntries.push(e)}function resetTryEntry(t){var e=t.completion||{};e.type="normal",delete e.arg,t.completion=e}function Context(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(pushTryEntry,this),this.reset(!0)}function values(e){if(e||""===e){var r=e[a];if(r)return r.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var o=-1,i=function next(){for(;++o<e.length;)if(n.call(e,o))return next.value=e[o],next.done=!1,next;return next.value=t,next.done=!0,next};return i.next=i}}throw new TypeError(helper_typeof(e)+" is not iterable")}return GeneratorFunction.prototype=GeneratorFunctionPrototype,o(g,"constructor",{value:GeneratorFunctionPrototype,configurable:!0}),o(GeneratorFunctionPrototype,"constructor",{value:GeneratorFunction,configurable:!0}),GeneratorFunction.displayName=define(GeneratorFunctionPrototype,u,"GeneratorFunction"),e.isGeneratorFunction=function(t){var e="function"==typeof t&&t.constructor;return!!e&&(e===GeneratorFunction||"GeneratorFunction"===(e.displayName||e.name))},e.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,GeneratorFunctionPrototype):(t.__proto__=GeneratorFunctionPrototype,define(t,u,"GeneratorFunction")),t.prototype=Object.create(g),t},e.awrap=function(t){return{__await:t}},defineIteratorMethods(AsyncIterator.prototype),define(AsyncIterator.prototype,c,(function(){return this})),e.AsyncIterator=AsyncIterator,e.async=function(t,r,n,o,i){void 0===i&&(i=Promise);var a=new AsyncIterator(wrap(t,r,n,o),i);return e.isGeneratorFunction(r)?a:a.next().then((function(t){return t.done?t.value:a.next()}))},defineIteratorMethods(g),define(g,u,"Generator"),define(g,a,(function(){return this})),define(g,"toString",(function(){return"[object Generator]"})),e.keys=function(t){var e=Object(t),r=[];for(var n in e)r.push(n);return r.reverse(),function next(){for(;r.length;){var t=r.pop();if(t in e)return next.value=t,next.done=!1,next}return next.done=!0,next}},e.values=values,Context.prototype={constructor:Context,reset:function reset(e){if(this.prev=0,this.next=0,this.sent=this._sent=t,this.done=!1,this.delegate=null,this.method="next",this.arg=t,this.tryEntries.forEach(resetTryEntry),!e)for(var r in this)"t"===r.charAt(0)&&n.call(this,r)&&!isNaN(+r.slice(1))&&(this[r]=t)},stop:function stop(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function dispatchException(e){if(this.done)throw e;var r=this;function handle(n,o){return a.type="throw",a.arg=e,r.next=n,o&&(r.method="next",r.arg=t),!!o}for(var o=this.tryEntries.length-1;o>=0;--o){var i=this.tryEntries[o],a=i.completion;if("root"===i.tryLoc)return handle("end");if(i.tryLoc<=this.prev){var c=n.call(i,"catchLoc"),u=n.call(i,"finallyLoc");if(c&&u){if(this.prev<i.catchLoc)return handle(i.catchLoc,!0);if(this.prev<i.finallyLoc)return handle(i.finallyLoc)}else if(c){if(this.prev<i.catchLoc)return handle(i.catchLoc,!0)}else{if(!u)throw Error("try statement without catch or finally");if(this.prev<i.finallyLoc)return handle(i.finallyLoc)}}}},abrupt:function abrupt(t,e){for(var r=this.tryEntries.length-1;r>=0;--r){var o=this.tryEntries[r];if(o.tryLoc<=this.prev&&n.call(o,"finallyLoc")&&this.prev<o.finallyLoc){var i=o;break}}i&&("break"===t||"continue"===t)&&i.tryLoc<=e&&e<=i.finallyLoc&&(i=null);var a=i?i.completion:{};return a.type=t,a.arg=e,i?(this.method="next",this.next=i.finallyLoc,y):this.complete(a)},complete:function complete(t,e){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&e&&(this.next=e),y},finish:function finish(t){for(var e=this.tryEntries.length-1;e>=0;--e){var r=this.tryEntries[e];if(r.finallyLoc===t)return this.complete(r.completion,r.afterLoc),resetTryEntry(r),y}},catch:function _catch(t){for(var e=this.tryEntries.length-1;e>=0;--e){var r=this.tryEntries[e];if(r.tryLoc===t){var n=r.completion;if("throw"===n.type){var o=n.arg;resetTryEntry(r)}return o}}throw Error("illegal catch attempt")},delegateYield:function delegateYield(e,r,n){return this.delegate={iterator:values(e),resultName:r,nextLoc:n},"next"===this.method&&(this.arg=t),y}},e}function asyncGeneratorStep(n,t,e,r,o,a,c){try{var i=n[a](c),u=i.value}catch(n){return void e(n)}i.done?t(u):Promise.resolve(u).then(r,o)}function _asyncToGenerator(n){return function(){var t=this,e=arguments;return new Promise((function(r,o){var a=n.apply(t,e);function _next(n){asyncGeneratorStep(a,r,o,_next,_throw,"next",n)}function _throw(n){asyncGeneratorStep(a,r,o,_next,_throw,"throw",n)}_next(void 0)}))}}function helper_typeof(o){return helper_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(o){return typeof o}:function(o){return o&&"function"==typeof Symbol&&o.constructor===Symbol&&o!==Symbol.prototype?"symbol":typeof o},helper_typeof(o)}var StaticArrayBufferProto=(new ArrayBuffer).__proto__;function helper_toString(thing){return"string"==typeof thing?thing:new(bytebuffer_default().wrap)(thing).toString("binary")}function toArrayBuffer(thing){if(void 0!==thing){if(thing===Object(thing)&&thing.__proto__===StaticArrayBufferProto)return thing;if("string"!=typeof thing)throw new Error("Tried to convert a non-string of type ".concat(helper_typeof(thing)," to an array buffer"));return new(bytebuffer_default().wrap)(thing,"binary").toArrayBuffer()}}function joinVectorAndEcryptedData(vector,encryptedData){var cipherText=new Uint8Array(encryptedData),output=new Uint8Array(vector.length+cipherText.length);return output.set(vector,0),output.set(cipherText,vector.length),output}function splitVectorAndEcryptedData(cipherText){return[cipherText.slice(0,16),cipherText.slice(16)]}function encryptRSA(_x,_x2){return _encryptRSA.apply(this,arguments)}function _encryptRSA(){return(_encryptRSA=_asyncToGenerator(_regeneratorRuntime().mark((function _callee(key,data){return _regeneratorRuntime().wrap((function _callee$(_context){for(;;)switch(_context.prev=_context.next){case 0:return _context.abrupt("return",crypto.subtle.encrypt({name:"RSA-OAEP"},key,data));case 1:case"end":return _context.stop()}}),_callee)})))).apply(this,arguments)}function encryptAES(_x3,_x4,_x5){return _encryptAES.apply(this,arguments)}function _encryptAES(){return(_encryptAES=_asyncToGenerator(_regeneratorRuntime().mark((function _callee2(vector,key,data){return _regeneratorRuntime().wrap((function _callee2$(_context2){for(;;)switch(_context2.prev=_context2.next){case 0:return _context2.abrupt("return",crypto.subtle.encrypt({name:"AES-CBC",iv:vector},key,data));case 1:case"end":return _context2.stop()}}),_callee2)})))).apply(this,arguments)}function encryptAESCTR(_x6,_x7,_x8){return _encryptAESCTR.apply(this,arguments)}function _encryptAESCTR(){return(_encryptAESCTR=_asyncToGenerator(_regeneratorRuntime().mark((function _callee3(vector,key,data){return _regeneratorRuntime().wrap((function _callee3$(_context3){for(;;)switch(_context3.prev=_context3.next){case 0:return _context3.abrupt("return",crypto.subtle.encrypt({name:"AES-CTR",counter:vector,length:64},key,data));case 1:case"end":return _context3.stop()}}),_callee3)})))).apply(this,arguments)}function decryptRSA(_x9,_x10){return _decryptRSA.apply(this,arguments)}function _decryptRSA(){return(_decryptRSA=_asyncToGenerator(_regeneratorRuntime().mark((function _callee4(key,data){return _regeneratorRuntime().wrap((function _callee4$(_context4){for(;;)switch(_context4.prev=_context4.next){case 0:return _context4.abrupt("return",crypto.subtle.decrypt({name:"RSA-OAEP"},key,data));case 1:case"end":return _context4.stop()}}),_callee4)})))).apply(this,arguments)}function decryptAES(_x11,_x12,_x13){return _decryptAES.apply(this,arguments)}function _decryptAES(){return(_decryptAES=_asyncToGenerator(_regeneratorRuntime().mark((function _callee5(vector,key,data){return _regeneratorRuntime().wrap((function _callee5$(_context5){for(;;)switch(_context5.prev=_context5.next){case 0:return _context5.abrupt("return",crypto.subtle.decrypt({name:"AES-CBC",iv:vector},key,data));case 1:case"end":return _context5.stop()}}),_callee5)})))).apply(this,arguments)}function generateAESKey(){return _generateAESKey.apply(this,arguments)}function _generateAESKey(){return(_generateAESKey=_asyncToGenerator(_regeneratorRuntime().mark((function _callee6(){return _regeneratorRuntime().wrap((function _callee6$(_context6){for(;;)switch(_context6.prev=_context6.next){case 0:return _context6.abrupt("return",crypto.subtle.generateKey({name:"AES-CBC",length:128},!0,["encrypt","decrypt"]));case 1:case"end":return _context6.stop()}}),_callee6)})))).apply(this,arguments)}function generateAESCTRKey(){return _generateAESCTRKey.apply(this,arguments)}function _generateAESCTRKey(){return(_generateAESCTRKey=_asyncToGenerator(_regeneratorRuntime().mark((function _callee7(){return _regeneratorRuntime().wrap((function _callee7$(_context7){for(;;)switch(_context7.prev=_context7.next){case 0:return _context7.abrupt("return",crypto.subtle.generateKey({name:"AES-CTR",length:256},!0,["encrypt","decrypt"]));case 1:case"end":return _context7.stop()}}),_callee7)})))).apply(this,arguments)}function generateRSAKey(){return _generateRSAKey.apply(this,arguments)}function _generateRSAKey(){return(_generateRSAKey=_asyncToGenerator(_regeneratorRuntime().mark((function _callee8(){return _regeneratorRuntime().wrap((function _callee8$(_context8){for(;;)switch(_context8.prev=_context8.next){case 0:return _context8.abrupt("return",crypto.subtle.generateKey({name:"RSA-OAEP",modulusLength:2048,publicExponent:new Uint8Array([1,0,1]),hash:{name:"SHA-256"}},!0,["encrypt","decrypt"]));case 1:case"end":return _context8.stop()}}),_callee8)})))).apply(this,arguments)}function exportJWKKey(_x14){return _exportJWKKey.apply(this,arguments)}function _exportJWKKey(){return(_exportJWKKey=_asyncToGenerator(_regeneratorRuntime().mark((function _callee9(key){return _regeneratorRuntime().wrap((function _callee9$(_context9){for(;;)switch(_context9.prev=_context9.next){case 0:return _context9.abrupt("return",crypto.subtle.exportKey("jwk",key));case 1:case"end":return _context9.stop()}}),_callee9)})))).apply(this,arguments)}function importRSAKey(_x15){return _importRSAKey.apply(this,arguments)}function _importRSAKey(){return _importRSAKey=_asyncToGenerator(_regeneratorRuntime().mark((function _callee10(keyData){var keyUsages,_args10=arguments;return _regeneratorRuntime().wrap((function _callee10$(_context10){for(;;)switch(_context10.prev=_context10.next){case 0:return keyUsages=_args10.length>1&&void 0!==_args10[1]?_args10[1]:["encrypt","decrypt"],_context10.abrupt("return",crypto.subtle.importKey("jwk",keyData,{name:"RSA-OAEP",modulusLength:2048,publicExponent:new Uint8Array([1,0,1]),hash:{name:"SHA-256"}},!0,keyUsages));case 2:case"end":return _context10.stop()}}),_callee10)}))),_importRSAKey.apply(this,arguments)}function importAESKey(_x16){return _importAESKey.apply(this,arguments)}function _importAESKey(){return _importAESKey=_asyncToGenerator(_regeneratorRuntime().mark((function _callee11(keyData){var keyUsages,_args11=arguments;return _regeneratorRuntime().wrap((function _callee11$(_context11){for(;;)switch(_context11.prev=_context11.next){case 0:return keyUsages=_args11.length>1&&void 0!==_args11[1]?_args11[1]:["encrypt","decrypt"],_context11.abrupt("return",crypto.subtle.importKey("jwk",keyData,{name:"AES-CBC"},!0,keyUsages));case 2:case"end":return _context11.stop()}}),_callee11)}))),_importAESKey.apply(this,arguments)}function importRawKey(_x17){return _importRawKey.apply(this,arguments)}function _importRawKey(){return _importRawKey=_asyncToGenerator(_regeneratorRuntime().mark((function _callee12(keyData){var keyUsages,_args12=arguments;return _regeneratorRuntime().wrap((function _callee12$(_context12){for(;;)switch(_context12.prev=_context12.next){case 0:return keyUsages=_args12.length>1&&void 0!==_args12[1]?_args12[1]:["deriveKey"],_context12.abrupt("return",crypto.subtle.importKey("raw",keyData,{name:"PBKDF2"},!1,keyUsages));case 2:case"end":return _context12.stop()}}),_callee12)}))),_importRawKey.apply(this,arguments)}function deriveKey(_x18,_x19){return _deriveKey.apply(this,arguments)}function _deriveKey(){return _deriveKey=_asyncToGenerator(_regeneratorRuntime().mark((function _callee13(salt,baseKey){var keyUsages,_args13=arguments;return _regeneratorRuntime().wrap((function _callee13$(_context13){for(;;)switch(_context13.prev=_context13.next){case 0:return keyUsages=_args13.length>2&&void 0!==_args13[2]?_args13[2]:["encrypt","decrypt"],1e3,"SHA-256",_context13.abrupt("return",crypto.subtle.deriveKey({name:"PBKDF2",salt:salt,iterations:1e3,hash:"SHA-256"},baseKey,{name:"AES-CBC",length:256},!0,keyUsages));case 4:case"end":return _context13.stop()}}),_callee13)}))),_deriveKey.apply(this,arguments)}function readFileAsArrayBuffer(_x20){return _readFileAsArrayBuffer.apply(this,arguments)}function _readFileAsArrayBuffer(){return(_readFileAsArrayBuffer=_asyncToGenerator(_regeneratorRuntime().mark((function _callee14(file){return _regeneratorRuntime().wrap((function _callee14$(_context14){for(;;)switch(_context14.prev=_context14.next){case 0:return _context14.abrupt("return",new Promise((function(resolve,reject){var reader=new FileReader;reader.onload=function(evt){resolve(evt.target.result)},reader.onerror=function(evt){reject(evt)},reader.readAsArrayBuffer(file)})));case 1:case"end":return _context14.stop()}}),_callee14)})))).apply(this,arguments)}function generateMnemonicPhrase(_x21){return _generateMnemonicPhrase.apply(this,arguments)}function _generateMnemonicPhrase(){return _generateMnemonicPhrase=_asyncToGenerator(_regeneratorRuntime().mark((function _callee15(n){var sep,_yield$import,wordList,result,len,taken,x,_args15=arguments;return _regeneratorRuntime().wrap((function _callee15$(_context15){for(;;)switch(_context15.prev=_context15.next){case 0:return sep=_args15.length>1&&void 0!==_args15[1]?_args15[1]:" ",_context15.next=3,__webpack_require__.e(6573).then(__webpack_require__.bind(__webpack_require__,"./app/e2e/client/wordList.ts"));case 3:for(_yield$import=_context15.sent,wordList=_yield$import.default,result=new Array(n),len=wordList.length,taken=new Array(len);n--;)x=Math.floor(main_client.o.fraction()*len),result[n]=wordList[x in taken?taken[x]:x],taken[x]=--len in taken?taken[len]:len;return _context15.abrupt("return",result.join(sep));case 10:case"end":return _context15.stop()}}),_callee15)}))),_generateMnemonicPhrase.apply(this,arguments)}function createSha256HashFromText(_x22){return _createSha256HashFromText.apply(this,arguments)}function _createSha256HashFromText(){return(_createSha256HashFromText=_asyncToGenerator(_regeneratorRuntime().mark((function _callee16(data){var hash;return _regeneratorRuntime().wrap((function _callee16$(_context16){for(;;)switch(_context16.prev=_context16.next){case 0:return _context16.next=2,crypto.subtle.digest("SHA-256",(new TextEncoder).encode(data));case 2:return hash=_context16.sent,_context16.abrupt("return",Array.from(new Uint8Array(hash)).map((function(b){return b.toString(16).padStart(2,"0")})).join(""));case 4:case"end":return _context16.stop()}}),_callee16)})))).apply(this,arguments)}function sha256HashFromArrayBuffer(_x23){return _sha256HashFromArrayBuffer.apply(this,arguments)}function _sha256HashFromArrayBuffer(){return(_sha256HashFromArrayBuffer=_asyncToGenerator(_regeneratorRuntime().mark((function _callee17(arrayBuffer){var hashArray;return _regeneratorRuntime().wrap((function _callee17$(_context17){for(;;)switch(_context17.prev=_context17.next){case 0:return _context17.t0=Array,_context17.t1=Uint8Array,_context17.next=4,crypto.subtle.digest("SHA-256",arrayBuffer);case 4:return _context17.t2=_context17.sent,_context17.t3=new _context17.t1(_context17.t2),hashArray=_context17.t0.from.call(_context17.t0,_context17.t3),_context17.abrupt("return",hashArray.map((function(b){return b.toString(16).padStart(2,"0")})).join(""));case 8:case"end":return _context17.stop()}}),_callee17)})))).apply(this,arguments)}var getConfig=__webpack_require__("./client/lib/utils/getConfig.ts"),debug=void 0,isDebugEnabled=function isDebugEnabled(){return void 0===debug&&(debug="true"===(0,getConfig.z)("debug")||"true"===(0,getConfig.z)("debug-e2e")),debug},logger_log=function log(context){for(var _console,_len=arguments.length,msg=new Array(_len>1?_len-1:0),_key=1;_key<_len;_key++)msg[_key-1]=arguments[_key];isDebugEnabled()&&(_console=console).log.apply(_console,["[".concat(context,"]")].concat(msg))},logError=function logError(context){for(var _console2,_len2=arguments.length,msg=new Array(_len2>1?_len2-1:0),_key2=1;_key2<_len2;_key2++)msg[_key2-1]=arguments[_key2];isDebugEnabled()&&(_console2=console).error.apply(_console2,["[".concat(context,"]")].concat(msg))},base64=__webpack_require__("../../packages/base64/dist/base64.js"),RoomManager=__webpack_require__("./client/lib/RoomManager.ts"),roomCoordinator=__webpack_require__("./client/lib/rooms/roomCoordinator.tsx"),IRoomTypeConfig=__webpack_require__("./definition/IRoomTypeConfig.ts"),E2ERoomState=__webpack_require__("./app/e2e/client/E2ERoomState.ts"),_excluded=["_id"],_excluded2=["msg","attachments"];function rocketchat_e2e_room_typeof(o){return rocketchat_e2e_room_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(o){return typeof o}:function(o){return o&&"function"==typeof Symbol&&o.constructor===Symbol&&o!==Symbol.prototype?"symbol":typeof o},rocketchat_e2e_room_typeof(o)}function rocketchat_e2e_room_slicedToArray(r,e){return function rocketchat_e2e_room_arrayWithHoles(r){if(Array.isArray(r))return r}(r)||function rocketchat_e2e_room_iterableToArrayLimit(r,l){var t=null==r?null:"undefined"!=typeof Symbol&&r[Symbol.iterator]||r["@@iterator"];if(null!=t){var e,n,i,u,a=[],f=!0,o=!1;try{if(i=(t=t.call(r)).next,0===l){if(Object(t)!==t)return;f=!1}else for(;!(f=(e=i.call(t)).done)&&(a.push(e.value),a.length!==l);f=!0);}catch(r){o=!0,n=r}finally{try{if(!f&&null!=t.return&&(u=t.return(),Object(u)!==u))return}finally{if(o)throw n}}return a}}(r,e)||function rocketchat_e2e_room_unsupportedIterableToArray(r,a){if(r){if("string"==typeof r)return rocketchat_e2e_room_arrayLikeToArray(r,a);var t={}.toString.call(r).slice(8,-1);return"Object"===t&&r.constructor&&(t=r.constructor.name),"Map"===t||"Set"===t?Array.from(r):"Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t)?rocketchat_e2e_room_arrayLikeToArray(r,a):void 0}}(r,e)||function rocketchat_e2e_room_nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function rocketchat_e2e_room_arrayLikeToArray(r,a){(null==a||a>r.length)&&(a=r.length);for(var e=0,n=Array(a);e<a;e++)n[e]=r[e];return n}function _objectWithoutProperties(e,t){if(null==e)return{};var o,r,i=function _objectWithoutPropertiesLoose(r,e){if(null==r)return{};var t={};for(var n in r)if({}.hasOwnProperty.call(r,n)){if(e.includes(n))continue;t[n]=r[n]}return t}(e,t);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);for(r=0;r<s.length;r++)o=s[r],t.includes(o)||{}.propertyIsEnumerable.call(e,o)&&(i[o]=e[o])}return i}function rocketchat_e2e_room_ownKeys(e,r){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);r&&(o=o.filter((function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable}))),t.push.apply(t,o)}return t}function rocketchat_e2e_room_objectSpread(e){for(var r=1;r<arguments.length;r++){var t=null!=arguments[r]?arguments[r]:{};r%2?rocketchat_e2e_room_ownKeys(Object(t),!0).forEach((function(r){rocketchat_e2e_room_defineProperty(e,r,t[r])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):rocketchat_e2e_room_ownKeys(Object(t)).forEach((function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))}))}return e}function rocketchat_e2e_room_regeneratorRuntime(){rocketchat_e2e_room_regeneratorRuntime=function _regeneratorRuntime(){return e};var t,e={},r=Object.prototype,n=r.hasOwnProperty,o=Object.defineProperty||function(t,e,r){t[e]=r.value},i="function"==typeof Symbol?Symbol:{},a=i.iterator||"@@iterator",c=i.asyncIterator||"@@asyncIterator",u=i.toStringTag||"@@toStringTag";function define(t,e,r){return Object.defineProperty(t,e,{value:r,enumerable:!0,configurable:!0,writable:!0}),t[e]}try{define({},"")}catch(t){define=function define(t,e,r){return t[e]=r}}function wrap(t,e,r,n){var i=e&&e.prototype instanceof Generator?e:Generator,a=Object.create(i.prototype),c=new Context(n||[]);return o(a,"_invoke",{value:makeInvokeMethod(t,r,c)}),a}function tryCatch(t,e,r){try{return{type:"normal",arg:t.call(e,r)}}catch(t){return{type:"throw",arg:t}}}e.wrap=wrap;var h="suspendedStart",l="suspendedYield",f="executing",s="completed",y={};function Generator(){}function GeneratorFunction(){}function GeneratorFunctionPrototype(){}var p={};define(p,a,(function(){return this}));var d=Object.getPrototypeOf,v=d&&d(d(values([])));v&&v!==r&&n.call(v,a)&&(p=v);var g=GeneratorFunctionPrototype.prototype=Generator.prototype=Object.create(p);function defineIteratorMethods(t){["next","throw","return"].forEach((function(e){define(t,e,(function(t){return this._invoke(e,t)}))}))}function AsyncIterator(t,e){function invoke(r,o,i,a){var c=tryCatch(t[r],t,o);if("throw"!==c.type){var u=c.arg,h=u.value;return h&&"object"==rocketchat_e2e_room_typeof(h)&&n.call(h,"__await")?e.resolve(h.__await).then((function(t){invoke("next",t,i,a)}),(function(t){invoke("throw",t,i,a)})):e.resolve(h).then((function(t){u.value=t,i(u)}),(function(t){return invoke("throw",t,i,a)}))}a(c.arg)}var r;o(this,"_invoke",{value:function value(t,n){function callInvokeWithMethodAndArg(){return new e((function(e,r){invoke(t,n,e,r)}))}return r=r?r.then(callInvokeWithMethodAndArg,callInvokeWithMethodAndArg):callInvokeWithMethodAndArg()}})}function makeInvokeMethod(e,r,n){var o=h;return function(i,a){if(o===f)throw Error("Generator is already running");if(o===s){if("throw"===i)throw a;return{value:t,done:!0}}for(n.method=i,n.arg=a;;){var c=n.delegate;if(c){var u=maybeInvokeDelegate(c,n);if(u){if(u===y)continue;return u}}if("next"===n.method)n.sent=n._sent=n.arg;else if("throw"===n.method){if(o===h)throw o=s,n.arg;n.dispatchException(n.arg)}else"return"===n.method&&n.abrupt("return",n.arg);o=f;var p=tryCatch(e,r,n);if("normal"===p.type){if(o=n.done?s:l,p.arg===y)continue;return{value:p.arg,done:n.done}}"throw"===p.type&&(o=s,n.method="throw",n.arg=p.arg)}}}function maybeInvokeDelegate(e,r){var n=r.method,o=e.iterator[n];if(o===t)return r.delegate=null,"throw"===n&&e.iterator.return&&(r.method="return",r.arg=t,maybeInvokeDelegate(e,r),"throw"===r.method)||"return"!==n&&(r.method="throw",r.arg=new TypeError("The iterator does not provide a '"+n+"' method")),y;var i=tryCatch(o,e.iterator,r.arg);if("throw"===i.type)return r.method="throw",r.arg=i.arg,r.delegate=null,y;var a=i.arg;return a?a.done?(r[e.resultName]=a.value,r.next=e.nextLoc,"return"!==r.method&&(r.method="next",r.arg=t),r.delegate=null,y):a:(r.method="throw",r.arg=new TypeError("iterator result is not an object"),r.delegate=null,y)}function pushTryEntry(t){var e={tryLoc:t[0]};1 in t&&(e.catchLoc=t[1]),2 in t&&(e.finallyLoc=t[2],e.afterLoc=t[3]),this.tryEntries.push(e)}function resetTryEntry(t){var e=t.completion||{};e.type="normal",delete e.arg,t.completion=e}function Context(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(pushTryEntry,this),this.reset(!0)}function values(e){if(e||""===e){var r=e[a];if(r)return r.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var o=-1,i=function next(){for(;++o<e.length;)if(n.call(e,o))return next.value=e[o],next.done=!1,next;return next.value=t,next.done=!0,next};return i.next=i}}throw new TypeError(rocketchat_e2e_room_typeof(e)+" is not iterable")}return GeneratorFunction.prototype=GeneratorFunctionPrototype,o(g,"constructor",{value:GeneratorFunctionPrototype,configurable:!0}),o(GeneratorFunctionPrototype,"constructor",{value:GeneratorFunction,configurable:!0}),GeneratorFunction.displayName=define(GeneratorFunctionPrototype,u,"GeneratorFunction"),e.isGeneratorFunction=function(t){var e="function"==typeof t&&t.constructor;return!!e&&(e===GeneratorFunction||"GeneratorFunction"===(e.displayName||e.name))},e.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,GeneratorFunctionPrototype):(t.__proto__=GeneratorFunctionPrototype,define(t,u,"GeneratorFunction")),t.prototype=Object.create(g),t},e.awrap=function(t){return{__await:t}},defineIteratorMethods(AsyncIterator.prototype),define(AsyncIterator.prototype,c,(function(){return this})),e.AsyncIterator=AsyncIterator,e.async=function(t,r,n,o,i){void 0===i&&(i=Promise);var a=new AsyncIterator(wrap(t,r,n,o),i);return e.isGeneratorFunction(r)?a:a.next().then((function(t){return t.done?t.value:a.next()}))},defineIteratorMethods(g),define(g,u,"Generator"),define(g,a,(function(){return this})),define(g,"toString",(function(){return"[object Generator]"})),e.keys=function(t){var e=Object(t),r=[];for(var n in e)r.push(n);return r.reverse(),function next(){for(;r.length;){var t=r.pop();if(t in e)return next.value=t,next.done=!1,next}return next.done=!0,next}},e.values=values,Context.prototype={constructor:Context,reset:function reset(e){if(this.prev=0,this.next=0,this.sent=this._sent=t,this.done=!1,this.delegate=null,this.method="next",this.arg=t,this.tryEntries.forEach(resetTryEntry),!e)for(var r in this)"t"===r.charAt(0)&&n.call(this,r)&&!isNaN(+r.slice(1))&&(this[r]=t)},stop:function stop(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function dispatchException(e){if(this.done)throw e;var r=this;function handle(n,o){return a.type="throw",a.arg=e,r.next=n,o&&(r.method="next",r.arg=t),!!o}for(var o=this.tryEntries.length-1;o>=0;--o){var i=this.tryEntries[o],a=i.completion;if("root"===i.tryLoc)return handle("end");if(i.tryLoc<=this.prev){var c=n.call(i,"catchLoc"),u=n.call(i,"finallyLoc");if(c&&u){if(this.prev<i.catchLoc)return handle(i.catchLoc,!0);if(this.prev<i.finallyLoc)return handle(i.finallyLoc)}else if(c){if(this.prev<i.catchLoc)return handle(i.catchLoc,!0)}else{if(!u)throw Error("try statement without catch or finally");if(this.prev<i.finallyLoc)return handle(i.finallyLoc)}}}},abrupt:function abrupt(t,e){for(var r=this.tryEntries.length-1;r>=0;--r){var o=this.tryEntries[r];if(o.tryLoc<=this.prev&&n.call(o,"finallyLoc")&&this.prev<o.finallyLoc){var i=o;break}}i&&("break"===t||"continue"===t)&&i.tryLoc<=e&&e<=i.finallyLoc&&(i=null);var a=i?i.completion:{};return a.type=t,a.arg=e,i?(this.method="next",this.next=i.finallyLoc,y):this.complete(a)},complete:function complete(t,e){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&e&&(this.next=e),y},finish:function finish(t){for(var e=this.tryEntries.length-1;e>=0;--e){var r=this.tryEntries[e];if(r.finallyLoc===t)return this.complete(r.completion,r.afterLoc),resetTryEntry(r),y}},catch:function _catch(t){for(var e=this.tryEntries.length-1;e>=0;--e){var r=this.tryEntries[e];if(r.tryLoc===t){var n=r.completion;if("throw"===n.type){var o=n.arg;resetTryEntry(r)}return o}}throw Error("illegal catch attempt")},delegateYield:function delegateYield(e,r,n){return this.delegate={iterator:values(e),resultName:r,nextLoc:n},"next"===this.method&&(this.arg=t),y}},e}function rocketchat_e2e_room_asyncGeneratorStep(n,t,e,r,o,a,c){try{var i=n[a](c),u=i.value}catch(n){return void e(n)}i.done?t(u):Promise.resolve(u).then(r,o)}function rocketchat_e2e_room_asyncToGenerator(n){return function(){var t=this,e=arguments;return new Promise((function(r,o){var a=n.apply(t,e);function _next(n){rocketchat_e2e_room_asyncGeneratorStep(a,r,o,_next,_throw,"next",n)}function _throw(n){rocketchat_e2e_room_asyncGeneratorStep(a,r,o,_next,_throw,"throw",n)}_next(void 0)}))}}function _defineProperties(e,r){for(var t=0;t<r.length;t++){var o=r[t];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,rocketchat_e2e_room_toPropertyKey(o.key),o)}}function _setPrototypeOf(t,e){return _setPrototypeOf=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t},_setPrototypeOf(t,e)}function _createSuper(t){var r=_isNativeReflectConstruct();return function(){var e,o=_getPrototypeOf(t);if(r){var s=_getPrototypeOf(this).constructor;e=Reflect.construct(o,arguments,s)}else e=o.apply(this,arguments);return function _possibleConstructorReturn(t,e){if(e&&("object"==rocketchat_e2e_room_typeof(e)||"function"==typeof e))return e;if(void 0!==e)throw new TypeError("Derived constructors may only return object or undefined");return _assertThisInitialized(t)}(this,e)}}function _assertThisInitialized(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function _isNativeReflectConstruct(){try{var t=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(t){}return(_isNativeReflectConstruct=function _isNativeReflectConstruct(){return!!t})()}function _getPrototypeOf(t){return _getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(t){return t.__proto__||Object.getPrototypeOf(t)},_getPrototypeOf(t)}function rocketchat_e2e_room_defineProperty(e,r,t){return(r=rocketchat_e2e_room_toPropertyKey(r))in e?Object.defineProperty(e,r,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[r]=t,e}function rocketchat_e2e_room_toPropertyKey(t){var i=function rocketchat_e2e_room_toPrimitive(t,r){if("object"!=rocketchat_e2e_room_typeof(t)||!t)return t;var e=t[Symbol.toPrimitive];if(void 0!==e){var i=e.call(t,r||"default");if("object"!=rocketchat_e2e_room_typeof(i))return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===r?String:Number)(t)}(t,"string");return"symbol"==rocketchat_e2e_room_typeof(i)?i:i+""}function _asyncIterator(r){var n,t,o,e=2;for("undefined"!=typeof Symbol&&(t=Symbol.asyncIterator,o=Symbol.iterator);e--;){if(t&&null!=(n=r[t]))return n.call(r);if(o&&null!=(n=r[o]))return new AsyncFromSyncIterator(n.call(r));t="@@asyncIterator",o="@@iterator"}throw new TypeError("Object is not async iterable")}function AsyncFromSyncIterator(r){function AsyncFromSyncIteratorContinuation(r){if(Object(r)!==r)return Promise.reject(new TypeError(r+" is not an object."));var n=r.done;return Promise.resolve(r.value).then((function(r){return{value:r,done:n}}))}return AsyncFromSyncIterator=function AsyncFromSyncIterator(r){this.s=r,this.n=r.next},AsyncFromSyncIterator.prototype={s:null,n:null,next:function next(){return AsyncFromSyncIteratorContinuation(this.n.apply(this.s,arguments))},return:function _return(r){var n=this.s.return;return void 0===n?Promise.resolve({value:r,done:!0}):AsyncFromSyncIteratorContinuation(n.apply(this.s,arguments))},throw:function _throw(r){var n=this.s.return;return void 0===n?Promise.reject(r):AsyncFromSyncIteratorContinuation(n.apply(this.s,arguments))}},new AsyncFromSyncIterator(r)}var KEY_ID=Symbol("keyID"),PAUSED=Symbol("PAUSED"),permitedMutations=rocketchat_e2e_room_defineProperty(rocketchat_e2e_room_defineProperty(rocketchat_e2e_room_defineProperty(rocketchat_e2e_room_defineProperty(rocketchat_e2e_room_defineProperty({},E2ERoomState.h.NOT_STARTED,[E2ERoomState.h.ESTABLISHING,E2ERoomState.h.DISABLED,E2ERoomState.h.KEYS_RECEIVED]),E2ERoomState.h.READY,[E2ERoomState.h.DISABLED,E2ERoomState.h.CREATING_KEYS,E2ERoomState.h.WAITING_KEYS]),E2ERoomState.h.ERROR,[E2ERoomState.h.KEYS_RECEIVED,E2ERoomState.h.NOT_STARTED]),E2ERoomState.h.WAITING_KEYS,[E2ERoomState.h.KEYS_RECEIVED,E2ERoomState.h.ERROR,E2ERoomState.h.DISABLED]),E2ERoomState.h.ESTABLISHING,[E2ERoomState.h.READY,E2ERoomState.h.KEYS_RECEIVED,E2ERoomState.h.ERROR,E2ERoomState.h.DISABLED,E2ERoomState.h.WAITING_KEYS,E2ERoomState.h.CREATING_KEYS]),E2ERoom=function(_Emitter){!function _inherits(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),Object.defineProperty(t,"prototype",{writable:!1}),e&&_setPrototypeOf(t,e)}(E2ERoom,_Emitter);var _encryptGroupKeyForParticipantsWaitingForTheKeys,_decrypt,_decryptMessage,_decryptContent,_encryptMessage,_encryptMessageContent,_encryptText,_decryptFile,_encryptFile,_encryptGroupKeyForParticipant,_encryptOldKeysForParticipant,_encryptKeyForOtherParticipants,_resetRoomKey,_createGroupKey,_createNewGroupKey,_importGroupKey,_exportSessionKey,_decryptSessionKey,_handshake,_decryptPendingMessages,_exportOldRoomKeys,_decryptOldRoomKeys,_decryptSubscription,_shouldConvertSentMessages,_super=_createSuper(E2ERoom);function E2ERoom(userId,room){var _this;return function _classCallCheck(a,n){if(!(a instanceof n))throw new TypeError("Cannot call a class as a function")}(this,E2ERoom),rocketchat_e2e_room_defineProperty(_assertThisInitialized(_this=_super.call(this)),"state",void 0),rocketchat_e2e_room_defineProperty(_assertThisInitialized(_this),PAUSED,void 0),_this.userId=userId,_this.roomId=room._id,_this.typeOfRoom=room.t,_this.roomKeyId=room.e2eKeyId,_this.once(E2ERoomState.h.READY,rocketchat_e2e_room_asyncToGenerator(rocketchat_e2e_room_regeneratorRuntime().mark((function _callee(){return rocketchat_e2e_room_regeneratorRuntime().wrap((function _callee$(_context){for(;;)switch(_context.prev=_context.next){case 0:return _context.next=2,_this.decryptOldRoomKeys();case 2:return _context.abrupt("return",_this.decryptPendingMessages());case 3:case"end":return _context.stop()}}),_callee)})))),_this.once(E2ERoomState.h.READY,(function(){return _this.decryptSubscription()})),_this.on("STATE_CHANGED",(function(prev){_this.roomId===RoomManager.RoomManager.opened&&_this.log("[PREV: ".concat(prev,"]"),"State CHANGED")})),_this.on("STATE_CHANGED",(function(){return _this.handshake()})),_this.setState(E2ERoomState.h.NOT_STARTED),_this}return function _createClass(e,r,t){return r&&_defineProperties(e.prototype,r),t&&_defineProperties(e,t),Object.defineProperty(e,"prototype",{writable:!1}),e}(E2ERoom,[{key:"log",value:function log(){for(var _len=arguments.length,msg=new Array(_len),_key=0;_key<_len;_key++)msg[_key]=arguments[_key];logger_log.apply(void 0,["E2E ROOM { state: ".concat(this.state,", rid: ").concat(this.roomId," }")].concat(msg))}},{key:"error",value:function error(){for(var _len2=arguments.length,msg=new Array(_len2),_key2=0;_key2<_len2;_key2++)msg[_key2]=arguments[_key2];logError.apply(void 0,["E2E ROOM { state: ".concat(this.state,", rid: ").concat(this.roomId," }")].concat(msg))}},{key:"hasSessionKey",value:function hasSessionKey(){return!!this.groupSessionKey}},{key:"getState",value:function getState(){return this.state}},{key:"setState",value:function setState(requestedState){var currentState=this.state,nextState=function filterMutation(currentState,nextState){return currentState===nextState?nextState===E2ERoomState.h.ERROR:currentState in permitedMutations?!!permitedMutations[currentState].includes(nextState)&&nextState:nextState}(currentState,requestedState);nextState?(this.state=nextState,this.log(currentState,"->",nextState),this.emit("STATE_CHANGED",currentState,nextState,this),this.emit(nextState,this)):this.error("invalid state ".concat(currentState," -> ").concat(requestedState))}},{key:"isReady",value:function isReady(){return this.state===E2ERoomState.h.READY}},{key:"isDisabled",value:function isDisabled(){return this.state===E2ERoomState.h.DISABLED}},{key:"enable",value:function enable(){this.state!==E2ERoomState.h.READY&&this.setState(E2ERoomState.h.READY)}},{key:"disable",value:function disable(){this.setState(E2ERoomState.h.DISABLED)}},{key:"pause",value:function pause(){this.log("PAUSED",this[PAUSED],"->",!0),this[PAUSED]=!0,this.emit("PAUSED",!0)}},{key:"resume",value:function resume(){this.log("PAUSED",this[PAUSED],"->",!1),this[PAUSED]=!1,this.emit("PAUSED",!1)}},{key:"keyReceived",value:function keyReceived(){this.setState(E2ERoomState.h.KEYS_RECEIVED)}},{key:"shouldConvertSentMessages",value:(_shouldConvertSentMessages=rocketchat_e2e_room_asyncToGenerator(rocketchat_e2e_room_regeneratorRuntime().mark((function _callee2(message){var _this2=this;return rocketchat_e2e_room_regeneratorRuntime().wrap((function _callee2$(_context2){for(;;)switch(_context2.prev=_context2.next){case 0:if(this.isReady()&&!this[PAUSED]){_context2.next=2;break}return _context2.abrupt("return",!1);case 2:if(void 0!==this[PAUSED]){_context2.next=4;break}return _context2.abrupt("return",new Promise((function(resolve){_this2.once("PAUSED",resolve)})));case 4:if("/"!==message.msg[0]){_context2.next=6;break}return _context2.abrupt("return",!1);case 6:return _context2.abrupt("return",!0);case 7:case"end":return _context2.stop()}}),_callee2,this)}))),function shouldConvertSentMessages(_x){return _shouldConvertSentMessages.apply(this,arguments)})},{key:"shouldConvertReceivedMessages",value:function shouldConvertReceivedMessages(){return this.isReady()}},{key:"isWaitingKeys",value:function isWaitingKeys(){return this.state===E2ERoomState.h.WAITING_KEYS}},{key:"keyID",get:function get(){return this[KEY_ID]},set:function set(keyID){this[KEY_ID]=keyID}},{key:"decryptSubscription",value:(_decryptSubscription=rocketchat_e2e_room_asyncToGenerator(rocketchat_e2e_room_regeneratorRuntime().mark((function _callee3(){var _subscription$lastMes,subscription,message;return rocketchat_e2e_room_regeneratorRuntime().wrap((function _callee3$(_context3){for(;;)switch(_context3.prev=_context3.next){case 0:if(subscription=client.Subscriptions.findOne({rid:this.roomId}),"e2e"===(null===(_subscription$lastMes=subscription.lastMessage)||void 0===_subscription$lastMes?void 0:_subscription$lastMes.t)){_context3.next=4;break}return this.log("decryptSubscriptions nothing to do"),_context3.abrupt("return");case 4:return _context3.next=6,this.decryptMessage(subscription.lastMessage);case 6:message=_context3.sent,client.Subscriptions.update({_id:subscription._id},{$set:{lastMessage:message}}),this.log("decryptSubscriptions Done");case 9:case"end":return _context3.stop()}}),_callee3,this)}))),function decryptSubscription(){return _decryptSubscription.apply(this,arguments)})},{key:"decryptOldRoomKeys",value:(_decryptOldRoomKeys=rocketchat_e2e_room_asyncToGenerator(rocketchat_e2e_room_regeneratorRuntime().mark((function _callee4(){var sub,keys,_iteratorAbruptCompletion,_didIteratorError,_iteratorError,_iterator,_step,key,k;return rocketchat_e2e_room_regeneratorRuntime().wrap((function _callee4$(_context4){for(;;)switch(_context4.prev=_context4.next){case 0:if(null!=(sub=client.Subscriptions.findOne({rid:this.roomId}))&&sub.oldRoomKeys&&0!==(null==sub?void 0:sub.oldRoomKeys.length)){_context4.next=4;break}return this.log("decryptOldRoomKeys nothing to do"),_context4.abrupt("return");case 4:keys=[],_iteratorAbruptCompletion=!1,_didIteratorError=!1,_context4.prev=7,_iterator=_asyncIterator(sub.oldRoomKeys);case 9:return _context4.next=11,_iterator.next();case 11:if(!(_iteratorAbruptCompletion=!(_step=_context4.sent).done)){_context4.next=27;break}return key=_step.value,_context4.prev=13,_context4.next=16,this.decryptSessionKey(key.E2EKey);case 16:k=_context4.sent,keys.push(rocketchat_e2e_room_objectSpread(rocketchat_e2e_room_objectSpread({},key),{},{E2EKey:k})),_context4.next=24;break;case 20:_context4.prev=20,_context4.t0=_context4.catch(13),this.error("Cannot decrypt old room key with id ".concat(key.e2eKeyId,". This is likely because user private key changed or is missing. Skipping")),keys.push(rocketchat_e2e_room_objectSpread(rocketchat_e2e_room_objectSpread({},key),{},{E2EKey:null}));case 24:_iteratorAbruptCompletion=!1,_context4.next=9;break;case 27:_context4.next=33;break;case 29:_context4.prev=29,_context4.t1=_context4.catch(7),_didIteratorError=!0,_iteratorError=_context4.t1;case 33:if(_context4.prev=33,_context4.prev=34,!_iteratorAbruptCompletion||null==_iterator.return){_context4.next=38;break}return _context4.next=38,_iterator.return();case 38:if(_context4.prev=38,!_didIteratorError){_context4.next=41;break}throw _iteratorError;case 41:return _context4.finish(38);case 42:return _context4.finish(33);case 43:this.oldKeys=keys,this.log("decryptOldRoomKeys Done");case 45:case"end":return _context4.stop()}}),_callee4,this,[[7,29,33,43],[13,20],[34,,38,42]])}))),function decryptOldRoomKeys(){return _decryptOldRoomKeys.apply(this,arguments)})},{key:"exportOldRoomKeys",value:(_exportOldRoomKeys=rocketchat_e2e_room_asyncToGenerator(rocketchat_e2e_room_regeneratorRuntime().mark((function _callee5(oldKeys){var keys,_iteratorAbruptCompletion2,_didIteratorError2,_iteratorError2,_iterator2,_step2,key,k;return rocketchat_e2e_room_regeneratorRuntime().wrap((function _callee5$(_context5){for(;;)switch(_context5.prev=_context5.next){case 0:if(this.log("exportOldRoomKeys starting"),oldKeys&&0!==oldKeys.length){_context5.next=4;break}return this.log("exportOldRoomKeys nothing to do"),_context5.abrupt("return");case 4:keys=[],_iteratorAbruptCompletion2=!1,_didIteratorError2=!1,_context5.prev=7,_iterator2=_asyncIterator(oldKeys);case 9:return _context5.next=11,_iterator2.next();case 11:if(!(_iteratorAbruptCompletion2=!(_step2=_context5.sent).done)){_context5.next=28;break}if(key=_step2.value,_context5.prev=13,key.E2EKey){_context5.next=16;break}return _context5.abrupt("continue",25);case 16:return _context5.next=18,this.exportSessionKey(key.E2EKey);case 18:k=_context5.sent,keys.push(rocketchat_e2e_room_objectSpread(rocketchat_e2e_room_objectSpread({},key),{},{E2EKey:k})),_context5.next=25;break;case 22:_context5.prev=22,_context5.t0=_context5.catch(13),this.error("Cannot decrypt old room key with id ".concat(key.e2eKeyId,". This is likely because user private key changed or is missing. Skipping"));case 25:_iteratorAbruptCompletion2=!1,_context5.next=9;break;case 28:_context5.next=34;break;case 30:_context5.prev=30,_context5.t1=_context5.catch(7),_didIteratorError2=!0,_iteratorError2=_context5.t1;case 34:if(_context5.prev=34,_context5.prev=35,!_iteratorAbruptCompletion2||null==_iterator2.return){_context5.next=39;break}return _context5.next=39,_iterator2.return();case 39:if(_context5.prev=39,!_didIteratorError2){_context5.next=42;break}throw _iteratorError2;case 42:return _context5.finish(39);case 43:return _context5.finish(34);case 44:return this.log("exportOldRoomKeys Done: ".concat(keys.length," keys exported")),_context5.abrupt("return",keys);case 46:case"end":return _context5.stop()}}),_callee5,this,[[7,30,34,44],[13,22],[35,,39,43]])}))),function exportOldRoomKeys(_x2){return _exportOldRoomKeys.apply(this,arguments)})},{key:"decryptPendingMessages",value:(_decryptPendingMessages=rocketchat_e2e_room_asyncToGenerator(rocketchat_e2e_room_regeneratorRuntime().mark((function _callee7(){var _this3=this;return rocketchat_e2e_room_regeneratorRuntime().wrap((function _callee7$(_context7){for(;;)switch(_context7.prev=_context7.next){case 0:return _context7.abrupt("return",client.Messages.find({rid:this.roomId,t:"e2e",e2e:"pending"}).forEach(function(){var _ref3=rocketchat_e2e_room_asyncToGenerator(rocketchat_e2e_room_regeneratorRuntime().mark((function _callee6(_ref2){var _id,msg;return rocketchat_e2e_room_regeneratorRuntime().wrap((function _callee6$(_context6){for(;;)switch(_context6.prev=_context6.next){case 0:return _id=_ref2._id,msg=_objectWithoutProperties(_ref2,_excluded),_context6.t0=client.Messages,_context6.t1={_id:_id},_context6.next=5,_this3.decryptMessage(msg);case 5:_context6.t2=_context6.sent,_context6.t0.update.call(_context6.t0,_context6.t1,_context6.t2);case 7:case"end":return _context6.stop()}}),_callee6)})));return function(_x3){return _ref3.apply(this,arguments)}}()));case 1:case"end":return _context7.stop()}}),_callee7,this)}))),function decryptPendingMessages(){return _decryptPendingMessages.apply(this,arguments)})},{key:"handshake",value:(_handshake=rocketchat_e2e_room_asyncToGenerator(rocketchat_e2e_room_regeneratorRuntime().mark((function _callee8(){var groupKey,room;return rocketchat_e2e_room_regeneratorRuntime().wrap((function _callee8$(_context8){for(;;)switch(_context8.prev=_context8.next){case 0:if(e2e.isReady()){_context8.next=2;break}return _context8.abrupt("return");case 2:if(this.state===E2ERoomState.h.KEYS_RECEIVED||this.state===E2ERoomState.h.NOT_STARTED){_context8.next=4;break}return _context8.abrupt("return");case 4:if(this.setState(E2ERoomState.h.ESTABLISHING),_context8.prev=5,!(groupKey=client.Subscriptions.findOne({rid:this.roomId}).E2EKey)){_context8.next=12;break}return _context8.next=10,this.importGroupKey(groupKey);case 10:return this.setState(E2ERoomState.h.READY),_context8.abrupt("return");case 12:_context8.next=19;break;case 14:return _context8.prev=14,_context8.t0=_context8.catch(5),this.setState(E2ERoomState.h.ERROR),this.error("Error fetching group key: ",_context8.t0),_context8.abrupt("return");case 19:if(_context8.prev=19,(room=client.ChatRoom.findOne({_id:this.roomId})).e2eKeyId||room.u._id!==this.userId){_context8.next=27;break}return this.setState(E2ERoomState.h.CREATING_KEYS),_context8.next=25,this.createGroupKey();case 25:return this.setState(E2ERoomState.h.READY),_context8.abrupt("return");case 27:this.setState(E2ERoomState.h.WAITING_KEYS),this.log("Requesting room key"),SDKClient.sdk.publish("notify-room-users",["".concat(this.roomId,"/e2ekeyRequest"),this.roomId,room.e2eKeyId]),_context8.next=35;break;case 32:_context8.prev=32,_context8.t1=_context8.catch(19),this.setState(E2ERoomState.h.ERROR);case 35:case"end":return _context8.stop()}}),_callee8,this,[[5,14],[19,32]])}))),function handshake(){return _handshake.apply(this,arguments)})},{key:"isSupportedRoomType",value:function isSupportedRoomType(type){return roomCoordinator.roomCoordinator.getRoomDirectives(type).allowRoomSettingChange({},IRoomTypeConfig.Iq.E2E)}},{key:"decryptSessionKey",value:(_decryptSessionKey=rocketchat_e2e_room_asyncToGenerator(rocketchat_e2e_room_regeneratorRuntime().mark((function _callee9(key){return rocketchat_e2e_room_regeneratorRuntime().wrap((function _callee9$(_context9){for(;;)switch(_context9.prev=_context9.next){case 0:return _context9.t0=importAESKey,_context9.t1=JSON,_context9.next=4,this.exportSessionKey(key);case 4:return _context9.t2=_context9.sent,_context9.t3=_context9.t1.parse.call(_context9.t1,_context9.t2),_context9.abrupt("return",(0,_context9.t0)(_context9.t3));case 7:case"end":return _context9.stop()}}),_callee9,this)}))),function decryptSessionKey(_x4){return _decryptSessionKey.apply(this,arguments)})},{key:"exportSessionKey",value:(_exportSessionKey=rocketchat_e2e_room_asyncToGenerator(rocketchat_e2e_room_regeneratorRuntime().mark((function _callee10(key){var decryptedKey;return rocketchat_e2e_room_regeneratorRuntime().wrap((function _callee10$(_context10){for(;;)switch(_context10.prev=_context10.next){case 0:return key=key.slice(12),key=base64.o.decode(key),_context10.next=4,decryptRSA(e2e.privateKey,key);case 4:return decryptedKey=_context10.sent,_context10.abrupt("return",helper_toString(decryptedKey));case 6:case"end":return _context10.stop()}}),_callee10)}))),function exportSessionKey(_x5){return _exportSessionKey.apply(this,arguments)})},{key:"importGroupKey",value:(_importGroupKey=rocketchat_e2e_room_asyncToGenerator(rocketchat_e2e_room_regeneratorRuntime().mark((function _callee11(groupKey){var decryptedKey,key;return rocketchat_e2e_room_regeneratorRuntime().wrap((function _callee11$(_context11){for(;;)switch(_context11.prev=_context11.next){case 0:return this.log("Importing room key ->",this.roomId),groupKey=groupKey.slice(12),groupKey=base64.o.decode(groupKey),_context11.prev=3,_context11.next=6,decryptRSA(e2e.privateKey,groupKey);case 6:decryptedKey=_context11.sent,this.sessionKeyExportedString=helper_toString(decryptedKey),_context11.next=14;break;case 10:return _context11.prev=10,_context11.t0=_context11.catch(3),this.error("Error decrypting group key: ",_context11.t0),_context11.abrupt("return",!1);case 14:if(this.keyID){_context11.next=21;break}if(_context11.t1=this.roomKeyId,_context11.t1){_context11.next=20;break}return _context11.next=19,createSha256HashFromText(this.sessionKeyExportedString);case 19:_context11.t1=_context11.sent.slice(0,12);case 20:this.keyID=_context11.t1;case 21:return _context11.prev=21,_context11.next=24,importAESKey(JSON.parse(this.sessionKeyExportedString));case 24:key=_context11.sent,this.groupSessionKey=key,_context11.next=32;break;case 28:return _context11.prev=28,_context11.t2=_context11.catch(21),this.error("Error importing group key: ",_context11.t2),_context11.abrupt("return",!1);case 32:return _context11.abrupt("return",!0);case 33:case"end":return _context11.stop()}}),_callee11,this,[[3,10],[21,28]])}))),function importGroupKey(_x6){return _importGroupKey.apply(this,arguments)})},{key:"createNewGroupKey",value:(_createNewGroupKey=rocketchat_e2e_room_asyncToGenerator(rocketchat_e2e_room_regeneratorRuntime().mark((function _callee12(){var sessionKeyExported;return rocketchat_e2e_room_regeneratorRuntime().wrap((function _callee12$(_context12){for(;;)switch(_context12.prev=_context12.next){case 0:return _context12.next=2,generateAESKey();case 2:return this.groupSessionKey=_context12.sent,_context12.next=5,exportJWKKey(this.groupSessionKey);case 5:return sessionKeyExported=_context12.sent,this.sessionKeyExportedString=JSON.stringify(sessionKeyExported),_context12.next=9,createSha256HashFromText(this.sessionKeyExportedString);case 9:this.keyID=_context12.sent.slice(0,12);case 10:case"end":return _context12.stop()}}),_callee12,this)}))),function createNewGroupKey(){return _createNewGroupKey.apply(this,arguments)})},{key:"createGroupKey",value:(_createGroupKey=rocketchat_e2e_room_asyncToGenerator(rocketchat_e2e_room_regeneratorRuntime().mark((function _callee13(){return rocketchat_e2e_room_regeneratorRuntime().wrap((function _callee13$(_context13){for(;;)switch(_context13.prev=_context13.next){case 0:return this.log("Creating room key"),_context13.prev=1,_context13.next=4,this.createNewGroupKey();case 4:return _context13.next=6,SDKClient.sdk.call("e2e.setRoomKeyID",this.roomId,this.keyID);case 6:return _context13.t0=SDKClient.sdk.rest,_context13.t1=this.roomId,_context13.t2=this.userId,_context13.next=11,this.encryptGroupKeyForParticipant(e2e.publicKey);case 11:return _context13.t3=_context13.sent,_context13.t4={rid:_context13.t1,uid:_context13.t2,key:_context13.t3},_context13.next=15,_context13.t0.post.call(_context13.t0,"/v1/e2e.updateGroupKey",_context13.t4);case 15:return _context13.next=17,this.encryptKeyForOtherParticipants();case 17:_context13.next=23;break;case 19:throw _context13.prev=19,_context13.t5=_context13.catch(1),this.error("Error exporting group key: ",_context13.t5),_context13.t5;case 23:case"end":return _context13.stop()}}),_callee13,this,[[1,19]])}))),function createGroupKey(){return _createGroupKey.apply(this,arguments)})},{key:"resetRoomKey",value:(_resetRoomKey=rocketchat_e2e_room_asyncToGenerator(rocketchat_e2e_room_regeneratorRuntime().mark((function _callee14(){var e2eNewKeys;return rocketchat_e2e_room_regeneratorRuntime().wrap((function _callee14$(_context14){for(;;)switch(_context14.prev=_context14.next){case 0:if(this.log("Resetting room key"),e2e.publicKey){_context14.next=4;break}return this.error("Cannot reset room key. No public key found."),_context14.abrupt("return");case 4:return this.setState(E2ERoomState.h.CREATING_KEYS),_context14.prev=5,_context14.next=8,this.createNewGroupKey();case 8:return _context14.t0=this.keyID,_context14.next=11,this.encryptGroupKeyForParticipant(e2e.publicKey);case 11:return _context14.t1=_context14.sent,e2eNewKeys={e2eKeyId:_context14.t0,e2eKey:_context14.t1},this.setState(E2ERoomState.h.READY),this.log("Room key reset done for room ".concat(this.roomId)),_context14.abrupt("return",e2eNewKeys);case 18:throw _context14.prev=18,_context14.t2=_context14.catch(5),this.error("Error resetting group key: ",_context14.t2),_context14.t2;case 22:case"end":return _context14.stop()}}),_callee14,this,[[5,18]])}))),function resetRoomKey(){return _resetRoomKey.apply(this,arguments)})},{key:"onRoomKeyReset",value:function onRoomKeyReset(keyID){this.log("Room keyID was reset. New keyID: ".concat(keyID," Previous keyID: ").concat(this.keyID)),this.setState(E2ERoomState.h.WAITING_KEYS),this.keyID=keyID,this.groupSessionKey=void 0,this.sessionKeyExportedString=void 0,this.sessionKeyExported=void 0,this.oldKeys=void 0}},{key:"encryptKeyForOtherParticipants",value:(_encryptKeyForOtherParticipants=rocketchat_e2e_room_asyncToGenerator(rocketchat_e2e_room_regeneratorRuntime().mark((function _callee15(){var mySub,decryptedOldGroupKeys,users,usersSuggestedGroupKeys,_iteratorAbruptCompletion3,_didIteratorError3,_iteratorError3,_iterator3,_step3,user,encryptedGroupKey,oldKeys;return rocketchat_e2e_room_regeneratorRuntime().wrap((function _callee15$(_context15){for(;;)switch(_context15.prev=_context15.next){case 0:return _context15.prev=0,mySub=client.Subscriptions.findOne({rid:this.roomId}),_context15.next=4,this.exportOldRoomKeys(null==mySub?void 0:mySub.oldRoomKeys);case 4:return decryptedOldGroupKeys=_context15.sent,_context15.next=7,SDKClient.sdk.call("e2e.getUsersOfRoomWithoutKey",this.roomId);case 7:if(users=_context15.sent.users.filter((function(user){var _user$e2e;return null==user||null===(_user$e2e=user.e2e)||void 0===_user$e2e?void 0:_user$e2e.public_key})),users.length){_context15.next=10;break}return _context15.abrupt("return");case 10:usersSuggestedGroupKeys=rocketchat_e2e_room_defineProperty({},this.roomId,[]),_iteratorAbruptCompletion3=!1,_didIteratorError3=!1,_context15.prev=13,_iterator3=_asyncIterator(users);case 15:return _context15.next=17,_iterator3.next();case 17:if(!(_iteratorAbruptCompletion3=!(_step3=_context15.sent).done)){_context15.next=29;break}return user=_step3.value,_context15.next=21,this.encryptGroupKeyForParticipant(user.e2e.public_key);case 21:return encryptedGroupKey=_context15.sent,_context15.next=24,this.encryptOldKeysForParticipant(user.e2e.public_key,decryptedOldGroupKeys);case 24:oldKeys=_context15.sent,usersSuggestedGroupKeys[this.roomId].push(rocketchat_e2e_room_objectSpread({_id:user._id,key:encryptedGroupKey},oldKeys&&{oldKeys:oldKeys}));case 26:_iteratorAbruptCompletion3=!1,_context15.next=15;break;case 29:_context15.next=35;break;case 31:_context15.prev=31,_context15.t0=_context15.catch(13),_didIteratorError3=!0,_iteratorError3=_context15.t0;case 35:if(_context15.prev=35,_context15.prev=36,!_iteratorAbruptCompletion3||null==_iterator3.return){_context15.next=40;break}return _context15.next=40,_iterator3.return();case 40:if(_context15.prev=40,!_didIteratorError3){_context15.next=43;break}throw _iteratorError3;case 43:return _context15.finish(40);case 44:return _context15.finish(35);case 45:return _context15.next=47,SDKClient.sdk.rest.post("/v1/e2e.provideUsersSuggestedGroupKeys",{usersSuggestedGroupKeys:usersSuggestedGroupKeys});case 47:_context15.next=52;break;case 49:return _context15.prev=49,_context15.t1=_context15.catch(0),_context15.abrupt("return",this.error("Error getting room users: ",_context15.t1));case 52:case"end":return _context15.stop()}}),_callee15,this,[[0,49],[13,31,35,45],[36,,40,44]])}))),function encryptKeyForOtherParticipants(){return _encryptKeyForOtherParticipants.apply(this,arguments)})},{key:"encryptOldKeysForParticipant",value:(_encryptOldKeysForParticipant=rocketchat_e2e_room_asyncToGenerator(rocketchat_e2e_room_regeneratorRuntime().mark((function _callee16(public_key,oldRoomKeys){var userKey,keys,_iteratorAbruptCompletion4,_didIteratorError4,_iteratorError4,_iterator4,_step4,oldRoomKey,encryptedKey,encryptedKeyToString;return rocketchat_e2e_room_regeneratorRuntime().wrap((function _callee16$(_context16){for(;;)switch(_context16.prev=_context16.next){case 0:if(oldRoomKeys&&0!==oldRoomKeys.length){_context16.next=2;break}return _context16.abrupt("return");case 2:return _context16.prev=2,_context16.next=5,importRSAKey(JSON.parse(public_key),["encrypt"]);case 5:userKey=_context16.sent,_context16.next=11;break;case 8:return _context16.prev=8,_context16.t0=_context16.catch(2),_context16.abrupt("return",this.error("Error importing user key: ",_context16.t0));case 11:_context16.prev=11,keys=[],_iteratorAbruptCompletion4=!1,_didIteratorError4=!1,_context16.prev=15,_iterator4=_asyncIterator(oldRoomKeys);case 17:return _context16.next=19,_iterator4.next();case 19:if(!(_iteratorAbruptCompletion4=!(_step4=_context16.sent).done)){_context16.next=31;break}if((oldRoomKey=_step4.value).E2EKey){_context16.next=23;break}return _context16.abrupt("continue",28);case 23:return _context16.next=25,encryptRSA(userKey,toArrayBuffer(oldRoomKey.E2EKey));case 25:encryptedKey=_context16.sent,encryptedKeyToString=oldRoomKey.e2eKeyId+base64.o.encode(new Uint8Array(encryptedKey)),keys.push(rocketchat_e2e_room_objectSpread(rocketchat_e2e_room_objectSpread({},oldRoomKey),{},{E2EKey:encryptedKeyToString}));case 28:_iteratorAbruptCompletion4=!1,_context16.next=17;break;case 31:_context16.next=37;break;case 33:_context16.prev=33,_context16.t1=_context16.catch(15),_didIteratorError4=!0,_iteratorError4=_context16.t1;case 37:if(_context16.prev=37,_context16.prev=38,!_iteratorAbruptCompletion4||null==_iterator4.return){_context16.next=42;break}return _context16.next=42,_iterator4.return();case 42:if(_context16.prev=42,!_didIteratorError4){_context16.next=45;break}throw _iteratorError4;case 45:return _context16.finish(42);case 46:return _context16.finish(37);case 47:return _context16.abrupt("return",keys);case 50:return _context16.prev=50,_context16.t2=_context16.catch(11),_context16.abrupt("return",this.error("Error encrypting user key: ",_context16.t2));case 53:case"end":return _context16.stop()}}),_callee16,this,[[2,8],[11,50],[15,33,37,47],[38,,42,46]])}))),function encryptOldKeysForParticipant(_x7,_x8){return _encryptOldKeysForParticipant.apply(this,arguments)})},{key:"encryptGroupKeyForParticipant",value:(_encryptGroupKeyForParticipant=rocketchat_e2e_room_asyncToGenerator(rocketchat_e2e_room_regeneratorRuntime().mark((function _callee17(public_key){var userKey,encryptedUserKey,encryptedUserKeyToString;return rocketchat_e2e_room_regeneratorRuntime().wrap((function _callee17$(_context17){for(;;)switch(_context17.prev=_context17.next){case 0:return _context17.prev=0,_context17.next=3,importRSAKey(JSON.parse(public_key),["encrypt"]);case 3:userKey=_context17.sent,_context17.next=9;break;case 6:return _context17.prev=6,_context17.t0=_context17.catch(0),_context17.abrupt("return",this.error("Error importing user key: ",_context17.t0));case 9:return _context17.prev=9,_context17.next=12,encryptRSA(userKey,toArrayBuffer(this.sessionKeyExportedString));case 12:return encryptedUserKey=_context17.sent,encryptedUserKeyToString=this.keyID+base64.o.encode(new Uint8Array(encryptedUserKey)),_context17.abrupt("return",encryptedUserKeyToString);case 17:return _context17.prev=17,_context17.t1=_context17.catch(9),_context17.abrupt("return",this.error("Error encrypting user key: ",_context17.t1));case 20:case"end":return _context17.stop()}}),_callee17,this,[[0,6],[9,17]])}))),function encryptGroupKeyForParticipant(_x9){return _encryptGroupKeyForParticipant.apply(this,arguments)})},{key:"encryptFile",value:(_encryptFile=rocketchat_e2e_room_asyncToGenerator(rocketchat_e2e_room_regeneratorRuntime().mark((function _callee18(file){var fileArrayBuffer,hash,vector,key,result,exportedKey,fileName,encryptedFile;return rocketchat_e2e_room_regeneratorRuntime().wrap((function _callee18$(_context18){for(;;)switch(_context18.prev=_context18.next){case 0:return _context18.next=2,readFileAsArrayBuffer(file);case 2:return fileArrayBuffer=_context18.sent,_context18.next=5,sha256HashFromArrayBuffer(new Uint8Array(fileArrayBuffer));case 5:return hash=_context18.sent,vector=crypto.getRandomValues(new Uint8Array(16)),_context18.next=9,generateAESCTRKey();case 9:return key=_context18.sent,_context18.prev=10,_context18.next=13,encryptAESCTR(vector,key,fileArrayBuffer);case 13:result=_context18.sent,_context18.next=20;break;case 16:return _context18.prev=16,_context18.t0=_context18.catch(10),console.log(_context18.t0),_context18.abrupt("return",this.error("Error encrypting group key: ",_context18.t0));case 20:return _context18.next=22,window.crypto.subtle.exportKey("jwk",key);case 22:return exportedKey=_context18.sent,_context18.next=25,createSha256HashFromText(file.name);case 25:return fileName=_context18.sent,encryptedFile=new File([toArrayBuffer(result)],fileName),_context18.abrupt("return",{file:encryptedFile,key:exportedKey,iv:base64.o.encode(vector),type:file.type,hash:hash});case 28:case"end":return _context18.stop()}}),_callee18,this,[[10,16]])}))),function encryptFile(_x10){return _encryptFile.apply(this,arguments)})},{key:"decryptFile",value:(_decryptFile=rocketchat_e2e_room_asyncToGenerator(rocketchat_e2e_room_regeneratorRuntime().mark((function _callee19(file,key,iv){var ivArray,cryptoKey;return rocketchat_e2e_room_regeneratorRuntime().wrap((function _callee19$(_context19){for(;;)switch(_context19.prev=_context19.next){case 0:return ivArray=base64.o.decode(iv),_context19.next=3,window.crypto.subtle.importKey("jwk",key,{name:"AES-CTR"},!0,["encrypt","decrypt"]);case 3:return cryptoKey=_context19.sent,_context19.abrupt("return",window.crypto.subtle.decrypt({name:"AES-CTR",counter:ivArray,length:64},cryptoKey,file));case 5:case"end":return _context19.stop()}}),_callee19)}))),function decryptFile(_x11,_x12,_x13){return _decryptFile.apply(this,arguments)})},{key:"encryptText",value:(_encryptText=rocketchat_e2e_room_asyncToGenerator(rocketchat_e2e_room_regeneratorRuntime().mark((function _callee20(data){var vector,result;return rocketchat_e2e_room_regeneratorRuntime().wrap((function _callee20$(_context20){for(;;)switch(_context20.prev=_context20.next){case 0:return vector=crypto.getRandomValues(new Uint8Array(16)),_context20.prev=1,_context20.next=4,encryptAES(vector,this.groupSessionKey,data);case 4:return result=_context20.sent,_context20.abrupt("return",this.keyID+base64.o.encode(joinVectorAndEcryptedData(vector,result)));case 8:throw _context20.prev=8,_context20.t0=_context20.catch(1),this.error("Error encrypting message: ",_context20.t0),_context20.t0;case 12:case"end":return _context20.stop()}}),_callee20,this,[[1,8]])}))),function encryptText(_x14){return _encryptText.apply(this,arguments)})},{key:"encryptMessageContent",value:(_encryptMessageContent=rocketchat_e2e_room_asyncToGenerator(rocketchat_e2e_room_regeneratorRuntime().mark((function _callee21(contentToBeEncrypted){var data;return rocketchat_e2e_room_regeneratorRuntime().wrap((function _callee21$(_context21){for(;;)switch(_context21.prev=_context21.next){case 0:return data=(new TextEncoder).encode(ejson_default().stringify(contentToBeEncrypted)),_context21.next=3,this.encryptText(data);case 3:return _context21.t0=_context21.sent,_context21.abrupt("return",{algorithm:"rc.v1.aes-sha2",ciphertext:_context21.t0});case 5:case"end":return _context21.stop()}}),_callee21,this)}))),function encryptMessageContent(_x15){return _encryptMessageContent.apply(this,arguments)})},{key:"encryptMessage",value:(_encryptMessage=rocketchat_e2e_room_asyncToGenerator(rocketchat_e2e_room_regeneratorRuntime().mark((function _callee22(message){var msg,attachments,rest,content;return rocketchat_e2e_room_regeneratorRuntime().wrap((function _callee22$(_context22){for(;;)switch(_context22.prev=_context22.next){case 0:return msg=message.msg,attachments=message.attachments,rest=_objectWithoutProperties(message,_excluded2),_context22.next=3,this.encryptMessageContent({msg:msg,attachments:attachments});case 3:return content=_context22.sent,_context22.abrupt("return",rocketchat_e2e_room_objectSpread(rocketchat_e2e_room_objectSpread({},rest),{},{content:content,t:"e2e",e2e:"pending"}));case 5:case"end":return _context22.stop()}}),_callee22,this)}))),function encryptMessage(_x16){return _encryptMessage.apply(this,arguments)})},{key:"encrypt",value:function encrypt(message){if(this.isSupportedRoomType(this.typeOfRoom)){if(!this.groupSessionKey)throw new Error((0,i18n.t)("E2E_Invalid_Key"));var ts=new Date,data=new TextEncoder("UTF-8").encode(ejson_default().stringify({_id:message._id,text:message.msg,userId:this.userId,ts:ts}));return this.encryptText(data)}}},{key:"decryptContent",value:(_decryptContent=rocketchat_e2e_room_asyncToGenerator(rocketchat_e2e_room_regeneratorRuntime().mark((function _callee23(data){var content;return rocketchat_e2e_room_regeneratorRuntime().wrap((function _callee23$(_context23){for(;;)switch(_context23.prev=_context23.next){case 0:if(!data.content||"rc.v1.aes-sha2"!==data.content.algorithm){_context23.next=5;break}return _context23.next=3,this.decrypt(data.content.ciphertext);case 3:content=_context23.sent,Object.assign(data,content);case 5:return _context23.abrupt("return",data);case 6:case"end":return _context23.stop()}}),_callee23,this)}))),function decryptContent(_x17){return _decryptContent.apply(this,arguments)})},{key:"decryptMessage",value:(_decryptMessage=rocketchat_e2e_room_asyncToGenerator(rocketchat_e2e_room_regeneratorRuntime().mark((function _callee24(message){var data;return rocketchat_e2e_room_regeneratorRuntime().wrap((function _callee24$(_context24){for(;;)switch(_context24.prev=_context24.next){case 0:if("e2e"===message.t&&"done"!==message.e2e){_context24.next=2;break}return _context24.abrupt("return",message);case 2:if(!message.msg){_context24.next=7;break}return _context24.next=5,this.decrypt(message.msg);case 5:null!=(data=_context24.sent)&&data.text&&(message.msg=data.text);case 7:return _context24.next=9,this.decryptContent(message);case 9:return message=_context24.sent,_context24.abrupt("return",rocketchat_e2e_room_objectSpread(rocketchat_e2e_room_objectSpread({},message),{},{e2e:"done"}));case 11:case"end":return _context24.stop()}}),_callee24,this)}))),function decryptMessage(_x18){return _decryptMessage.apply(this,arguments)})},{key:"decrypt",value:(_decrypt=rocketchat_e2e_room_asyncToGenerator(rocketchat_e2e_room_regeneratorRuntime().mark((function _callee25(message){var keyID,oldKey,_this$oldKeys,oldRoomKey,_splitVectorAndEcrypt,_splitVectorAndEcrypt2,vector,cipherText,result;return rocketchat_e2e_room_regeneratorRuntime().wrap((function _callee25$(_context25){for(;;)switch(_context25.prev=_context25.next){case 0:if(keyID=message.slice(0,12),oldKey="",keyID===this.keyID){_context25.next=8;break}if(oldRoomKey=null===(_this$oldKeys=this.oldKeys)||void 0===_this$oldKeys?void 0:_this$oldKeys.find((function(key){return key.e2eKeyId===keyID}))){_context25.next=7;break}return this.error("Message is indecipherable. Message KeyID ".concat(keyID," not found in old room keys")),_context25.abrupt("return",{msg:(0,i18n.t)("E2E_indecipherable")});case 7:oldKey=oldRoomKey.E2EKey;case 8:return message=message.slice(12),_splitVectorAndEcrypt=splitVectorAndEcryptedData(base64.o.decode(message)),_splitVectorAndEcrypt2=rocketchat_e2e_room_slicedToArray(_splitVectorAndEcrypt,2),vector=_splitVectorAndEcrypt2[0],cipherText=_splitVectorAndEcrypt2[1],_context25.prev=10,_context25.next=13,decryptAES(vector,oldKey||this.groupSessionKey,cipherText);case 13:return result=_context25.sent,_context25.abrupt("return",ejson_default().parse(new TextDecoder("UTF-8").decode(new Uint8Array(result))));case 17:return _context25.prev=17,_context25.t0=_context25.catch(10),this.error("Error decrypting message: ",_context25.t0,message),_context25.abrupt("return",{msg:(0,i18n.t)("E2E_Key_Error")});case 21:case"end":return _context25.stop()}}),_callee25,this,[[10,17]])}))),function decrypt(_x19){return _decrypt.apply(this,arguments)})},{key:"provideKeyToUser",value:function provideKeyToUser(keyId){this.keyID===keyId&&(this.encryptKeyForOtherParticipants(),this.setState(E2ERoomState.h.READY))}},{key:"onStateChange",value:function onStateChange(cb){var _this4=this;return this.on("STATE_CHANGED",cb),function(){return _this4.off("STATE_CHANGED",cb)}}},{key:"encryptGroupKeyForParticipantsWaitingForTheKeys",value:(_encryptGroupKeyForParticipantsWaitingForTheKeys=rocketchat_e2e_room_asyncToGenerator(rocketchat_e2e_room_regeneratorRuntime().mark((function _callee27(users){var mySub,decryptedOldGroupKeys,usersWithKeys,_this5=this;return rocketchat_e2e_room_regeneratorRuntime().wrap((function _callee27$(_context27){for(;;)switch(_context27.prev=_context27.next){case 0:if(this.isReady()){_context27.next=2;break}return _context27.abrupt("return");case 2:return mySub=client.Subscriptions.findOne({rid:this.roomId}),_context27.next=5,this.exportOldRoomKeys(null==mySub?void 0:mySub.oldRoomKeys);case 5:return decryptedOldGroupKeys=_context27.sent,_context27.next=8,Promise.all(users.map(function(){var _ref4=rocketchat_e2e_room_asyncToGenerator(rocketchat_e2e_room_regeneratorRuntime().mark((function _callee26(user){var _id,public_key,key,oldKeys;return rocketchat_e2e_room_regeneratorRuntime().wrap((function _callee26$(_context26){for(;;)switch(_context26.prev=_context26.next){case 0:return _id=user._id,public_key=user.public_key,_context26.next=3,_this5.encryptGroupKeyForParticipant(public_key);case 3:return key=_context26.sent,_context26.next=6,_this5.encryptOldKeysForParticipant(public_key,decryptedOldGroupKeys);case 6:return oldKeys=_context26.sent,_context26.abrupt("return",rocketchat_e2e_room_objectSpread({_id:_id,key:key},oldKeys&&{oldKeys:oldKeys}));case 8:case"end":return _context26.stop()}}),_callee26)})));return function(_x21){return _ref4.apply(this,arguments)}}()));case 8:return usersWithKeys=_context27.sent,_context27.abrupt("return",usersWithKeys);case 10:case"end":return _context27.stop()}}),_callee27,this)}))),function encryptGroupKeyForParticipantsWaitingForTheKeys(_x20){return _encryptGroupKeyForParticipantsWaitingForTheKeys.apply(this,arguments)})}]),E2ERoom}(index_module.v);meteor.bX.onLogout((function(){e2e.stopClient()}));var rocketchat_e2e_excluded=["_id"];function rocketchat_e2e_typeof(o){return rocketchat_e2e_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(o){return typeof o}:function(o){return o&&"function"==typeof Symbol&&o.constructor===Symbol&&o!==Symbol.prototype?"symbol":typeof o},rocketchat_e2e_typeof(o)}function rocketchat_e2e_objectWithoutProperties(e,t){if(null==e)return{};var o,r,i=function rocketchat_e2e_objectWithoutPropertiesLoose(r,e){if(null==r)return{};var t={};for(var n in r)if({}.hasOwnProperty.call(r,n)){if(e.includes(n))continue;t[n]=r[n]}return t}(e,t);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);for(r=0;r<s.length;r++)o=s[r],t.includes(o)||{}.propertyIsEnumerable.call(e,o)&&(i[o]=e[o])}return i}function rocketchat_e2e_ownKeys(e,r){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);r&&(o=o.filter((function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable}))),t.push.apply(t,o)}return t}function rocketchat_e2e_objectSpread(e){for(var r=1;r<arguments.length;r++){var t=null!=arguments[r]?arguments[r]:{};r%2?rocketchat_e2e_ownKeys(Object(t),!0).forEach((function(r){rocketchat_e2e_defineProperty(e,r,t[r])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):rocketchat_e2e_ownKeys(Object(t)).forEach((function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))}))}return e}function rocketchat_e2e_slicedToArray(r,e){return function rocketchat_e2e_arrayWithHoles(r){if(Array.isArray(r))return r}(r)||function rocketchat_e2e_iterableToArrayLimit(r,l){var t=null==r?null:"undefined"!=typeof Symbol&&r[Symbol.iterator]||r["@@iterator"];if(null!=t){var e,n,i,u,a=[],f=!0,o=!1;try{if(i=(t=t.call(r)).next,0===l){if(Object(t)!==t)return;f=!1}else for(;!(f=(e=i.call(t)).done)&&(a.push(e.value),a.length!==l);f=!0);}catch(r){o=!0,n=r}finally{try{if(!f&&null!=t.return&&(u=t.return(),Object(u)!==u))return}finally{if(o)throw n}}return a}}(r,e)||function rocketchat_e2e_unsupportedIterableToArray(r,a){if(r){if("string"==typeof r)return rocketchat_e2e_arrayLikeToArray(r,a);var t={}.toString.call(r).slice(8,-1);return"Object"===t&&r.constructor&&(t=r.constructor.name),"Map"===t||"Set"===t?Array.from(r):"Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t)?rocketchat_e2e_arrayLikeToArray(r,a):void 0}}(r,e)||function rocketchat_e2e_nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function rocketchat_e2e_arrayLikeToArray(r,a){(null==a||a>r.length)&&(a=r.length);for(var e=0,n=Array(a);e<a;e++)n[e]=r[e];return n}function rocketchat_e2e_regeneratorRuntime(){rocketchat_e2e_regeneratorRuntime=function _regeneratorRuntime(){return e};var t,e={},r=Object.prototype,n=r.hasOwnProperty,o=Object.defineProperty||function(t,e,r){t[e]=r.value},i="function"==typeof Symbol?Symbol:{},a=i.iterator||"@@iterator",c=i.asyncIterator||"@@asyncIterator",u=i.toStringTag||"@@toStringTag";function define(t,e,r){return Object.defineProperty(t,e,{value:r,enumerable:!0,configurable:!0,writable:!0}),t[e]}try{define({},"")}catch(t){define=function define(t,e,r){return t[e]=r}}function wrap(t,e,r,n){var i=e&&e.prototype instanceof Generator?e:Generator,a=Object.create(i.prototype),c=new Context(n||[]);return o(a,"_invoke",{value:makeInvokeMethod(t,r,c)}),a}function tryCatch(t,e,r){try{return{type:"normal",arg:t.call(e,r)}}catch(t){return{type:"throw",arg:t}}}e.wrap=wrap;var h="suspendedStart",l="suspendedYield",f="executing",s="completed",y={};function Generator(){}function GeneratorFunction(){}function GeneratorFunctionPrototype(){}var p={};define(p,a,(function(){return this}));var d=Object.getPrototypeOf,v=d&&d(d(values([])));v&&v!==r&&n.call(v,a)&&(p=v);var g=GeneratorFunctionPrototype.prototype=Generator.prototype=Object.create(p);function defineIteratorMethods(t){["next","throw","return"].forEach((function(e){define(t,e,(function(t){return this._invoke(e,t)}))}))}function AsyncIterator(t,e){function invoke(r,o,i,a){var c=tryCatch(t[r],t,o);if("throw"!==c.type){var u=c.arg,h=u.value;return h&&"object"==rocketchat_e2e_typeof(h)&&n.call(h,"__await")?e.resolve(h.__await).then((function(t){invoke("next",t,i,a)}),(function(t){invoke("throw",t,i,a)})):e.resolve(h).then((function(t){u.value=t,i(u)}),(function(t){return invoke("throw",t,i,a)}))}a(c.arg)}var r;o(this,"_invoke",{value:function value(t,n){function callInvokeWithMethodAndArg(){return new e((function(e,r){invoke(t,n,e,r)}))}return r=r?r.then(callInvokeWithMethodAndArg,callInvokeWithMethodAndArg):callInvokeWithMethodAndArg()}})}function makeInvokeMethod(e,r,n){var o=h;return function(i,a){if(o===f)throw Error("Generator is already running");if(o===s){if("throw"===i)throw a;return{value:t,done:!0}}for(n.method=i,n.arg=a;;){var c=n.delegate;if(c){var u=maybeInvokeDelegate(c,n);if(u){if(u===y)continue;return u}}if("next"===n.method)n.sent=n._sent=n.arg;else if("throw"===n.method){if(o===h)throw o=s,n.arg;n.dispatchException(n.arg)}else"return"===n.method&&n.abrupt("return",n.arg);o=f;var p=tryCatch(e,r,n);if("normal"===p.type){if(o=n.done?s:l,p.arg===y)continue;return{value:p.arg,done:n.done}}"throw"===p.type&&(o=s,n.method="throw",n.arg=p.arg)}}}function maybeInvokeDelegate(e,r){var n=r.method,o=e.iterator[n];if(o===t)return r.delegate=null,"throw"===n&&e.iterator.return&&(r.method="return",r.arg=t,maybeInvokeDelegate(e,r),"throw"===r.method)||"return"!==n&&(r.method="throw",r.arg=new TypeError("The iterator does not provide a '"+n+"' method")),y;var i=tryCatch(o,e.iterator,r.arg);if("throw"===i.type)return r.method="throw",r.arg=i.arg,r.delegate=null,y;var a=i.arg;return a?a.done?(r[e.resultName]=a.value,r.next=e.nextLoc,"return"!==r.method&&(r.method="next",r.arg=t),r.delegate=null,y):a:(r.method="throw",r.arg=new TypeError("iterator result is not an object"),r.delegate=null,y)}function pushTryEntry(t){var e={tryLoc:t[0]};1 in t&&(e.catchLoc=t[1]),2 in t&&(e.finallyLoc=t[2],e.afterLoc=t[3]),this.tryEntries.push(e)}function resetTryEntry(t){var e=t.completion||{};e.type="normal",delete e.arg,t.completion=e}function Context(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(pushTryEntry,this),this.reset(!0)}function values(e){if(e||""===e){var r=e[a];if(r)return r.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var o=-1,i=function next(){for(;++o<e.length;)if(n.call(e,o))return next.value=e[o],next.done=!1,next;return next.value=t,next.done=!0,next};return i.next=i}}throw new TypeError(rocketchat_e2e_typeof(e)+" is not iterable")}return GeneratorFunction.prototype=GeneratorFunctionPrototype,o(g,"constructor",{value:GeneratorFunctionPrototype,configurable:!0}),o(GeneratorFunctionPrototype,"constructor",{value:GeneratorFunction,configurable:!0}),GeneratorFunction.displayName=define(GeneratorFunctionPrototype,u,"GeneratorFunction"),e.isGeneratorFunction=function(t){var e="function"==typeof t&&t.constructor;return!!e&&(e===GeneratorFunction||"GeneratorFunction"===(e.displayName||e.name))},e.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,GeneratorFunctionPrototype):(t.__proto__=GeneratorFunctionPrototype,define(t,u,"GeneratorFunction")),t.prototype=Object.create(g),t},e.awrap=function(t){return{__await:t}},defineIteratorMethods(AsyncIterator.prototype),define(AsyncIterator.prototype,c,(function(){return this})),e.AsyncIterator=AsyncIterator,e.async=function(t,r,n,o,i){void 0===i&&(i=Promise);var a=new AsyncIterator(wrap(t,r,n,o),i);return e.isGeneratorFunction(r)?a:a.next().then((function(t){return t.done?t.value:a.next()}))},defineIteratorMethods(g),define(g,u,"Generator"),define(g,a,(function(){return this})),define(g,"toString",(function(){return"[object Generator]"})),e.keys=function(t){var e=Object(t),r=[];for(var n in e)r.push(n);return r.reverse(),function next(){for(;r.length;){var t=r.pop();if(t in e)return next.value=t,next.done=!1,next}return next.done=!0,next}},e.values=values,Context.prototype={constructor:Context,reset:function reset(e){if(this.prev=0,this.next=0,this.sent=this._sent=t,this.done=!1,this.delegate=null,this.method="next",this.arg=t,this.tryEntries.forEach(resetTryEntry),!e)for(var r in this)"t"===r.charAt(0)&&n.call(this,r)&&!isNaN(+r.slice(1))&&(this[r]=t)},stop:function stop(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function dispatchException(e){if(this.done)throw e;var r=this;function handle(n,o){return a.type="throw",a.arg=e,r.next=n,o&&(r.method="next",r.arg=t),!!o}for(var o=this.tryEntries.length-1;o>=0;--o){var i=this.tryEntries[o],a=i.completion;if("root"===i.tryLoc)return handle("end");if(i.tryLoc<=this.prev){var c=n.call(i,"catchLoc"),u=n.call(i,"finallyLoc");if(c&&u){if(this.prev<i.catchLoc)return handle(i.catchLoc,!0);if(this.prev<i.finallyLoc)return handle(i.finallyLoc)}else if(c){if(this.prev<i.catchLoc)return handle(i.catchLoc,!0)}else{if(!u)throw Error("try statement without catch or finally");if(this.prev<i.finallyLoc)return handle(i.finallyLoc)}}}},abrupt:function abrupt(t,e){for(var r=this.tryEntries.length-1;r>=0;--r){var o=this.tryEntries[r];if(o.tryLoc<=this.prev&&n.call(o,"finallyLoc")&&this.prev<o.finallyLoc){var i=o;break}}i&&("break"===t||"continue"===t)&&i.tryLoc<=e&&e<=i.finallyLoc&&(i=null);var a=i?i.completion:{};return a.type=t,a.arg=e,i?(this.method="next",this.next=i.finallyLoc,y):this.complete(a)},complete:function complete(t,e){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&e&&(this.next=e),y},finish:function finish(t){for(var e=this.tryEntries.length-1;e>=0;--e){var r=this.tryEntries[e];if(r.finallyLoc===t)return this.complete(r.completion,r.afterLoc),resetTryEntry(r),y}},catch:function _catch(t){for(var e=this.tryEntries.length-1;e>=0;--e){var r=this.tryEntries[e];if(r.tryLoc===t){var n=r.completion;if("throw"===n.type){var o=n.arg;resetTryEntry(r)}return o}}throw Error("illegal catch attempt")},delegateYield:function delegateYield(e,r,n){return this.delegate={iterator:values(e),resultName:r,nextLoc:n},"next"===this.method&&(this.arg=t),y}},e}function rocketchat_e2e_asyncGeneratorStep(n,t,e,r,o,a,c){try{var i=n[a](c),u=i.value}catch(n){return void e(n)}i.done?t(u):Promise.resolve(u).then(r,o)}function rocketchat_e2e_asyncToGenerator(n){return function(){var t=this,e=arguments;return new Promise((function(r,o){var a=n.apply(t,e);function _next(n){rocketchat_e2e_asyncGeneratorStep(a,r,o,_next,_throw,"next",n)}function _throw(n){rocketchat_e2e_asyncGeneratorStep(a,r,o,_next,_throw,"throw",n)}_next(void 0)}))}}function rocketchat_e2e_defineProperties(e,r){for(var t=0;t<r.length;t++){var o=r[t];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,rocketchat_e2e_toPropertyKey(o.key),o)}}function rocketchat_e2e_setPrototypeOf(t,e){return rocketchat_e2e_setPrototypeOf=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t},rocketchat_e2e_setPrototypeOf(t,e)}function rocketchat_e2e_createSuper(t){var r=rocketchat_e2e_isNativeReflectConstruct();return function(){var e,o=rocketchat_e2e_getPrototypeOf(t);if(r){var s=rocketchat_e2e_getPrototypeOf(this).constructor;e=Reflect.construct(o,arguments,s)}else e=o.apply(this,arguments);return function rocketchat_e2e_possibleConstructorReturn(t,e){if(e&&("object"==rocketchat_e2e_typeof(e)||"function"==typeof e))return e;if(void 0!==e)throw new TypeError("Derived constructors may only return object or undefined");return rocketchat_e2e_assertThisInitialized(t)}(this,e)}}function rocketchat_e2e_assertThisInitialized(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function rocketchat_e2e_isNativeReflectConstruct(){try{var t=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(t){}return(rocketchat_e2e_isNativeReflectConstruct=function _isNativeReflectConstruct(){return!!t})()}function rocketchat_e2e_getPrototypeOf(t){return rocketchat_e2e_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(t){return t.__proto__||Object.getPrototypeOf(t)},rocketchat_e2e_getPrototypeOf(t)}function rocketchat_e2e_defineProperty(e,r,t){return(r=rocketchat_e2e_toPropertyKey(r))in e?Object.defineProperty(e,r,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[r]=t,e}function rocketchat_e2e_toPropertyKey(t){var i=function rocketchat_e2e_toPrimitive(t,r){if("object"!=rocketchat_e2e_typeof(t)||!t)return t;var e=t[Symbol.toPrimitive];if(void 0!==e){var i=e.call(t,r||"default");if("object"!=rocketchat_e2e_typeof(i))return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===r?String:Number)(t)}(t,"string");return"symbol"==rocketchat_e2e_typeof(i)?i:i+""}function rocketchat_e2e_asyncIterator(r){var n,t,o,e=2;for("undefined"!=typeof Symbol&&(t=Symbol.asyncIterator,o=Symbol.iterator);e--;){if(t&&null!=(n=r[t]))return n.call(r);if(o&&null!=(n=r[o]))return new rocketchat_e2e_AsyncFromSyncIterator(n.call(r));t="@@asyncIterator",o="@@iterator"}throw new TypeError("Object is not async iterable")}function rocketchat_e2e_AsyncFromSyncIterator(r){function AsyncFromSyncIteratorContinuation(r){if(Object(r)!==r)return Promise.reject(new TypeError(r+" is not an object."));var n=r.done;return Promise.resolve(r.value).then((function(r){return{value:r,done:n}}))}return rocketchat_e2e_AsyncFromSyncIterator=function AsyncFromSyncIterator(r){this.s=r,this.n=r.next},rocketchat_e2e_AsyncFromSyncIterator.prototype={s:null,n:null,next:function next(){return AsyncFromSyncIteratorContinuation(this.n.apply(this.s,arguments))},return:function _return(r){var n=this.s.return;return void 0===n?Promise.resolve({value:r,done:!0}):AsyncFromSyncIteratorContinuation(n.apply(this.s,arguments))},throw:function _throw(r){var n=this.s.return;return void 0===n?Promise.reject(r):AsyncFromSyncIteratorContinuation(n.apply(this.s,arguments))}},new rocketchat_e2e_AsyncFromSyncIterator(r)}var failedToDecodeKey=!1,E2EEStateDependency=new meteor.JD.Dependency,E2E=function(_Emitter){!function rocketchat_e2e_inherits(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),Object.defineProperty(t,"prototype",{writable:!1}),e&&rocketchat_e2e_setPrototypeOf(t,e)}(E2E,_Emitter);var _initiateKeyDistribution,_getSample,_getSuggestedE2EEKeys,_parseQuoteAttachment,_decryptSubscriptions,_decryptSubscription,_decryptPendingMessages,_decryptPinnedMessage,_decryptMessage,_decryptFileContent,_decodePrivateKey,_decodePrivateKeyFlow,_requestPasswordModal,_requestPasswordAlert,_getMasterKey,_encodePrivateKey,_createRandomPassword,_requestSubscriptionKeys,_createAndLoadKeys,_loadKeys,_loadKeysFromDB,_changePassword,_stopClient,_startClient,_initiateDecryptingPendingMessages,_rejectSuggestedKey,_acceptSuggestedKey,_persistKeys,_getInstanceByRoomId,_handleAsyncE2EESuggestedKey,_onSubscriptionChanged,_onE2EEReady,_super=rocketchat_e2e_createSuper(E2E);function E2E(){var _this;return function rocketchat_e2e_classCallCheck(a,n){if(!(a instanceof n))throw new TypeError("Cannot call a class as a function")}(this,E2E),rocketchat_e2e_defineProperty(rocketchat_e2e_assertThisInitialized(_this=_super.call(this)),"started",void 0),rocketchat_e2e_defineProperty(rocketchat_e2e_assertThisInitialized(_this),"instancesByRoomId",void 0),rocketchat_e2e_defineProperty(rocketchat_e2e_assertThisInitialized(_this),"db_public_key",void 0),rocketchat_e2e_defineProperty(rocketchat_e2e_assertThisInitialized(_this),"db_private_key",void 0),rocketchat_e2e_defineProperty(rocketchat_e2e_assertThisInitialized(_this),"privateKey",void 0),rocketchat_e2e_defineProperty(rocketchat_e2e_assertThisInitialized(_this),"publicKey",void 0),rocketchat_e2e_defineProperty(rocketchat_e2e_assertThisInitialized(_this),"keyDistributionInterval",void 0),rocketchat_e2e_defineProperty(rocketchat_e2e_assertThisInitialized(_this),"state",void 0),rocketchat_e2e_defineProperty(rocketchat_e2e_assertThisInitialized(_this),"observable",void 0),_this.started=!1,_this.instancesByRoomId={},_this.keyDistributionInterval=null,_this.observable=void 0,_this.on("E2E_STATE_CHANGED",(function(_ref){var prevState=_ref.prevState,nextState=_ref.nextState;_this.log("".concat(prevState," -> ").concat(nextState))})),_this.on(E2EEState.l.READY,rocketchat_e2e_asyncToGenerator(rocketchat_e2e_regeneratorRuntime().mark((function _callee(){return rocketchat_e2e_regeneratorRuntime().wrap((function _callee$(_context){for(;;)switch(_context.prev=_context.next){case 0:return _context.next=2,_this.onE2EEReady();case 2:case"end":return _context.stop()}}),_callee)})))),_this.on(E2EEState.l.SAVE_PASSWORD,rocketchat_e2e_asyncToGenerator(rocketchat_e2e_regeneratorRuntime().mark((function _callee2(){return rocketchat_e2e_regeneratorRuntime().wrap((function _callee2$(_context2){for(;;)switch(_context2.prev=_context2.next){case 0:return _context2.next=2,_this.onE2EEReady();case 2:case"end":return _context2.stop()}}),_callee2)})))),_this.on(E2EEState.l.DISABLED,(function(){var _this$observable;null===(_this$observable=_this.observable)||void 0===_this$observable||_this$observable.stop()})),_this.on(E2EEState.l.NOT_STARTED,(function(){var _this$observable2;null===(_this$observable2=_this.observable)||void 0===_this$observable2||_this$observable2.stop()})),_this.on(E2EEState.l.ERROR,(function(){var _this$observable3;null===(_this$observable3=_this.observable)||void 0===_this$observable3||_this$observable3.stop()})),_this.setState(E2EEState.l.NOT_STARTED),_this}return function rocketchat_e2e_createClass(e,r,t){return r&&rocketchat_e2e_defineProperties(e.prototype,r),t&&rocketchat_e2e_defineProperties(e,t),Object.defineProperty(e,"prototype",{writable:!1}),e}(E2E,[{key:"log",value:function log(){for(var _len=arguments.length,msg=new Array(_len),_key=0;_key<_len;_key++)msg[_key]=arguments[_key];logger_log.apply(void 0,["E2E"].concat(msg))}},{key:"error",value:function error(){for(var _len2=arguments.length,msg=new Array(_len2),_key2=0;_key2<_len2;_key2++)msg[_key2]=arguments[_key2];logError.apply(void 0,["E2E"].concat(msg))}},{key:"getState",value:function getState(){return this.state}},{key:"isEnabled",value:function isEnabled(){return this.state!==E2EEState.l.DISABLED}},{key:"isReady",value:function isReady(){return E2EEStateDependency.depend(),this.state===E2EEState.l.READY||this.state===E2EEState.l.SAVE_PASSWORD}},{key:"onE2EEReady",value:(_onE2EEReady=rocketchat_e2e_asyncToGenerator(rocketchat_e2e_regeneratorRuntime().mark((function _callee3(){return rocketchat_e2e_regeneratorRuntime().wrap((function _callee3$(_context3){for(;;)switch(_context3.prev=_context3.next){case 0:return this.log("startClient -> Done"),this.initiateHandshake(),_context3.next=4,this.handleAsyncE2EESuggestedKey();case 4:return this.log("decryptSubscriptions"),_context3.next=7,this.decryptSubscriptions();case 7:return this.log("decryptSubscriptions -> Done"),_context3.next=10,this.initiateDecryptingPendingMessages();case 10:return this.log("DecryptingPendingMessages -> Done"),_context3.next=13,this.initiateKeyDistribution();case 13:this.log("initiateKeyDistribution -> Done"),this.observeSubscriptions(),this.log("observing subscriptions");case 16:case"end":return _context3.stop()}}),_callee3,this)}))),function onE2EEReady(){return _onE2EEReady.apply(this,arguments)})},{key:"onSubscriptionChanged",value:(_onSubscriptionChanged=rocketchat_e2e_asyncToGenerator(rocketchat_e2e_regeneratorRuntime().mark((function _callee4(sub){var e2eRoom;return rocketchat_e2e_regeneratorRuntime().wrap((function _callee4$(_context4){for(;;)switch(_context4.prev=_context4.next){case 0:if(this.log("Subscription changed",sub),sub.encrypted||sub.E2EKey){_context4.next=4;break}return this.removeInstanceByRoomId(sub.rid),_context4.abrupt("return");case 4:return _context4.next=6,this.getInstanceByRoomId(sub.rid);case 6:if(e2eRoom=_context4.sent){_context4.next=9;break}return _context4.abrupt("return");case 9:if(!sub.E2ESuggestedKey){_context4.next=21;break}return _context4.next=12,e2eRoom.importGroupKey(sub.E2ESuggestedKey);case 12:if(!_context4.sent){_context4.next=18;break}return _context4.next=15,this.acceptSuggestedKey(sub.rid);case 15:e2eRoom.keyReceived(),_context4.next=21;break;case 18:return console.warn("Invalid E2ESuggestedKey, rejecting",sub.E2ESuggestedKey),_context4.next=21,this.rejectSuggestedKey(sub.rid);case 21:if(sub.encrypted?e2eRoom.resume():e2eRoom.pause(),e2eRoom.isSupportedRoomType(sub.t)){_context4.next=25;break}return e2eRoom.disable(),_context4.abrupt("return");case 25:if(!sub.E2EKey||!e2eRoom.isWaitingKeys()){_context4.next=28;break}return e2eRoom.keyReceived(),_context4.abrupt("return");case 28:if(e2eRoom.isReady()){_context4.next=30;break}return _context4.abrupt("return");case 30:return _context4.next=32,e2eRoom.decryptSubscription();case 32:case"end":return _context4.stop()}}),_callee4,this)}))),function onSubscriptionChanged(_x){return _onSubscriptionChanged.apply(this,arguments)})},{key:"observeSubscriptions",value:function observeSubscriptions(){var _this$observable4,_this2=this;null===(_this$observable4=this.observable)||void 0===_this$observable4||_this$observable4.stop(),this.observable=client.Subscriptions.find().observe({changed:function changed(sub){setTimeout((function(){return _this2.onSubscriptionChanged(sub)}),0)},added:function added(sub){setTimeout(rocketchat_e2e_asyncToGenerator(rocketchat_e2e_regeneratorRuntime().mark((function _callee5(){return rocketchat_e2e_regeneratorRuntime().wrap((function _callee5$(_context5){for(;;)switch(_context5.prev=_context5.next){case 0:if(_this2.log("Subscription added",sub),sub.encrypted||sub.E2EKey){_context5.next=3;break}return _context5.abrupt("return");case 3:return _context5.abrupt("return",_this2.getInstanceByRoomId(sub.rid));case 4:case"end":return _context5.stop()}}),_callee5)}))),0)},removed:function removed(sub){_this2.log("Subscription removed",sub),_this2.removeInstanceByRoomId(sub.rid)}})}},{key:"shouldAskForE2EEPassword",value:function shouldAskForE2EEPassword(){var private_key=this.getKeysFromLocalStorage().private_key;return this.db_private_key&&!private_key}},{key:"setState",value:function setState(nextState){var prevState=this.state;this.state=nextState,E2EEStateDependency.changed(),this.emit("E2E_STATE_CHANGED",{prevState:prevState,nextState:nextState}),this.emit(nextState)}},{key:"handleAsyncE2EESuggestedKey",value:(_handleAsyncE2EESuggestedKey=rocketchat_e2e_asyncToGenerator(rocketchat_e2e_regeneratorRuntime().mark((function _callee7(){var subs,_this3=this;return rocketchat_e2e_regeneratorRuntime().wrap((function _callee7$(_context7){for(;;)switch(_context7.prev=_context7.next){case 0:return subs=client.Subscriptions.find({E2ESuggestedKey:{$exists:!0}}).fetch(),_context7.next=3,Promise.all(subs.filter((function(sub){return sub.E2ESuggestedKey&&!sub.E2EKey})).map(function(){var _ref5=rocketchat_e2e_asyncToGenerator(rocketchat_e2e_regeneratorRuntime().mark((function _callee6(sub){var e2eRoom;return rocketchat_e2e_regeneratorRuntime().wrap((function _callee6$(_context6){for(;;)switch(_context6.prev=_context6.next){case 0:return _context6.next=2,e2e.getInstanceByRoomId(sub.rid);case 2:if(e2eRoom=_context6.sent){_context6.next=5;break}return _context6.abrupt("return");case 5:return _context6.next=7,e2eRoom.importGroupKey(sub.E2ESuggestedKey);case 7:if(!_context6.sent){_context6.next=14;break}return _this3.log("Imported valid E2E suggested key"),_context6.next=11,e2e.acceptSuggestedKey(sub.rid);case 11:e2eRoom.keyReceived(),_context6.next=17;break;case 14:return _this3.error("Invalid E2ESuggestedKey, rejecting",sub.E2ESuggestedKey),_context6.next=17,e2e.rejectSuggestedKey(sub.rid);case 17:sub.encrypted?e2eRoom.resume():e2eRoom.pause();case 18:case"end":return _context6.stop()}}),_callee6)})));return function(_x2){return _ref5.apply(this,arguments)}}()));case 3:case"end":return _context7.stop()}}),_callee7)}))),function handleAsyncE2EESuggestedKey(){return _handleAsyncE2EESuggestedKey.apply(this,arguments)})},{key:"getInstanceByRoomId",value:(_getInstanceByRoomId=rocketchat_e2e_asyncToGenerator(rocketchat_e2e_regeneratorRuntime().mark((function _callee8(rid){var room;return rocketchat_e2e_regeneratorRuntime().wrap((function _callee8$(_context8){for(;;)switch(_context8.prev=_context8.next){case 0:return _context8.next=2,(0,waitUntilFind.waitUntilFind)((function(){return client.ChatRoom.findOne({_id:rid})}));case 2:if("d"===(room=_context8.sent).t||"p"===room.t){_context8.next=5;break}return _context8.abrupt("return",null);case 5:if(room.encrypted){_context8.next=7;break}return _context8.abrupt("return",null);case 7:return this.instancesByRoomId[rid]||(this.instancesByRoomId[rid]=new E2ERoom(meteor.fj.userId(),room)),void 0!==this.instancesByRoomId[rid].keyID&&void 0!==room.e2eKeyId&&this.instancesByRoomId[rid].keyID!==room.e2eKeyId&&this.instancesByRoomId[rid].onRoomKeyReset(room.e2eKeyId),_context8.abrupt("return",this.instancesByRoomId[rid]);case 10:case"end":return _context8.stop()}}),_callee8,this)}))),function getInstanceByRoomId(_x3){return _getInstanceByRoomId.apply(this,arguments)})},{key:"removeInstanceByRoomId",value:function removeInstanceByRoomId(rid){delete this.instancesByRoomId[rid]}},{key:"persistKeys",value:(_persistKeys=rocketchat_e2e_asyncToGenerator(rocketchat_e2e_regeneratorRuntime().mark((function _callee9(_ref6,password){var public_key,private_key,force,encodedPrivateKey,_args9=arguments;return rocketchat_e2e_regeneratorRuntime().wrap((function _callee9$(_context9){for(;;)switch(_context9.prev=_context9.next){case 0:if(public_key=_ref6.public_key,private_key=_ref6.private_key,force=(_args9.length>2&&void 0!==_args9[2]?_args9[2]:{force:!1}).force,"string"==typeof public_key&&"string"==typeof private_key){_context9.next=4;break}throw new Error("Failed to persist keys as they are not strings.");case 4:return _context9.next=6,this.encodePrivateKey(private_key,password);case 6:if(encodedPrivateKey=_context9.sent){_context9.next=9;break}throw new Error("Failed to encode private key with provided password.");case 9:return _context9.next=11,SDKClient.sdk.rest.post("/v1/e2e.setUserPublicAndPrivateKeys",{public_key:public_key,private_key:encodedPrivateKey,force:force});case 11:case"end":return _context9.stop()}}),_callee9,this)}))),function persistKeys(_x4,_x5){return _persistKeys.apply(this,arguments)})},{key:"acceptSuggestedKey",value:(_acceptSuggestedKey=rocketchat_e2e_asyncToGenerator(rocketchat_e2e_regeneratorRuntime().mark((function _callee10(rid){return rocketchat_e2e_regeneratorRuntime().wrap((function _callee10$(_context10){for(;;)switch(_context10.prev=_context10.next){case 0:return _context10.next=2,SDKClient.sdk.rest.post("/v1/e2e.acceptSuggestedGroupKey",{rid:rid});case 2:case"end":return _context10.stop()}}),_callee10)}))),function acceptSuggestedKey(_x6){return _acceptSuggestedKey.apply(this,arguments)})},{key:"rejectSuggestedKey",value:(_rejectSuggestedKey=rocketchat_e2e_asyncToGenerator(rocketchat_e2e_regeneratorRuntime().mark((function _callee11(rid){return rocketchat_e2e_regeneratorRuntime().wrap((function _callee11$(_context11){for(;;)switch(_context11.prev=_context11.next){case 0:return _context11.next=2,SDKClient.sdk.rest.post("/v1/e2e.rejectSuggestedGroupKey",{rid:rid});case 2:case"end":return _context11.stop()}}),_callee11)}))),function rejectSuggestedKey(_x7){return _rejectSuggestedKey.apply(this,arguments)})},{key:"getKeysFromLocalStorage",value:function getKeysFromLocalStorage(){return{public_key:meteor.bX.storageLocation.getItem("public_key"),private_key:meteor.bX.storageLocation.getItem("private_key")}}},{key:"initiateHandshake",value:function initiateHandshake(){var _this4=this;Object.keys(this.instancesByRoomId).map((function(key){return _this4.instancesByRoomId[key].handshake()}))}},{key:"initiateDecryptingPendingMessages",value:(_initiateDecryptingPendingMessages=rocketchat_e2e_asyncToGenerator(rocketchat_e2e_regeneratorRuntime().mark((function _callee12(){var _this5=this;return rocketchat_e2e_regeneratorRuntime().wrap((function _callee12$(_context12){for(;;)switch(_context12.prev=_context12.next){case 0:return _context12.next=2,Promise.all(Object.keys(this.instancesByRoomId).map((function(key){return _this5.instancesByRoomId[key].decryptPendingMessages()})));case 2:case"end":return _context12.stop()}}),_callee12,this)}))),function initiateDecryptingPendingMessages(){return _initiateDecryptingPendingMessages.apply(this,arguments)})},{key:"openSaveE2EEPasswordModal",value:function openSaveE2EEPasswordModal(randomPassword){var _this6=this;imperativeModal.K.open({component:e2e_SaveE2EPasswordModal,props:{randomPassword:randomPassword,onClose:imperativeModal.K.close,onCancel:function onCancel(){_this6.closeAlert(),imperativeModal.K.close()},onConfirm:function onConfirm(){meteor.bX.storageLocation.removeItem("e2e.randomPassword"),_this6.setState(E2EEState.l.READY),(0,toast.b)({type:"success",message:(0,i18n.t)("End_To_End_Encryption_Enabled")}),_this6.closeAlert(),imperativeModal.K.close()}}})}},{key:"startClient",value:(_startClient=rocketchat_e2e_asyncToGenerator(rocketchat_e2e_regeneratorRuntime().mark((function _callee14(){var _this$getKeysFromLoca2,public_key,private_key,randomPassword,_this7=this;return rocketchat_e2e_regeneratorRuntime().wrap((function _callee14$(_context14){for(;;)switch(_context14.prev=_context14.next){case 0:if(!this.started){_context14.next=2;break}return _context14.abrupt("return");case 2:return this.log("startClient -> STARTED"),this.started=!0,_this$getKeysFromLoca2=this.getKeysFromLocalStorage(),public_key=_this$getKeysFromLoca2.public_key,private_key=_this$getKeysFromLoca2.private_key,_context14.next=7,this.loadKeysFromDB();case 7:if(!public_key&&this.db_public_key&&(public_key=this.db_public_key),!this.shouldAskForE2EEPassword()){_context14.next=22;break}return _context14.prev=9,this.setState(E2EEState.l.ENTER_PASSWORD),_context14.next=13,this.decodePrivateKey(this.db_private_key);case 13:private_key=_context14.sent,_context14.next=22;break;case 16:return _context14.prev=16,_context14.t0=_context14.catch(9),this.started=!1,failedToDecodeKey=!0,this.openAlert({title:"Wasn't possible to decode your encryption key to be imported.",html:"<div>Your encryption password seems wrong. Click here to try again.</div>",modifiers:["large","danger"],closable:!0,icon:"key",action:function(){var _action=rocketchat_e2e_asyncToGenerator(rocketchat_e2e_regeneratorRuntime().mark((function _callee13(){return rocketchat_e2e_regeneratorRuntime().wrap((function _callee13$(_context13){for(;;)switch(_context13.prev=_context13.next){case 0:return _context13.next=2,_this7.startClient();case 2:_this7.closeAlert();case 3:case"end":return _context13.stop()}}),_callee13)})));return function action(){return _action.apply(this,arguments)}}()}),_context14.abrupt("return");case 22:if(!public_key||!private_key){_context14.next=28;break}return _context14.next=25,this.loadKeys({public_key:public_key,private_key:private_key});case 25:this.setState(E2EEState.l.READY),_context14.next=31;break;case 28:return _context14.next=30,this.createAndLoadKeys();case 30:this.setState(E2EEState.l.READY);case 31:if(this.db_public_key&&this.db_private_key){_context14.next=40;break}return this.setState(E2EEState.l.LOADING_KEYS),_context14.t1=this,_context14.t2=this.getKeysFromLocalStorage(),_context14.next=37,this.createRandomPassword();case 37:return _context14.t3=_context14.sent,_context14.next=40,_context14.t1.persistKeys.call(_context14.t1,_context14.t2,_context14.t3);case 40:(randomPassword=meteor.bX.storageLocation.getItem("e2e.randomPassword"))&&(this.setState(E2EEState.l.SAVE_PASSWORD),this.openAlert({title:function title(){return(0,i18n.t)("Save_your_encryption_password")},html:function html(){return(0,i18n.t)("Click_here_to_view_and_copy_your_password")},modifiers:["large"],closable:!1,icon:"key",action:function action(){return _this7.openSaveE2EEPasswordModal(randomPassword)}}));case 42:case"end":return _context14.stop()}}),_callee14,this,[[9,16]])}))),function startClient(){return _startClient.apply(this,arguments)})},{key:"stopClient",value:(_stopClient=rocketchat_e2e_asyncToGenerator(rocketchat_e2e_regeneratorRuntime().mark((function _callee15(){return rocketchat_e2e_regeneratorRuntime().wrap((function _callee15$(_context15){for(;;)switch(_context15.prev=_context15.next){case 0:this.log("-> Stop Client"),this.closeAlert(),meteor.bX.storageLocation.removeItem("public_key"),meteor.bX.storageLocation.removeItem("private_key"),this.instancesByRoomId={},this.privateKey=void 0,this.publicKey=void 0,this.started=!1,this.keyDistributionInterval&&clearInterval(this.keyDistributionInterval),this.keyDistributionInterval=null,this.setState(E2EEState.l.DISABLED);case 11:case"end":return _context15.stop()}}),_callee15,this)}))),function stopClient(){return _stopClient.apply(this,arguments)})},{key:"changePassword",value:(_changePassword=rocketchat_e2e_asyncToGenerator(rocketchat_e2e_regeneratorRuntime().mark((function _callee16(newPassword){return rocketchat_e2e_regeneratorRuntime().wrap((function _callee16$(_context16){for(;;)switch(_context16.prev=_context16.next){case 0:return _context16.next=2,this.persistKeys(this.getKeysFromLocalStorage(),newPassword,{force:!0});case 2:meteor.bX.storageLocation.getItem("e2e.randomPassword")&&meteor.bX.storageLocation.setItem("e2e.randomPassword",newPassword);case 3:case"end":return _context16.stop()}}),_callee16,this)}))),function changePassword(_x8){return _changePassword.apply(this,arguments)})},{key:"loadKeysFromDB",value:(_loadKeysFromDB=rocketchat_e2e_asyncToGenerator(rocketchat_e2e_regeneratorRuntime().mark((function _callee17(){var _yield$sdk$rest$get,public_key,private_key;return rocketchat_e2e_regeneratorRuntime().wrap((function _callee17$(_context17){for(;;)switch(_context17.prev=_context17.next){case 0:return _context17.prev=0,this.setState(E2EEState.l.LOADING_KEYS),_context17.next=4,SDKClient.sdk.rest.get("/v1/e2e.fetchMyKeys");case 4:_yield$sdk$rest$get=_context17.sent,public_key=_yield$sdk$rest$get.public_key,private_key=_yield$sdk$rest$get.private_key,this.db_public_key=public_key,this.db_private_key=private_key,_context17.next=16;break;case 11:throw _context17.prev=11,_context17.t0=_context17.catch(0),this.setState(E2EEState.l.ERROR),this.error("Error fetching RSA keys: ",_context17.t0),_context17.t0;case 16:case"end":return _context17.stop()}}),_callee17,this,[[0,11]])}))),function loadKeysFromDB(){return _loadKeysFromDB.apply(this,arguments)})},{key:"loadKeys",value:(_loadKeys=rocketchat_e2e_asyncToGenerator(rocketchat_e2e_regeneratorRuntime().mark((function _callee18(_ref8){var public_key,private_key;return rocketchat_e2e_regeneratorRuntime().wrap((function _callee18$(_context18){for(;;)switch(_context18.prev=_context18.next){case 0:return public_key=_ref8.public_key,private_key=_ref8.private_key,meteor.bX.storageLocation.setItem("public_key",public_key),this.publicKey=public_key,_context18.prev=3,_context18.next=6,importRSAKey(ejson_default().parse(private_key),["decrypt"]);case 6:this.privateKey=_context18.sent,meteor.bX.storageLocation.setItem("private_key",private_key),_context18.next=14;break;case 10:return _context18.prev=10,_context18.t0=_context18.catch(3),this.setState(E2EEState.l.ERROR),_context18.abrupt("return",this.error("Error importing private key: ",_context18.t0));case 14:case"end":return _context18.stop()}}),_callee18,this,[[3,10]])}))),function loadKeys(_x9){return _loadKeys.apply(this,arguments)})},{key:"createAndLoadKeys",value:(_createAndLoadKeys=rocketchat_e2e_asyncToGenerator(rocketchat_e2e_regeneratorRuntime().mark((function _callee19(){var key,publicKey,privateKey;return rocketchat_e2e_regeneratorRuntime().wrap((function _callee19$(_context19){for(;;)switch(_context19.prev=_context19.next){case 0:return this.setState(E2EEState.l.LOADING_KEYS),_context19.prev=1,_context19.next=4,generateRSAKey();case 4:key=_context19.sent,this.privateKey=key.privateKey,_context19.next=12;break;case 8:return _context19.prev=8,_context19.t0=_context19.catch(1),this.setState(E2EEState.l.ERROR),_context19.abrupt("return",this.error("Error generating key: ",_context19.t0));case 12:return _context19.prev=12,_context19.next=15,exportJWKKey(key.publicKey);case 15:publicKey=_context19.sent,this.publicKey=JSON.stringify(publicKey),meteor.bX.storageLocation.setItem("public_key",JSON.stringify(publicKey)),_context19.next=24;break;case 20:return _context19.prev=20,_context19.t1=_context19.catch(12),this.setState(E2EEState.l.ERROR),_context19.abrupt("return",this.error("Error exporting public key: ",_context19.t1));case 24:return _context19.prev=24,_context19.next=27,exportJWKKey(key.privateKey);case 27:privateKey=_context19.sent,meteor.bX.storageLocation.setItem("private_key",JSON.stringify(privateKey)),_context19.next=35;break;case 31:return _context19.prev=31,_context19.t2=_context19.catch(24),this.setState(E2EEState.l.ERROR),_context19.abrupt("return",this.error("Error exporting private key: ",_context19.t2));case 35:return _context19.next=37,this.requestSubscriptionKeys();case 37:case"end":return _context19.stop()}}),_callee19,this,[[1,8],[12,20],[24,31]])}))),function createAndLoadKeys(){return _createAndLoadKeys.apply(this,arguments)})},{key:"requestSubscriptionKeys",value:(_requestSubscriptionKeys=rocketchat_e2e_asyncToGenerator(rocketchat_e2e_regeneratorRuntime().mark((function _callee20(){return rocketchat_e2e_regeneratorRuntime().wrap((function _callee20$(_context20){for(;;)switch(_context20.prev=_context20.next){case 0:return _context20.next=2,SDKClient.sdk.call("e2e.requestSubscriptionKeys");case 2:case"end":return _context20.stop()}}),_callee20)}))),function requestSubscriptionKeys(){return _requestSubscriptionKeys.apply(this,arguments)})},{key:"createRandomPassword",value:(_createRandomPassword=rocketchat_e2e_asyncToGenerator(rocketchat_e2e_regeneratorRuntime().mark((function _callee21(){var randomPassword;return rocketchat_e2e_regeneratorRuntime().wrap((function _callee21$(_context21){for(;;)switch(_context21.prev=_context21.next){case 0:return _context21.next=2,generateMnemonicPhrase(5);case 2:return randomPassword=_context21.sent,meteor.bX.storageLocation.setItem("e2e.randomPassword",randomPassword),_context21.abrupt("return",randomPassword);case 5:case"end":return _context21.stop()}}),_callee21)}))),function createRandomPassword(){return _createRandomPassword.apply(this,arguments)})},{key:"encodePrivateKey",value:(_encodePrivateKey=rocketchat_e2e_asyncToGenerator(rocketchat_e2e_regeneratorRuntime().mark((function _callee22(privateKey,password){var masterKey,vector,encodedPrivateKey;return rocketchat_e2e_regeneratorRuntime().wrap((function _callee22$(_context22){for(;;)switch(_context22.prev=_context22.next){case 0:return _context22.next=2,this.getMasterKey(password);case 2:return masterKey=_context22.sent,vector=crypto.getRandomValues(new Uint8Array(16)),_context22.prev=4,_context22.next=7,encryptAES(vector,masterKey,toArrayBuffer(privateKey));case 7:return encodedPrivateKey=_context22.sent,_context22.abrupt("return",ejson_default().stringify(joinVectorAndEcryptedData(vector,encodedPrivateKey)));case 11:return _context22.prev=11,_context22.t0=_context22.catch(4),this.setState(E2EEState.l.ERROR),_context22.abrupt("return",this.error("Error encrypting encodedPrivateKey: ",_context22.t0));case 15:case"end":return _context22.stop()}}),_callee22,this,[[4,11]])}))),function encodePrivateKey(_x10,_x11){return _encodePrivateKey.apply(this,arguments)})},{key:"getMasterKey",value:(_getMasterKey=rocketchat_e2e_asyncToGenerator(rocketchat_e2e_regeneratorRuntime().mark((function _callee23(password){var baseKey;return rocketchat_e2e_regeneratorRuntime().wrap((function _callee23$(_context23){for(;;)switch(_context23.prev=_context23.next){case 0:return null==password&&alert("You should provide a password"),_context23.prev=1,_context23.next=4,importRawKey(toArrayBuffer(password));case 4:baseKey=_context23.sent,_context23.next=11;break;case 7:return _context23.prev=7,_context23.t0=_context23.catch(1),this.setState(E2EEState.l.ERROR),_context23.abrupt("return",this.error("Error creating a key based on user password: ",_context23.t0));case 11:return _context23.prev=11,_context23.next=14,deriveKey(toArrayBuffer(meteor.fj.userId()),baseKey);case 14:return _context23.abrupt("return",_context23.sent);case 17:return _context23.prev=17,_context23.t1=_context23.catch(11),this.setState(E2EEState.l.ERROR),_context23.abrupt("return",this.error("Error deriving baseKey: ",_context23.t1));case 21:case"end":return _context23.stop()}}),_callee23,this,[[1,7],[11,17]])}))),function getMasterKey(_x12){return _getMasterKey.apply(this,arguments)})},{key:"openEnterE2EEPasswordModal",value:function openEnterE2EEPasswordModal(onEnterE2EEPassword){var _this8=this;imperativeModal.K.open({component:e2e_EnterE2EPasswordModal,props:{onClose:imperativeModal.K.close,onCancel:function onCancel(){failedToDecodeKey=!1,(0,toast.b)({type:"info",message:(0,i18n.t)("End_To_End_Encryption_Not_Enabled")}),_this8.closeAlert(),imperativeModal.K.close()},onConfirm:function onConfirm(password){null==onEnterE2EEPassword||onEnterE2EEPassword(password),_this8.closeAlert(),imperativeModal.K.close()}}})}},{key:"requestPasswordAlert",value:(_requestPasswordAlert=rocketchat_e2e_asyncToGenerator(rocketchat_e2e_regeneratorRuntime().mark((function _callee24(){var _this9=this;return rocketchat_e2e_regeneratorRuntime().wrap((function _callee24$(_context24){for(;;)switch(_context24.prev=_context24.next){case 0:return _context24.abrupt("return",new Promise((function(resolve){var showModal=function showModal(){return _this9.openEnterE2EEPasswordModal((function(password){return resolve(password)}))};failedToDecodeKey?showModal():function showAlert(){_this9.openAlert({title:function title(){return(0,i18n.t)("Enter_your_E2E_password")},html:function html(){return(0,i18n.t)("Click_here_to_enter_your_encryption_password")},modifiers:["large"],closable:!1,icon:"key",action:function action(){showModal()}})}()})));case 1:case"end":return _context24.stop()}}),_callee24)}))),function requestPasswordAlert(){return _requestPasswordAlert.apply(this,arguments)})},{key:"requestPasswordModal",value:(_requestPasswordModal=rocketchat_e2e_asyncToGenerator(rocketchat_e2e_regeneratorRuntime().mark((function _callee25(){var _this10=this;return rocketchat_e2e_regeneratorRuntime().wrap((function _callee25$(_context25){for(;;)switch(_context25.prev=_context25.next){case 0:return _context25.abrupt("return",new Promise((function(resolve){return _this10.openEnterE2EEPasswordModal((function(password){return resolve(password)}))})));case 1:case"end":return _context25.stop()}}),_callee25)}))),function requestPasswordModal(){return _requestPasswordModal.apply(this,arguments)})},{key:"decodePrivateKeyFlow",value:(_decodePrivateKeyFlow=rocketchat_e2e_asyncToGenerator(rocketchat_e2e_regeneratorRuntime().mark((function _callee26(){var password,masterKey,_splitVectorAndEcrypt,_splitVectorAndEcrypt2,vector,cipherText,privKey,privateKey;return rocketchat_e2e_regeneratorRuntime().wrap((function _callee26$(_context26){for(;;)switch(_context26.prev=_context26.next){case 0:return _context26.next=2,this.requestPasswordModal();case 2:return password=_context26.sent,_context26.next=5,this.getMasterKey(password);case 5:if(masterKey=_context26.sent,this.db_private_key){_context26.next=8;break}return _context26.abrupt("return");case 8:return _splitVectorAndEcrypt=splitVectorAndEcryptedData(ejson_default().parse(this.db_private_key)),_splitVectorAndEcrypt2=rocketchat_e2e_slicedToArray(_splitVectorAndEcrypt,2),vector=_splitVectorAndEcrypt2[0],cipherText=_splitVectorAndEcrypt2[1],_context26.prev=9,_context26.next=12,decryptAES(vector,masterKey,cipherText);case 12:if(privKey=_context26.sent,privateKey=helper_toString(privKey),!this.db_public_key||!privateKey){_context26.next=20;break}return _context26.next=17,this.loadKeys({public_key:this.db_public_key,private_key:privateKey});case 17:this.setState(E2EEState.l.READY),_context26.next=23;break;case 20:return _context26.next=22,this.createAndLoadKeys();case 22:this.setState(E2EEState.l.READY);case 23:(0,toast.b)({type:"success",message:(0,i18n.t)("End_To_End_Encryption_Enabled")}),_context26.next=32;break;case 26:throw _context26.prev=26,_context26.t0=_context26.catch(9),this.setState(E2EEState.l.ENTER_PASSWORD),(0,toast.b)({type:"error",message:(0,i18n.t)("Your_E2EE_password_is_incorrect")}),(0,toast.b)({type:"info",message:(0,i18n.t)("End_To_End_Encryption_Not_Enabled")}),new Error("E2E -> Error decrypting private key");case 32:case"end":return _context26.stop()}}),_callee26,this,[[9,26]])}))),function decodePrivateKeyFlow(){return _decodePrivateKeyFlow.apply(this,arguments)})},{key:"decodePrivateKey",value:(_decodePrivateKey=rocketchat_e2e_asyncToGenerator(rocketchat_e2e_regeneratorRuntime().mark((function _callee27(privateKey){var password,masterKey,_splitVectorAndEcrypt3,_splitVectorAndEcrypt4,vector,cipherText,privKey;return rocketchat_e2e_regeneratorRuntime().wrap((function _callee27$(_context27){for(;;)switch(_context27.prev=_context27.next){case 0:return _context27.next=2,this.requestPasswordAlert();case 2:return password=_context27.sent,_context27.next=5,this.getMasterKey(password);case 5:return masterKey=_context27.sent,_splitVectorAndEcrypt3=splitVectorAndEcryptedData(ejson_default().parse(privateKey)),_splitVectorAndEcrypt4=rocketchat_e2e_slicedToArray(_splitVectorAndEcrypt3,2),vector=_splitVectorAndEcrypt4[0],cipherText=_splitVectorAndEcrypt4[1],_context27.prev=7,_context27.next=10,decryptAES(vector,masterKey,cipherText);case 10:return privKey=_context27.sent,_context27.abrupt("return",helper_toString(privKey));case 14:throw _context27.prev=14,_context27.t0=_context27.catch(7),this.setState(E2EEState.l.ENTER_PASSWORD),(0,toast.b)({type:"error",message:(0,i18n.t)("Your_E2EE_password_is_incorrect")}),(0,toast.b)({type:"info",message:(0,i18n.t)("End_To_End_Encryption_Not_Enabled")}),new Error("E2E -> Error decrypting private key");case 20:case"end":return _context27.stop()}}),_callee27,this,[[7,14]])}))),function decodePrivateKey(_x13){return _decodePrivateKey.apply(this,arguments)})},{key:"decryptFileContent",value:(_decryptFileContent=rocketchat_e2e_asyncToGenerator(rocketchat_e2e_regeneratorRuntime().mark((function _callee28(file){var e2eRoom;return rocketchat_e2e_regeneratorRuntime().wrap((function _callee28$(_context28){for(;;)switch(_context28.prev=_context28.next){case 0:if(file.rid){_context28.next=2;break}return _context28.abrupt("return",file);case 2:return _context28.next=4,this.getInstanceByRoomId(file.rid);case 4:if(e2eRoom=_context28.sent){_context28.next=7;break}return _context28.abrupt("return",file);case 7:return _context28.abrupt("return",e2eRoom.decryptContent(file));case 8:case"end":return _context28.stop()}}),_callee28,this)}))),function decryptFileContent(_x14){return _decryptFileContent.apply(this,arguments)})},{key:"decryptMessage",value:(_decryptMessage=rocketchat_e2e_asyncToGenerator(rocketchat_e2e_regeneratorRuntime().mark((function _callee29(message){var e2eRoom,decryptedMessage,decryptedMessageWithQuote;return rocketchat_e2e_regeneratorRuntime().wrap((function _callee29$(_context29){for(;;)switch(_context29.prev=_context29.next){case 0:if((0,dist.isE2EEMessage)(message)&&"done"!==message.e2e){_context29.next=2;break}return _context29.abrupt("return",message);case 2:return _context29.next=4,this.getInstanceByRoomId(message.rid);case 4:if(e2eRoom=_context29.sent){_context29.next=7;break}return _context29.abrupt("return",message);case 7:return _context29.next=9,e2eRoom.decryptMessage(message);case 9:return decryptedMessage=_context29.sent,_context29.next=12,this.parseQuoteAttachment(decryptedMessage);case 12:return decryptedMessageWithQuote=_context29.sent,_context29.abrupt("return",decryptedMessageWithQuote);case 14:case"end":return _context29.stop()}}),_callee29,this)}))),function decryptMessage(_x15){return _decryptMessage.apply(this,arguments)})},{key:"decryptPinnedMessage",value:(_decryptPinnedMessage=rocketchat_e2e_asyncToGenerator(rocketchat_e2e_regeneratorRuntime().mark((function _callee30(message){var _message$attachments,pinnedMessage,e2eRoom,data,decryptedPinnedMessage;return rocketchat_e2e_regeneratorRuntime().wrap((function _callee30$(_context30){for(;;)switch(_context30.prev=_context30.next){case 0:if(pinnedMessage=null==message||null===(_message$attachments=message.attachments)||void 0===_message$attachments||null===(_message$attachments=_message$attachments[0])||void 0===_message$attachments?void 0:_message$attachments.text){_context30.next=3;break}return _context30.abrupt("return",message);case 3:return _context30.next=5,this.getInstanceByRoomId(message.rid);case 5:if(e2eRoom=_context30.sent){_context30.next=8;break}return _context30.abrupt("return",message);case 8:return _context30.next=10,e2eRoom.decrypt(pinnedMessage);case 10:if(data=_context30.sent){_context30.next=13;break}return _context30.abrupt("return",message);case 13:return(decryptedPinnedMessage=rocketchat_e2e_objectSpread({},message)).attachments[0].text=data.text,_context30.abrupt("return",decryptedPinnedMessage);case 16:case"end":return _context30.stop()}}),_callee30,this)}))),function decryptPinnedMessage(_x16){return _decryptPinnedMessage.apply(this,arguments)})},{key:"decryptPendingMessages",value:(_decryptPendingMessages=rocketchat_e2e_asyncToGenerator(rocketchat_e2e_regeneratorRuntime().mark((function _callee32(){var _this11=this;return rocketchat_e2e_regeneratorRuntime().wrap((function _callee32$(_context32){for(;;)switch(_context32.prev=_context32.next){case 0:return _context32.abrupt("return",client.Messages.find({t:"e2e",e2e:"pending"}).forEach(function(){var _ref10=rocketchat_e2e_asyncToGenerator(rocketchat_e2e_regeneratorRuntime().mark((function _callee31(_ref9){var _id,msg;return rocketchat_e2e_regeneratorRuntime().wrap((function _callee31$(_context31){for(;;)switch(_context31.prev=_context31.next){case 0:return _id=_ref9._id,msg=rocketchat_e2e_objectWithoutProperties(_ref9,rocketchat_e2e_excluded),_context31.t0=client.Messages,_context31.t1={_id:_id},_context31.next=5,_this11.decryptMessage(msg);case 5:_context31.t2=_context31.sent,_context31.t0.update.call(_context31.t0,_context31.t1,_context31.t2);case 7:case"end":return _context31.stop()}}),_callee31)})));return function(_x17){return _ref10.apply(this,arguments)}}()));case 1:case"end":return _context32.stop()}}),_callee32)}))),function decryptPendingMessages(){return _decryptPendingMessages.apply(this,arguments)})},{key:"decryptSubscription",value:(_decryptSubscription=rocketchat_e2e_asyncToGenerator(rocketchat_e2e_regeneratorRuntime().mark((function _callee33(subscriptionId){var e2eRoom;return rocketchat_e2e_regeneratorRuntime().wrap((function _callee33$(_context33){for(;;)switch(_context33.prev=_context33.next){case 0:return _context33.next=2,this.getInstanceByRoomId(subscriptionId);case 2:return e2eRoom=_context33.sent,this.log("decryptSubscription ->",subscriptionId),_context33.next=6,null==e2eRoom?void 0:e2eRoom.decryptSubscription();case 6:case"end":return _context33.stop()}}),_callee33,this)}))),function decryptSubscription(_x18){return _decryptSubscription.apply(this,arguments)})},{key:"decryptSubscriptions",value:(_decryptSubscriptions=rocketchat_e2e_asyncToGenerator(rocketchat_e2e_regeneratorRuntime().mark((function _callee34(){var _this12=this;return rocketchat_e2e_regeneratorRuntime().wrap((function _callee34$(_context34){for(;;)switch(_context34.prev=_context34.next){case 0:client.Subscriptions.find({encrypted:!0}).forEach((function(subscription){return _this12.decryptSubscription(subscription._id)}));case 1:case"end":return _context34.stop()}}),_callee34)}))),function decryptSubscriptions(){return _decryptSubscriptions.apply(this,arguments)})},{key:"openAlert",value:function openAlert(config){banners.ho(rocketchat_e2e_objectSpread({id:"e2e"},config))}},{key:"closeAlert",value:function closeAlert(){banners.LM("e2e")}},{key:"parseQuoteAttachment",value:(_parseQuoteAttachment=rocketchat_e2e_asyncToGenerator(rocketchat_e2e_regeneratorRuntime().mark((function _callee36(message){var urls,_this13=this;return rocketchat_e2e_regeneratorRuntime().wrap((function _callee36$(_context36){for(;;)switch(_context36.prev=_context36.next){case 0:if(null!=message&&message.msg){_context36.next=2;break}return _context36.abrupt("return",message);case 2:return urls=message.msg.match(/([A-Za-z]{3,9}):\/\/([-;:&=\+\$,\w]+@{1})?([-A-Za-z0-9\.]+)+:?(\d+)?((\/[-\+=!:~%\/\.@\,\w]*)?\??([-\+=&!:;%@\/\.\,\w]+)?(?:#([^\s\)]+))?)?/g)||[],_context36.next=5,Promise.all(urls.map(function(){var _ref11=rocketchat_e2e_asyncToGenerator(rocketchat_e2e_regeneratorRuntime().mark((function _callee35(url){var urlObj,_QueryString$parse,msgId,getQuotedMessage,quotedMessage,decryptedQuoteMessage,useRealName,quoteAttachment;return rocketchat_e2e_regeneratorRuntime().wrap((function _callee35$(_context35){for(;;)switch(_context35.prev=_context35.next){case 0:if(url.includes(settings_client.W.get("Site_Url"))){_context35.next=2;break}return _context35.abrupt("return");case 2:if((urlObj=url_url.parse(url)).query){_context35.next=5;break}return _context35.abrupt("return");case 5:if(_QueryString$parse=querystring.parse(urlObj.query),(msgId=_QueryString$parse.msg)&&!Array.isArray(msgId)){_context35.next=8;break}return _context35.abrupt("return");case 8:return _context35.next=10,SDKClient.sdk.rest.get("/v1/chat.getMessage",{msgId:msgId});case 10:if(getQuotedMessage=_context35.sent,quotedMessage=null==getQuotedMessage?void 0:getQuotedMessage.message){_context35.next=14;break}return _context35.abrupt("return");case 14:return _context35.next=16,_this13.decryptMessage((0,mapMessageFromApi.U)(quotedMessage));case 16:decryptedQuoteMessage=_context35.sent,message.attachments=message.attachments||[],useRealName=settings_client.W.get("UI_Use_Real_Name"),quoteAttachment=createQuoteAttachment(decryptedQuoteMessage,url,useRealName,(0,utils_client.ku)(decryptedQuoteMessage.u.username||"")),message.attachments.push(quoteAttachment);case 21:case"end":return _context35.stop()}}),_callee35)})));return function(_x20){return _ref11.apply(this,arguments)}}()));case 5:return _context36.abrupt("return",message);case 6:case"end":return _context36.stop()}}),_callee36)}))),function parseQuoteAttachment(_x19){return _parseQuoteAttachment.apply(this,arguments)})},{key:"getSuggestedE2EEKeys",value:(_getSuggestedE2EEKeys=rocketchat_e2e_asyncToGenerator(rocketchat_e2e_regeneratorRuntime().mark((function _callee38(usersWaitingForE2EKeys){var roomIds,_this14=this;return rocketchat_e2e_regeneratorRuntime().wrap((function _callee38$(_context38){for(;;)switch(_context38.prev=_context38.next){case 0:return roomIds=Object.keys(usersWaitingForE2EKeys),_context38.t0=Object,_context38.next=4,Promise.all(roomIds.map(function(){var _ref12=rocketchat_e2e_asyncToGenerator(rocketchat_e2e_regeneratorRuntime().mark((function _callee37(room){var e2eRoom,usersWithKeys;return rocketchat_e2e_regeneratorRuntime().wrap((function _callee37$(_context37){for(;;)switch(_context37.prev=_context37.next){case 0:return _context37.next=2,_this14.getInstanceByRoomId(room);case 2:if(e2eRoom=_context37.sent){_context37.next=5;break}return _context37.abrupt("return");case 5:return _context37.next=7,e2eRoom.encryptGroupKeyForParticipantsWaitingForTheKeys(usersWaitingForE2EKeys[room]);case 7:if(usersWithKeys=_context37.sent){_context37.next=10;break}return _context37.abrupt("return");case 10:return _context37.abrupt("return",[room,usersWithKeys]);case 11:case"end":return _context37.stop()}}),_callee37)})));return function(_x22){return _ref12.apply(this,arguments)}}()));case 4:return _context38.t1=_context38.sent.filter(isTruthy.z),_context38.abrupt("return",_context38.t0.fromEntries.call(_context38.t0,_context38.t1));case 6:case"end":return _context38.stop()}}),_callee38)}))),function getSuggestedE2EEKeys(_x21){return _getSuggestedE2EEKeys.apply(this,arguments)})},{key:"getSample",value:(_getSample=rocketchat_e2e_asyncToGenerator(rocketchat_e2e_regeneratorRuntime().mark((function _callee39(roomIds){var limit,randomRoomIds,sampleIds,_iteratorAbruptCompletion,_didIteratorError,_iteratorError,_iterator,_step,roomId,e2eroom,_args39=arguments;return rocketchat_e2e_regeneratorRuntime().wrap((function _callee39$(_context39){for(;;)switch(_context39.prev=_context39.next){case 0:if(0!==(limit=_args39.length>1&&void 0!==_args39[1]?_args39[1]:3)){_context39.next=3;break}return _context39.abrupt("return",[]);case 3:randomRoomIds=lodash_default().sampleSize(roomIds,10),sampleIds=[],_iteratorAbruptCompletion=!1,_didIteratorError=!1,_context39.prev=7,_iterator=rocketchat_e2e_asyncIterator(randomRoomIds);case 9:return _context39.next=11,_iterator.next();case 11:if(!(_iteratorAbruptCompletion=!(_step=_context39.sent).done)){_context39.next=22;break}return roomId=_step.value,_context39.next=15,this.getInstanceByRoomId(roomId);case 15:if(null!=(e2eroom=_context39.sent)&&e2eroom.hasSessionKey()){_context39.next=18;break}return _context39.abrupt("continue",19);case 18:sampleIds.push(roomId);case 19:_iteratorAbruptCompletion=!1,_context39.next=9;break;case 22:_context39.next=28;break;case 24:_context39.prev=24,_context39.t0=_context39.catch(7),_didIteratorError=!0,_iteratorError=_context39.t0;case 28:if(_context39.prev=28,_context39.prev=29,!_iteratorAbruptCompletion||null==_iterator.return){_context39.next=33;break}return _context39.next=33,_iterator.return();case 33:if(_context39.prev=33,!_didIteratorError){_context39.next=36;break}throw _iteratorError;case 36:return _context39.finish(33);case 37:return _context39.finish(28);case 38:if(sampleIds.length){_context39.next=40;break}return _context39.abrupt("return",this.getSample(roomIds,limit-1));case 40:return _context39.abrupt("return",sampleIds);case 41:case"end":return _context39.stop()}}),_callee39,this,[[7,24,28,38],[29,,33,37]])}))),function getSample(_x23){return _getSample.apply(this,arguments)})},{key:"initiateKeyDistribution",value:(_initiateKeyDistribution=rocketchat_e2e_asyncToGenerator(rocketchat_e2e_regeneratorRuntime().mark((function _callee41(){var keyDistribution,_this15=this;return rocketchat_e2e_regeneratorRuntime().wrap((function _callee41$(_context41){for(;;)switch(_context41.prev=_context41.next){case 0:if(!this.keyDistributionInterval){_context41.next=2;break}return _context41.abrupt("return");case 2:return keyDistribution=function(){var _ref13=rocketchat_e2e_asyncToGenerator(rocketchat_e2e_regeneratorRuntime().mark((function _callee40(){var roomIds,sampleIds,_yield$sdk$rest$get2,_yield$sdk$rest$get2$,usersWaitingForE2EKeys,userKeysWithRooms;return rocketchat_e2e_regeneratorRuntime().wrap((function _callee40$(_context40){for(;;)switch(_context40.prev=_context40.next){case 0:if((roomIds=client.ChatRoom.find({usersWaitingForE2EKeys:{$exists:!0},"usersWaitingForE2EKeys.userId":{$ne:meteor.fj.userId()}}).map((function(room){return room._id}))).length){_context40.next=3;break}return _context40.abrupt("return");case 3:return _context40.next=5,_this15.getSample(roomIds);case 5:if((sampleIds=_context40.sent).length){_context40.next=8;break}return _context40.abrupt("return");case 8:return _context40.next=10,SDKClient.sdk.rest.get("/v1/e2e.fetchUsersWaitingForGroupKey",{roomIds:sampleIds});case 10:if(_yield$sdk$rest$get2=_context40.sent,_yield$sdk$rest$get2$=_yield$sdk$rest$get2.usersWaitingForE2EKeys,usersWaitingForE2EKeys=void 0===_yield$sdk$rest$get2$?{}:_yield$sdk$rest$get2$,Object.keys(usersWaitingForE2EKeys).length){_context40.next=15;break}return _context40.abrupt("return");case 15:return _context40.next=17,_this15.getSuggestedE2EEKeys(usersWaitingForE2EKeys);case 17:if(userKeysWithRooms=_context40.sent,Object.keys(userKeysWithRooms).length){_context40.next=20;break}return _context40.abrupt("return");case 20:return _context40.prev=20,_context40.next=23,SDKClient.sdk.rest.post("/v1/e2e.provideUsersSuggestedGroupKeys",{usersSuggestedGroupKeys:userKeysWithRooms});case 23:_context40.next=28;break;case 25:return _context40.prev=25,_context40.t0=_context40.catch(20),_context40.abrupt("return",_this15.error("Error providing group key to users: ",_context40.t0));case 28:case"end":return _context40.stop()}}),_callee40,null,[[20,25]])})));return function keyDistribution(){return _ref13.apply(this,arguments)}}(),_context41.next=5,keyDistribution();case 5:this.keyDistributionInterval=setInterval(keyDistribution,1e4);case 6:case"end":return _context41.stop()}}),_callee41,this)}))),function initiateKeyDistribution(){return _initiateKeyDistribution.apply(this,arguments)})}]),E2E}(index_module.v),e2e=new E2E},"./client/lib/banners.ts":function(__unused_webpack_module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.d(__webpack_exports__,{KQ:function(){return firstSubscription},LM:function(){return closeById},VN:function(){return close},_8:function(){return isLegacyPayload},ho:function(){return open}});var _rocket_chat_emitter__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("./node_modules/@rocket.chat/emitter/dist/index.module.js"),isLegacyPayload=function isLegacyPayload(payload){return!("blocks"in payload)},queue=[],emitter=new _rocket_chat_emitter__WEBPACK_IMPORTED_MODULE_0__.v,firstSubscription=[function(callback){return emitter.on("update-first",callback)},function(){var _queue$;return null!==(_queue$=queue[0])&&void 0!==_queue$?_queue$:null}],open=function open(payload){var index=queue.findIndex((function(_payload){return isLegacyPayload(_payload)&&isLegacyPayload(payload)?_payload.id===payload.id:!isLegacyPayload(_payload)&&!isLegacyPayload(payload)&&_payload.viewId===payload.viewId}));-1===index&&(index=queue.length),queue[index]=payload,emitter.emit("update"),0===index&&emitter.emit("update-first")},closeById=function closeById(id){var index=queue.findIndex((function(banner){return isLegacyPayload(banner)?banner.id===id:banner.viewId===id}));index<0||(queue.splice(index,1),emitter.emit("update"),0===index&&emitter.emit("update-first"))},close=function close(){queue.shift(),emitter.emit("update"),emitter.emit("update-first")}},"./client/lib/utils/mapMessageFromApi.ts":function(__unused_webpack_module,__webpack_exports__,__webpack_require__){"use strict";function _typeof(o){return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(o){return typeof o}:function(o){return o&&"function"==typeof Symbol&&o.constructor===Symbol&&o!==Symbol.prototype?"symbol":typeof o},_typeof(o)}__webpack_require__.d(__webpack_exports__,{U:function(){return mapMessageFromApi}});var _excluded=["attachments","tlm","ts","_updatedAt","pinnedAt","webRtcCallEndTs"],_excluded2=["ts"];function ownKeys(e,r){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);r&&(o=o.filter((function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable}))),t.push.apply(t,o)}return t}function _objectSpread(e){for(var r=1;r<arguments.length;r++){var t=null!=arguments[r]?arguments[r]:{};r%2?ownKeys(Object(t),!0).forEach((function(r){_defineProperty(e,r,t[r])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):ownKeys(Object(t)).forEach((function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))}))}return e}function _defineProperty(e,r,t){return(r=function _toPropertyKey(t){var i=function _toPrimitive(t,r){if("object"!=_typeof(t)||!t)return t;var e=t[Symbol.toPrimitive];if(void 0!==e){var i=e.call(t,r||"default");if("object"!=_typeof(i))return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===r?String:Number)(t)}(t,"string");return"symbol"==_typeof(i)?i:i+""}(r))in e?Object.defineProperty(e,r,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[r]=t,e}function _objectWithoutProperties(e,t){if(null==e)return{};var o,r,i=function _objectWithoutPropertiesLoose(r,e){if(null==r)return{};var t={};for(var n in r)if({}.hasOwnProperty.call(r,n)){if(e.includes(n))continue;t[n]=r[n]}return t}(e,t);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);for(r=0;r<s.length;r++)o=s[r],t.includes(o)||{}.propertyIsEnumerable.call(e,o)&&(i[o]=e[o])}return i}var mapMessageFromApi=function mapMessageFromApi(_ref){var attachments=_ref.attachments,tlm=_ref.tlm,ts=_ref.ts,_updatedAt=_ref._updatedAt,pinnedAt=_ref.pinnedAt,webRtcCallEndTs=_ref.webRtcCallEndTs;return _objectSpread(_objectSpread(_objectSpread(_objectSpread(_objectSpread({},_objectWithoutProperties(_ref,_excluded)),{},{ts:new Date(ts)},tlm&&{tlm:new Date(tlm)}),{},{_updatedAt:new Date(_updatedAt)},pinnedAt&&{pinnedAt:new Date(pinnedAt)}),webRtcCallEndTs&&{webRtcCallEndTs:new Date(webRtcCallEndTs)}),attachments&&{attachments:attachments.map((function(_ref2){var ts=_ref2.ts,attachment=_objectWithoutProperties(_ref2,_excluded2);return _objectSpread(_objectSpread({},ts&&{ts:new Date(ts)}),attachment)}))})}},"./client/lib/utils/waitUntilFind.ts":function(__unused_webpack_module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,{waitUntilFind:function(){return waitUntilFind}});var meteor_tracker__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("./.storybook/mocks/meteor.js"),waitUntilFind=function waitUntilFind(fn){return new Promise((function(resolve){meteor_tracker__WEBPACK_IMPORTED_MODULE_0__.JD.autorun((function(c){var result=fn();void 0!==result&&(c.stop(),resolve(result))}))}))}},"../../packages/base64/dist/base64.js":function(__unused_webpack_module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.d(__webpack_exports__,{o:function(){return Base64}});const BASE_64_CHARS="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",BASE_64_VALS=Object.create(null),getChar=val=>BASE_64_CHARS.charAt(val);for(let i=0;i<64;i++)BASE_64_VALS[getChar(i)]=i;const newBinary=len=>{if("undefined"==typeof Uint8Array||"undefined"==typeof ArrayBuffer){return Object.assign(Array.from({length:len},(()=>0)),{$Uint8ArrayPolyfill:!0})}return new Uint8Array(new ArrayBuffer(len))},Base64={encode:array=>{if("string"==typeof array){const str=array,binary=newBinary(str.length);for(let i=0;i<str.length;i++){const ch=str.charCodeAt(i);if(ch>255)throw new Error("Not ascii. Base64.encode can only take ascii strings.");binary[i]=ch}array=binary}const answer=[];let a=null,b=null,c=null,d=null;for(let i=0;i<array.length;i++)switch(i%3){case 0:a=array[i]>>2&63,b=(3&array[i])<<4;break;case 1:b=(null!=b?b:0)|array[i]>>4&15,c=(15&array[i])<<2;break;case 2:c=(null!=c?c:0)|array[i]>>6&3,d=63&array[i],answer.push(getChar(null!=a?a:0)),answer.push(getChar(null!=b?b:0)),answer.push(getChar(c)),answer.push(getChar(d)),a=null,b=null,c=null,d=null}return null!==a&&(answer.push(getChar(a)),answer.push(getChar(null!=b?b:0)),null===c?answer.push("="):answer.push(getChar(c)),null===d&&answer.push("=")),answer.join("")},decode:str=>{let len=Math.floor(3*str.length/4);"="===str.charAt(str.length-1)&&(len--,"="===str.charAt(str.length-2)&&len--);const arr=newBinary(len);let one=null,two=null,three=null,j=0;for(let i=0;i<str.length;i++){const c=str.charAt(i),v="="===(ch=c)?-1:BASE_64_VALS[ch];switch(i%4){case 0:if(v<0)throw new Error("invalid base64 string");one=v<<2;break;case 1:if(v<0)throw new Error("invalid base64 string");one=(null!=one?one:0)|v>>4,arr[j++]=one,two=(15&v)<<4;break;case 2:v>=0&&(two=(null!=two?two:0)|v>>2,arr[j++]=two,three=(3&v)<<6);break;case 3:v>=0&&(arr[j++]=(null!=three?three:0)|v)}}var ch;return arr},newBinary:newBinary}},"?4f7e":function(){}}]);