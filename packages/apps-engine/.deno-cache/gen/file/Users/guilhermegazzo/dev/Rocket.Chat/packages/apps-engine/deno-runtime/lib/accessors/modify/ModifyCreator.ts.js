import { BlockBuilder } from '../builders/BlockBuilder.ts';
import { MessageBuilder } from '../builders/MessageBuilder.ts';
import { DiscussionBuilder } from '../builders/DiscussionBuilder.ts';
import { LivechatMessageBuilder } from '../builders/LivechatMessageBuilder.ts';
import { RoomBuilder } from '../builders/RoomBuilder.ts';
import { UserBuilder } from '../builders/UserBuilder.ts';
import { VideoConferenceBuilder } from '../builders/VideoConferenceBuilder.ts';
import { AppObjectRegistry } from '../../../AppObjectRegistry.ts';
import { require } from '../../../lib/require.ts';
const { UIHelper } = require('@rocket.chat/apps-engine/server/misc/UIHelper.js');
const { RoomType } = require('@rocket.chat/apps-engine/definition/rooms/RoomType.js');
const { UserType } = require('@rocket.chat/apps-engine/definition/users/UserType.js');
const { RocketChatAssociationModel } = require('@rocket.chat/apps-engine/definition/metadata/RocketChatAssociations.js');
export class ModifyCreator {
  senderFn;
  constructor(senderFn){
    this.senderFn = senderFn;
  }
  getLivechatCreator() {
    return new Proxy({
      __kind: 'getLivechatCreator'
    }, {
      get: (_target, prop)=>{
        // It's not worthwhile to make an asynchronous request for such a simple method
        if (prop === 'createToken') {
          return ()=>Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);
        }
        if (prop === 'toJSON') {
          return ()=>({});
        }
        return (...params)=>this.senderFn({
            method: `accessor:getModifier:getCreator:getLivechatCreator:${prop}`,
            params
          }).then((response)=>response.result).catch((err)=>{
            throw new Error(err.error);
          });
      }
    });
  }
  getUploadCreator() {
    return new Proxy({
      __kind: 'getUploadCreator'
    }, {
      get: (_target, prop)=>(...params)=>prop === 'toJSON' ? {} : this.senderFn({
            method: `accessor:getModifier:getCreator:getUploadCreator:${prop}`,
            params
          }).then((response)=>response.result).catch((err)=>{
            throw new Error(err.error);
          })
    });
  }
  getEmailCreator() {
    return new Proxy({
      __kind: 'getEmailCreator'
    }, {
      get: (_target, prop)=>(...params)=>prop === 'toJSON' ? {} : this.senderFn({
            method: `accessor:getModifier:getCreator:getEmailCreator:${prop}`,
            params
          }).then((response)=>response.result).catch((err)=>{
            throw new Error(err.error);
          })
    });
  }
  getBlockBuilder() {
    return new BlockBuilder();
  }
  startMessage(data) {
    if (data) {
      delete data.id;
    }
    return new MessageBuilder(data);
  }
  startLivechatMessage(data) {
    if (data) {
      delete data.id;
    }
    return new LivechatMessageBuilder(data);
  }
  startRoom(data) {
    if (data) {
      // @ts-ignore - this has been imported from the Apps-Engine
      delete data.id;
    }
    return new RoomBuilder(data);
  }
  startDiscussion(data) {
    if (data) {
      delete data.id;
    }
    return new DiscussionBuilder(data);
  }
  startVideoConference(data) {
    return new VideoConferenceBuilder(data);
  }
  startBotUser(data) {
    if (data) {
      delete data.id;
      const { roles } = data;
      if (roles?.length) {
        const hasRole = roles.map((role)=>role.toLocaleLowerCase()).some((role)=>role === 'admin' || role === 'owner' || role === 'moderator');
        if (hasRole) {
          throw new Error('Invalid role assigned to the user. Should not be admin, owner or moderator.');
        }
      }
      if (!data.type) {
        data.type = UserType.BOT;
      }
    }
    return new UserBuilder(data);
  }
  finish(builder) {
    switch(builder.kind){
      case RocketChatAssociationModel.MESSAGE:
        return this._finishMessage(builder);
      case RocketChatAssociationModel.LIVECHAT_MESSAGE:
        return this._finishLivechatMessage(builder);
      case RocketChatAssociationModel.ROOM:
        return this._finishRoom(builder);
      case RocketChatAssociationModel.DISCUSSION:
        return this._finishDiscussion(builder);
      case RocketChatAssociationModel.VIDEO_CONFERENCE:
        return this._finishVideoConference(builder);
      case RocketChatAssociationModel.USER:
        return this._finishUser(builder);
      default:
        throw new Error('Invalid builder passed to the ModifyCreator.finish function.');
    }
  }
  async _finishMessage(builder) {
    const result = builder.getMessage();
    delete result.id;
    if (!result.sender || !result.sender.id) {
      const response = await this.senderFn({
        method: 'bridges:getUserBridge:doGetAppUser',
        params: [
          'APP_ID'
        ]
      });
      const appUser = response.result;
      if (!appUser) {
        throw new Error('Invalid sender assigned to the message.');
      }
      result.sender = appUser;
    }
    if (result.blocks?.length) {
      // Can we move this elsewhere? This AppObjectRegistry usage doesn't really belong here, but where?
      result.blocks = UIHelper.assignIds(result.blocks, AppObjectRegistry.get('id') || '');
    }
    const response = await this.senderFn({
      method: 'bridges:getMessageBridge:doCreate',
      params: [
        result,
        AppObjectRegistry.get('id')
      ]
    });
    return String(response.result);
  }
  async _finishLivechatMessage(builder) {
    if (builder.getSender() && !builder.getVisitor()) {
      return this._finishMessage(builder.getMessageBuilder());
    }
    const result = builder.getMessage();
    delete result.id;
    if (!result.token && (!result.visitor || !result.visitor.token)) {
      throw new Error('Invalid visitor sending the message');
    }
    result.token = result.visitor ? result.visitor.token : result.token;
    const response = await this.senderFn({
      method: 'bridges:getLivechatBridge:doCreateMessage',
      params: [
        result,
        AppObjectRegistry.get('id')
      ]
    });
    return String(response.result);
  }
  async _finishRoom(builder) {
    const result = builder.getRoom();
    delete result.id;
    if (!result.type) {
      throw new Error('Invalid type assigned to the room.');
    }
    if (result.type !== RoomType.LIVE_CHAT) {
      if (!result.creator || !result.creator.id) {
        throw new Error('Invalid creator assigned to the room.');
      }
    }
    if (result.type !== RoomType.DIRECT_MESSAGE) {
      if (result.type !== RoomType.LIVE_CHAT) {
        if (!result.slugifiedName || !result.slugifiedName.trim()) {
          throw new Error('Invalid slugifiedName assigned to the room.');
        }
      }
      if (!result.displayName || !result.displayName.trim()) {
        throw new Error('Invalid displayName assigned to the room.');
      }
    }
    const response = await this.senderFn({
      method: 'bridges:getRoomBridge:doCreate',
      params: [
        result,
        builder.getMembersToBeAddedUsernames(),
        AppObjectRegistry.get('id')
      ]
    });
    return String(response.result);
  }
  async _finishDiscussion(builder) {
    const room = builder.getRoom();
    delete room.id;
    if (!room.creator || !room.creator.id) {
      throw new Error('Invalid creator assigned to the discussion.');
    }
    if (!room.slugifiedName || !room.slugifiedName.trim()) {
      throw new Error('Invalid slugifiedName assigned to the discussion.');
    }
    if (!room.displayName || !room.displayName.trim()) {
      throw new Error('Invalid displayName assigned to the discussion.');
    }
    if (!room.parentRoom || !room.parentRoom.id) {
      throw new Error('Invalid parentRoom assigned to the discussion.');
    }
    const response = await this.senderFn({
      method: 'bridges:getRoomBridge:doCreateDiscussion',
      params: [
        room,
        builder.getParentMessage(),
        builder.getReply(),
        builder.getMembersToBeAddedUsernames(),
        AppObjectRegistry.get('id')
      ]
    });
    return String(response.result);
  }
  async _finishVideoConference(builder) {
    const videoConference = builder.getVideoConference();
    if (!videoConference.createdBy) {
      throw new Error('Invalid creator assigned to the video conference.');
    }
    if (!videoConference.providerName?.trim()) {
      throw new Error('Invalid provider name assigned to the video conference.');
    }
    if (!videoConference.rid) {
      throw new Error('Invalid roomId assigned to the video conference.');
    }
    const response = await this.senderFn({
      method: 'bridges:getVideoConferenceBridge:doCreate',
      params: [
        videoConference,
        AppObjectRegistry.get('id')
      ]
    });
    return String(response.result);
  }
  async _finishUser(builder) {
    const user = builder.getUser();
    const response = await this.senderFn({
      method: 'bridges:getUserBridge:doCreate',
      params: [
        user,
        AppObjectRegistry.get('id')
      ]
    });
    return String(response.result);
  }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImZpbGU6Ly8vVXNlcnMvZ3VpbGhlcm1lZ2F6em8vZGV2L1JvY2tldC5DaGF0L3BhY2thZ2VzL2FwcHMtZW5naW5lL2Rlbm8tcnVudGltZS9saWIvYWNjZXNzb3JzL21vZGlmeS9Nb2RpZnlDcmVhdG9yLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB0eXBlIHsgSU1vZGlmeUNyZWF0b3IgfSBmcm9tICdAcm9ja2V0LmNoYXQvYXBwcy1lbmdpbmUvZGVmaW5pdGlvbi9hY2Nlc3NvcnMvSU1vZGlmeUNyZWF0b3IudHMnO1xuaW1wb3J0IHR5cGUgeyBJVXBsb2FkQ3JlYXRvciB9IGZyb20gJ0Byb2NrZXQuY2hhdC9hcHBzLWVuZ2luZS9kZWZpbml0aW9uL2FjY2Vzc29ycy9JVXBsb2FkQ3JlYXRvci50cyc7XG5pbXBvcnQgdHlwZSB7IElFbWFpbENyZWF0b3IgfSBmcm9tICdAcm9ja2V0LmNoYXQvYXBwcy1lbmdpbmUvZGVmaW5pdGlvbi9hY2Nlc3NvcnMvSUVtYWlsQ3JlYXRvci50cyc7XG5pbXBvcnQgdHlwZSB7IElMaXZlY2hhdENyZWF0b3IgfSBmcm9tICdAcm9ja2V0LmNoYXQvYXBwcy1lbmdpbmUvZGVmaW5pdGlvbi9hY2Nlc3NvcnMvSUxpdmVjaGF0Q3JlYXRvci50cyc7XG5pbXBvcnQgdHlwZSB7IElNZXNzYWdlIH0gZnJvbSAnQHJvY2tldC5jaGF0L2FwcHMtZW5naW5lL2RlZmluaXRpb24vbWVzc2FnZXMvSU1lc3NhZ2UudHMnO1xuaW1wb3J0IHR5cGUgeyBJUm9vbSB9IGZyb20gJ0Byb2NrZXQuY2hhdC9hcHBzLWVuZ2luZS9kZWZpbml0aW9uL3Jvb21zL0lSb29tLnRzJztcbmltcG9ydCB0eXBlIHsgSUJvdFVzZXIgfSBmcm9tICdAcm9ja2V0LmNoYXQvYXBwcy1lbmdpbmUvZGVmaW5pdGlvbi91c2Vycy9JQm90VXNlci50cyc7XG5pbXBvcnQgdHlwZSB7IFVzZXJUeXBlIGFzIF9Vc2VyVHlwZSB9IGZyb20gJ0Byb2NrZXQuY2hhdC9hcHBzLWVuZ2luZS9kZWZpbml0aW9uL3VzZXJzL1VzZXJUeXBlLnRzJztcbmltcG9ydCB0eXBlIHsgUm9ja2V0Q2hhdEFzc29jaWF0aW9uTW9kZWwgYXMgX1JvY2tldENoYXRBc3NvY2lhdGlvbk1vZGVsIH0gZnJvbSAnQHJvY2tldC5jaGF0L2FwcHMtZW5naW5lL2RlZmluaXRpb24vbWV0YWRhdGEvUm9ja2V0Q2hhdEFzc29jaWF0aW9ucy50cyc7XG5pbXBvcnQgdHlwZSB7IElNZXNzYWdlQnVpbGRlciB9IGZyb20gJ0Byb2NrZXQuY2hhdC9hcHBzLWVuZ2luZS9kZWZpbml0aW9uL2FjY2Vzc29ycy9JTWVzc2FnZUJ1aWxkZXIudHMnO1xuaW1wb3J0IHR5cGUgeyBJUm9vbUJ1aWxkZXIgfSBmcm9tICdAcm9ja2V0LmNoYXQvYXBwcy1lbmdpbmUvZGVmaW5pdGlvbi9hY2Nlc3NvcnMvSVJvb21CdWlsZGVyLnRzJztcbmltcG9ydCB0eXBlIHsgSVVzZXJCdWlsZGVyIH0gZnJvbSAnQHJvY2tldC5jaGF0L2FwcHMtZW5naW5lL2RlZmluaXRpb24vYWNjZXNzb3JzL0lVc2VyQnVpbGRlci50cyc7XG5pbXBvcnQgdHlwZSB7IElWaWRlb0NvbmZlcmVuY2VCdWlsZGVyIH0gZnJvbSAnQHJvY2tldC5jaGF0L2FwcHMtZW5naW5lL2RlZmluaXRpb24vYWNjZXNzb3JzL0lWaWRlb0NvbmZlcmVuY2VCdWlsZGVyLnRzJztcbmltcG9ydCB0eXBlIHsgUm9vbVR5cGUgYXMgX1Jvb21UeXBlIH0gZnJvbSAnQHJvY2tldC5jaGF0L2FwcHMtZW5naW5lL2RlZmluaXRpb24vcm9vbXMvUm9vbVR5cGUudHMnO1xuaW1wb3J0IHR5cGUgeyBJTGl2ZWNoYXRNZXNzYWdlQnVpbGRlciB9IGZyb20gJ0Byb2NrZXQuY2hhdC9hcHBzLWVuZ2luZS9kZWZpbml0aW9uL2FjY2Vzc29ycy9JTGl2ZWNoYXRNZXNzYWdlQnVpbGRlci50cyc7XG5pbXBvcnQgdHlwZSB7IFVJSGVscGVyIGFzIF9VSUhlbHBlciB9IGZyb20gJ0Byb2NrZXQuY2hhdC9hcHBzLWVuZ2luZS9zZXJ2ZXIvbWlzYy9VSUhlbHBlci50cyc7XG5cbmltcG9ydCAqIGFzIE1lc3NlbmdlciBmcm9tICcuLi8uLi9tZXNzZW5nZXIudHMnO1xuXG5pbXBvcnQgeyBCbG9ja0J1aWxkZXIgfSBmcm9tICcuLi9idWlsZGVycy9CbG9ja0J1aWxkZXIudHMnO1xuaW1wb3J0IHsgTWVzc2FnZUJ1aWxkZXIgfSBmcm9tICcuLi9idWlsZGVycy9NZXNzYWdlQnVpbGRlci50cyc7XG5pbXBvcnQgeyBEaXNjdXNzaW9uQnVpbGRlciwgSURpc2N1c3Npb25CdWlsZGVyIH0gZnJvbSAnLi4vYnVpbGRlcnMvRGlzY3Vzc2lvbkJ1aWxkZXIudHMnO1xuaW1wb3J0IHsgSUxpdmVjaGF0TWVzc2FnZSwgTGl2ZWNoYXRNZXNzYWdlQnVpbGRlciB9IGZyb20gJy4uL2J1aWxkZXJzL0xpdmVjaGF0TWVzc2FnZUJ1aWxkZXIudHMnO1xuaW1wb3J0IHsgUm9vbUJ1aWxkZXIgfSBmcm9tICcuLi9idWlsZGVycy9Sb29tQnVpbGRlci50cyc7XG5pbXBvcnQgeyBVc2VyQnVpbGRlciB9IGZyb20gJy4uL2J1aWxkZXJzL1VzZXJCdWlsZGVyLnRzJztcbmltcG9ydCB7IEFwcFZpZGVvQ29uZmVyZW5jZSwgVmlkZW9Db25mZXJlbmNlQnVpbGRlciB9IGZyb20gJy4uL2J1aWxkZXJzL1ZpZGVvQ29uZmVyZW5jZUJ1aWxkZXIudHMnO1xuaW1wb3J0IHsgQXBwT2JqZWN0UmVnaXN0cnkgfSBmcm9tICcuLi8uLi8uLi9BcHBPYmplY3RSZWdpc3RyeS50cyc7XG5pbXBvcnQgeyByZXF1aXJlIH0gZnJvbSAnLi4vLi4vLi4vbGliL3JlcXVpcmUudHMnO1xuXG5jb25zdCB7IFVJSGVscGVyIH0gPSByZXF1aXJlKCdAcm9ja2V0LmNoYXQvYXBwcy1lbmdpbmUvc2VydmVyL21pc2MvVUlIZWxwZXIuanMnKSBhcyB7IFVJSGVscGVyOiB0eXBlb2YgX1VJSGVscGVyIH07XG5jb25zdCB7IFJvb21UeXBlIH0gPSByZXF1aXJlKCdAcm9ja2V0LmNoYXQvYXBwcy1lbmdpbmUvZGVmaW5pdGlvbi9yb29tcy9Sb29tVHlwZS5qcycpIGFzIHsgUm9vbVR5cGU6IHR5cGVvZiBfUm9vbVR5cGUgfTtcbmNvbnN0IHsgVXNlclR5cGUgfSA9IHJlcXVpcmUoJ0Byb2NrZXQuY2hhdC9hcHBzLWVuZ2luZS9kZWZpbml0aW9uL3VzZXJzL1VzZXJUeXBlLmpzJykgYXMgeyBVc2VyVHlwZTogdHlwZW9mIF9Vc2VyVHlwZSB9O1xuY29uc3QgeyBSb2NrZXRDaGF0QXNzb2NpYXRpb25Nb2RlbCB9ID0gcmVxdWlyZSgnQHJvY2tldC5jaGF0L2FwcHMtZW5naW5lL2RlZmluaXRpb24vbWV0YWRhdGEvUm9ja2V0Q2hhdEFzc29jaWF0aW9ucy5qcycpIGFzIHtcbiAgICBSb2NrZXRDaGF0QXNzb2NpYXRpb25Nb2RlbDogdHlwZW9mIF9Sb2NrZXRDaGF0QXNzb2NpYXRpb25Nb2RlbDtcbn07XG5cbmV4cG9ydCBjbGFzcyBNb2RpZnlDcmVhdG9yIGltcGxlbWVudHMgSU1vZGlmeUNyZWF0b3Ige1xuICAgIGNvbnN0cnVjdG9yKHByaXZhdGUgcmVhZG9ubHkgc2VuZGVyRm46IHR5cGVvZiBNZXNzZW5nZXIuc2VuZFJlcXVlc3QpIHsgfVxuXG4gICAgZ2V0TGl2ZWNoYXRDcmVhdG9yKCk6IElMaXZlY2hhdENyZWF0b3Ige1xuICAgICAgICByZXR1cm4gbmV3IFByb3h5KFxuICAgICAgICAgICAgeyBfX2tpbmQ6ICdnZXRMaXZlY2hhdENyZWF0b3InIH0sXG4gICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgZ2V0OiAoX3RhcmdldDogdW5rbm93biwgcHJvcDogc3RyaW5nKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIC8vIEl0J3Mgbm90IHdvcnRod2hpbGUgdG8gbWFrZSBhbiBhc3luY2hyb25vdXMgcmVxdWVzdCBmb3Igc3VjaCBhIHNpbXBsZSBtZXRob2RcbiAgICAgICAgICAgICAgICAgICAgaWYgKHByb3AgPT09ICdjcmVhdGVUb2tlbicpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAoKSA9PiBNYXRoLnJhbmRvbSgpLnRvU3RyaW5nKDM2KS5zdWJzdHJpbmcoMiwgMTUpICsgTWF0aC5yYW5kb20oKS50b1N0cmluZygzNikuc3Vic3RyaW5nKDIsIDE1KTtcbiAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgIGlmIChwcm9wID09PSAndG9KU09OJykge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICgpID0+ICh7fSk7XG4gICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gKC4uLnBhcmFtczogdW5rbm93bltdKSA9PlxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zZW5kZXJGbih7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbWV0aG9kOiBgYWNjZXNzb3I6Z2V0TW9kaWZpZXI6Z2V0Q3JlYXRvcjpnZXRMaXZlY2hhdENyZWF0b3I6JHtwcm9wfWAsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFyYW1zLFxuICAgICAgICAgICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAudGhlbigocmVzcG9uc2UpID0+IHJlc3BvbnNlLnJlc3VsdClcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAuY2F0Y2goKGVycikgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoZXJyLmVycm9yKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgfSxcbiAgICAgICAgKSBhcyBJTGl2ZWNoYXRDcmVhdG9yO1xuICAgIH1cblxuICAgIGdldFVwbG9hZENyZWF0b3IoKTogSVVwbG9hZENyZWF0b3Ige1xuICAgICAgICByZXR1cm4gbmV3IFByb3h5KFxuICAgICAgICAgICAgeyBfX2tpbmQ6ICdnZXRVcGxvYWRDcmVhdG9yJyB9LFxuICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgIGdldDpcbiAgICAgICAgICAgICAgICAgICAgKF90YXJnZXQ6IHVua25vd24sIHByb3A6IHN0cmluZykgPT5cbiAgICAgICAgICAgICAgICAgICAgICAgICguLi5wYXJhbXM6IHVua25vd25bXSkgPT5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcm9wID09PSAndG9KU09OJ1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA/IHt9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDogdGhpcy5zZW5kZXJGbih7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtZXRob2Q6IGBhY2Nlc3NvcjpnZXRNb2RpZmllcjpnZXRDcmVhdG9yOmdldFVwbG9hZENyZWF0b3I6JHtwcm9wfWAsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYXJhbXMsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAudGhlbigocmVzcG9uc2UpID0+IHJlc3BvbnNlLnJlc3VsdClcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5jYXRjaCgoZXJyKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGVyci5lcnJvcik7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KSxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICkgYXMgSVVwbG9hZENyZWF0b3I7XG4gICAgfVxuXG4gICAgZ2V0RW1haWxDcmVhdG9yKCk6IElFbWFpbENyZWF0b3Ige1xuICAgICAgICByZXR1cm4gbmV3IFByb3h5KFxuICAgICAgICAgICAgeyBfX2tpbmQ6ICdnZXRFbWFpbENyZWF0b3InIH0sXG4gICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgZ2V0OiAoX3RhcmdldDogdW5rbm93biwgcHJvcDogc3RyaW5nKSA9PiBcbiAgICAgICAgICAgICAgICAgICAgICAgICguLi5wYXJhbXM6IHVua25vd25bXSkgPT5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcm9wID09PSAndG9KU09OJ1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA/IHt9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDogdGhpcy5zZW5kZXJGbih7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtZXRob2Q6IGBhY2Nlc3NvcjpnZXRNb2RpZmllcjpnZXRDcmVhdG9yOmdldEVtYWlsQ3JlYXRvcjoke3Byb3B9YCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhcmFtc1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLnRoZW4oKHJlc3BvbnNlKSA9PiByZXNwb25zZS5yZXN1bHQpXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAuY2F0Y2goKGVycikgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihlcnIuZXJyb3IpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSksXG4gICAgICAgICAgICB9XG4gICAgICAgIClcbiAgICB9XG5cbiAgICBnZXRCbG9ja0J1aWxkZXIoKSB7XG4gICAgICAgIHJldHVybiBuZXcgQmxvY2tCdWlsZGVyKCk7XG4gICAgfVxuXG4gICAgc3RhcnRNZXNzYWdlKGRhdGE/OiBJTWVzc2FnZSkge1xuICAgICAgICBpZiAoZGF0YSkge1xuICAgICAgICAgICAgZGVsZXRlIGRhdGEuaWQ7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gbmV3IE1lc3NhZ2VCdWlsZGVyKGRhdGEpO1xuICAgIH1cblxuICAgIHN0YXJ0TGl2ZWNoYXRNZXNzYWdlKGRhdGE/OiBJTGl2ZWNoYXRNZXNzYWdlKSB7XG4gICAgICAgIGlmIChkYXRhKSB7XG4gICAgICAgICAgICBkZWxldGUgZGF0YS5pZDtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBuZXcgTGl2ZWNoYXRNZXNzYWdlQnVpbGRlcihkYXRhKTtcbiAgICB9XG5cbiAgICBzdGFydFJvb20oZGF0YT86IElSb29tKSB7XG4gICAgICAgIGlmIChkYXRhKSB7XG4gICAgICAgICAgICAvLyBAdHMtaWdub3JlIC0gdGhpcyBoYXMgYmVlbiBpbXBvcnRlZCBmcm9tIHRoZSBBcHBzLUVuZ2luZVxuICAgICAgICAgICAgZGVsZXRlIGRhdGEuaWQ7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gbmV3IFJvb21CdWlsZGVyKGRhdGEpO1xuICAgIH1cblxuICAgIHN0YXJ0RGlzY3Vzc2lvbihkYXRhPzogUGFydGlhbDxJUm9vbT4pIHtcbiAgICAgICAgaWYgKGRhdGEpIHtcbiAgICAgICAgICAgIGRlbGV0ZSBkYXRhLmlkO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIG5ldyBEaXNjdXNzaW9uQnVpbGRlcihkYXRhKTtcbiAgICB9XG5cbiAgICBzdGFydFZpZGVvQ29uZmVyZW5jZShkYXRhPzogUGFydGlhbDxBcHBWaWRlb0NvbmZlcmVuY2U+KSB7XG4gICAgICAgIHJldHVybiBuZXcgVmlkZW9Db25mZXJlbmNlQnVpbGRlcihkYXRhKTtcbiAgICB9XG5cbiAgICBzdGFydEJvdFVzZXIoZGF0YT86IFBhcnRpYWw8SUJvdFVzZXI+KSB7XG4gICAgICAgIGlmIChkYXRhKSB7XG4gICAgICAgICAgICBkZWxldGUgZGF0YS5pZDtcblxuICAgICAgICAgICAgY29uc3QgeyByb2xlcyB9ID0gZGF0YTtcblxuICAgICAgICAgICAgaWYgKHJvbGVzPy5sZW5ndGgpIHtcbiAgICAgICAgICAgICAgICBjb25zdCBoYXNSb2xlID0gcm9sZXNcbiAgICAgICAgICAgICAgICAgICAgLm1hcCgocm9sZTogc3RyaW5nKSA9PiByb2xlLnRvTG9jYWxlTG93ZXJDYXNlKCkpXG4gICAgICAgICAgICAgICAgICAgIC5zb21lKChyb2xlOiBzdHJpbmcpID0+IHJvbGUgPT09ICdhZG1pbicgfHwgcm9sZSA9PT0gJ293bmVyJyB8fCByb2xlID09PSAnbW9kZXJhdG9yJyk7XG5cbiAgICAgICAgICAgICAgICBpZiAoaGFzUm9sZSkge1xuICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0ludmFsaWQgcm9sZSBhc3NpZ25lZCB0byB0aGUgdXNlci4gU2hvdWxkIG5vdCBiZSBhZG1pbiwgb3duZXIgb3IgbW9kZXJhdG9yLicpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKCFkYXRhLnR5cGUpIHtcbiAgICAgICAgICAgICAgICBkYXRhLnR5cGUgPSBVc2VyVHlwZS5CT1Q7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gbmV3IFVzZXJCdWlsZGVyKGRhdGEpO1xuICAgIH1cblxuICAgIHB1YmxpYyBmaW5pc2goXG4gICAgICAgIGJ1aWxkZXI6IElNZXNzYWdlQnVpbGRlciB8IElMaXZlY2hhdE1lc3NhZ2VCdWlsZGVyIHwgSVJvb21CdWlsZGVyIHwgSURpc2N1c3Npb25CdWlsZGVyIHwgSVZpZGVvQ29uZmVyZW5jZUJ1aWxkZXIgfCBJVXNlckJ1aWxkZXIsXG4gICAgKTogUHJvbWlzZTxzdHJpbmc+IHtcbiAgICAgICAgc3dpdGNoIChidWlsZGVyLmtpbmQpIHtcbiAgICAgICAgICAgIGNhc2UgUm9ja2V0Q2hhdEFzc29jaWF0aW9uTW9kZWwuTUVTU0FHRTpcbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5fZmluaXNoTWVzc2FnZShidWlsZGVyIGFzIElNZXNzYWdlQnVpbGRlcik7XG4gICAgICAgICAgICBjYXNlIFJvY2tldENoYXRBc3NvY2lhdGlvbk1vZGVsLkxJVkVDSEFUX01FU1NBR0U6XG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2ZpbmlzaExpdmVjaGF0TWVzc2FnZShidWlsZGVyIGFzIElMaXZlY2hhdE1lc3NhZ2VCdWlsZGVyKTtcbiAgICAgICAgICAgIGNhc2UgUm9ja2V0Q2hhdEFzc29jaWF0aW9uTW9kZWwuUk9PTTpcbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5fZmluaXNoUm9vbShidWlsZGVyIGFzIElSb29tQnVpbGRlcik7XG4gICAgICAgICAgICBjYXNlIFJvY2tldENoYXRBc3NvY2lhdGlvbk1vZGVsLkRJU0NVU1NJT046XG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2ZpbmlzaERpc2N1c3Npb24oYnVpbGRlciBhcyBJRGlzY3Vzc2lvbkJ1aWxkZXIpO1xuICAgICAgICAgICAgY2FzZSBSb2NrZXRDaGF0QXNzb2NpYXRpb25Nb2RlbC5WSURFT19DT05GRVJFTkNFOlxuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLl9maW5pc2hWaWRlb0NvbmZlcmVuY2UoYnVpbGRlciBhcyBJVmlkZW9Db25mZXJlbmNlQnVpbGRlcik7XG4gICAgICAgICAgICBjYXNlIFJvY2tldENoYXRBc3NvY2lhdGlvbk1vZGVsLlVTRVI6XG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2ZpbmlzaFVzZXIoYnVpbGRlciBhcyBJVXNlckJ1aWxkZXIpO1xuICAgICAgICAgICAgZGVmYXVsdDpcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0ludmFsaWQgYnVpbGRlciBwYXNzZWQgdG8gdGhlIE1vZGlmeUNyZWF0b3IuZmluaXNoIGZ1bmN0aW9uLicpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBhc3luYyBfZmluaXNoTWVzc2FnZShidWlsZGVyOiBJTWVzc2FnZUJ1aWxkZXIpOiBQcm9taXNlPHN0cmluZz4ge1xuICAgICAgICBjb25zdCByZXN1bHQgPSBidWlsZGVyLmdldE1lc3NhZ2UoKTtcbiAgICAgICAgZGVsZXRlIHJlc3VsdC5pZDtcblxuICAgICAgICBpZiAoIXJlc3VsdC5zZW5kZXIgfHwgIXJlc3VsdC5zZW5kZXIuaWQpIHtcbiAgICAgICAgICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgdGhpcy5zZW5kZXJGbih7XG4gICAgICAgICAgICAgICAgbWV0aG9kOiAnYnJpZGdlczpnZXRVc2VyQnJpZGdlOmRvR2V0QXBwVXNlcicsXG4gICAgICAgICAgICAgICAgcGFyYW1zOiBbJ0FQUF9JRCddLFxuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIGNvbnN0IGFwcFVzZXIgPSByZXNwb25zZS5yZXN1bHQ7XG5cbiAgICAgICAgICAgIGlmICghYXBwVXNlcikge1xuICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignSW52YWxpZCBzZW5kZXIgYXNzaWduZWQgdG8gdGhlIG1lc3NhZ2UuJyk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHJlc3VsdC5zZW5kZXIgPSBhcHBVc2VyO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKHJlc3VsdC5ibG9ja3M/Lmxlbmd0aCkge1xuICAgICAgICAgICAgLy8gQ2FuIHdlIG1vdmUgdGhpcyBlbHNld2hlcmU/IFRoaXMgQXBwT2JqZWN0UmVnaXN0cnkgdXNhZ2UgZG9lc24ndCByZWFsbHkgYmVsb25nIGhlcmUsIGJ1dCB3aGVyZT9cbiAgICAgICAgICAgIHJlc3VsdC5ibG9ja3MgPSBVSUhlbHBlci5hc3NpZ25JZHMocmVzdWx0LmJsb2NrcywgQXBwT2JqZWN0UmVnaXN0cnkuZ2V0KCdpZCcpIHx8ICcnKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgdGhpcy5zZW5kZXJGbih7XG4gICAgICAgICAgICBtZXRob2Q6ICdicmlkZ2VzOmdldE1lc3NhZ2VCcmlkZ2U6ZG9DcmVhdGUnLFxuICAgICAgICAgICAgcGFyYW1zOiBbcmVzdWx0LCBBcHBPYmplY3RSZWdpc3RyeS5nZXQoJ2lkJyldLFxuICAgICAgICB9KTtcblxuICAgICAgICByZXR1cm4gU3RyaW5nKHJlc3BvbnNlLnJlc3VsdCk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBhc3luYyBfZmluaXNoTGl2ZWNoYXRNZXNzYWdlKGJ1aWxkZXI6IElMaXZlY2hhdE1lc3NhZ2VCdWlsZGVyKTogUHJvbWlzZTxzdHJpbmc+IHtcbiAgICAgICAgaWYgKGJ1aWxkZXIuZ2V0U2VuZGVyKCkgJiYgIWJ1aWxkZXIuZ2V0VmlzaXRvcigpKSB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5fZmluaXNoTWVzc2FnZShidWlsZGVyLmdldE1lc3NhZ2VCdWlsZGVyKCkpO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgcmVzdWx0ID0gYnVpbGRlci5nZXRNZXNzYWdlKCk7XG4gICAgICAgIGRlbGV0ZSByZXN1bHQuaWQ7XG5cbiAgICAgICAgaWYgKCFyZXN1bHQudG9rZW4gJiYgKCFyZXN1bHQudmlzaXRvciB8fCAhcmVzdWx0LnZpc2l0b3IudG9rZW4pKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0ludmFsaWQgdmlzaXRvciBzZW5kaW5nIHRoZSBtZXNzYWdlJyk7XG4gICAgICAgIH1cblxuICAgICAgICByZXN1bHQudG9rZW4gPSByZXN1bHQudmlzaXRvciA/IHJlc3VsdC52aXNpdG9yLnRva2VuIDogcmVzdWx0LnRva2VuO1xuXG4gICAgICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgdGhpcy5zZW5kZXJGbih7XG4gICAgICAgICAgICBtZXRob2Q6ICdicmlkZ2VzOmdldExpdmVjaGF0QnJpZGdlOmRvQ3JlYXRlTWVzc2FnZScsXG4gICAgICAgICAgICBwYXJhbXM6IFtyZXN1bHQsIEFwcE9iamVjdFJlZ2lzdHJ5LmdldCgnaWQnKV0sXG4gICAgICAgIH0pO1xuXG4gICAgICAgIHJldHVybiBTdHJpbmcocmVzcG9uc2UucmVzdWx0KTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGFzeW5jIF9maW5pc2hSb29tKGJ1aWxkZXI6IElSb29tQnVpbGRlcik6IFByb21pc2U8c3RyaW5nPiB7XG4gICAgICAgIGNvbnN0IHJlc3VsdCA9IGJ1aWxkZXIuZ2V0Um9vbSgpO1xuICAgICAgICBkZWxldGUgcmVzdWx0LmlkO1xuXG4gICAgICAgIGlmICghcmVzdWx0LnR5cGUpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignSW52YWxpZCB0eXBlIGFzc2lnbmVkIHRvIHRoZSByb29tLicpO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKHJlc3VsdC50eXBlICE9PSBSb29tVHlwZS5MSVZFX0NIQVQpIHtcbiAgICAgICAgICAgIGlmICghcmVzdWx0LmNyZWF0b3IgfHwgIXJlc3VsdC5jcmVhdG9yLmlkKSB7XG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdJbnZhbGlkIGNyZWF0b3IgYXNzaWduZWQgdG8gdGhlIHJvb20uJyk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICBpZiAocmVzdWx0LnR5cGUgIT09IFJvb21UeXBlLkRJUkVDVF9NRVNTQUdFKSB7XG4gICAgICAgICAgICBpZiAocmVzdWx0LnR5cGUgIT09IFJvb21UeXBlLkxJVkVfQ0hBVCkge1xuICAgICAgICAgICAgICAgIGlmICghcmVzdWx0LnNsdWdpZmllZE5hbWUgfHwgIXJlc3VsdC5zbHVnaWZpZWROYW1lLnRyaW0oKSkge1xuICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0ludmFsaWQgc2x1Z2lmaWVkTmFtZSBhc3NpZ25lZCB0byB0aGUgcm9vbS4nKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmICghcmVzdWx0LmRpc3BsYXlOYW1lIHx8ICFyZXN1bHQuZGlzcGxheU5hbWUudHJpbSgpKSB7XG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdJbnZhbGlkIGRpc3BsYXlOYW1lIGFzc2lnbmVkIHRvIHRoZSByb29tLicpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCB0aGlzLnNlbmRlckZuKHtcbiAgICAgICAgICAgIG1ldGhvZDogJ2JyaWRnZXM6Z2V0Um9vbUJyaWRnZTpkb0NyZWF0ZScsXG4gICAgICAgICAgICBwYXJhbXM6IFtyZXN1bHQsIGJ1aWxkZXIuZ2V0TWVtYmVyc1RvQmVBZGRlZFVzZXJuYW1lcygpLCBBcHBPYmplY3RSZWdpc3RyeS5nZXQoJ2lkJyldLFxuICAgICAgICB9KTtcblxuICAgICAgICByZXR1cm4gU3RyaW5nKHJlc3BvbnNlLnJlc3VsdCk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBhc3luYyBfZmluaXNoRGlzY3Vzc2lvbihidWlsZGVyOiBJRGlzY3Vzc2lvbkJ1aWxkZXIpOiBQcm9taXNlPHN0cmluZz4ge1xuICAgICAgICBjb25zdCByb29tID0gYnVpbGRlci5nZXRSb29tKCk7XG4gICAgICAgIGRlbGV0ZSByb29tLmlkO1xuXG4gICAgICAgIGlmICghcm9vbS5jcmVhdG9yIHx8ICFyb29tLmNyZWF0b3IuaWQpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignSW52YWxpZCBjcmVhdG9yIGFzc2lnbmVkIHRvIHRoZSBkaXNjdXNzaW9uLicpO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKCFyb29tLnNsdWdpZmllZE5hbWUgfHwgIXJvb20uc2x1Z2lmaWVkTmFtZS50cmltKCkpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignSW52YWxpZCBzbHVnaWZpZWROYW1lIGFzc2lnbmVkIHRvIHRoZSBkaXNjdXNzaW9uLicpO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKCFyb29tLmRpc3BsYXlOYW1lIHx8ICFyb29tLmRpc3BsYXlOYW1lLnRyaW0oKSkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdJbnZhbGlkIGRpc3BsYXlOYW1lIGFzc2lnbmVkIHRvIHRoZSBkaXNjdXNzaW9uLicpO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKCFyb29tLnBhcmVudFJvb20gfHwgIXJvb20ucGFyZW50Um9vbS5pZCkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdJbnZhbGlkIHBhcmVudFJvb20gYXNzaWduZWQgdG8gdGhlIGRpc2N1c3Npb24uJyk7XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IHRoaXMuc2VuZGVyRm4oe1xuICAgICAgICAgICAgbWV0aG9kOiAnYnJpZGdlczpnZXRSb29tQnJpZGdlOmRvQ3JlYXRlRGlzY3Vzc2lvbicsXG4gICAgICAgICAgICBwYXJhbXM6IFtyb29tLCBidWlsZGVyLmdldFBhcmVudE1lc3NhZ2UoKSwgYnVpbGRlci5nZXRSZXBseSgpLCBidWlsZGVyLmdldE1lbWJlcnNUb0JlQWRkZWRVc2VybmFtZXMoKSwgQXBwT2JqZWN0UmVnaXN0cnkuZ2V0KCdpZCcpXSxcbiAgICAgICAgfSk7XG5cbiAgICAgICAgcmV0dXJuIFN0cmluZyhyZXNwb25zZS5yZXN1bHQpO1xuICAgIH1cblxuICAgIHByaXZhdGUgYXN5bmMgX2ZpbmlzaFZpZGVvQ29uZmVyZW5jZShidWlsZGVyOiBJVmlkZW9Db25mZXJlbmNlQnVpbGRlcik6IFByb21pc2U8c3RyaW5nPiB7XG4gICAgICAgIGNvbnN0IHZpZGVvQ29uZmVyZW5jZSA9IGJ1aWxkZXIuZ2V0VmlkZW9Db25mZXJlbmNlKCk7XG5cbiAgICAgICAgaWYgKCF2aWRlb0NvbmZlcmVuY2UuY3JlYXRlZEJ5KSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0ludmFsaWQgY3JlYXRvciBhc3NpZ25lZCB0byB0aGUgdmlkZW8gY29uZmVyZW5jZS4nKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICghdmlkZW9Db25mZXJlbmNlLnByb3ZpZGVyTmFtZT8udHJpbSgpKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0ludmFsaWQgcHJvdmlkZXIgbmFtZSBhc3NpZ25lZCB0byB0aGUgdmlkZW8gY29uZmVyZW5jZS4nKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICghdmlkZW9Db25mZXJlbmNlLnJpZCkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdJbnZhbGlkIHJvb21JZCBhc3NpZ25lZCB0byB0aGUgdmlkZW8gY29uZmVyZW5jZS4nKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgdGhpcy5zZW5kZXJGbih7XG4gICAgICAgICAgICBtZXRob2Q6ICdicmlkZ2VzOmdldFZpZGVvQ29uZmVyZW5jZUJyaWRnZTpkb0NyZWF0ZScsXG4gICAgICAgICAgICBwYXJhbXM6IFt2aWRlb0NvbmZlcmVuY2UsIEFwcE9iamVjdFJlZ2lzdHJ5LmdldCgnaWQnKV0sXG4gICAgICAgIH0pO1xuXG4gICAgICAgIHJldHVybiBTdHJpbmcocmVzcG9uc2UucmVzdWx0KTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGFzeW5jIF9maW5pc2hVc2VyKGJ1aWxkZXI6IElVc2VyQnVpbGRlcik6IFByb21pc2U8c3RyaW5nPiB7XG4gICAgICAgIGNvbnN0IHVzZXIgPSBidWlsZGVyLmdldFVzZXIoKTtcblxuICAgICAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IHRoaXMuc2VuZGVyRm4oe1xuICAgICAgICAgICAgbWV0aG9kOiAnYnJpZGdlczpnZXRVc2VyQnJpZGdlOmRvQ3JlYXRlJyxcbiAgICAgICAgICAgIHBhcmFtczogW3VzZXIsIEFwcE9iamVjdFJlZ2lzdHJ5LmdldCgnaWQnKV0sXG4gICAgICAgIH0pO1xuXG4gICAgICAgIHJldHVybiBTdHJpbmcocmVzcG9uc2UucmVzdWx0KTtcbiAgICB9XG59XG4iXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBbUJBLFNBQVMsWUFBWSxRQUFRLDhCQUE4QjtBQUMzRCxTQUFTLGNBQWMsUUFBUSxnQ0FBZ0M7QUFDL0QsU0FBUyxpQkFBaUIsUUFBNEIsbUNBQW1DO0FBQ3pGLFNBQTJCLHNCQUFzQixR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