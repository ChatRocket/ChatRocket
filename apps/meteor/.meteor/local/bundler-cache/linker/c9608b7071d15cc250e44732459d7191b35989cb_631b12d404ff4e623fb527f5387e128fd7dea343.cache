[{"type":"js","data":"Package[\"core-runtime\"].queue(\"rocketchat:streamer\",function () {/* Imports */\nvar Meteor = Package.meteor.Meteor;\nvar global = Package.meteor.global;\nvar meteorEnv = Package.meteor.meteorEnv;\nvar EmitterPromise = Package.meteor.EmitterPromise;\nvar DDPCommon = Package['ddp-common'].DDPCommon;\nvar ECMAScript = Package.ecmascript.ECMAScript;\nvar check = Package.check.check;\nvar Match = Package.check.Match;\nvar Tracker = Package.tracker.Tracker;\nvar Deps = Package.tracker.Deps;\nvar meteorInstall = Package.modules.meteorInstall;\nvar Promise = Package.promise.Promise;\n\n/* Package-scope variables */\nvar EV, fn, eventName, Streamer;\n\nvar require = meteorInstall({\"node_modules\":{\"meteor\":{\"rocketchat:streamer\":{\"lib\":{\"ev.js\":function module(){\n\n////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\n//                                                                                                                    //\n// packages/rocketchat_streamer/lib/ev.js                                                                             //\n//                                                                                                                    //\n////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\n                                                                                                                      //\n/* globals EV:true */\n/* exported EV */\n\nEV = class EV {\n  constructor() {\n    this.handlers = {};\n  }\n  emit(event) {\n    for (var _len = arguments.length, args = new Array(_len > 1 ? _len - 1 : 0), _key = 1; _key < _len; _key++) {\n      args[_key - 1] = arguments[_key];\n    }\n    return this.handlers[event] && this.handlers[event].forEach(handler => handler.apply(this, args));\n  }\n  emitWithScope(event, scope) {\n    for (var _len2 = arguments.length, args = new Array(_len2 > 2 ? _len2 - 2 : 0), _key2 = 2; _key2 < _len2; _key2++) {\n      args[_key2 - 2] = arguments[_key2];\n    }\n    return this.handlers[event] && this.handlers[event].forEach(handler => handler.apply(scope, args));\n  }\n  listenerCount(event) {\n    return this.handlers[event] && this.handlers[event].length || 0;\n  }\n  on(event, callback) {\n    if (!this.handlers[event]) {\n      this.handlers[event] = [];\n    }\n    this.handlers[event].push(callback);\n  }\n  once(event, callback) {\n    const self = this;\n    this.on(event, function onetimeCallback() {\n      self.removeListener(event, onetimeCallback);\n      callback.apply(this, arguments);\n    });\n  }\n  removeListener(event, callback) {\n    if (!this.handlers[event]) {\n      return;\n    }\n    const index = this.handlers[event].indexOf(callback);\n    if (index > -1) {\n      this.handlers[event].splice(index, 1);\n    }\n  }\n  removeAllListeners(event) {\n    this.handlers[event] = undefined;\n  }\n};\n////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\n\n}},\"server\":{\"server.js\":function module(require,exports,module){\n\n////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\n//                                                                                                                    //\n// packages/rocketchat_streamer/server/server.js                                                                      //\n//                                                                                                                    //\n////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\n                                                                                                                      //\n!module.wrapAsync(async function (module, __reifyWaitForDeps__, __reify_async_result__) {\n  \"use strict\";\n  try {\n    let DDPCommon;\n    module.link(\"meteor/ddp-common\", {\n      DDPCommon(v) {\n        DDPCommon = v;\n      }\n    }, 0);\n    if (__reifyWaitForDeps__()) (await __reifyWaitForDeps__())();\n    class StreamerCentral extends EV {\n      constructor() {\n        super();\n        this.instances = {};\n      }\n    }\n    Meteor.StreamerCentral = new StreamerCentral();\n    const changedPayload = function (collection, id, fields) {\n      if (_.isEmpty(fields)) {\n        return;\n      }\n      return DDPCommon.stringifyDDP({\n        msg: 'changed',\n        collection,\n        id,\n        fields\n      });\n    };\n    const send = function (self, msg) {\n      if (!self.socket) {\n        return;\n      }\n      self.socket.send(msg);\n    };\n    Meteor.Streamer = class Streamer extends EV {\n      constructor(name) {\n        let {\n          retransmit = true,\n          retransmitToSelf = false\n        } = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};\n        if (Meteor.StreamerCentral.instances[name]) {\n          console.warn('Streamer instance already exists:', name);\n          return Meteor.StreamerCentral.instances[name];\n        }\n        super();\n        Meteor.StreamerCentral.instances[name] = this;\n        this.name = name;\n        this.retransmit = retransmit;\n        this.retransmitToSelf = retransmitToSelf;\n        this.subscriptions = [];\n        this.subscriptionsByEventName = {};\n        this.transformers = {};\n        this.iniPublication();\n        this.initMethod();\n        this._allowRead = {};\n        this._allowEmit = {};\n        this._allowWrite = {};\n        this.allowRead('none');\n        this.allowEmit('all');\n        this.allowWrite('none');\n      }\n      get name() {\n        return this._name;\n      }\n      set name(name) {\n        check(name, String);\n        this._name = name;\n      }\n      get subscriptionName() {\n        return \"stream-\".concat(this.name);\n      }\n      get retransmit() {\n        return this._retransmit;\n      }\n      set retransmit(retransmit) {\n        check(retransmit, Boolean);\n        this._retransmit = retransmit;\n      }\n      get retransmitToSelf() {\n        return this._retransmitToSelf;\n      }\n      set retransmitToSelf(retransmitToSelf) {\n        check(retransmitToSelf, Boolean);\n        this._retransmitToSelf = retransmitToSelf;\n      }\n      allowRead(eventName, fn) {\n        if (fn === undefined) {\n          fn = eventName;\n          eventName = '__all__';\n        }\n        if (typeof fn === 'function') {\n          return this._allowRead[eventName] = fn;\n        }\n        if (typeof fn === 'string' && ['all', 'none', 'logged'].indexOf(fn) === -1) {\n          console.error(\"allowRead shortcut '\".concat(fn, \"' is invalid\"));\n        }\n        if (fn === 'all' || fn === true) {\n          return this._allowRead[eventName] = function () {\n            return true;\n          };\n        }\n        if (fn === 'none' || fn === false) {\n          return this._allowRead[eventName] = function () {\n            return false;\n          };\n        }\n        if (fn === 'logged') {\n          return this._allowRead[eventName] = function () {\n            return Boolean(this.userId);\n          };\n        }\n      }\n      allowEmit(eventName, fn) {\n        if (fn === undefined) {\n          fn = eventName;\n          eventName = '__all__';\n        }\n        if (typeof fn === 'function') {\n          return this._allowEmit[eventName] = fn;\n        }\n        if (typeof fn === 'string' && ['all', 'none', 'logged'].indexOf(fn) === -1) {\n          console.error(\"allowRead shortcut '\".concat(fn, \"' is invalid\"));\n        }\n        if (fn === 'all' || fn === true) {\n          return this._allowEmit[eventName] = function () {\n            return true;\n          };\n        }\n        if (fn === 'none' || fn === false) {\n          return this._allowEmit[eventName] = function () {\n            return false;\n          };\n        }\n        if (fn === 'logged') {\n          return this._allowEmit[eventName] = function () {\n            return Boolean(this.userId);\n          };\n        }\n      }\n      allowWrite(eventName, fn) {\n        if (fn === undefined) {\n          fn = eventName;\n          eventName = '__all__';\n        }\n        if (typeof fn === 'function') {\n          return this._allowWrite[eventName] = fn;\n        }\n        if (typeof fn === 'string' && ['all', 'none', 'logged'].indexOf(fn) === -1) {\n          console.error(\"allowWrite shortcut '\".concat(fn, \"' is invalid\"));\n        }\n        if (fn === 'all' || fn === true) {\n          return this._allowWrite[eventName] = function () {\n            return true;\n          };\n        }\n        if (fn === 'none' || fn === false) {\n          return this._allowWrite[eventName] = function () {\n            return false;\n          };\n        }\n        if (fn === 'logged') {\n          return this._allowWrite[eventName] = function () {\n            return Boolean(this.userId);\n          };\n        }\n      }\n      isReadAllowed(scope, eventName, args) {\n        if (this._allowRead[eventName]) {\n          return this._allowRead[eventName].call(scope, eventName, ...args);\n        }\n        return this._allowRead['__all__'].call(scope, eventName, ...args);\n      }\n      isEmitAllowed(scope, eventName) {\n        for (var _len = arguments.length, args = new Array(_len > 2 ? _len - 2 : 0), _key = 2; _key < _len; _key++) {\n          args[_key - 2] = arguments[_key];\n        }\n        if (this._allowEmit[eventName]) {\n          return this._allowEmit[eventName].call(scope, eventName, ...args);\n        }\n        return this._allowEmit['__all__'].call(scope, eventName, ...args);\n      }\n      isWriteAllowed(scope, eventName, args) {\n        if (this._allowWrite[eventName]) {\n          return this._allowWrite[eventName].call(scope, eventName, ...args);\n        }\n        return this._allowWrite['__all__'].call(scope, eventName, ...args);\n      }\n      addSubscription(subscription, eventName) {\n        this.subscriptions.push(subscription);\n        if (!this.subscriptionsByEventName[eventName]) {\n          this.subscriptionsByEventName[eventName] = [];\n        }\n        this.subscriptionsByEventName[eventName].push(subscription);\n      }\n      removeSubscription(subscription, eventName) {\n        const index = this.subscriptions.indexOf(subscription);\n        if (index > -1) {\n          this.subscriptions.splice(index, 1);\n        }\n        if (this.subscriptionsByEventName[eventName]) {\n          const index = this.subscriptionsByEventName[eventName].indexOf(subscription);\n          if (index > -1) {\n            this.subscriptionsByEventName[eventName].splice(index, 1);\n          }\n        }\n      }\n      transform(eventName, fn) {\n        if (typeof eventName === 'function') {\n          fn = eventName;\n          eventName = '__all__';\n        }\n        if (!this.transformers[eventName]) {\n          this.transformers[eventName] = [];\n        }\n        this.transformers[eventName].push(fn);\n      }\n      applyTransformers(methodScope, eventName, args) {\n        if (this.transformers['__all__']) {\n          this.transformers['__all__'].forEach(transform => {\n            args = transform.call(methodScope, eventName, args);\n            methodScope.tranformed = true;\n            if (!Array.isArray(args)) {\n              args = [args];\n            }\n          });\n        }\n        if (this.transformers[eventName]) {\n          this.transformers[eventName].forEach(transform => {\n            args = transform.call(methodScope, ...args);\n            methodScope.tranformed = true;\n            if (!Array.isArray(args)) {\n              args = [args];\n            }\n          });\n        }\n        return args;\n      }\n      _publish(publication, eventName, options) {\n        check(eventName, String);\n        check(options, Match.OneOf(Boolean, {\n          useCollection: Boolean,\n          args: Array\n        }));\n        let useCollection,\n          args = [];\n        if (typeof options === 'boolean') {\n          useCollection = options;\n        } else {\n          if (options.useCollection) {\n            useCollection = options.useCollection;\n          }\n          if (options.args) {\n            args = options.args;\n          }\n        }\n        if (eventName.length === 0) {\n          publication.stop();\n          throw new Meteor.Error('invalid-event-name');\n        }\n        if (this.isReadAllowed(publication, eventName, args) !== true) {\n          publication.stop();\n          throw new Meteor.Error('not-allowed');\n        }\n        const subscription = {\n          subscription: publication,\n          eventName: eventName\n        };\n        this.addSubscription(subscription, eventName);\n        publication.onStop(() => {\n          this.removeSubscription(subscription, eventName);\n        });\n        if (useCollection === true) {\n          // Collection compatibility\n          publication._session.sendAdded(this.subscriptionName, 'id', {\n            eventName: eventName\n          });\n        }\n        publication.ready();\n      }\n      iniPublication() {\n        const stream = this;\n        Meteor.publish(this.subscriptionName, function () {\n          for (var _len2 = arguments.length, args = new Array(_len2), _key2 = 0; _key2 < _len2; _key2++) {\n            args[_key2] = arguments[_key2];\n          }\n          return stream._publish.apply(stream, [this, ...args]);\n        });\n      }\n      initMethod() {\n        const stream = this;\n        const method = {};\n        method[this.subscriptionName] = function (eventName) {\n          for (var _len3 = arguments.length, args = new Array(_len3 > 1 ? _len3 - 1 : 0), _key3 = 1; _key3 < _len3; _key3++) {\n            args[_key3 - 1] = arguments[_key3];\n          }\n          check(eventName, String);\n          check(args, Array);\n          this.unblock();\n          if (stream.isWriteAllowed(this, eventName, args) !== true) {\n            return;\n          }\n          const methodScope = {\n            userId: this.userId,\n            connection: this.connection,\n            originalParams: args,\n            tranformed: false\n          };\n          args = stream.applyTransformers(methodScope, eventName, args);\n          stream.emitWithScope(eventName, methodScope, ...args);\n          if (stream.retransmit === true) {\n            stream._emit(eventName, args, this.connection, true);\n          }\n        };\n        try {\n          Meteor.methods(method);\n        } catch (e) {\n          console.error(e);\n        }\n      }\n      _emit(eventName, args, origin, broadcast) {\n        if (broadcast === true) {\n          Meteor.StreamerCentral.emit('broadcast', this.name, eventName, args);\n        }\n        const subscriptions = this.subscriptionsByEventName[eventName];\n        if (!Array.isArray(subscriptions)) {\n          return;\n        }\n        const msg = changedPayload(this.subscriptionName, 'id', {\n          eventName,\n          args\n        });\n        if (!msg) {\n          return;\n        }\n        subscriptions.forEach(subscription => {\n          if (this.retransmitToSelf === false && origin && origin === subscription.subscription.connection) {\n            return;\n          }\n          if (this.isEmitAllowed(subscription.subscription, eventName, ...args)) {\n            send(subscription.subscription._session, msg);\n          }\n        });\n      }\n      emit(eventName) {\n        for (var _len4 = arguments.length, args = new Array(_len4 > 1 ? _len4 - 1 : 0), _key4 = 1; _key4 < _len4; _key4++) {\n          args[_key4 - 1] = arguments[_key4];\n        }\n        this._emit(eventName, args, undefined, true);\n      }\n      __emit() {\n        return super.emit(...arguments);\n      }\n      emitWithoutBroadcast(eventName) {\n        for (var _len5 = arguments.length, args = new Array(_len5 > 1 ? _len5 - 1 : 0), _key5 = 1; _key5 < _len5; _key5++) {\n          args[_key5 - 1] = arguments[_key5];\n        }\n        this._emit(eventName, args, undefined, false);\n      }\n    };\n    __reify_async_result__();\n  } catch (_reifyError) {\n    return __reify_async_result__(_reifyError);\n  }\n  __reify_async_result__()\n}, {\n  self: this,\n  async: false\n});\n////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\n\n}}}}}},{\n  \"extensions\": [\n    \".js\",\n    \".json\"\n  ]\n});\n\n\n/* Exports */\nreturn {\n  export: function () { return {\n      Streamer: Streamer\n    };},\n  require: require,\n  eagerModulePaths: [\n    \"/node_modules/meteor/rocketchat:streamer/lib/ev.js\",\n    \"/node_modules/meteor/rocketchat:streamer/server/server.js\"\n  ]\n}});\n","servePath":"/packages/rocketchat_streamer.js","sourceMap":{"version":3,"sources":["packages/rocketchat:streamer/lib/ev.js","packages/rocketchat:streamer/server/server.js"],"names":["EV","constructor","handlers","emit","event","_len","arguments","length","args","Array","_key","forEach","handler","apply","emitWithScope","scope","_len2","_key2","listenerCount","on","callback","push","once","self","onetimeCallback","removeListener","index","indexOf","splice","removeAllListeners","undefined","DDPCommon","module","link","v","__reifyWaitForDeps__","StreamerCentral","instances","Meteor","changedPayload","collection","id","fields","_","isEmpty","stringifyDDP","msg","send","socket","Streamer","name","retransmit","retransmitToSelf","console","warn","subscriptions","subscriptionsByEventName","transformers","iniPublication","initMethod","_allowRead","_allowEmit","_allowWrite","allowRead","allowEmit","allowWrite","_name","check","String","subscriptionName","concat","_retransmit","Boolean","_retransmitToSelf","eventName","fn","error","userId","isReadAllowed","call","isEmitAllowed","isWriteAllowed","addSubscription","subscription","removeSubscription","transform","applyTransformers","methodScope","tranformed","isArray","_publish","publication","options","Match","OneOf","useCollection","stop","Error","onStop","_session","sendAdded","ready","stream","publish","method","_len3","_key3","unblock","connection","originalParams","_emit","methods","e","origin","broadcast","_len4","_key4","__emit","emitWithoutBroadcast","_len5","_key5","__reify_async_result__","_reifyError","async"],"mappings":"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","file":"/packages/rocketchat_streamer.js","sourcesContent":["/* globals EV:true */\n/* exported EV */\n\nEV = class EV {\n\tconstructor() {\n\t\tthis.handlers = {};\n\t}\n\n\temit(event, ...args) {\n\t\treturn this.handlers[event] && this.handlers[event].forEach(handler => handler.apply(this, args));\n\t}\n\n\temitWithScope(event, scope, ...args) {\n\t\treturn this.handlers[event] && this.handlers[event].forEach(handler => handler.apply(scope, args));\n\t}\n\n\tlistenerCount(event) {\n\t\treturn (this.handlers[event] && this.handlers[event].length) || 0;\n\t}\n\n\ton(event, callback) {\n\t\tif (!this.handlers[event]) {\n\t\t\tthis.handlers[event] = [];\n\t\t}\n\t\tthis.handlers[event].push(callback);\n\t}\n\n\tonce(event, callback) {\n\t\tconst self = this;\n\t\tthis.on(event, function onetimeCallback() {\n\t\t\tself.removeListener(event, onetimeCallback);\n\t\t\tcallback.apply(this, arguments);\n\t\t});\n\t}\n\n\tremoveListener(event, callback) {\n\t\tif (!this.handlers[event]) {\n\t\t\treturn;\n\t\t}\n\t\tconst index = this.handlers[event].indexOf(callback);\n\t\tif (index > -1) {\n\t\t\tthis.handlers[event].splice(index, 1);\n\t\t}\n\t}\n\n\tremoveAllListeners(event) {\n\t\tthis.handlers[event] = undefined;\n\t}\n};\n","/* globals EV */\n/* eslint new-cap: false */\nimport { DDPCommon } from 'meteor/ddp-common';\n\nclass StreamerCentral extends EV {\n\tconstructor() {\n\t\tsuper();\n\n\t\tthis.instances = {};\n\t}\n}\n\nMeteor.StreamerCentral = new StreamerCentral;\n\nconst changedPayload = function (collection, id, fields) {\n\tif (_.isEmpty(fields)) {\n\t\treturn;\n\t}\n\treturn DDPCommon.stringifyDDP({\n\t\tmsg: 'changed',\n\t\tcollection,\n\t\tid,\n\t\tfields\n\t});\n};\n\nconst send = function (self, msg) {\n\tif (!self.socket) {\n\t\treturn;\n\t}\n\tself.socket.send(msg);\n};\n\n\nMeteor.Streamer = class Streamer extends EV {\n\tconstructor(name, {retransmit = true, retransmitToSelf = false} = {}) {\n\t\tif (Meteor.StreamerCentral.instances[name]) {\n\t\t\tconsole.warn('Streamer instance already exists:', name);\n\t\t\treturn Meteor.StreamerCentral.instances[name];\n\t\t}\n\n\t\tsuper();\n\n\t\tMeteor.StreamerCentral.instances[name] = this;\n\n\t\tthis.name = name;\n\t\tthis.retransmit = retransmit;\n\t\tthis.retransmitToSelf = retransmitToSelf;\n\n\t\tthis.subscriptions = [];\n\t\tthis.subscriptionsByEventName = {};\n\t\tthis.transformers = {};\n\n\t\tthis.iniPublication();\n\t\tthis.initMethod();\n\n\t\tthis._allowRead = {};\n\t\tthis._allowEmit = {};\n\t\tthis._allowWrite = {};\n\n\t\tthis.allowRead('none');\n\t\tthis.allowEmit('all');\n\t\tthis.allowWrite('none');\n\t}\n\n\tget name() {\n\t\treturn this._name;\n\t}\n\n\tset name(name) {\n\t\tcheck(name, String);\n\t\tthis._name = name;\n\t}\n\n\tget subscriptionName() {\n\t\treturn `stream-${this.name}`;\n\t}\n\n\tget retransmit() {\n\t\treturn this._retransmit;\n\t}\n\n\tset retransmit(retransmit) {\n\t\tcheck(retransmit, Boolean);\n\t\tthis._retransmit = retransmit;\n\t}\n\n\tget retransmitToSelf() {\n\t\treturn this._retransmitToSelf;\n\t}\n\n\tset retransmitToSelf(retransmitToSelf) {\n\t\tcheck(retransmitToSelf, Boolean);\n\t\tthis._retransmitToSelf = retransmitToSelf;\n\t}\n\n\tallowRead(eventName, fn) {\n\t\tif (fn === undefined) {\n\t\t\tfn = eventName;\n\t\t\teventName = '__all__';\n\t\t}\n\n\t\tif (typeof fn === 'function') {\n\t\t\treturn this._allowRead[eventName] = fn;\n\t\t}\n\n\t\tif (typeof fn === 'string' && ['all', 'none', 'logged'].indexOf(fn) === -1) {\n\t\t\tconsole.error(`allowRead shortcut '${fn}' is invalid`);\n\t\t}\n\n\t\tif (fn === 'all' || fn === true) {\n\t\t\treturn this._allowRead[eventName] = function() {\n\t\t\t\treturn true;\n\t\t\t};\n\t\t}\n\n\t\tif (fn === 'none' || fn === false) {\n\t\t\treturn this._allowRead[eventName] = function() {\n\t\t\t\treturn false;\n\t\t\t};\n\t\t}\n\n\t\tif (fn === 'logged') {\n\t\t\treturn this._allowRead[eventName] = function() {\n\t\t\t\treturn Boolean(this.userId);\n\t\t\t};\n\t\t}\n\t}\n\n\tallowEmit(eventName, fn) {\n\t\tif (fn === undefined) {\n\t\t\tfn = eventName;\n\t\t\teventName = '__all__';\n\t\t}\n\n\t\tif (typeof fn === 'function') {\n\t\t\treturn this._allowEmit[eventName] = fn;\n\t\t}\n\n\t\tif (typeof fn === 'string' && ['all', 'none', 'logged'].indexOf(fn) === -1) {\n\t\t\tconsole.error(`allowRead shortcut '${fn}' is invalid`);\n\t\t}\n\n\t\tif (fn === 'all' || fn === true) {\n\t\t\treturn this._allowEmit[eventName] = function() {\n\t\t\t\treturn true;\n\t\t\t};\n\t\t}\n\n\t\tif (fn === 'none' || fn === false) {\n\t\t\treturn this._allowEmit[eventName] = function() {\n\t\t\t\treturn false;\n\t\t\t};\n\t\t}\n\n\t\tif (fn === 'logged') {\n\t\t\treturn this._allowEmit[eventName] = function() {\n\t\t\t\treturn Boolean(this.userId);\n\t\t\t};\n\t\t}\n\t}\n\n\tallowWrite(eventName, fn) {\n\t\tif (fn === undefined) {\n\t\t\tfn = eventName;\n\t\t\teventName = '__all__';\n\t\t}\n\n\t\tif (typeof fn === 'function') {\n\t\t\treturn this._allowWrite[eventName] = fn;\n\t\t}\n\n\t\tif (typeof fn === 'string' && ['all', 'none', 'logged'].indexOf(fn) === -1) {\n\t\t\tconsole.error(`allowWrite shortcut '${fn}' is invalid`);\n\t\t}\n\n\t\tif (fn === 'all' || fn === true) {\n\t\t\treturn this._allowWrite[eventName] = function() {\n\t\t\t\treturn true;\n\t\t\t};\n\t\t}\n\n\t\tif (fn === 'none' || fn === false) {\n\t\t\treturn this._allowWrite[eventName] = function() {\n\t\t\t\treturn false;\n\t\t\t};\n\t\t}\n\n\t\tif (fn === 'logged') {\n\t\t\treturn this._allowWrite[eventName] = function() {\n\t\t\t\treturn Boolean(this.userId);\n\t\t\t};\n\t\t}\n\t}\n\n\tisReadAllowed(scope, eventName, args) {\n\t\tif (this._allowRead[eventName]) {\n\t\t\treturn this._allowRead[eventName].call(scope, eventName, ...args);\n\t\t}\n\n\t\treturn this._allowRead['__all__'].call(scope, eventName, ...args);\n\t}\n\n\tisEmitAllowed(scope, eventName, ...args) {\n\t\tif (this._allowEmit[eventName]) {\n\t\t\treturn this._allowEmit[eventName].call(scope, eventName, ...args);\n\t\t}\n\n\t\treturn this._allowEmit['__all__'].call(scope, eventName, ...args);\n\t}\n\n\tisWriteAllowed(scope, eventName, args) {\n\t\tif (this._allowWrite[eventName]) {\n\t\t\treturn this._allowWrite[eventName].call(scope, eventName, ...args);\n\t\t}\n\n\t\treturn this._allowWrite['__all__'].call(scope, eventName, ...args);\n\t}\n\n\taddSubscription(subscription, eventName) {\n\t\tthis.subscriptions.push(subscription);\n\n\t\tif (!this.subscriptionsByEventName[eventName]) {\n\t\t\tthis.subscriptionsByEventName[eventName] = [];\n\t\t}\n\n\t\tthis.subscriptionsByEventName[eventName].push(subscription);\n\t}\n\n\tremoveSubscription(subscription, eventName) {\n\t\tconst index = this.subscriptions.indexOf(subscription);\n\t\tif (index > -1) {\n\t\t\tthis.subscriptions.splice(index, 1);\n\t\t}\n\n\t\tif (this.subscriptionsByEventName[eventName]) {\n\t\t\tconst index = this.subscriptionsByEventName[eventName].indexOf(subscription);\n\t\t\tif (index > -1) {\n\t\t\t\tthis.subscriptionsByEventName[eventName].splice(index, 1);\n\t\t\t}\n\t\t}\n\t}\n\n\ttransform(eventName, fn) {\n\t\tif (typeof eventName === 'function') {\n\t\t\tfn = eventName;\n\t\t\teventName = '__all__';\n\t\t}\n\n\t\tif (!this.transformers[eventName]) {\n\t\t\tthis.transformers[eventName] = [];\n\t\t}\n\n\t\tthis.transformers[eventName].push(fn);\n\t}\n\n\tapplyTransformers(methodScope, eventName, args) {\n\t\tif (this.transformers['__all__']) {\n\t\t\tthis.transformers['__all__'].forEach((transform) => {\n\t\t\t\targs = transform.call(methodScope, eventName, args);\n\t\t\t\tmethodScope.tranformed = true;\n\t\t\t\tif (!Array.isArray(args)) {\n\t\t\t\t\targs = [args];\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\n\t\tif (this.transformers[eventName]) {\n\t\t\tthis.transformers[eventName].forEach((transform) => {\n\t\t\t\targs = transform.call(methodScope, ...args);\n\t\t\t\tmethodScope.tranformed = true;\n\t\t\t\tif (!Array.isArray(args)) {\n\t\t\t\t\targs = [args];\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\n\t\treturn args;\n\t}\n\n\n\t_publish(publication, eventName, options) {\n\t\tcheck(eventName, String);\n\t\tcheck(options, Match.OneOf(Boolean, {\n\t\t\tuseCollection: Boolean,\n\t\t\targs: Array,\n\t\t}));\n\n\t\tlet useCollection, args = [];\n\n\t\tif (typeof options === 'boolean') {\n\t\t\tuseCollection = options;\n\t\t} else {\n\t\t\tif (options.useCollection) {\n\t\t\t\tuseCollection = options.useCollection;\n\t\t\t}\n\n\t\t\tif (options.args) {\n\t\t\t\targs = options.args;\n\t\t\t}\n\t\t}\n\n\t\tif (eventName.length === 0) {\n\t\t\tpublication.stop();\n\t\t\tthrow new Meteor.Error('invalid-event-name');\n\t\t}\n\n\t\tif (this.isReadAllowed(publication, eventName, args) !== true) {\n\t\t\tpublication.stop();\n\t\t\tthrow new Meteor.Error('not-allowed');\n\t\t}\n\n\t\tconst subscription = {\n\t\t\tsubscription: publication,\n\t\t\teventName: eventName\n\t\t};\n\n\t\tthis.addSubscription(subscription, eventName);\n\n\t\tpublication.onStop(() => {\n\t\t\tthis.removeSubscription(subscription, eventName);\n\t\t});\n\n\t\tif (useCollection === true) {\n\t\t\t// Collection compatibility\n\t\t\tpublication._session.sendAdded(this.subscriptionName, 'id', {\n\t\t\t\teventName: eventName\n\t\t\t});\n\t\t}\n\n\t\tpublication.ready();\n\t}\n\n\tiniPublication() {\n\t\tconst stream = this;\n\t\tMeteor.publish(this.subscriptionName, function (...args) { return stream._publish.apply(stream, [this, ...args]); });\n\t}\n\n\tinitMethod() {\n\t\tconst stream = this;\n\t\tconst method = {};\n\n\t\tmethod[this.subscriptionName] = function(eventName, ...args) {\n\t\t\tcheck(eventName, String);\n\t\t\tcheck(args, Array);\n\n\t\t\tthis.unblock();\n\n\t\t\tif (stream.isWriteAllowed(this, eventName, args) !== true) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconst methodScope = {\n\t\t\t\tuserId: this.userId,\n\t\t\t\tconnection: this.connection,\n\t\t\t\toriginalParams: args,\n\t\t\t\ttranformed: false\n\t\t\t};\n\n\t\t\targs = stream.applyTransformers(methodScope, eventName, args);\n\n\t\t\tstream.emitWithScope(eventName, methodScope, ...args);\n\n\t\t\tif (stream.retransmit === true) {\n\t\t\t\tstream._emit(eventName, args, this.connection, true);\n\t\t\t}\n\t\t};\n\n\t\ttry {\n\t\t\tMeteor.methods(method);\n\t\t} catch (e) {\n\t\t\tconsole.error(e);\n\t\t}\n\t}\n\n\t_emit(eventName, args, origin, broadcast) {\n\t\tif (broadcast === true) {\n\t\t\tMeteor.StreamerCentral.emit('broadcast', this.name, eventName, args);\n\t\t}\n\n\t\tconst subscriptions = this.subscriptionsByEventName[eventName];\n\t\tif (!Array.isArray(subscriptions)) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst msg = changedPayload(this.subscriptionName, 'id', {\n\t\t\teventName,\n\t\t\targs\n\t\t});\n\n\t\tif(!msg) {\n\t\t\treturn;\n\t\t}\n\n\t\tsubscriptions.forEach((subscription) => {\n\t\t\tif (this.retransmitToSelf === false && origin && origin === subscription.subscription.connection) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tif (this.isEmitAllowed(subscription.subscription, eventName, ...args)) {\n\t\t\t\tsend(subscription.subscription._session, msg);\n\t\t\t}\n\t\t});\n\t}\n\n\temit(eventName, ...args) {\n\t\tthis._emit(eventName, args, undefined, true);\n\t}\n\n\t__emit(...args) {\n\t\treturn super.emit(...args);\n\t}\n\n\temitWithoutBroadcast(eventName, ...args) {\n\t\tthis._emit(eventName, args, undefined, false);\n\t}\n};\n"]}}]