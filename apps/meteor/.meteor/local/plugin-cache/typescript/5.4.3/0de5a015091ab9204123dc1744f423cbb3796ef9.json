{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/app/lib/server/functions/checkUrlForSsrf.ts","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","topLevelAwait","objectRestSpread","objectRestSpread","asyncGenerators","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"os.osx.arm64"},"sourceFileName":"app/lib/server/functions/checkUrlForSsrf.ts","filename":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/app/lib/server/functions/checkUrlForSsrf.ts","inputSourceMap":{"version":3,"file":"app/lib/server/functions/checkUrlForSsrf.ts","sourceRoot":"","sources":["app/lib/server/functions/checkUrlForSsrf.ts"],"names":[],"mappings":"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","sourcesContent":["import { lookup } from 'dns';\n\n// https://en.wikipedia.org/wiki/Reserved_IP_addresses + Alibaba Metadata IP\nconst ranges: string[] = [\n\t'0.0.0.0/8',\n\t'10.0.0.0/8',\n\t'100.64.0.0/10',\n\t'127.0.0.0/8',\n\t'169.254.0.0/16',\n\t'172.16.0.0/12',\n\t'192.0.0.0/24',\n\t'192.0.2.0/24',\n\t'192.88.99.0/24',\n\t'192.168.0.0/16',\n\t'198.18.0.0/15',\n\t'198.51.100.0/24',\n\t'203.0.113.0/24',\n\t'224.0.0.0/4',\n\t'240.0.0.0/4',\n\t'255.255.255.255',\n\t'100.100.100.200/32',\n];\n\nexport const nslookup = async (hostname: string): Promise<string> => {\n\treturn new Promise((resolve, reject) => {\n\t\tlookup(hostname, (error, address) => {\n\t\t\tif (error) {\n\t\t\t\treject(error);\n\t\t\t} else {\n\t\t\t\tresolve(address);\n\t\t\t}\n\t\t});\n\t});\n};\n\nexport const ipToLong = (ip: string): number => {\n\treturn ip.split('.').reduce((acc, octet) => (acc << 8) + parseInt(octet, 10), 0) >>> 0;\n};\n\nexport const isIpInRange = (ip: string, range: string): boolean => {\n\tconst [rangeIp, subnet] = range.split('/');\n\tconst ipLong = ipToLong(ip);\n\tconst rangeIpLong = ipToLong(rangeIp);\n\tconst mask = ~(2 ** (32 - Number(subnet)) - 1);\n\treturn (ipLong & mask) === (rangeIpLong & mask);\n};\n\nexport const isIpInAnyRange = (ip: string): boolean => ranges.some((range) => isIpInRange(ip, range));\n\nexport const isValidIPv4 = (ip: string): boolean => {\n\tconst octets = ip.split('.');\n\tif (octets.length !== 4) return false;\n\treturn octets.every((octet) => {\n\t\tconst num = Number(octet);\n\t\treturn num >= 0 && num <= 255 && octet === num.toString();\n\t});\n};\n\nexport const isValidDomain = (domain: string): boolean => {\n\tconst domainPattern = /^(?!-)(?!.*--)[A-Za-z0-9-]{1,63}(?<!-)\\.?([A-Za-z0-9-]{2,63}\\.?)*[A-Za-z]{2,63}$/;\n\tif (!domainPattern.test(domain)) {\n\t\treturn false;\n\t}\n\treturn true;\n};\n\nexport const checkUrlForSsrf = async (url: string): Promise<boolean> => {\n\tif (!(url.startsWith('http://') || url.startsWith('https://'))) {\n\t\treturn false;\n\t}\n\n\tconst [, address] = url.split('://');\n\tconst ipOrDomain = address.includes('/') ? address.split('/')[0] : address;\n\n\tif (!(isValidIPv4(ipOrDomain) || isValidDomain(ipOrDomain))) {\n\t\treturn false;\n\t}\n\n\tif (isValidIPv4(ipOrDomain) && isIpInAnyRange(ipOrDomain)) {\n\t\treturn false;\n\t}\n\n\tif (isValidDomain(ipOrDomain) && /metadata.google.internal/.test(ipOrDomain.toLowerCase())) {\n\t\treturn false;\n\t}\n\n\tif (isValidDomain(ipOrDomain)) {\n\t\ttry {\n\t\t\tconst ipAddress = await nslookup(ipOrDomain);\n\t\t\tif (isIpInAnyRange(ipAddress)) {\n\t\t\t\treturn false;\n\t\t\t}\n\t\t} catch (error) {\n\t\t\tconsole.log(error);\n\t\t\treturn false;\n\t\t}\n\t}\n\n\treturn true;\n};\n"]},"targets":{"android":"125.0.0","chrome":"125.0.0","edge":"125.0.0","firefox":"115.0.0","ie":"10.0.0","ios":"17.4.0","opera":"110.0.0","opera_mobile":"80.0.0","safari":"17.4.0","samsung":"24.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor","root":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":false,"enforceStrictMode":false,"dynamicImport":true,"generateLetDeclarations":true,"topLevelAwait":true},"externalDependencies":[]},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"version":"7.17.2","helpers":true,"useESModules":false,"corejs":false},"externalDependencies":[]},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-async-generator-functions","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-class-properties","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true},"externalDependencies":[]},{"key":"transform-react-jsx","visitor":{"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXFragment":{"exit":[null]},"JSXElement":{"exit":[null]},"JSXAttribute":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false},"externalDependencies":[]},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-nullish-coalescing-operator","visitor":{"LogicalExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-optional-chaining","visitor":{"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-optional-catch-binding","visitor":{"CatchClause":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-class-properties","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-async-generator-functions","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-logical-assignment-operators","visitor":{"AssignmentExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]}],"presets":[],"generatorOpts":{"filename":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/app/lib/server/functions/checkUrlForSsrf.ts","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"app/lib/server/functions/checkUrlForSsrf.ts","inputSourceMap":{"version":3,"file":"app/lib/server/functions/checkUrlForSsrf.ts","sourceRoot":"","sources":["app/lib/server/functions/checkUrlForSsrf.ts"],"names":[],"mappings":"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","sourcesContent":["import { lookup } from 'dns';\n\n// https://en.wikipedia.org/wiki/Reserved_IP_addresses + Alibaba Metadata IP\nconst ranges: string[] = [\n\t'0.0.0.0/8',\n\t'10.0.0.0/8',\n\t'100.64.0.0/10',\n\t'127.0.0.0/8',\n\t'169.254.0.0/16',\n\t'172.16.0.0/12',\n\t'192.0.0.0/24',\n\t'192.0.2.0/24',\n\t'192.88.99.0/24',\n\t'192.168.0.0/16',\n\t'198.18.0.0/15',\n\t'198.51.100.0/24',\n\t'203.0.113.0/24',\n\t'224.0.0.0/4',\n\t'240.0.0.0/4',\n\t'255.255.255.255',\n\t'100.100.100.200/32',\n];\n\nexport const nslookup = async (hostname: string): Promise<string> => {\n\treturn new Promise((resolve, reject) => {\n\t\tlookup(hostname, (error, address) => {\n\t\t\tif (error) {\n\t\t\t\treject(error);\n\t\t\t} else {\n\t\t\t\tresolve(address);\n\t\t\t}\n\t\t});\n\t});\n};\n\nexport const ipToLong = (ip: string): number => {\n\treturn ip.split('.').reduce((acc, octet) => (acc << 8) + parseInt(octet, 10), 0) >>> 0;\n};\n\nexport const isIpInRange = (ip: string, range: string): boolean => {\n\tconst [rangeIp, subnet] = range.split('/');\n\tconst ipLong = ipToLong(ip);\n\tconst rangeIpLong = ipToLong(rangeIp);\n\tconst mask = ~(2 ** (32 - Number(subnet)) - 1);\n\treturn (ipLong & mask) === (rangeIpLong & mask);\n};\n\nexport const isIpInAnyRange = (ip: string): boolean => ranges.some((range) => isIpInRange(ip, range));\n\nexport const isValidIPv4 = (ip: string): boolean => {\n\tconst octets = ip.split('.');\n\tif (octets.length !== 4) return false;\n\treturn octets.every((octet) => {\n\t\tconst num = Number(octet);\n\t\treturn num >= 0 && num <= 255 && octet === num.toString();\n\t});\n};\n\nexport const isValidDomain = (domain: string): boolean => {\n\tconst domainPattern = /^(?!-)(?!.*--)[A-Za-z0-9-]{1,63}(?<!-)\\.?([A-Za-z0-9-]{2,63}\\.?)*[A-Za-z]{2,63}$/;\n\tif (!domainPattern.test(domain)) {\n\t\treturn false;\n\t}\n\treturn true;\n};\n\nexport const checkUrlForSsrf = async (url: string): Promise<boolean> => {\n\tif (!(url.startsWith('http://') || url.startsWith('https://'))) {\n\t\treturn false;\n\t}\n\n\tconst [, address] = url.split('://');\n\tconst ipOrDomain = address.includes('/') ? address.split('/')[0] : address;\n\n\tif (!(isValidIPv4(ipOrDomain) || isValidDomain(ipOrDomain))) {\n\t\treturn false;\n\t}\n\n\tif (isValidIPv4(ipOrDomain) && isIpInAnyRange(ipOrDomain)) {\n\t\treturn false;\n\t}\n\n\tif (isValidDomain(ipOrDomain) && /metadata.google.internal/.test(ipOrDomain.toLowerCase())) {\n\t\treturn false;\n\t}\n\n\tif (isValidDomain(ipOrDomain)) {\n\t\ttry {\n\t\t\tconst ipAddress = await nslookup(ipOrDomain);\n\t\t\tif (isIpInAnyRange(ipAddress)) {\n\t\t\t\treturn false;\n\t\t\t}\n\t\t} catch (error) {\n\t\t\tconsole.log(error);\n\t\t\treturn false;\n\t\t}\n\t}\n\n\treturn true;\n};\n"]}}},"code":"!module.wrapAsync(async function (module, __reifyWaitForDeps__, __reify_async_result__) {\n  \"use strict\";\n  try {\n    module.export({\n      nslookup: () => nslookup,\n      ipToLong: () => ipToLong,\n      isIpInRange: () => isIpInRange,\n      isIpInAnyRange: () => isIpInAnyRange,\n      isValidIPv4: () => isValidIPv4,\n      isValidDomain: () => isValidDomain,\n      checkUrlForSsrf: () => checkUrlForSsrf\n    });\n    let lookup;\n    module.link(\"dns\", {\n      lookup(v) {\n        lookup = v;\n      }\n    }, 0);\n    if (__reifyWaitForDeps__()) (await __reifyWaitForDeps__())();\n    // https://en.wikipedia.org/wiki/Reserved_IP_addresses + Alibaba Metadata IP\n    const ranges = ['0.0.0.0/8', '10.0.0.0/8', '100.64.0.0/10', '127.0.0.0/8', '169.254.0.0/16', '172.16.0.0/12', '192.0.0.0/24', '192.0.2.0/24', '192.88.99.0/24', '192.168.0.0/16', '198.18.0.0/15', '198.51.100.0/24', '203.0.113.0/24', '224.0.0.0/4', '240.0.0.0/4', '255.255.255.255', '100.100.100.200/32'];\n    const nslookup = async hostname => {\n      return new Promise((resolve, reject) => {\n        lookup(hostname, (error, address) => {\n          if (error) {\n            reject(error);\n          } else {\n            resolve(address);\n          }\n        });\n      });\n    };\n    const ipToLong = ip => {\n      return ip.split('.').reduce((acc, octet) => (acc << 8) + parseInt(octet, 10), 0) >>> 0;\n    };\n    const isIpInRange = (ip, range) => {\n      const [rangeIp, subnet] = range.split('/');\n      const ipLong = ipToLong(ip);\n      const rangeIpLong = ipToLong(rangeIp);\n      const mask = ~(Math.pow(2, 32 - Number(subnet)) - 1);\n      return (ipLong & mask) === (rangeIpLong & mask);\n    };\n    const isIpInAnyRange = ip => ranges.some(range => isIpInRange(ip, range));\n    const isValidIPv4 = ip => {\n      const octets = ip.split('.');\n      if (octets.length !== 4) return false;\n      return octets.every(octet => {\n        const num = Number(octet);\n        return num >= 0 && num <= 255 && octet === num.toString();\n      });\n    };\n    const isValidDomain = domain => {\n      const domainPattern = /^(?!-)(?!.*--)[A-Za-z0-9-]{1,63}(?<!-)\\.?([A-Za-z0-9-]{2,63}\\.?)*[A-Za-z]{2,63}$/;\n      if (!domainPattern.test(domain)) {\n        return false;\n      }\n      return true;\n    };\n    const checkUrlForSsrf = async url => {\n      if (!(url.startsWith('http://') || url.startsWith('https://'))) {\n        return false;\n      }\n      const [, address] = url.split('://');\n      const ipOrDomain = address.includes('/') ? address.split('/')[0] : address;\n      if (!(isValidIPv4(ipOrDomain) || isValidDomain(ipOrDomain))) {\n        return false;\n      }\n      if (isValidIPv4(ipOrDomain) && isIpInAnyRange(ipOrDomain)) {\n        return false;\n      }\n      if (isValidDomain(ipOrDomain) && /metadata.google.internal/.test(ipOrDomain.toLowerCase())) {\n        return false;\n      }\n      if (isValidDomain(ipOrDomain)) {\n        try {\n          const ipAddress = await nslookup(ipOrDomain);\n          if (isIpInAnyRange(ipAddress)) {\n            return false;\n          }\n        } catch (error) {\n          console.log(error);\n          return false;\n        }\n      }\n      return true;\n    };\n    __reify_async_result__();\n  } catch (_reifyError) {\n    return __reify_async_result__(_reifyError);\n  }\n  __reify_async_result__()\n}, {\n  self: this,\n  async: false\n});","map":{"version":3,"names":["module","export","nslookup","ipToLong","isIpInRange","isIpInAnyRange","isValidIPv4","isValidDomain","checkUrlForSsrf","lookup","link","v","__reifyWaitForDeps__","ranges","hostname","Promise","resolve","reject","error","address","ip","split","reduce","acc","octet","parseInt","range","rangeIp","subnet","ipLong","rangeIpLong","mask","Math","pow","Number","some","octets","length","every","num","toString","domain","domainPattern","test","url","startsWith","ipOrDomain","includes","toLowerCase","ipAddress","console","log","__reify_async_result__","_reifyError","self","async"],"sources":["app/lib/server/functions/checkUrlForSsrf.ts"],"sourcesContent":["import { lookup } from 'dns';\n\n// https://en.wikipedia.org/wiki/Reserved_IP_addresses + Alibaba Metadata IP\nconst ranges: string[] = [\n\t'0.0.0.0/8',\n\t'10.0.0.0/8',\n\t'100.64.0.0/10',\n\t'127.0.0.0/8',\n\t'169.254.0.0/16',\n\t'172.16.0.0/12',\n\t'192.0.0.0/24',\n\t'192.0.2.0/24',\n\t'192.88.99.0/24',\n\t'192.168.0.0/16',\n\t'198.18.0.0/15',\n\t'198.51.100.0/24',\n\t'203.0.113.0/24',\n\t'224.0.0.0/4',\n\t'240.0.0.0/4',\n\t'255.255.255.255',\n\t'100.100.100.200/32',\n];\n\nexport const nslookup = async (hostname: string): Promise<string> => {\n\treturn new Promise((resolve, reject) => {\n\t\tlookup(hostname, (error, address) => {\n\t\t\tif (error) {\n\t\t\t\treject(error);\n\t\t\t} else {\n\t\t\t\tresolve(address);\n\t\t\t}\n\t\t});\n\t});\n};\n\nexport const ipToLong = (ip: string): number => {\n\treturn ip.split('.').reduce((acc, octet) => (acc << 8) + parseInt(octet, 10), 0) >>> 0;\n};\n\nexport const isIpInRange = (ip: string, range: string): boolean => {\n\tconst [rangeIp, subnet] = range.split('/');\n\tconst ipLong = ipToLong(ip);\n\tconst rangeIpLong = ipToLong(rangeIp);\n\tconst mask = ~(2 ** (32 - Number(subnet)) - 1);\n\treturn (ipLong & mask) === (rangeIpLong & mask);\n};\n\nexport const isIpInAnyRange = (ip: string): boolean => ranges.some((range) => isIpInRange(ip, range));\n\nexport const isValidIPv4 = (ip: string): boolean => {\n\tconst octets = ip.split('.');\n\tif (octets.length !== 4) return false;\n\treturn octets.every((octet) => {\n\t\tconst num = Number(octet);\n\t\treturn num >= 0 && num <= 255 && octet === num.toString();\n\t});\n};\n\nexport const isValidDomain = (domain: string): boolean => {\n\tconst domainPattern = /^(?!-)(?!.*--)[A-Za-z0-9-]{1,63}(?<!-)\\.?([A-Za-z0-9-]{2,63}\\.?)*[A-Za-z]{2,63}$/;\n\tif (!domainPattern.test(domain)) {\n\t\treturn false;\n\t}\n\treturn true;\n};\n\nexport const checkUrlForSsrf = async (url: string): Promise<boolean> => {\n\tif (!(url.startsWith('http://') || url.startsWith('https://'))) {\n\t\treturn false;\n\t}\n\n\tconst [, address] = url.split('://');\n\tconst ipOrDomain = address.includes('/') ? address.split('/')[0] : address;\n\n\tif (!(isValidIPv4(ipOrDomain) || isValidDomain(ipOrDomain))) {\n\t\treturn false;\n\t}\n\n\tif (isValidIPv4(ipOrDomain) && isIpInAnyRange(ipOrDomain)) {\n\t\treturn false;\n\t}\n\n\tif (isValidDomain(ipOrDomain) && /metadata.google.internal/.test(ipOrDomain.toLowerCase())) {\n\t\treturn false;\n\t}\n\n\tif (isValidDomain(ipOrDomain)) {\n\t\ttry {\n\t\t\tconst ipAddress = await nslookup(ipOrDomain);\n\t\t\tif (isIpInAnyRange(ipAddress)) {\n\t\t\t\treturn false;\n\t\t\t}\n\t\t} catch (error) {\n\t\t\tconsole.log(error);\n\t\t\treturn false;\n\t\t}\n\t}\n\n\treturn true;\n};\n"],"mappings":"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","ignoreList":[]},"sourceType":"module","externalDependencies":{},"hash":"0de5a015091ab9204123dc1744f423cbb3796ef9"}
