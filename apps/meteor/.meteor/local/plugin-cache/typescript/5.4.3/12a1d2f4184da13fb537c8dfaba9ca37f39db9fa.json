{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/app/metrics/server/lib/collectMetrics.ts","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","topLevelAwait","objectRestSpread","objectRestSpread","asyncGenerators","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"os.osx.arm64"},"sourceFileName":"app/metrics/server/lib/collectMetrics.ts","filename":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/app/metrics/server/lib/collectMetrics.ts","inputSourceMap":{"version":3,"file":"app/metrics/server/lib/collectMetrics.ts","sourceRoot":"","sources":["app/metrics/server/lib/collectMetrics.ts"],"names":[],"mappings":"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","sourcesContent":["import http from 'http';\n\nimport { Statistics } from '@rocket.chat/models';\nimport connect from 'connect';\nimport { Facts } from 'meteor/facts-base';\nimport { Meteor } from 'meteor/meteor';\nimport { MongoInternals } from 'meteor/mongo';\nimport client from 'prom-client';\nimport gcStats from 'prometheus-gc-stats';\nimport _ from 'underscore';\n\nimport { SystemLogger } from '../../../../server/lib/logger/system';\nimport { getControl } from '../../../../server/lib/migrations';\nimport { settings } from '../../../settings/server';\nimport { getAppsStatistics } from '../../../statistics/server/lib/getAppsStatistics';\nimport { Info } from '../../../utils/rocketchat.info';\nimport { metrics } from './metrics';\n\nconst { mongo } = MongoInternals.defaultRemoteCollectionDriver();\n\nFacts.incrementServerFact = function (pkg: 'pkg' | 'fact', fact: string | number, increment: number): void {\n\tmetrics.meteorFacts.inc({ pkg, fact }, increment);\n};\n\nconst setPrometheusData = async (): Promise<void> => {\n\tmetrics.info.set(\n\t\t{\n\t\t\tversion: Info.version,\n\t\t\tunique_id: settings.get<string>('uniqueID'),\n\t\t\tsite_url: settings.get<string>('Site_Url'),\n\t\t},\n\t\t1,\n\t);\n\n\tconst sessions = Array.from<{ userId: string }>(Meteor.server.sessions.values());\n\tconst authenticatedSessions = sessions.filter((s) => s.userId);\n\tmetrics.ddpSessions.set(Meteor.server.sessions.size);\n\tmetrics.ddpAuthenticatedSessions.set(authenticatedSessions.length);\n\tmetrics.ddpConnectedUsers.set(_.unique(authenticatedSessions.map((s) => s.userId)).length);\n\n\t// Apps metrics\n\tconst { totalInstalled, totalActive, totalFailed } = await getAppsStatistics();\n\n\tmetrics.totalAppsInstalled.set(totalInstalled || 0);\n\tmetrics.totalAppsEnabled.set(totalActive || 0);\n\tmetrics.totalAppsFailed.set(totalFailed || 0);\n\n\tconst oplogQueue = (mongo as any)._oplogHandle?._entryQueue?.length || 0;\n\tmetrics.oplogQueue.set(oplogQueue);\n\n\tconst statistics = await Statistics.findLast();\n\tif (!statistics) {\n\t\treturn;\n\t}\n\n\tmetrics.version.set({ version: statistics.version }, 1);\n\tmetrics.migration.set((await getControl()).version);\n\tmetrics.instanceCount.set(statistics.instanceCount);\n\tmetrics.oplogEnabled.set({ enabled: `${statistics.oplogEnabled}` }, 1);\n\n\t// User statistics\n\tmetrics.totalUsers.set(statistics.totalUsers);\n\tmetrics.activeUsers.set(statistics.activeUsers);\n\tmetrics.nonActiveUsers.set(statistics.nonActiveUsers);\n\tmetrics.onlineUsers.set(statistics.onlineUsers);\n\tmetrics.awayUsers.set(statistics.awayUsers);\n\tmetrics.offlineUsers.set(statistics.offlineUsers);\n\n\t// Room statistics\n\tmetrics.totalRooms.set(statistics.totalRooms);\n\tmetrics.totalChannels.set(statistics.totalChannels);\n\tmetrics.totalPrivateGroups.set(statistics.totalPrivateGroups);\n\tmetrics.totalDirect.set(statistics.totalDirect);\n\tmetrics.totalLivechat.set(statistics.totalLivechat);\n\n\t// Message statistics\n\tmetrics.totalMessages.set(statistics.totalMessages);\n\tmetrics.totalChannelMessages.set(statistics.totalChannelMessages);\n\tmetrics.totalPrivateGroupMessages.set(statistics.totalPrivateGroupMessages);\n\tmetrics.totalDirectMessages.set(statistics.totalDirectMessages);\n\tmetrics.totalLivechatMessages.set(statistics.totalLivechatMessages);\n\n\t// Livechat stats\n\tmetrics.totalLivechatVisitors.set(statistics.totalLivechatVisitors);\n\tmetrics.totalLivechatAgents.set(statistics.totalLivechatAgents);\n\n\tmetrics.pushQueue.set(statistics.pushQueue || 0);\n};\n\nconst app = connect();\n\n// const compression = require('compression');\n// app.use(compression());\n\napp.use('/metrics', (_req, res) => {\n\tres.setHeader('Content-Type', 'text/plain');\n\tclient.register\n\t\t.metrics()\n\t\t.then((data) => {\n\t\t\tmetrics.metricsRequests.inc();\n\t\t\tmetrics.metricsSize.set(data.length);\n\n\t\t\tres.end(data);\n\t\t})\n\t\t.catch((err) => {\n\t\t\tSystemLogger.error({ msg: 'Error while collecting metrics', err });\n\t\t\tres.end();\n\t\t});\n});\n\napp.use('/', (_req, res) => {\n\tconst html = `<html>\n\t\t<head>\n\t\t\t<title>Rocket.Chat Prometheus Exporter</title>\n\t\t</head>\n\t\t<body>\n\t\t\t<h1>Rocket.Chat Prometheus Exporter</h1>\n\t\t\t<p><a href=\"/metrics\">Metrics</a></p>\n\t\t</body>\n\t</html>`;\n\n\tres.write(html);\n\tres.end();\n});\n\nconst server = http.createServer(app);\n\nlet timer: NodeJS.Timeout;\nlet resetTimer: NodeJS.Timeout;\nlet defaultMetricsInitiated = false;\nlet gcStatsInitiated = false;\nconst was = {\n\tenabled: false,\n\tport: 9458,\n\tresetInterval: 0,\n\tcollectGC: false,\n};\nconst updatePrometheusConfig = async (): Promise<void> => {\n\tconst is = {\n\t\tport: process.env.PROMETHEUS_PORT || settings.get('Prometheus_Port'),\n\t\tenabled: settings.get<boolean>('Prometheus_Enabled'),\n\t\tresetInterval: settings.get<number>('Prometheus_Reset_Interval'),\n\t\tcollectGC: settings.get<boolean>('Prometheus_Garbage_Collector'),\n\t};\n\n\tif (Object.values(is).some((s) => s == null)) {\n\t\treturn;\n\t}\n\n\tif (Object.entries(is).every(([k, v]) => v === was[k as keyof typeof was])) {\n\t\treturn;\n\t}\n\n\tif (!is.enabled) {\n\t\tif (was.enabled) {\n\t\t\tSystemLogger.info('Disabling Prometheus');\n\t\t\tserver.close();\n\t\t\tclearInterval(timer);\n\t\t}\n\t\tObject.assign(was, is);\n\t\treturn;\n\t}\n\n\tSystemLogger.debug({ msg: 'Configuring Prometheus', is });\n\n\tif (!was.enabled) {\n\t\tserver.listen({\n\t\t\tport: is.port,\n\t\t\thost: process.env.BIND_IP || '0.0.0.0',\n\t\t});\n\n\t\ttimer = setInterval(setPrometheusData, 5000);\n\t}\n\n\tclearInterval(resetTimer);\n\tif (is.resetInterval) {\n\t\tresetTimer = setInterval(() => {\n\t\t\tclient.register.getMetricsAsArray().forEach((metric) => {\n\t\t\t\t// @ts-expect-error Property 'hashMap' does not exist on type 'metric'.\n\t\t\t\tmetric.hashMap = {};\n\t\t\t});\n\t\t}, is.resetInterval);\n\t}\n\n\t// Prevent exceptions on calling those methods twice since\n\t// it's not possible to stop them to be able to restart\n\ttry {\n\t\tif (defaultMetricsInitiated === false) {\n\t\t\tdefaultMetricsInitiated = true;\n\t\t\tclient.collectDefaultMetrics();\n\t\t}\n\t\tif (is.collectGC && gcStatsInitiated === false) {\n\t\t\tgcStatsInitiated = true;\n\t\t\tgcStats(client.register)();\n\t\t}\n\t} catch (error) {\n\t\tSystemLogger.error(error);\n\t}\n\n\tObject.assign(was, is);\n};\n\nMeteor.startup(async () => {\n\tsettings.watchByRegex(/^Prometheus_.+/, updatePrometheusConfig);\n});\n"]},"targets":{"android":"125.0.0","chrome":"125.0.0","edge":"125.0.0","firefox":"115.0.0","ie":"10.0.0","ios":"17.4.0","opera":"110.0.0","opera_mobile":"80.0.0","safari":"17.4.0","samsung":"24.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor","root":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":false,"enforceStrictMode":false,"dynamicImport":true,"generateLetDeclarations":true,"topLevelAwait":true},"externalDependencies":[]},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"version":"7.17.2","helpers":true,"useESModules":false,"corejs":false},"externalDependencies":[]},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-async-generator-functions","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-class-properties","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true},"externalDependencies":[]},{"key":"transform-react-jsx","visitor":{"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXFragment":{"exit":[null]},"JSXElement":{"exit":[null]},"JSXAttribute":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false},"externalDependencies":[]},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-nullish-coalescing-operator","visitor":{"LogicalExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-optional-chaining","visitor":{"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-optional-catch-binding","visitor":{"CatchClause":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-class-properties","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-async-generator-functions","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-logical-assignment-operators","visitor":{"AssignmentExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]}],"presets":[],"generatorOpts":{"filename":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/app/metrics/server/lib/collectMetrics.ts","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"app/metrics/server/lib/collectMetrics.ts","inputSourceMap":{"version":3,"file":"app/metrics/server/lib/collectMetrics.ts","sourceRoot":"","sources":["app/metrics/server/lib/collectMetrics.ts"],"names":[],"mappings":"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","sourcesContent":["import http from 'http';\n\nimport { Statistics } from '@rocket.chat/models';\nimport connect from 'connect';\nimport { Facts } from 'meteor/facts-base';\nimport { Meteor } from 'meteor/meteor';\nimport { MongoInternals } from 'meteor/mongo';\nimport client from 'prom-client';\nimport gcStats from 'prometheus-gc-stats';\nimport _ from 'underscore';\n\nimport { SystemLogger } from '../../../../server/lib/logger/system';\nimport { getControl } from '../../../../server/lib/migrations';\nimport { settings } from '../../../settings/server';\nimport { getAppsStatistics } from '../../../statistics/server/lib/getAppsStatistics';\nimport { Info } from '../../../utils/rocketchat.info';\nimport { metrics } from './metrics';\n\nconst { mongo } = MongoInternals.defaultRemoteCollectionDriver();\n\nFacts.incrementServerFact = function (pkg: 'pkg' | 'fact', fact: string | number, increment: number): void {\n\tmetrics.meteorFacts.inc({ pkg, fact }, increment);\n};\n\nconst setPrometheusData = async (): Promise<void> => {\n\tmetrics.info.set(\n\t\t{\n\t\t\tversion: Info.version,\n\t\t\tunique_id: settings.get<string>('uniqueID'),\n\t\t\tsite_url: settings.get<string>('Site_Url'),\n\t\t},\n\t\t1,\n\t);\n\n\tconst sessions = Array.from<{ userId: string }>(Meteor.server.sessions.values());\n\tconst authenticatedSessions = sessions.filter((s) => s.userId);\n\tmetrics.ddpSessions.set(Meteor.server.sessions.size);\n\tmetrics.ddpAuthenticatedSessions.set(authenticatedSessions.length);\n\tmetrics.ddpConnectedUsers.set(_.unique(authenticatedSessions.map((s) => s.userId)).length);\n\n\t// Apps metrics\n\tconst { totalInstalled, totalActive, totalFailed } = await getAppsStatistics();\n\n\tmetrics.totalAppsInstalled.set(totalInstalled || 0);\n\tmetrics.totalAppsEnabled.set(totalActive || 0);\n\tmetrics.totalAppsFailed.set(totalFailed || 0);\n\n\tconst oplogQueue = (mongo as any)._oplogHandle?._entryQueue?.length || 0;\n\tmetrics.oplogQueue.set(oplogQueue);\n\n\tconst statistics = await Statistics.findLast();\n\tif (!statistics) {\n\t\treturn;\n\t}\n\n\tmetrics.version.set({ version: statistics.version }, 1);\n\tmetrics.migration.set((await getControl()).version);\n\tmetrics.instanceCount.set(statistics.instanceCount);\n\tmetrics.oplogEnabled.set({ enabled: `${statistics.oplogEnabled}` }, 1);\n\n\t// User statistics\n\tmetrics.totalUsers.set(statistics.totalUsers);\n\tmetrics.activeUsers.set(statistics.activeUsers);\n\tmetrics.nonActiveUsers.set(statistics.nonActiveUsers);\n\tmetrics.onlineUsers.set(statistics.onlineUsers);\n\tmetrics.awayUsers.set(statistics.awayUsers);\n\tmetrics.offlineUsers.set(statistics.offlineUsers);\n\n\t// Room statistics\n\tmetrics.totalRooms.set(statistics.totalRooms);\n\tmetrics.totalChannels.set(statistics.totalChannels);\n\tmetrics.totalPrivateGroups.set(statistics.totalPrivateGroups);\n\tmetrics.totalDirect.set(statistics.totalDirect);\n\tmetrics.totalLivechat.set(statistics.totalLivechat);\n\n\t// Message statistics\n\tmetrics.totalMessages.set(statistics.totalMessages);\n\tmetrics.totalChannelMessages.set(statistics.totalChannelMessages);\n\tmetrics.totalPrivateGroupMessages.set(statistics.totalPrivateGroupMessages);\n\tmetrics.totalDirectMessages.set(statistics.totalDirectMessages);\n\tmetrics.totalLivechatMessages.set(statistics.totalLivechatMessages);\n\n\t// Livechat stats\n\tmetrics.totalLivechatVisitors.set(statistics.totalLivechatVisitors);\n\tmetrics.totalLivechatAgents.set(statistics.totalLivechatAgents);\n\n\tmetrics.pushQueue.set(statistics.pushQueue || 0);\n};\n\nconst app = connect();\n\n// const compression = require('compression');\n// app.use(compression());\n\napp.use('/metrics', (_req, res) => {\n\tres.setHeader('Content-Type', 'text/plain');\n\tclient.register\n\t\t.metrics()\n\t\t.then((data) => {\n\t\t\tmetrics.metricsRequests.inc();\n\t\t\tmetrics.metricsSize.set(data.length);\n\n\t\t\tres.end(data);\n\t\t})\n\t\t.catch((err) => {\n\t\t\tSystemLogger.error({ msg: 'Error while collecting metrics', err });\n\t\t\tres.end();\n\t\t});\n});\n\napp.use('/', (_req, res) => {\n\tconst html = `<html>\n\t\t<head>\n\t\t\t<title>Rocket.Chat Prometheus Exporter</title>\n\t\t</head>\n\t\t<body>\n\t\t\t<h1>Rocket.Chat Prometheus Exporter</h1>\n\t\t\t<p><a href=\"/metrics\">Metrics</a></p>\n\t\t</body>\n\t</html>`;\n\n\tres.write(html);\n\tres.end();\n});\n\nconst server = http.createServer(app);\n\nlet timer: NodeJS.Timeout;\nlet resetTimer: NodeJS.Timeout;\nlet defaultMetricsInitiated = false;\nlet gcStatsInitiated = false;\nconst was = {\n\tenabled: false,\n\tport: 9458,\n\tresetInterval: 0,\n\tcollectGC: false,\n};\nconst updatePrometheusConfig = async (): Promise<void> => {\n\tconst is = {\n\t\tport: process.env.PROMETHEUS_PORT || settings.get('Prometheus_Port'),\n\t\tenabled: settings.get<boolean>('Prometheus_Enabled'),\n\t\tresetInterval: settings.get<number>('Prometheus_Reset_Interval'),\n\t\tcollectGC: settings.get<boolean>('Prometheus_Garbage_Collector'),\n\t};\n\n\tif (Object.values(is).some((s) => s == null)) {\n\t\treturn;\n\t}\n\n\tif (Object.entries(is).every(([k, v]) => v === was[k as keyof typeof was])) {\n\t\treturn;\n\t}\n\n\tif (!is.enabled) {\n\t\tif (was.enabled) {\n\t\t\tSystemLogger.info('Disabling Prometheus');\n\t\t\tserver.close();\n\t\t\tclearInterval(timer);\n\t\t}\n\t\tObject.assign(was, is);\n\t\treturn;\n\t}\n\n\tSystemLogger.debug({ msg: 'Configuring Prometheus', is });\n\n\tif (!was.enabled) {\n\t\tserver.listen({\n\t\t\tport: is.port,\n\t\t\thost: process.env.BIND_IP || '0.0.0.0',\n\t\t});\n\n\t\ttimer = setInterval(setPrometheusData, 5000);\n\t}\n\n\tclearInterval(resetTimer);\n\tif (is.resetInterval) {\n\t\tresetTimer = setInterval(() => {\n\t\t\tclient.register.getMetricsAsArray().forEach((metric) => {\n\t\t\t\t// @ts-expect-error Property 'hashMap' does not exist on type 'metric'.\n\t\t\t\tmetric.hashMap = {};\n\t\t\t});\n\t\t}, is.resetInterval);\n\t}\n\n\t// Prevent exceptions on calling those methods twice since\n\t// it's not possible to stop them to be able to restart\n\ttry {\n\t\tif (defaultMetricsInitiated === false) {\n\t\t\tdefaultMetricsInitiated = true;\n\t\t\tclient.collectDefaultMetrics();\n\t\t}\n\t\tif (is.collectGC && gcStatsInitiated === false) {\n\t\t\tgcStatsInitiated = true;\n\t\t\tgcStats(client.register)();\n\t\t}\n\t} catch (error) {\n\t\tSystemLogger.error(error);\n\t}\n\n\tObject.assign(was, is);\n};\n\nMeteor.startup(async () => {\n\tsettings.watchByRegex(/^Prometheus_.+/, updatePrometheusConfig);\n});\n"]}}},"code":"!module.wrapAsync(async function (module, __reifyWaitForDeps__, __reify_async_result__) {\n  \"use strict\";\n  try {\n    let http;\n    module.link(\"http\", {\n      default(v) {\n        http = v;\n      }\n    }, 0);\n    let Statistics;\n    module.link(\"@rocket.chat/models\", {\n      Statistics(v) {\n        Statistics = v;\n      }\n    }, 1);\n    let connect;\n    module.link(\"connect\", {\n      default(v) {\n        connect = v;\n      }\n    }, 2);\n    let Facts;\n    module.link(\"meteor/facts-base\", {\n      Facts(v) {\n        Facts = v;\n      }\n    }, 3);\n    let Meteor;\n    module.link(\"meteor/meteor\", {\n      Meteor(v) {\n        Meteor = v;\n      }\n    }, 4);\n    let MongoInternals;\n    module.link(\"meteor/mongo\", {\n      MongoInternals(v) {\n        MongoInternals = v;\n      }\n    }, 5);\n    let client;\n    module.link(\"prom-client\", {\n      default(v) {\n        client = v;\n      }\n    }, 6);\n    let gcStats;\n    module.link(\"prometheus-gc-stats\", {\n      default(v) {\n        gcStats = v;\n      }\n    }, 7);\n    let _;\n    module.link(\"underscore\", {\n      default(v) {\n        _ = v;\n      }\n    }, 8);\n    let SystemLogger;\n    module.link(\"../../../../server/lib/logger/system\", {\n      SystemLogger(v) {\n        SystemLogger = v;\n      }\n    }, 9);\n    let getControl;\n    module.link(\"../../../../server/lib/migrations\", {\n      getControl(v) {\n        getControl = v;\n      }\n    }, 10);\n    let settings;\n    module.link(\"../../../settings/server\", {\n      settings(v) {\n        settings = v;\n      }\n    }, 11);\n    let getAppsStatistics;\n    module.link(\"../../../statistics/server/lib/getAppsStatistics\", {\n      getAppsStatistics(v) {\n        getAppsStatistics = v;\n      }\n    }, 12);\n    let Info;\n    module.link(\"../../../utils/rocketchat.info\", {\n      Info(v) {\n        Info = v;\n      }\n    }, 13);\n    let metrics;\n    module.link(\"./metrics\", {\n      metrics(v) {\n        metrics = v;\n      }\n    }, 14);\n    if (__reifyWaitForDeps__()) (await __reifyWaitForDeps__())();\n    const {\n      mongo\n    } = MongoInternals.defaultRemoteCollectionDriver();\n    Facts.incrementServerFact = function (pkg, fact, increment) {\n      metrics.meteorFacts.inc({\n        pkg,\n        fact\n      }, increment);\n    };\n    const setPrometheusData = async () => {\n      var _mongo$_oplogHandle, _mongo$_oplogHandle$_;\n      metrics.info.set({\n        version: Info.version,\n        unique_id: settings.get('uniqueID'),\n        site_url: settings.get('Site_Url')\n      }, 1);\n      const sessions = Array.from(Meteor.server.sessions.values());\n      const authenticatedSessions = sessions.filter(s => s.userId);\n      metrics.ddpSessions.set(Meteor.server.sessions.size);\n      metrics.ddpAuthenticatedSessions.set(authenticatedSessions.length);\n      metrics.ddpConnectedUsers.set(_.unique(authenticatedSessions.map(s => s.userId)).length);\n      // Apps metrics\n      const {\n        totalInstalled,\n        totalActive,\n        totalFailed\n      } = await getAppsStatistics();\n      metrics.totalAppsInstalled.set(totalInstalled || 0);\n      metrics.totalAppsEnabled.set(totalActive || 0);\n      metrics.totalAppsFailed.set(totalFailed || 0);\n      const oplogQueue = ((_mongo$_oplogHandle = mongo._oplogHandle) === null || _mongo$_oplogHandle === void 0 ? void 0 : (_mongo$_oplogHandle$_ = _mongo$_oplogHandle._entryQueue) === null || _mongo$_oplogHandle$_ === void 0 ? void 0 : _mongo$_oplogHandle$_.length) || 0;\n      metrics.oplogQueue.set(oplogQueue);\n      const statistics = await Statistics.findLast();\n      if (!statistics) {\n        return;\n      }\n      metrics.version.set({\n        version: statistics.version\n      }, 1);\n      metrics.migration.set((await getControl()).version);\n      metrics.instanceCount.set(statistics.instanceCount);\n      metrics.oplogEnabled.set({\n        enabled: \"\".concat(statistics.oplogEnabled)\n      }, 1);\n      // User statistics\n      metrics.totalUsers.set(statistics.totalUsers);\n      metrics.activeUsers.set(statistics.activeUsers);\n      metrics.nonActiveUsers.set(statistics.nonActiveUsers);\n      metrics.onlineUsers.set(statistics.onlineUsers);\n      metrics.awayUsers.set(statistics.awayUsers);\n      metrics.offlineUsers.set(statistics.offlineUsers);\n      // Room statistics\n      metrics.totalRooms.set(statistics.totalRooms);\n      metrics.totalChannels.set(statistics.totalChannels);\n      metrics.totalPrivateGroups.set(statistics.totalPrivateGroups);\n      metrics.totalDirect.set(statistics.totalDirect);\n      metrics.totalLivechat.set(statistics.totalLivechat);\n      // Message statistics\n      metrics.totalMessages.set(statistics.totalMessages);\n      metrics.totalChannelMessages.set(statistics.totalChannelMessages);\n      metrics.totalPrivateGroupMessages.set(statistics.totalPrivateGroupMessages);\n      metrics.totalDirectMessages.set(statistics.totalDirectMessages);\n      metrics.totalLivechatMessages.set(statistics.totalLivechatMessages);\n      // Livechat stats\n      metrics.totalLivechatVisitors.set(statistics.totalLivechatVisitors);\n      metrics.totalLivechatAgents.set(statistics.totalLivechatAgents);\n      metrics.pushQueue.set(statistics.pushQueue || 0);\n    };\n    const app = connect();\n    // const compression = require('compression');\n    // app.use(compression());\n    app.use('/metrics', (_req, res) => {\n      res.setHeader('Content-Type', 'text/plain');\n      client.register.metrics().then(data => {\n        metrics.metricsRequests.inc();\n        metrics.metricsSize.set(data.length);\n        res.end(data);\n      }).catch(err => {\n        SystemLogger.error({\n          msg: 'Error while collecting metrics',\n          err\n        });\n        res.end();\n      });\n    });\n    app.use('/', (_req, res) => {\n      const html = \"<html>\\n\\t\\t<head>\\n\\t\\t\\t<title>Rocket.Chat Prometheus Exporter</title>\\n\\t\\t</head>\\n\\t\\t<body>\\n\\t\\t\\t<h1>Rocket.Chat Prometheus Exporter</h1>\\n\\t\\t\\t<p><a href=\\\"/metrics\\\">Metrics</a></p>\\n\\t\\t</body>\\n\\t</html>\";\n      res.write(html);\n      res.end();\n    });\n    const server = http.createServer(app);\n    let timer;\n    let resetTimer;\n    let defaultMetricsInitiated = false;\n    let gcStatsInitiated = false;\n    const was = {\n      enabled: false,\n      port: 9458,\n      resetInterval: 0,\n      collectGC: false\n    };\n    const updatePrometheusConfig = async () => {\n      const is = {\n        port: process.env.PROMETHEUS_PORT || settings.get('Prometheus_Port'),\n        enabled: settings.get('Prometheus_Enabled'),\n        resetInterval: settings.get('Prometheus_Reset_Interval'),\n        collectGC: settings.get('Prometheus_Garbage_Collector')\n      };\n      if (Object.values(is).some(s => s == null)) {\n        return;\n      }\n      if (Object.entries(is).every(_ref => {\n        let [k, v] = _ref;\n        return v === was[k];\n      })) {\n        return;\n      }\n      if (!is.enabled) {\n        if (was.enabled) {\n          SystemLogger.info('Disabling Prometheus');\n          server.close();\n          clearInterval(timer);\n        }\n        Object.assign(was, is);\n        return;\n      }\n      SystemLogger.debug({\n        msg: 'Configuring Prometheus',\n        is\n      });\n      if (!was.enabled) {\n        server.listen({\n          port: is.port,\n          host: process.env.BIND_IP || '0.0.0.0'\n        });\n        timer = setInterval(setPrometheusData, 5000);\n      }\n      clearInterval(resetTimer);\n      if (is.resetInterval) {\n        resetTimer = setInterval(() => {\n          client.register.getMetricsAsArray().forEach(metric => {\n            // @ts-expect-error Property 'hashMap' does not exist on type 'metric'.\n            metric.hashMap = {};\n          });\n        }, is.resetInterval);\n      }\n      // Prevent exceptions on calling those methods twice since\n      // it's not possible to stop them to be able to restart\n      try {\n        if (defaultMetricsInitiated === false) {\n          defaultMetricsInitiated = true;\n          client.collectDefaultMetrics();\n        }\n        if (is.collectGC && gcStatsInitiated === false) {\n          gcStatsInitiated = true;\n          gcStats(client.register)();\n        }\n      } catch (error) {\n        SystemLogger.error(error);\n      }\n      Object.assign(was, is);\n    };\n    Meteor.startup(async () => {\n      settings.watchByRegex(/^Prometheus_.+/, updatePrometheusConfig);\n    });\n    __reify_async_result__();\n  } catch (_reifyError) {\n    return __reify_async_result__(_reifyError);\n  }\n  __reify_async_result__()\n}, {\n  self: this,\n  async: false\n});","map":{"version":3,"names":["http","module","link","default","v","Statistics","connect","Facts","Meteor","MongoInternals","client","gcStats","_","SystemLogger","getControl","settings","getAppsStatistics","Info","metrics","__reifyWaitForDeps__","mongo","defaultRemoteCollectionDriver","incrementServerFact","pkg","fact","increment","meteorFacts","inc","setPrometheusData","_mongo$_oplogHandle","_mongo$_oplogHandle$_","info","set","version","unique_id","get","site_url","sessions","Array","from","server","values","authenticatedSessions","filter","s","userId","ddpSessions","size","ddpAuthenticatedSessions","length","ddpConnectedUsers","unique","map","totalInstalled","totalActive","totalFailed","totalAppsInstalled","totalAppsEnabled","totalAppsFailed","oplogQueue","_oplogHandle","_entryQueue","statistics","findLast","migration","instanceCount","oplogEnabled","enabled","concat","totalUsers","activeUsers","nonActiveUsers","onlineUsers","awayUsers","offlineUsers","totalRooms","totalChannels","totalPrivateGroups","totalDirect","totalLivechat","totalMessages","totalChannelMessages","totalPrivateGroupMessages","totalDirectMessages","totalLivechatMessages","totalLivechatVisitors","totalLivechatAgents","pushQueue","app","use","_req","res","setHeader","register","then","data","metricsRequests","metricsSize","end","catch","err","error","msg","html","write","createServer","timer","resetTimer","defaultMetricsInitiated","gcStatsInitiated","was","port","resetInterval","collectGC","updatePrometheusConfig","is","process","env","PROMETHEUS_PORT","Object","some","entries","every","_ref","k","close","clearInterval","assign","debug","listen","host","BIND_IP","setInterval","getMetricsAsArray","forEach","metric","hashMap","collectDefaultMetrics","startup","watchByRegex","__reify_async_result__","_reifyError","self","async"],"sources":["app/metrics/server/lib/collectMetrics.ts"],"sourcesContent":["import http from 'http';\n\nimport { Statistics } from '@rocket.chat/models';\nimport connect from 'connect';\nimport { Facts } from 'meteor/facts-base';\nimport { Meteor } from 'meteor/meteor';\nimport { MongoInternals } from 'meteor/mongo';\nimport client from 'prom-client';\nimport gcStats from 'prometheus-gc-stats';\nimport _ from 'underscore';\n\nimport { SystemLogger } from '../../../../server/lib/logger/system';\nimport { getControl } from '../../../../server/lib/migrations';\nimport { settings } from '../../../settings/server';\nimport { getAppsStatistics } from '../../../statistics/server/lib/getAppsStatistics';\nimport { Info } from '../../../utils/rocketchat.info';\nimport { metrics } from './metrics';\n\nconst { mongo } = MongoInternals.defaultRemoteCollectionDriver();\n\nFacts.incrementServerFact = function (pkg: 'pkg' | 'fact', fact: string | number, increment: number): void {\n\tmetrics.meteorFacts.inc({ pkg, fact }, increment);\n};\n\nconst setPrometheusData = async (): Promise<void> => {\n\tmetrics.info.set(\n\t\t{\n\t\t\tversion: Info.version,\n\t\t\tunique_id: settings.get<string>('uniqueID'),\n\t\t\tsite_url: settings.get<string>('Site_Url'),\n\t\t},\n\t\t1,\n\t);\n\n\tconst sessions = Array.from<{ userId: string }>(Meteor.server.sessions.values());\n\tconst authenticatedSessions = sessions.filter((s) => s.userId);\n\tmetrics.ddpSessions.set(Meteor.server.sessions.size);\n\tmetrics.ddpAuthenticatedSessions.set(authenticatedSessions.length);\n\tmetrics.ddpConnectedUsers.set(_.unique(authenticatedSessions.map((s) => s.userId)).length);\n\n\t// Apps metrics\n\tconst { totalInstalled, totalActive, totalFailed } = await getAppsStatistics();\n\n\tmetrics.totalAppsInstalled.set(totalInstalled || 0);\n\tmetrics.totalAppsEnabled.set(totalActive || 0);\n\tmetrics.totalAppsFailed.set(totalFailed || 0);\n\n\tconst oplogQueue = (mongo as any)._oplogHandle?._entryQueue?.length || 0;\n\tmetrics.oplogQueue.set(oplogQueue);\n\n\tconst statistics = await Statistics.findLast();\n\tif (!statistics) {\n\t\treturn;\n\t}\n\n\tmetrics.version.set({ version: statistics.version }, 1);\n\tmetrics.migration.set((await getControl()).version);\n\tmetrics.instanceCount.set(statistics.instanceCount);\n\tmetrics.oplogEnabled.set({ enabled: `${statistics.oplogEnabled}` }, 1);\n\n\t// User statistics\n\tmetrics.totalUsers.set(statistics.totalUsers);\n\tmetrics.activeUsers.set(statistics.activeUsers);\n\tmetrics.nonActiveUsers.set(statistics.nonActiveUsers);\n\tmetrics.onlineUsers.set(statistics.onlineUsers);\n\tmetrics.awayUsers.set(statistics.awayUsers);\n\tmetrics.offlineUsers.set(statistics.offlineUsers);\n\n\t// Room statistics\n\tmetrics.totalRooms.set(statistics.totalRooms);\n\tmetrics.totalChannels.set(statistics.totalChannels);\n\tmetrics.totalPrivateGroups.set(statistics.totalPrivateGroups);\n\tmetrics.totalDirect.set(statistics.totalDirect);\n\tmetrics.totalLivechat.set(statistics.totalLivechat);\n\n\t// Message statistics\n\tmetrics.totalMessages.set(statistics.totalMessages);\n\tmetrics.totalChannelMessages.set(statistics.totalChannelMessages);\n\tmetrics.totalPrivateGroupMessages.set(statistics.totalPrivateGroupMessages);\n\tmetrics.totalDirectMessages.set(statistics.totalDirectMessages);\n\tmetrics.totalLivechatMessages.set(statistics.totalLivechatMessages);\n\n\t// Livechat stats\n\tmetrics.totalLivechatVisitors.set(statistics.totalLivechatVisitors);\n\tmetrics.totalLivechatAgents.set(statistics.totalLivechatAgents);\n\n\tmetrics.pushQueue.set(statistics.pushQueue || 0);\n};\n\nconst app = connect();\n\n// const compression = require('compression');\n// app.use(compression());\n\napp.use('/metrics', (_req, res) => {\n\tres.setHeader('Content-Type', 'text/plain');\n\tclient.register\n\t\t.metrics()\n\t\t.then((data) => {\n\t\t\tmetrics.metricsRequests.inc();\n\t\t\tmetrics.metricsSize.set(data.length);\n\n\t\t\tres.end(data);\n\t\t})\n\t\t.catch((err) => {\n\t\t\tSystemLogger.error({ msg: 'Error while collecting metrics', err });\n\t\t\tres.end();\n\t\t});\n});\n\napp.use('/', (_req, res) => {\n\tconst html = `<html>\n\t\t<head>\n\t\t\t<title>Rocket.Chat Prometheus Exporter</title>\n\t\t</head>\n\t\t<body>\n\t\t\t<h1>Rocket.Chat Prometheus Exporter</h1>\n\t\t\t<p><a href=\"/metrics\">Metrics</a></p>\n\t\t</body>\n\t</html>`;\n\n\tres.write(html);\n\tres.end();\n});\n\nconst server = http.createServer(app);\n\nlet timer: NodeJS.Timeout;\nlet resetTimer: NodeJS.Timeout;\nlet defaultMetricsInitiated = false;\nlet gcStatsInitiated = false;\nconst was = {\n\tenabled: false,\n\tport: 9458,\n\tresetInterval: 0,\n\tcollectGC: false,\n};\nconst updatePrometheusConfig = async (): Promise<void> => {\n\tconst is = {\n\t\tport: process.env.PROMETHEUS_PORT || settings.get('Prometheus_Port'),\n\t\tenabled: settings.get<boolean>('Prometheus_Enabled'),\n\t\tresetInterval: settings.get<number>('Prometheus_Reset_Interval'),\n\t\tcollectGC: settings.get<boolean>('Prometheus_Garbage_Collector'),\n\t};\n\n\tif (Object.values(is).some((s) => s == null)) {\n\t\treturn;\n\t}\n\n\tif (Object.entries(is).every(([k, v]) => v === was[k as keyof typeof was])) {\n\t\treturn;\n\t}\n\n\tif (!is.enabled) {\n\t\tif (was.enabled) {\n\t\t\tSystemLogger.info('Disabling Prometheus');\n\t\t\tserver.close();\n\t\t\tclearInterval(timer);\n\t\t}\n\t\tObject.assign(was, is);\n\t\treturn;\n\t}\n\n\tSystemLogger.debug({ msg: 'Configuring Prometheus', is });\n\n\tif (!was.enabled) {\n\t\tserver.listen({\n\t\t\tport: is.port,\n\t\t\thost: process.env.BIND_IP || '0.0.0.0',\n\t\t});\n\n\t\ttimer = setInterval(setPrometheusData, 5000);\n\t}\n\n\tclearInterval(resetTimer);\n\tif (is.resetInterval) {\n\t\tresetTimer = setInterval(() => {\n\t\t\tclient.register.getMetricsAsArray().forEach((metric) => {\n\t\t\t\t// @ts-expect-error Property 'hashMap' does not exist on type 'metric'.\n\t\t\t\tmetric.hashMap = {};\n\t\t\t});\n\t\t}, is.resetInterval);\n\t}\n\n\t// Prevent exceptions on calling those methods twice since\n\t// it's not possible to stop them to be able to restart\n\ttry {\n\t\tif (defaultMetricsInitiated === false) {\n\t\t\tdefaultMetricsInitiated = true;\n\t\t\tclient.collectDefaultMetrics();\n\t\t}\n\t\tif (is.collectGC && gcStatsInitiated === false) {\n\t\t\tgcStatsInitiated = true;\n\t\t\tgcStats(client.register)();\n\t\t}\n\t} catch (error) {\n\t\tSystemLogger.error(error);\n\t}\n\n\tObject.assign(was, is);\n};\n\nMeteor.startup(async () => {\n\tsettings.watchByRegex(/^Prometheus_.+/, updatePrometheusConfig);\n});\n"],"mappings":"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","ignoreList":[]},"sourceType":"module","externalDependencies":{},"hash":"12a1d2f4184da13fb537c8dfaba9ca37f39db9fa"}
