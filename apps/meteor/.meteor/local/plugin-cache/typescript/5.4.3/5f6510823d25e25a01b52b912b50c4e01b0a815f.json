{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/ee/app/livechat-enterprise/server/lib/LivechatEnterprise.ts","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","topLevelAwait","objectRestSpread","objectRestSpread","asyncGenerators","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"os.osx.arm64"},"sourceFileName":"ee/app/livechat-enterprise/server/lib/LivechatEnterprise.ts","filename":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/ee/app/livechat-enterprise/server/lib/LivechatEnterprise.ts","inputSourceMap":{"version":3,"file":"ee/app/livechat-enterprise/server/lib/LivechatEnterprise.ts","sourceRoot":"","sources":["ee/app/livechat-enterprise/server/lib/LivechatEnterprise.ts"],"names":[],"mappings":"AACA,OAAO,EAAE,KAAK,EAAE,iCAAiC,EAAE,WAAW,EAAE,oBAAoB,EAAE,YAAY,EAAE,MAAM,qBAAqB,CAAC;AAChI,OAAO,EAAE,KAAK,EAAE,KAAK,EAAE,MAAM,cAAc,CAAC;AAC5C,OAAO,EAAE,MAAM,EAAE,MAAM,eAAe,CAAC;AAEvC,OAAO,EAAE,kBAAkB,EAAE,MAAM,UAAU,CAAC;AAC9C,OAAO,EAAE,kBAAkB,EAAE,MAAM,aAAa,CAAC;AACjD,OAAO,EAAE,SAAS,EAAE,MAAM,8BAA8B,CAAC;AACzD,OAAO,EAAE,iBAAiB,EAAE,MAAM,8CAA8C,CAAC;AACjF,OAAO,EAAE,wBAAwB,EAAE,MAAM,qDAAqD,CAAC;AAE/F,MAAM,CAAC,MAAM,kBAAkB,GAAG;IACjC,KAAK,CAAC,UAAU,CAAC,QAAgB;QAChC,KAAK,CAAC,QAAQ,EAAE,MAAM,CAAC,CAAC;QAExB,MAAM,IAAI,GAAG,MAAM,KAAK,CAAC,iBAAiB,CAAC,QAAQ,EAAE,EAAE,UAAU,EAAE,EAAE,GAAG,EAAE,CAAC,EAAE,QAAQ,EAAE,CAAC,EAAE,EAAE,CAAC,CAAC;QAE9F,IAAI,CAAC,IAAI,EAAE,CAAC;YACX,MAAM,IAAI,MAAM,CAAC,KAAK,CAAC,oBAAoB,EAAE,cAAc,EAAE;gBAC5D,MAAM,EAAE,qBAAqB;aAC7B,CAAC,CAAC;QACJ,CAAC;QAED,IAAI,MAAM,iBAAiB,CAAC,IAAI,CAAC,GAAG,EAAE,CAAC,kBAAkB,CAAC,CAAC,EAAE,CAAC;YAC7D,OAAO,IAAI,CAAC;QACb,CAAC;QAED,OAAO,KAAK,CAAC;IACd,CAAC;IAED,KAAK,CAAC,aAAa,CAAC,QAAgB;QACnC,KAAK,CAAC,QAAQ,EAAE,MAAM,CAAC,CAAC;QAExB,MAAM,IAAI,GAAG,MAAM,KAAK,CAAC,iBAAiB,CAAC,QAAQ,EAAE,EAAE,UAAU,EAAE,EAAE,GAAG,EAAE,CAAC,EAAE,EAAE,CAAC,CAAC;QAEjF,IAAI,CAAC,IAAI,EAAE,CAAC;YACX,MAAM,IAAI,MAAM,CAAC,KAAK,CAAC,oBAAoB,EAAE,cAAc,EAAE;gBAC5D,MAAM,EAAE,wBAAwB;aAChC,CAAC,CAAC;QACJ,CAAC;QAED,MAAM,gBAAgB,GAAG,MAAM,wBAAwB,CAAC,IAAI,CAAC,GAAG,EAAE,CAAC,kBAAkB,CAAC,CAAC,CAAC;QACxF,IAAI,CAAC,gBAAgB,EAAE,CAAC;YACvB,OAAO,KAAK,CAAC;QACd,CAAC;QAED,sDAAsD;QACtD,MAAM,oBAAoB,CAAC,iBAAiB,CAAC,IAAI,CAAC,GAAG,CAAC,CAAC;QAEvD,OAAO,IAAI,CAAC;IACb,CAAC;IAED,KAAK,CAAC,UAAU,CAAC,GAAW;QAC3B,KAAK,CAAC,GAAG,EAAE,MAAM,CAAC,CAAC;QAEnB,MAAM,IAAI,GAAG,MAAM,YAAY,CAAC,WAAW,CAAC,GAAG,EAAE,EAAE,UAAU,EAAE,EAAE,GAAG,EAAE,CAAC,EAAE,EAAE,CAAC,CAAC;QAE7E,IAAI,CAAC,IAAI,EAAE,CAAC;YACX,MAAM,IAAI,MAAM,CAAC,KAAK,CAAC,gBAAgB,EAAE,gBAAgB,EAAE,EAAE,MAAM,EAAE,qBAAqB,EAAE,CAAC,CAAC;QAC/F,CAAC;QAED,OAAO,YAAY,CAAC,UAAU,CAAC,GAAG,CAAC,CAAC;IACrC,CAAC;IAED,KAAK,CAAC,QAAQ,CACb,GAAkB,EAClB,QAA+C,EAC/C,YAAqD,EACrD,eAA2C;QAE3C,KAAK,CAAC,GAAG,EAAE,KAAK,CAAC,KAAK,CAAC,MAAM,CAAC,CAAC,CAAC;QAEhC,KAAK,CAAC,QAAQ,EAAE;YACf,IAAI,EAAE,MAAM;YACZ,UAAU,EAAE,MAAM;YAClB,OAAO,EAAE,KAAK,CAAC,QAAQ,CAAC,OAAO,CAAC;YAChC,WAAW,EAAE,KAAK,CAAC,QAAQ,CAAC,MAAM,CAAC;YACnC,KAAK,EAAE,KAAK,CAAC,QAAQ,CAAC,MAAM,CAAC;YAC7B,iBAAiB,EAAE,KAAK,CAAC,QAAQ,CAAC,OAAO,CAAC;SAC1C,CAAC,CAAC;QAEH,KAAK,CAAC,YAAY,EAAE;YACnB,KAAK,CAAC,eAAe,CAAC;gBACrB,SAAS,EAAE,MAAM;gBACjB,QAAQ,EAAE,MAAM;aAChB,CAAC;SACF,CAAC,CAAC;QAEH,KAAK,CAAC,eAAe,EAAE;YACtB,KAAK,CAAC,eAAe,CAAC;gBACrB,YAAY,EAAE,MAAM;aACpB,CAAC;SACF,CAAC,CAAC;QAEH,IAAI,SAAS,GAAa,EAAE,CAAC;QAC7B,IAAI,GAAG,EAAE,CAAC;YACT,MAAM,IAAI,GAAG,MAAM,YAAY,CAAC,WAAW,CAAC,GAAG,CAAC,CAAC;YACjD,IAAI,CAAC,IAAI,EAAE,CAAC;gBACX,MAAM,IAAI,MAAM,CAAC,KAAK,CAAC,sBAAsB,EAAE,gBAAgB,EAAE;oBAChE,MAAM,EAAE,mBAAmB;iBAC3B,CAAC,CAAC;YACJ,CAAC;YAED,SAAS,GAAG,IAAI,CAAC,SAAS,IAAI,EAAE,CAAC;QAClC,CAAC;QAED,MAAM,iBAAiB,GAAG,MAAM,KAAK,CAAC,yBAAyB,CAC9D,kBAAkB,EAClB,EAAE,GAAG,EAAE,EAAE,GAAG,EAAE,YAAY,CAAC,GAAG,CAAC,CAAC,EAAE,SAAS,EAAE,EAAE,EAAE,CAAC,SAAS,CAAC,EAAE,EAAE,EAChE,EAAE,UAAU,EAAE,EAAE,GAAG,EAAE,CAAC,EAAE,QAAQ,EAAE,CAAC,EAAE,EAAE,CACvC,CAAC,OAAO,EAAE,CAAC;QAEZ,MAAM,QAAQ,GAAG,iBAAiB,CAAC,GAAG,CAAC,CAAC,EAAE,GAAG,EAAE,SAAS,EAAE,QAAQ,EAAE,EAAE,EAAE,CAAC,CAAC;YACzE,SAAS;YACT,QAAQ;SACR,CAAC,CAA8C,CAAC;QAEjD,OAAO,YAAY,CAAC,kBAAkB,CAAC,GAAG,EAAE,QAAQ,EAAE,SAAS,EAAE,QAAQ,EAAE,eAAe,CAAC,CAAC;IAC7F,CAAC;IAED,KAAK,CAAC,SAAS,CAAC,GAAW;QAC1B,KAAK,CAAC,GAAG,EAAE,MAAM,CAAC,CAAC;QAEnB,MAAM,GAAG,GAAG,MAAM,WAAW,CAAC,WAAW,CAAC,GAAG,EAAE,EAAE,UAAU,EAAE,EAAE,GAAG,EAAE,CAAC,EAAE,IAAI,EAAE,CAAC,EAAE,EAAE,CAAC,CAAC;QAEpF,IAAI,CAAC,GAAG,EAAE,CAAC;YACV,MAAM,IAAI,MAAM,CAAC,KAAK,CAAC,eAAe,EAAE,eAAe,EAAE,EAAE,MAAM,EAAE,oBAAoB,EAAE,CAAC,CAAC;QAC5F,CAAC;QAED,MAAM,SAAS,CAAC,GAAG,CAAC,0BAA0B,EAAE,GAAG,CAAC,CAAC;QACrD,OAAO,WAAW,CAAC,UAAU,CAAC,GAAG,CAAC,CAAC;IACpC,CAAC;IAED,KAAK,CAAC,OAAO,CAAC,GAAuB,EAAE,OAA+C,EAAE,cAAwB;QAC/G,KAAK,CAAC,GAAG,EAAE,KAAK,CAAC,KAAK,CAAC,MAAM,CAAC,CAAC,CAAC;QAEhC,KAAK,CAAC,OAAO,EAAE;YACd,IAAI,EAAE,MAAM;YACZ,WAAW,EAAE,KAAK,CAAC,QAAQ,CAAC,MAAM,CAAC;SACnC,CAAC,CAAC;QAEH,KAAK,CAAC,cAAc,EAAE,CAAC,MAAM,CAAC,CAAC,CAAC;QAEhC,OAAO,WAAW,CAAC,iBAAiB,CAAC,GAAG,EAAE,OAAO,EAAE,cAAc,CAAC,CAAC;IACpE,CAAC;IAED,KAAK,CAAC,OAAO,CAAC,GAAkB,EAAE,OAA8F;QAC/H,MAAM,MAAM,GAAG,GAAG,IAAI,CAAC,MAAM,iCAAiC,CAAC,WAAW,CAAC,GAAG,EAAE,EAAE,UAAU,EAAE,EAAE,gBAAgB,EAAE,CAAC,EAAE,EAAE,CAAC,CAAC,CAAC;QAC1H,MAAM,MAAM,GAAG,MAAM,iCAAiC,CAAC,aAAa,CAAC,GAAG,EAAE,OAAO,CAAC,IAAI,EAAE,OAAO,CAAC,gBAAgB,CAAC,CAAC;QAClH,IAAI,MAAM,EAAE,CAAC;YACZ,MAAM,IAAI,KAAK,CAAC,sBAAsB,CAAC,CAAC;QACzC,CAAC;QAED,MAAM,GAAG,GAAG,MAAM,iCAAiC,CAAC,sBAAsB,CAAC,OAAO,EAAE,GAAG,CAAC,CAAC;QACzF,IAAI,CAAC,MAAM,EAAE,CAAC;YACb,OAAO,GAAG,CAAC;QACZ,CAAC;QAED,MAAM,EAAE,gBAAgB,EAAE,mBAAmB,EAAE,GAAG,MAAM,CAAC;QACzD,MAAM,EAAE,gBAAgB,EAAE,GAAG,GAAG,CAAC;QAEjC,IAAI,mBAAmB,KAAK,gBAAgB,EAAE,CAAC;YAC9C,MAAM,kBAAkB,CAAC,GAAG,CAAC,CAAC;QAC/B,CAAC;QAED,OAAO,GAAG,CAAC;IACZ,CAAC;IAED,KAAK,CAAC,SAAS,CAAC,GAAW;QAC1B,MAAM,GAAG,GAAG,MAAM,iCAAiC,CAAC,WAAW,CAAC,GAAG,EAAE,EAAE,UAAU,EAAE,EAAE,GAAG,EAAE,CAAC,EAAE,EAAE,CAAC,CAAC;QACjG,IAAI,CAAC,GAAG,EAAE,CAAC;YACV,MAAM,IAAI,KAAK,CAAC,eAAe,GAAG,YAAY,CAAC,CAAC;QACjD,CAAC;QAED,MAAM,aAAa,GAAG,MAAM,iCAAiC,CAAC,UAAU,CAAC,GAAG,CAAC,CAAC;QAC9E,IAAI,CAAC,aAAa,IAAI,aAAa,CAAC,YAAY,KAAK,CAAC,EAAE,CAAC;YACxD,MAAM,IAAI,KAAK,CAAC,8BAA8B,GAAG,EAAE,CAAC,CAAC;QACtD,CAAC;QAED,MAAM,kBAAkB,CAAC,GAAG,CAAC,CAAC;IAC/B,CAAC;CACD,CAAC","sourcesContent":["import type { IOmnichannelBusinessUnit, IOmnichannelServiceLevelAgreements } from '@rocket.chat/core-typings';\nimport { Users, OmnichannelServiceLevelAgreements, LivechatTag, LivechatUnitMonitors, LivechatUnit } from '@rocket.chat/models';\nimport { Match, check } from 'meteor/check';\nimport { Meteor } from 'meteor/meteor';\n\nimport { updateSLAInquiries } from './Helper';\nimport { removeSLAFromRooms } from './SlaHelper';\nimport { callbacks } from '../../../../../lib/callbacks';\nimport { addUserRolesAsync } from '../../../../../server/lib/roles/addUserRoles';\nimport { removeUserFromRolesAsync } from '../../../../../server/lib/roles/removeUserFromRoles';\n\nexport const LivechatEnterprise = {\n\tasync addMonitor(username: string) {\n\t\tcheck(username, String);\n\n\t\tconst user = await Users.findOneByUsername(username, { projection: { _id: 1, username: 1 } });\n\n\t\tif (!user) {\n\t\t\tthrow new Meteor.Error('error-invalid-user', 'Invalid user', {\n\t\t\t\tmethod: 'livechat:addMonitor',\n\t\t\t});\n\t\t}\n\n\t\tif (await addUserRolesAsync(user._id, ['livechat-monitor'])) {\n\t\t\treturn user;\n\t\t}\n\n\t\treturn false;\n\t},\n\n\tasync removeMonitor(username: string) {\n\t\tcheck(username, String);\n\n\t\tconst user = await Users.findOneByUsername(username, { projection: { _id: 1 } });\n\n\t\tif (!user) {\n\t\t\tthrow new Meteor.Error('error-invalid-user', 'Invalid user', {\n\t\t\t\tmethod: 'livechat:removeMonitor',\n\t\t\t});\n\t\t}\n\n\t\tconst removeRoleResult = await removeUserFromRolesAsync(user._id, ['livechat-monitor']);\n\t\tif (!removeRoleResult) {\n\t\t\treturn false;\n\t\t}\n\n\t\t// remove this monitor from any unit it is assigned to\n\t\tawait LivechatUnitMonitors.removeByMonitorId(user._id);\n\n\t\treturn true;\n\t},\n\n\tasync removeUnit(_id: string) {\n\t\tcheck(_id, String);\n\n\t\tconst unit = await LivechatUnit.findOneById(_id, { projection: { _id: 1 } });\n\n\t\tif (!unit) {\n\t\t\tthrow new Meteor.Error('unit-not-found', 'Unit not found', { method: 'livechat:removeUnit' });\n\t\t}\n\n\t\treturn LivechatUnit.removeById(_id);\n\t},\n\n\tasync saveUnit(\n\t\t_id: string | null,\n\t\tunitData: Omit<IOmnichannelBusinessUnit, '_id'>,\n\t\tunitMonitors: { monitorId: string; username: string },\n\t\tunitDepartments: { departmentId: string }[],\n\t) {\n\t\tcheck(_id, Match.Maybe(String));\n\n\t\tcheck(unitData, {\n\t\t\tname: String,\n\t\t\tvisibility: String,\n\t\t\tenabled: Match.Optional(Boolean),\n\t\t\tdescription: Match.Optional(String),\n\t\t\temail: Match.Optional(String),\n\t\t\tshowOnOfflineForm: Match.Optional(Boolean),\n\t\t});\n\n\t\tcheck(unitMonitors, [\n\t\t\tMatch.ObjectIncluding({\n\t\t\t\tmonitorId: String,\n\t\t\t\tusername: String,\n\t\t\t}),\n\t\t]);\n\n\t\tcheck(unitDepartments, [\n\t\t\tMatch.ObjectIncluding({\n\t\t\t\tdepartmentId: String,\n\t\t\t}),\n\t\t]);\n\n\t\tlet ancestors: string[] = [];\n\t\tif (_id) {\n\t\t\tconst unit = await LivechatUnit.findOneById(_id);\n\t\t\tif (!unit) {\n\t\t\t\tthrow new Meteor.Error('error-unit-not-found', 'Unit not found', {\n\t\t\t\t\tmethod: 'livechat:saveUnit',\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tancestors = unit.ancestors || [];\n\t\t}\n\n\t\tconst validUserMonitors = await Users.findUsersInRolesWithQuery(\n\t\t\t'livechat-monitor',\n\t\t\t{ _id: { $in: unitMonitors.map(({ monitorId }) => monitorId) } },\n\t\t\t{ projection: { _id: 1, username: 1 } },\n\t\t).toArray();\n\n\t\tconst monitors = validUserMonitors.map(({ _id: monitorId, username }) => ({\n\t\t\tmonitorId,\n\t\t\tusername,\n\t\t})) as { monitorId: string; username: string }[];\n\n\t\treturn LivechatUnit.createOrUpdateUnit(_id, unitData, ancestors, monitors, unitDepartments);\n\t},\n\n\tasync removeTag(_id: string) {\n\t\tcheck(_id, String);\n\n\t\tconst tag = await LivechatTag.findOneById(_id, { projection: { _id: 1, name: 1 } });\n\n\t\tif (!tag) {\n\t\t\tthrow new Meteor.Error('tag-not-found', 'Tag not found', { method: 'livechat:removeTag' });\n\t\t}\n\n\t\tawait callbacks.run('livechat.afterTagRemoved', tag);\n\t\treturn LivechatTag.removeById(_id);\n\t},\n\n\tasync saveTag(_id: string | undefined, tagData: { name: string; description?: string }, tagDepartments: string[]) {\n\t\tcheck(_id, Match.Maybe(String));\n\n\t\tcheck(tagData, {\n\t\t\tname: String,\n\t\t\tdescription: Match.Optional(String),\n\t\t});\n\n\t\tcheck(tagDepartments, [String]);\n\n\t\treturn LivechatTag.createOrUpdateTag(_id, tagData, tagDepartments);\n\t},\n\n\tasync saveSLA(_id: string | null, slaData: Pick<IOmnichannelServiceLevelAgreements, 'name' | 'description' | 'dueTimeInMinutes'>) {\n\t\tconst oldSLA = _id && (await OmnichannelServiceLevelAgreements.findOneById(_id, { projection: { dueTimeInMinutes: 1 } }));\n\t\tconst exists = await OmnichannelServiceLevelAgreements.findDuplicate(_id, slaData.name, slaData.dueTimeInMinutes);\n\t\tif (exists) {\n\t\t\tthrow new Error('error-duplicated-sla');\n\t\t}\n\n\t\tconst sla = await OmnichannelServiceLevelAgreements.createOrUpdatePriority(slaData, _id);\n\t\tif (!oldSLA) {\n\t\t\treturn sla;\n\t\t}\n\n\t\tconst { dueTimeInMinutes: oldDueTimeInMinutes } = oldSLA;\n\t\tconst { dueTimeInMinutes } = sla;\n\n\t\tif (oldDueTimeInMinutes !== dueTimeInMinutes) {\n\t\t\tawait updateSLAInquiries(sla);\n\t\t}\n\n\t\treturn sla;\n\t},\n\n\tasync removeSLA(_id: string) {\n\t\tconst sla = await OmnichannelServiceLevelAgreements.findOneById(_id, { projection: { _id: 1 } });\n\t\tif (!sla) {\n\t\t\tthrow new Error(`SLA with id ${_id} not found`);\n\t\t}\n\n\t\tconst removedResult = await OmnichannelServiceLevelAgreements.removeById(_id);\n\t\tif (!removedResult || removedResult.deletedCount !== 1) {\n\t\t\tthrow new Error(`Error removing SLA with id ${_id}`);\n\t\t}\n\n\t\tawait removeSLAFromRooms(_id);\n\t},\n};\n"]},"targets":{"android":"125.0.0","chrome":"125.0.0","edge":"125.0.0","firefox":"115.0.0","ie":"10.0.0","ios":"17.4.0","opera":"110.0.0","opera_mobile":"80.0.0","safari":"17.4.0","samsung":"24.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor","root":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":false,"enforceStrictMode":false,"dynamicImport":true,"generateLetDeclarations":true,"topLevelAwait":true},"externalDependencies":[]},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"version":"7.17.2","helpers":true,"useESModules":false,"corejs":false},"externalDependencies":[]},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-async-generator-functions","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-class-properties","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true},"externalDependencies":[]},{"key":"transform-react-jsx","visitor":{"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXFragment":{"exit":[null]},"JSXElement":{"exit":[null]},"JSXAttribute":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false},"externalDependencies":[]},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-nullish-coalescing-operator","visitor":{"LogicalExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-optional-chaining","visitor":{"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-optional-catch-binding","visitor":{"CatchClause":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-class-properties","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-async-generator-functions","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-logical-assignment-operators","visitor":{"AssignmentExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]}],"presets":[],"generatorOpts":{"filename":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/ee/app/livechat-enterprise/server/lib/LivechatEnterprise.ts","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"ee/app/livechat-enterprise/server/lib/LivechatEnterprise.ts","inputSourceMap":{"version":3,"file":"ee/app/livechat-enterprise/server/lib/LivechatEnterprise.ts","sourceRoot":"","sources":["ee/app/livechat-enterprise/server/lib/LivechatEnterprise.ts"],"names":[],"mappings":"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","sourcesContent":["import type { IOmnichannelBusinessUnit, IOmnichannelServiceLevelAgreements } from '@rocket.chat/core-typings';\nimport { Users, OmnichannelServiceLevelAgreements, LivechatTag, LivechatUnitMonitors, LivechatUnit } from '@rocket.chat/models';\nimport { Match, check } from 'meteor/check';\nimport { Meteor } from 'meteor/meteor';\n\nimport { updateSLAInquiries } from './Helper';\nimport { removeSLAFromRooms } from './SlaHelper';\nimport { callbacks } from '../../../../../lib/callbacks';\nimport { addUserRolesAsync } from '../../../../../server/lib/roles/addUserRoles';\nimport { removeUserFromRolesAsync } from '../../../../../server/lib/roles/removeUserFromRoles';\n\nexport const LivechatEnterprise = {\n\tasync addMonitor(username: string) {\n\t\tcheck(username, String);\n\n\t\tconst user = await Users.findOneByUsername(username, { projection: { _id: 1, username: 1 } });\n\n\t\tif (!user) {\n\t\t\tthrow new Meteor.Error('error-invalid-user', 'Invalid user', {\n\t\t\t\tmethod: 'livechat:addMonitor',\n\t\t\t});\n\t\t}\n\n\t\tif (await addUserRolesAsync(user._id, ['livechat-monitor'])) {\n\t\t\treturn user;\n\t\t}\n\n\t\treturn false;\n\t},\n\n\tasync removeMonitor(username: string) {\n\t\tcheck(username, String);\n\n\t\tconst user = await Users.findOneByUsername(username, { projection: { _id: 1 } });\n\n\t\tif (!user) {\n\t\t\tthrow new Meteor.Error('error-invalid-user', 'Invalid user', {\n\t\t\t\tmethod: 'livechat:removeMonitor',\n\t\t\t});\n\t\t}\n\n\t\tconst removeRoleResult = await removeUserFromRolesAsync(user._id, ['livechat-monitor']);\n\t\tif (!removeRoleResult) {\n\t\t\treturn false;\n\t\t}\n\n\t\t// remove this monitor from any unit it is assigned to\n\t\tawait LivechatUnitMonitors.removeByMonitorId(user._id);\n\n\t\treturn true;\n\t},\n\n\tasync removeUnit(_id: string) {\n\t\tcheck(_id, String);\n\n\t\tconst unit = await LivechatUnit.findOneById(_id, { projection: { _id: 1 } });\n\n\t\tif (!unit) {\n\t\t\tthrow new Meteor.Error('unit-not-found', 'Unit not found', { method: 'livechat:removeUnit' });\n\t\t}\n\n\t\treturn LivechatUnit.removeById(_id);\n\t},\n\n\tasync saveUnit(\n\t\t_id: string | null,\n\t\tunitData: Omit<IOmnichannelBusinessUnit, '_id'>,\n\t\tunitMonitors: { monitorId: string; username: string },\n\t\tunitDepartments: { departmentId: string }[],\n\t) {\n\t\tcheck(_id, Match.Maybe(String));\n\n\t\tcheck(unitData, {\n\t\t\tname: String,\n\t\t\tvisibility: String,\n\t\t\tenabled: Match.Optional(Boolean),\n\t\t\tdescription: Match.Optional(String),\n\t\t\temail: Match.Optional(String),\n\t\t\tshowOnOfflineForm: Match.Optional(Boolean),\n\t\t});\n\n\t\tcheck(unitMonitors, [\n\t\t\tMatch.ObjectIncluding({\n\t\t\t\tmonitorId: String,\n\t\t\t\tusername: String,\n\t\t\t}),\n\t\t]);\n\n\t\tcheck(unitDepartments, [\n\t\t\tMatch.ObjectIncluding({\n\t\t\t\tdepartmentId: String,\n\t\t\t}),\n\t\t]);\n\n\t\tlet ancestors: string[] = [];\n\t\tif (_id) {\n\t\t\tconst unit = await LivechatUnit.findOneById(_id);\n\t\t\tif (!unit) {\n\t\t\t\tthrow new Meteor.Error('error-unit-not-found', 'Unit not found', {\n\t\t\t\t\tmethod: 'livechat:saveUnit',\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tancestors = unit.ancestors || [];\n\t\t}\n\n\t\tconst validUserMonitors = await Users.findUsersInRolesWithQuery(\n\t\t\t'livechat-monitor',\n\t\t\t{ _id: { $in: unitMonitors.map(({ monitorId }) => monitorId) } },\n\t\t\t{ projection: { _id: 1, username: 1 } },\n\t\t).toArray();\n\n\t\tconst monitors = validUserMonitors.map(({ _id: monitorId, username }) => ({\n\t\t\tmonitorId,\n\t\t\tusername,\n\t\t})) as { monitorId: string; username: string }[];\n\n\t\treturn LivechatUnit.createOrUpdateUnit(_id, unitData, ancestors, monitors, unitDepartments);\n\t},\n\n\tasync removeTag(_id: string) {\n\t\tcheck(_id, String);\n\n\t\tconst tag = await LivechatTag.findOneById(_id, { projection: { _id: 1, name: 1 } });\n\n\t\tif (!tag) {\n\t\t\tthrow new Meteor.Error('tag-not-found', 'Tag not found', { method: 'livechat:removeTag' });\n\t\t}\n\n\t\tawait callbacks.run('livechat.afterTagRemoved', tag);\n\t\treturn LivechatTag.removeById(_id);\n\t},\n\n\tasync saveTag(_id: string | undefined, tagData: { name: string; description?: string }, tagDepartments: string[]) {\n\t\tcheck(_id, Match.Maybe(String));\n\n\t\tcheck(tagData, {\n\t\t\tname: String,\n\t\t\tdescription: Match.Optional(String),\n\t\t});\n\n\t\tcheck(tagDepartments, [String]);\n\n\t\treturn LivechatTag.createOrUpdateTag(_id, tagData, tagDepartments);\n\t},\n\n\tasync saveSLA(_id: string | null, slaData: Pick<IOmnichannelServiceLevelAgreements, 'name' | 'description' | 'dueTimeInMinutes'>) {\n\t\tconst oldSLA = _id && (await OmnichannelServiceLevelAgreements.findOneById(_id, { projection: { dueTimeInMinutes: 1 } }));\n\t\tconst exists = await OmnichannelServiceLevelAgreements.findDuplicate(_id, slaData.name, slaData.dueTimeInMinutes);\n\t\tif (exists) {\n\t\t\tthrow new Error('error-duplicated-sla');\n\t\t}\n\n\t\tconst sla = await OmnichannelServiceLevelAgreements.createOrUpdatePriority(slaData, _id);\n\t\tif (!oldSLA) {\n\t\t\treturn sla;\n\t\t}\n\n\t\tconst { dueTimeInMinutes: oldDueTimeInMinutes } = oldSLA;\n\t\tconst { dueTimeInMinutes } = sla;\n\n\t\tif (oldDueTimeInMinutes !== dueTimeInMinutes) {\n\t\t\tawait updateSLAInquiries(sla);\n\t\t}\n\n\t\treturn sla;\n\t},\n\n\tasync removeSLA(_id: string) {\n\t\tconst sla = await OmnichannelServiceLevelAgreements.findOneById(_id, { projection: { _id: 1 } });\n\t\tif (!sla) {\n\t\t\tthrow new Error(`SLA with id ${_id} not found`);\n\t\t}\n\n\t\tconst removedResult = await OmnichannelServiceLevelAgreements.removeById(_id);\n\t\tif (!removedResult || removedResult.deletedCount !== 1) {\n\t\t\tthrow new Error(`Error removing SLA with id ${_id}`);\n\t\t}\n\n\t\tawait removeSLAFromRooms(_id);\n\t},\n};\n"]}}},"code":"!module.wrapAsync(async function (module, __reifyWaitForDeps__, __reify_async_result__) {\n  \"use strict\";\n  try {\n    module.export({\n      LivechatEnterprise: () => LivechatEnterprise\n    });\n    let Users, OmnichannelServiceLevelAgreements, LivechatTag, LivechatUnitMonitors, LivechatUnit;\n    module.link(\"@rocket.chat/models\", {\n      Users(v) {\n        Users = v;\n      },\n      OmnichannelServiceLevelAgreements(v) {\n        OmnichannelServiceLevelAgreements = v;\n      },\n      LivechatTag(v) {\n        LivechatTag = v;\n      },\n      LivechatUnitMonitors(v) {\n        LivechatUnitMonitors = v;\n      },\n      LivechatUnit(v) {\n        LivechatUnit = v;\n      }\n    }, 0);\n    let Match, check;\n    module.link(\"meteor/check\", {\n      Match(v) {\n        Match = v;\n      },\n      check(v) {\n        check = v;\n      }\n    }, 1);\n    let Meteor;\n    module.link(\"meteor/meteor\", {\n      Meteor(v) {\n        Meteor = v;\n      }\n    }, 2);\n    let updateSLAInquiries;\n    module.link(\"./Helper\", {\n      updateSLAInquiries(v) {\n        updateSLAInquiries = v;\n      }\n    }, 3);\n    let removeSLAFromRooms;\n    module.link(\"./SlaHelper\", {\n      removeSLAFromRooms(v) {\n        removeSLAFromRooms = v;\n      }\n    }, 4);\n    let callbacks;\n    module.link(\"../../../../../lib/callbacks\", {\n      callbacks(v) {\n        callbacks = v;\n      }\n    }, 5);\n    let addUserRolesAsync;\n    module.link(\"../../../../../server/lib/roles/addUserRoles\", {\n      addUserRolesAsync(v) {\n        addUserRolesAsync = v;\n      }\n    }, 6);\n    let removeUserFromRolesAsync;\n    module.link(\"../../../../../server/lib/roles/removeUserFromRoles\", {\n      removeUserFromRolesAsync(v) {\n        removeUserFromRolesAsync = v;\n      }\n    }, 7);\n    if (__reifyWaitForDeps__()) (await __reifyWaitForDeps__())();\n    const LivechatEnterprise = {\n      async addMonitor(username) {\n        check(username, String);\n        const user = await Users.findOneByUsername(username, {\n          projection: {\n            _id: 1,\n            username: 1\n          }\n        });\n        if (!user) {\n          throw new Meteor.Error('error-invalid-user', 'Invalid user', {\n            method: 'livechat:addMonitor'\n          });\n        }\n        if (await addUserRolesAsync(user._id, ['livechat-monitor'])) {\n          return user;\n        }\n        return false;\n      },\n      async removeMonitor(username) {\n        check(username, String);\n        const user = await Users.findOneByUsername(username, {\n          projection: {\n            _id: 1\n          }\n        });\n        if (!user) {\n          throw new Meteor.Error('error-invalid-user', 'Invalid user', {\n            method: 'livechat:removeMonitor'\n          });\n        }\n        const removeRoleResult = await removeUserFromRolesAsync(user._id, ['livechat-monitor']);\n        if (!removeRoleResult) {\n          return false;\n        }\n        // remove this monitor from any unit it is assigned to\n        await LivechatUnitMonitors.removeByMonitorId(user._id);\n        return true;\n      },\n      async removeUnit(_id) {\n        check(_id, String);\n        const unit = await LivechatUnit.findOneById(_id, {\n          projection: {\n            _id: 1\n          }\n        });\n        if (!unit) {\n          throw new Meteor.Error('unit-not-found', 'Unit not found', {\n            method: 'livechat:removeUnit'\n          });\n        }\n        return LivechatUnit.removeById(_id);\n      },\n      async saveUnit(_id, unitData, unitMonitors, unitDepartments) {\n        check(_id, Match.Maybe(String));\n        check(unitData, {\n          name: String,\n          visibility: String,\n          enabled: Match.Optional(Boolean),\n          description: Match.Optional(String),\n          email: Match.Optional(String),\n          showOnOfflineForm: Match.Optional(Boolean)\n        });\n        check(unitMonitors, [Match.ObjectIncluding({\n          monitorId: String,\n          username: String\n        })]);\n        check(unitDepartments, [Match.ObjectIncluding({\n          departmentId: String\n        })]);\n        let ancestors = [];\n        if (_id) {\n          const unit = await LivechatUnit.findOneById(_id);\n          if (!unit) {\n            throw new Meteor.Error('error-unit-not-found', 'Unit not found', {\n              method: 'livechat:saveUnit'\n            });\n          }\n          ancestors = unit.ancestors || [];\n        }\n        const validUserMonitors = await Users.findUsersInRolesWithQuery('livechat-monitor', {\n          _id: {\n            $in: unitMonitors.map(_ref => {\n              let {\n                monitorId\n              } = _ref;\n              return monitorId;\n            })\n          }\n        }, {\n          projection: {\n            _id: 1,\n            username: 1\n          }\n        }).toArray();\n        const monitors = validUserMonitors.map(_ref2 => {\n          let {\n            _id: monitorId,\n            username\n          } = _ref2;\n          return {\n            monitorId,\n            username\n          };\n        });\n        return LivechatUnit.createOrUpdateUnit(_id, unitData, ancestors, monitors, unitDepartments);\n      },\n      async removeTag(_id) {\n        check(_id, String);\n        const tag = await LivechatTag.findOneById(_id, {\n          projection: {\n            _id: 1,\n            name: 1\n          }\n        });\n        if (!tag) {\n          throw new Meteor.Error('tag-not-found', 'Tag not found', {\n            method: 'livechat:removeTag'\n          });\n        }\n        await callbacks.run('livechat.afterTagRemoved', tag);\n        return LivechatTag.removeById(_id);\n      },\n      async saveTag(_id, tagData, tagDepartments) {\n        check(_id, Match.Maybe(String));\n        check(tagData, {\n          name: String,\n          description: Match.Optional(String)\n        });\n        check(tagDepartments, [String]);\n        return LivechatTag.createOrUpdateTag(_id, tagData, tagDepartments);\n      },\n      async saveSLA(_id, slaData) {\n        const oldSLA = _id && (await OmnichannelServiceLevelAgreements.findOneById(_id, {\n          projection: {\n            dueTimeInMinutes: 1\n          }\n        }));\n        const exists = await OmnichannelServiceLevelAgreements.findDuplicate(_id, slaData.name, slaData.dueTimeInMinutes);\n        if (exists) {\n          throw new Error('error-duplicated-sla');\n        }\n        const sla = await OmnichannelServiceLevelAgreements.createOrUpdatePriority(slaData, _id);\n        if (!oldSLA) {\n          return sla;\n        }\n        const {\n          dueTimeInMinutes: oldDueTimeInMinutes\n        } = oldSLA;\n        const {\n          dueTimeInMinutes\n        } = sla;\n        if (oldDueTimeInMinutes !== dueTimeInMinutes) {\n          await updateSLAInquiries(sla);\n        }\n        return sla;\n      },\n      async removeSLA(_id) {\n        const sla = await OmnichannelServiceLevelAgreements.findOneById(_id, {\n          projection: {\n            _id: 1\n          }\n        });\n        if (!sla) {\n          throw new Error(\"SLA with id \".concat(_id, \" not found\"));\n        }\n        const removedResult = await OmnichannelServiceLevelAgreements.removeById(_id);\n        if (!removedResult || removedResult.deletedCount !== 1) {\n          throw new Error(\"Error removing SLA with id \".concat(_id));\n        }\n        await removeSLAFromRooms(_id);\n      }\n    };\n    __reify_async_result__();\n  } catch (_reifyError) {\n    return __reify_async_result__(_reifyError);\n  }\n  __reify_async_result__()\n}, {\n  self: this,\n  async: false\n});","map":{"version":3,"names":["module","export","LivechatEnterprise","Users","OmnichannelServiceLevelAgreements","LivechatTag","LivechatUnitMonitors","LivechatUnit","link","v","Match","check","Meteor","updateSLAInquiries","removeSLAFromRooms","callbacks","addUserRolesAsync","removeUserFromRolesAsync","__reifyWaitForDeps__","addMonitor","username","String","user","findOneByUsername","projection","_id","Error","method","removeMonitor","removeRoleResult","removeByMonitorId","removeUnit","unit","findOneById","removeById","saveUnit","unitData","unitMonitors","unitDepartments","Maybe","name","visibility","enabled","Optional","Boolean","description","email","showOnOfflineForm","ObjectIncluding","monitorId","departmentId","ancestors","validUserMonitors","findUsersInRolesWithQuery","$in","map","_ref","toArray","monitors","_ref2","createOrUpdateUnit","removeTag","tag","run","saveTag","tagData","tagDepartments","createOrUpdateTag","saveSLA","slaData","oldSLA","dueTimeInMinutes","exists","findDuplicate","sla","createOrUpdatePriority","oldDueTimeInMinutes","removeSLA","concat","removedResult","deletedCount","__reify_async_result__","_reifyError","self","async"],"sources":["ee/app/livechat-enterprise/server/lib/LivechatEnterprise.ts"],"sourcesContent":["import type { IOmnichannelBusinessUnit, IOmnichannelServiceLevelAgreements } from '@rocket.chat/core-typings';\nimport { Users, OmnichannelServiceLevelAgreements, LivechatTag, LivechatUnitMonitors, LivechatUnit } from '@rocket.chat/models';\nimport { Match, check } from 'meteor/check';\nimport { Meteor } from 'meteor/meteor';\n\nimport { updateSLAInquiries } from './Helper';\nimport { removeSLAFromRooms } from './SlaHelper';\nimport { callbacks } from '../../../../../lib/callbacks';\nimport { addUserRolesAsync } from '../../../../../server/lib/roles/addUserRoles';\nimport { removeUserFromRolesAsync } from '../../../../../server/lib/roles/removeUserFromRoles';\n\nexport const LivechatEnterprise = {\n\tasync addMonitor(username: string) {\n\t\tcheck(username, String);\n\n\t\tconst user = await Users.findOneByUsername(username, { projection: { _id: 1, username: 1 } });\n\n\t\tif (!user) {\n\t\t\tthrow new Meteor.Error('error-invalid-user', 'Invalid user', {\n\t\t\t\tmethod: 'livechat:addMonitor',\n\t\t\t});\n\t\t}\n\n\t\tif (await addUserRolesAsync(user._id, ['livechat-monitor'])) {\n\t\t\treturn user;\n\t\t}\n\n\t\treturn false;\n\t},\n\n\tasync removeMonitor(username: string) {\n\t\tcheck(username, String);\n\n\t\tconst user = await Users.findOneByUsername(username, { projection: { _id: 1 } });\n\n\t\tif (!user) {\n\t\t\tthrow new Meteor.Error('error-invalid-user', 'Invalid user', {\n\t\t\t\tmethod: 'livechat:removeMonitor',\n\t\t\t});\n\t\t}\n\n\t\tconst removeRoleResult = await removeUserFromRolesAsync(user._id, ['livechat-monitor']);\n\t\tif (!removeRoleResult) {\n\t\t\treturn false;\n\t\t}\n\n\t\t// remove this monitor from any unit it is assigned to\n\t\tawait LivechatUnitMonitors.removeByMonitorId(user._id);\n\n\t\treturn true;\n\t},\n\n\tasync removeUnit(_id: string) {\n\t\tcheck(_id, String);\n\n\t\tconst unit = await LivechatUnit.findOneById(_id, { projection: { _id: 1 } });\n\n\t\tif (!unit) {\n\t\t\tthrow new Meteor.Error('unit-not-found', 'Unit not found', { method: 'livechat:removeUnit' });\n\t\t}\n\n\t\treturn LivechatUnit.removeById(_id);\n\t},\n\n\tasync saveUnit(\n\t\t_id: string | null,\n\t\tunitData: Omit<IOmnichannelBusinessUnit, '_id'>,\n\t\tunitMonitors: { monitorId: string; username: string },\n\t\tunitDepartments: { departmentId: string }[],\n\t) {\n\t\tcheck(_id, Match.Maybe(String));\n\n\t\tcheck(unitData, {\n\t\t\tname: String,\n\t\t\tvisibility: String,\n\t\t\tenabled: Match.Optional(Boolean),\n\t\t\tdescription: Match.Optional(String),\n\t\t\temail: Match.Optional(String),\n\t\t\tshowOnOfflineForm: Match.Optional(Boolean),\n\t\t});\n\n\t\tcheck(unitMonitors, [\n\t\t\tMatch.ObjectIncluding({\n\t\t\t\tmonitorId: String,\n\t\t\t\tusername: String,\n\t\t\t}),\n\t\t]);\n\n\t\tcheck(unitDepartments, [\n\t\t\tMatch.ObjectIncluding({\n\t\t\t\tdepartmentId: String,\n\t\t\t}),\n\t\t]);\n\n\t\tlet ancestors: string[] = [];\n\t\tif (_id) {\n\t\t\tconst unit = await LivechatUnit.findOneById(_id);\n\t\t\tif (!unit) {\n\t\t\t\tthrow new Meteor.Error('error-unit-not-found', 'Unit not found', {\n\t\t\t\t\tmethod: 'livechat:saveUnit',\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tancestors = unit.ancestors || [];\n\t\t}\n\n\t\tconst validUserMonitors = await Users.findUsersInRolesWithQuery(\n\t\t\t'livechat-monitor',\n\t\t\t{ _id: { $in: unitMonitors.map(({ monitorId }) => monitorId) } },\n\t\t\t{ projection: { _id: 1, username: 1 } },\n\t\t).toArray();\n\n\t\tconst monitors = validUserMonitors.map(({ _id: monitorId, username }) => ({\n\t\t\tmonitorId,\n\t\t\tusername,\n\t\t})) as { monitorId: string; username: string }[];\n\n\t\treturn LivechatUnit.createOrUpdateUnit(_id, unitData, ancestors, monitors, unitDepartments);\n\t},\n\n\tasync removeTag(_id: string) {\n\t\tcheck(_id, String);\n\n\t\tconst tag = await LivechatTag.findOneById(_id, { projection: { _id: 1, name: 1 } });\n\n\t\tif (!tag) {\n\t\t\tthrow new Meteor.Error('tag-not-found', 'Tag not found', { method: 'livechat:removeTag' });\n\t\t}\n\n\t\tawait callbacks.run('livechat.afterTagRemoved', tag);\n\t\treturn LivechatTag.removeById(_id);\n\t},\n\n\tasync saveTag(_id: string | undefined, tagData: { name: string; description?: string }, tagDepartments: string[]) {\n\t\tcheck(_id, Match.Maybe(String));\n\n\t\tcheck(tagData, {\n\t\t\tname: String,\n\t\t\tdescription: Match.Optional(String),\n\t\t});\n\n\t\tcheck(tagDepartments, [String]);\n\n\t\treturn LivechatTag.createOrUpdateTag(_id, tagData, tagDepartments);\n\t},\n\n\tasync saveSLA(_id: string | null, slaData: Pick<IOmnichannelServiceLevelAgreements, 'name' | 'description' | 'dueTimeInMinutes'>) {\n\t\tconst oldSLA = _id && (await OmnichannelServiceLevelAgreements.findOneById(_id, { projection: { dueTimeInMinutes: 1 } }));\n\t\tconst exists = await OmnichannelServiceLevelAgreements.findDuplicate(_id, slaData.name, slaData.dueTimeInMinutes);\n\t\tif (exists) {\n\t\t\tthrow new Error('error-duplicated-sla');\n\t\t}\n\n\t\tconst sla = await OmnichannelServiceLevelAgreements.createOrUpdatePriority(slaData, _id);\n\t\tif (!oldSLA) {\n\t\t\treturn sla;\n\t\t}\n\n\t\tconst { dueTimeInMinutes: oldDueTimeInMinutes } = oldSLA;\n\t\tconst { dueTimeInMinutes } = sla;\n\n\t\tif (oldDueTimeInMinutes !== dueTimeInMinutes) {\n\t\t\tawait updateSLAInquiries(sla);\n\t\t}\n\n\t\treturn sla;\n\t},\n\n\tasync removeSLA(_id: string) {\n\t\tconst sla = await OmnichannelServiceLevelAgreements.findOneById(_id, { projection: { _id: 1 } });\n\t\tif (!sla) {\n\t\t\tthrow new Error(`SLA with id ${_id} not found`);\n\t\t}\n\n\t\tconst removedResult = await OmnichannelServiceLevelAgreements.removeById(_id);\n\t\tif (!removedResult || removedResult.deletedCount !== 1) {\n\t\t\tthrow new Error(`Error removing SLA with id ${_id}`);\n\t\t}\n\n\t\tawait removeSLAFromRooms(_id);\n\t},\n};\n"],"mappings":"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","ignoreList":[]},"sourceType":"module","externalDependencies":{},"hash":"5f6510823d25e25a01b52b912b50c4e01b0a815f"}
