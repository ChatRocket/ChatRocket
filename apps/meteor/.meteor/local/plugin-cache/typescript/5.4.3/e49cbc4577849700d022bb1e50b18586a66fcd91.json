{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/app/oauth2-server-config/server/oauth/oauth2-server.ts","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","topLevelAwait","objectRestSpread","objectRestSpread","asyncGenerators","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"os.osx.arm64"},"sourceFileName":"app/oauth2-server-config/server/oauth/oauth2-server.ts","filename":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/app/oauth2-server-config/server/oauth/oauth2-server.ts","inputSourceMap":{"version":3,"file":"app/oauth2-server-config/server/oauth/oauth2-server.ts","sourceRoot":"","sources":["app/oauth2-server-config/server/oauth/oauth2-server.ts"],"names":[],"mappings":"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","sourcesContent":["import type { IUser } from '@rocket.chat/core-typings';\nimport { OAuthAccessTokens, Users } from '@rocket.chat/models';\nimport type { Request, Response } from 'express';\nimport { Meteor } from 'meteor/meteor';\nimport { WebApp } from 'meteor/webapp';\n\nimport { OAuth2Server } from '../../../../server/oauth2-server/oauth';\nimport { API } from '../../../api/server';\n\nconst oauth2server = new OAuth2Server({\n\t// If you're developing something related to oauth servers, you should change this to true\n\tdebug: false,\n});\n\n// https://github.com/RocketChat/rocketchat-oauth2-server/blob/e758fd7ef69348c7ceceabe241747a986c32d036/model.coffee#L27-L27\nasync function getAccessToken(accessToken: string) {\n\treturn OAuthAccessTokens.findOneByAccessToken(accessToken);\n}\n\nexport async function oAuth2ServerAuth(partialRequest: {\n\theaders: Record<string, any>;\n\tquery: Record<string, any>;\n}): Promise<{ user: IUser } | undefined> {\n\tconst headerToken = partialRequest.headers.authorization?.replace('Bearer ', '');\n\tconst queryToken = partialRequest.query.access_token;\n\n\tconst accessToken = await getAccessToken(headerToken || queryToken);\n\n\t// If there is no token available or the token has expired, return undefined\n\tif (!accessToken || (accessToken.expires != null && accessToken.expires < new Date())) {\n\t\treturn;\n\t}\n\n\tconst user = await Users.findOneById(accessToken.userId);\n\n\tif (user == null) {\n\t\treturn;\n\t}\n\n\treturn { user };\n}\n\noauth2server.app.disable('x-powered-by');\n\nWebApp.connectHandlers.use(oauth2server.app);\n\noauth2server.app.get('/oauth/userinfo', async (req: Request, res: Response) => {\n\tif (req.headers.authorization == null) {\n\t\treturn res.status(401).send('No token');\n\t}\n\tconst accessToken = req.headers.authorization.replace('Bearer ', '');\n\tconst token = await getAccessToken(accessToken);\n\tif (token == null) {\n\t\treturn res.status(401).send('Invalid Token');\n\t}\n\tconst user = await Users.findOneById(token.userId);\n\tif (user == null) {\n\t\treturn res.status(401).send('Invalid Token');\n\t}\n\treturn res.send({\n\t\tsub: user._id,\n\t\tname: user.name,\n\t\temail: user.emails?.[0].address,\n\t\temail_verified: user.emails?.[0].verified,\n\t\tdepartment: '',\n\t\tbirthdate: '',\n\t\tpreffered_username: user.username,\n\t\tupdated_at: user._updatedAt,\n\t\tpicture: `${Meteor.absoluteUrl()}avatar/${user.username}`,\n\t});\n});\n\nAPI.v1.addAuthMethod(async function () {\n\treturn oAuth2ServerAuth(this.request);\n});\n"]},"targets":{"android":"125.0.0","chrome":"125.0.0","edge":"125.0.0","firefox":"115.0.0","ie":"10.0.0","ios":"17.4.0","opera":"110.0.0","opera_mobile":"80.0.0","safari":"17.4.0","samsung":"24.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor","root":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":false,"enforceStrictMode":false,"dynamicImport":true,"generateLetDeclarations":true,"topLevelAwait":true},"externalDependencies":[]},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"version":"7.17.2","helpers":true,"useESModules":false,"corejs":false},"externalDependencies":[]},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-async-generator-functions","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-class-properties","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true},"externalDependencies":[]},{"key":"transform-react-jsx","visitor":{"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXFragment":{"exit":[null]},"JSXElement":{"exit":[null]},"JSXAttribute":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false},"externalDependencies":[]},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-nullish-coalescing-operator","visitor":{"LogicalExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-optional-chaining","visitor":{"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-optional-catch-binding","visitor":{"CatchClause":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-class-properties","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-async-generator-functions","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-logical-assignment-operators","visitor":{"AssignmentExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]}],"presets":[],"generatorOpts":{"filename":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/app/oauth2-server-config/server/oauth/oauth2-server.ts","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"app/oauth2-server-config/server/oauth/oauth2-server.ts","inputSourceMap":{"version":3,"file":"app/oauth2-server-config/server/oauth/oauth2-server.ts","sourceRoot":"","sources":["app/oauth2-server-config/server/oauth/oauth2-server.ts"],"names":[],"mappings":"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","sourcesContent":["import type { IUser } from '@rocket.chat/core-typings';\nimport { OAuthAccessTokens, Users } from '@rocket.chat/models';\nimport type { Request, Response } from 'express';\nimport { Meteor } from 'meteor/meteor';\nimport { WebApp } from 'meteor/webapp';\n\nimport { OAuth2Server } from '../../../../server/oauth2-server/oauth';\nimport { API } from '../../../api/server';\n\nconst oauth2server = new OAuth2Server({\n\t// If you're developing something related to oauth servers, you should change this to true\n\tdebug: false,\n});\n\n// https://github.com/RocketChat/rocketchat-oauth2-server/blob/e758fd7ef69348c7ceceabe241747a986c32d036/model.coffee#L27-L27\nasync function getAccessToken(accessToken: string) {\n\treturn OAuthAccessTokens.findOneByAccessToken(accessToken);\n}\n\nexport async function oAuth2ServerAuth(partialRequest: {\n\theaders: Record<string, any>;\n\tquery: Record<string, any>;\n}): Promise<{ user: IUser } | undefined> {\n\tconst headerToken = partialRequest.headers.authorization?.replace('Bearer ', '');\n\tconst queryToken = partialRequest.query.access_token;\n\n\tconst accessToken = await getAccessToken(headerToken || queryToken);\n\n\t// If there is no token available or the token has expired, return undefined\n\tif (!accessToken || (accessToken.expires != null && accessToken.expires < new Date())) {\n\t\treturn;\n\t}\n\n\tconst user = await Users.findOneById(accessToken.userId);\n\n\tif (user == null) {\n\t\treturn;\n\t}\n\n\treturn { user };\n}\n\noauth2server.app.disable('x-powered-by');\n\nWebApp.connectHandlers.use(oauth2server.app);\n\noauth2server.app.get('/oauth/userinfo', async (req: Request, res: Response) => {\n\tif (req.headers.authorization == null) {\n\t\treturn res.status(401).send('No token');\n\t}\n\tconst accessToken = req.headers.authorization.replace('Bearer ', '');\n\tconst token = await getAccessToken(accessToken);\n\tif (token == null) {\n\t\treturn res.status(401).send('Invalid Token');\n\t}\n\tconst user = await Users.findOneById(token.userId);\n\tif (user == null) {\n\t\treturn res.status(401).send('Invalid Token');\n\t}\n\treturn res.send({\n\t\tsub: user._id,\n\t\tname: user.name,\n\t\temail: user.emails?.[0].address,\n\t\temail_verified: user.emails?.[0].verified,\n\t\tdepartment: '',\n\t\tbirthdate: '',\n\t\tpreffered_username: user.username,\n\t\tupdated_at: user._updatedAt,\n\t\tpicture: `${Meteor.absoluteUrl()}avatar/${user.username}`,\n\t});\n});\n\nAPI.v1.addAuthMethod(async function () {\n\treturn oAuth2ServerAuth(this.request);\n});\n"]}}},"code":"!module.wrapAsync(async function (module, __reifyWaitForDeps__, __reify_async_result__) {\n  \"use strict\";\n  try {\n    module.export({\n      oAuth2ServerAuth: () => oAuth2ServerAuth\n    });\n    let OAuthAccessTokens, Users;\n    module.link(\"@rocket.chat/models\", {\n      OAuthAccessTokens(v) {\n        OAuthAccessTokens = v;\n      },\n      Users(v) {\n        Users = v;\n      }\n    }, 0);\n    let Meteor;\n    module.link(\"meteor/meteor\", {\n      Meteor(v) {\n        Meteor = v;\n      }\n    }, 1);\n    let WebApp;\n    module.link(\"meteor/webapp\", {\n      WebApp(v) {\n        WebApp = v;\n      }\n    }, 2);\n    let OAuth2Server;\n    module.link(\"../../../../server/oauth2-server/oauth\", {\n      OAuth2Server(v) {\n        OAuth2Server = v;\n      }\n    }, 3);\n    let API;\n    module.link(\"../../../api/server\", {\n      API(v) {\n        API = v;\n      }\n    }, 4);\n    if (__reifyWaitForDeps__()) (await __reifyWaitForDeps__())();\n    const oauth2server = new OAuth2Server({\n      // If you're developing something related to oauth servers, you should change this to true\n      debug: false\n    });\n    // https://github.com/RocketChat/rocketchat-oauth2-server/blob/e758fd7ef69348c7ceceabe241747a986c32d036/model.coffee#L27-L27\n    async function getAccessToken(accessToken) {\n      return OAuthAccessTokens.findOneByAccessToken(accessToken);\n    }\n    async function oAuth2ServerAuth(partialRequest) {\n      var _partialRequest$heade;\n      const headerToken = (_partialRequest$heade = partialRequest.headers.authorization) === null || _partialRequest$heade === void 0 ? void 0 : _partialRequest$heade.replace('Bearer ', '');\n      const queryToken = partialRequest.query.access_token;\n      const accessToken = await getAccessToken(headerToken || queryToken);\n      // If there is no token available or the token has expired, return undefined\n      if (!accessToken || accessToken.expires != null && accessToken.expires < new Date()) {\n        return;\n      }\n      const user = await Users.findOneById(accessToken.userId);\n      if (user == null) {\n        return;\n      }\n      return {\n        user\n      };\n    }\n    oauth2server.app.disable('x-powered-by');\n    WebApp.connectHandlers.use(oauth2server.app);\n    oauth2server.app.get('/oauth/userinfo', async (req, res) => {\n      var _user$emails, _user$emails2;\n      if (req.headers.authorization == null) {\n        return res.status(401).send('No token');\n      }\n      const accessToken = req.headers.authorization.replace('Bearer ', '');\n      const token = await getAccessToken(accessToken);\n      if (token == null) {\n        return res.status(401).send('Invalid Token');\n      }\n      const user = await Users.findOneById(token.userId);\n      if (user == null) {\n        return res.status(401).send('Invalid Token');\n      }\n      return res.send({\n        sub: user._id,\n        name: user.name,\n        email: (_user$emails = user.emails) === null || _user$emails === void 0 ? void 0 : _user$emails[0].address,\n        email_verified: (_user$emails2 = user.emails) === null || _user$emails2 === void 0 ? void 0 : _user$emails2[0].verified,\n        department: '',\n        birthdate: '',\n        preffered_username: user.username,\n        updated_at: user._updatedAt,\n        picture: \"\".concat(Meteor.absoluteUrl(), \"avatar/\").concat(user.username)\n      });\n    });\n    API.v1.addAuthMethod(async function () {\n      return oAuth2ServerAuth(this.request);\n    });\n    __reify_async_result__();\n  } catch (_reifyError) {\n    return __reify_async_result__(_reifyError);\n  }\n  __reify_async_result__()\n}, {\n  self: this,\n  async: false\n});","map":{"version":3,"names":["module","export","oAuth2ServerAuth","OAuthAccessTokens","Users","link","v","Meteor","WebApp","OAuth2Server","API","__reifyWaitForDeps__","oauth2server","debug","getAccessToken","accessToken","findOneByAccessToken","partialRequest","_partialRequest$heade","headerToken","headers","authorization","replace","queryToken","query","access_token","expires","Date","user","findOneById","userId","app","disable","connectHandlers","use","get","req","res","_user$emails","_user$emails2","status","send","token","sub","_id","name","email","emails","address","email_verified","verified","department","birthdate","preffered_username","username","updated_at","_updatedAt","picture","concat","absoluteUrl","v1","addAuthMethod","request","__reify_async_result__","_reifyError","self","async"],"sources":["app/oauth2-server-config/server/oauth/oauth2-server.ts"],"sourcesContent":["import type { IUser } from '@rocket.chat/core-typings';\nimport { OAuthAccessTokens, Users } from '@rocket.chat/models';\nimport type { Request, Response } from 'express';\nimport { Meteor } from 'meteor/meteor';\nimport { WebApp } from 'meteor/webapp';\n\nimport { OAuth2Server } from '../../../../server/oauth2-server/oauth';\nimport { API } from '../../../api/server';\n\nconst oauth2server = new OAuth2Server({\n\t// If you're developing something related to oauth servers, you should change this to true\n\tdebug: false,\n});\n\n// https://github.com/RocketChat/rocketchat-oauth2-server/blob/e758fd7ef69348c7ceceabe241747a986c32d036/model.coffee#L27-L27\nasync function getAccessToken(accessToken: string) {\n\treturn OAuthAccessTokens.findOneByAccessToken(accessToken);\n}\n\nexport async function oAuth2ServerAuth(partialRequest: {\n\theaders: Record<string, any>;\n\tquery: Record<string, any>;\n}): Promise<{ user: IUser } | undefined> {\n\tconst headerToken = partialRequest.headers.authorization?.replace('Bearer ', '');\n\tconst queryToken = partialRequest.query.access_token;\n\n\tconst accessToken = await getAccessToken(headerToken || queryToken);\n\n\t// If there is no token available or the token has expired, return undefined\n\tif (!accessToken || (accessToken.expires != null && accessToken.expires < new Date())) {\n\t\treturn;\n\t}\n\n\tconst user = await Users.findOneById(accessToken.userId);\n\n\tif (user == null) {\n\t\treturn;\n\t}\n\n\treturn { user };\n}\n\noauth2server.app.disable('x-powered-by');\n\nWebApp.connectHandlers.use(oauth2server.app);\n\noauth2server.app.get('/oauth/userinfo', async (req: Request, res: Response) => {\n\tif (req.headers.authorization == null) {\n\t\treturn res.status(401).send('No token');\n\t}\n\tconst accessToken = req.headers.authorization.replace('Bearer ', '');\n\tconst token = await getAccessToken(accessToken);\n\tif (token == null) {\n\t\treturn res.status(401).send('Invalid Token');\n\t}\n\tconst user = await Users.findOneById(token.userId);\n\tif (user == null) {\n\t\treturn res.status(401).send('Invalid Token');\n\t}\n\treturn res.send({\n\t\tsub: user._id,\n\t\tname: user.name,\n\t\temail: user.emails?.[0].address,\n\t\temail_verified: user.emails?.[0].verified,\n\t\tdepartment: '',\n\t\tbirthdate: '',\n\t\tpreffered_username: user.username,\n\t\tupdated_at: user._updatedAt,\n\t\tpicture: `${Meteor.absoluteUrl()}avatar/${user.username}`,\n\t});\n});\n\nAPI.v1.addAuthMethod(async function () {\n\treturn oAuth2ServerAuth(this.request);\n});\n"],"mappings":"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","ignoreList":[]},"sourceType":"module","externalDependencies":{},"hash":"e49cbc4577849700d022bb1e50b18586a66fcd91"}
