{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/server/oauth2-server/oauth.ts","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","topLevelAwait","objectRestSpread","objectRestSpread","asyncGenerators","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"os.osx.arm64"},"sourceFileName":"server/oauth2-server/oauth.ts","filename":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/server/oauth2-server/oauth.ts","inputSourceMap":{"version":3,"file":"server/oauth2-server/oauth.ts","sourceRoot":"","sources":["server/oauth2-server/oauth.ts"],"names":[],"mappings":"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","sourcesContent":["import { OAuthApps, Users } from '@rocket.chat/models';\nimport express from 'express';\nimport type { Express, NextFunction, Request, Response } from 'express';\nimport { Accounts } from 'meteor/accounts-base';\nimport OAuthServer, { OAuthError, UnauthorizedRequestError } from 'oauth2-server';\n\nimport type { ModelConfig } from './model';\nimport { Model } from './model';\n\nexport class OAuth2Server {\n\tpublic app: Express;\n\n\tprivate oauth: OAuthServer;\n\n\tprivate config: ModelConfig;\n\n\tconstructor(config: ModelConfig) {\n\t\tif (config == null) {\n\t\t\tconfig = {};\n\t\t}\n\n\t\tthis.config = config;\n\t\tthis.app = express();\n\n\t\tthis.oauth = new OAuthServer({\n\t\t\tmodel: new Model(this.config),\n\t\t});\n\n\t\tthis.initRoutes();\n\n\t\treturn this;\n\t}\n\n\tinitRoutes() {\n\t\tconst { config, oauth } = this;\n\n\t\tconst debugMiddleware = function (req: Request, _res: Response, next: NextFunction) {\n\t\t\tif (config.debug === true) {\n\t\t\t\tconsole.log('[OAuth2Server]', req.method, req.url);\n\t\t\t}\n\t\t\treturn next();\n\t\t};\n\n\t\tconst handleResponse = function (res: Response, response: OAuthServer.Response, next: NextFunction) {\n\t\t\tif (response.status === 302 && response.headers?.location) {\n\t\t\t\tconst { location } = response.headers;\n\t\t\t\tdelete response.headers.location;\n\t\t\t\tres.set(response.headers);\n\t\t\t\tres.redirect(location);\n\t\t\t} else if (response.status) {\n\t\t\t\tres.set(response.headers);\n\t\t\t\tres.status(response.status).send(response.body);\n\t\t\t} else {\n\t\t\t\tnext();\n\t\t\t}\n\t\t};\n\n\t\t// Transforms requests which are POST and aren't \"x-www-form-urlencoded\" content type\n\t\t// and they pass the required information as query strings\n\t\tconst transformRequestsNotUsingFormUrlencodedType = function (req: Request, _res: Response, next: NextFunction) {\n\t\t\tif (!req.is('application/x-www-form-urlencoded') && req.method === 'POST') {\n\t\t\t\tif (config.debug === true) {\n\t\t\t\t\tconsole.log('[OAuth2Server]', 'Transforming a request to form-urlencoded with the query going to the body.');\n\t\t\t\t}\n\t\t\t\treq.headers['content-type'] = 'application/x-www-form-urlencoded';\n\t\t\t\treq.body = Object.assign({}, req.body, req.query);\n\t\t\t}\n\t\t\treturn next();\n\t\t};\n\n\t\tthis.app.all('/oauth/token', debugMiddleware, transformRequestsNotUsingFormUrlencodedType, async (req, res, next) => {\n\t\t\tconst request = new OAuthServer.Request(req);\n\t\t\tconst response = new OAuthServer.Response(res);\n\n\t\t\ttry {\n\t\t\t\tawait oauth.token(request, response);\n\n\t\t\t\thandleResponse(res, response, next);\n\t\t\t} catch (e: any) {\n\t\t\t\tnext(e);\n\t\t\t}\n\t\t});\n\n\t\tthis.app.get('/oauth/authorize', debugMiddleware, async (req, res, next) => {\n\t\t\tif (typeof req.query.client_id !== 'string') {\n\t\t\t\treturn res.redirect('/oauth/error/404');\n\t\t\t}\n\n\t\t\tconst client = await OAuthApps.findOneActiveByClientId(req.query.client_id);\n\t\t\tif (client == null) {\n\t\t\t\treturn res.redirect('/oauth/error/404');\n\t\t\t}\n\n\t\t\tconst redirectUris: string[] = client.redirectUri.split(',');\n\n\t\t\tif (typeof req.query.redirect_uri === 'string' && !redirectUris.includes(req.query.redirect_uri)) {\n\t\t\t\treturn res.redirect('/oauth/error/invalid_redirect_uri');\n\t\t\t}\n\n\t\t\treturn next();\n\t\t});\n\n\t\tthis.app.post('/oauth/authorize', debugMiddleware, async (req, res, next) => {\n\t\t\tif (req.body.allow !== 'yes') {\n\t\t\t\tres.status(401);\n\t\t\t\treturn res.send({ error: 'access_denied', error_description: 'The user denied access to your application' });\n\t\t\t}\n\n\t\t\t// The new version of the library is expecting a new name. Doing this for compatibility\n\t\t\tif (req.body.token && !req.body.access_token) {\n\t\t\t\treq.body.access_token = req.body.token;\n\t\t\t}\n\n\t\t\tif (req.body.access_token == null) {\n\t\t\t\treturn res.status(401).send('No token');\n\t\t\t}\n\n\t\t\tconst user = await Users.findOne(\n\t\t\t\t{\n\t\t\t\t\t'services.resume.loginTokens.hashedToken': Accounts._hashLoginToken(req.body.access_token),\n\t\t\t\t},\n\t\t\t\t{ projection: { _id: 1 } },\n\t\t\t);\n\n\t\t\tif (user == null) {\n\t\t\t\treturn res.status(401).send('Invalid token');\n\t\t\t}\n\n\t\t\tres.locals.user = { id: user._id };\n\n\t\t\treturn next();\n\t\t});\n\n\t\tthis.app.post('/oauth/authorize', debugMiddleware, async (req: Request, res: Response, next: NextFunction) => {\n\t\t\tconst request = new OAuthServer.Request(req);\n\t\t\tconst response = new OAuthServer.Response(res);\n\n\t\t\ttry {\n\t\t\t\tawait oauth.authorize(request, response, {\n\t\t\t\t\tauthenticateHandler: {\n\t\t\t\t\t\tasync handle() {\n\t\t\t\t\t\t\tconst clientId = request.body.client_id || request.query?.client_id;\n\n\t\t\t\t\t\t\tif (!clientId) {\n\t\t\t\t\t\t\t\tthrow new Error('Missing parameter: `client_id`');\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\tif (req.body.allow === 'yes') {\n\t\t\t\t\t\t\t\tawait Users.updateOne({ _id: res.locals.user.id }, { $addToSet: { 'oauth.authorizedClients': clientId } });\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\treturn { id: res.locals.user.id };\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t});\n\n\t\t\t\thandleResponse(res, response, next);\n\t\t\t} catch (e: any) {\n\t\t\t\tnext(e);\n\t\t\t}\n\t\t});\n\n\t\tthis.app.use('/oauth/*', (err: Error, _req: Request, res: Response, next: NextFunction) => {\n\t\t\tif (!(err instanceof OAuthError)) return next(err);\n\n\t\t\tdelete err.stack;\n\n\t\t\tres.status(err.code);\n\n\t\t\tif (err instanceof UnauthorizedRequestError) {\n\t\t\t\treturn res.send();\n\t\t\t}\n\n\t\t\tres.send({ error: err.name, error_description: err.message });\n\t\t});\n\t}\n}\n"]},"targets":{"android":"125.0.0","chrome":"125.0.0","edge":"125.0.0","firefox":"115.0.0","ie":"10.0.0","ios":"17.4.0","opera":"110.0.0","opera_mobile":"80.0.0","safari":"17.4.0","samsung":"24.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor","root":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":false,"enforceStrictMode":false,"dynamicImport":true,"generateLetDeclarations":true,"topLevelAwait":true},"externalDependencies":[]},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"version":"7.17.2","helpers":true,"useESModules":false,"corejs":false},"externalDependencies":[]},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-async-generator-functions","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-class-properties","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true},"externalDependencies":[]},{"key":"transform-react-jsx","visitor":{"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXFragment":{"exit":[null]},"JSXElement":{"exit":[null]},"JSXAttribute":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false},"externalDependencies":[]},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-nullish-coalescing-operator","visitor":{"LogicalExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-optional-chaining","visitor":{"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-optional-catch-binding","visitor":{"CatchClause":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-class-properties","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-async-generator-functions","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-logical-assignment-operators","visitor":{"AssignmentExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]}],"presets":[],"generatorOpts":{"filename":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/server/oauth2-server/oauth.ts","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"server/oauth2-server/oauth.ts","inputSourceMap":{"version":3,"file":"server/oauth2-server/oauth.ts","sourceRoot":"","sources":["server/oauth2-server/oauth.ts"],"names":[],"mappings":"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","sourcesContent":["import { OAuthApps, Users } from '@rocket.chat/models';\nimport express from 'express';\nimport type { Express, NextFunction, Request, Response } from 'express';\nimport { Accounts } from 'meteor/accounts-base';\nimport OAuthServer, { OAuthError, UnauthorizedRequestError } from 'oauth2-server';\n\nimport type { ModelConfig } from './model';\nimport { Model } from './model';\n\nexport class OAuth2Server {\n\tpublic app: Express;\n\n\tprivate oauth: OAuthServer;\n\n\tprivate config: ModelConfig;\n\n\tconstructor(config: ModelConfig) {\n\t\tif (config == null) {\n\t\t\tconfig = {};\n\t\t}\n\n\t\tthis.config = config;\n\t\tthis.app = express();\n\n\t\tthis.oauth = new OAuthServer({\n\t\t\tmodel: new Model(this.config),\n\t\t});\n\n\t\tthis.initRoutes();\n\n\t\treturn this;\n\t}\n\n\tinitRoutes() {\n\t\tconst { config, oauth } = this;\n\n\t\tconst debugMiddleware = function (req: Request, _res: Response, next: NextFunction) {\n\t\t\tif (config.debug === true) {\n\t\t\t\tconsole.log('[OAuth2Server]', req.method, req.url);\n\t\t\t}\n\t\t\treturn next();\n\t\t};\n\n\t\tconst handleResponse = function (res: Response, response: OAuthServer.Response, next: NextFunction) {\n\t\t\tif (response.status === 302 && response.headers?.location) {\n\t\t\t\tconst { location } = response.headers;\n\t\t\t\tdelete response.headers.location;\n\t\t\t\tres.set(response.headers);\n\t\t\t\tres.redirect(location);\n\t\t\t} else if (response.status) {\n\t\t\t\tres.set(response.headers);\n\t\t\t\tres.status(response.status).send(response.body);\n\t\t\t} else {\n\t\t\t\tnext();\n\t\t\t}\n\t\t};\n\n\t\t// Transforms requests which are POST and aren't \"x-www-form-urlencoded\" content type\n\t\t// and they pass the required information as query strings\n\t\tconst transformRequestsNotUsingFormUrlencodedType = function (req: Request, _res: Response, next: NextFunction) {\n\t\t\tif (!req.is('application/x-www-form-urlencoded') && req.method === 'POST') {\n\t\t\t\tif (config.debug === true) {\n\t\t\t\t\tconsole.log('[OAuth2Server]', 'Transforming a request to form-urlencoded with the query going to the body.');\n\t\t\t\t}\n\t\t\t\treq.headers['content-type'] = 'application/x-www-form-urlencoded';\n\t\t\t\treq.body = Object.assign({}, req.body, req.query);\n\t\t\t}\n\t\t\treturn next();\n\t\t};\n\n\t\tthis.app.all('/oauth/token', debugMiddleware, transformRequestsNotUsingFormUrlencodedType, async (req, res, next) => {\n\t\t\tconst request = new OAuthServer.Request(req);\n\t\t\tconst response = new OAuthServer.Response(res);\n\n\t\t\ttry {\n\t\t\t\tawait oauth.token(request, response);\n\n\t\t\t\thandleResponse(res, response, next);\n\t\t\t} catch (e: any) {\n\t\t\t\tnext(e);\n\t\t\t}\n\t\t});\n\n\t\tthis.app.get('/oauth/authorize', debugMiddleware, async (req, res, next) => {\n\t\t\tif (typeof req.query.client_id !== 'string') {\n\t\t\t\treturn res.redirect('/oauth/error/404');\n\t\t\t}\n\n\t\t\tconst client = await OAuthApps.findOneActiveByClientId(req.query.client_id);\n\t\t\tif (client == null) {\n\t\t\t\treturn res.redirect('/oauth/error/404');\n\t\t\t}\n\n\t\t\tconst redirectUris: string[] = client.redirectUri.split(',');\n\n\t\t\tif (typeof req.query.redirect_uri === 'string' && !redirectUris.includes(req.query.redirect_uri)) {\n\t\t\t\treturn res.redirect('/oauth/error/invalid_redirect_uri');\n\t\t\t}\n\n\t\t\treturn next();\n\t\t});\n\n\t\tthis.app.post('/oauth/authorize', debugMiddleware, async (req, res, next) => {\n\t\t\tif (req.body.allow !== 'yes') {\n\t\t\t\tres.status(401);\n\t\t\t\treturn res.send({ error: 'access_denied', error_description: 'The user denied access to your application' });\n\t\t\t}\n\n\t\t\t// The new version of the library is expecting a new name. Doing this for compatibility\n\t\t\tif (req.body.token && !req.body.access_token) {\n\t\t\t\treq.body.access_token = req.body.token;\n\t\t\t}\n\n\t\t\tif (req.body.access_token == null) {\n\t\t\t\treturn res.status(401).send('No token');\n\t\t\t}\n\n\t\t\tconst user = await Users.findOne(\n\t\t\t\t{\n\t\t\t\t\t'services.resume.loginTokens.hashedToken': Accounts._hashLoginToken(req.body.access_token),\n\t\t\t\t},\n\t\t\t\t{ projection: { _id: 1 } },\n\t\t\t);\n\n\t\t\tif (user == null) {\n\t\t\t\treturn res.status(401).send('Invalid token');\n\t\t\t}\n\n\t\t\tres.locals.user = { id: user._id };\n\n\t\t\treturn next();\n\t\t});\n\n\t\tthis.app.post('/oauth/authorize', debugMiddleware, async (req: Request, res: Response, next: NextFunction) => {\n\t\t\tconst request = new OAuthServer.Request(req);\n\t\t\tconst response = new OAuthServer.Response(res);\n\n\t\t\ttry {\n\t\t\t\tawait oauth.authorize(request, response, {\n\t\t\t\t\tauthenticateHandler: {\n\t\t\t\t\t\tasync handle() {\n\t\t\t\t\t\t\tconst clientId = request.body.client_id || request.query?.client_id;\n\n\t\t\t\t\t\t\tif (!clientId) {\n\t\t\t\t\t\t\t\tthrow new Error('Missing parameter: `client_id`');\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\tif (req.body.allow === 'yes') {\n\t\t\t\t\t\t\t\tawait Users.updateOne({ _id: res.locals.user.id }, { $addToSet: { 'oauth.authorizedClients': clientId } });\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\treturn { id: res.locals.user.id };\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t});\n\n\t\t\t\thandleResponse(res, response, next);\n\t\t\t} catch (e: any) {\n\t\t\t\tnext(e);\n\t\t\t}\n\t\t});\n\n\t\tthis.app.use('/oauth/*', (err: Error, _req: Request, res: Response, next: NextFunction) => {\n\t\t\tif (!(err instanceof OAuthError)) return next(err);\n\n\t\t\tdelete err.stack;\n\n\t\t\tres.status(err.code);\n\n\t\t\tif (err instanceof UnauthorizedRequestError) {\n\t\t\t\treturn res.send();\n\t\t\t}\n\n\t\t\tres.send({ error: err.name, error_description: err.message });\n\t\t});\n\t}\n}\n"]}}},"code":"!module.wrapAsync(async function (module, __reifyWaitForDeps__, __reify_async_result__) {\n  \"use strict\";\n  try {\n    module.export({\n      OAuth2Server: () => OAuth2Server\n    });\n    let OAuthApps, Users;\n    module.link(\"@rocket.chat/models\", {\n      OAuthApps(v) {\n        OAuthApps = v;\n      },\n      Users(v) {\n        Users = v;\n      }\n    }, 0);\n    let express;\n    module.link(\"express\", {\n      default(v) {\n        express = v;\n      }\n    }, 1);\n    let Accounts;\n    module.link(\"meteor/accounts-base\", {\n      Accounts(v) {\n        Accounts = v;\n      }\n    }, 2);\n    let OAuthServer, OAuthError, UnauthorizedRequestError;\n    module.link(\"oauth2-server\", {\n      default(v) {\n        OAuthServer = v;\n      },\n      OAuthError(v) {\n        OAuthError = v;\n      },\n      UnauthorizedRequestError(v) {\n        UnauthorizedRequestError = v;\n      }\n    }, 3);\n    let Model;\n    module.link(\"./model\", {\n      Model(v) {\n        Model = v;\n      }\n    }, 4);\n    if (__reifyWaitForDeps__()) (await __reifyWaitForDeps__())();\n    class OAuth2Server {\n      constructor(config) {\n        this.app = void 0;\n        this.oauth = void 0;\n        this.config = void 0;\n        if (config == null) {\n          config = {};\n        }\n        this.config = config;\n        this.app = express();\n        this.oauth = new OAuthServer({\n          model: new Model(this.config)\n        });\n        this.initRoutes();\n        return this;\n      }\n      initRoutes() {\n        const {\n          config,\n          oauth\n        } = this;\n        const debugMiddleware = function (req, _res, next) {\n          if (config.debug === true) {\n            console.log('[OAuth2Server]', req.method, req.url);\n          }\n          return next();\n        };\n        const handleResponse = function (res, response, next) {\n          var _response$headers;\n          if (response.status === 302 && (_response$headers = response.headers) !== null && _response$headers !== void 0 && _response$headers.location) {\n            const {\n              location\n            } = response.headers;\n            delete response.headers.location;\n            res.set(response.headers);\n            res.redirect(location);\n          } else if (response.status) {\n            res.set(response.headers);\n            res.status(response.status).send(response.body);\n          } else {\n            next();\n          }\n        };\n        // Transforms requests which are POST and aren't \"x-www-form-urlencoded\" content type\n        // and they pass the required information as query strings\n        const transformRequestsNotUsingFormUrlencodedType = function (req, _res, next) {\n          if (!req.is('application/x-www-form-urlencoded') && req.method === 'POST') {\n            if (config.debug === true) {\n              console.log('[OAuth2Server]', 'Transforming a request to form-urlencoded with the query going to the body.');\n            }\n            req.headers['content-type'] = 'application/x-www-form-urlencoded';\n            req.body = Object.assign({}, req.body, req.query);\n          }\n          return next();\n        };\n        this.app.all('/oauth/token', debugMiddleware, transformRequestsNotUsingFormUrlencodedType, async (req, res, next) => {\n          const request = new OAuthServer.Request(req);\n          const response = new OAuthServer.Response(res);\n          try {\n            await oauth.token(request, response);\n            handleResponse(res, response, next);\n          } catch (e) {\n            next(e);\n          }\n        });\n        this.app.get('/oauth/authorize', debugMiddleware, async (req, res, next) => {\n          if (typeof req.query.client_id !== 'string') {\n            return res.redirect('/oauth/error/404');\n          }\n          const client = await OAuthApps.findOneActiveByClientId(req.query.client_id);\n          if (client == null) {\n            return res.redirect('/oauth/error/404');\n          }\n          const redirectUris = client.redirectUri.split(',');\n          if (typeof req.query.redirect_uri === 'string' && !redirectUris.includes(req.query.redirect_uri)) {\n            return res.redirect('/oauth/error/invalid_redirect_uri');\n          }\n          return next();\n        });\n        this.app.post('/oauth/authorize', debugMiddleware, async (req, res, next) => {\n          if (req.body.allow !== 'yes') {\n            res.status(401);\n            return res.send({\n              error: 'access_denied',\n              error_description: 'The user denied access to your application'\n            });\n          }\n          // The new version of the library is expecting a new name. Doing this for compatibility\n          if (req.body.token && !req.body.access_token) {\n            req.body.access_token = req.body.token;\n          }\n          if (req.body.access_token == null) {\n            return res.status(401).send('No token');\n          }\n          const user = await Users.findOne({\n            'services.resume.loginTokens.hashedToken': Accounts._hashLoginToken(req.body.access_token)\n          }, {\n            projection: {\n              _id: 1\n            }\n          });\n          if (user == null) {\n            return res.status(401).send('Invalid token');\n          }\n          res.locals.user = {\n            id: user._id\n          };\n          return next();\n        });\n        this.app.post('/oauth/authorize', debugMiddleware, async (req, res, next) => {\n          const request = new OAuthServer.Request(req);\n          const response = new OAuthServer.Response(res);\n          try {\n            await oauth.authorize(request, response, {\n              authenticateHandler: {\n                async handle() {\n                  var _request$query;\n                  const clientId = request.body.client_id || ((_request$query = request.query) === null || _request$query === void 0 ? void 0 : _request$query.client_id);\n                  if (!clientId) {\n                    throw new Error('Missing parameter: `client_id`');\n                  }\n                  if (req.body.allow === 'yes') {\n                    await Users.updateOne({\n                      _id: res.locals.user.id\n                    }, {\n                      $addToSet: {\n                        'oauth.authorizedClients': clientId\n                      }\n                    });\n                  }\n                  return {\n                    id: res.locals.user.id\n                  };\n                }\n              }\n            });\n            handleResponse(res, response, next);\n          } catch (e) {\n            next(e);\n          }\n        });\n        this.app.use('/oauth/*', (err, _req, res, next) => {\n          if (!(err instanceof OAuthError)) return next(err);\n          delete err.stack;\n          res.status(err.code);\n          if (err instanceof UnauthorizedRequestError) {\n            return res.send();\n          }\n          res.send({\n            error: err.name,\n            error_description: err.message\n          });\n        });\n      }\n    }\n    __reify_async_result__();\n  } catch (_reifyError) {\n    return __reify_async_result__(_reifyError);\n  }\n  __reify_async_result__()\n}, {\n  self: this,\n  async: false\n});","map":{"version":3,"names":["module","export","OAuth2Server","OAuthApps","Users","link","v","express","default","Accounts","OAuthServer","OAuthError","UnauthorizedRequestError","Model","__reifyWaitForDeps__","constructor","config","app","oauth","model","initRoutes","debugMiddleware","req","_res","next","debug","console","log","method","url","handleResponse","res","response","_response$headers","status","headers","location","set","redirect","send","body","transformRequestsNotUsingFormUrlencodedType","is","Object","assign","query","all","request","Request","Response","token","e","get","client_id","client","findOneActiveByClientId","redirectUris","redirectUri","split","redirect_uri","includes","post","allow","error","error_description","access_token","user","findOne","_hashLoginToken","projection","_id","locals","id","authorize","authenticateHandler","handle","_request$query","clientId","Error","updateOne","$addToSet","use","err","_req","stack","code","name","message","__reify_async_result__","_reifyError","self","async"],"sources":["server/oauth2-server/oauth.ts"],"sourcesContent":["import { OAuthApps, Users } from '@rocket.chat/models';\nimport express from 'express';\nimport type { Express, NextFunction, Request, Response } from 'express';\nimport { Accounts } from 'meteor/accounts-base';\nimport OAuthServer, { OAuthError, UnauthorizedRequestError } from 'oauth2-server';\n\nimport type { ModelConfig } from './model';\nimport { Model } from './model';\n\nexport class OAuth2Server {\n\tpublic app: Express;\n\n\tprivate oauth: OAuthServer;\n\n\tprivate config: ModelConfig;\n\n\tconstructor(config: ModelConfig) {\n\t\tif (config == null) {\n\t\t\tconfig = {};\n\t\t}\n\n\t\tthis.config = config;\n\t\tthis.app = express();\n\n\t\tthis.oauth = new OAuthServer({\n\t\t\tmodel: new Model(this.config),\n\t\t});\n\n\t\tthis.initRoutes();\n\n\t\treturn this;\n\t}\n\n\tinitRoutes() {\n\t\tconst { config, oauth } = this;\n\n\t\tconst debugMiddleware = function (req: Request, _res: Response, next: NextFunction) {\n\t\t\tif (config.debug === true) {\n\t\t\t\tconsole.log('[OAuth2Server]', req.method, req.url);\n\t\t\t}\n\t\t\treturn next();\n\t\t};\n\n\t\tconst handleResponse = function (res: Response, response: OAuthServer.Response, next: NextFunction) {\n\t\t\tif (response.status === 302 && response.headers?.location) {\n\t\t\t\tconst { location } = response.headers;\n\t\t\t\tdelete response.headers.location;\n\t\t\t\tres.set(response.headers);\n\t\t\t\tres.redirect(location);\n\t\t\t} else if (response.status) {\n\t\t\t\tres.set(response.headers);\n\t\t\t\tres.status(response.status).send(response.body);\n\t\t\t} else {\n\t\t\t\tnext();\n\t\t\t}\n\t\t};\n\n\t\t// Transforms requests which are POST and aren't \"x-www-form-urlencoded\" content type\n\t\t// and they pass the required information as query strings\n\t\tconst transformRequestsNotUsingFormUrlencodedType = function (req: Request, _res: Response, next: NextFunction) {\n\t\t\tif (!req.is('application/x-www-form-urlencoded') && req.method === 'POST') {\n\t\t\t\tif (config.debug === true) {\n\t\t\t\t\tconsole.log('[OAuth2Server]', 'Transforming a request to form-urlencoded with the query going to the body.');\n\t\t\t\t}\n\t\t\t\treq.headers['content-type'] = 'application/x-www-form-urlencoded';\n\t\t\t\treq.body = Object.assign({}, req.body, req.query);\n\t\t\t}\n\t\t\treturn next();\n\t\t};\n\n\t\tthis.app.all('/oauth/token', debugMiddleware, transformRequestsNotUsingFormUrlencodedType, async (req, res, next) => {\n\t\t\tconst request = new OAuthServer.Request(req);\n\t\t\tconst response = new OAuthServer.Response(res);\n\n\t\t\ttry {\n\t\t\t\tawait oauth.token(request, response);\n\n\t\t\t\thandleResponse(res, response, next);\n\t\t\t} catch (e: any) {\n\t\t\t\tnext(e);\n\t\t\t}\n\t\t});\n\n\t\tthis.app.get('/oauth/authorize', debugMiddleware, async (req, res, next) => {\n\t\t\tif (typeof req.query.client_id !== 'string') {\n\t\t\t\treturn res.redirect('/oauth/error/404');\n\t\t\t}\n\n\t\t\tconst client = await OAuthApps.findOneActiveByClientId(req.query.client_id);\n\t\t\tif (client == null) {\n\t\t\t\treturn res.redirect('/oauth/error/404');\n\t\t\t}\n\n\t\t\tconst redirectUris: string[] = client.redirectUri.split(',');\n\n\t\t\tif (typeof req.query.redirect_uri === 'string' && !redirectUris.includes(req.query.redirect_uri)) {\n\t\t\t\treturn res.redirect('/oauth/error/invalid_redirect_uri');\n\t\t\t}\n\n\t\t\treturn next();\n\t\t});\n\n\t\tthis.app.post('/oauth/authorize', debugMiddleware, async (req, res, next) => {\n\t\t\tif (req.body.allow !== 'yes') {\n\t\t\t\tres.status(401);\n\t\t\t\treturn res.send({ error: 'access_denied', error_description: 'The user denied access to your application' });\n\t\t\t}\n\n\t\t\t// The new version of the library is expecting a new name. Doing this for compatibility\n\t\t\tif (req.body.token && !req.body.access_token) {\n\t\t\t\treq.body.access_token = req.body.token;\n\t\t\t}\n\n\t\t\tif (req.body.access_token == null) {\n\t\t\t\treturn res.status(401).send('No token');\n\t\t\t}\n\n\t\t\tconst user = await Users.findOne(\n\t\t\t\t{\n\t\t\t\t\t'services.resume.loginTokens.hashedToken': Accounts._hashLoginToken(req.body.access_token),\n\t\t\t\t},\n\t\t\t\t{ projection: { _id: 1 } },\n\t\t\t);\n\n\t\t\tif (user == null) {\n\t\t\t\treturn res.status(401).send('Invalid token');\n\t\t\t}\n\n\t\t\tres.locals.user = { id: user._id };\n\n\t\t\treturn next();\n\t\t});\n\n\t\tthis.app.post('/oauth/authorize', debugMiddleware, async (req: Request, res: Response, next: NextFunction) => {\n\t\t\tconst request = new OAuthServer.Request(req);\n\t\t\tconst response = new OAuthServer.Response(res);\n\n\t\t\ttry {\n\t\t\t\tawait oauth.authorize(request, response, {\n\t\t\t\t\tauthenticateHandler: {\n\t\t\t\t\t\tasync handle() {\n\t\t\t\t\t\t\tconst clientId = request.body.client_id || request.query?.client_id;\n\n\t\t\t\t\t\t\tif (!clientId) {\n\t\t\t\t\t\t\t\tthrow new Error('Missing parameter: `client_id`');\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\tif (req.body.allow === 'yes') {\n\t\t\t\t\t\t\t\tawait Users.updateOne({ _id: res.locals.user.id }, { $addToSet: { 'oauth.authorizedClients': clientId } });\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\treturn { id: res.locals.user.id };\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t});\n\n\t\t\t\thandleResponse(res, response, next);\n\t\t\t} catch (e: any) {\n\t\t\t\tnext(e);\n\t\t\t}\n\t\t});\n\n\t\tthis.app.use('/oauth/*', (err: Error, _req: Request, res: Response, next: NextFunction) => {\n\t\t\tif (!(err instanceof OAuthError)) return next(err);\n\n\t\t\tdelete err.stack;\n\n\t\t\tres.status(err.code);\n\n\t\t\tif (err instanceof UnauthorizedRequestError) {\n\t\t\t\treturn res.send();\n\t\t\t}\n\n\t\t\tres.send({ error: err.name, error_description: err.message });\n\t\t});\n\t}\n}\n"],"mappings":"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","ignoreList":[]},"sourceType":"module","externalDependencies":{},"hash":"00aec07f4ef51b46638872d3cecaad30bf4c64ea"}
