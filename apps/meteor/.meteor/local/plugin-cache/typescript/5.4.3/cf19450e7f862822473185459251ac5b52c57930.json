{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/client/lib/userData.ts","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","topLevelAwait","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"web.browser.legacy"},"sourceFileName":"client/lib/userData.ts","filename":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/client/lib/userData.ts","inputSourceMap":{"version":3,"file":"client/lib/userData.ts","sourceRoot":"","sources":["client/lib/userData.ts"],"names":[],"mappings":"AACA,OAAO,EAAE,WAAW,EAAE,MAAM,qBAAqB,CAAC;AAElD,OAAO,EAAE,KAAK,EAAE,MAAM,yBAAyB,CAAC;AAChD,OAAO,EAAE,GAAG,EAAE,MAAM,sCAAsC,CAAC;AAE3D,MAAM,CAAC,MAAM,WAAW,GAAG,IAAI,WAAW,CAAC,KAAK,CAAC,CAAC;AA6BlD,MAAM,UAAU,GAAG,CAAC,QAAe,EAAQ,EAAE;IAC5C,MAAM,IAAI,GAAG,KAAK,CAAC,OAAO,CAAC,EAAE,GAAG,EAAE,QAAQ,CAAC,GAAG,EAAE,CAAsB,CAAC;IAEvE,IAAI,CAAC,IAAI,EAAE,UAAU,IAAI,IAAI,CAAC,UAAU,CAAC,OAAO,EAAE,GAAG,QAAQ,CAAC,UAAU,CAAC,OAAO,EAAE,EAAE,CAAC;QACpF,KAAK,CAAC,MAAM,CAAC,EAAE,GAAG,EAAE,QAAQ,CAAC,GAAG,EAAE,EAAE,QAAQ,CAAC,CAAC;QAC9C,OAAO;IACR,CAAC;IAED,8DAA8D;IAC9D,MAAM,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC,OAAO,CAAC,CAAC,GAAG,EAAE,EAAE;QACjC,OAAO,QAAQ,CAAC,GAAkB,CAAC,CAAC;IACrC,CAAC,CAAC,CAAC;IACH,KAAK,CAAC,MAAM,CAAC,EAAE,GAAG,EAAE,IAAI,CAAC,GAAG,EAAE,EAAE,EAAE,IAAI,EAAE,EAAE,GAAG,QAAQ,EAAE,EAAE,CAAC,CAAC;AAC5D,CAAC,CAAC;AAEF,IAAI,MAAgC,CAAC;AACrC,MAAM,CAAC,MAAM,mBAAmB,GAAG,KAAK,EAAE,GAAiB,EAA+B,EAAE;IAC3F,IAAI,CAAC,GAAG,EAAE,CAAC;QACV,OAAO;IACR,CAAC;IAED,4DAA4D;IAC5D,KAAK,CAAC,MAAM,CAAC,EAAE,GAAG,EAAE,EAAE,GAAG,EAAE,GAAG,EAAE,EAAE,CAAC,CAAC;IAEpC,MAAM,EAAE,EAAE,CAAC;IAEX,MAAM,MAAM,GAAG,GAAG,CAAC,MAAM,CAAC,aAAa,EAAE,CAAC,GAAG,GAAG,WAAW,CAAC,EAAE,CAAC,IAAI,EAAE,EAAE;QACtE,QAAQ,IAAI,CAAC,IAAI,EAAE,CAAC;YACnB,KAAK,UAAU;gBACd,6DAA6D;gBAC7D,MAAM,EAAE,IAAI,EAAE,EAAE,EAAE,GAAG,IAAI,EAAE,GAAG,IAAI,CAAC;gBACnC,KAAK,CAAC,MAAM,CAAC,IAAwB,CAAC,CAAC;gBACvC,MAAM;YAEP,KAAK,SAAS;gBACb,KAAK,CAAC,MAAM,CAAC,EAAE,GAAG,EAAE,GAAG,EAAE,EAAE,EAAE,IAAI,EAAE,IAAI,CAAC,IAAI,EAAE,MAAM,EAAE,IAAI,CAAC,KAAY,EAAE,CAAC,CAAC;gBAC3E,MAAM;YAEP,KAAK,SAAS;gBACb,KAAK,CAAC,MAAM,CAAC,EAAE,GAAG,EAAE,GAAG,EAAE,CAAC,CAAC;gBAC3B,MAAM;QACR,CAAC;IACF,CAAC,CAAC,CAAC;IAEH,MAAM,GAAG,MAAM,CAAC,IAAI,CAAC;IACrB,MAAM,MAAM,CAAC,KAAK,EAAE,CAAC;IAErB,MAAM,EAAE,IAAI,EAAE,SAAS,EAAE,QAAQ,EAAE,WAAW,EAAE,GAAG,QAAQ,EAAE,GAAG,MAAM,GAAG,CAAC,IAAI,CAAC,GAAG,CAAC,QAAQ,CAAC,CAAC;IAE7F,YAAY;IACZ,uDAAuD;IACvD,KAAK;IACL,iDAAiD;IACjD,kBAAkB;IAClB,oBAAoB;IACpB,eAAe;IACf,IAAI;IAEJ,IAAI,QAAQ,EAAE,CAAC;QACd,MAAM,EAAE,KAAK,EAAE,KAAK,EAAE,MAAM,EAAE,QAAQ,EAAE,SAAS,EAAE,GAAG,QAAQ,EAAE,GAAG,WAAW,IAAI,EAAE,CAAC;QAErF,UAAU,CAAC;YACV,GAAG,QAAQ;YACX,GAAG,CAAC,WAAW,IAAI;gBAClB,QAAQ,EAAE;oBACT,GAAG,CAAC,QAAQ,CAAC,CAAC,CAAC,EAAE,GAAG,QAAQ,EAAE,CAAC,CAAC,CAAC,EAAE,CAAC;oBACpC,GAAG,CAAC,MAAM;wBACT,CAAC,CAAC;4BACA,MAAM,EAAE;gCACP,GAAG,CAAC,MAAM,CAAC,WAAW,IAAI;oCACzB,WAAW,EAAE,MAAM,CAAC,WAAW,CAAC,GAAG,CAAC,CAAC,KAAK,EAAE,EAAE,CAAC,CAAC;wCAC/C,GAAG,KAAK;wCACR,IAAI,EAAE,IAAI,IAAI,CAAC,MAAM,IAAI,KAAK,CAAC,CAAC,CAAC,KAAK,CAAC,IAAI,CAAC,CAAC,CAAC,EAAE,CAAC;wCACjD,SAAS,EAAE,CAAC,WAAW,IAAI,KAAK,CAAC,CAAC,CAAC,IAAI,IAAI,CAAC,KAAK,CAAC,SAAS,CAAC,CAAC,CAAC,CAAC,SAAS,CAAS;wCACjF,wBAAwB,EAAE,KAAK,CAAC,wBAAwB,CAAC,CAAC,CAAC,IAAI,IAAI,CAAC,KAAK,CAAC,wBAAwB,CAAC,CAAC,CAAC,CAAC,SAAS;qCAC/G,CAAC,CAAC;iCACH,CAAC;6BACF;yBACA;wBACH,CAAC,CAAC,EAAE,CAAC;oBACN,GAAG,CAAC,KAAK;wBACR,CAAC,CAAC;4BACA,KAAK,EAAE;gCACN,GAAG,KAAK;gCACR,SAAS,EAAE,IAAI,IAAI,CAAC,KAAK,CAAC,SAAS,CAAC;6BACpC;yBACA;wBACH,CAAC,CAAC,EAAE,CAAC;oBACN,GAAG,CAAC,SAAS,CAAC,CAAC,CAAC,EAAE,GAAG,SAAS,EAAE,MAAM,EAAE,IAAI,IAAI,CAAC,SAAS,CAAC,MAAM,CAAC,EAAE,CAAC,CAAC,CAAC,EAAE,CAAC;oBAC1E,GAAG,CAAC,QAAQ,CAAC,CAAC,CAAC,EAAE,QAAQ,EAAE,EAAE,GAAG,QAAQ,EAAE,SAAS,EAAE,IAAI,IAAI,CAAC,QAAQ,CAAC,SAAS,CAAC,EAAE,EAAE,CAAC,CAAC,CAAC,EAAE,CAAC;oBAC3F,GAAG,CAAC,KAAK,EAAE,kBAAkB,IAAI;wBAChC,KAAK,EAAE;4BACN,kBAAkB,EAAE,KAAK,CAAC,kBAAkB,CAAC,GAAG,CAAC,CAAC,KAAK,EAAE,EAAE,CAAC,CAAC;gCAC5D,GAAG,KAAK;gCACR,IAAI,EAAE,IAAI,IAAI,CAAC,KAAK,CAAC,IAAI,CAAC;6BAC1B,CAAC,CAAC;yBACH;qBACD,CAAC;iBACF;aACD,CAAC;YACF,GAAG,CAAC,SAAS,IAAI;gBAChB,SAAS,EAAE,IAAI,IAAI,CAAC,SAAS,CAAC;aAC9B,CAAC;YACF,IAAI,EAAE,OAAO,CAAC,IAAI,CAAC;YACnB,SAAS,EAAE,IAAI,IAAI,CAAC,QAAQ,CAAC,SAAS,CAAC;YACvC,UAAU,EAAE,IAAI,IAAI,CAAC,QAAQ,CAAC,UAAU,CAAC;SACzC,CAAC,CAAC;IACJ,CAAC;IACD,WAAW,CAAC,GAAG,CAAC,IAAI,CAAC,CAAC;IAEtB,OAAO,QAAQ,CAAC;AACjB,CAAC,CAAC;AAEF,MAAM,CAAC,MAAM,mBAAmB,GAAG,GAAW,EAAE,CAAC,KAAK,CAAC,MAAM,CAAC,EAAE,CAAC,CAAC","sourcesContent":["import type { ILivechatAgent, IUser, Serialized } from '@rocket.chat/core-typings';\nimport { ReactiveVar } from 'meteor/reactive-var';\n\nimport { Users } from '../../app/models/client';\nimport { sdk } from '../../app/utils/client/lib/SDKClient';\n\nexport const isSyncReady = new ReactiveVar(false);\n\ntype RawUserData = Serialized<\n\tPick<\n\t\tIUser,\n\t\t| '_id'\n\t\t| 'type'\n\t\t| 'name'\n\t\t| 'username'\n\t\t| 'emails'\n\t\t| 'status'\n\t\t| 'statusDefault'\n\t\t| 'statusText'\n\t\t| 'statusConnection'\n\t\t| 'avatarOrigin'\n\t\t| 'utcOffset'\n\t\t| 'language'\n\t\t| 'settings'\n\t\t| 'roles'\n\t\t| 'active'\n\t\t| 'defaultRoom'\n\t\t| 'customFields'\n\t\t| 'oauth'\n\t\t| 'createdAt'\n\t\t| '_updatedAt'\n\t\t| 'avatarETag'\n\t> & { statusLivechat?: ILivechatAgent['statusLivechat'] }\n>;\n\nconst updateUser = (userData: IUser): void => {\n\tconst user = Users.findOne({ _id: userData._id }) as IUser | undefined;\n\n\tif (!user?._updatedAt || user._updatedAt.getTime() < userData._updatedAt.getTime()) {\n\t\tUsers.upsert({ _id: userData._id }, userData);\n\t\treturn;\n\t}\n\n\t// delete data already on user's collection as those are newer\n\tObject.keys(user).forEach((key) => {\n\t\tdelete userData[key as keyof IUser];\n\t});\n\tUsers.update({ _id: user._id }, { $set: { ...userData } });\n};\n\nlet cancel: undefined | (() => void);\nexport const synchronizeUserData = async (uid: IUser['_id']): Promise<RawUserData | void> => {\n\tif (!uid) {\n\t\treturn;\n\t}\n\n\t// Remove data from any other user that we may have retained\n\tUsers.remove({ _id: { $ne: uid } });\n\n\tcancel?.();\n\n\tconst result = sdk.stream('notify-user', [`${uid}/userData`], (data) => {\n\t\tswitch (data.type) {\n\t\t\tcase 'inserted':\n\t\t\t\t// eslint-disable-next-line @typescript-eslint/no-unused-vars\n\t\t\t\tconst { type, id, ...user } = data;\n\t\t\t\tUsers.insert(user as unknown as IUser);\n\t\t\t\tbreak;\n\n\t\t\tcase 'updated':\n\t\t\t\tUsers.upsert({ _id: uid }, { $set: data.diff, $unset: data.unset as any });\n\t\t\t\tbreak;\n\n\t\t\tcase 'removed':\n\t\t\t\tUsers.remove({ _id: uid });\n\t\t\t\tbreak;\n\t\t}\n\t});\n\n\tcancel = result.stop;\n\tawait result.ready();\n\n\tconst { ldap, lastLogin, services: rawServices, ...userData } = await sdk.rest.get('/v1/me');\n\n\t// email?: {\n\t// \tverificationTokens?: IUserEmailVerificationToken[];\n\t// };\n\t// export interface IUserEmailVerificationToken {\n\t// \ttoken: string;\n\t// \taddress: string;\n\t// \twhen: Date;\n\t// }\n\n\tif (userData) {\n\t\tconst { email, cloud, resume, email2fa, emailCode, ...services } = rawServices || {};\n\n\t\tupdateUser({\n\t\t\t...userData,\n\t\t\t...(rawServices && {\n\t\t\t\tservices: {\n\t\t\t\t\t...(services ? { ...services } : {}),\n\t\t\t\t\t...(resume\n\t\t\t\t\t\t? {\n\t\t\t\t\t\t\t\tresume: {\n\t\t\t\t\t\t\t\t\t...(resume.loginTokens && {\n\t\t\t\t\t\t\t\t\t\tloginTokens: resume.loginTokens.map((token) => ({\n\t\t\t\t\t\t\t\t\t\t\t...token,\n\t\t\t\t\t\t\t\t\t\t\twhen: new Date('when' in token ? token.when : ''),\n\t\t\t\t\t\t\t\t\t\t\tcreatedAt: ('createdAt' in token ? new Date(token.createdAt) : undefined) as Date,\n\t\t\t\t\t\t\t\t\t\t\ttwoFactorAuthorizedUntil: token.twoFactorAuthorizedUntil ? new Date(token.twoFactorAuthorizedUntil) : undefined,\n\t\t\t\t\t\t\t\t\t\t})),\n\t\t\t\t\t\t\t\t\t}),\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t  }\n\t\t\t\t\t\t: {}),\n\t\t\t\t\t...(cloud\n\t\t\t\t\t\t? {\n\t\t\t\t\t\t\t\tcloud: {\n\t\t\t\t\t\t\t\t\t...cloud,\n\t\t\t\t\t\t\t\t\texpiresAt: new Date(cloud.expiresAt),\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t  }\n\t\t\t\t\t\t: {}),\n\t\t\t\t\t...(emailCode ? { ...emailCode, expire: new Date(emailCode.expire) } : {}),\n\t\t\t\t\t...(email2fa ? { email2fa: { ...email2fa, changedAt: new Date(email2fa.changedAt) } } : {}),\n\t\t\t\t\t...(email?.verificationTokens && {\n\t\t\t\t\t\temail: {\n\t\t\t\t\t\t\tverificationTokens: email.verificationTokens.map((token) => ({\n\t\t\t\t\t\t\t\t...token,\n\t\t\t\t\t\t\t\twhen: new Date(token.when),\n\t\t\t\t\t\t\t})),\n\t\t\t\t\t\t},\n\t\t\t\t\t}),\n\t\t\t\t},\n\t\t\t}),\n\t\t\t...(lastLogin && {\n\t\t\t\tlastLogin: new Date(lastLogin),\n\t\t\t}),\n\t\t\tldap: Boolean(ldap),\n\t\t\tcreatedAt: new Date(userData.createdAt),\n\t\t\t_updatedAt: new Date(userData._updatedAt),\n\t\t});\n\t}\n\tisSyncReady.set(true);\n\n\treturn userData;\n};\n\nexport const removeLocalUserData = (): number => Users.remove({});\n"]},"targets":{"android":"125.0.0","chrome":"125.0.0","edge":"125.0.0","firefox":"115.0.0","ie":"10.0.0","ios":"17.4.0","opera":"110.0.0","opera_mobile":"80.0.0","safari":"17.4.0","samsung":"24.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor","root":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":true,"enforceStrictMode":false,"dynamicImport":true},"externalDependencies":[]},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"version":"7.17.2","helpers":true,"useESModules":false,"corejs":false},"externalDependencies":[]},{"key":"proposal-class-properties","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true},"externalDependencies":[]},{"key":"base$0$3","visitor":{"FunctionExpression":{"exit":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"base$0$4","visitor":{"ForInStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-react-jsx","visitor":{"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXFragment":{"exit":[null]},"JSXElement":{"exit":[null]},"JSXAttribute":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false},"externalDependencies":[]},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-nullish-coalescing-operator","visitor":{"LogicalExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-optional-chaining","visitor":{"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-optional-catch-binding","visitor":{"CatchClause":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-class-properties","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-async-generator-functions","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-logical-assignment-operators","visitor":{"AssignmentExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-arrow-functions","visitor":{"ArrowFunctionExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-block-scoped-functions","visitor":{"BlockStatement":{"enter":[null]},"SwitchCase":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-block-scoping","visitor":{"VariableDeclaration":{"enter":[null,null]},"BlockStatement":{"enter":[null]},"SwitchCase":{"enter":[null]},"ClassDeclaration":{"enter":[null]},"DoWhileStatement":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForStatement":{"enter":[null]},"WhileStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-classes","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"ClassDeclaration":{"enter":[null]},"ClassExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"loose":true},"externalDependencies":[]},{"key":"transform-computed-properties","visitor":{"ObjectExpression":{"exit":[null]},"_exploded":true,"_verified":true},"options":{"loose":true},"externalDependencies":[]},{"key":"transform-destructuring","visitor":{"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"VariableDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"transform-for-of","visitor":{"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"loose":true},"externalDependencies":[]},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-object-super","visitor":{"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true,"DoWhileStatement":{"exit":[null]},"ForInStatement":{"exit":[null]},"ForStatement":{"exit":[null]},"WhileStatement":{"exit":[null]},"ForOfStatement":{"exit":[null]}},"options":{},"externalDependencies":[]},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"transform-shorthand-properties","visitor":{"ObjectMethod":{"enter":[null]},"ObjectProperty":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-spread","visitor":{"ArrayExpression":{"enter":[null]},"CallExpression":{"enter":[null]},"NewExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-sticky-regex","visitor":{"RegExpLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"loose":true},"externalDependencies":[]},{"key":"transform-typeof-symbol","visitor":{"UnaryExpression":{"enter":[null]},"_exploded":true,"_verified":true,"BlockStatement":{"enter":[null]},"CatchClause":{"enter":[null]},"DoWhileStatement":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForStatement":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"Program":{"enter":[null]},"ObjectMethod":{"enter":[null]},"SwitchStatement":{"enter":[null]},"WhileStatement":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]},"ForOfStatement":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"StaticBlock":{"enter":[null]},"TSModuleBlock":{"enter":[null]},"AssignmentPattern":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectPattern":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"transform-unicode-regex","visitor":{"RegExpLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-property-literals","visitor":{"ObjectProperty":{"exit":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-regenerator","visitor":{"ObjectMethod":{"enter":[null],"exit":[null]},"ClassMethod":{"enter":[null],"exit":[null]},"ClassPrivateMethod":{"enter":[null],"exit":[null]},"FunctionDeclaration":{"exit":[null]},"FunctionExpression":{"exit":[null]},"ArrowFunctionExpression":{"exit":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]}],"presets":[],"generatorOpts":{"filename":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/client/lib/userData.ts","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"client/lib/userData.ts","inputSourceMap":{"version":3,"file":"client/lib/userData.ts","sourceRoot":"","sources":["client/lib/userData.ts"],"names":[],"mappings":"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","sourcesContent":["import type { ILivechatAgent, IUser, Serialized } from '@rocket.chat/core-typings';\nimport { ReactiveVar } from 'meteor/reactive-var';\n\nimport { Users } from '../../app/models/client';\nimport { sdk } from '../../app/utils/client/lib/SDKClient';\n\nexport const isSyncReady = new ReactiveVar(false);\n\ntype RawUserData = Serialized<\n\tPick<\n\t\tIUser,\n\t\t| '_id'\n\t\t| 'type'\n\t\t| 'name'\n\t\t| 'username'\n\t\t| 'emails'\n\t\t| 'status'\n\t\t| 'statusDefault'\n\t\t| 'statusText'\n\t\t| 'statusConnection'\n\t\t| 'avatarOrigin'\n\t\t| 'utcOffset'\n\t\t| 'language'\n\t\t| 'settings'\n\t\t| 'roles'\n\t\t| 'active'\n\t\t| 'defaultRoom'\n\t\t| 'customFields'\n\t\t| 'oauth'\n\t\t| 'createdAt'\n\t\t| '_updatedAt'\n\t\t| 'avatarETag'\n\t> & { statusLivechat?: ILivechatAgent['statusLivechat'] }\n>;\n\nconst updateUser = (userData: IUser): void => {\n\tconst user = Users.findOne({ _id: userData._id }) as IUser | undefined;\n\n\tif (!user?._updatedAt || user._updatedAt.getTime() < userData._updatedAt.getTime()) {\n\t\tUsers.upsert({ _id: userData._id }, userData);\n\t\treturn;\n\t}\n\n\t// delete data already on user's collection as those are newer\n\tObject.keys(user).forEach((key) => {\n\t\tdelete userData[key as keyof IUser];\n\t});\n\tUsers.update({ _id: user._id }, { $set: { ...userData } });\n};\n\nlet cancel: undefined | (() => void);\nexport const synchronizeUserData = async (uid: IUser['_id']): Promise<RawUserData | void> => {\n\tif (!uid) {\n\t\treturn;\n\t}\n\n\t// Remove data from any other user that we may have retained\n\tUsers.remove({ _id: { $ne: uid } });\n\n\tcancel?.();\n\n\tconst result = sdk.stream('notify-user', [`${uid}/userData`], (data) => {\n\t\tswitch (data.type) {\n\t\t\tcase 'inserted':\n\t\t\t\t// eslint-disable-next-line @typescript-eslint/no-unused-vars\n\t\t\t\tconst { type, id, ...user } = data;\n\t\t\t\tUsers.insert(user as unknown as IUser);\n\t\t\t\tbreak;\n\n\t\t\tcase 'updated':\n\t\t\t\tUsers.upsert({ _id: uid }, { $set: data.diff, $unset: data.unset as any });\n\t\t\t\tbreak;\n\n\t\t\tcase 'removed':\n\t\t\t\tUsers.remove({ _id: uid });\n\t\t\t\tbreak;\n\t\t}\n\t});\n\n\tcancel = result.stop;\n\tawait result.ready();\n\n\tconst { ldap, lastLogin, services: rawServices, ...userData } = await sdk.rest.get('/v1/me');\n\n\t// email?: {\n\t// \tverificationTokens?: IUserEmailVerificationToken[];\n\t// };\n\t// export interface IUserEmailVerificationToken {\n\t// \ttoken: string;\n\t// \taddress: string;\n\t// \twhen: Date;\n\t// }\n\n\tif (userData) {\n\t\tconst { email, cloud, resume, email2fa, emailCode, ...services } = rawServices || {};\n\n\t\tupdateUser({\n\t\t\t...userData,\n\t\t\t...(rawServices && {\n\t\t\t\tservices: {\n\t\t\t\t\t...(services ? { ...services } : {}),\n\t\t\t\t\t...(resume\n\t\t\t\t\t\t? {\n\t\t\t\t\t\t\t\tresume: {\n\t\t\t\t\t\t\t\t\t...(resume.loginTokens && {\n\t\t\t\t\t\t\t\t\t\tloginTokens: resume.loginTokens.map((token) => ({\n\t\t\t\t\t\t\t\t\t\t\t...token,\n\t\t\t\t\t\t\t\t\t\t\twhen: new Date('when' in token ? token.when : ''),\n\t\t\t\t\t\t\t\t\t\t\tcreatedAt: ('createdAt' in token ? new Date(token.createdAt) : undefined) as Date,\n\t\t\t\t\t\t\t\t\t\t\ttwoFactorAuthorizedUntil: token.twoFactorAuthorizedUntil ? new Date(token.twoFactorAuthorizedUntil) : undefined,\n\t\t\t\t\t\t\t\t\t\t})),\n\t\t\t\t\t\t\t\t\t}),\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t  }\n\t\t\t\t\t\t: {}),\n\t\t\t\t\t...(cloud\n\t\t\t\t\t\t? {\n\t\t\t\t\t\t\t\tcloud: {\n\t\t\t\t\t\t\t\t\t...cloud,\n\t\t\t\t\t\t\t\t\texpiresAt: new Date(cloud.expiresAt),\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t  }\n\t\t\t\t\t\t: {}),\n\t\t\t\t\t...(emailCode ? { ...emailCode, expire: new Date(emailCode.expire) } : {}),\n\t\t\t\t\t...(email2fa ? { email2fa: { ...email2fa, changedAt: new Date(email2fa.changedAt) } } : {}),\n\t\t\t\t\t...(email?.verificationTokens && {\n\t\t\t\t\t\temail: {\n\t\t\t\t\t\t\tverificationTokens: email.verificationTokens.map((token) => ({\n\t\t\t\t\t\t\t\t...token,\n\t\t\t\t\t\t\t\twhen: new Date(token.when),\n\t\t\t\t\t\t\t})),\n\t\t\t\t\t\t},\n\t\t\t\t\t}),\n\t\t\t\t},\n\t\t\t}),\n\t\t\t...(lastLogin && {\n\t\t\t\tlastLogin: new Date(lastLogin),\n\t\t\t}),\n\t\t\tldap: Boolean(ldap),\n\t\t\tcreatedAt: new Date(userData.createdAt),\n\t\t\t_updatedAt: new Date(userData._updatedAt),\n\t\t});\n\t}\n\tisSyncReady.set(true);\n\n\treturn userData;\n};\n\nexport const removeLocalUserData = (): number => Users.remove({});\n"]}}},"code":"var _excluded = [\"type\", \"id\"],\n  _excluded2 = [\"ldap\", \"lastLogin\", \"services\"],\n  _excluded3 = [\"email\", \"cloud\", \"resume\", \"email2fa\", \"emailCode\"];\nvar _regeneratorRuntime;\nmodule.link(\"@babel/runtime/regenerator\", {\n  default: function (v) {\n    _regeneratorRuntime = v;\n  }\n}, 0);\nvar _objectWithoutProperties;\nmodule.link(\"@babel/runtime/helpers/objectWithoutProperties\", {\n  default: function (v) {\n    _objectWithoutProperties = v;\n  }\n}, 1);\nvar _objectSpread;\nmodule.link(\"@babel/runtime/helpers/objectSpread2\", {\n  default: function (v) {\n    _objectSpread = v;\n  }\n}, 2);\nmodule.export({\n  isSyncReady: function () {\n    return isSyncReady;\n  },\n  synchronizeUserData: function () {\n    return synchronizeUserData;\n  },\n  removeLocalUserData: function () {\n    return removeLocalUserData;\n  }\n});\nvar ReactiveVar;\nmodule.link(\"meteor/reactive-var\", {\n  ReactiveVar: function (v) {\n    ReactiveVar = v;\n  }\n}, 0);\nvar Users;\nmodule.link(\"../../app/models/client\", {\n  Users: function (v) {\n    Users = v;\n  }\n}, 1);\nvar sdk;\nmodule.link(\"../../app/utils/client/lib/SDKClient\", {\n  sdk: function (v) {\n    sdk = v;\n  }\n}, 2);\nvar isSyncReady = new ReactiveVar(false);\nvar updateUser = function (userData) {\n  var user = Users.findOne({\n    _id: userData._id\n  });\n  if (!(user !== null && user !== void 0 && user._updatedAt) || user._updatedAt.getTime() < userData._updatedAt.getTime()) {\n    Users.upsert({\n      _id: userData._id\n    }, userData);\n    return;\n  }\n  // delete data already on user's collection as those are newer\n  Object.keys(user).forEach(function (key) {\n    delete userData[key];\n  });\n  Users.update({\n    _id: user._id\n  }, {\n    $set: _objectSpread({}, userData)\n  });\n};\nvar cancel;\nvar synchronizeUserData = function () {\n  function _callee(uid) {\n    var _cancel;\n    var result, _await$sdk$rest$get, ldap, lastLogin, rawServices, userData, _ref, email, cloud, resume, email2fa, emailCode, services;\n    return _regeneratorRuntime.async(function () {\n      function _callee$(_context) {\n        while (1) switch (_context.prev = _context.next) {\n          case 0:\n            if (uid) {\n              _context.next = 2;\n              break;\n            }\n            return _context.abrupt(\"return\");\n          case 2:\n            // Remove data from any other user that we may have retained\n            Users.remove({\n              _id: {\n                $ne: uid\n              }\n            });\n            (_cancel = cancel) === null || _cancel === void 0 ? void 0 : _cancel();\n            result = sdk.stream('notify-user', [uid + \"/userData\"], function (data) {\n              switch (data.type) {\n                case 'inserted':\n                  // eslint-disable-next-line @typescript-eslint/no-unused-vars\n                  var type = data.type,\n                    id = data.id,\n                    user = _objectWithoutProperties(data, _excluded);\n                  Users.insert(user);\n                  break;\n                case 'updated':\n                  Users.upsert({\n                    _id: uid\n                  }, {\n                    $set: data.diff,\n                    $unset: data.unset\n                  });\n                  break;\n                case 'removed':\n                  Users.remove({\n                    _id: uid\n                  });\n                  break;\n              }\n            });\n            cancel = result.stop;\n            _context.next = 8;\n            return _regeneratorRuntime.awrap(result.ready());\n          case 8:\n            _context.next = 10;\n            return _regeneratorRuntime.awrap(sdk.rest.get('/v1/me'));\n          case 10:\n            _await$sdk$rest$get = _context.sent;\n            ldap = _await$sdk$rest$get.ldap;\n            lastLogin = _await$sdk$rest$get.lastLogin;\n            rawServices = _await$sdk$rest$get.services;\n            userData = _objectWithoutProperties(_await$sdk$rest$get, _excluded2);\n            // email?: {\n            // \tverificationTokens?: IUserEmailVerificationToken[];\n            // };\n            // export interface IUserEmailVerificationToken {\n            // \ttoken: string;\n            // \taddress: string;\n            // \twhen: Date;\n            // }\n            if (userData) {\n              _ref = rawServices || {}, email = _ref.email, cloud = _ref.cloud, resume = _ref.resume, email2fa = _ref.email2fa, emailCode = _ref.emailCode, services = _objectWithoutProperties(_ref, _excluded3);\n              updateUser(_objectSpread(_objectSpread(_objectSpread(_objectSpread({}, userData), rawServices && {\n                services: _objectSpread(_objectSpread(_objectSpread(_objectSpread(_objectSpread(_objectSpread({}, services ? _objectSpread({}, services) : {}), resume ? {\n                  resume: _objectSpread({}, resume.loginTokens && {\n                    loginTokens: resume.loginTokens.map(function (token) {\n                      return _objectSpread(_objectSpread({}, token), {}, {\n                        when: new Date('when' in token ? token.when : ''),\n                        createdAt: 'createdAt' in token ? new Date(token.createdAt) : undefined,\n                        twoFactorAuthorizedUntil: token.twoFactorAuthorizedUntil ? new Date(token.twoFactorAuthorizedUntil) : undefined\n                      });\n                    })\n                  })\n                } : {}), cloud ? {\n                  cloud: _objectSpread(_objectSpread({}, cloud), {}, {\n                    expiresAt: new Date(cloud.expiresAt)\n                  })\n                } : {}), emailCode ? _objectSpread(_objectSpread({}, emailCode), {}, {\n                  expire: new Date(emailCode.expire)\n                }) : {}), email2fa ? {\n                  email2fa: _objectSpread(_objectSpread({}, email2fa), {}, {\n                    changedAt: new Date(email2fa.changedAt)\n                  })\n                } : {}), (email === null || email === void 0 ? void 0 : email.verificationTokens) && {\n                  email: {\n                    verificationTokens: email.verificationTokens.map(function (token) {\n                      return _objectSpread(_objectSpread({}, token), {}, {\n                        when: new Date(token.when)\n                      });\n                    })\n                  }\n                })\n              }), lastLogin && {\n                lastLogin: new Date(lastLogin)\n              }), {}, {\n                ldap: Boolean(ldap),\n                createdAt: new Date(userData.createdAt),\n                _updatedAt: new Date(userData._updatedAt)\n              }));\n            }\n            isSyncReady.set(true);\n            return _context.abrupt(\"return\", userData);\n          case 18:\n          case \"end\":\n            return _context.stop();\n        }\n      }\n      return _callee$;\n    }(), null, null, null, Promise);\n  }\n  return _callee;\n}();\nvar removeLocalUserData = function () {\n  return Users.remove({});\n};","map":{"version":3,"names":["_regeneratorRuntime","module","link","default","v","_objectWithoutProperties","_objectSpread","export","isSyncReady","synchronizeUserData","removeLocalUserData","ReactiveVar","Users","sdk","updateUser","userData","user","findOne","_id","_updatedAt","getTime","upsert","Object","keys","forEach","key","update","$set","cancel","_callee","uid","_cancel","result","_await$sdk$rest$get","ldap","lastLogin","rawServices","_ref","email","cloud","resume","email2fa","emailCode","services","async","_callee$","_context","prev","next","abrupt","remove","$ne","stream","data","type","id","_excluded","insert","diff","$unset","unset","stop","awrap","ready","rest","get","sent","_excluded2","_excluded3","loginTokens","map","token","when","Date","createdAt","undefined","twoFactorAuthorizedUntil","expiresAt","expire","changedAt","verificationTokens","Boolean","set","Promise"],"sources":["client/lib/userData.ts"],"sourcesContent":["import type { ILivechatAgent, IUser, Serialized } from '@rocket.chat/core-typings';\nimport { ReactiveVar } from 'meteor/reactive-var';\n\nimport { Users } from '../../app/models/client';\nimport { sdk } from '../../app/utils/client/lib/SDKClient';\n\nexport const isSyncReady = new ReactiveVar(false);\n\ntype RawUserData = Serialized<\n\tPick<\n\t\tIUser,\n\t\t| '_id'\n\t\t| 'type'\n\t\t| 'name'\n\t\t| 'username'\n\t\t| 'emails'\n\t\t| 'status'\n\t\t| 'statusDefault'\n\t\t| 'statusText'\n\t\t| 'statusConnection'\n\t\t| 'avatarOrigin'\n\t\t| 'utcOffset'\n\t\t| 'language'\n\t\t| 'settings'\n\t\t| 'roles'\n\t\t| 'active'\n\t\t| 'defaultRoom'\n\t\t| 'customFields'\n\t\t| 'oauth'\n\t\t| 'createdAt'\n\t\t| '_updatedAt'\n\t\t| 'avatarETag'\n\t> & { statusLivechat?: ILivechatAgent['statusLivechat'] }\n>;\n\nconst updateUser = (userData: IUser): void => {\n\tconst user = Users.findOne({ _id: userData._id }) as IUser | undefined;\n\n\tif (!user?._updatedAt || user._updatedAt.getTime() < userData._updatedAt.getTime()) {\n\t\tUsers.upsert({ _id: userData._id }, userData);\n\t\treturn;\n\t}\n\n\t// delete data already on user's collection as those are newer\n\tObject.keys(user).forEach((key) => {\n\t\tdelete userData[key as keyof IUser];\n\t});\n\tUsers.update({ _id: user._id }, { $set: { ...userData } });\n};\n\nlet cancel: undefined | (() => void);\nexport const synchronizeUserData = async (uid: IUser['_id']): Promise<RawUserData | void> => {\n\tif (!uid) {\n\t\treturn;\n\t}\n\n\t// Remove data from any other user that we may have retained\n\tUsers.remove({ _id: { $ne: uid } });\n\n\tcancel?.();\n\n\tconst result = sdk.stream('notify-user', [`${uid}/userData`], (data) => {\n\t\tswitch (data.type) {\n\t\t\tcase 'inserted':\n\t\t\t\t// eslint-disable-next-line @typescript-eslint/no-unused-vars\n\t\t\t\tconst { type, id, ...user } = data;\n\t\t\t\tUsers.insert(user as unknown as IUser);\n\t\t\t\tbreak;\n\n\t\t\tcase 'updated':\n\t\t\t\tUsers.upsert({ _id: uid }, { $set: data.diff, $unset: data.unset as any });\n\t\t\t\tbreak;\n\n\t\t\tcase 'removed':\n\t\t\t\tUsers.remove({ _id: uid });\n\t\t\t\tbreak;\n\t\t}\n\t});\n\n\tcancel = result.stop;\n\tawait result.ready();\n\n\tconst { ldap, lastLogin, services: rawServices, ...userData } = await sdk.rest.get('/v1/me');\n\n\t// email?: {\n\t// \tverificationTokens?: IUserEmailVerificationToken[];\n\t// };\n\t// export interface IUserEmailVerificationToken {\n\t// \ttoken: string;\n\t// \taddress: string;\n\t// \twhen: Date;\n\t// }\n\n\tif (userData) {\n\t\tconst { email, cloud, resume, email2fa, emailCode, ...services } = rawServices || {};\n\n\t\tupdateUser({\n\t\t\t...userData,\n\t\t\t...(rawServices && {\n\t\t\t\tservices: {\n\t\t\t\t\t...(services ? { ...services } : {}),\n\t\t\t\t\t...(resume\n\t\t\t\t\t\t? {\n\t\t\t\t\t\t\t\tresume: {\n\t\t\t\t\t\t\t\t\t...(resume.loginTokens && {\n\t\t\t\t\t\t\t\t\t\tloginTokens: resume.loginTokens.map((token) => ({\n\t\t\t\t\t\t\t\t\t\t\t...token,\n\t\t\t\t\t\t\t\t\t\t\twhen: new Date('when' in token ? token.when : ''),\n\t\t\t\t\t\t\t\t\t\t\tcreatedAt: ('createdAt' in token ? new Date(token.createdAt) : undefined) as Date,\n\t\t\t\t\t\t\t\t\t\t\ttwoFactorAuthorizedUntil: token.twoFactorAuthorizedUntil ? new Date(token.twoFactorAuthorizedUntil) : undefined,\n\t\t\t\t\t\t\t\t\t\t})),\n\t\t\t\t\t\t\t\t\t}),\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t  }\n\t\t\t\t\t\t: {}),\n\t\t\t\t\t...(cloud\n\t\t\t\t\t\t? {\n\t\t\t\t\t\t\t\tcloud: {\n\t\t\t\t\t\t\t\t\t...cloud,\n\t\t\t\t\t\t\t\t\texpiresAt: new Date(cloud.expiresAt),\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t  }\n\t\t\t\t\t\t: {}),\n\t\t\t\t\t...(emailCode ? { ...emailCode, expire: new Date(emailCode.expire) } : {}),\n\t\t\t\t\t...(email2fa ? { email2fa: { ...email2fa, changedAt: new Date(email2fa.changedAt) } } : {}),\n\t\t\t\t\t...(email?.verificationTokens && {\n\t\t\t\t\t\temail: {\n\t\t\t\t\t\t\tverificationTokens: email.verificationTokens.map((token) => ({\n\t\t\t\t\t\t\t\t...token,\n\t\t\t\t\t\t\t\twhen: new Date(token.when),\n\t\t\t\t\t\t\t})),\n\t\t\t\t\t\t},\n\t\t\t\t\t}),\n\t\t\t\t},\n\t\t\t}),\n\t\t\t...(lastLogin && {\n\t\t\t\tlastLogin: new Date(lastLogin),\n\t\t\t}),\n\t\t\tldap: Boolean(ldap),\n\t\t\tcreatedAt: new Date(userData.createdAt),\n\t\t\t_updatedAt: new Date(userData._updatedAt),\n\t\t});\n\t}\n\tisSyncReady.set(true);\n\n\treturn userData;\n};\n\nexport const removeLocalUserData = (): number => Users.remove({});\n"],"mappings":"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","ignoreList":[]},"sourceType":"module","externalDependencies":{},"hash":"cf19450e7f862822473185459251ac5b52c57930"}
