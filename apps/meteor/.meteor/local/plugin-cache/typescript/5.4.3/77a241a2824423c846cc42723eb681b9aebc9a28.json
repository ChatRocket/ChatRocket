{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/server/services/federation/infrastructure/rocket-chat/adapters/Settings.ts","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","topLevelAwait","objectRestSpread","objectRestSpread","asyncGenerators","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"os.osx.arm64"},"sourceFileName":"server/services/federation/infrastructure/rocket-chat/adapters/Settings.ts","filename":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/server/services/federation/infrastructure/rocket-chat/adapters/Settings.ts","inputSourceMap":{"version":3,"file":"server/services/federation/infrastructure/rocket-chat/adapters/Settings.ts","sourceRoot":"","sources":["server/services/federation/infrastructure/rocket-chat/adapters/Settings.ts"],"names":[],"mappings":"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","sourcesContent":["import crypto from 'crypto';\n\nimport { Settings } from '@rocket.chat/models';\nimport yaml from 'js-yaml';\nimport { v4 as uuidv4 } from 'uuid';\n\nimport { notifyOnSettingChangedById } from '../../../../../../app/lib/server/lib/notifyListener';\nimport { settings, settingsRegistry } from '../../../../../../app/settings/server';\nimport type { IFederationBridgeRegistrationFile } from '../../../domain/IFederationBridge';\n\nconst EVERYTHING_REGEX = '.*';\nconst LISTEN_RULES = EVERYTHING_REGEX;\n\nexport class RocketChatSettingsAdapter {\n\tpublic async initialize() {\n\t\tawait this.addFederationSettings();\n\t\tthis.watchChangesAndUpdateRegistrationFile();\n\t}\n\n\tpublic getApplicationServiceId(): string {\n\t\treturn settings.get('Federation_Matrix_id');\n\t}\n\n\tpublic getApplicationHomeServerToken(): string {\n\t\treturn settings.get('Federation_Matrix_hs_token');\n\t}\n\n\tpublic getApplicationApplicationServiceToken(): string {\n\t\treturn settings.get('Federation_Matrix_as_token');\n\t}\n\n\tpublic getBridgeUrl(): string {\n\t\treturn settings.get('Federation_Matrix_bridge_url');\n\t}\n\n\tpublic getBridgePort(): number {\n\t\tconst [, , port = '3300'] = this.getBridgeUrl().split(':');\n\n\t\treturn parseInt(port);\n\t}\n\n\tpublic getHomeServerUrl(): string {\n\t\treturn settings.get('Federation_Matrix_homeserver_url');\n\t}\n\n\tpublic getHomeServerDomain(): string {\n\t\treturn settings.get('Federation_Matrix_homeserver_domain');\n\t}\n\n\tpublic getBridgeBotUsername(): string {\n\t\treturn settings.get('Federation_Matrix_bridge_localpart');\n\t}\n\n\tpublic getMaximumSizeOfUsersWhenJoiningPublicRooms(): string {\n\t\treturn settings.get('Federation_Matrix_max_size_of_public_rooms_users');\n\t}\n\n\tpublic async disableFederation(): Promise<void> {\n\t\t// TODO: audit\n\t\t(await Settings.updateValueById('Federation_Matrix_enabled', false)).modifiedCount &&\n\t\t\tvoid notifyOnSettingChangedById('Federation_Matrix_enabled');\n\t}\n\n\tpublic isFederationEnabled(): boolean {\n\t\treturn settings.get('Federation_Matrix_enabled') === true;\n\t}\n\n\tpublic isTypingStatusEnabled(): boolean {\n\t\treturn settings.get('Federation_Matrix_enable_ephemeral_events') === true;\n\t}\n\n\tpublic isConfigurationValid(): boolean {\n\t\treturn settings.get('Federation_Matrix_configuration_status') === 'Valid';\n\t}\n\n\tpublic async setConfigurationStatus(status: 'Valid' | 'Invalid'): Promise<void> {\n\t\t// TODO: audit\n\t\tconst { modifiedCount } = await Settings.updateValueById('Federation_Matrix_configuration_status', status);\n\t\tif (modifiedCount) {\n\t\t\tvoid notifyOnSettingChangedById('Federation_Matrix_configuration_status');\n\t\t}\n\t}\n\n\tpublic onFederationEnabledStatusChanged(\n\t\tcallback: (\n\t\t\tenabled: boolean,\n\t\t\tappServiceId: string,\n\t\t\thomeServerUrl: string,\n\t\t\thomeServerDomain: string,\n\t\t\tbridgeUrl: string,\n\t\t\tbridgePort: number,\n\t\t\thomeServerRegistrationFile: IFederationBridgeRegistrationFile,\n\t\t) => Promise<void>,\n\t): () => void {\n\t\treturn settings.watchMultiple<boolean>(\n\t\t\t[\n\t\t\t\t'Federation_Matrix_enabled',\n\t\t\t\t'Federation_Matrix_id',\n\t\t\t\t'Federation_Matrix_hs_token',\n\t\t\t\t'Federation_Matrix_as_token',\n\t\t\t\t'Federation_Matrix_homeserver_url',\n\t\t\t\t'Federation_Matrix_homeserver_domain',\n\t\t\t\t'Federation_Matrix_bridge_url',\n\t\t\t\t'Federation_Matrix_bridge_localpart',\n\t\t\t],\n\t\t\t([enabled]) =>\n\t\t\t\tcallback(\n\t\t\t\t\tenabled === true,\n\t\t\t\t\tthis.getApplicationServiceId(),\n\t\t\t\t\tthis.getHomeServerUrl(),\n\t\t\t\t\tthis.getHomeServerDomain(),\n\t\t\t\t\tthis.getBridgeUrl(),\n\t\t\t\t\tthis.getBridgePort(),\n\t\t\t\t\tthis.getAppServiceRegistrationObject(),\n\t\t\t\t),\n\t\t);\n\t}\n\n\tpublic getAppServiceRegistrationObject(): IFederationBridgeRegistrationFile {\n\t\treturn {\n\t\t\tid: this.getApplicationServiceId(),\n\t\t\thomeserverToken: this.getApplicationHomeServerToken(),\n\t\t\tapplicationServiceToken: this.getApplicationApplicationServiceToken(),\n\t\t\tbridgeUrl: this.getBridgeUrl(),\n\t\t\tbotName: this.getBridgeBotUsername(),\n\t\t\tenableEphemeralEvents: this.isTypingStatusEnabled(),\n\t\t\tlistenTo: {\n\t\t\t\tusers: [\n\t\t\t\t\t{\n\t\t\t\t\t\texclusive: false,\n\t\t\t\t\t\tregex: LISTEN_RULES,\n\t\t\t\t\t},\n\t\t\t\t],\n\t\t\t\trooms: [\n\t\t\t\t\t{\n\t\t\t\t\t\texclusive: false,\n\t\t\t\t\t\tregex: LISTEN_RULES,\n\t\t\t\t\t},\n\t\t\t\t],\n\t\t\t\taliases: [\n\t\t\t\t\t{\n\t\t\t\t\t\texclusive: false,\n\t\t\t\t\t\tregex: LISTEN_RULES,\n\t\t\t\t\t},\n\t\t\t\t],\n\t\t\t},\n\t\t};\n\t}\n\n\tprivate async updateRegistrationFile(): Promise<void> {\n\t\tconst registrationFile = this.getAppServiceRegistrationObject();\n\n\t\tawait Settings.updateValueById(\n\t\t\t'Federation_Matrix_registration_file',\n\t\t\tyaml.dump({\n\t\t\t\t'id': registrationFile.id,\n\t\t\t\t'hs_token': registrationFile.homeserverToken,\n\t\t\t\t'as_token': registrationFile.applicationServiceToken,\n\t\t\t\t'url': registrationFile.bridgeUrl,\n\t\t\t\t'sender_localpart': registrationFile.botName,\n\t\t\t\t'namespaces': registrationFile.listenTo,\n\t\t\t\t'de.sorunome.msc2409.push_ephemeral': registrationFile.enableEphemeralEvents,\n\t\t\t}),\n\t\t);\n\t}\n\n\tprivate watchChangesAndUpdateRegistrationFile(): void {\n\t\tsettings.watchMultiple(\n\t\t\t[\n\t\t\t\t'Federation_Matrix_id',\n\t\t\t\t'Federation_Matrix_hs_token',\n\t\t\t\t'Federation_Matrix_as_token',\n\t\t\t\t'Federation_Matrix_homeserver_url',\n\t\t\t\t'Federation_Matrix_homeserver_domain',\n\t\t\t\t'Federation_Matrix_bridge_url',\n\t\t\t\t'Federation_Matrix_bridge_localpart',\n\t\t\t],\n\t\t\tthis.updateRegistrationFile.bind(this),\n\t\t);\n\t}\n\n\tprivate async addFederationSettings(): Promise<void> {\n\t\tawait settingsRegistry.add('Federation_Matrix_enabled', false, {\n\t\t\treadonly: false,\n\t\t\ttype: 'boolean',\n\t\t\ti18nLabel: 'Federation_Matrix_enabled',\n\t\t\ti18nDescription: 'Federation_Matrix_enabled_desc',\n\t\t\talert: 'Federation_Matrix_Enabled_Alert',\n\t\t\tpublic: true,\n\t\t\tgroup: 'Federation',\n\t\t\tsection: 'Matrix Bridge',\n\t\t});\n\n\t\tawait settingsRegistry.add('Federation_Matrix_serve_well_known', true, {\n\t\t\treadonly: false,\n\t\t\ttype: 'boolean',\n\t\t\ti18nLabel: 'Federation_Matrix_serve_well_known',\n\t\t\talert: 'Federation_Matrix_serve_well_known_Alert',\n\t\t\tgroup: 'Federation',\n\t\t\tsection: 'Matrix Bridge',\n\t\t});\n\n\t\tawait settingsRegistry.add('Federation_Matrix_enable_ephemeral_events', false, {\n\t\t\treadonly: false,\n\t\t\ttype: 'boolean',\n\t\t\ti18nLabel: 'Federation_Matrix_enable_ephemeral_events',\n\t\t\ti18nDescription: 'Federation_Matrix_enable_ephemeral_events_desc',\n\t\t\talert: 'Federation_Matrix_enable_ephemeral_events_Alert',\n\t\t\tpublic: true,\n\t\t\tgroup: 'Federation',\n\t\t\tsection: 'Matrix Bridge',\n\t\t});\n\n\t\tconst uniqueId = settings.get('uniqueID') || uuidv4().slice(0, 15).replace(new RegExp('-', 'g'), '_');\n\t\tconst homeserverToken = crypto.createHash('sha256').update(`hs_${uniqueId}`).digest('hex');\n\t\tconst applicationServiceToken = crypto.createHash('sha256').update(`as_${uniqueId}`).digest('hex');\n\n\t\tconst siteUrl = settings.get<string>('Site_Url');\n\n\t\tawait settingsRegistry.add('Federation_Matrix_id', `rocketchat_${uniqueId}`, {\n\t\t\treadonly: process.env.NODE_ENV === 'production',\n\t\t\ttype: 'string',\n\t\t\ti18nLabel: 'Federation_Matrix_id',\n\t\t\ti18nDescription: 'Federation_Matrix_id_desc',\n\t\t\tgroup: 'Federation',\n\t\t\tsection: 'Matrix Bridge',\n\t\t});\n\n\t\tawait settingsRegistry.add('Federation_Matrix_hs_token', homeserverToken, {\n\t\t\treadonly: process.env.NODE_ENV === 'production',\n\t\t\ttype: 'string',\n\t\t\ti18nLabel: 'Federation_Matrix_hs_token',\n\t\t\ti18nDescription: 'Federation_Matrix_hs_token_desc',\n\t\t\tgroup: 'Federation',\n\t\t\tsection: 'Matrix Bridge',\n\t\t});\n\n\t\tawait settingsRegistry.add('Federation_Matrix_as_token', applicationServiceToken, {\n\t\t\treadonly: process.env.NODE_ENV === 'production',\n\t\t\ttype: 'string',\n\t\t\ti18nLabel: 'Federation_Matrix_as_token',\n\t\t\ti18nDescription: 'Federation_Matrix_as_token_desc',\n\t\t\tgroup: 'Federation',\n\t\t\tsection: 'Matrix Bridge',\n\t\t});\n\n\t\tawait settingsRegistry.add('Federation_Matrix_homeserver_url', 'http://localhost:8008', {\n\t\t\ttype: 'string',\n\t\t\ti18nLabel: 'Federation_Matrix_homeserver_url',\n\t\t\ti18nDescription: 'Federation_Matrix_homeserver_url_desc',\n\t\t\talert: 'Federation_Matrix_homeserver_url_alert',\n\t\t\tgroup: 'Federation',\n\t\t\tsection: 'Matrix Bridge',\n\t\t});\n\n\t\tawait settingsRegistry.add('Federation_Matrix_homeserver_domain', siteUrl, {\n\t\t\ttype: 'string',\n\t\t\ti18nLabel: 'Federation_Matrix_homeserver_domain',\n\t\t\ti18nDescription: 'Federation_Matrix_homeserver_domain_desc',\n\t\t\talert: 'Federation_Matrix_homeserver_domain_alert',\n\t\t\tgroup: 'Federation',\n\t\t\tsection: 'Matrix Bridge',\n\t\t});\n\n\t\tawait settingsRegistry.add('Federation_Matrix_bridge_url', 'http://localhost:3300', {\n\t\t\ttype: 'string',\n\t\t\ti18nLabel: 'Federation_Matrix_bridge_url',\n\t\t\ti18nDescription: 'Federation_Matrix_bridge_url_desc',\n\t\t\tgroup: 'Federation',\n\t\t\tsection: 'Matrix Bridge',\n\t\t});\n\n\t\tawait settingsRegistry.add('Federation_Matrix_bridge_localpart', 'rocket.cat', {\n\t\t\ttype: 'string',\n\t\t\ti18nLabel: 'Federation_Matrix_bridge_localpart',\n\t\t\ti18nDescription: 'Federation_Matrix_bridge_localpart_desc',\n\t\t\tgroup: 'Federation',\n\t\t\tsection: 'Matrix Bridge',\n\t\t});\n\n\t\tawait settingsRegistry.add('Federation_Matrix_registration_file', '', {\n\t\t\treadonly: true,\n\t\t\ttype: 'code',\n\t\t\ti18nLabel: 'Federation_Matrix_registration_file',\n\t\t\ti18nDescription: 'Federation_Matrix_registration_file_desc',\n\t\t\talert: 'Federation_Matrix_registration_file_Alert',\n\t\t\tgroup: 'Federation',\n\t\t\tsection: 'Matrix Bridge',\n\t\t});\n\n\t\tawait settingsRegistry.add('Federation_Matrix_max_size_of_public_rooms_users', 100, {\n\t\t\treadonly: false,\n\t\t\ttype: 'int',\n\t\t\ti18nLabel: 'Federation_Matrix_max_size_of_public_rooms_users',\n\t\t\ti18nDescription: 'Federation_Matrix_max_size_of_public_rooms_users_desc',\n\t\t\talert: 'Federation_Matrix_max_size_of_public_rooms_users_Alert',\n\t\t\tpublic: true,\n\t\t\tenterprise: true,\n\t\t\tinvalidValue: false,\n\t\t\tgroup: 'Federation',\n\t\t\tsection: 'Matrix Bridge',\n\t\t});\n\n\t\tawait settingsRegistry.add('Federation_Matrix_configuration_status', 'Invalid', {\n\t\t\treadonly: true,\n\t\t\ttype: 'string',\n\t\t\ti18nLabel: 'Federation_Matrix_configuration_status',\n\t\t\ti18nDescription: 'Federation_Matrix_configuration_status_desc',\n\t\t\tpublic: false,\n\t\t\tenterprise: false,\n\t\t\tinvalidValue: '',\n\t\t\tgroup: 'Federation',\n\t\t\tsection: 'Matrix Bridge',\n\t\t});\n\n\t\tawait settingsRegistry.add('Federation_Matrix_check_configuration_button', 'checkFederationConfiguration', {\n\t\t\ttype: 'action',\n\t\t\tactionText: 'Federation_Matrix_check_configuration',\n\t\t\tpublic: false,\n\t\t\tenterprise: false,\n\t\t\tinvalidValue: '',\n\t\t\tgroup: 'Federation',\n\t\t\tsection: 'Matrix Bridge',\n\t\t});\n\t}\n}\n"]},"targets":{"android":"125.0.0","chrome":"125.0.0","edge":"125.0.0","firefox":"115.0.0","ie":"10.0.0","ios":"17.4.0","opera":"110.0.0","opera_mobile":"80.0.0","safari":"17.4.0","samsung":"24.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor","root":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":false,"enforceStrictMode":false,"dynamicImport":true,"generateLetDeclarations":true,"topLevelAwait":true},"externalDependencies":[]},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"version":"7.17.2","helpers":true,"useESModules":false,"corejs":false},"externalDependencies":[]},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-async-generator-functions","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-class-properties","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true},"externalDependencies":[]},{"key":"transform-react-jsx","visitor":{"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXFragment":{"exit":[null]},"JSXElement":{"exit":[null]},"JSXAttribute":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false},"externalDependencies":[]},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-nullish-coalescing-operator","visitor":{"LogicalExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-optional-chaining","visitor":{"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-optional-catch-binding","visitor":{"CatchClause":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-class-properties","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-async-generator-functions","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-logical-assignment-operators","visitor":{"AssignmentExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]}],"presets":[],"generatorOpts":{"filename":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/server/services/federation/infrastructure/rocket-chat/adapters/Settings.ts","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"server/services/federation/infrastructure/rocket-chat/adapters/Settings.ts","inputSourceMap":{"version":3,"file":"server/services/federation/infrastructure/rocket-chat/adapters/Settings.ts","sourceRoot":"","sources":["server/services/federation/infrastructure/rocket-chat/adapters/Settings.ts"],"names":[],"mappings":"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","sourcesContent":["import crypto from 'crypto';\n\nimport { Settings } from '@rocket.chat/models';\nimport yaml from 'js-yaml';\nimport { v4 as uuidv4 } from 'uuid';\n\nimport { notifyOnSettingChangedById } from '../../../../../../app/lib/server/lib/notifyListener';\nimport { settings, settingsRegistry } from '../../../../../../app/settings/server';\nimport type { IFederationBridgeRegistrationFile } from '../../../domain/IFederationBridge';\n\nconst EVERYTHING_REGEX = '.*';\nconst LISTEN_RULES = EVERYTHING_REGEX;\n\nexport class RocketChatSettingsAdapter {\n\tpublic async initialize() {\n\t\tawait this.addFederationSettings();\n\t\tthis.watchChangesAndUpdateRegistrationFile();\n\t}\n\n\tpublic getApplicationServiceId(): string {\n\t\treturn settings.get('Federation_Matrix_id');\n\t}\n\n\tpublic getApplicationHomeServerToken(): string {\n\t\treturn settings.get('Federation_Matrix_hs_token');\n\t}\n\n\tpublic getApplicationApplicationServiceToken(): string {\n\t\treturn settings.get('Federation_Matrix_as_token');\n\t}\n\n\tpublic getBridgeUrl(): string {\n\t\treturn settings.get('Federation_Matrix_bridge_url');\n\t}\n\n\tpublic getBridgePort(): number {\n\t\tconst [, , port = '3300'] = this.getBridgeUrl().split(':');\n\n\t\treturn parseInt(port);\n\t}\n\n\tpublic getHomeServerUrl(): string {\n\t\treturn settings.get('Federation_Matrix_homeserver_url');\n\t}\n\n\tpublic getHomeServerDomain(): string {\n\t\treturn settings.get('Federation_Matrix_homeserver_domain');\n\t}\n\n\tpublic getBridgeBotUsername(): string {\n\t\treturn settings.get('Federation_Matrix_bridge_localpart');\n\t}\n\n\tpublic getMaximumSizeOfUsersWhenJoiningPublicRooms(): string {\n\t\treturn settings.get('Federation_Matrix_max_size_of_public_rooms_users');\n\t}\n\n\tpublic async disableFederation(): Promise<void> {\n\t\t// TODO: audit\n\t\t(await Settings.updateValueById('Federation_Matrix_enabled', false)).modifiedCount &&\n\t\t\tvoid notifyOnSettingChangedById('Federation_Matrix_enabled');\n\t}\n\n\tpublic isFederationEnabled(): boolean {\n\t\treturn settings.get('Federation_Matrix_enabled') === true;\n\t}\n\n\tpublic isTypingStatusEnabled(): boolean {\n\t\treturn settings.get('Federation_Matrix_enable_ephemeral_events') === true;\n\t}\n\n\tpublic isConfigurationValid(): boolean {\n\t\treturn settings.get('Federation_Matrix_configuration_status') === 'Valid';\n\t}\n\n\tpublic async setConfigurationStatus(status: 'Valid' | 'Invalid'): Promise<void> {\n\t\t// TODO: audit\n\t\tconst { modifiedCount } = await Settings.updateValueById('Federation_Matrix_configuration_status', status);\n\t\tif (modifiedCount) {\n\t\t\tvoid notifyOnSettingChangedById('Federation_Matrix_configuration_status');\n\t\t}\n\t}\n\n\tpublic onFederationEnabledStatusChanged(\n\t\tcallback: (\n\t\t\tenabled: boolean,\n\t\t\tappServiceId: string,\n\t\t\thomeServerUrl: string,\n\t\t\thomeServerDomain: string,\n\t\t\tbridgeUrl: string,\n\t\t\tbridgePort: number,\n\t\t\thomeServerRegistrationFile: IFederationBridgeRegistrationFile,\n\t\t) => Promise<void>,\n\t): () => void {\n\t\treturn settings.watchMultiple<boolean>(\n\t\t\t[\n\t\t\t\t'Federation_Matrix_enabled',\n\t\t\t\t'Federation_Matrix_id',\n\t\t\t\t'Federation_Matrix_hs_token',\n\t\t\t\t'Federation_Matrix_as_token',\n\t\t\t\t'Federation_Matrix_homeserver_url',\n\t\t\t\t'Federation_Matrix_homeserver_domain',\n\t\t\t\t'Federation_Matrix_bridge_url',\n\t\t\t\t'Federation_Matrix_bridge_localpart',\n\t\t\t],\n\t\t\t([enabled]) =>\n\t\t\t\tcallback(\n\t\t\t\t\tenabled === true,\n\t\t\t\t\tthis.getApplicationServiceId(),\n\t\t\t\t\tthis.getHomeServerUrl(),\n\t\t\t\t\tthis.getHomeServerDomain(),\n\t\t\t\t\tthis.getBridgeUrl(),\n\t\t\t\t\tthis.getBridgePort(),\n\t\t\t\t\tthis.getAppServiceRegistrationObject(),\n\t\t\t\t),\n\t\t);\n\t}\n\n\tpublic getAppServiceRegistrationObject(): IFederationBridgeRegistrationFile {\n\t\treturn {\n\t\t\tid: this.getApplicationServiceId(),\n\t\t\thomeserverToken: this.getApplicationHomeServerToken(),\n\t\t\tapplicationServiceToken: this.getApplicationApplicationServiceToken(),\n\t\t\tbridgeUrl: this.getBridgeUrl(),\n\t\t\tbotName: this.getBridgeBotUsername(),\n\t\t\tenableEphemeralEvents: this.isTypingStatusEnabled(),\n\t\t\tlistenTo: {\n\t\t\t\tusers: [\n\t\t\t\t\t{\n\t\t\t\t\t\texclusive: false,\n\t\t\t\t\t\tregex: LISTEN_RULES,\n\t\t\t\t\t},\n\t\t\t\t],\n\t\t\t\trooms: [\n\t\t\t\t\t{\n\t\t\t\t\t\texclusive: false,\n\t\t\t\t\t\tregex: LISTEN_RULES,\n\t\t\t\t\t},\n\t\t\t\t],\n\t\t\t\taliases: [\n\t\t\t\t\t{\n\t\t\t\t\t\texclusive: false,\n\t\t\t\t\t\tregex: LISTEN_RULES,\n\t\t\t\t\t},\n\t\t\t\t],\n\t\t\t},\n\t\t};\n\t}\n\n\tprivate async updateRegistrationFile(): Promise<void> {\n\t\tconst registrationFile = this.getAppServiceRegistrationObject();\n\n\t\tawait Settings.updateValueById(\n\t\t\t'Federation_Matrix_registration_file',\n\t\t\tyaml.dump({\n\t\t\t\t'id': registrationFile.id,\n\t\t\t\t'hs_token': registrationFile.homeserverToken,\n\t\t\t\t'as_token': registrationFile.applicationServiceToken,\n\t\t\t\t'url': registrationFile.bridgeUrl,\n\t\t\t\t'sender_localpart': registrationFile.botName,\n\t\t\t\t'namespaces': registrationFile.listenTo,\n\t\t\t\t'de.sorunome.msc2409.push_ephemeral': registrationFile.enableEphemeralEvents,\n\t\t\t}),\n\t\t);\n\t}\n\n\tprivate watchChangesAndUpdateRegistrationFile(): void {\n\t\tsettings.watchMultiple(\n\t\t\t[\n\t\t\t\t'Federation_Matrix_id',\n\t\t\t\t'Federation_Matrix_hs_token',\n\t\t\t\t'Federation_Matrix_as_token',\n\t\t\t\t'Federation_Matrix_homeserver_url',\n\t\t\t\t'Federation_Matrix_homeserver_domain',\n\t\t\t\t'Federation_Matrix_bridge_url',\n\t\t\t\t'Federation_Matrix_bridge_localpart',\n\t\t\t],\n\t\t\tthis.updateRegistrationFile.bind(this),\n\t\t);\n\t}\n\n\tprivate async addFederationSettings(): Promise<void> {\n\t\tawait settingsRegistry.add('Federation_Matrix_enabled', false, {\n\t\t\treadonly: false,\n\t\t\ttype: 'boolean',\n\t\t\ti18nLabel: 'Federation_Matrix_enabled',\n\t\t\ti18nDescription: 'Federation_Matrix_enabled_desc',\n\t\t\talert: 'Federation_Matrix_Enabled_Alert',\n\t\t\tpublic: true,\n\t\t\tgroup: 'Federation',\n\t\t\tsection: 'Matrix Bridge',\n\t\t});\n\n\t\tawait settingsRegistry.add('Federation_Matrix_serve_well_known', true, {\n\t\t\treadonly: false,\n\t\t\ttype: 'boolean',\n\t\t\ti18nLabel: 'Federation_Matrix_serve_well_known',\n\t\t\talert: 'Federation_Matrix_serve_well_known_Alert',\n\t\t\tgroup: 'Federation',\n\t\t\tsection: 'Matrix Bridge',\n\t\t});\n\n\t\tawait settingsRegistry.add('Federation_Matrix_enable_ephemeral_events', false, {\n\t\t\treadonly: false,\n\t\t\ttype: 'boolean',\n\t\t\ti18nLabel: 'Federation_Matrix_enable_ephemeral_events',\n\t\t\ti18nDescription: 'Federation_Matrix_enable_ephemeral_events_desc',\n\t\t\talert: 'Federation_Matrix_enable_ephemeral_events_Alert',\n\t\t\tpublic: true,\n\t\t\tgroup: 'Federation',\n\t\t\tsection: 'Matrix Bridge',\n\t\t});\n\n\t\tconst uniqueId = settings.get('uniqueID') || uuidv4().slice(0, 15).replace(new RegExp('-', 'g'), '_');\n\t\tconst homeserverToken = crypto.createHash('sha256').update(`hs_${uniqueId}`).digest('hex');\n\t\tconst applicationServiceToken = crypto.createHash('sha256').update(`as_${uniqueId}`).digest('hex');\n\n\t\tconst siteUrl = settings.get<string>('Site_Url');\n\n\t\tawait settingsRegistry.add('Federation_Matrix_id', `rocketchat_${uniqueId}`, {\n\t\t\treadonly: process.env.NODE_ENV === 'production',\n\t\t\ttype: 'string',\n\t\t\ti18nLabel: 'Federation_Matrix_id',\n\t\t\ti18nDescription: 'Federation_Matrix_id_desc',\n\t\t\tgroup: 'Federation',\n\t\t\tsection: 'Matrix Bridge',\n\t\t});\n\n\t\tawait settingsRegistry.add('Federation_Matrix_hs_token', homeserverToken, {\n\t\t\treadonly: process.env.NODE_ENV === 'production',\n\t\t\ttype: 'string',\n\t\t\ti18nLabel: 'Federation_Matrix_hs_token',\n\t\t\ti18nDescription: 'Federation_Matrix_hs_token_desc',\n\t\t\tgroup: 'Federation',\n\t\t\tsection: 'Matrix Bridge',\n\t\t});\n\n\t\tawait settingsRegistry.add('Federation_Matrix_as_token', applicationServiceToken, {\n\t\t\treadonly: process.env.NODE_ENV === 'production',\n\t\t\ttype: 'string',\n\t\t\ti18nLabel: 'Federation_Matrix_as_token',\n\t\t\ti18nDescription: 'Federation_Matrix_as_token_desc',\n\t\t\tgroup: 'Federation',\n\t\t\tsection: 'Matrix Bridge',\n\t\t});\n\n\t\tawait settingsRegistry.add('Federation_Matrix_homeserver_url', 'http://localhost:8008', {\n\t\t\ttype: 'string',\n\t\t\ti18nLabel: 'Federation_Matrix_homeserver_url',\n\t\t\ti18nDescription: 'Federation_Matrix_homeserver_url_desc',\n\t\t\talert: 'Federation_Matrix_homeserver_url_alert',\n\t\t\tgroup: 'Federation',\n\t\t\tsection: 'Matrix Bridge',\n\t\t});\n\n\t\tawait settingsRegistry.add('Federation_Matrix_homeserver_domain', siteUrl, {\n\t\t\ttype: 'string',\n\t\t\ti18nLabel: 'Federation_Matrix_homeserver_domain',\n\t\t\ti18nDescription: 'Federation_Matrix_homeserver_domain_desc',\n\t\t\talert: 'Federation_Matrix_homeserver_domain_alert',\n\t\t\tgroup: 'Federation',\n\t\t\tsection: 'Matrix Bridge',\n\t\t});\n\n\t\tawait settingsRegistry.add('Federation_Matrix_bridge_url', 'http://localhost:3300', {\n\t\t\ttype: 'string',\n\t\t\ti18nLabel: 'Federation_Matrix_bridge_url',\n\t\t\ti18nDescription: 'Federation_Matrix_bridge_url_desc',\n\t\t\tgroup: 'Federation',\n\t\t\tsection: 'Matrix Bridge',\n\t\t});\n\n\t\tawait settingsRegistry.add('Federation_Matrix_bridge_localpart', 'rocket.cat', {\n\t\t\ttype: 'string',\n\t\t\ti18nLabel: 'Federation_Matrix_bridge_localpart',\n\t\t\ti18nDescription: 'Federation_Matrix_bridge_localpart_desc',\n\t\t\tgroup: 'Federation',\n\t\t\tsection: 'Matrix Bridge',\n\t\t});\n\n\t\tawait settingsRegistry.add('Federation_Matrix_registration_file', '', {\n\t\t\treadonly: true,\n\t\t\ttype: 'code',\n\t\t\ti18nLabel: 'Federation_Matrix_registration_file',\n\t\t\ti18nDescription: 'Federation_Matrix_registration_file_desc',\n\t\t\talert: 'Federation_Matrix_registration_file_Alert',\n\t\t\tgroup: 'Federation',\n\t\t\tsection: 'Matrix Bridge',\n\t\t});\n\n\t\tawait settingsRegistry.add('Federation_Matrix_max_size_of_public_rooms_users', 100, {\n\t\t\treadonly: false,\n\t\t\ttype: 'int',\n\t\t\ti18nLabel: 'Federation_Matrix_max_size_of_public_rooms_users',\n\t\t\ti18nDescription: 'Federation_Matrix_max_size_of_public_rooms_users_desc',\n\t\t\talert: 'Federation_Matrix_max_size_of_public_rooms_users_Alert',\n\t\t\tpublic: true,\n\t\t\tenterprise: true,\n\t\t\tinvalidValue: false,\n\t\t\tgroup: 'Federation',\n\t\t\tsection: 'Matrix Bridge',\n\t\t});\n\n\t\tawait settingsRegistry.add('Federation_Matrix_configuration_status', 'Invalid', {\n\t\t\treadonly: true,\n\t\t\ttype: 'string',\n\t\t\ti18nLabel: 'Federation_Matrix_configuration_status',\n\t\t\ti18nDescription: 'Federation_Matrix_configuration_status_desc',\n\t\t\tpublic: false,\n\t\t\tenterprise: false,\n\t\t\tinvalidValue: '',\n\t\t\tgroup: 'Federation',\n\t\t\tsection: 'Matrix Bridge',\n\t\t});\n\n\t\tawait settingsRegistry.add('Federation_Matrix_check_configuration_button', 'checkFederationConfiguration', {\n\t\t\ttype: 'action',\n\t\t\tactionText: 'Federation_Matrix_check_configuration',\n\t\t\tpublic: false,\n\t\t\tenterprise: false,\n\t\t\tinvalidValue: '',\n\t\t\tgroup: 'Federation',\n\t\t\tsection: 'Matrix Bridge',\n\t\t});\n\t}\n}\n"]}}},"code":"!module.wrapAsync(async function (module, __reifyWaitForDeps__, __reify_async_result__) {\n  \"use strict\";\n  try {\n    module.export({\n      RocketChatSettingsAdapter: () => RocketChatSettingsAdapter\n    });\n    let crypto;\n    module.link(\"crypto\", {\n      default(v) {\n        crypto = v;\n      }\n    }, 0);\n    let Settings;\n    module.link(\"@rocket.chat/models\", {\n      Settings(v) {\n        Settings = v;\n      }\n    }, 1);\n    let yaml;\n    module.link(\"js-yaml\", {\n      default(v) {\n        yaml = v;\n      }\n    }, 2);\n    let uuidv4;\n    module.link(\"uuid\", {\n      v4(v) {\n        uuidv4 = v;\n      }\n    }, 3);\n    let notifyOnSettingChangedById;\n    module.link(\"../../../../../../app/lib/server/lib/notifyListener\", {\n      notifyOnSettingChangedById(v) {\n        notifyOnSettingChangedById = v;\n      }\n    }, 4);\n    let settings, settingsRegistry;\n    module.link(\"../../../../../../app/settings/server\", {\n      settings(v) {\n        settings = v;\n      },\n      settingsRegistry(v) {\n        settingsRegistry = v;\n      }\n    }, 5);\n    if (__reifyWaitForDeps__()) (await __reifyWaitForDeps__())();\n    const EVERYTHING_REGEX = '.*';\n    const LISTEN_RULES = EVERYTHING_REGEX;\n    class RocketChatSettingsAdapter {\n      async initialize() {\n        await this.addFederationSettings();\n        this.watchChangesAndUpdateRegistrationFile();\n      }\n      getApplicationServiceId() {\n        return settings.get('Federation_Matrix_id');\n      }\n      getApplicationHomeServerToken() {\n        return settings.get('Federation_Matrix_hs_token');\n      }\n      getApplicationApplicationServiceToken() {\n        return settings.get('Federation_Matrix_as_token');\n      }\n      getBridgeUrl() {\n        return settings.get('Federation_Matrix_bridge_url');\n      }\n      getBridgePort() {\n        const [,, port = '3300'] = this.getBridgeUrl().split(':');\n        return parseInt(port);\n      }\n      getHomeServerUrl() {\n        return settings.get('Federation_Matrix_homeserver_url');\n      }\n      getHomeServerDomain() {\n        return settings.get('Federation_Matrix_homeserver_domain');\n      }\n      getBridgeBotUsername() {\n        return settings.get('Federation_Matrix_bridge_localpart');\n      }\n      getMaximumSizeOfUsersWhenJoiningPublicRooms() {\n        return settings.get('Federation_Matrix_max_size_of_public_rooms_users');\n      }\n      async disableFederation() {\n        // TODO: audit\n        (await Settings.updateValueById('Federation_Matrix_enabled', false)).modifiedCount && void notifyOnSettingChangedById('Federation_Matrix_enabled');\n      }\n      isFederationEnabled() {\n        return settings.get('Federation_Matrix_enabled') === true;\n      }\n      isTypingStatusEnabled() {\n        return settings.get('Federation_Matrix_enable_ephemeral_events') === true;\n      }\n      isConfigurationValid() {\n        return settings.get('Federation_Matrix_configuration_status') === 'Valid';\n      }\n      async setConfigurationStatus(status) {\n        // TODO: audit\n        const {\n          modifiedCount\n        } = await Settings.updateValueById('Federation_Matrix_configuration_status', status);\n        if (modifiedCount) {\n          void notifyOnSettingChangedById('Federation_Matrix_configuration_status');\n        }\n      }\n      onFederationEnabledStatusChanged(callback) {\n        return settings.watchMultiple(['Federation_Matrix_enabled', 'Federation_Matrix_id', 'Federation_Matrix_hs_token', 'Federation_Matrix_as_token', 'Federation_Matrix_homeserver_url', 'Federation_Matrix_homeserver_domain', 'Federation_Matrix_bridge_url', 'Federation_Matrix_bridge_localpart'], _ref => {\n          let [enabled] = _ref;\n          return callback(enabled === true, this.getApplicationServiceId(), this.getHomeServerUrl(), this.getHomeServerDomain(), this.getBridgeUrl(), this.getBridgePort(), this.getAppServiceRegistrationObject());\n        });\n      }\n      getAppServiceRegistrationObject() {\n        return {\n          id: this.getApplicationServiceId(),\n          homeserverToken: this.getApplicationHomeServerToken(),\n          applicationServiceToken: this.getApplicationApplicationServiceToken(),\n          bridgeUrl: this.getBridgeUrl(),\n          botName: this.getBridgeBotUsername(),\n          enableEphemeralEvents: this.isTypingStatusEnabled(),\n          listenTo: {\n            users: [{\n              exclusive: false,\n              regex: LISTEN_RULES\n            }],\n            rooms: [{\n              exclusive: false,\n              regex: LISTEN_RULES\n            }],\n            aliases: [{\n              exclusive: false,\n              regex: LISTEN_RULES\n            }]\n          }\n        };\n      }\n      async updateRegistrationFile() {\n        const registrationFile = this.getAppServiceRegistrationObject();\n        await Settings.updateValueById('Federation_Matrix_registration_file', yaml.dump({\n          'id': registrationFile.id,\n          'hs_token': registrationFile.homeserverToken,\n          'as_token': registrationFile.applicationServiceToken,\n          'url': registrationFile.bridgeUrl,\n          'sender_localpart': registrationFile.botName,\n          'namespaces': registrationFile.listenTo,\n          'de.sorunome.msc2409.push_ephemeral': registrationFile.enableEphemeralEvents\n        }));\n      }\n      watchChangesAndUpdateRegistrationFile() {\n        settings.watchMultiple(['Federation_Matrix_id', 'Federation_Matrix_hs_token', 'Federation_Matrix_as_token', 'Federation_Matrix_homeserver_url', 'Federation_Matrix_homeserver_domain', 'Federation_Matrix_bridge_url', 'Federation_Matrix_bridge_localpart'], this.updateRegistrationFile.bind(this));\n      }\n      async addFederationSettings() {\n        await settingsRegistry.add('Federation_Matrix_enabled', false, {\n          readonly: false,\n          type: 'boolean',\n          i18nLabel: 'Federation_Matrix_enabled',\n          i18nDescription: 'Federation_Matrix_enabled_desc',\n          alert: 'Federation_Matrix_Enabled_Alert',\n          public: true,\n          group: 'Federation',\n          section: 'Matrix Bridge'\n        });\n        await settingsRegistry.add('Federation_Matrix_serve_well_known', true, {\n          readonly: false,\n          type: 'boolean',\n          i18nLabel: 'Federation_Matrix_serve_well_known',\n          alert: 'Federation_Matrix_serve_well_known_Alert',\n          group: 'Federation',\n          section: 'Matrix Bridge'\n        });\n        await settingsRegistry.add('Federation_Matrix_enable_ephemeral_events', false, {\n          readonly: false,\n          type: 'boolean',\n          i18nLabel: 'Federation_Matrix_enable_ephemeral_events',\n          i18nDescription: 'Federation_Matrix_enable_ephemeral_events_desc',\n          alert: 'Federation_Matrix_enable_ephemeral_events_Alert',\n          public: true,\n          group: 'Federation',\n          section: 'Matrix Bridge'\n        });\n        const uniqueId = settings.get('uniqueID') || uuidv4().slice(0, 15).replace(new RegExp('-', 'g'), '_');\n        const homeserverToken = crypto.createHash('sha256').update(\"hs_\".concat(uniqueId)).digest('hex');\n        const applicationServiceToken = crypto.createHash('sha256').update(\"as_\".concat(uniqueId)).digest('hex');\n        const siteUrl = settings.get('Site_Url');\n        await settingsRegistry.add('Federation_Matrix_id', \"rocketchat_\".concat(uniqueId), {\n          readonly: process.env.NODE_ENV === 'production',\n          type: 'string',\n          i18nLabel: 'Federation_Matrix_id',\n          i18nDescription: 'Federation_Matrix_id_desc',\n          group: 'Federation',\n          section: 'Matrix Bridge'\n        });\n        await settingsRegistry.add('Federation_Matrix_hs_token', homeserverToken, {\n          readonly: process.env.NODE_ENV === 'production',\n          type: 'string',\n          i18nLabel: 'Federation_Matrix_hs_token',\n          i18nDescription: 'Federation_Matrix_hs_token_desc',\n          group: 'Federation',\n          section: 'Matrix Bridge'\n        });\n        await settingsRegistry.add('Federation_Matrix_as_token', applicationServiceToken, {\n          readonly: process.env.NODE_ENV === 'production',\n          type: 'string',\n          i18nLabel: 'Federation_Matrix_as_token',\n          i18nDescription: 'Federation_Matrix_as_token_desc',\n          group: 'Federation',\n          section: 'Matrix Bridge'\n        });\n        await settingsRegistry.add('Federation_Matrix_homeserver_url', 'http://localhost:8008', {\n          type: 'string',\n          i18nLabel: 'Federation_Matrix_homeserver_url',\n          i18nDescription: 'Federation_Matrix_homeserver_url_desc',\n          alert: 'Federation_Matrix_homeserver_url_alert',\n          group: 'Federation',\n          section: 'Matrix Bridge'\n        });\n        await settingsRegistry.add('Federation_Matrix_homeserver_domain', siteUrl, {\n          type: 'string',\n          i18nLabel: 'Federation_Matrix_homeserver_domain',\n          i18nDescription: 'Federation_Matrix_homeserver_domain_desc',\n          alert: 'Federation_Matrix_homeserver_domain_alert',\n          group: 'Federation',\n          section: 'Matrix Bridge'\n        });\n        await settingsRegistry.add('Federation_Matrix_bridge_url', 'http://localhost:3300', {\n          type: 'string',\n          i18nLabel: 'Federation_Matrix_bridge_url',\n          i18nDescription: 'Federation_Matrix_bridge_url_desc',\n          group: 'Federation',\n          section: 'Matrix Bridge'\n        });\n        await settingsRegistry.add('Federation_Matrix_bridge_localpart', 'rocket.cat', {\n          type: 'string',\n          i18nLabel: 'Federation_Matrix_bridge_localpart',\n          i18nDescription: 'Federation_Matrix_bridge_localpart_desc',\n          group: 'Federation',\n          section: 'Matrix Bridge'\n        });\n        await settingsRegistry.add('Federation_Matrix_registration_file', '', {\n          readonly: true,\n          type: 'code',\n          i18nLabel: 'Federation_Matrix_registration_file',\n          i18nDescription: 'Federation_Matrix_registration_file_desc',\n          alert: 'Federation_Matrix_registration_file_Alert',\n          group: 'Federation',\n          section: 'Matrix Bridge'\n        });\n        await settingsRegistry.add('Federation_Matrix_max_size_of_public_rooms_users', 100, {\n          readonly: false,\n          type: 'int',\n          i18nLabel: 'Federation_Matrix_max_size_of_public_rooms_users',\n          i18nDescription: 'Federation_Matrix_max_size_of_public_rooms_users_desc',\n          alert: 'Federation_Matrix_max_size_of_public_rooms_users_Alert',\n          public: true,\n          enterprise: true,\n          invalidValue: false,\n          group: 'Federation',\n          section: 'Matrix Bridge'\n        });\n        await settingsRegistry.add('Federation_Matrix_configuration_status', 'Invalid', {\n          readonly: true,\n          type: 'string',\n          i18nLabel: 'Federation_Matrix_configuration_status',\n          i18nDescription: 'Federation_Matrix_configuration_status_desc',\n          public: false,\n          enterprise: false,\n          invalidValue: '',\n          group: 'Federation',\n          section: 'Matrix Bridge'\n        });\n        await settingsRegistry.add('Federation_Matrix_check_configuration_button', 'checkFederationConfiguration', {\n          type: 'action',\n          actionText: 'Federation_Matrix_check_configuration',\n          public: false,\n          enterprise: false,\n          invalidValue: '',\n          group: 'Federation',\n          section: 'Matrix Bridge'\n        });\n      }\n    }\n    __reify_async_result__();\n  } catch (_reifyError) {\n    return __reify_async_result__(_reifyError);\n  }\n  __reify_async_result__()\n}, {\n  self: this,\n  async: false\n});","map":{"version":3,"names":["module","export","RocketChatSettingsAdapter","crypto","link","default","v","Settings","yaml","uuidv4","v4","notifyOnSettingChangedById","settings","settingsRegistry","__reifyWaitForDeps__","EVERYTHING_REGEX","LISTEN_RULES","initialize","addFederationSettings","watchChangesAndUpdateRegistrationFile","getApplicationServiceId","get","getApplicationHomeServerToken","getApplicationApplicationServiceToken","getBridgeUrl","getBridgePort","port","split","parseInt","getHomeServerUrl","getHomeServerDomain","getBridgeBotUsername","getMaximumSizeOfUsersWhenJoiningPublicRooms","disableFederation","updateValueById","modifiedCount","isFederationEnabled","isTypingStatusEnabled","isConfigurationValid","setConfigurationStatus","status","onFederationEnabledStatusChanged","callback","watchMultiple","_ref","enabled","getAppServiceRegistrationObject","id","homeserverToken","applicationServiceToken","bridgeUrl","botName","enableEphemeralEvents","listenTo","users","exclusive","regex","rooms","aliases","updateRegistrationFile","registrationFile","dump","bind","add","readonly","type","i18nLabel","i18nDescription","alert","public","group","section","uniqueId","slice","replace","RegExp","createHash","update","concat","digest","siteUrl","process","env","NODE_ENV","enterprise","invalidValue","actionText","__reify_async_result__","_reifyError","self","async"],"sources":["server/services/federation/infrastructure/rocket-chat/adapters/Settings.ts"],"sourcesContent":["import crypto from 'crypto';\n\nimport { Settings } from '@rocket.chat/models';\nimport yaml from 'js-yaml';\nimport { v4 as uuidv4 } from 'uuid';\n\nimport { notifyOnSettingChangedById } from '../../../../../../app/lib/server/lib/notifyListener';\nimport { settings, settingsRegistry } from '../../../../../../app/settings/server';\nimport type { IFederationBridgeRegistrationFile } from '../../../domain/IFederationBridge';\n\nconst EVERYTHING_REGEX = '.*';\nconst LISTEN_RULES = EVERYTHING_REGEX;\n\nexport class RocketChatSettingsAdapter {\n\tpublic async initialize() {\n\t\tawait this.addFederationSettings();\n\t\tthis.watchChangesAndUpdateRegistrationFile();\n\t}\n\n\tpublic getApplicationServiceId(): string {\n\t\treturn settings.get('Federation_Matrix_id');\n\t}\n\n\tpublic getApplicationHomeServerToken(): string {\n\t\treturn settings.get('Federation_Matrix_hs_token');\n\t}\n\n\tpublic getApplicationApplicationServiceToken(): string {\n\t\treturn settings.get('Federation_Matrix_as_token');\n\t}\n\n\tpublic getBridgeUrl(): string {\n\t\treturn settings.get('Federation_Matrix_bridge_url');\n\t}\n\n\tpublic getBridgePort(): number {\n\t\tconst [, , port = '3300'] = this.getBridgeUrl().split(':');\n\n\t\treturn parseInt(port);\n\t}\n\n\tpublic getHomeServerUrl(): string {\n\t\treturn settings.get('Federation_Matrix_homeserver_url');\n\t}\n\n\tpublic getHomeServerDomain(): string {\n\t\treturn settings.get('Federation_Matrix_homeserver_domain');\n\t}\n\n\tpublic getBridgeBotUsername(): string {\n\t\treturn settings.get('Federation_Matrix_bridge_localpart');\n\t}\n\n\tpublic getMaximumSizeOfUsersWhenJoiningPublicRooms(): string {\n\t\treturn settings.get('Federation_Matrix_max_size_of_public_rooms_users');\n\t}\n\n\tpublic async disableFederation(): Promise<void> {\n\t\t// TODO: audit\n\t\t(await Settings.updateValueById('Federation_Matrix_enabled', false)).modifiedCount &&\n\t\t\tvoid notifyOnSettingChangedById('Federation_Matrix_enabled');\n\t}\n\n\tpublic isFederationEnabled(): boolean {\n\t\treturn settings.get('Federation_Matrix_enabled') === true;\n\t}\n\n\tpublic isTypingStatusEnabled(): boolean {\n\t\treturn settings.get('Federation_Matrix_enable_ephemeral_events') === true;\n\t}\n\n\tpublic isConfigurationValid(): boolean {\n\t\treturn settings.get('Federation_Matrix_configuration_status') === 'Valid';\n\t}\n\n\tpublic async setConfigurationStatus(status: 'Valid' | 'Invalid'): Promise<void> {\n\t\t// TODO: audit\n\t\tconst { modifiedCount } = await Settings.updateValueById('Federation_Matrix_configuration_status', status);\n\t\tif (modifiedCount) {\n\t\t\tvoid notifyOnSettingChangedById('Federation_Matrix_configuration_status');\n\t\t}\n\t}\n\n\tpublic onFederationEnabledStatusChanged(\n\t\tcallback: (\n\t\t\tenabled: boolean,\n\t\t\tappServiceId: string,\n\t\t\thomeServerUrl: string,\n\t\t\thomeServerDomain: string,\n\t\t\tbridgeUrl: string,\n\t\t\tbridgePort: number,\n\t\t\thomeServerRegistrationFile: IFederationBridgeRegistrationFile,\n\t\t) => Promise<void>,\n\t): () => void {\n\t\treturn settings.watchMultiple<boolean>(\n\t\t\t[\n\t\t\t\t'Federation_Matrix_enabled',\n\t\t\t\t'Federation_Matrix_id',\n\t\t\t\t'Federation_Matrix_hs_token',\n\t\t\t\t'Federation_Matrix_as_token',\n\t\t\t\t'Federation_Matrix_homeserver_url',\n\t\t\t\t'Federation_Matrix_homeserver_domain',\n\t\t\t\t'Federation_Matrix_bridge_url',\n\t\t\t\t'Federation_Matrix_bridge_localpart',\n\t\t\t],\n\t\t\t([enabled]) =>\n\t\t\t\tcallback(\n\t\t\t\t\tenabled === true,\n\t\t\t\t\tthis.getApplicationServiceId(),\n\t\t\t\t\tthis.getHomeServerUrl(),\n\t\t\t\t\tthis.getHomeServerDomain(),\n\t\t\t\t\tthis.getBridgeUrl(),\n\t\t\t\t\tthis.getBridgePort(),\n\t\t\t\t\tthis.getAppServiceRegistrationObject(),\n\t\t\t\t),\n\t\t);\n\t}\n\n\tpublic getAppServiceRegistrationObject(): IFederationBridgeRegistrationFile {\n\t\treturn {\n\t\t\tid: this.getApplicationServiceId(),\n\t\t\thomeserverToken: this.getApplicationHomeServerToken(),\n\t\t\tapplicationServiceToken: this.getApplicationApplicationServiceToken(),\n\t\t\tbridgeUrl: this.getBridgeUrl(),\n\t\t\tbotName: this.getBridgeBotUsername(),\n\t\t\tenableEphemeralEvents: this.isTypingStatusEnabled(),\n\t\t\tlistenTo: {\n\t\t\t\tusers: [\n\t\t\t\t\t{\n\t\t\t\t\t\texclusive: false,\n\t\t\t\t\t\tregex: LISTEN_RULES,\n\t\t\t\t\t},\n\t\t\t\t],\n\t\t\t\trooms: [\n\t\t\t\t\t{\n\t\t\t\t\t\texclusive: false,\n\t\t\t\t\t\tregex: LISTEN_RULES,\n\t\t\t\t\t},\n\t\t\t\t],\n\t\t\t\taliases: [\n\t\t\t\t\t{\n\t\t\t\t\t\texclusive: false,\n\t\t\t\t\t\tregex: LISTEN_RULES,\n\t\t\t\t\t},\n\t\t\t\t],\n\t\t\t},\n\t\t};\n\t}\n\n\tprivate async updateRegistrationFile(): Promise<void> {\n\t\tconst registrationFile = this.getAppServiceRegistrationObject();\n\n\t\tawait Settings.updateValueById(\n\t\t\t'Federation_Matrix_registration_file',\n\t\t\tyaml.dump({\n\t\t\t\t'id': registrationFile.id,\n\t\t\t\t'hs_token': registrationFile.homeserverToken,\n\t\t\t\t'as_token': registrationFile.applicationServiceToken,\n\t\t\t\t'url': registrationFile.bridgeUrl,\n\t\t\t\t'sender_localpart': registrationFile.botName,\n\t\t\t\t'namespaces': registrationFile.listenTo,\n\t\t\t\t'de.sorunome.msc2409.push_ephemeral': registrationFile.enableEphemeralEvents,\n\t\t\t}),\n\t\t);\n\t}\n\n\tprivate watchChangesAndUpdateRegistrationFile(): void {\n\t\tsettings.watchMultiple(\n\t\t\t[\n\t\t\t\t'Federation_Matrix_id',\n\t\t\t\t'Federation_Matrix_hs_token',\n\t\t\t\t'Federation_Matrix_as_token',\n\t\t\t\t'Federation_Matrix_homeserver_url',\n\t\t\t\t'Federation_Matrix_homeserver_domain',\n\t\t\t\t'Federation_Matrix_bridge_url',\n\t\t\t\t'Federation_Matrix_bridge_localpart',\n\t\t\t],\n\t\t\tthis.updateRegistrationFile.bind(this),\n\t\t);\n\t}\n\n\tprivate async addFederationSettings(): Promise<void> {\n\t\tawait settingsRegistry.add('Federation_Matrix_enabled', false, {\n\t\t\treadonly: false,\n\t\t\ttype: 'boolean',\n\t\t\ti18nLabel: 'Federation_Matrix_enabled',\n\t\t\ti18nDescription: 'Federation_Matrix_enabled_desc',\n\t\t\talert: 'Federation_Matrix_Enabled_Alert',\n\t\t\tpublic: true,\n\t\t\tgroup: 'Federation',\n\t\t\tsection: 'Matrix Bridge',\n\t\t});\n\n\t\tawait settingsRegistry.add('Federation_Matrix_serve_well_known', true, {\n\t\t\treadonly: false,\n\t\t\ttype: 'boolean',\n\t\t\ti18nLabel: 'Federation_Matrix_serve_well_known',\n\t\t\talert: 'Federation_Matrix_serve_well_known_Alert',\n\t\t\tgroup: 'Federation',\n\t\t\tsection: 'Matrix Bridge',\n\t\t});\n\n\t\tawait settingsRegistry.add('Federation_Matrix_enable_ephemeral_events', false, {\n\t\t\treadonly: false,\n\t\t\ttype: 'boolean',\n\t\t\ti18nLabel: 'Federation_Matrix_enable_ephemeral_events',\n\t\t\ti18nDescription: 'Federation_Matrix_enable_ephemeral_events_desc',\n\t\t\talert: 'Federation_Matrix_enable_ephemeral_events_Alert',\n\t\t\tpublic: true,\n\t\t\tgroup: 'Federation',\n\t\t\tsection: 'Matrix Bridge',\n\t\t});\n\n\t\tconst uniqueId = settings.get('uniqueID') || uuidv4().slice(0, 15).replace(new RegExp('-', 'g'), '_');\n\t\tconst homeserverToken = crypto.createHash('sha256').update(`hs_${uniqueId}`).digest('hex');\n\t\tconst applicationServiceToken = crypto.createHash('sha256').update(`as_${uniqueId}`).digest('hex');\n\n\t\tconst siteUrl = settings.get<string>('Site_Url');\n\n\t\tawait settingsRegistry.add('Federation_Matrix_id', `rocketchat_${uniqueId}`, {\n\t\t\treadonly: process.env.NODE_ENV === 'production',\n\t\t\ttype: 'string',\n\t\t\ti18nLabel: 'Federation_Matrix_id',\n\t\t\ti18nDescription: 'Federation_Matrix_id_desc',\n\t\t\tgroup: 'Federation',\n\t\t\tsection: 'Matrix Bridge',\n\t\t});\n\n\t\tawait settingsRegistry.add('Federation_Matrix_hs_token', homeserverToken, {\n\t\t\treadonly: process.env.NODE_ENV === 'production',\n\t\t\ttype: 'string',\n\t\t\ti18nLabel: 'Federation_Matrix_hs_token',\n\t\t\ti18nDescription: 'Federation_Matrix_hs_token_desc',\n\t\t\tgroup: 'Federation',\n\t\t\tsection: 'Matrix Bridge',\n\t\t});\n\n\t\tawait settingsRegistry.add('Federation_Matrix_as_token', applicationServiceToken, {\n\t\t\treadonly: process.env.NODE_ENV === 'production',\n\t\t\ttype: 'string',\n\t\t\ti18nLabel: 'Federation_Matrix_as_token',\n\t\t\ti18nDescription: 'Federation_Matrix_as_token_desc',\n\t\t\tgroup: 'Federation',\n\t\t\tsection: 'Matrix Bridge',\n\t\t});\n\n\t\tawait settingsRegistry.add('Federation_Matrix_homeserver_url', 'http://localhost:8008', {\n\t\t\ttype: 'string',\n\t\t\ti18nLabel: 'Federation_Matrix_homeserver_url',\n\t\t\ti18nDescription: 'Federation_Matrix_homeserver_url_desc',\n\t\t\talert: 'Federation_Matrix_homeserver_url_alert',\n\t\t\tgroup: 'Federation',\n\t\t\tsection: 'Matrix Bridge',\n\t\t});\n\n\t\tawait settingsRegistry.add('Federation_Matrix_homeserver_domain', siteUrl, {\n\t\t\ttype: 'string',\n\t\t\ti18nLabel: 'Federation_Matrix_homeserver_domain',\n\t\t\ti18nDescription: 'Federation_Matrix_homeserver_domain_desc',\n\t\t\talert: 'Federation_Matrix_homeserver_domain_alert',\n\t\t\tgroup: 'Federation',\n\t\t\tsection: 'Matrix Bridge',\n\t\t});\n\n\t\tawait settingsRegistry.add('Federation_Matrix_bridge_url', 'http://localhost:3300', {\n\t\t\ttype: 'string',\n\t\t\ti18nLabel: 'Federation_Matrix_bridge_url',\n\t\t\ti18nDescription: 'Federation_Matrix_bridge_url_desc',\n\t\t\tgroup: 'Federation',\n\t\t\tsection: 'Matrix Bridge',\n\t\t});\n\n\t\tawait settingsRegistry.add('Federation_Matrix_bridge_localpart', 'rocket.cat', {\n\t\t\ttype: 'string',\n\t\t\ti18nLabel: 'Federation_Matrix_bridge_localpart',\n\t\t\ti18nDescription: 'Federation_Matrix_bridge_localpart_desc',\n\t\t\tgroup: 'Federation',\n\t\t\tsection: 'Matrix Bridge',\n\t\t});\n\n\t\tawait settingsRegistry.add('Federation_Matrix_registration_file', '', {\n\t\t\treadonly: true,\n\t\t\ttype: 'code',\n\t\t\ti18nLabel: 'Federation_Matrix_registration_file',\n\t\t\ti18nDescription: 'Federation_Matrix_registration_file_desc',\n\t\t\talert: 'Federation_Matrix_registration_file_Alert',\n\t\t\tgroup: 'Federation',\n\t\t\tsection: 'Matrix Bridge',\n\t\t});\n\n\t\tawait settingsRegistry.add('Federation_Matrix_max_size_of_public_rooms_users', 100, {\n\t\t\treadonly: false,\n\t\t\ttype: 'int',\n\t\t\ti18nLabel: 'Federation_Matrix_max_size_of_public_rooms_users',\n\t\t\ti18nDescription: 'Federation_Matrix_max_size_of_public_rooms_users_desc',\n\t\t\talert: 'Federation_Matrix_max_size_of_public_rooms_users_Alert',\n\t\t\tpublic: true,\n\t\t\tenterprise: true,\n\t\t\tinvalidValue: false,\n\t\t\tgroup: 'Federation',\n\t\t\tsection: 'Matrix Bridge',\n\t\t});\n\n\t\tawait settingsRegistry.add('Federation_Matrix_configuration_status', 'Invalid', {\n\t\t\treadonly: true,\n\t\t\ttype: 'string',\n\t\t\ti18nLabel: 'Federation_Matrix_configuration_status',\n\t\t\ti18nDescription: 'Federation_Matrix_configuration_status_desc',\n\t\t\tpublic: false,\n\t\t\tenterprise: false,\n\t\t\tinvalidValue: '',\n\t\t\tgroup: 'Federation',\n\t\t\tsection: 'Matrix Bridge',\n\t\t});\n\n\t\tawait settingsRegistry.add('Federation_Matrix_check_configuration_button', 'checkFederationConfiguration', {\n\t\t\ttype: 'action',\n\t\t\tactionText: 'Federation_Matrix_check_configuration',\n\t\t\tpublic: false,\n\t\t\tenterprise: false,\n\t\t\tinvalidValue: '',\n\t\t\tgroup: 'Federation',\n\t\t\tsection: 'Matrix Bridge',\n\t\t});\n\t}\n}\n"],"mappings":"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","ignoreList":[]},"sourceType":"module","externalDependencies":{},"hash":"77a241a2824423c846cc42723eb681b9aebc9a28"}
