{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/server/services/federation/domain/FederatedRoom.ts","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","topLevelAwait","objectRestSpread","objectRestSpread","asyncGenerators","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"os.osx.arm64"},"sourceFileName":"server/services/federation/domain/FederatedRoom.ts","filename":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/server/services/federation/domain/FederatedRoom.ts","inputSourceMap":{"version":3,"file":"server/services/federation/domain/FederatedRoom.ts","sourceRoot":"","sources":["server/services/federation/domain/FederatedRoom.ts"],"names":[],"mappings":"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","sourcesContent":["import { RoomType } from '@rocket.chat/apps-engine/definition/rooms';\nimport type { IDirectMessageRoom, IMessage, IRoom } from '@rocket.chat/core-typings';\nimport { ObjectId } from 'mongodb'; // This should not be in the domain layer, but its a known \"problem\"\n\nimport type { FederatedUser } from './FederatedUser';\n\nexport const isAnInternalIdentifier = (fromOriginName: string, localOriginName: string): boolean => {\n\treturn fromOriginName === localOriginName;\n};\n\nexport abstract class AbstractFederatedRoom {\n\tprotected externalId: string;\n\n\tprotected internalId: string;\n\n\tprotected internalReference: Partial<IRoom>;\n\n\tprotected constructor({ externalId, internalReference }: { externalId: string; internalReference: Partial<IRoom> }) {\n\t\tthis.externalId = externalId;\n\t\tthis.internalReference = internalReference;\n\t\tthis.internalId = internalReference._id || new ObjectId().toHexString();\n\t}\n\n\tprotected static generateTemporaryName(normalizedExternalId: string): string {\n\t\treturn `Federation-${normalizedExternalId}`;\n\t}\n\n\tpublic abstract isDirectMessage(): boolean;\n\n\tpublic getExternalId(): string {\n\t\treturn this.externalId;\n\t}\n\n\tpublic getRoomType(): RoomType {\n\t\treturn this.internalReference.t as RoomType;\n\t}\n\n\tpublic getInternalId(): string {\n\t\treturn this.internalId;\n\t}\n\n\tpublic getDisplayName(): string | undefined {\n\t\treturn this.internalReference.fname;\n\t}\n\n\tpublic getName(): string | undefined {\n\t\treturn this.internalReference.name;\n\t}\n\n\tpublic getTopic(): string | undefined {\n\t\treturn this.internalReference.topic;\n\t}\n\n\tpublic static isOriginalFromTheProxyServer(fromOriginName: string, proxyServerOriginName: string): boolean {\n\t\treturn isAnInternalIdentifier(fromOriginName, proxyServerOriginName);\n\t}\n\n\tpublic getInternalReference(): Readonly<Partial<IRoom>> {\n\t\treturn Object.freeze({\n\t\t\t...this.internalReference,\n\t\t\t_id: this.internalId,\n\t\t});\n\t}\n\n\tpublic getCreatorUsername(): string | undefined {\n\t\treturn this.internalReference.u?.username;\n\t}\n\n\tpublic isTheCreator(userId: string): boolean {\n\t\treturn this.internalReference.u?._id === userId;\n\t}\n\n\tpublic getCreatorId(): string | undefined {\n\t\treturn this.internalReference.u?._id;\n\t}\n\n\tpublic changeRoomType(type: RoomType): void {\n\t\tif (this.isDirectMessage()) {\n\t\t\tthrow new Error('Its not possible to change a direct message type');\n\t\t}\n\t\tthis.internalReference.t = type;\n\t}\n\n\tpublic changeDisplayRoomName(displayName: string): void {\n\t\tif (this.isDirectMessage()) {\n\t\t\tthrow new Error('Its not possible to change a direct message name');\n\t\t}\n\t\tthis.internalReference.fname = displayName;\n\t}\n\n\tpublic shouldUpdateRoomName(aRoomName: string): boolean {\n\t\treturn this.internalReference?.name !== aRoomName && !this.isDirectMessage();\n\t}\n\n\tpublic changeRoomName(name: string): void {\n\t\tif (this.isDirectMessage()) {\n\t\t\tthrow new Error('Its not possible to change a direct message name');\n\t\t}\n\t\tthis.internalReference.name = name;\n\t}\n\n\tpublic changeRoomTopic(topic: string): void {\n\t\tif (this.isDirectMessage()) {\n\t\t\tthrow new Error('Its not possible to change a direct message topic');\n\t\t}\n\t\tthis.internalReference.topic = topic;\n\t}\n\n\tpublic shouldUpdateDisplayRoomName(aRoomName: string): boolean {\n\t\treturn this.internalReference?.fname !== aRoomName && !this.isDirectMessage();\n\t}\n\n\tpublic shouldUpdateRoomTopic(aRoomTopic: string): boolean {\n\t\treturn this.internalReference?.topic !== aRoomTopic && !this.isDirectMessage();\n\t}\n\n\tpublic static shouldUpdateMessage(newMessageText: string, originalMessage: IMessage): boolean {\n\t\treturn originalMessage.msg !== newMessageText;\n\t}\n}\n\nexport class FederatedRoom extends AbstractFederatedRoom {\n\tprotected constructor({ externalId, internalReference }: { externalId: string; internalReference: Partial<IRoom> }) {\n\t\tsuper({ externalId, internalReference });\n\t}\n\n\tpublic static createInstance(\n\t\texternalId: string,\n\t\tnormalizedExternalId: string,\n\t\tcreator: FederatedUser,\n\t\ttype: RoomType,\n\t\tdisplayName?: string,\n\t\tname?: string,\n\t): FederatedRoom {\n\t\tif (type === RoomType.DIRECT_MESSAGE) {\n\t\t\tthrow new Error('For DMs please use the specific class');\n\t\t}\n\t\tconst roomName = displayName || FederatedRoom.generateTemporaryName(normalizedExternalId);\n\t\treturn new FederatedRoom({\n\t\t\texternalId,\n\t\t\tinternalReference: {\n\t\t\t\tt: type,\n\t\t\t\tfname: roomName,\n\t\t\t\tname,\n\t\t\t\tu: creator.getInternalReference(),\n\t\t\t},\n\t\t});\n\t}\n\n\tpublic static createWithInternalReference(externalId: string, internalReference: IRoom): FederatedRoom {\n\t\tif (internalReference.t === RoomType.DIRECT_MESSAGE) {\n\t\t\tthrow new Error('For DMs please use the specific class');\n\t\t}\n\t\treturn new FederatedRoom({\n\t\t\texternalId,\n\t\t\tinternalReference,\n\t\t});\n\t}\n\n\tpublic isDirectMessage(): boolean {\n\t\treturn false;\n\t}\n}\n\nexport class DirectMessageFederatedRoom extends AbstractFederatedRoom {\n\tpublic members: FederatedUser[];\n\n\tprotected constructor({\n\t\texternalId,\n\t\tinternalReference,\n\t\tmembers,\n\t}: {\n\t\texternalId: string;\n\t\tinternalReference: Partial<IRoom>;\n\t\tmembers: FederatedUser[];\n\t}) {\n\t\tsuper({ externalId, internalReference });\n\t\tthis.members = members;\n\t}\n\n\tpublic static createInstance(externalId: string, creator: FederatedUser, members: FederatedUser[]): DirectMessageFederatedRoom {\n\t\treturn new DirectMessageFederatedRoom({\n\t\t\texternalId,\n\t\t\tmembers,\n\t\t\tinternalReference: {\n\t\t\t\tt: RoomType.DIRECT_MESSAGE,\n\t\t\t\tu: creator.getInternalReference(),\n\t\t\t},\n\t\t});\n\t}\n\n\tpublic static createWithInternalReference<T extends IRoom | IDirectMessageRoom>(\n\t\texternalId: string,\n\t\tinternalReference: T,\n\t\tmembers: FederatedUser[],\n\t): DirectMessageFederatedRoom {\n\t\treturn new DirectMessageFederatedRoom({\n\t\t\texternalId,\n\t\t\tinternalReference,\n\t\t\tmembers,\n\t\t});\n\t}\n\n\tpublic getMembersUsernames(): string[] {\n\t\treturn this.members.map((user) => user.getUsername() || '').filter(Boolean);\n\t}\n\n\tpublic getMembers(): FederatedUser[] {\n\t\treturn this.members;\n\t}\n\n\tpublic addMember(member: FederatedUser): void {\n\t\tthis.members.push(member);\n\t}\n\n\tpublic isDirectMessage(): boolean {\n\t\treturn true;\n\t}\n\n\tpublic isUserPartOfTheRoom(federatedUser: FederatedUser): boolean {\n\t\tif (!federatedUser.getUsername()) {\n\t\t\treturn false;\n\t\t}\n\t\tif (!this.internalReference?.usernames) {\n\t\t\treturn false;\n\t\t}\n\t\treturn this.internalReference.usernames.includes(federatedUser.getUsername() as string);\n\t}\n}\n"]},"targets":{"android":"125.0.0","chrome":"125.0.0","edge":"125.0.0","firefox":"115.0.0","ie":"10.0.0","ios":"17.4.0","opera":"110.0.0","opera_mobile":"80.0.0","safari":"17.4.0","samsung":"24.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor","root":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":false,"enforceStrictMode":false,"dynamicImport":true,"generateLetDeclarations":true,"topLevelAwait":true},"externalDependencies":[]},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"version":"7.17.2","helpers":true,"useESModules":false,"corejs":false},"externalDependencies":[]},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-async-generator-functions","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-class-properties","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true},"externalDependencies":[]},{"key":"transform-react-jsx","visitor":{"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXFragment":{"exit":[null]},"JSXElement":{"exit":[null]},"JSXAttribute":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false},"externalDependencies":[]},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-nullish-coalescing-operator","visitor":{"LogicalExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-optional-chaining","visitor":{"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-optional-catch-binding","visitor":{"CatchClause":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-class-properties","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-async-generator-functions","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-logical-assignment-operators","visitor":{"AssignmentExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]}],"presets":[],"generatorOpts":{"filename":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/server/services/federation/domain/FederatedRoom.ts","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"server/services/federation/domain/FederatedRoom.ts","inputSourceMap":{"version":3,"file":"server/services/federation/domain/FederatedRoom.ts","sourceRoot":"","sources":["server/services/federation/domain/FederatedRoom.ts"],"names":[],"mappings":"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","sourcesContent":["import { RoomType } from '@rocket.chat/apps-engine/definition/rooms';\nimport type { IDirectMessageRoom, IMessage, IRoom } from '@rocket.chat/core-typings';\nimport { ObjectId } from 'mongodb'; // This should not be in the domain layer, but its a known \"problem\"\n\nimport type { FederatedUser } from './FederatedUser';\n\nexport const isAnInternalIdentifier = (fromOriginName: string, localOriginName: string): boolean => {\n\treturn fromOriginName === localOriginName;\n};\n\nexport abstract class AbstractFederatedRoom {\n\tprotected externalId: string;\n\n\tprotected internalId: string;\n\n\tprotected internalReference: Partial<IRoom>;\n\n\tprotected constructor({ externalId, internalReference }: { externalId: string; internalReference: Partial<IRoom> }) {\n\t\tthis.externalId = externalId;\n\t\tthis.internalReference = internalReference;\n\t\tthis.internalId = internalReference._id || new ObjectId().toHexString();\n\t}\n\n\tprotected static generateTemporaryName(normalizedExternalId: string): string {\n\t\treturn `Federation-${normalizedExternalId}`;\n\t}\n\n\tpublic abstract isDirectMessage(): boolean;\n\n\tpublic getExternalId(): string {\n\t\treturn this.externalId;\n\t}\n\n\tpublic getRoomType(): RoomType {\n\t\treturn this.internalReference.t as RoomType;\n\t}\n\n\tpublic getInternalId(): string {\n\t\treturn this.internalId;\n\t}\n\n\tpublic getDisplayName(): string | undefined {\n\t\treturn this.internalReference.fname;\n\t}\n\n\tpublic getName(): string | undefined {\n\t\treturn this.internalReference.name;\n\t}\n\n\tpublic getTopic(): string | undefined {\n\t\treturn this.internalReference.topic;\n\t}\n\n\tpublic static isOriginalFromTheProxyServer(fromOriginName: string, proxyServerOriginName: string): boolean {\n\t\treturn isAnInternalIdentifier(fromOriginName, proxyServerOriginName);\n\t}\n\n\tpublic getInternalReference(): Readonly<Partial<IRoom>> {\n\t\treturn Object.freeze({\n\t\t\t...this.internalReference,\n\t\t\t_id: this.internalId,\n\t\t});\n\t}\n\n\tpublic getCreatorUsername(): string | undefined {\n\t\treturn this.internalReference.u?.username;\n\t}\n\n\tpublic isTheCreator(userId: string): boolean {\n\t\treturn this.internalReference.u?._id === userId;\n\t}\n\n\tpublic getCreatorId(): string | undefined {\n\t\treturn this.internalReference.u?._id;\n\t}\n\n\tpublic changeRoomType(type: RoomType): void {\n\t\tif (this.isDirectMessage()) {\n\t\t\tthrow new Error('Its not possible to change a direct message type');\n\t\t}\n\t\tthis.internalReference.t = type;\n\t}\n\n\tpublic changeDisplayRoomName(displayName: string): void {\n\t\tif (this.isDirectMessage()) {\n\t\t\tthrow new Error('Its not possible to change a direct message name');\n\t\t}\n\t\tthis.internalReference.fname = displayName;\n\t}\n\n\tpublic shouldUpdateRoomName(aRoomName: string): boolean {\n\t\treturn this.internalReference?.name !== aRoomName && !this.isDirectMessage();\n\t}\n\n\tpublic changeRoomName(name: string): void {\n\t\tif (this.isDirectMessage()) {\n\t\t\tthrow new Error('Its not possible to change a direct message name');\n\t\t}\n\t\tthis.internalReference.name = name;\n\t}\n\n\tpublic changeRoomTopic(topic: string): void {\n\t\tif (this.isDirectMessage()) {\n\t\t\tthrow new Error('Its not possible to change a direct message topic');\n\t\t}\n\t\tthis.internalReference.topic = topic;\n\t}\n\n\tpublic shouldUpdateDisplayRoomName(aRoomName: string): boolean {\n\t\treturn this.internalReference?.fname !== aRoomName && !this.isDirectMessage();\n\t}\n\n\tpublic shouldUpdateRoomTopic(aRoomTopic: string): boolean {\n\t\treturn this.internalReference?.topic !== aRoomTopic && !this.isDirectMessage();\n\t}\n\n\tpublic static shouldUpdateMessage(newMessageText: string, originalMessage: IMessage): boolean {\n\t\treturn originalMessage.msg !== newMessageText;\n\t}\n}\n\nexport class FederatedRoom extends AbstractFederatedRoom {\n\tprotected constructor({ externalId, internalReference }: { externalId: string; internalReference: Partial<IRoom> }) {\n\t\tsuper({ externalId, internalReference });\n\t}\n\n\tpublic static createInstance(\n\t\texternalId: string,\n\t\tnormalizedExternalId: string,\n\t\tcreator: FederatedUser,\n\t\ttype: RoomType,\n\t\tdisplayName?: string,\n\t\tname?: string,\n\t): FederatedRoom {\n\t\tif (type === RoomType.DIRECT_MESSAGE) {\n\t\t\tthrow new Error('For DMs please use the specific class');\n\t\t}\n\t\tconst roomName = displayName || FederatedRoom.generateTemporaryName(normalizedExternalId);\n\t\treturn new FederatedRoom({\n\t\t\texternalId,\n\t\t\tinternalReference: {\n\t\t\t\tt: type,\n\t\t\t\tfname: roomName,\n\t\t\t\tname,\n\t\t\t\tu: creator.getInternalReference(),\n\t\t\t},\n\t\t});\n\t}\n\n\tpublic static createWithInternalReference(externalId: string, internalReference: IRoom): FederatedRoom {\n\t\tif (internalReference.t === RoomType.DIRECT_MESSAGE) {\n\t\t\tthrow new Error('For DMs please use the specific class');\n\t\t}\n\t\treturn new FederatedRoom({\n\t\t\texternalId,\n\t\t\tinternalReference,\n\t\t});\n\t}\n\n\tpublic isDirectMessage(): boolean {\n\t\treturn false;\n\t}\n}\n\nexport class DirectMessageFederatedRoom extends AbstractFederatedRoom {\n\tpublic members: FederatedUser[];\n\n\tprotected constructor({\n\t\texternalId,\n\t\tinternalReference,\n\t\tmembers,\n\t}: {\n\t\texternalId: string;\n\t\tinternalReference: Partial<IRoom>;\n\t\tmembers: FederatedUser[];\n\t}) {\n\t\tsuper({ externalId, internalReference });\n\t\tthis.members = members;\n\t}\n\n\tpublic static createInstance(externalId: string, creator: FederatedUser, members: FederatedUser[]): DirectMessageFederatedRoom {\n\t\treturn new DirectMessageFederatedRoom({\n\t\t\texternalId,\n\t\t\tmembers,\n\t\t\tinternalReference: {\n\t\t\t\tt: RoomType.DIRECT_MESSAGE,\n\t\t\t\tu: creator.getInternalReference(),\n\t\t\t},\n\t\t});\n\t}\n\n\tpublic static createWithInternalReference<T extends IRoom | IDirectMessageRoom>(\n\t\texternalId: string,\n\t\tinternalReference: T,\n\t\tmembers: FederatedUser[],\n\t): DirectMessageFederatedRoom {\n\t\treturn new DirectMessageFederatedRoom({\n\t\t\texternalId,\n\t\t\tinternalReference,\n\t\t\tmembers,\n\t\t});\n\t}\n\n\tpublic getMembersUsernames(): string[] {\n\t\treturn this.members.map((user) => user.getUsername() || '').filter(Boolean);\n\t}\n\n\tpublic getMembers(): FederatedUser[] {\n\t\treturn this.members;\n\t}\n\n\tpublic addMember(member: FederatedUser): void {\n\t\tthis.members.push(member);\n\t}\n\n\tpublic isDirectMessage(): boolean {\n\t\treturn true;\n\t}\n\n\tpublic isUserPartOfTheRoom(federatedUser: FederatedUser): boolean {\n\t\tif (!federatedUser.getUsername()) {\n\t\t\treturn false;\n\t\t}\n\t\tif (!this.internalReference?.usernames) {\n\t\t\treturn false;\n\t\t}\n\t\treturn this.internalReference.usernames.includes(federatedUser.getUsername() as string);\n\t}\n}\n"]}}},"code":"!module.wrapAsync(async function (module, __reifyWaitForDeps__, __reify_async_result__) {\n  \"use strict\";\n  try {\n    let _objectSpread;\n    module.link(\"@babel/runtime/helpers/objectSpread2\", {\n      default(v) {\n        _objectSpread = v;\n      }\n    }, 0);\n    module.export({\n      isAnInternalIdentifier: () => isAnInternalIdentifier,\n      AbstractFederatedRoom: () => AbstractFederatedRoom,\n      FederatedRoom: () => FederatedRoom,\n      DirectMessageFederatedRoom: () => DirectMessageFederatedRoom\n    });\n    let RoomType;\n    module.link(\"@rocket.chat/apps-engine/definition/rooms\", {\n      RoomType(v) {\n        RoomType = v;\n      }\n    }, 0);\n    let ObjectId;\n    module.link(\"mongodb\", {\n      ObjectId(v) {\n        ObjectId = v;\n      }\n    }, 1);\n    if (__reifyWaitForDeps__()) (await __reifyWaitForDeps__())();\n    const isAnInternalIdentifier = (fromOriginName, localOriginName) => {\n      return fromOriginName === localOriginName;\n    };\n    class AbstractFederatedRoom {\n      constructor(_ref) {\n        let {\n          externalId,\n          internalReference\n        } = _ref;\n        this.externalId = void 0;\n        this.internalId = void 0;\n        this.internalReference = void 0;\n        this.externalId = externalId;\n        this.internalReference = internalReference;\n        this.internalId = internalReference._id || new ObjectId().toHexString();\n      }\n      static generateTemporaryName(normalizedExternalId) {\n        return \"Federation-\".concat(normalizedExternalId);\n      }\n      getExternalId() {\n        return this.externalId;\n      }\n      getRoomType() {\n        return this.internalReference.t;\n      }\n      getInternalId() {\n        return this.internalId;\n      }\n      getDisplayName() {\n        return this.internalReference.fname;\n      }\n      getName() {\n        return this.internalReference.name;\n      }\n      getTopic() {\n        return this.internalReference.topic;\n      }\n      static isOriginalFromTheProxyServer(fromOriginName, proxyServerOriginName) {\n        return isAnInternalIdentifier(fromOriginName, proxyServerOriginName);\n      }\n      getInternalReference() {\n        return Object.freeze(_objectSpread(_objectSpread({}, this.internalReference), {}, {\n          _id: this.internalId\n        }));\n      }\n      getCreatorUsername() {\n        var _this$internalReferen;\n        return (_this$internalReferen = this.internalReference.u) === null || _this$internalReferen === void 0 ? void 0 : _this$internalReferen.username;\n      }\n      isTheCreator(userId) {\n        var _this$internalReferen2;\n        return ((_this$internalReferen2 = this.internalReference.u) === null || _this$internalReferen2 === void 0 ? void 0 : _this$internalReferen2._id) === userId;\n      }\n      getCreatorId() {\n        var _this$internalReferen3;\n        return (_this$internalReferen3 = this.internalReference.u) === null || _this$internalReferen3 === void 0 ? void 0 : _this$internalReferen3._id;\n      }\n      changeRoomType(type) {\n        if (this.isDirectMessage()) {\n          throw new Error('Its not possible to change a direct message type');\n        }\n        this.internalReference.t = type;\n      }\n      changeDisplayRoomName(displayName) {\n        if (this.isDirectMessage()) {\n          throw new Error('Its not possible to change a direct message name');\n        }\n        this.internalReference.fname = displayName;\n      }\n      shouldUpdateRoomName(aRoomName) {\n        var _this$internalReferen4;\n        return ((_this$internalReferen4 = this.internalReference) === null || _this$internalReferen4 === void 0 ? void 0 : _this$internalReferen4.name) !== aRoomName && !this.isDirectMessage();\n      }\n      changeRoomName(name) {\n        if (this.isDirectMessage()) {\n          throw new Error('Its not possible to change a direct message name');\n        }\n        this.internalReference.name = name;\n      }\n      changeRoomTopic(topic) {\n        if (this.isDirectMessage()) {\n          throw new Error('Its not possible to change a direct message topic');\n        }\n        this.internalReference.topic = topic;\n      }\n      shouldUpdateDisplayRoomName(aRoomName) {\n        var _this$internalReferen5;\n        return ((_this$internalReferen5 = this.internalReference) === null || _this$internalReferen5 === void 0 ? void 0 : _this$internalReferen5.fname) !== aRoomName && !this.isDirectMessage();\n      }\n      shouldUpdateRoomTopic(aRoomTopic) {\n        var _this$internalReferen6;\n        return ((_this$internalReferen6 = this.internalReference) === null || _this$internalReferen6 === void 0 ? void 0 : _this$internalReferen6.topic) !== aRoomTopic && !this.isDirectMessage();\n      }\n      static shouldUpdateMessage(newMessageText, originalMessage) {\n        return originalMessage.msg !== newMessageText;\n      }\n    }\n    class FederatedRoom extends AbstractFederatedRoom {\n      constructor(_ref2) {\n        let {\n          externalId,\n          internalReference\n        } = _ref2;\n        super({\n          externalId,\n          internalReference\n        });\n      }\n      static createInstance(externalId, normalizedExternalId, creator, type, displayName, name) {\n        if (type === RoomType.DIRECT_MESSAGE) {\n          throw new Error('For DMs please use the specific class');\n        }\n        const roomName = displayName || FederatedRoom.generateTemporaryName(normalizedExternalId);\n        return new FederatedRoom({\n          externalId,\n          internalReference: {\n            t: type,\n            fname: roomName,\n            name,\n            u: creator.getInternalReference()\n          }\n        });\n      }\n      static createWithInternalReference(externalId, internalReference) {\n        if (internalReference.t === RoomType.DIRECT_MESSAGE) {\n          throw new Error('For DMs please use the specific class');\n        }\n        return new FederatedRoom({\n          externalId,\n          internalReference\n        });\n      }\n      isDirectMessage() {\n        return false;\n      }\n    }\n    class DirectMessageFederatedRoom extends AbstractFederatedRoom {\n      constructor(_ref3) {\n        let {\n          externalId,\n          internalReference,\n          members\n        } = _ref3;\n        super({\n          externalId,\n          internalReference\n        });\n        this.members = void 0;\n        this.members = members;\n      }\n      static createInstance(externalId, creator, members) {\n        return new DirectMessageFederatedRoom({\n          externalId,\n          members,\n          internalReference: {\n            t: RoomType.DIRECT_MESSAGE,\n            u: creator.getInternalReference()\n          }\n        });\n      }\n      static createWithInternalReference(externalId, internalReference, members) {\n        return new DirectMessageFederatedRoom({\n          externalId,\n          internalReference,\n          members\n        });\n      }\n      getMembersUsernames() {\n        return this.members.map(user => user.getUsername() || '').filter(Boolean);\n      }\n      getMembers() {\n        return this.members;\n      }\n      addMember(member) {\n        this.members.push(member);\n      }\n      isDirectMessage() {\n        return true;\n      }\n      isUserPartOfTheRoom(federatedUser) {\n        var _this$internalReferen7;\n        if (!federatedUser.getUsername()) {\n          return false;\n        }\n        if (!((_this$internalReferen7 = this.internalReference) !== null && _this$internalReferen7 !== void 0 && _this$internalReferen7.usernames)) {\n          return false;\n        }\n        return this.internalReference.usernames.includes(federatedUser.getUsername());\n      }\n    }\n    __reify_async_result__();\n  } catch (_reifyError) {\n    return __reify_async_result__(_reifyError);\n  }\n  __reify_async_result__()\n}, {\n  self: this,\n  async: false\n});","map":{"version":3,"names":["_objectSpread","module","link","default","v","export","isAnInternalIdentifier","AbstractFederatedRoom","FederatedRoom","DirectMessageFederatedRoom","RoomType","ObjectId","__reifyWaitForDeps__","fromOriginName","localOriginName","constructor","_ref","externalId","internalReference","internalId","_id","toHexString","generateTemporaryName","normalizedExternalId","concat","getExternalId","getRoomType","t","getInternalId","getDisplayName","fname","getName","name","getTopic","topic","isOriginalFromTheProxyServer","proxyServerOriginName","getInternalReference","Object","freeze","getCreatorUsername","_this$internalReferen","u","username","isTheCreator","userId","_this$internalReferen2","getCreatorId","_this$internalReferen3","changeRoomType","type","isDirectMessage","Error","changeDisplayRoomName","displayName","shouldUpdateRoomName","aRoomName","_this$internalReferen4","changeRoomName","changeRoomTopic","shouldUpdateDisplayRoomName","_this$internalReferen5","shouldUpdateRoomTopic","aRoomTopic","_this$internalReferen6","shouldUpdateMessage","newMessageText","originalMessage","msg","_ref2","createInstance","creator","DIRECT_MESSAGE","roomName","createWithInternalReference","_ref3","members","getMembersUsernames","map","user","getUsername","filter","Boolean","getMembers","addMember","member","push","isUserPartOfTheRoom","federatedUser","_this$internalReferen7","usernames","includes","__reify_async_result__","_reifyError","self","async"],"sources":["server/services/federation/domain/FederatedRoom.ts"],"sourcesContent":["import { RoomType } from '@rocket.chat/apps-engine/definition/rooms';\nimport type { IDirectMessageRoom, IMessage, IRoom } from '@rocket.chat/core-typings';\nimport { ObjectId } from 'mongodb'; // This should not be in the domain layer, but its a known \"problem\"\n\nimport type { FederatedUser } from './FederatedUser';\n\nexport const isAnInternalIdentifier = (fromOriginName: string, localOriginName: string): boolean => {\n\treturn fromOriginName === localOriginName;\n};\n\nexport abstract class AbstractFederatedRoom {\n\tprotected externalId: string;\n\n\tprotected internalId: string;\n\n\tprotected internalReference: Partial<IRoom>;\n\n\tprotected constructor({ externalId, internalReference }: { externalId: string; internalReference: Partial<IRoom> }) {\n\t\tthis.externalId = externalId;\n\t\tthis.internalReference = internalReference;\n\t\tthis.internalId = internalReference._id || new ObjectId().toHexString();\n\t}\n\n\tprotected static generateTemporaryName(normalizedExternalId: string): string {\n\t\treturn `Federation-${normalizedExternalId}`;\n\t}\n\n\tpublic abstract isDirectMessage(): boolean;\n\n\tpublic getExternalId(): string {\n\t\treturn this.externalId;\n\t}\n\n\tpublic getRoomType(): RoomType {\n\t\treturn this.internalReference.t as RoomType;\n\t}\n\n\tpublic getInternalId(): string {\n\t\treturn this.internalId;\n\t}\n\n\tpublic getDisplayName(): string | undefined {\n\t\treturn this.internalReference.fname;\n\t}\n\n\tpublic getName(): string | undefined {\n\t\treturn this.internalReference.name;\n\t}\n\n\tpublic getTopic(): string | undefined {\n\t\treturn this.internalReference.topic;\n\t}\n\n\tpublic static isOriginalFromTheProxyServer(fromOriginName: string, proxyServerOriginName: string): boolean {\n\t\treturn isAnInternalIdentifier(fromOriginName, proxyServerOriginName);\n\t}\n\n\tpublic getInternalReference(): Readonly<Partial<IRoom>> {\n\t\treturn Object.freeze({\n\t\t\t...this.internalReference,\n\t\t\t_id: this.internalId,\n\t\t});\n\t}\n\n\tpublic getCreatorUsername(): string | undefined {\n\t\treturn this.internalReference.u?.username;\n\t}\n\n\tpublic isTheCreator(userId: string): boolean {\n\t\treturn this.internalReference.u?._id === userId;\n\t}\n\n\tpublic getCreatorId(): string | undefined {\n\t\treturn this.internalReference.u?._id;\n\t}\n\n\tpublic changeRoomType(type: RoomType): void {\n\t\tif (this.isDirectMessage()) {\n\t\t\tthrow new Error('Its not possible to change a direct message type');\n\t\t}\n\t\tthis.internalReference.t = type;\n\t}\n\n\tpublic changeDisplayRoomName(displayName: string): void {\n\t\tif (this.isDirectMessage()) {\n\t\t\tthrow new Error('Its not possible to change a direct message name');\n\t\t}\n\t\tthis.internalReference.fname = displayName;\n\t}\n\n\tpublic shouldUpdateRoomName(aRoomName: string): boolean {\n\t\treturn this.internalReference?.name !== aRoomName && !this.isDirectMessage();\n\t}\n\n\tpublic changeRoomName(name: string): void {\n\t\tif (this.isDirectMessage()) {\n\t\t\tthrow new Error('Its not possible to change a direct message name');\n\t\t}\n\t\tthis.internalReference.name = name;\n\t}\n\n\tpublic changeRoomTopic(topic: string): void {\n\t\tif (this.isDirectMessage()) {\n\t\t\tthrow new Error('Its not possible to change a direct message topic');\n\t\t}\n\t\tthis.internalReference.topic = topic;\n\t}\n\n\tpublic shouldUpdateDisplayRoomName(aRoomName: string): boolean {\n\t\treturn this.internalReference?.fname !== aRoomName && !this.isDirectMessage();\n\t}\n\n\tpublic shouldUpdateRoomTopic(aRoomTopic: string): boolean {\n\t\treturn this.internalReference?.topic !== aRoomTopic && !this.isDirectMessage();\n\t}\n\n\tpublic static shouldUpdateMessage(newMessageText: string, originalMessage: IMessage): boolean {\n\t\treturn originalMessage.msg !== newMessageText;\n\t}\n}\n\nexport class FederatedRoom extends AbstractFederatedRoom {\n\tprotected constructor({ externalId, internalReference }: { externalId: string; internalReference: Partial<IRoom> }) {\n\t\tsuper({ externalId, internalReference });\n\t}\n\n\tpublic static createInstance(\n\t\texternalId: string,\n\t\tnormalizedExternalId: string,\n\t\tcreator: FederatedUser,\n\t\ttype: RoomType,\n\t\tdisplayName?: string,\n\t\tname?: string,\n\t): FederatedRoom {\n\t\tif (type === RoomType.DIRECT_MESSAGE) {\n\t\t\tthrow new Error('For DMs please use the specific class');\n\t\t}\n\t\tconst roomName = displayName || FederatedRoom.generateTemporaryName(normalizedExternalId);\n\t\treturn new FederatedRoom({\n\t\t\texternalId,\n\t\t\tinternalReference: {\n\t\t\t\tt: type,\n\t\t\t\tfname: roomName,\n\t\t\t\tname,\n\t\t\t\tu: creator.getInternalReference(),\n\t\t\t},\n\t\t});\n\t}\n\n\tpublic static createWithInternalReference(externalId: string, internalReference: IRoom): FederatedRoom {\n\t\tif (internalReference.t === RoomType.DIRECT_MESSAGE) {\n\t\t\tthrow new Error('For DMs please use the specific class');\n\t\t}\n\t\treturn new FederatedRoom({\n\t\t\texternalId,\n\t\t\tinternalReference,\n\t\t});\n\t}\n\n\tpublic isDirectMessage(): boolean {\n\t\treturn false;\n\t}\n}\n\nexport class DirectMessageFederatedRoom extends AbstractFederatedRoom {\n\tpublic members: FederatedUser[];\n\n\tprotected constructor({\n\t\texternalId,\n\t\tinternalReference,\n\t\tmembers,\n\t}: {\n\t\texternalId: string;\n\t\tinternalReference: Partial<IRoom>;\n\t\tmembers: FederatedUser[];\n\t}) {\n\t\tsuper({ externalId, internalReference });\n\t\tthis.members = members;\n\t}\n\n\tpublic static createInstance(externalId: string, creator: FederatedUser, members: FederatedUser[]): DirectMessageFederatedRoom {\n\t\treturn new DirectMessageFederatedRoom({\n\t\t\texternalId,\n\t\t\tmembers,\n\t\t\tinternalReference: {\n\t\t\t\tt: RoomType.DIRECT_MESSAGE,\n\t\t\t\tu: creator.getInternalReference(),\n\t\t\t},\n\t\t});\n\t}\n\n\tpublic static createWithInternalReference<T extends IRoom | IDirectMessageRoom>(\n\t\texternalId: string,\n\t\tinternalReference: T,\n\t\tmembers: FederatedUser[],\n\t): DirectMessageFederatedRoom {\n\t\treturn new DirectMessageFederatedRoom({\n\t\t\texternalId,\n\t\t\tinternalReference,\n\t\t\tmembers,\n\t\t});\n\t}\n\n\tpublic getMembersUsernames(): string[] {\n\t\treturn this.members.map((user) => user.getUsername() || '').filter(Boolean);\n\t}\n\n\tpublic getMembers(): FederatedUser[] {\n\t\treturn this.members;\n\t}\n\n\tpublic addMember(member: FederatedUser): void {\n\t\tthis.members.push(member);\n\t}\n\n\tpublic isDirectMessage(): boolean {\n\t\treturn true;\n\t}\n\n\tpublic isUserPartOfTheRoom(federatedUser: FederatedUser): boolean {\n\t\tif (!federatedUser.getUsername()) {\n\t\t\treturn false;\n\t\t}\n\t\tif (!this.internalReference?.usernames) {\n\t\t\treturn false;\n\t\t}\n\t\treturn this.internalReference.usernames.includes(federatedUser.getUsername() as string);\n\t}\n}\n"],"mappings":"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","ignoreList":[]},"sourceType":"module","externalDependencies":{},"hash":"b03aac9063319b0ef2d463ef4b677f85e917b6e8"}
