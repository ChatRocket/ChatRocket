{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/client/lib/chats/uploads.ts","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","topLevelAwait","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"web.browser"},"sourceFileName":"client/lib/chats/uploads.ts","filename":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/client/lib/chats/uploads.ts","inputSourceMap":{"version":3,"file":"client/lib/chats/uploads.ts","sourceRoot":"","sources":["client/lib/chats/uploads.ts"],"names":[],"mappings":"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","sourcesContent":["import type { IMessage, IRoom, IE2EEMessage, IUpload } from '@rocket.chat/core-typings';\nimport { Emitter } from '@rocket.chat/emitter';\nimport { Random } from '@rocket.chat/random';\n\nimport { UserAction, USER_ACTIVITIES } from '../../../app/ui/client/lib/UserAction';\nimport { sdk } from '../../../app/utils/client/lib/SDKClient';\nimport { getErrorMessage } from '../errorHandling';\nimport type { UploadsAPI } from './ChatAPI';\nimport type { Upload } from './Upload';\n\nlet uploads: readonly Upload[] = [];\n\nconst emitter = new Emitter<{ update: void; [x: `cancelling-${Upload['id']}`]: void }>();\n\nconst updateUploads = (update: (uploads: readonly Upload[]) => readonly Upload[]): void => {\n\tuploads = update(uploads);\n\temitter.emit('update');\n};\n\nconst get = (): readonly Upload[] => uploads;\n\nconst subscribe = (callback: () => void): (() => void) => emitter.on('update', callback);\n\nconst cancel = (id: Upload['id']): void => {\n\temitter.emit(`cancelling-${id}`);\n};\n\nconst wipeFailedOnes = (): void => {\n\tupdateUploads((uploads) => uploads.filter((upload) => !upload.error));\n};\n\nconst send = async (\n\tfile: File,\n\t{\n\t\tdescription,\n\t\tmsg,\n\t\trid,\n\t\ttmid,\n\t\tt,\n\t}: {\n\t\tdescription?: string;\n\t\tmsg?: string;\n\t\trid: string;\n\t\ttmid?: string;\n\t\tt?: IMessage['t'];\n\t},\n\tgetContent?: (fileId: string, fileUrl: string) => Promise<IE2EEMessage['content']>,\n\tfileContent?: { raw: Partial<IUpload>; encrypted: IE2EEMessage['content'] },\n): Promise<void> => {\n\tconst id = Random.id();\n\n\tupdateUploads((uploads) => [\n\t\t...uploads,\n\t\t{\n\t\t\tid,\n\t\t\tname: fileContent?.raw.name || file.name,\n\t\t\tpercentage: 0,\n\t\t},\n\t]);\n\n\ttry {\n\t\tawait new Promise((resolve, reject) => {\n\t\t\tconst xhr = sdk.rest.upload(\n\t\t\t\t`/v1/rooms.media/${rid}`,\n\t\t\t\t{\n\t\t\t\t\tfile,\n\t\t\t\t\t...(fileContent && {\n\t\t\t\t\t\tcontent: JSON.stringify(fileContent.encrypted),\n\t\t\t\t\t}),\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\tload: (event) => {\n\t\t\t\t\t\tresolve(event);\n\t\t\t\t\t},\n\t\t\t\t\tprogress: (event) => {\n\t\t\t\t\t\tif (!event.lengthComputable) {\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\t\t\t\t\t\tconst progress = (event.loaded / event.total) * 100;\n\t\t\t\t\t\tif (progress === 100) {\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tupdateUploads((uploads) =>\n\t\t\t\t\t\t\tuploads.map((upload) => {\n\t\t\t\t\t\t\t\tif (upload.id !== id) {\n\t\t\t\t\t\t\t\t\treturn upload;\n\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\treturn {\n\t\t\t\t\t\t\t\t\t...upload,\n\t\t\t\t\t\t\t\t\tpercentage: Math.round(progress) || 0,\n\t\t\t\t\t\t\t\t};\n\t\t\t\t\t\t\t}),\n\t\t\t\t\t\t);\n\t\t\t\t\t},\n\t\t\t\t\terror: (event) => {\n\t\t\t\t\t\tupdateUploads((uploads) =>\n\t\t\t\t\t\t\tuploads.map((upload) => {\n\t\t\t\t\t\t\t\tif (upload.id !== id) {\n\t\t\t\t\t\t\t\t\treturn upload;\n\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\treturn {\n\t\t\t\t\t\t\t\t\t...upload,\n\t\t\t\t\t\t\t\t\tpercentage: 0,\n\t\t\t\t\t\t\t\t\terror: new Error(xhr.responseText),\n\t\t\t\t\t\t\t\t};\n\t\t\t\t\t\t\t}),\n\t\t\t\t\t\t);\n\t\t\t\t\t\treject(event);\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t);\n\n\t\t\txhr.onload = async () => {\n\t\t\t\tif (xhr.readyState === xhr.DONE && xhr.status === 200) {\n\t\t\t\t\tconst result = JSON.parse(xhr.responseText);\n\t\t\t\t\tlet content;\n\t\t\t\t\tif (getContent) {\n\t\t\t\t\t\tcontent = await getContent(result.file._id, result.file.url);\n\t\t\t\t\t}\n\n\t\t\t\t\tawait sdk.rest.post(`/v1/rooms.mediaConfirm/${rid}/${result.file._id}`, {\n\t\t\t\t\t\tmsg,\n\t\t\t\t\t\ttmid,\n\t\t\t\t\t\tdescription,\n\t\t\t\t\t\tt,\n\t\t\t\t\t\tcontent,\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t};\n\n\t\t\tif (uploads.length) {\n\t\t\t\tUserAction.performContinuously(rid, USER_ACTIVITIES.USER_UPLOADING, { tmid });\n\t\t\t}\n\n\t\t\temitter.once(`cancelling-${id}`, () => {\n\t\t\t\txhr.abort();\n\t\t\t\tupdateUploads((uploads) => uploads.filter((upload) => upload.id !== id));\n\t\t\t});\n\t\t});\n\n\t\tupdateUploads((uploads) => uploads.filter((upload) => upload.id !== id));\n\t} catch (error: unknown) {\n\t\tupdateUploads((uploads) =>\n\t\t\tuploads.map((upload) => {\n\t\t\t\tif (upload.id !== id) {\n\t\t\t\t\treturn upload;\n\t\t\t\t}\n\n\t\t\t\treturn {\n\t\t\t\t\t...upload,\n\t\t\t\t\tpercentage: 0,\n\t\t\t\t\terror: new Error(getErrorMessage(error)),\n\t\t\t\t};\n\t\t\t}),\n\t\t);\n\t} finally {\n\t\tif (!uploads.length) {\n\t\t\tUserAction.stop(rid, USER_ACTIVITIES.USER_UPLOADING, { tmid });\n\t\t}\n\t}\n};\n\nexport const createUploadsAPI = ({ rid, tmid }: { rid: IRoom['_id']; tmid?: IMessage['_id'] }): UploadsAPI => ({\n\tget,\n\tsubscribe,\n\twipeFailedOnes,\n\tcancel,\n\tsend: (\n\t\tfile: File,\n\t\t{ description, msg, t }: { description?: string; msg?: string; t?: IMessage['t'] },\n\t\tgetContent?: (fileId: string, fileUrl: string) => Promise<IE2EEMessage['content']>,\n\t\tfileContent?: { raw: Partial<IUpload>; encrypted: IE2EEMessage['content'] },\n\t): Promise<void> => send(file, { description, msg, rid, tmid, t }, getContent, fileContent),\n});\n"]},"targets":{"android":"125.0.0","chrome":"125.0.0","edge":"125.0.0","firefox":"115.0.0","ie":"10.0.0","ios":"17.4.0","opera":"110.0.0","opera_mobile":"80.0.0","safari":"17.4.0","samsung":"24.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor","root":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":false,"enforceStrictMode":false,"dynamicImport":true,"generateLetDeclarations":true},"externalDependencies":[]},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"version":"7.17.2","helpers":true,"useESModules":false,"corejs":false},"externalDependencies":[]},{"key":"proposal-class-properties","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true},"externalDependencies":[]},{"key":"transform-react-jsx","visitor":{"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXFragment":{"exit":[null]},"JSXElement":{"exit":[null]},"JSXAttribute":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false},"externalDependencies":[]},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-nullish-coalescing-operator","visitor":{"LogicalExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-optional-chaining","visitor":{"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-optional-catch-binding","visitor":{"CatchClause":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-class-properties","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-async-generator-functions","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-logical-assignment-operators","visitor":{"AssignmentExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]}],"presets":[],"generatorOpts":{"filename":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/client/lib/chats/uploads.ts","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"client/lib/chats/uploads.ts","inputSourceMap":{"version":3,"file":"client/lib/chats/uploads.ts","sourceRoot":"","sources":["client/lib/chats/uploads.ts"],"names":[],"mappings":"AACA,OAAO,EAAE,OAAO,EAAE,MAAM,sBAAsB,CAAC;AAC/C,OAAO,EAAE,MAAM,EAAE,MAAM,qBAAqB,CAAC;AAE7C,OAAO,EAAE,UAAU,EAAE,eAAe,EAAE,MAAM,uCAAuC,CAAC;AACpF,OAAO,EAAE,GAAG,EAAE,MAAM,yCAAyC,CAAC;AAC9D,OAAO,EAAE,eAAe,EAAE,MAAM,kBAAkB,CAAC;AAInD,IAAI,OAAO,GAAsB,EAAE,CAAC;AAEpC,MAAM,OAAO,GAAG,IAAI,OAAO,EAA6D,CAAC;AAEzF,MAAM,aAAa,GAAG,CAAC,MAAyD,EAAQ,EAAE;IACzF,OAAO,GAAG,MAAM,CAAC,OAAO,CAAC,CAAC;IAC1B,OAAO,CAAC,IAAI,CAAC,QAAQ,CAAC,CAAC;AACxB,CAAC,CAAC;AAEF,MAAM,GAAG,GAAG,GAAsB,EAAE,CAAC,OAAO,CAAC;AAE7C,MAAM,SAAS,GAAG,CAAC,QAAoB,EAAgB,EAAE,CAAC,OAAO,CAAC,EAAE,CAAC,QAAQ,EAAE,QAAQ,CAAC,CAAC;AAEzF,MAAM,MAAM,GAAG,CAAC,EAAgB,EAAQ,EAAE;IACzC,OAAO,CAAC,IAAI,CAAC,cAAc,EAAE,EAAE,CAAC,CAAC;AAClC,CAAC,CAAC;AAEF,MAAM,cAAc,GAAG,GAAS,EAAE;IACjC,aAAa,CAAC,CAAC,OAAO,EAAE,EAAE,CAAC,OAAO,CAAC,MAAM,CAAC,CAAC,MAAM,EAAE,EAAE,CAAC,CAAC,MAAM,CAAC,KAAK,CAAC,CAAC,CAAC;AACvE,CAAC,CAAC;AAEF,MAAM,IAAI,GAAG,KAAK,EACjB,IAAU,EACV,EACC,WAAW,EACX,GAAG,EACH,GAAG,EACH,IAAI,EACJ,CAAC,GAOD,EACD,UAAkF,EAClF,WAA2E,EAC3D,EAAE;IAClB,MAAM,EAAE,GAAG,MAAM,CAAC,EAAE,EAAE,CAAC;IAEvB,aAAa,CAAC,CAAC,OAAO,EAAE,EAAE,CAAC;QAC1B,GAAG,OAAO;QACV;YACC,EAAE;YACF,IAAI,EAAE,WAAW,EAAE,GAAG,CAAC,IAAI,IAAI,IAAI,CAAC,IAAI;YACxC,UAAU,EAAE,CAAC;SACb;KACD,CAAC,CAAC;IAEH,IAAI,CAAC;QACJ,MAAM,IAAI,OAAO,CAAC,CAAC,OAAO,EAAE,MAAM,EAAE,EAAE;YACrC,MAAM,GAAG,GAAG,GAAG,CAAC,IAAI,CAAC,MAAM,CAC1B,mBAAmB,GAAG,EAAE,EACxB;gBACC,IAAI;gBACJ,GAAG,CAAC,WAAW,IAAI;oBAClB,OAAO,EAAE,IAAI,CAAC,SAAS,CAAC,WAAW,CAAC,SAAS,CAAC;iBAC9C,CAAC;aACF,EACD;gBACC,IAAI,EAAE,CAAC,KAAK,EAAE,EAAE;oBACf,OAAO,CAAC,KAAK,CAAC,CAAC;gBAChB,CAAC;gBACD,QAAQ,EAAE,CAAC,KAAK,EAAE,EAAE;oBACnB,IAAI,CAAC,KAAK,CAAC,gBAAgB,EAAE,CAAC;wBAC7B,OAAO;oBACR,CAAC;oBACD,MAAM,QAAQ,GAAG,CAAC,KAAK,CAAC,MAAM,GAAG,KAAK,CAAC,KAAK,CAAC,GAAG,GAAG,CAAC;oBACpD,IAAI,QAAQ,KAAK,GAAG,EAAE,CAAC;wBACtB,OAAO;oBACR,CAAC;oBAED,aAAa,CAAC,CAAC,OAAO,EAAE,EAAE,CACzB,OAAO,CAAC,GAAG,CAAC,CAAC,MAAM,EAAE,EAAE;wBACtB,IAAI,MAAM,CAAC,EAAE,KAAK,EAAE,EAAE,CAAC;4BACtB,OAAO,MAAM,CAAC;wBACf,CAAC;wBAED,OAAO;4BACN,GAAG,MAAM;4BACT,UAAU,EAAE,IAAI,CAAC,KAAK,CAAC,QAAQ,CAAC,IAAI,CAAC;yBACrC,CAAC;oBACH,CAAC,CAAC,CACF,CAAC;gBACH,CAAC;gBACD,KAAK,EAAE,CAAC,KAAK,EAAE,EAAE;oBAChB,aAAa,CAAC,CAAC,OAAO,EAAE,EAAE,CACzB,OAAO,CAAC,GAAG,CAAC,CAAC,MAAM,EAAE,EAAE;wBACtB,IAAI,MAAM,CAAC,EAAE,KAAK,EAAE,EAAE,CAAC;4BACtB,OAAO,MAAM,CAAC;wBACf,CAAC;wBAED,OAAO;4BACN,GAAG,MAAM;4BACT,UAAU,EAAE,CAAC;4BACb,KAAK,EAAE,IAAI,KAAK,CAAC,GAAG,CAAC,YAAY,CAAC;yBAClC,CAAC;oBACH,CAAC,CAAC,CACF,CAAC;oBACF,MAAM,CAAC,KAAK,CAAC,CAAC;gBACf,CAAC;aACD,CACD,CAAC;YAEF,GAAG,CAAC,MAAM,GAAG,KAAK,IAAI,EAAE;gBACvB,IAAI,GAAG,CAAC,UAAU,KAAK,GAAG,CAAC,IAAI,IAAI,GAAG,CAAC,MAAM,KAAK,GAAG,EAAE,CAAC;oBACvD,MAAM,MAAM,GAAG,IAAI,CAAC,KAAK,CAAC,GAAG,CAAC,YAAY,CAAC,CAAC;oBAC5C,IAAI,OAAO,CAAC;oBACZ,IAAI,UAAU,EAAE,CAAC;wBAChB,OAAO,GAAG,MAAM,UAAU,CAAC,MAAM,CAAC,IAAI,CAAC,GAAG,EAAE,MAAM,CAAC,IAAI,CAAC,GAAG,CAAC,CAAC;oBAC9D,CAAC;oBAED,MAAM,GAAG,CAAC,IAAI,CAAC,IAAI,CAAC,0BAA0B,GAAG,IAAI,MAAM,CAAC,IAAI,CAAC,GAAG,EAAE,EAAE;wBACvE,GAAG;wBACH,IAAI;wBACJ,WAAW;wBACX,CAAC;wBACD,OAAO;qBACP,CAAC,CAAC;gBACJ,CAAC;YACF,CAAC,CAAC;YAEF,IAAI,OAAO,CAAC,MAAM,EAAE,CAAC;gBACpB,UAAU,CAAC,mBAAmB,CAAC,GAAG,EAAE,eAAe,CAAC,cAAc,EAAE,EAAE,IAAI,EAAE,CAAC,CAAC;YAC/E,CAAC;YAED,OAAO,CAAC,IAAI,CAAC,cAAc,EAAE,EAAE,EAAE,GAAG,EAAE;gBACrC,GAAG,CAAC,KAAK,EAAE,CAAC;gBACZ,aAAa,CAAC,CAAC,OAAO,EAAE,EAAE,CAAC,OAAO,CAAC,MAAM,CAAC,CAAC,MAAM,EAAE,EAAE,CAAC,MAAM,CAAC,EAAE,KAAK,EAAE,CAAC,CAAC,CAAC;YAC1E,CAAC,CAAC,CAAC;QACJ,CAAC,CAAC,CAAC;QAEH,aAAa,CAAC,CAAC,OAAO,EAAE,EAAE,CAAC,OAAO,CAAC,MAAM,CAAC,CAAC,MAAM,EAAE,EAAE,CAAC,MAAM,CAAC,EAAE,KAAK,EAAE,CAAC,CAAC,CAAC;IAC1E,CAAC;IAAC,OAAO,KAAc,EAAE,CAAC;QACzB,aAAa,CAAC,CAAC,OAAO,EAAE,EAAE,CACzB,OAAO,CAAC,GAAG,CAAC,CAAC,MAAM,EAAE,EAAE;YACtB,IAAI,MAAM,CAAC,EAAE,KAAK,EAAE,EAAE,CAAC;gBACtB,OAAO,MAAM,CAAC;YACf,CAAC;YAED,OAAO;gBACN,GAAG,MAAM;gBACT,UAAU,EAAE,CAAC;gBACb,KAAK,EAAE,IAAI,KAAK,CAAC,eAAe,CAAC,KAAK,CAAC,CAAC;aACxC,CAAC;QACH,CAAC,CAAC,CACF,CAAC;IACH,CAAC;YAAS,CAAC;QACV,IAAI,CAAC,OAAO,CAAC,MAAM,EAAE,CAAC;YACrB,UAAU,CAAC,IAAI,CAAC,GAAG,EAAE,eAAe,CAAC,cAAc,EAAE,EAAE,IAAI,EAAE,CAAC,CAAC;QAChE,CAAC;IACF,CAAC;AACF,CAAC,CAAC;AAEF,MAAM,CAAC,MAAM,gBAAgB,GAAG,CAAC,EAAE,GAAG,EAAE,IAAI,EAAiD,EAAc,EAAE,CAAC,CAAC;IAC9G,GAAG;IACH,SAAS;IACT,cAAc;IACd,MAAM;IACN,IAAI,EAAE,CACL,IAAU,EACV,EAAE,WAAW,EAAE,GAAG,EAAE,CAAC,EAA6D,EAClF,UAAkF,EAClF,WAA2E,EAC3D,EAAE,CAAC,IAAI,CAAC,IAAI,EAAE,EAAE,WAAW,EAAE,GAAG,EAAE,GAAG,EAAE,IAAI,EAAE,CAAC,EAAE,EAAE,UAAU,EAAE,WAAW,CAAC;CAC3F,CAAC,CAAC","sourcesContent":["import type { IMessage, IRoom, IE2EEMessage, IUpload } from '@rocket.chat/core-typings';\nimport { Emitter } from '@rocket.chat/emitter';\nimport { Random } from '@rocket.chat/random';\n\nimport { UserAction, USER_ACTIVITIES } from '../../../app/ui/client/lib/UserAction';\nimport { sdk } from '../../../app/utils/client/lib/SDKClient';\nimport { getErrorMessage } from '../errorHandling';\nimport type { UploadsAPI } from './ChatAPI';\nimport type { Upload } from './Upload';\n\nlet uploads: readonly Upload[] = [];\n\nconst emitter = new Emitter<{ update: void; [x: `cancelling-${Upload['id']}`]: void }>();\n\nconst updateUploads = (update: (uploads: readonly Upload[]) => readonly Upload[]): void => {\n\tuploads = update(uploads);\n\temitter.emit('update');\n};\n\nconst get = (): readonly Upload[] => uploads;\n\nconst subscribe = (callback: () => void): (() => void) => emitter.on('update', callback);\n\nconst cancel = (id: Upload['id']): void => {\n\temitter.emit(`cancelling-${id}`);\n};\n\nconst wipeFailedOnes = (): void => {\n\tupdateUploads((uploads) => uploads.filter((upload) => !upload.error));\n};\n\nconst send = async (\n\tfile: File,\n\t{\n\t\tdescription,\n\t\tmsg,\n\t\trid,\n\t\ttmid,\n\t\tt,\n\t}: {\n\t\tdescription?: string;\n\t\tmsg?: string;\n\t\trid: string;\n\t\ttmid?: string;\n\t\tt?: IMessage['t'];\n\t},\n\tgetContent?: (fileId: string, fileUrl: string) => Promise<IE2EEMessage['content']>,\n\tfileContent?: { raw: Partial<IUpload>; encrypted: IE2EEMessage['content'] },\n): Promise<void> => {\n\tconst id = Random.id();\n\n\tupdateUploads((uploads) => [\n\t\t...uploads,\n\t\t{\n\t\t\tid,\n\t\t\tname: fileContent?.raw.name || file.name,\n\t\t\tpercentage: 0,\n\t\t},\n\t]);\n\n\ttry {\n\t\tawait new Promise((resolve, reject) => {\n\t\t\tconst xhr = sdk.rest.upload(\n\t\t\t\t`/v1/rooms.media/${rid}`,\n\t\t\t\t{\n\t\t\t\t\tfile,\n\t\t\t\t\t...(fileContent && {\n\t\t\t\t\t\tcontent: JSON.stringify(fileContent.encrypted),\n\t\t\t\t\t}),\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\tload: (event) => {\n\t\t\t\t\t\tresolve(event);\n\t\t\t\t\t},\n\t\t\t\t\tprogress: (event) => {\n\t\t\t\t\t\tif (!event.lengthComputable) {\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\t\t\t\t\t\tconst progress = (event.loaded / event.total) * 100;\n\t\t\t\t\t\tif (progress === 100) {\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tupdateUploads((uploads) =>\n\t\t\t\t\t\t\tuploads.map((upload) => {\n\t\t\t\t\t\t\t\tif (upload.id !== id) {\n\t\t\t\t\t\t\t\t\treturn upload;\n\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\treturn {\n\t\t\t\t\t\t\t\t\t...upload,\n\t\t\t\t\t\t\t\t\tpercentage: Math.round(progress) || 0,\n\t\t\t\t\t\t\t\t};\n\t\t\t\t\t\t\t}),\n\t\t\t\t\t\t);\n\t\t\t\t\t},\n\t\t\t\t\terror: (event) => {\n\t\t\t\t\t\tupdateUploads((uploads) =>\n\t\t\t\t\t\t\tuploads.map((upload) => {\n\t\t\t\t\t\t\t\tif (upload.id !== id) {\n\t\t\t\t\t\t\t\t\treturn upload;\n\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\treturn {\n\t\t\t\t\t\t\t\t\t...upload,\n\t\t\t\t\t\t\t\t\tpercentage: 0,\n\t\t\t\t\t\t\t\t\terror: new Error(xhr.responseText),\n\t\t\t\t\t\t\t\t};\n\t\t\t\t\t\t\t}),\n\t\t\t\t\t\t);\n\t\t\t\t\t\treject(event);\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t);\n\n\t\t\txhr.onload = async () => {\n\t\t\t\tif (xhr.readyState === xhr.DONE && xhr.status === 200) {\n\t\t\t\t\tconst result = JSON.parse(xhr.responseText);\n\t\t\t\t\tlet content;\n\t\t\t\t\tif (getContent) {\n\t\t\t\t\t\tcontent = await getContent(result.file._id, result.file.url);\n\t\t\t\t\t}\n\n\t\t\t\t\tawait sdk.rest.post(`/v1/rooms.mediaConfirm/${rid}/${result.file._id}`, {\n\t\t\t\t\t\tmsg,\n\t\t\t\t\t\ttmid,\n\t\t\t\t\t\tdescription,\n\t\t\t\t\t\tt,\n\t\t\t\t\t\tcontent,\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t};\n\n\t\t\tif (uploads.length) {\n\t\t\t\tUserAction.performContinuously(rid, USER_ACTIVITIES.USER_UPLOADING, { tmid });\n\t\t\t}\n\n\t\t\temitter.once(`cancelling-${id}`, () => {\n\t\t\t\txhr.abort();\n\t\t\t\tupdateUploads((uploads) => uploads.filter((upload) => upload.id !== id));\n\t\t\t});\n\t\t});\n\n\t\tupdateUploads((uploads) => uploads.filter((upload) => upload.id !== id));\n\t} catch (error: unknown) {\n\t\tupdateUploads((uploads) =>\n\t\t\tuploads.map((upload) => {\n\t\t\t\tif (upload.id !== id) {\n\t\t\t\t\treturn upload;\n\t\t\t\t}\n\n\t\t\t\treturn {\n\t\t\t\t\t...upload,\n\t\t\t\t\tpercentage: 0,\n\t\t\t\t\terror: new Error(getErrorMessage(error)),\n\t\t\t\t};\n\t\t\t}),\n\t\t);\n\t} finally {\n\t\tif (!uploads.length) {\n\t\t\tUserAction.stop(rid, USER_ACTIVITIES.USER_UPLOADING, { tmid });\n\t\t}\n\t}\n};\n\nexport const createUploadsAPI = ({ rid, tmid }: { rid: IRoom['_id']; tmid?: IMessage['_id'] }): UploadsAPI => ({\n\tget,\n\tsubscribe,\n\twipeFailedOnes,\n\tcancel,\n\tsend: (\n\t\tfile: File,\n\t\t{ description, msg, t }: { description?: string; msg?: string; t?: IMessage['t'] },\n\t\tgetContent?: (fileId: string, fileUrl: string) => Promise<IE2EEMessage['content']>,\n\t\tfileContent?: { raw: Partial<IUpload>; encrypted: IE2EEMessage['content'] },\n\t): Promise<void> => send(file, { description, msg, rid, tmid, t }, getContent, fileContent),\n});\n"]}}},"code":"let _objectSpread;\nmodule.link(\"@babel/runtime/helpers/objectSpread2\", {\n  default(v) {\n    _objectSpread = v;\n  }\n}, 0);\nmodule.export({\n  createUploadsAPI: () => createUploadsAPI\n});\nlet Emitter;\nmodule.link(\"@rocket.chat/emitter\", {\n  Emitter(v) {\n    Emitter = v;\n  }\n}, 0);\nlet Random;\nmodule.link(\"@rocket.chat/random\", {\n  Random(v) {\n    Random = v;\n  }\n}, 1);\nlet UserAction, USER_ACTIVITIES;\nmodule.link(\"../../../app/ui/client/lib/UserAction\", {\n  UserAction(v) {\n    UserAction = v;\n  },\n  USER_ACTIVITIES(v) {\n    USER_ACTIVITIES = v;\n  }\n}, 2);\nlet sdk;\nmodule.link(\"../../../app/utils/client/lib/SDKClient\", {\n  sdk(v) {\n    sdk = v;\n  }\n}, 3);\nlet getErrorMessage;\nmodule.link(\"../errorHandling\", {\n  getErrorMessage(v) {\n    getErrorMessage = v;\n  }\n}, 4);\nlet uploads = [];\nconst emitter = new Emitter();\nconst updateUploads = update => {\n  uploads = update(uploads);\n  emitter.emit('update');\n};\nconst get = () => uploads;\nconst subscribe = callback => emitter.on('update', callback);\nconst cancel = id => {\n  emitter.emit(\"cancelling-\".concat(id));\n};\nconst wipeFailedOnes = () => {\n  updateUploads(uploads => uploads.filter(upload => !upload.error));\n};\nconst send = async (file, _ref, getContent, fileContent) => {\n  let {\n    description,\n    msg,\n    rid,\n    tmid,\n    t\n  } = _ref;\n  const id = Random.id();\n  updateUploads(uploads => [...uploads, {\n    id,\n    name: (fileContent === null || fileContent === void 0 ? void 0 : fileContent.raw.name) || file.name,\n    percentage: 0\n  }]);\n  try {\n    await new Promise((resolve, reject) => {\n      const xhr = sdk.rest.upload(\"/v1/rooms.media/\".concat(rid), _objectSpread({\n        file\n      }, fileContent && {\n        content: JSON.stringify(fileContent.encrypted)\n      }), {\n        load: event => {\n          resolve(event);\n        },\n        progress: event => {\n          if (!event.lengthComputable) {\n            return;\n          }\n          const progress = event.loaded / event.total * 100;\n          if (progress === 100) {\n            return;\n          }\n          updateUploads(uploads => uploads.map(upload => {\n            if (upload.id !== id) {\n              return upload;\n            }\n            return _objectSpread(_objectSpread({}, upload), {}, {\n              percentage: Math.round(progress) || 0\n            });\n          }));\n        },\n        error: event => {\n          updateUploads(uploads => uploads.map(upload => {\n            if (upload.id !== id) {\n              return upload;\n            }\n            return _objectSpread(_objectSpread({}, upload), {}, {\n              percentage: 0,\n              error: new Error(xhr.responseText)\n            });\n          }));\n          reject(event);\n        }\n      });\n      xhr.onload = async () => {\n        if (xhr.readyState === xhr.DONE && xhr.status === 200) {\n          const result = JSON.parse(xhr.responseText);\n          let content;\n          if (getContent) {\n            content = await getContent(result.file._id, result.file.url);\n          }\n          await sdk.rest.post(\"/v1/rooms.mediaConfirm/\".concat(rid, \"/\").concat(result.file._id), {\n            msg,\n            tmid,\n            description,\n            t,\n            content\n          });\n        }\n      };\n      if (uploads.length) {\n        UserAction.performContinuously(rid, USER_ACTIVITIES.USER_UPLOADING, {\n          tmid\n        });\n      }\n      emitter.once(\"cancelling-\".concat(id), () => {\n        xhr.abort();\n        updateUploads(uploads => uploads.filter(upload => upload.id !== id));\n      });\n    });\n    updateUploads(uploads => uploads.filter(upload => upload.id !== id));\n  } catch (error) {\n    updateUploads(uploads => uploads.map(upload => {\n      if (upload.id !== id) {\n        return upload;\n      }\n      return _objectSpread(_objectSpread({}, upload), {}, {\n        percentage: 0,\n        error: new Error(getErrorMessage(error))\n      });\n    }));\n  } finally {\n    if (!uploads.length) {\n      UserAction.stop(rid, USER_ACTIVITIES.USER_UPLOADING, {\n        tmid\n      });\n    }\n  }\n};\nconst createUploadsAPI = _ref2 => {\n  let {\n    rid,\n    tmid\n  } = _ref2;\n  return {\n    get,\n    subscribe,\n    wipeFailedOnes,\n    cancel,\n    send: (file, _ref3, getContent, fileContent) => {\n      let {\n        description,\n        msg,\n        t\n      } = _ref3;\n      return send(file, {\n        description,\n        msg,\n        rid,\n        tmid,\n        t\n      }, getContent, fileContent);\n    }\n  };\n};","map":{"version":3,"names":["_objectSpread","module","link","default","v","export","createUploadsAPI","Emitter","Random","UserAction","USER_ACTIVITIES","sdk","getErrorMessage","uploads","emitter","updateUploads","update","emit","get","subscribe","callback","on","cancel","id","concat","wipeFailedOnes","filter","upload","error","send","file","_ref","getContent","fileContent","description","msg","rid","tmid","t","name","raw","percentage","Promise","resolve","reject","xhr","rest","content","JSON","stringify","encrypted","load","event","progress","lengthComputable","loaded","total","map","Math","round","Error","responseText","onload","readyState","DONE","status","result","parse","_id","url","post","length","performContinuously","USER_UPLOADING","once","abort","stop","_ref2","_ref3"],"sources":["client/lib/chats/uploads.ts"],"sourcesContent":["import type { IMessage, IRoom, IE2EEMessage, IUpload } from '@rocket.chat/core-typings';\nimport { Emitter } from '@rocket.chat/emitter';\nimport { Random } from '@rocket.chat/random';\n\nimport { UserAction, USER_ACTIVITIES } from '../../../app/ui/client/lib/UserAction';\nimport { sdk } from '../../../app/utils/client/lib/SDKClient';\nimport { getErrorMessage } from '../errorHandling';\nimport type { UploadsAPI } from './ChatAPI';\nimport type { Upload } from './Upload';\n\nlet uploads: readonly Upload[] = [];\n\nconst emitter = new Emitter<{ update: void; [x: `cancelling-${Upload['id']}`]: void }>();\n\nconst updateUploads = (update: (uploads: readonly Upload[]) => readonly Upload[]): void => {\n\tuploads = update(uploads);\n\temitter.emit('update');\n};\n\nconst get = (): readonly Upload[] => uploads;\n\nconst subscribe = (callback: () => void): (() => void) => emitter.on('update', callback);\n\nconst cancel = (id: Upload['id']): void => {\n\temitter.emit(`cancelling-${id}`);\n};\n\nconst wipeFailedOnes = (): void => {\n\tupdateUploads((uploads) => uploads.filter((upload) => !upload.error));\n};\n\nconst send = async (\n\tfile: File,\n\t{\n\t\tdescription,\n\t\tmsg,\n\t\trid,\n\t\ttmid,\n\t\tt,\n\t}: {\n\t\tdescription?: string;\n\t\tmsg?: string;\n\t\trid: string;\n\t\ttmid?: string;\n\t\tt?: IMessage['t'];\n\t},\n\tgetContent?: (fileId: string, fileUrl: string) => Promise<IE2EEMessage['content']>,\n\tfileContent?: { raw: Partial<IUpload>; encrypted: IE2EEMessage['content'] },\n): Promise<void> => {\n\tconst id = Random.id();\n\n\tupdateUploads((uploads) => [\n\t\t...uploads,\n\t\t{\n\t\t\tid,\n\t\t\tname: fileContent?.raw.name || file.name,\n\t\t\tpercentage: 0,\n\t\t},\n\t]);\n\n\ttry {\n\t\tawait new Promise((resolve, reject) => {\n\t\t\tconst xhr = sdk.rest.upload(\n\t\t\t\t`/v1/rooms.media/${rid}`,\n\t\t\t\t{\n\t\t\t\t\tfile,\n\t\t\t\t\t...(fileContent && {\n\t\t\t\t\t\tcontent: JSON.stringify(fileContent.encrypted),\n\t\t\t\t\t}),\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\tload: (event) => {\n\t\t\t\t\t\tresolve(event);\n\t\t\t\t\t},\n\t\t\t\t\tprogress: (event) => {\n\t\t\t\t\t\tif (!event.lengthComputable) {\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\t\t\t\t\t\tconst progress = (event.loaded / event.total) * 100;\n\t\t\t\t\t\tif (progress === 100) {\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tupdateUploads((uploads) =>\n\t\t\t\t\t\t\tuploads.map((upload) => {\n\t\t\t\t\t\t\t\tif (upload.id !== id) {\n\t\t\t\t\t\t\t\t\treturn upload;\n\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\treturn {\n\t\t\t\t\t\t\t\t\t...upload,\n\t\t\t\t\t\t\t\t\tpercentage: Math.round(progress) || 0,\n\t\t\t\t\t\t\t\t};\n\t\t\t\t\t\t\t}),\n\t\t\t\t\t\t);\n\t\t\t\t\t},\n\t\t\t\t\terror: (event) => {\n\t\t\t\t\t\tupdateUploads((uploads) =>\n\t\t\t\t\t\t\tuploads.map((upload) => {\n\t\t\t\t\t\t\t\tif (upload.id !== id) {\n\t\t\t\t\t\t\t\t\treturn upload;\n\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\treturn {\n\t\t\t\t\t\t\t\t\t...upload,\n\t\t\t\t\t\t\t\t\tpercentage: 0,\n\t\t\t\t\t\t\t\t\terror: new Error(xhr.responseText),\n\t\t\t\t\t\t\t\t};\n\t\t\t\t\t\t\t}),\n\t\t\t\t\t\t);\n\t\t\t\t\t\treject(event);\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t);\n\n\t\t\txhr.onload = async () => {\n\t\t\t\tif (xhr.readyState === xhr.DONE && xhr.status === 200) {\n\t\t\t\t\tconst result = JSON.parse(xhr.responseText);\n\t\t\t\t\tlet content;\n\t\t\t\t\tif (getContent) {\n\t\t\t\t\t\tcontent = await getContent(result.file._id, result.file.url);\n\t\t\t\t\t}\n\n\t\t\t\t\tawait sdk.rest.post(`/v1/rooms.mediaConfirm/${rid}/${result.file._id}`, {\n\t\t\t\t\t\tmsg,\n\t\t\t\t\t\ttmid,\n\t\t\t\t\t\tdescription,\n\t\t\t\t\t\tt,\n\t\t\t\t\t\tcontent,\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t};\n\n\t\t\tif (uploads.length) {\n\t\t\t\tUserAction.performContinuously(rid, USER_ACTIVITIES.USER_UPLOADING, { tmid });\n\t\t\t}\n\n\t\t\temitter.once(`cancelling-${id}`, () => {\n\t\t\t\txhr.abort();\n\t\t\t\tupdateUploads((uploads) => uploads.filter((upload) => upload.id !== id));\n\t\t\t});\n\t\t});\n\n\t\tupdateUploads((uploads) => uploads.filter((upload) => upload.id !== id));\n\t} catch (error: unknown) {\n\t\tupdateUploads((uploads) =>\n\t\t\tuploads.map((upload) => {\n\t\t\t\tif (upload.id !== id) {\n\t\t\t\t\treturn upload;\n\t\t\t\t}\n\n\t\t\t\treturn {\n\t\t\t\t\t...upload,\n\t\t\t\t\tpercentage: 0,\n\t\t\t\t\terror: new Error(getErrorMessage(error)),\n\t\t\t\t};\n\t\t\t}),\n\t\t);\n\t} finally {\n\t\tif (!uploads.length) {\n\t\t\tUserAction.stop(rid, USER_ACTIVITIES.USER_UPLOADING, { tmid });\n\t\t}\n\t}\n};\n\nexport const createUploadsAPI = ({ rid, tmid }: { rid: IRoom['_id']; tmid?: IMessage['_id'] }): UploadsAPI => ({\n\tget,\n\tsubscribe,\n\twipeFailedOnes,\n\tcancel,\n\tsend: (\n\t\tfile: File,\n\t\t{ description, msg, t }: { description?: string; msg?: string; t?: IMessage['t'] },\n\t\tgetContent?: (fileId: string, fileUrl: string) => Promise<IE2EEMessage['content']>,\n\t\tfileContent?: { raw: Partial<IUpload>; encrypted: IE2EEMessage['content'] },\n\t): Promise<void> => send(file, { description, msg, rid, tmid, t }, getContent, fileContent),\n});\n"],"mappings":"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","ignoreList":[]},"sourceType":"module","externalDependencies":{},"hash":"238ee265d2e97c5d4a621ab596533e6d91cf09dc"}
