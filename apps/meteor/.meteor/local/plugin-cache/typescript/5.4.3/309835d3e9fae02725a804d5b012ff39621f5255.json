{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/server/modules/streamer/streamer.module.ts","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","topLevelAwait","objectRestSpread","objectRestSpread","asyncGenerators","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"os.osx.arm64"},"sourceFileName":"server/modules/streamer/streamer.module.ts","filename":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/server/modules/streamer/streamer.module.ts","inputSourceMap":{"version":3,"file":"server/modules/streamer/streamer.module.ts","sourceRoot":"","sources":["server/modules/streamer/streamer.module.ts"],"names":[],"mappings":"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","sourcesContent":["import { MeteorError } from '@rocket.chat/core-services';\nimport type { StreamerEvents } from '@rocket.chat/ddp-client';\nimport { EventEmitter } from 'eventemitter3';\nimport type { IPublication, Rule, Connection, DDPSubscription, IStreamer, IRules, TransformMessage } from 'meteor/rocketchat:streamer';\n\nimport { SystemLogger } from '../../lib/logger/system';\n\nclass StreamerCentralClass<N extends keyof StreamerEvents> extends EventEmitter {\n\tpublic instances: Record<string, Streamer<N>> = {};\n\n\tconstructor() {\n\t\tsuper();\n\t}\n}\n\nexport const StreamerCentral = new StreamerCentralClass();\n\nexport abstract class Streamer<N extends keyof StreamerEvents> extends EventEmitter implements IStreamer<N> {\n\tpublic subscriptions = new Set<DDPSubscription>();\n\n\tprotected subscriptionsByEventName = new Map<string, Set<DDPSubscription>>();\n\n\tpublic retransmit = true;\n\n\tpublic retransmitToSelf = false;\n\n\tpublic serverOnly = false;\n\n\tprivate _allowRead: IRules = {};\n\n\tprivate _allowWrite: IRules = {};\n\n\tprivate _allowEmit: IRules = {};\n\n\tconstructor(\n\t\tpublic name: string,\n\t\t{ retransmit = true, retransmitToSelf = false }: { retransmit?: boolean; retransmitToSelf?: boolean } = {},\n\t) {\n\t\tsuper();\n\n\t\tif (StreamerCentral.instances[name]) {\n\t\t\tconsole.warn('Streamer instance already exists:', name);\n\t\t\treturn StreamerCentral.instances[name];\n\t\t}\n\n\t\tStreamerCentral.instances[name] = this;\n\n\t\tthis.retransmit = retransmit;\n\t\tthis.retransmitToSelf = retransmitToSelf;\n\n\t\tthis.iniPublication();\n\t\t// DDPStreamer doesn't have this\n\t\tthis.initMethod();\n\n\t\tthis.allowRead('none');\n\t\tthis.allowEmit('all');\n\t\tthis.allowWrite('none');\n\t}\n\n\tget subscriptionName(): string {\n\t\treturn `stream-${this.name}`;\n\t}\n\n\tprivate allow(rules: IRules, name: string) {\n\t\treturn (eventName: string | boolean | Rule, fn?: string | boolean | Rule): void => {\n\t\t\tif (fn === undefined) {\n\t\t\t\tfn = eventName;\n\t\t\t\teventName = '__all__';\n\t\t\t}\n\n\t\t\tif (typeof eventName !== 'string') {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tif (typeof fn === 'function') {\n\t\t\t\trules[eventName] = fn;\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tif (typeof fn === 'string' && ['all', 'none', 'logged'].indexOf(fn) === -1) {\n\t\t\t\tSystemLogger.error(`${name} shortcut '${fn}' is invalid`);\n\t\t\t}\n\n\t\t\tif (fn === 'all' || fn === true) {\n\t\t\t\trules[eventName] = async function (): Promise<boolean> {\n\t\t\t\t\treturn true;\n\t\t\t\t};\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tif (fn === 'none' || fn === false) {\n\t\t\t\trules[eventName] = async function (): Promise<boolean> {\n\t\t\t\t\treturn false;\n\t\t\t\t};\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tif (fn === 'logged') {\n\t\t\t\trules[eventName] = async function (): Promise<boolean> {\n\t\t\t\t\treturn Boolean(this.userId);\n\t\t\t\t};\n\t\t\t}\n\t\t};\n\t}\n\n\tallowRead(eventName: string | boolean | Rule, fn?: Rule | 'all' | 'none' | 'logged'): void {\n\t\tthis.allow(this._allowRead, 'allowRead')(eventName, fn);\n\t}\n\n\tallowWrite(eventName: string | boolean | Rule, fn?: Rule | 'all' | 'none' | 'logged'): void {\n\t\tthis.allow(this._allowWrite, 'allowWrite')(eventName, fn);\n\t}\n\n\tallowEmit(eventName: string | boolean | Rule, fn?: Rule | 'all' | 'none' | 'logged'): void {\n\t\tthis.allow(this._allowEmit, 'allowEmit')(eventName, fn);\n\t}\n\n\tprivate isAllowed(rules: IRules) {\n\t\treturn async (scope: IPublication, eventName: string, args: any): Promise<boolean | object> => {\n\t\t\tif (rules[eventName]) {\n\t\t\t\treturn rules[eventName].call(scope, eventName, ...args);\n\t\t\t}\n\n\t\t\treturn rules.__all__.call(scope, eventName, ...args);\n\t\t};\n\t}\n\n\tasync isReadAllowed(scope: IPublication, eventName: string, args: any): Promise<boolean | object> {\n\t\treturn this.isAllowed(this._allowRead)(scope, eventName, args);\n\t}\n\n\tasync isEmitAllowed(scope: IPublication, eventName: string, ...args: any[]): Promise<boolean | object> {\n\t\treturn this.isAllowed(this._allowEmit)(scope, eventName, args);\n\t}\n\n\tasync isWriteAllowed(scope: IPublication, eventName: string, args: any): Promise<boolean | object> {\n\t\treturn this.isAllowed(this._allowWrite)(scope, eventName, args);\n\t}\n\n\taddSubscription(subscription: DDPSubscription, eventName: string): void {\n\t\tthis.subscriptions.add(subscription);\n\n\t\tconst subByEventName = this.subscriptionsByEventName.get(eventName) || new Set();\n\t\tsubByEventName.add(subscription);\n\n\t\tthis.subscriptionsByEventName.set(eventName, subByEventName);\n\t}\n\n\tremoveSubscription(subscription: DDPSubscription, eventName: string): void {\n\t\tthis.subscriptions.delete(subscription);\n\n\t\tconst subByEventName = this.subscriptionsByEventName.get(eventName);\n\t\tif (subByEventName) {\n\t\t\tsubByEventName.delete(subscription);\n\t\t}\n\t}\n\n\tasync _publish(\n\t\tpublication: IPublication,\n\t\teventName: string,\n\t\toptions: boolean | { useCollection?: boolean; args?: any } = false,\n\t): Promise<void> {\n\t\tlet useCollection;\n\t\tlet args = [];\n\n\t\tif (typeof options === 'boolean') {\n\t\t\tuseCollection = options;\n\t\t} else {\n\t\t\tif (options.useCollection) {\n\t\t\t\tuseCollection = options.useCollection;\n\t\t\t}\n\n\t\t\tif (options.args) {\n\t\t\t\targs = options.args;\n\t\t\t}\n\t\t}\n\n\t\tif (eventName.length === 0) {\n\t\t\tthrow new MeteorError('invalid-event-name');\n\t\t}\n\n\t\tif ((await this.isReadAllowed(publication, eventName, args)) !== true) {\n\t\t\tthrow new MeteorError('not-allowed');\n\t\t}\n\n\t\tconst subscription = {\n\t\t\tsubscription: publication,\n\t\t\teventName,\n\t\t};\n\n\t\tthis.addSubscription(subscription, eventName);\n\n\t\tpublication.onStop(() => {\n\t\t\tthis.removeSubscription(subscription, eventName);\n\t\t});\n\n\t\t// DDPStreamer doesn't have this\n\t\tif (useCollection === true) {\n\t\t\t// Collection compatibility\n\t\t\tpublication._session.sendAdded(this.subscriptionName, 'id', {\n\t\t\t\teventName,\n\t\t\t});\n\t\t}\n\n\t\tpublication.ready();\n\n\t\tsuper.emit('_afterPublish', this, publication, eventName, options);\n\t}\n\n\tabstract registerPublication(\n\t\tname: string,\n\t\tfn: (eventName: string, options: boolean | { useCollection?: boolean; args?: any }) => Promise<void>,\n\t): void;\n\n\tiniPublication(): void {\n\t\tconst _publish = this._publish.bind(this);\n\t\tthis.registerPublication(\n\t\t\tthis.subscriptionName,\n\t\t\tasync function (this: IPublication, eventName: string, options: boolean | { useCollection?: boolean; args?: any }) {\n\t\t\t\treturn _publish(this, eventName, options);\n\t\t\t},\n\t\t);\n\t}\n\n\tabstract registerMethod(methods: Record<string, (eventName: string, ...args: any[]) => any>): void;\n\n\tinitMethod(): void {\n\t\tconst isWriteAllowed = this.isWriteAllowed.bind(this);\n\t\tconst __emit = this.__emit.bind(this);\n\t\tconst _emit = this._emit.bind(this);\n\t\tconst { retransmit } = this;\n\n\t\tconst method: Record<string, (eventName: string, ...args: any[]) => any> = {\n\t\t\tasync [this.subscriptionName](this: IPublication, eventName, ...args): Promise<void> {\n\t\t\t\tif ((await isWriteAllowed(this, eventName, args)) !== true) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\t__emit(eventName, ...args);\n\n\t\t\t\tif (retransmit === true) {\n\t\t\t\t\t_emit(eventName, args, this.connection, true);\n\t\t\t\t}\n\t\t\t},\n\t\t};\n\n\t\ttry {\n\t\t\tthis.registerMethod(method);\n\t\t} catch (e) {\n\t\t\tSystemLogger.error(e);\n\t\t}\n\t}\n\n\tabstract changedPayload(collection: string, id: string, fields: Record<string, any>): string | false;\n\n\t_emit(eventName: string, args: any[], origin: Connection | undefined, broadcast: boolean, transform?: TransformMessage): boolean {\n\t\tif (broadcast === true) {\n\t\t\tStreamerCentral.emit('broadcast', this.name, eventName, args);\n\t\t}\n\n\t\tconst subscriptions = this.subscriptionsByEventName.get(eventName);\n\t\tif (!subscriptions?.size) {\n\t\t\treturn false;\n\t\t}\n\n\t\tif (transform) {\n\t\t\tvoid this.sendToManySubscriptions(subscriptions, origin, eventName, args, transform);\n\n\t\t\treturn true;\n\t\t}\n\n\t\tconst msg = this.changedPayload(this.subscriptionName, 'id', {\n\t\t\teventName,\n\t\t\targs,\n\t\t});\n\n\t\tif (!msg) {\n\t\t\treturn false;\n\t\t}\n\n\t\tvoid this.sendToManySubscriptions(subscriptions, origin, eventName, args, msg);\n\n\t\treturn true;\n\t}\n\n\tasync sendToManySubscriptions(\n\t\tsubscriptions: Set<DDPSubscription>,\n\t\torigin: Connection | undefined,\n\t\teventName: string,\n\t\targs: any[],\n\t\tgetMsg: string | TransformMessage,\n\t): Promise<void> {\n\t\tsubscriptions.forEach(async (subscription) => {\n\t\t\tif (this.retransmitToSelf === false && origin && origin === subscription.subscription.connection) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconst allowed = await this.isEmitAllowed(subscription.subscription, eventName, ...args);\n\t\t\tif (allowed) {\n\t\t\t\tconst msg = typeof getMsg === 'string' ? getMsg : getMsg(this, subscription, eventName, args, allowed);\n\t\t\t\tif (msg) {\n\t\t\t\t\tsubscription.subscription._session.socket?.send(msg);\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\t}\n\n\temit(eventName: string | symbol, ...args: any[]): boolean {\n\t\treturn this._emit(eventName as string, args, undefined, true);\n\t}\n\n\t__emit(eventName: string, ...args: any[]): boolean {\n\t\treturn super.emit(eventName, ...args);\n\t}\n\n\temitWithoutBroadcast(eventName: string, ...args: any[]): void {\n\t\tthis._emit(eventName, args, undefined, false);\n\t}\n}\n"]},"targets":{"android":"125.0.0","chrome":"125.0.0","edge":"125.0.0","firefox":"115.0.0","ie":"10.0.0","ios":"17.4.0","opera":"110.0.0","opera_mobile":"80.0.0","safari":"17.4.0","samsung":"24.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor","root":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":false,"enforceStrictMode":false,"dynamicImport":true,"generateLetDeclarations":true,"topLevelAwait":true},"externalDependencies":[]},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"version":"7.17.2","helpers":true,"useESModules":false,"corejs":false},"externalDependencies":[]},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-async-generator-functions","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-class-properties","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true},"externalDependencies":[]},{"key":"transform-react-jsx","visitor":{"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXFragment":{"exit":[null]},"JSXElement":{"exit":[null]},"JSXAttribute":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false},"externalDependencies":[]},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-nullish-coalescing-operator","visitor":{"LogicalExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-optional-chaining","visitor":{"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-optional-catch-binding","visitor":{"CatchClause":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-class-properties","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-async-generator-functions","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-logical-assignment-operators","visitor":{"AssignmentExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]}],"presets":[],"generatorOpts":{"filename":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/server/modules/streamer/streamer.module.ts","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"server/modules/streamer/streamer.module.ts","inputSourceMap":{"version":3,"file":"server/modules/streamer/streamer.module.ts","sourceRoot":"","sources":["server/modules/streamer/streamer.module.ts"],"names":[],"mappings":"AAAA,OAAO,EAAE,WAAW,EAAE,MAAM,4BAA4B,CAAC;AAEzD,OAAO,EAAE,YAAY,EAAE,MAAM,eAAe,CAAC;AAG7C,OAAO,EAAE,YAAY,EAAE,MAAM,yBAAyB,CAAC;AAEvD,MAAM,oBAAqD,SAAQ,YAAY;IACvE,SAAS,GAAgC,EAAE,CAAC;IAEnD;QACC,KAAK,EAAE,CAAC;IACT,CAAC;CACD;AAED,MAAM,CAAC,MAAM,eAAe,GAAG,IAAI,oBAAoB,EAAE,CAAC;AAE1D,MAAM,OAAgB,QAAyC,SAAQ,YAAY;IAkB1E;IAjBD,aAAa,GAAG,IAAI,GAAG,EAAmB,CAAC;IAExC,wBAAwB,GAAG,IAAI,GAAG,EAAgC,CAAC;IAEtE,UAAU,GAAG,IAAI,CAAC;IAElB,gBAAgB,GAAG,KAAK,CAAC;IAEzB,UAAU,GAAG,KAAK,CAAC;IAElB,UAAU,GAAW,EAAE,CAAC;IAExB,WAAW,GAAW,EAAE,CAAC;IAEzB,UAAU,GAAW,EAAE,CAAC;IAEhC,YACQ,IAAY,EACnB,EAAE,UAAU,GAAG,IAAI,EAAE,gBAAgB,GAAG,KAAK,KAA2D,EAAE;QAE1G,KAAK,EAAE,CAAC;QAHD,SAAI,GAAJ,IAAI,CAAQ;QAKnB,IAAI,eAAe,CAAC,SAAS,CAAC,IAAI,CAAC,EAAE,CAAC;YACrC,OAAO,CAAC,IAAI,CAAC,mCAAmC,EAAE,IAAI,CAAC,CAAC;YACxD,OAAO,eAAe,CAAC,SAAS,CAAC,IAAI,CAAC,CAAC;QACxC,CAAC;QAED,eAAe,CAAC,SAAS,CAAC,IAAI,CAAC,GAAG,IAAI,CAAC;QAEvC,IAAI,CAAC,UAAU,GAAG,UAAU,CAAC;QAC7B,IAAI,CAAC,gBAAgB,GAAG,gBAAgB,CAAC;QAEzC,IAAI,CAAC,cAAc,EAAE,CAAC;QACtB,gCAAgC;QAChC,IAAI,CAAC,UAAU,EAAE,CAAC;QAElB,IAAI,CAAC,SAAS,CAAC,MAAM,CAAC,CAAC;QACvB,IAAI,CAAC,SAAS,CAAC,KAAK,CAAC,CAAC;QACtB,IAAI,CAAC,UAAU,CAAC,MAAM,CAAC,CAAC;IACzB,CAAC;IAED,IAAI,gBAAgB;QACnB,OAAO,UAAU,IAAI,CAAC,IAAI,EAAE,CAAC;IAC9B,CAAC;IAEO,KAAK,CAAC,KAAa,EAAE,IAAY;QACxC,OAAO,CAAC,SAAkC,EAAE,EAA4B,EAAQ,EAAE;YACjF,IAAI,EAAE,KAAK,SAAS,EAAE,CAAC;gBACtB,EAAE,GAAG,SAAS,CAAC;gBACf,SAAS,GAAG,SAAS,CAAC;YACvB,CAAC;YAED,IAAI,OAAO,SAAS,KAAK,QAAQ,EAAE,CAAC;gBACnC,OAAO;YACR,CAAC;YAED,IAAI,OAAO,EAAE,KAAK,UAAU,EAAE,CAAC;gBAC9B,KAAK,CAAC,SAAS,CAAC,GAAG,EAAE,CAAC;gBACtB,OAAO;YACR,CAAC;YAED,IAAI,OAAO,EAAE,KAAK,QAAQ,IAAI,CAAC,KAAK,EAAE,MAAM,EAAE,QAAQ,CAAC,CAAC,OAAO,CAAC,EAAE,CAAC,KAAK,CAAC,CAAC,EAAE,CAAC;gBAC5E,YAAY,CAAC,KAAK,CAAC,GAAG,IAAI,cAAc,EAAE,cAAc,CAAC,CAAC;YAC3D,CAAC;YAED,IAAI,EAAE,KAAK,KAAK,IAAI,EAAE,KAAK,IAAI,EAAE,CAAC;gBACjC,KAAK,CAAC,SAAS,CAAC,GAAG,KAAK;oBACvB,OAAO,IAAI,CAAC;gBACb,CAAC,CAAC;gBACF,OAAO;YACR,CAAC;YAED,IAAI,EAAE,KAAK,MAAM,IAAI,EAAE,KAAK,KAAK,EAAE,CAAC;gBACnC,KAAK,CAAC,SAAS,CAAC,GAAG,KAAK;oBACvB,OAAO,KAAK,CAAC;gBACd,CAAC,CAAC;gBACF,OAAO;YACR,CAAC;YAED,IAAI,EAAE,KAAK,QAAQ,EAAE,CAAC;gBACrB,KAAK,CAAC,SAAS,CAAC,GAAG,KAAK;oBACvB,OAAO,OAAO,CAAC,IAAI,CAAC,MAAM,CAAC,CAAC;gBAC7B,CAAC,CAAC;YACH,CAAC;QACF,CAAC,CAAC;IACH,CAAC;IAED,SAAS,CAAC,SAAkC,EAAE,EAAqC;QAClF,IAAI,CAAC,KAAK,CAAC,IAAI,CAAC,UAAU,EAAE,WAAW,CAAC,CAAC,SAAS,EAAE,EAAE,CAAC,CAAC;IACzD,CAAC;IAED,UAAU,CAAC,SAAkC,EAAE,EAAqC;QACnF,IAAI,CAAC,KAAK,CAAC,IAAI,CAAC,WAAW,EAAE,YAAY,CAAC,CAAC,SAAS,EAAE,EAAE,CAAC,CAAC;IAC3D,CAAC;IAED,SAAS,CAAC,SAAkC,EAAE,EAAqC;QAClF,IAAI,CAAC,KAAK,CAAC,IAAI,CAAC,UAAU,EAAE,WAAW,CAAC,CAAC,SAAS,EAAE,EAAE,CAAC,CAAC;IACzD,CAAC;IAEO,SAAS,CAAC,KAAa;QAC9B,OAAO,KAAK,EAAE,KAAmB,EAAE,SAAiB,EAAE,IAAS,EAA6B,EAAE;YAC7F,IAAI,KAAK,CAAC,SAAS,CAAC,EAAE,CAAC;gBACtB,OAAO,KAAK,CAAC,SAAS,CAAC,CAAC,IAAI,CAAC,KAAK,EAAE,SAAS,EAAE,GAAG,IAAI,CAAC,CAAC;YACzD,CAAC;YAED,OAAO,KAAK,CAAC,OAAO,CAAC,IAAI,CAAC,KAAK,EAAE,SAAS,EAAE,GAAG,IAAI,CAAC,CAAC;QACtD,CAAC,CAAC;IACH,CAAC;IAED,KAAK,CAAC,aAAa,CAAC,KAAmB,EAAE,SAAiB,EAAE,IAAS;QACpE,OAAO,IAAI,CAAC,SAAS,CAAC,IAAI,CAAC,UAAU,CAAC,CAAC,KAAK,EAAE,SAAS,EAAE,IAAI,CAAC,CAAC;IAChE,CAAC;IAED,KAAK,CAAC,aAAa,CAAC,KAAmB,EAAE,SAAiB,EAAE,GAAG,IAAW;QACzE,OAAO,IAAI,CAAC,SAAS,CAAC,IAAI,CAAC,UAAU,CAAC,CAAC,KAAK,EAAE,SAAS,EAAE,IAAI,CAAC,CAAC;IAChE,CAAC;IAED,KAAK,CAAC,cAAc,CAAC,KAAmB,EAAE,SAAiB,EAAE,IAAS;QACrE,OAAO,IAAI,CAAC,SAAS,CAAC,IAAI,CAAC,WAAW,CAAC,CAAC,KAAK,EAAE,SAAS,EAAE,IAAI,CAAC,CAAC;IACjE,CAAC;IAED,eAAe,CAAC,YAA6B,EAAE,SAAiB;QAC/D,IAAI,CAAC,aAAa,CAAC,GAAG,CAAC,YAAY,CAAC,CAAC;QAErC,MAAM,cAAc,GAAG,IAAI,CAAC,wBAAwB,CAAC,GAAG,CAAC,SAAS,CAAC,IAAI,IAAI,GAAG,EAAE,CAAC;QACjF,cAAc,CAAC,GAAG,CAAC,YAAY,CAAC,CAAC;QAEjC,IAAI,CAAC,wBAAwB,CAAC,GAAG,CAAC,SAAS,EAAE,cAAc,CAAC,CAAC;IAC9D,CAAC;IAED,kBAAkB,CAAC,YAA6B,EAAE,SAAiB;QAClE,IAAI,CAAC,aAAa,CAAC,MAAM,CAAC,YAAY,CAAC,CAAC;QAExC,MAAM,cAAc,GAAG,IAAI,CAAC,wBAAwB,CAAC,GAAG,CAAC,SAAS,CAAC,CAAC;QACpE,IAAI,cAAc,EAAE,CAAC;YACpB,cAAc,CAAC,MAAM,CAAC,YAAY,CAAC,CAAC;QACrC,CAAC;IACF,CAAC;IAED,KAAK,CAAC,QAAQ,CACb,WAAyB,EACzB,SAAiB,EACjB,UAA6D,KAAK;QAElE,IAAI,aAAa,CAAC;QAClB,IAAI,IAAI,GAAG,EAAE,CAAC;QAEd,IAAI,OAAO,OAAO,KAAK,SAAS,EAAE,CAAC;YAClC,aAAa,GAAG,OAAO,CAAC;QACzB,CAAC;aAAM,CAAC;YACP,IAAI,OAAO,CAAC,aAAa,EAAE,CAAC;gBAC3B,aAAa,GAAG,OAAO,CAAC,aAAa,CAAC;YACvC,CAAC;YAED,IAAI,OAAO,CAAC,IAAI,EAAE,CAAC;gBAClB,IAAI,GAAG,OAAO,CAAC,IAAI,CAAC;YACrB,CAAC;QACF,CAAC;QAED,IAAI,SAAS,CAAC,MAAM,KAAK,CAAC,EAAE,CAAC;YAC5B,MAAM,IAAI,WAAW,CAAC,oBAAoB,CAAC,CAAC;QAC7C,CAAC;QAED,IAAI,CAAC,MAAM,IAAI,CAAC,aAAa,CAAC,WAAW,EAAE,SAAS,EAAE,IAAI,CAAC,CAAC,KAAK,IAAI,EAAE,CAAC;YACvE,MAAM,IAAI,WAAW,CAAC,aAAa,CAAC,CAAC;QACtC,CAAC;QAED,MAAM,YAAY,GAAG;YACpB,YAAY,EAAE,WAAW;YACzB,SAAS;SACT,CAAC;QAEF,IAAI,CAAC,eAAe,CAAC,YAAY,EAAE,SAAS,CAAC,CAAC;QAE9C,WAAW,CAAC,MAAM,CAAC,GAAG,EAAE;YACvB,IAAI,CAAC,kBAAkB,CAAC,YAAY,EAAE,SAAS,CAAC,CAAC;QAClD,CAAC,CAAC,CAAC;QAEH,gCAAgC;QAChC,IAAI,aAAa,KAAK,IAAI,EAAE,CAAC;YAC5B,2BAA2B;YAC3B,WAAW,CAAC,QAAQ,CAAC,SAAS,CAAC,IAAI,CAAC,gBAAgB,EAAE,IAAI,EAAE;gBAC3D,SAAS;aACT,CAAC,CAAC;QACJ,CAAC;QAED,WAAW,CAAC,KAAK,EAAE,CAAC;QAEpB,KAAK,CAAC,IAAI,CAAC,eAAe,EAAE,IAAI,EAAE,WAAW,EAAE,SAAS,EAAE,OAAO,CAAC,CAAC;IACpE,CAAC;IAOD,cAAc;QACb,MAAM,QAAQ,GAAG,IAAI,CAAC,QAAQ,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;QAC1C,IAAI,CAAC,mBAAmB,CACvB,IAAI,CAAC,gBAAgB,EACrB,KAAK,WAA+B,SAAiB,EAAE,OAA0D;YAChH,OAAO,QAAQ,CAAC,IAAI,EAAE,SAAS,EAAE,OAAO,CAAC,CAAC;QAC3C,CAAC,CACD,CAAC;IACH,CAAC;IAID,UAAU;QACT,MAAM,cAAc,GAAG,IAAI,CAAC,cAAc,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;QACtD,MAAM,MAAM,GAAG,IAAI,CAAC,MAAM,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;QACtC,MAAM,KAAK,GAAG,IAAI,CAAC,KAAK,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;QACpC,MAAM,EAAE,UAAU,EAAE,GAAG,IAAI,CAAC;QAE5B,MAAM,MAAM,GAA+D;YAC1E,KAAK,CAAC,CAAC,IAAI,CAAC,gBAAgB,CAAC,CAAqB,SAAS,EAAE,GAAG,IAAI;gBACnE,IAAI,CAAC,MAAM,cAAc,CAAC,IAAI,EAAE,SAAS,EAAE,IAAI,CAAC,CAAC,KAAK,IAAI,EAAE,CAAC;oBAC5D,OAAO;gBACR,CAAC;gBAED,MAAM,CAAC,SAAS,EAAE,GAAG,IAAI,CAAC,CAAC;gBAE3B,IAAI,UAAU,KAAK,IAAI,EAAE,CAAC;oBACzB,KAAK,CAAC,SAAS,EAAE,IAAI,EAAE,IAAI,CAAC,UAAU,EAAE,IAAI,CAAC,CAAC;gBAC/C,CAAC;YACF,CAAC;SACD,CAAC;QAEF,IAAI,CAAC;YACJ,IAAI,CAAC,cAAc,CAAC,MAAM,CAAC,CAAC;QAC7B,CAAC;QAAC,OAAO,CAAC,EAAE,CAAC;YACZ,YAAY,CAAC,KAAK,CAAC,CAAC,CAAC,CAAC;QACvB,CAAC;IACF,CAAC;IAID,KAAK,CAAC,SAAiB,EAAE,IAAW,EAAE,MAA8B,EAAE,SAAkB,EAAE,SAA4B;QACrH,IAAI,SAAS,KAAK,IAAI,EAAE,CAAC;YACxB,eAAe,CAAC,IAAI,CAAC,WAAW,EAAE,IAAI,CAAC,IAAI,EAAE,SAAS,EAAE,IAAI,CAAC,CAAC;QAC/D,CAAC;QAED,MAAM,aAAa,GAAG,IAAI,CAAC,wBAAwB,CAAC,GAAG,CAAC,SAAS,CAAC,CAAC;QACnE,IAAI,CAAC,aAAa,EAAE,IAAI,EAAE,CAAC;YAC1B,OAAO,KAAK,CAAC;QACd,CAAC;QAED,IAAI,SAAS,EAAE,CAAC;YACf,KAAK,IAAI,CAAC,uBAAuB,CAAC,aAAa,EAAE,MAAM,EAAE,SAAS,EAAE,IAAI,EAAE,SAAS,CAAC,CAAC;YAErF,OAAO,IAAI,CAAC;QACb,CAAC;QAED,MAAM,GAAG,GAAG,IAAI,CAAC,cAAc,CAAC,IAAI,CAAC,gBAAgB,EAAE,IAAI,EAAE;YAC5D,SAAS;YACT,IAAI;SACJ,CAAC,CAAC;QAEH,IAAI,CAAC,GAAG,EAAE,CAAC;YACV,OAAO,KAAK,CAAC;QACd,CAAC;QAED,KAAK,IAAI,CAAC,uBAAuB,CAAC,aAAa,EAAE,MAAM,EAAE,SAAS,EAAE,IAAI,EAAE,GAAG,CAAC,CAAC;QAE/E,OAAO,IAAI,CAAC;IACb,CAAC;IAED,KAAK,CAAC,uBAAuB,CAC5B,aAAmC,EACnC,MAA8B,EAC9B,SAAiB,EACjB,IAAW,EACX,MAAiC;QAEjC,aAAa,CAAC,OAAO,CAAC,KAAK,EAAE,YAAY,EAAE,EAAE;YAC5C,IAAI,IAAI,CAAC,gBAAgB,KAAK,KAAK,IAAI,MAAM,IAAI,MAAM,KAAK,YAAY,CAAC,YAAY,CAAC,UAAU,EAAE,CAAC;gBAClG,OAAO;YACR,CAAC;YAED,MAAM,OAAO,GAAG,MAAM,IAAI,CAAC,aAAa,CAAC,YAAY,CAAC,YAAY,EAAE,SAAS,EAAE,GAAG,IAAI,CAAC,CAAC;YACxF,IAAI,OAAO,EAAE,CAAC;gBACb,MAAM,GAAG,GAAG,OAAO,MAAM,KAAK,QAAQ,CAAC,CAAC,CAAC,MAAM,CAAC,CAAC,CAAC,MAAM,CAAC,IAAI,EAAE,YAAY,EAAE,SAAS,EAAE,IAAI,EAAE,OAAO,CAAC,CAAC;gBACvG,IAAI,GAAG,EAAE,CAAC;oBACT,YAAY,CAAC,YAAY,CAAC,QAAQ,CAAC,MAAM,EAAE,IAAI,CAAC,GAAG,CAAC,CAAC;gBACtD,CAAC;YACF,CAAC;QACF,CAAC,CAAC,CAAC;IACJ,CAAC;IAED,IAAI,CAAC,SAA0B,EAAE,GAAG,IAAW;QAC9C,OAAO,IAAI,CAAC,KAAK,CAAC,SAAmB,EAAE,IAAI,EAAE,SAAS,EAAE,IAAI,CAAC,CAAC;IAC/D,CAAC;IAED,MAAM,CAAC,SAAiB,EAAE,GAAG,IAAW;QACvC,OAAO,KAAK,CAAC,IAAI,CAAC,SAAS,EAAE,GAAG,IAAI,CAAC,CAAC;IACvC,CAAC;IAED,oBAAoB,CAAC,SAAiB,EAAE,GAAG,IAAW;QACrD,IAAI,CAAC,KAAK,CAAC,SAAS,EAAE,IAAI,EAAE,SAAS,EAAE,KAAK,CAAC,CAAC;IAC/C,CAAC;CACD","sourcesContent":["import { MeteorError } from '@rocket.chat/core-services';\nimport type { StreamerEvents } from '@rocket.chat/ddp-client';\nimport { EventEmitter } from 'eventemitter3';\nimport type { IPublication, Rule, Connection, DDPSubscription, IStreamer, IRules, TransformMessage } from 'meteor/rocketchat:streamer';\n\nimport { SystemLogger } from '../../lib/logger/system';\n\nclass StreamerCentralClass<N extends keyof StreamerEvents> extends EventEmitter {\n\tpublic instances: Record<string, Streamer<N>> = {};\n\n\tconstructor() {\n\t\tsuper();\n\t}\n}\n\nexport const StreamerCentral = new StreamerCentralClass();\n\nexport abstract class Streamer<N extends keyof StreamerEvents> extends EventEmitter implements IStreamer<N> {\n\tpublic subscriptions = new Set<DDPSubscription>();\n\n\tprotected subscriptionsByEventName = new Map<string, Set<DDPSubscription>>();\n\n\tpublic retransmit = true;\n\n\tpublic retransmitToSelf = false;\n\n\tpublic serverOnly = false;\n\n\tprivate _allowRead: IRules = {};\n\n\tprivate _allowWrite: IRules = {};\n\n\tprivate _allowEmit: IRules = {};\n\n\tconstructor(\n\t\tpublic name: string,\n\t\t{ retransmit = true, retransmitToSelf = false }: { retransmit?: boolean; retransmitToSelf?: boolean } = {},\n\t) {\n\t\tsuper();\n\n\t\tif (StreamerCentral.instances[name]) {\n\t\t\tconsole.warn('Streamer instance already exists:', name);\n\t\t\treturn StreamerCentral.instances[name];\n\t\t}\n\n\t\tStreamerCentral.instances[name] = this;\n\n\t\tthis.retransmit = retransmit;\n\t\tthis.retransmitToSelf = retransmitToSelf;\n\n\t\tthis.iniPublication();\n\t\t// DDPStreamer doesn't have this\n\t\tthis.initMethod();\n\n\t\tthis.allowRead('none');\n\t\tthis.allowEmit('all');\n\t\tthis.allowWrite('none');\n\t}\n\n\tget subscriptionName(): string {\n\t\treturn `stream-${this.name}`;\n\t}\n\n\tprivate allow(rules: IRules, name: string) {\n\t\treturn (eventName: string | boolean | Rule, fn?: string | boolean | Rule): void => {\n\t\t\tif (fn === undefined) {\n\t\t\t\tfn = eventName;\n\t\t\t\teventName = '__all__';\n\t\t\t}\n\n\t\t\tif (typeof eventName !== 'string') {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tif (typeof fn === 'function') {\n\t\t\t\trules[eventName] = fn;\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tif (typeof fn === 'string' && ['all', 'none', 'logged'].indexOf(fn) === -1) {\n\t\t\t\tSystemLogger.error(`${name} shortcut '${fn}' is invalid`);\n\t\t\t}\n\n\t\t\tif (fn === 'all' || fn === true) {\n\t\t\t\trules[eventName] = async function (): Promise<boolean> {\n\t\t\t\t\treturn true;\n\t\t\t\t};\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tif (fn === 'none' || fn === false) {\n\t\t\t\trules[eventName] = async function (): Promise<boolean> {\n\t\t\t\t\treturn false;\n\t\t\t\t};\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tif (fn === 'logged') {\n\t\t\t\trules[eventName] = async function (): Promise<boolean> {\n\t\t\t\t\treturn Boolean(this.userId);\n\t\t\t\t};\n\t\t\t}\n\t\t};\n\t}\n\n\tallowRead(eventName: string | boolean | Rule, fn?: Rule | 'all' | 'none' | 'logged'): void {\n\t\tthis.allow(this._allowRead, 'allowRead')(eventName, fn);\n\t}\n\n\tallowWrite(eventName: string | boolean | Rule, fn?: Rule | 'all' | 'none' | 'logged'): void {\n\t\tthis.allow(this._allowWrite, 'allowWrite')(eventName, fn);\n\t}\n\n\tallowEmit(eventName: string | boolean | Rule, fn?: Rule | 'all' | 'none' | 'logged'): void {\n\t\tthis.allow(this._allowEmit, 'allowEmit')(eventName, fn);\n\t}\n\n\tprivate isAllowed(rules: IRules) {\n\t\treturn async (scope: IPublication, eventName: string, args: any): Promise<boolean | object> => {\n\t\t\tif (rules[eventName]) {\n\t\t\t\treturn rules[eventName].call(scope, eventName, ...args);\n\t\t\t}\n\n\t\t\treturn rules.__all__.call(scope, eventName, ...args);\n\t\t};\n\t}\n\n\tasync isReadAllowed(scope: IPublication, eventName: string, args: any): Promise<boolean | object> {\n\t\treturn this.isAllowed(this._allowRead)(scope, eventName, args);\n\t}\n\n\tasync isEmitAllowed(scope: IPublication, eventName: string, ...args: any[]): Promise<boolean | object> {\n\t\treturn this.isAllowed(this._allowEmit)(scope, eventName, args);\n\t}\n\n\tasync isWriteAllowed(scope: IPublication, eventName: string, args: any): Promise<boolean | object> {\n\t\treturn this.isAllowed(this._allowWrite)(scope, eventName, args);\n\t}\n\n\taddSubscription(subscription: DDPSubscription, eventName: string): void {\n\t\tthis.subscriptions.add(subscription);\n\n\t\tconst subByEventName = this.subscriptionsByEventName.get(eventName) || new Set();\n\t\tsubByEventName.add(subscription);\n\n\t\tthis.subscriptionsByEventName.set(eventName, subByEventName);\n\t}\n\n\tremoveSubscription(subscription: DDPSubscription, eventName: string): void {\n\t\tthis.subscriptions.delete(subscription);\n\n\t\tconst subByEventName = this.subscriptionsByEventName.get(eventName);\n\t\tif (subByEventName) {\n\t\t\tsubByEventName.delete(subscription);\n\t\t}\n\t}\n\n\tasync _publish(\n\t\tpublication: IPublication,\n\t\teventName: string,\n\t\toptions: boolean | { useCollection?: boolean; args?: any } = false,\n\t): Promise<void> {\n\t\tlet useCollection;\n\t\tlet args = [];\n\n\t\tif (typeof options === 'boolean') {\n\t\t\tuseCollection = options;\n\t\t} else {\n\t\t\tif (options.useCollection) {\n\t\t\t\tuseCollection = options.useCollection;\n\t\t\t}\n\n\t\t\tif (options.args) {\n\t\t\t\targs = options.args;\n\t\t\t}\n\t\t}\n\n\t\tif (eventName.length === 0) {\n\t\t\tthrow new MeteorError('invalid-event-name');\n\t\t}\n\n\t\tif ((await this.isReadAllowed(publication, eventName, args)) !== true) {\n\t\t\tthrow new MeteorError('not-allowed');\n\t\t}\n\n\t\tconst subscription = {\n\t\t\tsubscription: publication,\n\t\t\teventName,\n\t\t};\n\n\t\tthis.addSubscription(subscription, eventName);\n\n\t\tpublication.onStop(() => {\n\t\t\tthis.removeSubscription(subscription, eventName);\n\t\t});\n\n\t\t// DDPStreamer doesn't have this\n\t\tif (useCollection === true) {\n\t\t\t// Collection compatibility\n\t\t\tpublication._session.sendAdded(this.subscriptionName, 'id', {\n\t\t\t\teventName,\n\t\t\t});\n\t\t}\n\n\t\tpublication.ready();\n\n\t\tsuper.emit('_afterPublish', this, publication, eventName, options);\n\t}\n\n\tabstract registerPublication(\n\t\tname: string,\n\t\tfn: (eventName: string, options: boolean | { useCollection?: boolean; args?: any }) => Promise<void>,\n\t): void;\n\n\tiniPublication(): void {\n\t\tconst _publish = this._publish.bind(this);\n\t\tthis.registerPublication(\n\t\t\tthis.subscriptionName,\n\t\t\tasync function (this: IPublication, eventName: string, options: boolean | { useCollection?: boolean; args?: any }) {\n\t\t\t\treturn _publish(this, eventName, options);\n\t\t\t},\n\t\t);\n\t}\n\n\tabstract registerMethod(methods: Record<string, (eventName: string, ...args: any[]) => any>): void;\n\n\tinitMethod(): void {\n\t\tconst isWriteAllowed = this.isWriteAllowed.bind(this);\n\t\tconst __emit = this.__emit.bind(this);\n\t\tconst _emit = this._emit.bind(this);\n\t\tconst { retransmit } = this;\n\n\t\tconst method: Record<string, (eventName: string, ...args: any[]) => any> = {\n\t\t\tasync [this.subscriptionName](this: IPublication, eventName, ...args): Promise<void> {\n\t\t\t\tif ((await isWriteAllowed(this, eventName, args)) !== true) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\t__emit(eventName, ...args);\n\n\t\t\t\tif (retransmit === true) {\n\t\t\t\t\t_emit(eventName, args, this.connection, true);\n\t\t\t\t}\n\t\t\t},\n\t\t};\n\n\t\ttry {\n\t\t\tthis.registerMethod(method);\n\t\t} catch (e) {\n\t\t\tSystemLogger.error(e);\n\t\t}\n\t}\n\n\tabstract changedPayload(collection: string, id: string, fields: Record<string, any>): string | false;\n\n\t_emit(eventName: string, args: any[], origin: Connection | undefined, broadcast: boolean, transform?: TransformMessage): boolean {\n\t\tif (broadcast === true) {\n\t\t\tStreamerCentral.emit('broadcast', this.name, eventName, args);\n\t\t}\n\n\t\tconst subscriptions = this.subscriptionsByEventName.get(eventName);\n\t\tif (!subscriptions?.size) {\n\t\t\treturn false;\n\t\t}\n\n\t\tif (transform) {\n\t\t\tvoid this.sendToManySubscriptions(subscriptions, origin, eventName, args, transform);\n\n\t\t\treturn true;\n\t\t}\n\n\t\tconst msg = this.changedPayload(this.subscriptionName, 'id', {\n\t\t\teventName,\n\t\t\targs,\n\t\t});\n\n\t\tif (!msg) {\n\t\t\treturn false;\n\t\t}\n\n\t\tvoid this.sendToManySubscriptions(subscriptions, origin, eventName, args, msg);\n\n\t\treturn true;\n\t}\n\n\tasync sendToManySubscriptions(\n\t\tsubscriptions: Set<DDPSubscription>,\n\t\torigin: Connection | undefined,\n\t\teventName: string,\n\t\targs: any[],\n\t\tgetMsg: string | TransformMessage,\n\t): Promise<void> {\n\t\tsubscriptions.forEach(async (subscription) => {\n\t\t\tif (this.retransmitToSelf === false && origin && origin === subscription.subscription.connection) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconst allowed = await this.isEmitAllowed(subscription.subscription, eventName, ...args);\n\t\t\tif (allowed) {\n\t\t\t\tconst msg = typeof getMsg === 'string' ? getMsg : getMsg(this, subscription, eventName, args, allowed);\n\t\t\t\tif (msg) {\n\t\t\t\t\tsubscription.subscription._session.socket?.send(msg);\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\t}\n\n\temit(eventName: string | symbol, ...args: any[]): boolean {\n\t\treturn this._emit(eventName as string, args, undefined, true);\n\t}\n\n\t__emit(eventName: string, ...args: any[]): boolean {\n\t\treturn super.emit(eventName, ...args);\n\t}\n\n\temitWithoutBroadcast(eventName: string, ...args: any[]): void {\n\t\tthis._emit(eventName, args, undefined, false);\n\t}\n}\n"]}}},"code":"!module.wrapAsync(async function (module, __reifyWaitForDeps__, __reify_async_result__) {\n  \"use strict\";\n  try {\n    module.export({\n      StreamerCentral: () => StreamerCentral,\n      Streamer: () => Streamer\n    });\n    let MeteorError;\n    module.link(\"@rocket.chat/core-services\", {\n      MeteorError(v) {\n        MeteorError = v;\n      }\n    }, 0);\n    let EventEmitter;\n    module.link(\"eventemitter3\", {\n      EventEmitter(v) {\n        EventEmitter = v;\n      }\n    }, 1);\n    let SystemLogger;\n    module.link(\"../../lib/logger/system\", {\n      SystemLogger(v) {\n        SystemLogger = v;\n      }\n    }, 2);\n    if (__reifyWaitForDeps__()) (await __reifyWaitForDeps__())();\n    class StreamerCentralClass extends EventEmitter {\n      constructor() {\n        super();\n        this.instances = {};\n      }\n    }\n    const StreamerCentral = new StreamerCentralClass();\n    class Streamer extends EventEmitter {\n      constructor(name) {\n        let {\n          retransmit = true,\n          retransmitToSelf = false\n        } = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};\n        super();\n        this.name = void 0;\n        this.subscriptions = new Set();\n        this.subscriptionsByEventName = new Map();\n        this.retransmit = true;\n        this.retransmitToSelf = false;\n        this.serverOnly = false;\n        this._allowRead = {};\n        this._allowWrite = {};\n        this._allowEmit = {};\n        this.name = name;\n        if (StreamerCentral.instances[name]) {\n          console.warn('Streamer instance already exists:', name);\n          return StreamerCentral.instances[name];\n        }\n        StreamerCentral.instances[name] = this;\n        this.retransmit = retransmit;\n        this.retransmitToSelf = retransmitToSelf;\n        this.iniPublication();\n        // DDPStreamer doesn't have this\n        this.initMethod();\n        this.allowRead('none');\n        this.allowEmit('all');\n        this.allowWrite('none');\n      }\n      get subscriptionName() {\n        return \"stream-\".concat(this.name);\n      }\n      allow(rules, name) {\n        return (eventName, fn) => {\n          if (fn === undefined) {\n            fn = eventName;\n            eventName = '__all__';\n          }\n          if (typeof eventName !== 'string') {\n            return;\n          }\n          if (typeof fn === 'function') {\n            rules[eventName] = fn;\n            return;\n          }\n          if (typeof fn === 'string' && ['all', 'none', 'logged'].indexOf(fn) === -1) {\n            SystemLogger.error(\"\".concat(name, \" shortcut '\").concat(fn, \"' is invalid\"));\n          }\n          if (fn === 'all' || fn === true) {\n            rules[eventName] = async function () {\n              return true;\n            };\n            return;\n          }\n          if (fn === 'none' || fn === false) {\n            rules[eventName] = async function () {\n              return false;\n            };\n            return;\n          }\n          if (fn === 'logged') {\n            rules[eventName] = async function () {\n              return Boolean(this.userId);\n            };\n          }\n        };\n      }\n      allowRead(eventName, fn) {\n        this.allow(this._allowRead, 'allowRead')(eventName, fn);\n      }\n      allowWrite(eventName, fn) {\n        this.allow(this._allowWrite, 'allowWrite')(eventName, fn);\n      }\n      allowEmit(eventName, fn) {\n        this.allow(this._allowEmit, 'allowEmit')(eventName, fn);\n      }\n      isAllowed(rules) {\n        return async (scope, eventName, args) => {\n          if (rules[eventName]) {\n            return rules[eventName].call(scope, eventName, ...args);\n          }\n          return rules.__all__.call(scope, eventName, ...args);\n        };\n      }\n      async isReadAllowed(scope, eventName, args) {\n        return this.isAllowed(this._allowRead)(scope, eventName, args);\n      }\n      async isEmitAllowed(scope, eventName) {\n        for (var _len = arguments.length, args = new Array(_len > 2 ? _len - 2 : 0), _key = 2; _key < _len; _key++) {\n          args[_key - 2] = arguments[_key];\n        }\n        return this.isAllowed(this._allowEmit)(scope, eventName, args);\n      }\n      async isWriteAllowed(scope, eventName, args) {\n        return this.isAllowed(this._allowWrite)(scope, eventName, args);\n      }\n      addSubscription(subscription, eventName) {\n        this.subscriptions.add(subscription);\n        const subByEventName = this.subscriptionsByEventName.get(eventName) || new Set();\n        subByEventName.add(subscription);\n        this.subscriptionsByEventName.set(eventName, subByEventName);\n      }\n      removeSubscription(subscription, eventName) {\n        this.subscriptions.delete(subscription);\n        const subByEventName = this.subscriptionsByEventName.get(eventName);\n        if (subByEventName) {\n          subByEventName.delete(subscription);\n        }\n      }\n      async _publish(publication, eventName) {\n        let options = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : false;\n        let useCollection;\n        let args = [];\n        if (typeof options === 'boolean') {\n          useCollection = options;\n        } else {\n          if (options.useCollection) {\n            useCollection = options.useCollection;\n          }\n          if (options.args) {\n            args = options.args;\n          }\n        }\n        if (eventName.length === 0) {\n          throw new MeteorError('invalid-event-name');\n        }\n        if ((await this.isReadAllowed(publication, eventName, args)) !== true) {\n          throw new MeteorError('not-allowed');\n        }\n        const subscription = {\n          subscription: publication,\n          eventName\n        };\n        this.addSubscription(subscription, eventName);\n        publication.onStop(() => {\n          this.removeSubscription(subscription, eventName);\n        });\n        // DDPStreamer doesn't have this\n        if (useCollection === true) {\n          // Collection compatibility\n          publication._session.sendAdded(this.subscriptionName, 'id', {\n            eventName\n          });\n        }\n        publication.ready();\n        super.emit('_afterPublish', this, publication, eventName, options);\n      }\n      iniPublication() {\n        const _publish = this._publish.bind(this);\n        this.registerPublication(this.subscriptionName, async function (eventName, options) {\n          return _publish(this, eventName, options);\n        });\n      }\n      initMethod() {\n        const isWriteAllowed = this.isWriteAllowed.bind(this);\n        const __emit = this.__emit.bind(this);\n        const _emit = this._emit.bind(this);\n        const {\n          retransmit\n        } = this;\n        const method = {\n          async [this.subscriptionName](eventName) {\n            for (var _len2 = arguments.length, args = new Array(_len2 > 1 ? _len2 - 1 : 0), _key2 = 1; _key2 < _len2; _key2++) {\n              args[_key2 - 1] = arguments[_key2];\n            }\n            if ((await isWriteAllowed(this, eventName, args)) !== true) {\n              return;\n            }\n            __emit(eventName, ...args);\n            if (retransmit === true) {\n              _emit(eventName, args, this.connection, true);\n            }\n          }\n        };\n        try {\n          this.registerMethod(method);\n        } catch (e) {\n          SystemLogger.error(e);\n        }\n      }\n      _emit(eventName, args, origin, broadcast, transform) {\n        if (broadcast === true) {\n          StreamerCentral.emit('broadcast', this.name, eventName, args);\n        }\n        const subscriptions = this.subscriptionsByEventName.get(eventName);\n        if (!(subscriptions !== null && subscriptions !== void 0 && subscriptions.size)) {\n          return false;\n        }\n        if (transform) {\n          void this.sendToManySubscriptions(subscriptions, origin, eventName, args, transform);\n          return true;\n        }\n        const msg = this.changedPayload(this.subscriptionName, 'id', {\n          eventName,\n          args\n        });\n        if (!msg) {\n          return false;\n        }\n        void this.sendToManySubscriptions(subscriptions, origin, eventName, args, msg);\n        return true;\n      }\n      async sendToManySubscriptions(subscriptions, origin, eventName, args, getMsg) {\n        subscriptions.forEach(async subscription => {\n          if (this.retransmitToSelf === false && origin && origin === subscription.subscription.connection) {\n            return;\n          }\n          const allowed = await this.isEmitAllowed(subscription.subscription, eventName, ...args);\n          if (allowed) {\n            const msg = typeof getMsg === 'string' ? getMsg : getMsg(this, subscription, eventName, args, allowed);\n            if (msg) {\n              var _subscription$subscri;\n              (_subscription$subscri = subscription.subscription._session.socket) === null || _subscription$subscri === void 0 ? void 0 : _subscription$subscri.send(msg);\n            }\n          }\n        });\n      }\n      emit(eventName) {\n        for (var _len3 = arguments.length, args = new Array(_len3 > 1 ? _len3 - 1 : 0), _key3 = 1; _key3 < _len3; _key3++) {\n          args[_key3 - 1] = arguments[_key3];\n        }\n        return this._emit(eventName, args, undefined, true);\n      }\n      __emit(eventName) {\n        for (var _len4 = arguments.length, args = new Array(_len4 > 1 ? _len4 - 1 : 0), _key4 = 1; _key4 < _len4; _key4++) {\n          args[_key4 - 1] = arguments[_key4];\n        }\n        return super.emit(eventName, ...args);\n      }\n      emitWithoutBroadcast(eventName) {\n        for (var _len5 = arguments.length, args = new Array(_len5 > 1 ? _len5 - 1 : 0), _key5 = 1; _key5 < _len5; _key5++) {\n          args[_key5 - 1] = arguments[_key5];\n        }\n        this._emit(eventName, args, undefined, false);\n      }\n    }\n    __reify_async_result__();\n  } catch (_reifyError) {\n    return __reify_async_result__(_reifyError);\n  }\n  __reify_async_result__()\n}, {\n  self: this,\n  async: false\n});","map":{"version":3,"names":["module","export","StreamerCentral","Streamer","MeteorError","link","v","EventEmitter","SystemLogger","__reifyWaitForDeps__","StreamerCentralClass","constructor","instances","name","retransmit","retransmitToSelf","arguments","length","undefined","subscriptions","Set","subscriptionsByEventName","Map","serverOnly","_allowRead","_allowWrite","_allowEmit","console","warn","iniPublication","initMethod","allowRead","allowEmit","allowWrite","subscriptionName","concat","allow","rules","eventName","fn","indexOf","error","Boolean","userId","isAllowed","scope","args","call","__all__","isReadAllowed","isEmitAllowed","_len","Array","_key","isWriteAllowed","addSubscription","subscription","add","subByEventName","get","set","removeSubscription","delete","_publish","publication","options","useCollection","onStop","_session","sendAdded","ready","emit","bind","registerPublication","__emit","_emit","method","_len2","_key2","connection","registerMethod","e","origin","broadcast","transform","size","sendToManySubscriptions","msg","changedPayload","getMsg","forEach","allowed","_subscription$subscri","socket","send","_len3","_key3","_len4","_key4","emitWithoutBroadcast","_len5","_key5","__reify_async_result__","_reifyError","self","async"],"sources":["server/modules/streamer/streamer.module.ts"],"sourcesContent":["import { MeteorError } from '@rocket.chat/core-services';\nimport type { StreamerEvents } from '@rocket.chat/ddp-client';\nimport { EventEmitter } from 'eventemitter3';\nimport type { IPublication, Rule, Connection, DDPSubscription, IStreamer, IRules, TransformMessage } from 'meteor/rocketchat:streamer';\n\nimport { SystemLogger } from '../../lib/logger/system';\n\nclass StreamerCentralClass<N extends keyof StreamerEvents> extends EventEmitter {\n\tpublic instances: Record<string, Streamer<N>> = {};\n\n\tconstructor() {\n\t\tsuper();\n\t}\n}\n\nexport const StreamerCentral = new StreamerCentralClass();\n\nexport abstract class Streamer<N extends keyof StreamerEvents> extends EventEmitter implements IStreamer<N> {\n\tpublic subscriptions = new Set<DDPSubscription>();\n\n\tprotected subscriptionsByEventName = new Map<string, Set<DDPSubscription>>();\n\n\tpublic retransmit = true;\n\n\tpublic retransmitToSelf = false;\n\n\tpublic serverOnly = false;\n\n\tprivate _allowRead: IRules = {};\n\n\tprivate _allowWrite: IRules = {};\n\n\tprivate _allowEmit: IRules = {};\n\n\tconstructor(\n\t\tpublic name: string,\n\t\t{ retransmit = true, retransmitToSelf = false }: { retransmit?: boolean; retransmitToSelf?: boolean } = {},\n\t) {\n\t\tsuper();\n\n\t\tif (StreamerCentral.instances[name]) {\n\t\t\tconsole.warn('Streamer instance already exists:', name);\n\t\t\treturn StreamerCentral.instances[name];\n\t\t}\n\n\t\tStreamerCentral.instances[name] = this;\n\n\t\tthis.retransmit = retransmit;\n\t\tthis.retransmitToSelf = retransmitToSelf;\n\n\t\tthis.iniPublication();\n\t\t// DDPStreamer doesn't have this\n\t\tthis.initMethod();\n\n\t\tthis.allowRead('none');\n\t\tthis.allowEmit('all');\n\t\tthis.allowWrite('none');\n\t}\n\n\tget subscriptionName(): string {\n\t\treturn `stream-${this.name}`;\n\t}\n\n\tprivate allow(rules: IRules, name: string) {\n\t\treturn (eventName: string | boolean | Rule, fn?: string | boolean | Rule): void => {\n\t\t\tif (fn === undefined) {\n\t\t\t\tfn = eventName;\n\t\t\t\teventName = '__all__';\n\t\t\t}\n\n\t\t\tif (typeof eventName !== 'string') {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tif (typeof fn === 'function') {\n\t\t\t\trules[eventName] = fn;\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tif (typeof fn === 'string' && ['all', 'none', 'logged'].indexOf(fn) === -1) {\n\t\t\t\tSystemLogger.error(`${name} shortcut '${fn}' is invalid`);\n\t\t\t}\n\n\t\t\tif (fn === 'all' || fn === true) {\n\t\t\t\trules[eventName] = async function (): Promise<boolean> {\n\t\t\t\t\treturn true;\n\t\t\t\t};\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tif (fn === 'none' || fn === false) {\n\t\t\t\trules[eventName] = async function (): Promise<boolean> {\n\t\t\t\t\treturn false;\n\t\t\t\t};\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tif (fn === 'logged') {\n\t\t\t\trules[eventName] = async function (): Promise<boolean> {\n\t\t\t\t\treturn Boolean(this.userId);\n\t\t\t\t};\n\t\t\t}\n\t\t};\n\t}\n\n\tallowRead(eventName: string | boolean | Rule, fn?: Rule | 'all' | 'none' | 'logged'): void {\n\t\tthis.allow(this._allowRead, 'allowRead')(eventName, fn);\n\t}\n\n\tallowWrite(eventName: string | boolean | Rule, fn?: Rule | 'all' | 'none' | 'logged'): void {\n\t\tthis.allow(this._allowWrite, 'allowWrite')(eventName, fn);\n\t}\n\n\tallowEmit(eventName: string | boolean | Rule, fn?: Rule | 'all' | 'none' | 'logged'): void {\n\t\tthis.allow(this._allowEmit, 'allowEmit')(eventName, fn);\n\t}\n\n\tprivate isAllowed(rules: IRules) {\n\t\treturn async (scope: IPublication, eventName: string, args: any): Promise<boolean | object> => {\n\t\t\tif (rules[eventName]) {\n\t\t\t\treturn rules[eventName].call(scope, eventName, ...args);\n\t\t\t}\n\n\t\t\treturn rules.__all__.call(scope, eventName, ...args);\n\t\t};\n\t}\n\n\tasync isReadAllowed(scope: IPublication, eventName: string, args: any): Promise<boolean | object> {\n\t\treturn this.isAllowed(this._allowRead)(scope, eventName, args);\n\t}\n\n\tasync isEmitAllowed(scope: IPublication, eventName: string, ...args: any[]): Promise<boolean | object> {\n\t\treturn this.isAllowed(this._allowEmit)(scope, eventName, args);\n\t}\n\n\tasync isWriteAllowed(scope: IPublication, eventName: string, args: any): Promise<boolean | object> {\n\t\treturn this.isAllowed(this._allowWrite)(scope, eventName, args);\n\t}\n\n\taddSubscription(subscription: DDPSubscription, eventName: string): void {\n\t\tthis.subscriptions.add(subscription);\n\n\t\tconst subByEventName = this.subscriptionsByEventName.get(eventName) || new Set();\n\t\tsubByEventName.add(subscription);\n\n\t\tthis.subscriptionsByEventName.set(eventName, subByEventName);\n\t}\n\n\tremoveSubscription(subscription: DDPSubscription, eventName: string): void {\n\t\tthis.subscriptions.delete(subscription);\n\n\t\tconst subByEventName = this.subscriptionsByEventName.get(eventName);\n\t\tif (subByEventName) {\n\t\t\tsubByEventName.delete(subscription);\n\t\t}\n\t}\n\n\tasync _publish(\n\t\tpublication: IPublication,\n\t\teventName: string,\n\t\toptions: boolean | { useCollection?: boolean; args?: any } = false,\n\t): Promise<void> {\n\t\tlet useCollection;\n\t\tlet args = [];\n\n\t\tif (typeof options === 'boolean') {\n\t\t\tuseCollection = options;\n\t\t} else {\n\t\t\tif (options.useCollection) {\n\t\t\t\tuseCollection = options.useCollection;\n\t\t\t}\n\n\t\t\tif (options.args) {\n\t\t\t\targs = options.args;\n\t\t\t}\n\t\t}\n\n\t\tif (eventName.length === 0) {\n\t\t\tthrow new MeteorError('invalid-event-name');\n\t\t}\n\n\t\tif ((await this.isReadAllowed(publication, eventName, args)) !== true) {\n\t\t\tthrow new MeteorError('not-allowed');\n\t\t}\n\n\t\tconst subscription = {\n\t\t\tsubscription: publication,\n\t\t\teventName,\n\t\t};\n\n\t\tthis.addSubscription(subscription, eventName);\n\n\t\tpublication.onStop(() => {\n\t\t\tthis.removeSubscription(subscription, eventName);\n\t\t});\n\n\t\t// DDPStreamer doesn't have this\n\t\tif (useCollection === true) {\n\t\t\t// Collection compatibility\n\t\t\tpublication._session.sendAdded(this.subscriptionName, 'id', {\n\t\t\t\teventName,\n\t\t\t});\n\t\t}\n\n\t\tpublication.ready();\n\n\t\tsuper.emit('_afterPublish', this, publication, eventName, options);\n\t}\n\n\tabstract registerPublication(\n\t\tname: string,\n\t\tfn: (eventName: string, options: boolean | { useCollection?: boolean; args?: any }) => Promise<void>,\n\t): void;\n\n\tiniPublication(): void {\n\t\tconst _publish = this._publish.bind(this);\n\t\tthis.registerPublication(\n\t\t\tthis.subscriptionName,\n\t\t\tasync function (this: IPublication, eventName: string, options: boolean | { useCollection?: boolean; args?: any }) {\n\t\t\t\treturn _publish(this, eventName, options);\n\t\t\t},\n\t\t);\n\t}\n\n\tabstract registerMethod(methods: Record<string, (eventName: string, ...args: any[]) => any>): void;\n\n\tinitMethod(): void {\n\t\tconst isWriteAllowed = this.isWriteAllowed.bind(this);\n\t\tconst __emit = this.__emit.bind(this);\n\t\tconst _emit = this._emit.bind(this);\n\t\tconst { retransmit } = this;\n\n\t\tconst method: Record<string, (eventName: string, ...args: any[]) => any> = {\n\t\t\tasync [this.subscriptionName](this: IPublication, eventName, ...args): Promise<void> {\n\t\t\t\tif ((await isWriteAllowed(this, eventName, args)) !== true) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\t__emit(eventName, ...args);\n\n\t\t\t\tif (retransmit === true) {\n\t\t\t\t\t_emit(eventName, args, this.connection, true);\n\t\t\t\t}\n\t\t\t},\n\t\t};\n\n\t\ttry {\n\t\t\tthis.registerMethod(method);\n\t\t} catch (e) {\n\t\t\tSystemLogger.error(e);\n\t\t}\n\t}\n\n\tabstract changedPayload(collection: string, id: string, fields: Record<string, any>): string | false;\n\n\t_emit(eventName: string, args: any[], origin: Connection | undefined, broadcast: boolean, transform?: TransformMessage): boolean {\n\t\tif (broadcast === true) {\n\t\t\tStreamerCentral.emit('broadcast', this.name, eventName, args);\n\t\t}\n\n\t\tconst subscriptions = this.subscriptionsByEventName.get(eventName);\n\t\tif (!subscriptions?.size) {\n\t\t\treturn false;\n\t\t}\n\n\t\tif (transform) {\n\t\t\tvoid this.sendToManySubscriptions(subscriptions, origin, eventName, args, transform);\n\n\t\t\treturn true;\n\t\t}\n\n\t\tconst msg = this.changedPayload(this.subscriptionName, 'id', {\n\t\t\teventName,\n\t\t\targs,\n\t\t});\n\n\t\tif (!msg) {\n\t\t\treturn false;\n\t\t}\n\n\t\tvoid this.sendToManySubscriptions(subscriptions, origin, eventName, args, msg);\n\n\t\treturn true;\n\t}\n\n\tasync sendToManySubscriptions(\n\t\tsubscriptions: Set<DDPSubscription>,\n\t\torigin: Connection | undefined,\n\t\teventName: string,\n\t\targs: any[],\n\t\tgetMsg: string | TransformMessage,\n\t): Promise<void> {\n\t\tsubscriptions.forEach(async (subscription) => {\n\t\t\tif (this.retransmitToSelf === false && origin && origin === subscription.subscription.connection) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconst allowed = await this.isEmitAllowed(subscription.subscription, eventName, ...args);\n\t\t\tif (allowed) {\n\t\t\t\tconst msg = typeof getMsg === 'string' ? getMsg : getMsg(this, subscription, eventName, args, allowed);\n\t\t\t\tif (msg) {\n\t\t\t\t\tsubscription.subscription._session.socket?.send(msg);\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\t}\n\n\temit(eventName: string | symbol, ...args: any[]): boolean {\n\t\treturn this._emit(eventName as string, args, undefined, true);\n\t}\n\n\t__emit(eventName: string, ...args: any[]): boolean {\n\t\treturn super.emit(eventName, ...args);\n\t}\n\n\temitWithoutBroadcast(eventName: string, ...args: any[]): void {\n\t\tthis._emit(eventName, args, undefined, false);\n\t}\n}\n"],"mappings":"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","ignoreList":[]},"sourceType":"module","externalDependencies":{},"hash":"309835d3e9fae02725a804d5b012ff39621f5255"}
