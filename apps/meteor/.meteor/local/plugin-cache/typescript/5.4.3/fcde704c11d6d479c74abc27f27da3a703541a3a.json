{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/app/livechat/server/lib/messages.ts","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","topLevelAwait","objectRestSpread","objectRestSpread","asyncGenerators","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"os.osx.arm64"},"sourceFileName":"app/livechat/server/lib/messages.ts","filename":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/app/livechat/server/lib/messages.ts","inputSourceMap":{"version":3,"file":"app/livechat/server/lib/messages.ts","sourceRoot":"","sources":["app/livechat/server/lib/messages.ts"],"names":[],"mappings":"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","sourcesContent":["import dns from 'dns';\nimport * as util from 'util';\n\nimport { LivechatDepartment } from '@rocket.chat/models';\n\nimport { callbacks } from '../../../../lib/callbacks';\nimport * as Mailer from '../../../mailer/server/api';\nimport { settings } from '../../../settings/server';\n\nconst dnsResolveMx = util.promisify(dns.resolveMx);\n\ntype OfflineMessageData = {\n\tmessage: string;\n\tname: string;\n\temail: string;\n\tdepartment?: string;\n\thost?: string;\n};\n\nexport async function sendOfflineMessage(data: OfflineMessageData) {\n\tif (!settings.get('Livechat_display_offline_form')) {\n\t\tthrow new Error('error-offline-form-disabled');\n\t}\n\n\tconst { message, name, email, department, host } = data;\n\n\tif (!email) {\n\t\tthrow new Error('error-invalid-email');\n\t}\n\n\tconst emailMessage = `${message}`.replace(/([^>\\r\\n]?)(\\r\\n|\\n\\r|\\r|\\n)/g, '$1<br>$2');\n\n\tlet html = '<h1>New livechat message</h1>';\n\tif (host && host !== '') {\n\t\thtml = html.concat(`<p><strong>Sent from:</strong><a href='${host}'> ${host}</a></p>`);\n\t}\n\thtml = html.concat(`\n\t\t\t<p><strong>Visitor name:</strong> ${name}</p>\n\t\t\t<p><strong>Visitor email:</strong> ${email}</p>\n\t\t\t<p><strong>Message:</strong><br>${emailMessage}</p>`);\n\n\tconst fromEmail = settings.get<string>('From_Email').match(/\\b[A-Z0-9._%+-]+@(?:[A-Z0-9-]+\\.)+[A-Z]{2,4}\\b/i);\n\n\tlet from: string;\n\tif (fromEmail) {\n\t\tfrom = fromEmail[0];\n\t} else {\n\t\tfrom = settings.get<string>('From_Email');\n\t}\n\n\tif (settings.get('Livechat_validate_offline_email')) {\n\t\tconst emailDomain = email.substr(email.lastIndexOf('@') + 1);\n\n\t\ttry {\n\t\t\tawait dnsResolveMx(emailDomain);\n\t\t} catch (e) {\n\t\t\tthrow new Meteor.Error('error-invalid-email-address');\n\t\t}\n\t}\n\n\t// TODO Block offline form if Livechat_offline_email is undefined\n\t// (it does not make sense to have an offline form that does nothing)\n\t// `this.sendEmail` will throw an error if the email is invalid\n\t// thus this breaks livechat, since the \"to\" email is invalid, and that returns an [invalid email] error to the livechat client\n\tlet emailTo = settings.get<string>('Livechat_offline_email');\n\tif (department && department !== '') {\n\t\tconst dep = await LivechatDepartment.findOneByIdOrName(department, { projection: { email: 1 } });\n\t\tif (dep) {\n\t\t\temailTo = dep.email || emailTo;\n\t\t}\n\t}\n\n\tconst fromText = `${name} - ${email} <${from}>`;\n\tconst replyTo = `${name} <${email}>`;\n\tconst subject = `Livechat offline message from ${name}: ${`${emailMessage}`.substring(0, 20)}`;\n\tawait sendEmail(fromText, emailTo, replyTo, subject, html);\n\n\tsetImmediate(() => {\n\t\tvoid callbacks.run('livechat.offlineMessage', data);\n\t});\n}\n\nasync function sendEmail(from: string, to: string, replyTo: string, subject: string, html: string): Promise<void> {\n\tawait Mailer.send({\n\t\tto,\n\t\tfrom,\n\t\treplyTo,\n\t\tsubject,\n\t\thtml,\n\t});\n}\n"]},"targets":{"android":"125.0.0","chrome":"125.0.0","edge":"125.0.0","firefox":"115.0.0","ie":"10.0.0","ios":"17.4.0","opera":"110.0.0","opera_mobile":"80.0.0","safari":"17.4.0","samsung":"24.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor","root":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":false,"enforceStrictMode":false,"dynamicImport":true,"generateLetDeclarations":true,"topLevelAwait":true},"externalDependencies":[]},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"version":"7.17.2","helpers":true,"useESModules":false,"corejs":false},"externalDependencies":[]},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-async-generator-functions","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-class-properties","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true},"externalDependencies":[]},{"key":"transform-react-jsx","visitor":{"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXFragment":{"exit":[null]},"JSXElement":{"exit":[null]},"JSXAttribute":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false},"externalDependencies":[]},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-nullish-coalescing-operator","visitor":{"LogicalExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-optional-chaining","visitor":{"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-optional-catch-binding","visitor":{"CatchClause":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-class-properties","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-async-generator-functions","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-logical-assignment-operators","visitor":{"AssignmentExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]}],"presets":[],"generatorOpts":{"filename":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/app/livechat/server/lib/messages.ts","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"app/livechat/server/lib/messages.ts","inputSourceMap":{"version":3,"file":"app/livechat/server/lib/messages.ts","sourceRoot":"","sources":["app/livechat/server/lib/messages.ts"],"names":[],"mappings":"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","sourcesContent":["import dns from 'dns';\nimport * as util from 'util';\n\nimport { LivechatDepartment } from '@rocket.chat/models';\n\nimport { callbacks } from '../../../../lib/callbacks';\nimport * as Mailer from '../../../mailer/server/api';\nimport { settings } from '../../../settings/server';\n\nconst dnsResolveMx = util.promisify(dns.resolveMx);\n\ntype OfflineMessageData = {\n\tmessage: string;\n\tname: string;\n\temail: string;\n\tdepartment?: string;\n\thost?: string;\n};\n\nexport async function sendOfflineMessage(data: OfflineMessageData) {\n\tif (!settings.get('Livechat_display_offline_form')) {\n\t\tthrow new Error('error-offline-form-disabled');\n\t}\n\n\tconst { message, name, email, department, host } = data;\n\n\tif (!email) {\n\t\tthrow new Error('error-invalid-email');\n\t}\n\n\tconst emailMessage = `${message}`.replace(/([^>\\r\\n]?)(\\r\\n|\\n\\r|\\r|\\n)/g, '$1<br>$2');\n\n\tlet html = '<h1>New livechat message</h1>';\n\tif (host && host !== '') {\n\t\thtml = html.concat(`<p><strong>Sent from:</strong><a href='${host}'> ${host}</a></p>`);\n\t}\n\thtml = html.concat(`\n\t\t\t<p><strong>Visitor name:</strong> ${name}</p>\n\t\t\t<p><strong>Visitor email:</strong> ${email}</p>\n\t\t\t<p><strong>Message:</strong><br>${emailMessage}</p>`);\n\n\tconst fromEmail = settings.get<string>('From_Email').match(/\\b[A-Z0-9._%+-]+@(?:[A-Z0-9-]+\\.)+[A-Z]{2,4}\\b/i);\n\n\tlet from: string;\n\tif (fromEmail) {\n\t\tfrom = fromEmail[0];\n\t} else {\n\t\tfrom = settings.get<string>('From_Email');\n\t}\n\n\tif (settings.get('Livechat_validate_offline_email')) {\n\t\tconst emailDomain = email.substr(email.lastIndexOf('@') + 1);\n\n\t\ttry {\n\t\t\tawait dnsResolveMx(emailDomain);\n\t\t} catch (e) {\n\t\t\tthrow new Meteor.Error('error-invalid-email-address');\n\t\t}\n\t}\n\n\t// TODO Block offline form if Livechat_offline_email is undefined\n\t// (it does not make sense to have an offline form that does nothing)\n\t// `this.sendEmail` will throw an error if the email is invalid\n\t// thus this breaks livechat, since the \"to\" email is invalid, and that returns an [invalid email] error to the livechat client\n\tlet emailTo = settings.get<string>('Livechat_offline_email');\n\tif (department && department !== '') {\n\t\tconst dep = await LivechatDepartment.findOneByIdOrName(department, { projection: { email: 1 } });\n\t\tif (dep) {\n\t\t\temailTo = dep.email || emailTo;\n\t\t}\n\t}\n\n\tconst fromText = `${name} - ${email} <${from}>`;\n\tconst replyTo = `${name} <${email}>`;\n\tconst subject = `Livechat offline message from ${name}: ${`${emailMessage}`.substring(0, 20)}`;\n\tawait sendEmail(fromText, emailTo, replyTo, subject, html);\n\n\tsetImmediate(() => {\n\t\tvoid callbacks.run('livechat.offlineMessage', data);\n\t});\n}\n\nasync function sendEmail(from: string, to: string, replyTo: string, subject: string, html: string): Promise<void> {\n\tawait Mailer.send({\n\t\tto,\n\t\tfrom,\n\t\treplyTo,\n\t\tsubject,\n\t\thtml,\n\t});\n}\n"]}}},"code":"!module.wrapAsync(async function (module, __reifyWaitForDeps__, __reify_async_result__) {\n  \"use strict\";\n  try {\n    module.export({\n      sendOfflineMessage: () => sendOfflineMessage\n    });\n    let dns;\n    module.link(\"dns\", {\n      default(v) {\n        dns = v;\n      }\n    }, 0);\n    let util;\n    module.link(\"util\", {\n      \"*\"(v) {\n        util = v;\n      }\n    }, 1);\n    let LivechatDepartment;\n    module.link(\"@rocket.chat/models\", {\n      LivechatDepartment(v) {\n        LivechatDepartment = v;\n      }\n    }, 2);\n    let callbacks;\n    module.link(\"../../../../lib/callbacks\", {\n      callbacks(v) {\n        callbacks = v;\n      }\n    }, 3);\n    let Mailer;\n    module.link(\"../../../mailer/server/api\", {\n      \"*\"(v) {\n        Mailer = v;\n      }\n    }, 4);\n    let settings;\n    module.link(\"../../../settings/server\", {\n      settings(v) {\n        settings = v;\n      }\n    }, 5);\n    if (__reifyWaitForDeps__()) (await __reifyWaitForDeps__())();\n    const dnsResolveMx = util.promisify(dns.resolveMx);\n    async function sendOfflineMessage(data) {\n      if (!settings.get('Livechat_display_offline_form')) {\n        throw new Error('error-offline-form-disabled');\n      }\n      const {\n        message,\n        name,\n        email,\n        department,\n        host\n      } = data;\n      if (!email) {\n        throw new Error('error-invalid-email');\n      }\n      const emailMessage = \"\".concat(message).replace(/([^>\\r\\n]?)(\\r\\n|\\n\\r|\\r|\\n)/g, '$1<br>$2');\n      let html = '<h1>New livechat message</h1>';\n      if (host && host !== '') {\n        html = html.concat(\"<p><strong>Sent from:</strong><a href='\".concat(host, \"'> \").concat(host, \"</a></p>\"));\n      }\n      html = html.concat(\"\\n\\t\\t\\t<p><strong>Visitor name:</strong> \".concat(name, \"</p>\\n\\t\\t\\t<p><strong>Visitor email:</strong> \").concat(email, \"</p>\\n\\t\\t\\t<p><strong>Message:</strong><br>\").concat(emailMessage, \"</p>\"));\n      const fromEmail = settings.get('From_Email').match(/\\b[A-Z0-9._%+-]+@(?:[A-Z0-9-]+\\.)+[A-Z]{2,4}\\b/i);\n      let from;\n      if (fromEmail) {\n        from = fromEmail[0];\n      } else {\n        from = settings.get('From_Email');\n      }\n      if (settings.get('Livechat_validate_offline_email')) {\n        const emailDomain = email.substr(email.lastIndexOf('@') + 1);\n        try {\n          await dnsResolveMx(emailDomain);\n        } catch (e) {\n          throw new Meteor.Error('error-invalid-email-address');\n        }\n      }\n      // TODO Block offline form if Livechat_offline_email is undefined\n      // (it does not make sense to have an offline form that does nothing)\n      // `this.sendEmail` will throw an error if the email is invalid\n      // thus this breaks livechat, since the \"to\" email is invalid, and that returns an [invalid email] error to the livechat client\n      let emailTo = settings.get('Livechat_offline_email');\n      if (department && department !== '') {\n        const dep = await LivechatDepartment.findOneByIdOrName(department, {\n          projection: {\n            email: 1\n          }\n        });\n        if (dep) {\n          emailTo = dep.email || emailTo;\n        }\n      }\n      const fromText = \"\".concat(name, \" - \").concat(email, \" <\").concat(from, \">\");\n      const replyTo = \"\".concat(name, \" <\").concat(email, \">\");\n      const subject = \"Livechat offline message from \".concat(name, \": \").concat(\"\".concat(emailMessage).substring(0, 20));\n      await sendEmail(fromText, emailTo, replyTo, subject, html);\n      setImmediate(() => {\n        void callbacks.run('livechat.offlineMessage', data);\n      });\n    }\n    async function sendEmail(from, to, replyTo, subject, html) {\n      await Mailer.send({\n        to,\n        from,\n        replyTo,\n        subject,\n        html\n      });\n    }\n    __reify_async_result__();\n  } catch (_reifyError) {\n    return __reify_async_result__(_reifyError);\n  }\n  __reify_async_result__()\n}, {\n  self: this,\n  async: false\n});","map":{"version":3,"names":["module","export","sendOfflineMessage","dns","link","default","v","util","*","LivechatDepartment","callbacks","Mailer","settings","__reifyWaitForDeps__","dnsResolveMx","promisify","resolveMx","data","get","Error","message","name","email","department","host","emailMessage","concat","replace","html","fromEmail","match","from","emailDomain","substr","lastIndexOf","e","Meteor","emailTo","dep","findOneByIdOrName","projection","fromText","replyTo","subject","substring","sendEmail","setImmediate","run","to","send","__reify_async_result__","_reifyError","self","async"],"sources":["app/livechat/server/lib/messages.ts"],"sourcesContent":["import dns from 'dns';\nimport * as util from 'util';\n\nimport { LivechatDepartment } from '@rocket.chat/models';\n\nimport { callbacks } from '../../../../lib/callbacks';\nimport * as Mailer from '../../../mailer/server/api';\nimport { settings } from '../../../settings/server';\n\nconst dnsResolveMx = util.promisify(dns.resolveMx);\n\ntype OfflineMessageData = {\n\tmessage: string;\n\tname: string;\n\temail: string;\n\tdepartment?: string;\n\thost?: string;\n};\n\nexport async function sendOfflineMessage(data: OfflineMessageData) {\n\tif (!settings.get('Livechat_display_offline_form')) {\n\t\tthrow new Error('error-offline-form-disabled');\n\t}\n\n\tconst { message, name, email, department, host } = data;\n\n\tif (!email) {\n\t\tthrow new Error('error-invalid-email');\n\t}\n\n\tconst emailMessage = `${message}`.replace(/([^>\\r\\n]?)(\\r\\n|\\n\\r|\\r|\\n)/g, '$1<br>$2');\n\n\tlet html = '<h1>New livechat message</h1>';\n\tif (host && host !== '') {\n\t\thtml = html.concat(`<p><strong>Sent from:</strong><a href='${host}'> ${host}</a></p>`);\n\t}\n\thtml = html.concat(`\n\t\t\t<p><strong>Visitor name:</strong> ${name}</p>\n\t\t\t<p><strong>Visitor email:</strong> ${email}</p>\n\t\t\t<p><strong>Message:</strong><br>${emailMessage}</p>`);\n\n\tconst fromEmail = settings.get<string>('From_Email').match(/\\b[A-Z0-9._%+-]+@(?:[A-Z0-9-]+\\.)+[A-Z]{2,4}\\b/i);\n\n\tlet from: string;\n\tif (fromEmail) {\n\t\tfrom = fromEmail[0];\n\t} else {\n\t\tfrom = settings.get<string>('From_Email');\n\t}\n\n\tif (settings.get('Livechat_validate_offline_email')) {\n\t\tconst emailDomain = email.substr(email.lastIndexOf('@') + 1);\n\n\t\ttry {\n\t\t\tawait dnsResolveMx(emailDomain);\n\t\t} catch (e) {\n\t\t\tthrow new Meteor.Error('error-invalid-email-address');\n\t\t}\n\t}\n\n\t// TODO Block offline form if Livechat_offline_email is undefined\n\t// (it does not make sense to have an offline form that does nothing)\n\t// `this.sendEmail` will throw an error if the email is invalid\n\t// thus this breaks livechat, since the \"to\" email is invalid, and that returns an [invalid email] error to the livechat client\n\tlet emailTo = settings.get<string>('Livechat_offline_email');\n\tif (department && department !== '') {\n\t\tconst dep = await LivechatDepartment.findOneByIdOrName(department, { projection: { email: 1 } });\n\t\tif (dep) {\n\t\t\temailTo = dep.email || emailTo;\n\t\t}\n\t}\n\n\tconst fromText = `${name} - ${email} <${from}>`;\n\tconst replyTo = `${name} <${email}>`;\n\tconst subject = `Livechat offline message from ${name}: ${`${emailMessage}`.substring(0, 20)}`;\n\tawait sendEmail(fromText, emailTo, replyTo, subject, html);\n\n\tsetImmediate(() => {\n\t\tvoid callbacks.run('livechat.offlineMessage', data);\n\t});\n}\n\nasync function sendEmail(from: string, to: string, replyTo: string, subject: string, html: string): Promise<void> {\n\tawait Mailer.send({\n\t\tto,\n\t\tfrom,\n\t\treplyTo,\n\t\tsubject,\n\t\thtml,\n\t});\n}\n"],"mappings":"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","ignoreList":[]},"sourceType":"module","externalDependencies":{},"hash":"fcde704c11d6d479c74abc27f27da3a703541a3a"}
