{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/app/apps/server/bridges/oauthApps.ts","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","topLevelAwait","objectRestSpread","objectRestSpread","asyncGenerators","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"os.osx.arm64"},"sourceFileName":"app/apps/server/bridges/oauthApps.ts","filename":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/app/apps/server/bridges/oauthApps.ts","inputSourceMap":{"version":3,"file":"app/apps/server/bridges/oauthApps.ts","sourceRoot":"","sources":["app/apps/server/bridges/oauthApps.ts"],"names":[],"mappings":"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","sourcesContent":["import type { IAppServerOrchestrator } from '@rocket.chat/apps';\nimport type { IOAuthApp, IOAuthAppParams } from '@rocket.chat/apps-engine/definition/accessors/IOAuthApp';\nimport { OAuthAppsBridge } from '@rocket.chat/apps-engine/server/bridges/OAuthAppsBridge';\nimport type { IOAuthApps } from '@rocket.chat/core-typings';\nimport { OAuthApps, Users } from '@rocket.chat/models';\nimport { Random } from '@rocket.chat/random';\nimport { v4 as uuidv4 } from 'uuid';\n\nexport class AppOAuthAppsBridge extends OAuthAppsBridge {\n\tconstructor(private readonly orch: IAppServerOrchestrator) {\n\t\tsuper();\n\t}\n\n\tprotected async create(oAuthApp: IOAuthAppParams, appId: string): Promise<string | null> {\n\t\tthis.orch.debugLog(`The App ${appId} is creating a new OAuth app.`);\n\t\tconst { clientId, clientSecret } = oAuthApp;\n\t\tconst botUser = await Users.findOne({ appId });\n\n\t\tif (!botUser) {\n\t\t\tthrow new Error(`The user for app ${appId} is not registered.`);\n\t\t}\n\n\t\tconst { _id, username } = botUser;\n\n\t\treturn (\n\t\t\tawait OAuthApps.insertOne({\n\t\t\t\t...oAuthApp,\n\t\t\t\t_id: uuidv4(),\n\t\t\t\tappId,\n\t\t\t\tclientId: clientId ?? Random.id(),\n\t\t\t\tclientSecret: clientSecret ?? Random.secret(),\n\t\t\t\t_createdAt: new Date(),\n\t\t\t\t_createdBy: {\n\t\t\t\t\t_id,\n\t\t\t\t\tusername,\n\t\t\t\t},\n\t\t\t} as unknown as IOAuthApps)\n\t\t).insertedId;\n\t}\n\n\tprotected async getById(id: string, appId: string): Promise<IOAuthApp | null> {\n\t\tthis.orch.debugLog(`The App ${appId} is getting the OAuth app by ID ${id}.`);\n\t\tconst data = await OAuthApps.findOne({ _id: id, appId });\n\t\tif (data) {\n\t\t\tconst { _id, _createdAt, _createdBy, _updatedAt, ...rest } = data as any;\n\t\t\treturn {\n\t\t\t\t...rest,\n\t\t\t\tid: _id,\n\t\t\t\tcreatedAt: _createdAt.toDateString(),\n\t\t\t\tcreatedBy: {\n\t\t\t\t\tid: _createdBy._id,\n\t\t\t\t\tusername: _createdBy.username,\n\t\t\t\t},\n\t\t\t\tupdatedAt: _updatedAt,\n\t\t\t};\n\t\t}\n\n\t\treturn null;\n\t}\n\n\tprotected async getByName(name: string, appId: string): Promise<Array<IOAuthApp>> {\n\t\tthis.orch.debugLog(`The App ${appId} is getting the OAuth apps by name.`);\n\t\treturn OAuthApps.find({ name, appId }).toArray() as unknown as Array<IOAuthApp>;\n\t}\n\n\tprotected async update(oAuthApp: IOAuthAppParams, id: string, appId: string): Promise<void> {\n\t\tthis.orch.debugLog(`The App ${appId} is updating the OAuth app ${id}.`);\n\t\tawait OAuthApps.updateOne({ _id: id, appId }, { $set: oAuthApp }, { upsert: true });\n\t}\n\n\tprotected async delete(id: string, appId: string): Promise<void> {\n\t\tthis.orch.debugLog(`The App ${appId} is deleting the OAuth app ${id}.`);\n\t\tawait OAuthApps.deleteOne({ _id: id, appId });\n\t}\n\n\tprotected async purge(appId: string): Promise<void> {\n\t\tthis.orch.debugLog(`The App ${appId} is deleting an OAuth app.`);\n\t\tawait OAuthApps.deleteMany({ appId });\n\t}\n}\n"]},"targets":{"android":"125.0.0","chrome":"125.0.0","edge":"125.0.0","firefox":"115.0.0","ie":"10.0.0","ios":"17.4.0","opera":"110.0.0","opera_mobile":"80.0.0","safari":"17.4.0","samsung":"24.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor","root":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":false,"enforceStrictMode":false,"dynamicImport":true,"generateLetDeclarations":true,"topLevelAwait":true},"externalDependencies":[]},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"version":"7.17.2","helpers":true,"useESModules":false,"corejs":false},"externalDependencies":[]},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-async-generator-functions","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-class-properties","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true},"externalDependencies":[]},{"key":"transform-react-jsx","visitor":{"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXFragment":{"exit":[null]},"JSXElement":{"exit":[null]},"JSXAttribute":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false},"externalDependencies":[]},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-nullish-coalescing-operator","visitor":{"LogicalExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-optional-chaining","visitor":{"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-optional-catch-binding","visitor":{"CatchClause":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-class-properties","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-async-generator-functions","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-logical-assignment-operators","visitor":{"AssignmentExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]}],"presets":[],"generatorOpts":{"filename":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/app/apps/server/bridges/oauthApps.ts","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"app/apps/server/bridges/oauthApps.ts","inputSourceMap":{"version":3,"file":"app/apps/server/bridges/oauthApps.ts","sourceRoot":"","sources":["app/apps/server/bridges/oauthApps.ts"],"names":[],"mappings":"AAEA,OAAO,EAAE,eAAe,EAAE,MAAM,yDAAyD,CAAC;AAE1F,OAAO,EAAE,SAAS,EAAE,KAAK,EAAE,MAAM,qBAAqB,CAAC;AACvD,OAAO,EAAE,MAAM,EAAE,MAAM,qBAAqB,CAAC;AAC7C,OAAO,EAAE,EAAE,IAAI,MAAM,EAAE,MAAM,MAAM,CAAC;AAEpC,MAAM,OAAO,kBAAmB,SAAQ,eAAe;IACzB;IAA7B,YAA6B,IAA4B;QACxD,KAAK,EAAE,CAAC;QADoB,SAAI,GAAJ,IAAI,CAAwB;IAEzD,CAAC;IAES,KAAK,CAAC,MAAM,CAAC,QAAyB,EAAE,KAAa;QAC9D,IAAI,CAAC,IAAI,CAAC,QAAQ,CAAC,WAAW,KAAK,+BAA+B,CAAC,CAAC;QACpE,MAAM,EAAE,QAAQ,EAAE,YAAY,EAAE,GAAG,QAAQ,CAAC;QAC5C,MAAM,OAAO,GAAG,MAAM,KAAK,CAAC,OAAO,CAAC,EAAE,KAAK,EAAE,CAAC,CAAC;QAE/C,IAAI,CAAC,OAAO,EAAE,CAAC;YACd,MAAM,IAAI,KAAK,CAAC,oBAAoB,KAAK,qBAAqB,CAAC,CAAC;QACjE,CAAC;QAED,MAAM,EAAE,GAAG,EAAE,QAAQ,EAAE,GAAG,OAAO,CAAC;QAElC,OAAO,CACN,MAAM,SAAS,CAAC,SAAS,CAAC;YACzB,GAAG,QAAQ;YACX,GAAG,EAAE,MAAM,EAAE;YACb,KAAK;YACL,QAAQ,EAAE,QAAQ,IAAI,MAAM,CAAC,EAAE,EAAE;YACjC,YAAY,EAAE,YAAY,IAAI,MAAM,CAAC,MAAM,EAAE;YAC7C,UAAU,EAAE,IAAI,IAAI,EAAE;YACtB,UAAU,EAAE;gBACX,GAAG;gBACH,QAAQ;aACR;SACwB,CAAC,CAC3B,CAAC,UAAU,CAAC;IACd,CAAC;IAES,KAAK,CAAC,OAAO,CAAC,EAAU,EAAE,KAAa;QAChD,IAAI,CAAC,IAAI,CAAC,QAAQ,CAAC,WAAW,KAAK,mCAAmC,EAAE,GAAG,CAAC,CAAC;QAC7E,MAAM,IAAI,GAAG,MAAM,SAAS,CAAC,OAAO,CAAC,EAAE,GAAG,EAAE,EAAE,EAAE,KAAK,EAAE,CAAC,CAAC;QACzD,IAAI,IAAI,EAAE,CAAC;YACV,MAAM,EAAE,GAAG,EAAE,UAAU,EAAE,UAAU,EAAE,UAAU,EAAE,GAAG,IAAI,EAAE,GAAG,IAAW,CAAC;YACzE,OAAO;gBACN,GAAG,IAAI;gBACP,EAAE,EAAE,GAAG;gBACP,SAAS,EAAE,UAAU,CAAC,YAAY,EAAE;gBACpC,SAAS,EAAE;oBACV,EAAE,EAAE,UAAU,CAAC,GAAG;oBAClB,QAAQ,EAAE,UAAU,CAAC,QAAQ;iBAC7B;gBACD,SAAS,EAAE,UAAU;aACrB,CAAC;QACH,CAAC;QAED,OAAO,IAAI,CAAC;IACb,CAAC;IAES,KAAK,CAAC,SAAS,CAAC,IAAY,EAAE,KAAa;QACpD,IAAI,CAAC,IAAI,CAAC,QAAQ,CAAC,WAAW,KAAK,qCAAqC,CAAC,CAAC;QAC1E,OAAO,SAAS,CAAC,IAAI,CAAC,EAAE,IAAI,EAAE,KAAK,EAAE,CAAC,CAAC,OAAO,EAAiC,CAAC;IACjF,CAAC;IAES,KAAK,CAAC,MAAM,CAAC,QAAyB,EAAE,EAAU,EAAE,KAAa;QAC1E,IAAI,CAAC,IAAI,CAAC,QAAQ,CAAC,WAAW,KAAK,8BAA8B,EAAE,GAAG,CAAC,CAAC;QACxE,MAAM,SAAS,CAAC,SAAS,CAAC,EAAE,GAAG,EAAE,EAAE,EAAE,KAAK,EAAE,EAAE,EAAE,IAAI,EAAE,QAAQ,EAAE,EAAE,EAAE,MAAM,EAAE,IAAI,EAAE,CAAC,CAAC;IACrF,CAAC;IAES,KAAK,CAAC,MAAM,CAAC,EAAU,EAAE,KAAa;QAC/C,IAAI,CAAC,IAAI,CAAC,QAAQ,CAAC,WAAW,KAAK,8BAA8B,EAAE,GAAG,CAAC,CAAC;QACxE,MAAM,SAAS,CAAC,SAAS,CAAC,EAAE,GAAG,EAAE,EAAE,EAAE,KAAK,EAAE,CAAC,CAAC;IAC/C,CAAC;IAES,KAAK,CAAC,KAAK,CAAC,KAAa;QAClC,IAAI,CAAC,IAAI,CAAC,QAAQ,CAAC,WAAW,KAAK,4BAA4B,CAAC,CAAC;QACjE,MAAM,SAAS,CAAC,UAAU,CAAC,EAAE,KAAK,EAAE,CAAC,CAAC;IACvC,CAAC;CACD","sourcesContent":["import type { IAppServerOrchestrator } from '@rocket.chat/apps';\nimport type { IOAuthApp, IOAuthAppParams } from '@rocket.chat/apps-engine/definition/accessors/IOAuthApp';\nimport { OAuthAppsBridge } from '@rocket.chat/apps-engine/server/bridges/OAuthAppsBridge';\nimport type { IOAuthApps } from '@rocket.chat/core-typings';\nimport { OAuthApps, Users } from '@rocket.chat/models';\nimport { Random } from '@rocket.chat/random';\nimport { v4 as uuidv4 } from 'uuid';\n\nexport class AppOAuthAppsBridge extends OAuthAppsBridge {\n\tconstructor(private readonly orch: IAppServerOrchestrator) {\n\t\tsuper();\n\t}\n\n\tprotected async create(oAuthApp: IOAuthAppParams, appId: string): Promise<string | null> {\n\t\tthis.orch.debugLog(`The App ${appId} is creating a new OAuth app.`);\n\t\tconst { clientId, clientSecret } = oAuthApp;\n\t\tconst botUser = await Users.findOne({ appId });\n\n\t\tif (!botUser) {\n\t\t\tthrow new Error(`The user for app ${appId} is not registered.`);\n\t\t}\n\n\t\tconst { _id, username } = botUser;\n\n\t\treturn (\n\t\t\tawait OAuthApps.insertOne({\n\t\t\t\t...oAuthApp,\n\t\t\t\t_id: uuidv4(),\n\t\t\t\tappId,\n\t\t\t\tclientId: clientId ?? Random.id(),\n\t\t\t\tclientSecret: clientSecret ?? Random.secret(),\n\t\t\t\t_createdAt: new Date(),\n\t\t\t\t_createdBy: {\n\t\t\t\t\t_id,\n\t\t\t\t\tusername,\n\t\t\t\t},\n\t\t\t} as unknown as IOAuthApps)\n\t\t).insertedId;\n\t}\n\n\tprotected async getById(id: string, appId: string): Promise<IOAuthApp | null> {\n\t\tthis.orch.debugLog(`The App ${appId} is getting the OAuth app by ID ${id}.`);\n\t\tconst data = await OAuthApps.findOne({ _id: id, appId });\n\t\tif (data) {\n\t\t\tconst { _id, _createdAt, _createdBy, _updatedAt, ...rest } = data as any;\n\t\t\treturn {\n\t\t\t\t...rest,\n\t\t\t\tid: _id,\n\t\t\t\tcreatedAt: _createdAt.toDateString(),\n\t\t\t\tcreatedBy: {\n\t\t\t\t\tid: _createdBy._id,\n\t\t\t\t\tusername: _createdBy.username,\n\t\t\t\t},\n\t\t\t\tupdatedAt: _updatedAt,\n\t\t\t};\n\t\t}\n\n\t\treturn null;\n\t}\n\n\tprotected async getByName(name: string, appId: string): Promise<Array<IOAuthApp>> {\n\t\tthis.orch.debugLog(`The App ${appId} is getting the OAuth apps by name.`);\n\t\treturn OAuthApps.find({ name, appId }).toArray() as unknown as Array<IOAuthApp>;\n\t}\n\n\tprotected async update(oAuthApp: IOAuthAppParams, id: string, appId: string): Promise<void> {\n\t\tthis.orch.debugLog(`The App ${appId} is updating the OAuth app ${id}.`);\n\t\tawait OAuthApps.updateOne({ _id: id, appId }, { $set: oAuthApp }, { upsert: true });\n\t}\n\n\tprotected async delete(id: string, appId: string): Promise<void> {\n\t\tthis.orch.debugLog(`The App ${appId} is deleting the OAuth app ${id}.`);\n\t\tawait OAuthApps.deleteOne({ _id: id, appId });\n\t}\n\n\tprotected async purge(appId: string): Promise<void> {\n\t\tthis.orch.debugLog(`The App ${appId} is deleting an OAuth app.`);\n\t\tawait OAuthApps.deleteMany({ appId });\n\t}\n}\n"]}}},"code":"!module.wrapAsync(async function (module, __reifyWaitForDeps__, __reify_async_result__) {\n  \"use strict\";\n  try {\n    let _objectWithoutProperties;\n    module.link(\"@babel/runtime/helpers/objectWithoutProperties\", {\n      default(v) {\n        _objectWithoutProperties = v;\n      }\n    }, 0);\n    let _objectSpread;\n    module.link(\"@babel/runtime/helpers/objectSpread2\", {\n      default(v) {\n        _objectSpread = v;\n      }\n    }, 1);\n    const _excluded = [\"_id\", \"_createdAt\", \"_createdBy\", \"_updatedAt\"];\n    module.export({\n      AppOAuthAppsBridge: () => AppOAuthAppsBridge\n    });\n    let OAuthAppsBridge;\n    module.link(\"@rocket.chat/apps-engine/server/bridges/OAuthAppsBridge\", {\n      OAuthAppsBridge(v) {\n        OAuthAppsBridge = v;\n      }\n    }, 0);\n    let OAuthApps, Users;\n    module.link(\"@rocket.chat/models\", {\n      OAuthApps(v) {\n        OAuthApps = v;\n      },\n      Users(v) {\n        Users = v;\n      }\n    }, 1);\n    let Random;\n    module.link(\"@rocket.chat/random\", {\n      Random(v) {\n        Random = v;\n      }\n    }, 2);\n    let uuidv4;\n    module.link(\"uuid\", {\n      v4(v) {\n        uuidv4 = v;\n      }\n    }, 3);\n    if (__reifyWaitForDeps__()) (await __reifyWaitForDeps__())();\n    class AppOAuthAppsBridge extends OAuthAppsBridge {\n      constructor(orch) {\n        super();\n        this.orch = void 0;\n        this.orch = orch;\n      }\n      async create(oAuthApp, appId) {\n        this.orch.debugLog(\"The App \".concat(appId, \" is creating a new OAuth app.\"));\n        const {\n          clientId,\n          clientSecret\n        } = oAuthApp;\n        const botUser = await Users.findOne({\n          appId\n        });\n        if (!botUser) {\n          throw new Error(\"The user for app \".concat(appId, \" is not registered.\"));\n        }\n        const {\n          _id,\n          username\n        } = botUser;\n        return (await OAuthApps.insertOne(_objectSpread(_objectSpread({}, oAuthApp), {}, {\n          _id: uuidv4(),\n          appId,\n          clientId: clientId !== null && clientId !== void 0 ? clientId : Random.id(),\n          clientSecret: clientSecret !== null && clientSecret !== void 0 ? clientSecret : Random.secret(),\n          _createdAt: new Date(),\n          _createdBy: {\n            _id,\n            username\n          }\n        }))).insertedId;\n      }\n      async getById(id, appId) {\n        this.orch.debugLog(\"The App \".concat(appId, \" is getting the OAuth app by ID \").concat(id, \".\"));\n        const data = await OAuthApps.findOne({\n          _id: id,\n          appId\n        });\n        if (data) {\n          const {\n              _id,\n              _createdAt,\n              _createdBy,\n              _updatedAt\n            } = data,\n            rest = _objectWithoutProperties(data, _excluded);\n          return _objectSpread(_objectSpread({}, rest), {}, {\n            id: _id,\n            createdAt: _createdAt.toDateString(),\n            createdBy: {\n              id: _createdBy._id,\n              username: _createdBy.username\n            },\n            updatedAt: _updatedAt\n          });\n        }\n        return null;\n      }\n      async getByName(name, appId) {\n        this.orch.debugLog(\"The App \".concat(appId, \" is getting the OAuth apps by name.\"));\n        return OAuthApps.find({\n          name,\n          appId\n        }).toArray();\n      }\n      async update(oAuthApp, id, appId) {\n        this.orch.debugLog(\"The App \".concat(appId, \" is updating the OAuth app \").concat(id, \".\"));\n        await OAuthApps.updateOne({\n          _id: id,\n          appId\n        }, {\n          $set: oAuthApp\n        }, {\n          upsert: true\n        });\n      }\n      async delete(id, appId) {\n        this.orch.debugLog(\"The App \".concat(appId, \" is deleting the OAuth app \").concat(id, \".\"));\n        await OAuthApps.deleteOne({\n          _id: id,\n          appId\n        });\n      }\n      async purge(appId) {\n        this.orch.debugLog(\"The App \".concat(appId, \" is deleting an OAuth app.\"));\n        await OAuthApps.deleteMany({\n          appId\n        });\n      }\n    }\n    __reify_async_result__();\n  } catch (_reifyError) {\n    return __reify_async_result__(_reifyError);\n  }\n  __reify_async_result__()\n}, {\n  self: this,\n  async: false\n});","map":{"version":3,"names":["_objectWithoutProperties","module","link","default","v","_objectSpread","_excluded","export","AppOAuthAppsBridge","OAuthAppsBridge","OAuthApps","Users","Random","uuidv4","v4","__reifyWaitForDeps__","constructor","orch","create","oAuthApp","appId","debugLog","concat","clientId","clientSecret","botUser","findOne","Error","_id","username","insertOne","id","secret","_createdAt","Date","_createdBy","insertedId","getById","data","_updatedAt","rest","createdAt","toDateString","createdBy","updatedAt","getByName","name","find","toArray","update","updateOne","$set","upsert","delete","deleteOne","purge","deleteMany","__reify_async_result__","_reifyError","self","async"],"sources":["app/apps/server/bridges/oauthApps.ts"],"sourcesContent":["import type { IAppServerOrchestrator } from '@rocket.chat/apps';\nimport type { IOAuthApp, IOAuthAppParams } from '@rocket.chat/apps-engine/definition/accessors/IOAuthApp';\nimport { OAuthAppsBridge } from '@rocket.chat/apps-engine/server/bridges/OAuthAppsBridge';\nimport type { IOAuthApps } from '@rocket.chat/core-typings';\nimport { OAuthApps, Users } from '@rocket.chat/models';\nimport { Random } from '@rocket.chat/random';\nimport { v4 as uuidv4 } from 'uuid';\n\nexport class AppOAuthAppsBridge extends OAuthAppsBridge {\n\tconstructor(private readonly orch: IAppServerOrchestrator) {\n\t\tsuper();\n\t}\n\n\tprotected async create(oAuthApp: IOAuthAppParams, appId: string): Promise<string | null> {\n\t\tthis.orch.debugLog(`The App ${appId} is creating a new OAuth app.`);\n\t\tconst { clientId, clientSecret } = oAuthApp;\n\t\tconst botUser = await Users.findOne({ appId });\n\n\t\tif (!botUser) {\n\t\t\tthrow new Error(`The user for app ${appId} is not registered.`);\n\t\t}\n\n\t\tconst { _id, username } = botUser;\n\n\t\treturn (\n\t\t\tawait OAuthApps.insertOne({\n\t\t\t\t...oAuthApp,\n\t\t\t\t_id: uuidv4(),\n\t\t\t\tappId,\n\t\t\t\tclientId: clientId ?? Random.id(),\n\t\t\t\tclientSecret: clientSecret ?? Random.secret(),\n\t\t\t\t_createdAt: new Date(),\n\t\t\t\t_createdBy: {\n\t\t\t\t\t_id,\n\t\t\t\t\tusername,\n\t\t\t\t},\n\t\t\t} as unknown as IOAuthApps)\n\t\t).insertedId;\n\t}\n\n\tprotected async getById(id: string, appId: string): Promise<IOAuthApp | null> {\n\t\tthis.orch.debugLog(`The App ${appId} is getting the OAuth app by ID ${id}.`);\n\t\tconst data = await OAuthApps.findOne({ _id: id, appId });\n\t\tif (data) {\n\t\t\tconst { _id, _createdAt, _createdBy, _updatedAt, ...rest } = data as any;\n\t\t\treturn {\n\t\t\t\t...rest,\n\t\t\t\tid: _id,\n\t\t\t\tcreatedAt: _createdAt.toDateString(),\n\t\t\t\tcreatedBy: {\n\t\t\t\t\tid: _createdBy._id,\n\t\t\t\t\tusername: _createdBy.username,\n\t\t\t\t},\n\t\t\t\tupdatedAt: _updatedAt,\n\t\t\t};\n\t\t}\n\n\t\treturn null;\n\t}\n\n\tprotected async getByName(name: string, appId: string): Promise<Array<IOAuthApp>> {\n\t\tthis.orch.debugLog(`The App ${appId} is getting the OAuth apps by name.`);\n\t\treturn OAuthApps.find({ name, appId }).toArray() as unknown as Array<IOAuthApp>;\n\t}\n\n\tprotected async update(oAuthApp: IOAuthAppParams, id: string, appId: string): Promise<void> {\n\t\tthis.orch.debugLog(`The App ${appId} is updating the OAuth app ${id}.`);\n\t\tawait OAuthApps.updateOne({ _id: id, appId }, { $set: oAuthApp }, { upsert: true });\n\t}\n\n\tprotected async delete(id: string, appId: string): Promise<void> {\n\t\tthis.orch.debugLog(`The App ${appId} is deleting the OAuth app ${id}.`);\n\t\tawait OAuthApps.deleteOne({ _id: id, appId });\n\t}\n\n\tprotected async purge(appId: string): Promise<void> {\n\t\tthis.orch.debugLog(`The App ${appId} is deleting an OAuth app.`);\n\t\tawait OAuthApps.deleteMany({ appId });\n\t}\n}\n"],"mappings":";;;IAEA,IAAAA,wBAA0B;IAAAC,MAAM,CAAAC,IAAA,iDAAyD,EAAC;MAAAC,QAAAC,CAAA;QAAAJ,wBAAA,GAAAI,CAAA;MAAA;IAAA;IAAA,IAAAC,aAAA;IAAAJ,MAAA,CAAAC,IAAA;MAAAC,QAAAC,CAAA;QAAAC,aAAA,GAAAD,CAAA;MAAA;IAAA;IAAA,MAAAE,SAAA;IAA1FL,MAAA,CAAOM,MAAE;MAAAC,kBAAuB,EAAAA,CAAA,KAAAA;IAAA;IAAA,IAAAC,eAAA;IAAAR,MAAA,CAAAC,IAA0D;MAAAO,gBAAAL,CAAA;QAAAK,eAAA,GAAAL,CAAA;MAAA;IAAA;IAAA,IAAAM,SAAA,EAAAC,KAAA;IAAAV,MAAA,CAAAC,IAAA;MAAAQ,UAAAN,CAAA;QAAAM,SAAA,GAAAN,CAAA;MAAA;MAAAO,MAAAP,CAAA;QAAAO,KAAA,GAAAP,CAAA;MAAA;IAAA;IAAA,IAAAQ,MAAA;IAAAX,MAAA,CAAAC,IAAA;MAAAU,OAAAR,CAAA;QAAAQ,MAAA,GAAAR,CAAA;MAAA;IAAA;IAAA,IAAAS,MAAA;IAAAZ,MAAA,CAAAC,IAAA;MAAAY,GAAAV,CAAA;QAAAS,MAAA,GAAAT,CAAA;MAAA;IAAA;IAAA,IAAAW,oBAAA,WAAAA,oBAAA;IAMpF,MAAOP,kBAAmB,SAAQC,eAAe;MACtDO,YAA6BC,IAA4B;QACxD,KAAK,EAAE;QAAC,KADoBA,IAAA;QAAA,KAAAA,IAAI,GAAJA,IAAI;MAEjC;MAEU,MAAMC,MAAMA,CAACC,QAAyB,EAAEC,KAAa;QAC9D,IAAI,CAACH,IAAI,CAACI,QAAQ,YAAAC,MAAA,CAAYF,KAAK,kCAA+B,CAAC;QACnE,MAAM;UAAEG,QAAQ;UAAEC;QAAY,CAAE,GAAGL,QAAQ;QAC3C,MAAMM,OAAO,GAAG,MAAMd,KAAK,CAACe,OAAO,CAAC;UAAEN;QAAK,CAAE,CAAC;QAE9C,IAAI,CAACK,OAAO,EAAE;UACb,MAAM,IAAIE,KAAK,qBAAAL,MAAA,CAAqBF,KAAK,wBAAqB,CAAC;QAChE;QAEA,MAAM;UAAEQ,GAAG;UAAEC;QAAQ,CAAE,GAAGJ,OAAO;QAEjC,OAAO,CACN,MAAMf,SAAS,CAACoB,SAAS,CAAAzB,aAAA,CAAAA,aAAA,KACrBc,QAAQ;UACXS,GAAG,EAAEf,MAAM,EAAE;UACbO,KAAK;UACLG,QAAQ,EAAEA,QAAQ,aAARA,QAAQ,cAARA,QAAQ,GAAIX,MAAM,CAACmB,EAAE,EAAE;UACjCP,YAAY,EAAEA,YAAY,aAAZA,YAAY,cAAZA,YAAY,GAAIZ,MAAM,CAACoB,MAAM,EAAE;UAC7CC,UAAU,EAAE,IAAIC,IAAI,EAAE;UACtBC,UAAU,EAAE;YACXP,GAAG;YACHC;;QACA,EACwB,CAAC,EAC1BO,UAAU;MACb;MAEU,MAAMC,OAAOA,CAACN,EAAU,EAAEX,KAAa;QAChD,IAAI,CAACH,IAAI,CAACI,QAAQ,YAAAC,MAAA,CAAYF,KAAK,sCAAAE,MAAA,CAAmCS,EAAE,MAAG,CAAC;QAC5E,MAAMO,IAAI,GAAG,MAAM5B,SAAS,CAACgB,OAAO,CAAC;UAAEE,GAAG,EAAEG,EAAE;UAAEX;QAAK,CAAE,CAAC;QACxD,IAAIkB,IAAI,EAAE;UACT,MAAM;cAAEV,GAAG;cAAEK,UAAU;cAAEE,UAAU;cAAEI;YAAmB,CAAE,GAAGD,IAAW;YAApBE,IAAI,GAAAxC,wBAAA,CAAKsC,IAAW,EAAAhC,SAAA;UACxE,OAAAD,aAAA,CAAAA,aAAA,KACImC,IAAI;YACPT,EAAE,EAAEH,GAAG;YACPa,SAAS,EAAER,UAAU,CAACS,YAAY,EAAE;YACpCC,SAAS,EAAE;cACVZ,EAAE,EAAEI,UAAU,CAACP,GAAG;cAClBC,QAAQ,EAAEM,UAAU,CAACN;aACrB;YACDe,SAAS,EAAEL;UAAU;QAEvB;QAEA,OAAO,IAAI;MACZ;MAEU,MAAMM,SAASA,CAACC,IAAY,EAAE1B,KAAa;QACpD,IAAI,CAACH,IAAI,CAACI,QAAQ,YAAAC,MAAA,CAAYF,KAAK,wCAAqC,CAAC;QACzE,OAAOV,SAAS,CAACqC,IAAI,CAAC;UAAED,IAAI;UAAE1B;QAAK,CAAE,CAAC,CAAC4B,OAAO,EAAiC;MAChF;MAEU,MAAMC,MAAMA,CAAC9B,QAAyB,EAAEY,EAAU,EAAEX,KAAa;QAC1E,IAAI,CAACH,IAAI,CAACI,QAAQ,YAAAC,MAAA,CAAYF,KAAK,iCAAAE,MAAA,CAA8BS,EAAE,MAAG,CAAC;QACvE,MAAMrB,SAAS,CAACwC,SAAS,CAAC;UAAEtB,GAAG,EAAEG,EAAE;UAAEX;QAAK,CAAE,EAAE;UAAE+B,IAAI,EAAEhC;QAAQ,CAAE,EAAE;UAAEiC,MAAM,EAAE;QAAI,CAAE,CAAC;MACpF;MAEU,MAAMC,MAAMA,CAACtB,EAAU,EAAEX,KAAa;QAC/C,IAAI,CAACH,IAAI,CAACI,QAAQ,YAAAC,MAAA,CAAYF,KAAK,iCAAAE,MAAA,CAA8BS,EAAE,MAAG,CAAC;QACvE,MAAMrB,SAAS,CAAC4C,SAAS,CAAC;UAAE1B,GAAG,EAAEG,EAAE;UAAEX;QAAK,CAAE,CAAC;MAC9C;MAEU,MAAMmC,KAAKA,CAACnC,KAAa;QAClC,IAAI,CAACH,IAAI,CAACI,QAAQ,YAAAC,MAAA,CAAYF,KAAK,+BAA4B,CAAC;QAChE,MAAMV,SAAS,CAAC8C,UAAU,CAAC;UAAEpC;QAAK,CAAE,CAAC;MACtC;;IACAqC,sBAAA;EAAA,SAAAC,WAAA;IAAA,OAAAD,sBAAA,CAAAC,WAAA;EAAA;EAAAD,sBAAA;AAAA;EAAAE,IAAA;EAAAC,KAAA;AAAA","ignoreList":[]},"sourceType":"module","externalDependencies":{},"hash":"b29669687213637a4b86ac0ba0188867d713a153"}
