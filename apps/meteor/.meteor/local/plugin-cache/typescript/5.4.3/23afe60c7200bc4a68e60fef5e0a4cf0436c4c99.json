{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/ee/app/livechat-enterprise/server/api/rooms.ts","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","topLevelAwait","objectRestSpread","objectRestSpread","asyncGenerators","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"os.osx.arm64"},"sourceFileName":"ee/app/livechat-enterprise/server/api/rooms.ts","filename":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/ee/app/livechat-enterprise/server/api/rooms.ts","inputSourceMap":{"version":3,"file":"ee/app/livechat-enterprise/server/api/rooms.ts","sourceRoot":"","sources":["ee/app/livechat-enterprise/server/api/rooms.ts"],"names":[],"mappings":"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","sourcesContent":["import { OmnichannelEEService } from '@rocket.chat/core-services';\nimport type { IOmnichannelRoom } from '@rocket.chat/core-typings';\nimport { LivechatRooms, Subscriptions } from '@rocket.chat/models';\nimport { isLivechatRoomOnHoldProps, isLivechatRoomResumeOnHoldProps, isPOSTLivechatRoomPriorityParams } from '@rocket.chat/rest-typings';\n\nimport { API } from '../../../../../app/api/server';\nimport { hasPermissionAsync } from '../../../../../app/authorization/server/functions/hasPermission';\nimport { i18n } from '../../../../../server/lib/i18n';\nimport { removePriorityFromRoom, updateRoomPriority } from './lib/priorities';\n\nAPI.v1.addRoute(\n\t'livechat/room.onHold',\n\t{ authRequired: true, permissionsRequired: ['on-hold-livechat-room'], validateParams: isLivechatRoomOnHoldProps },\n\t{\n\t\tasync post() {\n\t\t\tconst { roomId } = this.bodyParams;\n\n\t\t\ttype Room = Pick<IOmnichannelRoom, '_id' | 't' | 'open' | 'onHold' | 'u' | 'lastMessage' | 'servedBy'>;\n\n\t\t\tconst room = await LivechatRooms.findOneById<Room>(roomId, {\n\t\t\t\tprojection: { _id: 1, t: 1, open: 1, onHold: 1, u: 1, lastMessage: 1, servedBy: 1 },\n\t\t\t});\n\t\t\tif (!room) {\n\t\t\t\tthrow new Error('error-invalid-room');\n\t\t\t}\n\n\t\t\tconst subscription = await Subscriptions.findOneByRoomIdAndUserId(roomId, this.userId, { projection: { _id: 1 } });\n\t\t\tif (!subscription && !(await hasPermissionAsync(this.userId, 'on-hold-others-livechat-room'))) {\n\t\t\t\tthrow new Error('Not_authorized');\n\t\t\t}\n\n\t\t\tconst onHoldBy = { _id: this.userId, username: this.user.username, name: this.user.name };\n\t\t\tconst comment = i18n.t('Omnichannel_On_Hold_manually', {\n\t\t\t\tuser: onHoldBy.name || `@${onHoldBy.username}`,\n\t\t\t});\n\n\t\t\tawait OmnichannelEEService.placeRoomOnHold(room, comment, this.user);\n\n\t\t\treturn API.v1.success();\n\t\t},\n\t},\n);\n\nAPI.v1.addRoute(\n\t'livechat/room.resumeOnHold',\n\t{ authRequired: true, permissionsRequired: ['view-l-room'], validateParams: isLivechatRoomResumeOnHoldProps },\n\t{\n\t\tasync post() {\n\t\t\tconst { roomId } = this.bodyParams;\n\t\t\tif (!roomId || roomId.trim() === '') {\n\t\t\t\tthrow new Error('invalid-param');\n\t\t\t}\n\n\t\t\ttype Room = Pick<IOmnichannelRoom, '_id' | 't' | 'open' | 'onHold' | 'servedBy' | 'u' | 'lastMessage'>;\n\n\t\t\tconst room = await LivechatRooms.findOneById<Room>(roomId, {\n\t\t\t\tprojection: { t: 1, open: 1, onHold: 1, servedBy: 1 },\n\t\t\t});\n\t\t\tif (!room) {\n\t\t\t\tthrow new Error('error-invalid-room');\n\t\t\t}\n\n\t\t\tconst subscription = await Subscriptions.findOneByRoomIdAndUserId(roomId, this.userId, { projection: { _id: 1 } });\n\t\t\tif (!subscription && !(await hasPermissionAsync(this.userId, 'on-hold-others-livechat-room'))) {\n\t\t\t\tthrow new Error('Not_authorized');\n\t\t\t}\n\n\t\t\tconst { name, username, _id: userId } = this.user;\n\t\t\tconst onHoldBy = { _id: userId, username, name };\n\t\t\tconst comment = i18n.t('Omnichannel_on_hold_chat_resumed_manually', {\n\t\t\t\tuser: onHoldBy.name || `@${onHoldBy.username}`,\n\t\t\t});\n\n\t\t\tawait OmnichannelEEService.resumeRoomOnHold(room, comment, this.user, true);\n\n\t\t\treturn API.v1.success();\n\t\t},\n\t},\n);\n\nAPI.v1.addRoute(\n\t'livechat/room/:rid/priority',\n\t{\n\t\tauthRequired: true,\n\t\tvalidateParams: { POST: isPOSTLivechatRoomPriorityParams },\n\t\tpermissionsRequired: {\n\t\t\tPOST: { permissions: ['view-l-room'], operation: 'hasAny' },\n\t\t\tDELETE: { permissions: ['view-l-room'], operation: 'hasAny' },\n\t\t},\n\t},\n\t{\n\t\tasync post() {\n\t\t\tconst { rid } = this.urlParams;\n\t\t\tconst { priorityId } = this.bodyParams;\n\n\t\t\tif (!this.user.username) {\n\t\t\t\treturn API.v1.failure('Invalid user');\n\t\t\t}\n\n\t\t\tawait updateRoomPriority(\n\t\t\t\trid,\n\t\t\t\t{\n\t\t\t\t\t_id: this.user._id,\n\t\t\t\t\tname: this.user.name || '',\n\t\t\t\t\tusername: this.user.username,\n\t\t\t\t},\n\t\t\t\tpriorityId,\n\t\t\t);\n\n\t\t\treturn API.v1.success();\n\t\t},\n\t\tasync delete() {\n\t\t\tconst { rid } = this.urlParams;\n\n\t\t\tif (!this.user.username) {\n\t\t\t\treturn API.v1.failure('Invalid user');\n\t\t\t}\n\n\t\t\tawait removePriorityFromRoom(rid, {\n\t\t\t\t_id: this.user._id,\n\t\t\t\tname: this.user.name || '',\n\t\t\t\tusername: this.user.username,\n\t\t\t});\n\n\t\t\treturn API.v1.success();\n\t\t},\n\t},\n);\n"]},"targets":{"android":"125.0.0","chrome":"125.0.0","edge":"125.0.0","firefox":"115.0.0","ie":"10.0.0","ios":"17.4.0","opera":"110.0.0","opera_mobile":"80.0.0","safari":"17.4.0","samsung":"24.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor","root":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":false,"enforceStrictMode":false,"dynamicImport":true,"generateLetDeclarations":true,"topLevelAwait":true},"externalDependencies":[]},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"version":"7.17.2","helpers":true,"useESModules":false,"corejs":false},"externalDependencies":[]},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-async-generator-functions","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-class-properties","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true},"externalDependencies":[]},{"key":"transform-react-jsx","visitor":{"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXFragment":{"exit":[null]},"JSXElement":{"exit":[null]},"JSXAttribute":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false},"externalDependencies":[]},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-nullish-coalescing-operator","visitor":{"LogicalExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-optional-chaining","visitor":{"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-optional-catch-binding","visitor":{"CatchClause":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-class-properties","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-async-generator-functions","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-logical-assignment-operators","visitor":{"AssignmentExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]}],"presets":[],"generatorOpts":{"filename":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/ee/app/livechat-enterprise/server/api/rooms.ts","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"ee/app/livechat-enterprise/server/api/rooms.ts","inputSourceMap":{"version":3,"file":"ee/app/livechat-enterprise/server/api/rooms.ts","sourceRoot":"","sources":["ee/app/livechat-enterprise/server/api/rooms.ts"],"names":[],"mappings":"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","sourcesContent":["import { OmnichannelEEService } from '@rocket.chat/core-services';\nimport type { IOmnichannelRoom } from '@rocket.chat/core-typings';\nimport { LivechatRooms, Subscriptions } from '@rocket.chat/models';\nimport { isLivechatRoomOnHoldProps, isLivechatRoomResumeOnHoldProps, isPOSTLivechatRoomPriorityParams } from '@rocket.chat/rest-typings';\n\nimport { API } from '../../../../../app/api/server';\nimport { hasPermissionAsync } from '../../../../../app/authorization/server/functions/hasPermission';\nimport { i18n } from '../../../../../server/lib/i18n';\nimport { removePriorityFromRoom, updateRoomPriority } from './lib/priorities';\n\nAPI.v1.addRoute(\n\t'livechat/room.onHold',\n\t{ authRequired: true, permissionsRequired: ['on-hold-livechat-room'], validateParams: isLivechatRoomOnHoldProps },\n\t{\n\t\tasync post() {\n\t\t\tconst { roomId } = this.bodyParams;\n\n\t\t\ttype Room = Pick<IOmnichannelRoom, '_id' | 't' | 'open' | 'onHold' | 'u' | 'lastMessage' | 'servedBy'>;\n\n\t\t\tconst room = await LivechatRooms.findOneById<Room>(roomId, {\n\t\t\t\tprojection: { _id: 1, t: 1, open: 1, onHold: 1, u: 1, lastMessage: 1, servedBy: 1 },\n\t\t\t});\n\t\t\tif (!room) {\n\t\t\t\tthrow new Error('error-invalid-room');\n\t\t\t}\n\n\t\t\tconst subscription = await Subscriptions.findOneByRoomIdAndUserId(roomId, this.userId, { projection: { _id: 1 } });\n\t\t\tif (!subscription && !(await hasPermissionAsync(this.userId, 'on-hold-others-livechat-room'))) {\n\t\t\t\tthrow new Error('Not_authorized');\n\t\t\t}\n\n\t\t\tconst onHoldBy = { _id: this.userId, username: this.user.username, name: this.user.name };\n\t\t\tconst comment = i18n.t('Omnichannel_On_Hold_manually', {\n\t\t\t\tuser: onHoldBy.name || `@${onHoldBy.username}`,\n\t\t\t});\n\n\t\t\tawait OmnichannelEEService.placeRoomOnHold(room, comment, this.user);\n\n\t\t\treturn API.v1.success();\n\t\t},\n\t},\n);\n\nAPI.v1.addRoute(\n\t'livechat/room.resumeOnHold',\n\t{ authRequired: true, permissionsRequired: ['view-l-room'], validateParams: isLivechatRoomResumeOnHoldProps },\n\t{\n\t\tasync post() {\n\t\t\tconst { roomId } = this.bodyParams;\n\t\t\tif (!roomId || roomId.trim() === '') {\n\t\t\t\tthrow new Error('invalid-param');\n\t\t\t}\n\n\t\t\ttype Room = Pick<IOmnichannelRoom, '_id' | 't' | 'open' | 'onHold' | 'servedBy' | 'u' | 'lastMessage'>;\n\n\t\t\tconst room = await LivechatRooms.findOneById<Room>(roomId, {\n\t\t\t\tprojection: { t: 1, open: 1, onHold: 1, servedBy: 1 },\n\t\t\t});\n\t\t\tif (!room) {\n\t\t\t\tthrow new Error('error-invalid-room');\n\t\t\t}\n\n\t\t\tconst subscription = await Subscriptions.findOneByRoomIdAndUserId(roomId, this.userId, { projection: { _id: 1 } });\n\t\t\tif (!subscription && !(await hasPermissionAsync(this.userId, 'on-hold-others-livechat-room'))) {\n\t\t\t\tthrow new Error('Not_authorized');\n\t\t\t}\n\n\t\t\tconst { name, username, _id: userId } = this.user;\n\t\t\tconst onHoldBy = { _id: userId, username, name };\n\t\t\tconst comment = i18n.t('Omnichannel_on_hold_chat_resumed_manually', {\n\t\t\t\tuser: onHoldBy.name || `@${onHoldBy.username}`,\n\t\t\t});\n\n\t\t\tawait OmnichannelEEService.resumeRoomOnHold(room, comment, this.user, true);\n\n\t\t\treturn API.v1.success();\n\t\t},\n\t},\n);\n\nAPI.v1.addRoute(\n\t'livechat/room/:rid/priority',\n\t{\n\t\tauthRequired: true,\n\t\tvalidateParams: { POST: isPOSTLivechatRoomPriorityParams },\n\t\tpermissionsRequired: {\n\t\t\tPOST: { permissions: ['view-l-room'], operation: 'hasAny' },\n\t\t\tDELETE: { permissions: ['view-l-room'], operation: 'hasAny' },\n\t\t},\n\t},\n\t{\n\t\tasync post() {\n\t\t\tconst { rid } = this.urlParams;\n\t\t\tconst { priorityId } = this.bodyParams;\n\n\t\t\tif (!this.user.username) {\n\t\t\t\treturn API.v1.failure('Invalid user');\n\t\t\t}\n\n\t\t\tawait updateRoomPriority(\n\t\t\t\trid,\n\t\t\t\t{\n\t\t\t\t\t_id: this.user._id,\n\t\t\t\t\tname: this.user.name || '',\n\t\t\t\t\tusername: this.user.username,\n\t\t\t\t},\n\t\t\t\tpriorityId,\n\t\t\t);\n\n\t\t\treturn API.v1.success();\n\t\t},\n\t\tasync delete() {\n\t\t\tconst { rid } = this.urlParams;\n\n\t\t\tif (!this.user.username) {\n\t\t\t\treturn API.v1.failure('Invalid user');\n\t\t\t}\n\n\t\t\tawait removePriorityFromRoom(rid, {\n\t\t\t\t_id: this.user._id,\n\t\t\t\tname: this.user.name || '',\n\t\t\t\tusername: this.user.username,\n\t\t\t});\n\n\t\t\treturn API.v1.success();\n\t\t},\n\t},\n);\n"]}}},"code":"!module.wrapAsync(async function (module, __reifyWaitForDeps__, __reify_async_result__) {\n  \"use strict\";\n  try {\n    let OmnichannelEEService;\n    module.link(\"@rocket.chat/core-services\", {\n      OmnichannelEEService(v) {\n        OmnichannelEEService = v;\n      }\n    }, 0);\n    let LivechatRooms, Subscriptions;\n    module.link(\"@rocket.chat/models\", {\n      LivechatRooms(v) {\n        LivechatRooms = v;\n      },\n      Subscriptions(v) {\n        Subscriptions = v;\n      }\n    }, 1);\n    let isLivechatRoomOnHoldProps, isLivechatRoomResumeOnHoldProps, isPOSTLivechatRoomPriorityParams;\n    module.link(\"@rocket.chat/rest-typings\", {\n      isLivechatRoomOnHoldProps(v) {\n        isLivechatRoomOnHoldProps = v;\n      },\n      isLivechatRoomResumeOnHoldProps(v) {\n        isLivechatRoomResumeOnHoldProps = v;\n      },\n      isPOSTLivechatRoomPriorityParams(v) {\n        isPOSTLivechatRoomPriorityParams = v;\n      }\n    }, 2);\n    let API;\n    module.link(\"../../../../../app/api/server\", {\n      API(v) {\n        API = v;\n      }\n    }, 3);\n    let hasPermissionAsync;\n    module.link(\"../../../../../app/authorization/server/functions/hasPermission\", {\n      hasPermissionAsync(v) {\n        hasPermissionAsync = v;\n      }\n    }, 4);\n    let i18n;\n    module.link(\"../../../../../server/lib/i18n\", {\n      i18n(v) {\n        i18n = v;\n      }\n    }, 5);\n    let removePriorityFromRoom, updateRoomPriority;\n    module.link(\"./lib/priorities\", {\n      removePriorityFromRoom(v) {\n        removePriorityFromRoom = v;\n      },\n      updateRoomPriority(v) {\n        updateRoomPriority = v;\n      }\n    }, 6);\n    if (__reifyWaitForDeps__()) (await __reifyWaitForDeps__())();\n    API.v1.addRoute('livechat/room.onHold', {\n      authRequired: true,\n      permissionsRequired: ['on-hold-livechat-room'],\n      validateParams: isLivechatRoomOnHoldProps\n    }, {\n      async post() {\n        const {\n          roomId\n        } = this.bodyParams;\n        const room = await LivechatRooms.findOneById(roomId, {\n          projection: {\n            _id: 1,\n            t: 1,\n            open: 1,\n            onHold: 1,\n            u: 1,\n            lastMessage: 1,\n            servedBy: 1\n          }\n        });\n        if (!room) {\n          throw new Error('error-invalid-room');\n        }\n        const subscription = await Subscriptions.findOneByRoomIdAndUserId(roomId, this.userId, {\n          projection: {\n            _id: 1\n          }\n        });\n        if (!subscription && !(await hasPermissionAsync(this.userId, 'on-hold-others-livechat-room'))) {\n          throw new Error('Not_authorized');\n        }\n        const onHoldBy = {\n          _id: this.userId,\n          username: this.user.username,\n          name: this.user.name\n        };\n        const comment = i18n.t('Omnichannel_On_Hold_manually', {\n          user: onHoldBy.name || \"@\".concat(onHoldBy.username)\n        });\n        await OmnichannelEEService.placeRoomOnHold(room, comment, this.user);\n        return API.v1.success();\n      }\n    });\n    API.v1.addRoute('livechat/room.resumeOnHold', {\n      authRequired: true,\n      permissionsRequired: ['view-l-room'],\n      validateParams: isLivechatRoomResumeOnHoldProps\n    }, {\n      async post() {\n        const {\n          roomId\n        } = this.bodyParams;\n        if (!roomId || roomId.trim() === '') {\n          throw new Error('invalid-param');\n        }\n        const room = await LivechatRooms.findOneById(roomId, {\n          projection: {\n            t: 1,\n            open: 1,\n            onHold: 1,\n            servedBy: 1\n          }\n        });\n        if (!room) {\n          throw new Error('error-invalid-room');\n        }\n        const subscription = await Subscriptions.findOneByRoomIdAndUserId(roomId, this.userId, {\n          projection: {\n            _id: 1\n          }\n        });\n        if (!subscription && !(await hasPermissionAsync(this.userId, 'on-hold-others-livechat-room'))) {\n          throw new Error('Not_authorized');\n        }\n        const {\n          name,\n          username,\n          _id: userId\n        } = this.user;\n        const onHoldBy = {\n          _id: userId,\n          username,\n          name\n        };\n        const comment = i18n.t('Omnichannel_on_hold_chat_resumed_manually', {\n          user: onHoldBy.name || \"@\".concat(onHoldBy.username)\n        });\n        await OmnichannelEEService.resumeRoomOnHold(room, comment, this.user, true);\n        return API.v1.success();\n      }\n    });\n    API.v1.addRoute('livechat/room/:rid/priority', {\n      authRequired: true,\n      validateParams: {\n        POST: isPOSTLivechatRoomPriorityParams\n      },\n      permissionsRequired: {\n        POST: {\n          permissions: ['view-l-room'],\n          operation: 'hasAny'\n        },\n        DELETE: {\n          permissions: ['view-l-room'],\n          operation: 'hasAny'\n        }\n      }\n    }, {\n      async post() {\n        const {\n          rid\n        } = this.urlParams;\n        const {\n          priorityId\n        } = this.bodyParams;\n        if (!this.user.username) {\n          return API.v1.failure('Invalid user');\n        }\n        await updateRoomPriority(rid, {\n          _id: this.user._id,\n          name: this.user.name || '',\n          username: this.user.username\n        }, priorityId);\n        return API.v1.success();\n      },\n      async delete() {\n        const {\n          rid\n        } = this.urlParams;\n        if (!this.user.username) {\n          return API.v1.failure('Invalid user');\n        }\n        await removePriorityFromRoom(rid, {\n          _id: this.user._id,\n          name: this.user.name || '',\n          username: this.user.username\n        });\n        return API.v1.success();\n      }\n    });\n    __reify_async_result__();\n  } catch (_reifyError) {\n    return __reify_async_result__(_reifyError);\n  }\n  __reify_async_result__()\n}, {\n  self: this,\n  async: false\n});","map":{"version":3,"names":["OmnichannelEEService","module","link","v","LivechatRooms","Subscriptions","isLivechatRoomOnHoldProps","isLivechatRoomResumeOnHoldProps","isPOSTLivechatRoomPriorityParams","API","hasPermissionAsync","i18n","removePriorityFromRoom","updateRoomPriority","__reifyWaitForDeps__","v1","addRoute","authRequired","permissionsRequired","validateParams","post","roomId","bodyParams","room","findOneById","projection","_id","t","open","onHold","u","lastMessage","servedBy","Error","subscription","findOneByRoomIdAndUserId","userId","onHoldBy","username","user","name","comment","concat","placeRoomOnHold","success","trim","resumeRoomOnHold","POST","permissions","operation","DELETE","rid","urlParams","priorityId","failure","delete","__reify_async_result__","_reifyError","self","async"],"sources":["ee/app/livechat-enterprise/server/api/rooms.ts"],"sourcesContent":["import { OmnichannelEEService } from '@rocket.chat/core-services';\nimport type { IOmnichannelRoom } from '@rocket.chat/core-typings';\nimport { LivechatRooms, Subscriptions } from '@rocket.chat/models';\nimport { isLivechatRoomOnHoldProps, isLivechatRoomResumeOnHoldProps, isPOSTLivechatRoomPriorityParams } from '@rocket.chat/rest-typings';\n\nimport { API } from '../../../../../app/api/server';\nimport { hasPermissionAsync } from '../../../../../app/authorization/server/functions/hasPermission';\nimport { i18n } from '../../../../../server/lib/i18n';\nimport { removePriorityFromRoom, updateRoomPriority } from './lib/priorities';\n\nAPI.v1.addRoute(\n\t'livechat/room.onHold',\n\t{ authRequired: true, permissionsRequired: ['on-hold-livechat-room'], validateParams: isLivechatRoomOnHoldProps },\n\t{\n\t\tasync post() {\n\t\t\tconst { roomId } = this.bodyParams;\n\n\t\t\ttype Room = Pick<IOmnichannelRoom, '_id' | 't' | 'open' | 'onHold' | 'u' | 'lastMessage' | 'servedBy'>;\n\n\t\t\tconst room = await LivechatRooms.findOneById<Room>(roomId, {\n\t\t\t\tprojection: { _id: 1, t: 1, open: 1, onHold: 1, u: 1, lastMessage: 1, servedBy: 1 },\n\t\t\t});\n\t\t\tif (!room) {\n\t\t\t\tthrow new Error('error-invalid-room');\n\t\t\t}\n\n\t\t\tconst subscription = await Subscriptions.findOneByRoomIdAndUserId(roomId, this.userId, { projection: { _id: 1 } });\n\t\t\tif (!subscription && !(await hasPermissionAsync(this.userId, 'on-hold-others-livechat-room'))) {\n\t\t\t\tthrow new Error('Not_authorized');\n\t\t\t}\n\n\t\t\tconst onHoldBy = { _id: this.userId, username: this.user.username, name: this.user.name };\n\t\t\tconst comment = i18n.t('Omnichannel_On_Hold_manually', {\n\t\t\t\tuser: onHoldBy.name || `@${onHoldBy.username}`,\n\t\t\t});\n\n\t\t\tawait OmnichannelEEService.placeRoomOnHold(room, comment, this.user);\n\n\t\t\treturn API.v1.success();\n\t\t},\n\t},\n);\n\nAPI.v1.addRoute(\n\t'livechat/room.resumeOnHold',\n\t{ authRequired: true, permissionsRequired: ['view-l-room'], validateParams: isLivechatRoomResumeOnHoldProps },\n\t{\n\t\tasync post() {\n\t\t\tconst { roomId } = this.bodyParams;\n\t\t\tif (!roomId || roomId.trim() === '') {\n\t\t\t\tthrow new Error('invalid-param');\n\t\t\t}\n\n\t\t\ttype Room = Pick<IOmnichannelRoom, '_id' | 't' | 'open' | 'onHold' | 'servedBy' | 'u' | 'lastMessage'>;\n\n\t\t\tconst room = await LivechatRooms.findOneById<Room>(roomId, {\n\t\t\t\tprojection: { t: 1, open: 1, onHold: 1, servedBy: 1 },\n\t\t\t});\n\t\t\tif (!room) {\n\t\t\t\tthrow new Error('error-invalid-room');\n\t\t\t}\n\n\t\t\tconst subscription = await Subscriptions.findOneByRoomIdAndUserId(roomId, this.userId, { projection: { _id: 1 } });\n\t\t\tif (!subscription && !(await hasPermissionAsync(this.userId, 'on-hold-others-livechat-room'))) {\n\t\t\t\tthrow new Error('Not_authorized');\n\t\t\t}\n\n\t\t\tconst { name, username, _id: userId } = this.user;\n\t\t\tconst onHoldBy = { _id: userId, username, name };\n\t\t\tconst comment = i18n.t('Omnichannel_on_hold_chat_resumed_manually', {\n\t\t\t\tuser: onHoldBy.name || `@${onHoldBy.username}`,\n\t\t\t});\n\n\t\t\tawait OmnichannelEEService.resumeRoomOnHold(room, comment, this.user, true);\n\n\t\t\treturn API.v1.success();\n\t\t},\n\t},\n);\n\nAPI.v1.addRoute(\n\t'livechat/room/:rid/priority',\n\t{\n\t\tauthRequired: true,\n\t\tvalidateParams: { POST: isPOSTLivechatRoomPriorityParams },\n\t\tpermissionsRequired: {\n\t\t\tPOST: { permissions: ['view-l-room'], operation: 'hasAny' },\n\t\t\tDELETE: { permissions: ['view-l-room'], operation: 'hasAny' },\n\t\t},\n\t},\n\t{\n\t\tasync post() {\n\t\t\tconst { rid } = this.urlParams;\n\t\t\tconst { priorityId } = this.bodyParams;\n\n\t\t\tif (!this.user.username) {\n\t\t\t\treturn API.v1.failure('Invalid user');\n\t\t\t}\n\n\t\t\tawait updateRoomPriority(\n\t\t\t\trid,\n\t\t\t\t{\n\t\t\t\t\t_id: this.user._id,\n\t\t\t\t\tname: this.user.name || '',\n\t\t\t\t\tusername: this.user.username,\n\t\t\t\t},\n\t\t\t\tpriorityId,\n\t\t\t);\n\n\t\t\treturn API.v1.success();\n\t\t},\n\t\tasync delete() {\n\t\t\tconst { rid } = this.urlParams;\n\n\t\t\tif (!this.user.username) {\n\t\t\t\treturn API.v1.failure('Invalid user');\n\t\t\t}\n\n\t\t\tawait removePriorityFromRoom(rid, {\n\t\t\t\t_id: this.user._id,\n\t\t\t\tname: this.user.name || '',\n\t\t\t\tusername: this.user.username,\n\t\t\t});\n\n\t\t\treturn API.v1.success();\n\t\t},\n\t},\n);\n"],"mappings":";;;IAAA,IAAAA,oBAAS;IAAAC,MAAsB,CAAAC,IAAA,CAAM,4BAA4B,EAAC;MAAAF,qBAAAG,CAAA;QAAAH,oBAAA,GAAAG,CAAA;MAAA;IAAA;IAAA,IAAAC,aAAA,EAAAC,aAAA;IAAAJ,MAAA,CAAAC,IAAA;MAAAE,cAAAD,CAAA;QAAAC,aAAA,GAAAD,CAAA;MAAA;MAAAE,cAAAF,CAAA;QAAAE,aAAA,GAAAF,CAAA;MAAA;IAAA;IAAA,IAAAG,yBAAA,EAAAC,+BAAA,EAAAC,gCAAA;IAAAP,MAAA,CAAAC,IAAA;MAAAI,0BAAAH,CAAA;QAAAG,yBAAA,GAAAH,CAAA;MAAA;MAAAI,gCAAAJ,CAAA;QAAAI,+BAAA,GAAAJ,CAAA;MAAA;MAAAK,iCAAAL,CAAA;QAAAK,gCAAA,GAAAL,CAAA;MAAA;IAAA;IAAA,IAAAM,GAAA;IAAAR,MAAA,CAAAC,IAAA;MAAAO,IAAAN,CAAA;QAAAM,GAAA,GAAAN,CAAA;MAAA;IAAA;IAAA,IAAAO,kBAAA;IAAAT,MAAA,CAAAC,IAAA;MAAAQ,mBAAAP,CAAA;QAAAO,kBAAA,GAAAP,CAAA;MAAA;IAAA;IAAA,IAAAQ,IAAA;IAAAV,MAAA,CAAAC,IAAA;MAAAS,KAAAR,CAAA;QAAAQ,IAAA,GAAAR,CAAA;MAAA;IAAA;IAAA,IAAAS,sBAAA,EAAAC,kBAAA;IAAAZ,MAAA,CAAAC,IAAA;MAAAU,uBAAAT,CAAA;QAAAS,sBAAA,GAAAT,CAAA;MAAA;MAAAU,mBAAAV,CAAA;QAAAU,kBAAA,GAAAV,CAAA;MAAA;IAAA;IAAA,IAAAW,oBAAA,WAAAA,oBAAA;IAUlEL,GAAG,CAACM,EAAE,CAACC,QAAQ,CACd,sBAAsB,EACtB;MAAEC,YAAY,EAAE,IAAI;MAAEC,mBAAmB,EAAE,CAAC,uBAAuB,CAAC;MAAEC,cAAc,EAAEb;IAAyB,CAAE,EACjH;MACC,MAAMc,IAAIA,CAAA;QACT,MAAM;UAAEC;QAAM,CAAE,GAAG,IAAI,CAACC,UAAU;QAIlC,MAAMC,IAAI,GAAG,MAAMnB,aAAa,CAACoB,WAAW,CAAOH,MAAM,EAAE;UAC1DI,UAAU,EAAE;YAAEC,GAAG,EAAE,CAAC;YAAEC,CAAC,EAAE,CAAC;YAAEC,IAAI,EAAE,CAAC;YAAEC,MAAM,EAAE,CAAC;YAAEC,CAAC,EAAE,CAAC;YAAEC,WAAW,EAAE,CAAC;YAAEC,QAAQ,EAAE;UAAC;SACjF,CAAC;QACF,IAAI,CAACT,IAAI,EAAE;UACV,MAAM,IAAIU,KAAK,CAAC,oBAAoB,CAAC;QACtC;QAEA,MAAMC,YAAY,GAAG,MAAM7B,aAAa,CAAC8B,wBAAwB,CAACd,MAAM,EAAE,IAAI,CAACe,MAAM,EAAE;UAAEX,UAAU,EAAE;YAAEC,GAAG,EAAE;UAAC;QAAE,CAAE,CAAC;QAClH,IAAI,CAACQ,YAAY,IAAI,EAAE,MAAMxB,kBAAkB,CAAC,IAAI,CAAC0B,MAAM,EAAE,8BAA8B,CAAC,CAAC,EAAE;UAC9F,MAAM,IAAIH,KAAK,CAAC,gBAAgB,CAAC;QAClC;QAEA,MAAMI,QAAQ,GAAG;UAAEX,GAAG,EAAE,IAAI,CAACU,MAAM;UAAEE,QAAQ,EAAE,IAAI,CAACC,IAAI,CAACD,QAAQ;UAAEE,IAAI,EAAE,IAAI,CAACD,IAAI,CAACC;QAAI,CAAE;QACzF,MAAMC,OAAO,GAAG9B,IAAI,CAACgB,CAAC,CAAC,8BAA8B,EAAE;UACtDY,IAAI,EAAEF,QAAQ,CAACG,IAAI,QAAAE,MAAA,CAAQL,QAAQ,CAACC,QAAQ;SAC5C,CAAC;QAEF,MAAMtC,oBAAoB,CAAC2C,eAAe,CAACpB,IAAI,EAAEkB,OAAO,EAAE,IAAI,CAACF,IAAI,CAAC;QAEpE,OAAO9B,GAAG,CAACM,EAAE,CAAC6B,OAAO,EAAE;MACxB;KACA,CACD;IAEDnC,GAAG,CAACM,EAAE,CAACC,QAAQ,CACd,4BAA4B,EAC5B;MAAEC,YAAY,EAAE,IAAI;MAAEC,mBAAmB,EAAE,CAAC,aAAa,CAAC;MAAEC,cAAc,EAAEZ;IAA+B,CAAE,EAC7G;MACC,MAAMa,IAAIA,CAAA;QACT,MAAM;UAAEC;QAAM,CAAE,GAAG,IAAI,CAACC,UAAU;QAClC,IAAI,CAACD,MAAM,IAAIA,MAAM,CAACwB,IAAI,EAAE,KAAK,EAAE,EAAE;UACpC,MAAM,IAAIZ,KAAK,CAAC,eAAe,CAAC;QACjC;QAIA,MAAMV,IAAI,GAAG,MAAMnB,aAAa,CAACoB,WAAW,CAAOH,MAAM,EAAE;UAC1DI,UAAU,EAAE;YAAEE,CAAC,EAAE,CAAC;YAAEC,IAAI,EAAE,CAAC;YAAEC,MAAM,EAAE,CAAC;YAAEG,QAAQ,EAAE;UAAC;SACnD,CAAC;QACF,IAAI,CAACT,IAAI,EAAE;UACV,MAAM,IAAIU,KAAK,CAAC,oBAAoB,CAAC;QACtC;QAEA,MAAMC,YAAY,GAAG,MAAM7B,aAAa,CAAC8B,wBAAwB,CAACd,MAAM,EAAE,IAAI,CAACe,MAAM,EAAE;UAAEX,UAAU,EAAE;YAAEC,GAAG,EAAE;UAAC;QAAE,CAAE,CAAC;QAClH,IAAI,CAACQ,YAAY,IAAI,EAAE,MAAMxB,kBAAkB,CAAC,IAAI,CAAC0B,MAAM,EAAE,8BAA8B,CAAC,CAAC,EAAE;UAC9F,MAAM,IAAIH,KAAK,CAAC,gBAAgB,CAAC;QAClC;QAEA,MAAM;UAAEO,IAAI;UAAEF,QAAQ;UAAEZ,GAAG,EAAEU;QAAM,CAAE,GAAG,IAAI,CAACG,IAAI;QACjD,MAAMF,QAAQ,GAAG;UAAEX,GAAG,EAAEU,MAAM;UAAEE,QAAQ;UAAEE;QAAI,CAAE;QAChD,MAAMC,OAAO,GAAG9B,IAAI,CAACgB,CAAC,CAAC,2CAA2C,EAAE;UACnEY,IAAI,EAAEF,QAAQ,CAACG,IAAI,QAAAE,MAAA,CAAQL,QAAQ,CAACC,QAAQ;SAC5C,CAAC;QAEF,MAAMtC,oBAAoB,CAAC8C,gBAAgB,CAACvB,IAAI,EAAEkB,OAAO,EAAE,IAAI,CAACF,IAAI,EAAE,IAAI,CAAC;QAE3E,OAAO9B,GAAG,CAACM,EAAE,CAAC6B,OAAO,EAAE;MACxB;KACA,CACD;IAEDnC,GAAG,CAACM,EAAE,CAACC,QAAQ,CACd,6BAA6B,EAC7B;MACCC,YAAY,EAAE,IAAI;MAClBE,cAAc,EAAE;QAAE4B,IAAI,EAAEvC;MAAgC,CAAE;MAC1DU,mBAAmB,EAAE;QACpB6B,IAAI,EAAE;UAAEC,WAAW,EAAE,CAAC,aAAa,CAAC;UAAEC,SAAS,EAAE;QAAQ,CAAE;QAC3DC,MAAM,EAAE;UAAEF,WAAW,EAAE,CAAC,aAAa,CAAC;UAAEC,SAAS,EAAE;QAAQ;;KAE5D,EACD;MACC,MAAM7B,IAAIA,CAAA;QACT,MAAM;UAAE+B;QAAG,CAAE,GAAG,IAAI,CAACC,SAAS;QAC9B,MAAM;UAAEC;QAAU,CAAE,GAAG,IAAI,CAAC/B,UAAU;QAEtC,IAAI,CAAC,IAAI,CAACiB,IAAI,CAACD,QAAQ,EAAE;UACxB,OAAO7B,GAAG,CAACM,EAAE,CAACuC,OAAO,CAAC,cAAc,CAAC;QACtC;QAEA,MAAMzC,kBAAkB,CACvBsC,GAAG,EACH;UACCzB,GAAG,EAAE,IAAI,CAACa,IAAI,CAACb,GAAG;UAClBc,IAAI,EAAE,IAAI,CAACD,IAAI,CAACC,IAAI,IAAI,EAAE;UAC1BF,QAAQ,EAAE,IAAI,CAACC,IAAI,CAACD;SACpB,EACDe,UAAU,CACV;QAED,OAAO5C,GAAG,CAACM,EAAE,CAAC6B,OAAO,EAAE;MACxB,CAAC;MACD,MAAMW,MAAMA,CAAA;QACX,MAAM;UAAEJ;QAAG,CAAE,GAAG,IAAI,CAACC,SAAS;QAE9B,IAAI,CAAC,IAAI,CAACb,IAAI,CAACD,QAAQ,EAAE;UACxB,OAAO7B,GAAG,CAACM,EAAE,CAACuC,OAAO,CAAC,cAAc,CAAC;QACtC;QAEA,MAAM1C,sBAAsB,CAACuC,GAAG,EAAE;UACjCzB,GAAG,EAAE,IAAI,CAACa,IAAI,CAACb,GAAG;UAClBc,IAAI,EAAE,IAAI,CAACD,IAAI,CAACC,IAAI,IAAI,EAAE;UAC1BF,QAAQ,EAAE,IAAI,CAACC,IAAI,CAACD;SACpB,CAAC;QAEF,OAAO7B,GAAG,CAACM,EAAE,CAAC6B,OAAO,EAAE;MACxB;KACA,CACD;IAACY,sBAAA;EAAA,SAAAC,WAAA;IAAA,OAAAD,sBAAA,CAAAC,WAAA;EAAA;EAAAD,sBAAA;AAAA;EAAAE,IAAA;EAAAC,KAAA;AAAA","ignoreList":[]},"sourceType":"module","externalDependencies":{},"hash":"23afe60c7200bc4a68e60fef5e0a4cf0436c4c99"}
