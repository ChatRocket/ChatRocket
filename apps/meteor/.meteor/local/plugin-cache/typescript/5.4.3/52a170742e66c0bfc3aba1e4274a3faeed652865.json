{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/app/integrations/server/lib/isolated-vm/isolated-vm.ts","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","topLevelAwait","objectRestSpread","objectRestSpread","asyncGenerators","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"os.osx.arm64"},"sourceFileName":"app/integrations/server/lib/isolated-vm/isolated-vm.ts","filename":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/app/integrations/server/lib/isolated-vm/isolated-vm.ts","inputSourceMap":{"version":3,"file":"app/integrations/server/lib/isolated-vm/isolated-vm.ts","sourceRoot":"","sources":["app/integrations/server/lib/isolated-vm/isolated-vm.ts"],"names":[],"mappings":"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","sourcesContent":["import type { IIntegration, ValueOf } from '@rocket.chat/core-typings';\nimport { pick } from '@rocket.chat/tools';\nimport ivm, { type Reference } from 'isolated-vm';\n\nimport { IntegrationScriptEngine } from '../ScriptEngine';\nimport type { IScriptClass, CompatibilityScriptResult, FullScriptClass } from '../definition';\nimport { buildSandbox } from './buildSandbox';\nimport { getCompatibilityScript } from './getCompatibilityScript';\n\nconst DISABLE_INTEGRATION_SCRIPTS = ['yes', 'true', 'ivm'].includes(String(process.env.DISABLE_INTEGRATION_SCRIPTS).toLowerCase());\n\nexport class IsolatedVMScriptEngine<IsIncoming extends boolean> extends IntegrationScriptEngine<IsIncoming> {\n\tprotected isDisabled(): boolean {\n\t\treturn DISABLE_INTEGRATION_SCRIPTS;\n\t}\n\n\tprotected async callScriptFunction(\n\t\tscriptReference: Reference<ValueOf<IScriptClass>>,\n\t\t...params: Parameters<ValueOf<FullScriptClass>>\n\t): Promise<any> {\n\t\treturn scriptReference.applySync(undefined, params, {\n\t\t\targuments: { copy: true },\n\t\t\tresult: { copy: true, promise: true },\n\t\t});\n\t}\n\n\tprotected async runScriptMethod({\n\t\tscript,\n\t\tmethod,\n\t\tparams,\n\t}: {\n\t\tintegrationId: IIntegration['_id'];\n\t\tscript: Partial<IScriptClass>;\n\t\tmethod: keyof IScriptClass;\n\t\tparams: Record<string, any>;\n\t}): Promise<any> {\n\t\tconst fn = script[method];\n\n\t\tif (typeof fn !== 'function') {\n\t\t\tthrow new Error('integration-method-not-found');\n\t\t}\n\n\t\treturn fn(params);\n\t}\n\n\tprotected async getIntegrationScript(integration: IIntegration): Promise<Partial<IScriptClass>> {\n\t\tif (this.disabled) {\n\t\t\tthrow new Error('integration-scripts-disabled');\n\t\t}\n\n\t\tconst compiledScript = this.compiledScripts[integration._id];\n\t\tif (compiledScript && +compiledScript._updatedAt === +integration._updatedAt) {\n\t\t\treturn compiledScript.script;\n\t\t}\n\n\t\tconst script = integration.scriptCompiled;\n\t\ttry {\n\t\t\tthis.logger.info({ msg: 'Will evaluate the integration script', integration: pick(integration, 'name', '_id') });\n\t\t\tthis.logger.debug(script);\n\n\t\t\tconst isolate = new ivm.Isolate({ memoryLimit: 8 });\n\n\t\t\tconst ivmScript = await isolate.compileScript(getCompatibilityScript(script));\n\n\t\t\tconst ivmContext = isolate.createContextSync();\n\t\t\tbuildSandbox(ivmContext);\n\n\t\t\tconst ivmResult: Reference<CompatibilityScriptResult> = await ivmScript.run(ivmContext, {\n\t\t\t\treference: true,\n\t\t\t\ttimeout: 3000,\n\t\t\t});\n\n\t\t\tconst availableFunctions = await ivmResult.get('availableFunctions', { copy: true });\n\t\t\tconst scriptFunctions = Object.fromEntries(\n\t\t\t\tavailableFunctions.map((functionName) => {\n\t\t\t\t\tconst fnReference = ivmResult.getSync(functionName, { reference: true });\n\t\t\t\t\treturn [functionName, (...params: Parameters<ValueOf<FullScriptClass>>) => this.callScriptFunction(fnReference, ...params)];\n\t\t\t\t}),\n\t\t\t) as Partial<IScriptClass>;\n\n\t\t\tthis.compiledScripts[integration._id] = {\n\t\t\t\tscript: scriptFunctions,\n\t\t\t\tstore: {},\n\t\t\t\t_updatedAt: integration._updatedAt,\n\t\t\t};\n\n\t\t\treturn scriptFunctions;\n\t\t} catch (err: any) {\n\t\t\tthis.logger.error({\n\t\t\t\tmsg: 'Error evaluating integration script',\n\t\t\t\tintegration: integration.name,\n\t\t\t\tscript,\n\t\t\t\terr,\n\t\t\t});\n\n\t\t\tthrow new Error('error-evaluating-script');\n\t\t}\n\t}\n}\n"]},"targets":{"android":"125.0.0","chrome":"125.0.0","edge":"125.0.0","firefox":"115.0.0","ie":"10.0.0","ios":"17.4.0","opera":"110.0.0","opera_mobile":"80.0.0","safari":"17.4.0","samsung":"24.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor","root":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":false,"enforceStrictMode":false,"dynamicImport":true,"generateLetDeclarations":true,"topLevelAwait":true},"externalDependencies":[]},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"version":"7.17.2","helpers":true,"useESModules":false,"corejs":false},"externalDependencies":[]},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-async-generator-functions","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-class-properties","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true},"externalDependencies":[]},{"key":"transform-react-jsx","visitor":{"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXFragment":{"exit":[null]},"JSXElement":{"exit":[null]},"JSXAttribute":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false},"externalDependencies":[]},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-nullish-coalescing-operator","visitor":{"LogicalExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-optional-chaining","visitor":{"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-optional-catch-binding","visitor":{"CatchClause":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-class-properties","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-async-generator-functions","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-logical-assignment-operators","visitor":{"AssignmentExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]}],"presets":[],"generatorOpts":{"filename":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/app/integrations/server/lib/isolated-vm/isolated-vm.ts","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"app/integrations/server/lib/isolated-vm/isolated-vm.ts","inputSourceMap":{"version":3,"file":"app/integrations/server/lib/isolated-vm/isolated-vm.ts","sourceRoot":"","sources":["app/integrations/server/lib/isolated-vm/isolated-vm.ts"],"names":[],"mappings":"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","sourcesContent":["import type { IIntegration, ValueOf } from '@rocket.chat/core-typings';\nimport { pick } from '@rocket.chat/tools';\nimport ivm, { type Reference } from 'isolated-vm';\n\nimport { IntegrationScriptEngine } from '../ScriptEngine';\nimport type { IScriptClass, CompatibilityScriptResult, FullScriptClass } from '../definition';\nimport { buildSandbox } from './buildSandbox';\nimport { getCompatibilityScript } from './getCompatibilityScript';\n\nconst DISABLE_INTEGRATION_SCRIPTS = ['yes', 'true', 'ivm'].includes(String(process.env.DISABLE_INTEGRATION_SCRIPTS).toLowerCase());\n\nexport class IsolatedVMScriptEngine<IsIncoming extends boolean> extends IntegrationScriptEngine<IsIncoming> {\n\tprotected isDisabled(): boolean {\n\t\treturn DISABLE_INTEGRATION_SCRIPTS;\n\t}\n\n\tprotected async callScriptFunction(\n\t\tscriptReference: Reference<ValueOf<IScriptClass>>,\n\t\t...params: Parameters<ValueOf<FullScriptClass>>\n\t): Promise<any> {\n\t\treturn scriptReference.applySync(undefined, params, {\n\t\t\targuments: { copy: true },\n\t\t\tresult: { copy: true, promise: true },\n\t\t});\n\t}\n\n\tprotected async runScriptMethod({\n\t\tscript,\n\t\tmethod,\n\t\tparams,\n\t}: {\n\t\tintegrationId: IIntegration['_id'];\n\t\tscript: Partial<IScriptClass>;\n\t\tmethod: keyof IScriptClass;\n\t\tparams: Record<string, any>;\n\t}): Promise<any> {\n\t\tconst fn = script[method];\n\n\t\tif (typeof fn !== 'function') {\n\t\t\tthrow new Error('integration-method-not-found');\n\t\t}\n\n\t\treturn fn(params);\n\t}\n\n\tprotected async getIntegrationScript(integration: IIntegration): Promise<Partial<IScriptClass>> {\n\t\tif (this.disabled) {\n\t\t\tthrow new Error('integration-scripts-disabled');\n\t\t}\n\n\t\tconst compiledScript = this.compiledScripts[integration._id];\n\t\tif (compiledScript && +compiledScript._updatedAt === +integration._updatedAt) {\n\t\t\treturn compiledScript.script;\n\t\t}\n\n\t\tconst script = integration.scriptCompiled;\n\t\ttry {\n\t\t\tthis.logger.info({ msg: 'Will evaluate the integration script', integration: pick(integration, 'name', '_id') });\n\t\t\tthis.logger.debug(script);\n\n\t\t\tconst isolate = new ivm.Isolate({ memoryLimit: 8 });\n\n\t\t\tconst ivmScript = await isolate.compileScript(getCompatibilityScript(script));\n\n\t\t\tconst ivmContext = isolate.createContextSync();\n\t\t\tbuildSandbox(ivmContext);\n\n\t\t\tconst ivmResult: Reference<CompatibilityScriptResult> = await ivmScript.run(ivmContext, {\n\t\t\t\treference: true,\n\t\t\t\ttimeout: 3000,\n\t\t\t});\n\n\t\t\tconst availableFunctions = await ivmResult.get('availableFunctions', { copy: true });\n\t\t\tconst scriptFunctions = Object.fromEntries(\n\t\t\t\tavailableFunctions.map((functionName) => {\n\t\t\t\t\tconst fnReference = ivmResult.getSync(functionName, { reference: true });\n\t\t\t\t\treturn [functionName, (...params: Parameters<ValueOf<FullScriptClass>>) => this.callScriptFunction(fnReference, ...params)];\n\t\t\t\t}),\n\t\t\t) as Partial<IScriptClass>;\n\n\t\t\tthis.compiledScripts[integration._id] = {\n\t\t\t\tscript: scriptFunctions,\n\t\t\t\tstore: {},\n\t\t\t\t_updatedAt: integration._updatedAt,\n\t\t\t};\n\n\t\t\treturn scriptFunctions;\n\t\t} catch (err: any) {\n\t\t\tthis.logger.error({\n\t\t\t\tmsg: 'Error evaluating integration script',\n\t\t\t\tintegration: integration.name,\n\t\t\t\tscript,\n\t\t\t\terr,\n\t\t\t});\n\n\t\t\tthrow new Error('error-evaluating-script');\n\t\t}\n\t}\n}\n"]}}},"code":"!module.wrapAsync(async function (module, __reifyWaitForDeps__, __reify_async_result__) {\n  \"use strict\";\n  try {\n    module.export({\n      IsolatedVMScriptEngine: () => IsolatedVMScriptEngine\n    });\n    let pick;\n    module.link(\"@rocket.chat/tools\", {\n      pick(v) {\n        pick = v;\n      }\n    }, 0);\n    let ivm;\n    module.link(\"isolated-vm\", {\n      default(v) {\n        ivm = v;\n      }\n    }, 1);\n    let IntegrationScriptEngine;\n    module.link(\"../ScriptEngine\", {\n      IntegrationScriptEngine(v) {\n        IntegrationScriptEngine = v;\n      }\n    }, 2);\n    let buildSandbox;\n    module.link(\"./buildSandbox\", {\n      buildSandbox(v) {\n        buildSandbox = v;\n      }\n    }, 3);\n    let getCompatibilityScript;\n    module.link(\"./getCompatibilityScript\", {\n      getCompatibilityScript(v) {\n        getCompatibilityScript = v;\n      }\n    }, 4);\n    if (__reifyWaitForDeps__()) (await __reifyWaitForDeps__())();\n    const DISABLE_INTEGRATION_SCRIPTS = ['yes', 'true', 'ivm'].includes(String(process.env.DISABLE_INTEGRATION_SCRIPTS).toLowerCase());\n    class IsolatedVMScriptEngine extends IntegrationScriptEngine {\n      isDisabled() {\n        return DISABLE_INTEGRATION_SCRIPTS;\n      }\n      async callScriptFunction(scriptReference) {\n        for (var _len = arguments.length, params = new Array(_len > 1 ? _len - 1 : 0), _key = 1; _key < _len; _key++) {\n          params[_key - 1] = arguments[_key];\n        }\n        return scriptReference.applySync(undefined, params, {\n          arguments: {\n            copy: true\n          },\n          result: {\n            copy: true,\n            promise: true\n          }\n        });\n      }\n      async runScriptMethod(_ref) {\n        let {\n          script,\n          method,\n          params\n        } = _ref;\n        const fn = script[method];\n        if (typeof fn !== 'function') {\n          throw new Error('integration-method-not-found');\n        }\n        return fn(params);\n      }\n      async getIntegrationScript(integration) {\n        var _this = this;\n        if (this.disabled) {\n          throw new Error('integration-scripts-disabled');\n        }\n        const compiledScript = this.compiledScripts[integration._id];\n        if (compiledScript && +compiledScript._updatedAt === +integration._updatedAt) {\n          return compiledScript.script;\n        }\n        const script = integration.scriptCompiled;\n        try {\n          this.logger.info({\n            msg: 'Will evaluate the integration script',\n            integration: pick(integration, 'name', '_id')\n          });\n          this.logger.debug(script);\n          const isolate = new ivm.Isolate({\n            memoryLimit: 8\n          });\n          const ivmScript = await isolate.compileScript(getCompatibilityScript(script));\n          const ivmContext = isolate.createContextSync();\n          buildSandbox(ivmContext);\n          const ivmResult = await ivmScript.run(ivmContext, {\n            reference: true,\n            timeout: 3000\n          });\n          const availableFunctions = await ivmResult.get('availableFunctions', {\n            copy: true\n          });\n          const scriptFunctions = Object.fromEntries(availableFunctions.map(functionName => {\n            const fnReference = ivmResult.getSync(functionName, {\n              reference: true\n            });\n            return [functionName, function () {\n              for (var _len2 = arguments.length, params = new Array(_len2), _key2 = 0; _key2 < _len2; _key2++) {\n                params[_key2] = arguments[_key2];\n              }\n              return _this.callScriptFunction(fnReference, ...params);\n            }];\n          }));\n          this.compiledScripts[integration._id] = {\n            script: scriptFunctions,\n            store: {},\n            _updatedAt: integration._updatedAt\n          };\n          return scriptFunctions;\n        } catch (err) {\n          this.logger.error({\n            msg: 'Error evaluating integration script',\n            integration: integration.name,\n            script,\n            err\n          });\n          throw new Error('error-evaluating-script');\n        }\n      }\n    }\n    __reify_async_result__();\n  } catch (_reifyError) {\n    return __reify_async_result__(_reifyError);\n  }\n  __reify_async_result__()\n}, {\n  self: this,\n  async: false\n});","map":{"version":3,"names":["module","export","IsolatedVMScriptEngine","pick","link","v","ivm","default","IntegrationScriptEngine","buildSandbox","getCompatibilityScript","__reifyWaitForDeps__","DISABLE_INTEGRATION_SCRIPTS","includes","String","process","env","toLowerCase","isDisabled","callScriptFunction","scriptReference","_len","arguments","length","params","Array","_key","applySync","undefined","copy","result","promise","runScriptMethod","_ref","script","method","fn","Error","getIntegrationScript","integration","_this","disabled","compiledScript","compiledScripts","_id","_updatedAt","scriptCompiled","logger","info","msg","debug","isolate","Isolate","memoryLimit","ivmScript","compileScript","ivmContext","createContextSync","ivmResult","run","reference","timeout","availableFunctions","get","scriptFunctions","Object","fromEntries","map","functionName","fnReference","getSync","_len2","_key2","store","err","error","name","__reify_async_result__","_reifyError","self","async"],"sources":["app/integrations/server/lib/isolated-vm/isolated-vm.ts"],"sourcesContent":["import type { IIntegration, ValueOf } from '@rocket.chat/core-typings';\nimport { pick } from '@rocket.chat/tools';\nimport ivm, { type Reference } from 'isolated-vm';\n\nimport { IntegrationScriptEngine } from '../ScriptEngine';\nimport type { IScriptClass, CompatibilityScriptResult, FullScriptClass } from '../definition';\nimport { buildSandbox } from './buildSandbox';\nimport { getCompatibilityScript } from './getCompatibilityScript';\n\nconst DISABLE_INTEGRATION_SCRIPTS = ['yes', 'true', 'ivm'].includes(String(process.env.DISABLE_INTEGRATION_SCRIPTS).toLowerCase());\n\nexport class IsolatedVMScriptEngine<IsIncoming extends boolean> extends IntegrationScriptEngine<IsIncoming> {\n\tprotected isDisabled(): boolean {\n\t\treturn DISABLE_INTEGRATION_SCRIPTS;\n\t}\n\n\tprotected async callScriptFunction(\n\t\tscriptReference: Reference<ValueOf<IScriptClass>>,\n\t\t...params: Parameters<ValueOf<FullScriptClass>>\n\t): Promise<any> {\n\t\treturn scriptReference.applySync(undefined, params, {\n\t\t\targuments: { copy: true },\n\t\t\tresult: { copy: true, promise: true },\n\t\t});\n\t}\n\n\tprotected async runScriptMethod({\n\t\tscript,\n\t\tmethod,\n\t\tparams,\n\t}: {\n\t\tintegrationId: IIntegration['_id'];\n\t\tscript: Partial<IScriptClass>;\n\t\tmethod: keyof IScriptClass;\n\t\tparams: Record<string, any>;\n\t}): Promise<any> {\n\t\tconst fn = script[method];\n\n\t\tif (typeof fn !== 'function') {\n\t\t\tthrow new Error('integration-method-not-found');\n\t\t}\n\n\t\treturn fn(params);\n\t}\n\n\tprotected async getIntegrationScript(integration: IIntegration): Promise<Partial<IScriptClass>> {\n\t\tif (this.disabled) {\n\t\t\tthrow new Error('integration-scripts-disabled');\n\t\t}\n\n\t\tconst compiledScript = this.compiledScripts[integration._id];\n\t\tif (compiledScript && +compiledScript._updatedAt === +integration._updatedAt) {\n\t\t\treturn compiledScript.script;\n\t\t}\n\n\t\tconst script = integration.scriptCompiled;\n\t\ttry {\n\t\t\tthis.logger.info({ msg: 'Will evaluate the integration script', integration: pick(integration, 'name', '_id') });\n\t\t\tthis.logger.debug(script);\n\n\t\t\tconst isolate = new ivm.Isolate({ memoryLimit: 8 });\n\n\t\t\tconst ivmScript = await isolate.compileScript(getCompatibilityScript(script));\n\n\t\t\tconst ivmContext = isolate.createContextSync();\n\t\t\tbuildSandbox(ivmContext);\n\n\t\t\tconst ivmResult: Reference<CompatibilityScriptResult> = await ivmScript.run(ivmContext, {\n\t\t\t\treference: true,\n\t\t\t\ttimeout: 3000,\n\t\t\t});\n\n\t\t\tconst availableFunctions = await ivmResult.get('availableFunctions', { copy: true });\n\t\t\tconst scriptFunctions = Object.fromEntries(\n\t\t\t\tavailableFunctions.map((functionName) => {\n\t\t\t\t\tconst fnReference = ivmResult.getSync(functionName, { reference: true });\n\t\t\t\t\treturn [functionName, (...params: Parameters<ValueOf<FullScriptClass>>) => this.callScriptFunction(fnReference, ...params)];\n\t\t\t\t}),\n\t\t\t) as Partial<IScriptClass>;\n\n\t\t\tthis.compiledScripts[integration._id] = {\n\t\t\t\tscript: scriptFunctions,\n\t\t\t\tstore: {},\n\t\t\t\t_updatedAt: integration._updatedAt,\n\t\t\t};\n\n\t\t\treturn scriptFunctions;\n\t\t} catch (err: any) {\n\t\t\tthis.logger.error({\n\t\t\t\tmsg: 'Error evaluating integration script',\n\t\t\t\tintegration: integration.name,\n\t\t\t\tscript,\n\t\t\t\terr,\n\t\t\t});\n\n\t\t\tthrow new Error('error-evaluating-script');\n\t\t}\n\t}\n}\n"],"mappings":"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","ignoreList":[]},"sourceType":"module","externalDependencies":{},"hash":"52a170742e66c0bfc3aba1e4274a3faeed652865"}
