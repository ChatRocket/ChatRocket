{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/ee/server/local-services/federation/service.ts","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","topLevelAwait","objectRestSpread","objectRestSpread","asyncGenerators","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"os.osx.arm64"},"sourceFileName":"ee/server/local-services/federation/service.ts","filename":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/ee/server/local-services/federation/service.ts","inputSourceMap":{"version":3,"file":"ee/server/local-services/federation/service.ts","sourceRoot":"","sources":["ee/server/local-services/federation/service.ts"],"names":[],"mappings":"AAWA,OAAO,EAAE,mCAAmC,EAAE,MAAM,8CAA8C,CAAC;AAEnG,OAAO,EAAE,mBAAmB,EAAE,MAAM,0BAA0B,CAAC;AAG/D,OAAO,EAAE,+BAA+B,EAAE,MAAM,oDAAoD,CAAC;AACrG,OAAO,EAAE,yBAAyB,EAAE,MAAM,gDAAgD,CAAC;AAE3F,MAAe,+BAAgC,SAAQ,yBAAyB;IACrE,qBAAqB,CAA0B;IAE/C,gCAAgC,CAA2C;IAE3E,2BAA2B,CAA8B;IAEzD,qBAAqB,CAA0B;IAE/C,qBAAqB,CAA0B;IAEzD;QACC,MAAM,qBAAqB,GAAG,mBAAmB,CAAC,oBAAoB,EAAE,CAAC;QACzE,MAAM,uBAAuB,GAAG,mBAAmB,CAAC,4BAA4B,EAAE,CAAC;QACnF,MAAM,QAAQ,GAAG,mBAAmB,CAAC,qBAAqB,CAAC,uBAAuB,EAAE,qBAAqB,CAAC,CAAC;QAC3G,KAAK,CAAC,QAAQ,EAAE,qBAAqB,EAAE,uBAAuB,CAAC,CAAC;QAEhE,IAAI,CAAC,qBAAqB,GAAG,mBAAmB,CAAC,wBAAwB,EAAE,CAAC;QAC5E,IAAI,CAAC,qBAAqB,GAAG,mBAAmB,CAAC,wBAAwB,EAAE,CAAC;QAC5E,IAAI,CAAC,qBAAqB,GAAG,mBAAmB,CAAC,2BAA2B,CAC3E,IAAI,CAAC,0BAA0B,EAAE,EACjC,IAAI,CAAC,qBAAqB,EAC1B,IAAI,CAAC,sBAAsB,EAAE,EAC7B,IAAI,CAAC,SAAS,EAAE,CAChB,CAAC;QACF,IAAI,CAAC,gCAAgC,GAAG,mBAAmB,CAAC,mCAAmC,CAC9F,IAAI,CAAC,qBAAqB,EAC1B,IAAI,CAAC,qBAAqB,EAC1B,IAAI,CAAC,sBAAsB,EAAE,EAC7B,IAAI,CAAC,0BAA0B,EAAE,EACjC,IAAI,CAAC,SAAS,EAAE,CAChB,CAAC;QACF,IAAI,CAAC,2BAA2B,GAAG,mBAAmB,CAAC,wBAAwB,CAC9E,IAAI,CAAC,qBAAqB,EAC1B,IAAI,CAAC,qBAAqB,EAC1B,IAAI,CAAC,sBAAsB,EAAE,EAC7B,IAAI,CAAC,0BAA0B,EAAE,EACjC,IAAI,CAAC,yBAAyB,EAAE,EAChC,IAAI,CAAC,8BAA8B,EAAE,EACrC,mBAAmB,CAAC,yBAAyB,EAAE,EAC/C,IAAI,CAAC,SAAS,EAAE,CAChB,CAAC;IACH,CAAC;IAES,KAAK,CAAC,+BAA+B;QAC9C,MAAM,IAAI,CAAC,8BAA8B,EAAE,CAAC,2CAA2C,CACtF,IAAI,CAAC,8BAA8B,EAAE,CAAC,yBAAyB,CAAC,IAAI,CAAC,IAAI,CAAC,8BAA8B,EAAE,CAAC,CAC3G,CAAC;IACH,CAAC;IAES,KAAK,CAAC,uBAAuB;QACtC,MAAM,0BAA0B,GAAG,mBAAmB,CAAC,0BAA0B,CAChF,IAAI,CAAC,qBAAqB,EAC1B,IAAI,CAAC,qBAAqB,EAC1B,IAAI,CAAC,sBAAsB,EAAE,EAC7B,IAAI,CAAC,0BAA0B,EAAE,EACjC,IAAI,CAAC,SAAS,EAAE,CAChB,CAAC;QACF,mBAAmB,CAAC,eAAe,CAAC,0BAA0B,CAAC,CAAC;IACjE,CAAC;IAES,KAAK,CAAC,4BAA4B;QAC3C,MAAM,yBAAyB,GAAG,mBAAmB,CAAC,sBAAsB,CAC3E,IAAI,CAAC,qBAAqB,EAC1B,IAAI,CAAC,qBAAqB,EAC1B,IAAI,CAAC,sBAAsB,EAAE,EAC7B,IAAI,CAAC,yBAAyB,EAAE,EAChC,IAAI,CAAC,0BAA0B,EAAE,EACjC,IAAI,CAAC,8BAA8B,EAAE,EACrC,IAAI,CAAC,SAAS,EAAE,CAChB,CAAC;QACF,MAAM,4BAA4B,GAAG,mBAAmB,CAAC,yBAAyB,CACjF,IAAI,CAAC,qBAAqB,EAC1B,IAAI,CAAC,qBAAqB,EAC1B,IAAI,CAAC,0BAA0B,EAAE,EACjC,IAAI,CAAC,yBAAyB,EAAE,EAChC,IAAI,CAAC,SAAS,EAAE,CAChB,CAAC;QACF,mBAAmB,CAAC,6BAA6B,CAAC,yBAAyB,EAAE,4BAA4B,CAAC,CAAC;QAC3G,mBAAmB,CAAC,+BAA+B,CAClD,IAAI,CAAC,2BAA2B,EAChC,IAAI,CAAC,gCAAgC,EACrC,IAAI,CAAC,0BAA0B,EAAE,CACjC,CAAC;IACH,CAAC;IAES,KAAK,CAAC,kBAAkB;QACjC,MAAM,KAAK,CAAC,eAAe,EAAE,CAAC;QAC9B,MAAM,IAAI,CAAC,eAAe,EAAE,CAAC;IAC9B,CAAC;IAES,KAAK,CAAC,mBAAmB;QAClC,MAAM,IAAI,CAAC,cAAc,EAAE,CAAC;IAC7B,CAAC;IAEO,SAAS;QAChB,OAAO,IAAI,CAAC,MAA6B,CAAC;IAC3C,CAAC;IAEO,KAAK,CAAC,eAAe;QAC5B,IAAI,CAAC,IAAI,CAAC,mBAAmB,EAAE,EAAE,CAAC;YACjC,OAAO;QACR,CAAC;QACD,MAAM,IAAI,CAAC,MAAM,CAAC,KAAK,EAAE,CAAC;QAC1B,IAAI,CAAC,MAAM,CAAC,wBAAwB,CAAC,kCAAkC,CAAC,CAAC;QACzE,mBAAmB,CAAC,kBAAkB,EAAE,CAAC;QACzC,MAAM,MAAM,CAAC,6CAA6C,CAAC,CAAC;QAC5D,MAAM,MAAM,CAAC,sBAAsB,CAAC,CAAC;IACtC,CAAC;IAEO,KAAK,CAAC,cAAc;QAC3B,MAAM,IAAI,CAAC,MAAM,CAAC,IAAI,EAAE,CAAC;QACzB,mBAAmB,CAAC,kBAAkB,EAAE,CAAC;QACzC,MAAM,KAAK,CAAC,eAAe,EAAE,CAAC;IAC/B,CAAC;IAEM,KAAK,CAAC,OAAO;QACnB,MAAM,KAAK,CAAC,eAAe,EAAE,CAAC;QAC9B,MAAM,IAAI,CAAC,eAAe,EAAE,CAAC;IAC9B,CAAC;IAEM,KAAK,CAAC,OAAO;QACnB,MAAM,IAAI,CAAC,cAAc,EAAE,CAAC;QAC5B,MAAM,KAAK,CAAC,OAAO,EAAE,CAAC;IACvB,CAAC;CACD;AAED,MAAM,OAAO,mBAAoB,SAAQ,+BAA+B;IAC7D,IAAI,GAAG,uBAAuB,CAAC;IAElC,KAAK,CAAC,uBAAuB,CAAC,cAAsB,EAAE,QAAkB;QAC9E,MAAM,IAAI,CAAC,gCAAgC,CAAC,oCAAoC,CAC/E,+BAA+B,CAAC,wBAAwB,CAAC,cAAc,EAAE,QAAQ,CAAC,CAClF,CAAC;IACH,CAAC;IAEM,KAAK,CAAC,iBAAiB,CAC7B,UAAmB,EACnB,QAAiB,EACjB,SAAkB,EAClB,KAAc;QAMd,OAAO,IAAI,CAAC,2BAA2B,CAAC,iBAAiB,CACxD,IAAI,mCAAmC,CAAC;YACvC,UAAU;YACV,QAAQ;YACR,SAAS;YACT,KAAK;SACL,CAAC,CACF,CAAC;IACH,CAAC;IAEM,KAAK,CAAC,sCAAsC,CAClD,cAAsB;QAEtB,OAAO,IAAI,CAAC,qBAAqB,CAAC,sCAAsC,CAAC,cAAc,CAAC,CAAC;IAC1F,CAAC;IAEM,KAAK,CAAC,qCAAqC,CAAC,cAAsB,EAAE,UAAkB;QAC5F,OAAO,IAAI,CAAC,qBAAqB,CAAC,qCAAqC,CAAC,cAAc,EAAE,UAAU,CAAC,CAAC;IACrG,CAAC;IAEM,KAAK,CAAC,wCAAwC,CAAC,cAAsB,EAAE,UAAkB;QAC/F,OAAO,IAAI,CAAC,qBAAqB,CAAC,wCAAwC,CAAC,cAAc,EAAE,UAAU,CAAC,CAAC;IACxG,CAAC;IAEM,KAAK,CAAC,8BAA8B,CAC1C,cAAsB,EACtB,cAAsB,EACtB,QAAiB,EACjB,SAAkB;QAElB,MAAM,IAAI,CAAC,2BAA2B,CAAC,8BAA8B,CAAC,cAAc,EAAE,cAAc,EAAE,QAAQ,EAAE,SAAS,CAAC,CAAC;IAC5H,CAAC;IAEM,KAAK,CAAC,sBAAsB,CAAC,KAA6C;QAChF,MAAM,EAAE,cAAc,EAAE,cAAc,EAAE,QAAQ,EAAE,SAAS,EAAE,GAAG,KAAK,CAAC;QACtE,MAAM,IAAI,CAAC,2BAA2B,CAAC,sBAAsB,CAC5D,+BAA+B,CAAC,2BAA2B,CAAC,cAAc,EAAE,cAAc,EAAE,QAAQ,EAAE,SAAS,CAAC,CAChH,CAAC;IACH,CAAC;IAEM,KAAK,CAAC,eAAe,CAAC,SAAmB;QAC/C,OAAO,KAAK,CAAC,eAAe,CAAC,SAAS,CAAC,CAAC;IACzC,CAAC;IAED,MAAM,CAAC,KAAK,CAAC,uBAAuB;QACnC,MAAM,iBAAiB,GAAG,IAAI,mBAAmB,EAAE,CAAC;QACpD,MAAM,iBAAiB,CAAC,UAAU,EAAE,CAAC;QACrC,OAAO,iBAAiB,CAAC;IAC1B,CAAC;IAED,KAAK,CAAC,OAAO;QACZ,OAAO,KAAK,CAAC,OAAO,EAAE,CAAC;IACxB,CAAC;IAED,KAAK,CAAC,OAAO;QACZ,OAAO,KAAK,CAAC,OAAO,EAAE,CAAC;IACxB,CAAC;IAEM,KAAK,CAAC,mBAAmB;QAC/B,OAAO,KAAK,CAAC,mBAAmB,EAAE,CAAC;IACpC,CAAC;IAEM,KAAK,CAAC,sBAAsB;QAClC,OAAO,KAAK,CAAC,sBAAsB,EAAE,CAAC;IACvC,CAAC;IAEM,KAAK,CAAC,wBAAwB;QACpC,OAAO,KAAK,CAAC,wBAAwB,EAAE,CAAC;IACzC,CAAC;IAEM,KAAK,CAAC,mBAAmB;QAC/B,OAAO,KAAK,CAAC,mBAAmB,EAAE,CAAC;IACpC,CAAC;IAEM,KAAK,CAAC,gBAAgB,CAAC,IAAoB;QACjD,OAAO,KAAK,CAAC,gBAAgB,CAAC,IAAI,CAAC,CAAC;IACrC,CAAC;IAED,KAAK,CAAC,oBAAoB,CAAC,MAAc;QACxC,OAAO,KAAK,CAAC,oBAAoB,CAAC,MAAM,CAAC,CAAC;IAC3C,CAAC;CACD","sourcesContent":["import type {\n\tIFederationServiceEE,\n\tIFederationJoinExternalPublicRoomInput,\n\tFederationConfigurationStatus,\n} from '@rocket.chat/core-services';\nimport type { IRoom } from '@rocket.chat/core-typings';\nimport type { FederationPaginatedResult, IFederationPublicRooms } from '@rocket.chat/rest-typings';\n\nimport type { FederationUserServiceEE } from './application/UserService';\nimport type { FederationDirectMessageRoomServiceSender } from './application/room/sender/DirectMessageRoomServiceSender';\nimport type { FederationRoomServiceSender } from './application/room/sender/RoomServiceSender';\nimport { FederationSearchPublicRoomsInputDto } from './application/room/sender/input/RoomInputDto';\nimport type { IFederationBridgeEE } from './domain/IFederationBridge';\nimport { FederationFactoryEE } from './infrastructure/Factory';\nimport type { RocketChatRoomAdapterEE } from './infrastructure/rocket-chat/adapters/Room';\nimport type { RocketChatUserAdapterEE } from './infrastructure/rocket-chat/adapters/User';\nimport { FederationRoomSenderConverterEE } from './infrastructure/rocket-chat/converters/RoomSender';\nimport { AbstractFederationService } from '../../../../server/services/federation/service';\n\nabstract class AbstractBaseFederationServiceEE extends AbstractFederationService {\n\tprotected internalUserServiceEE: FederationUserServiceEE;\n\n\tprotected directMessageRoomServiceSenderEE: FederationDirectMessageRoomServiceSender;\n\n\tprotected internalRoomServiceSenderEE: FederationRoomServiceSender;\n\n\tprotected internalRoomAdapterEE: RocketChatRoomAdapterEE;\n\n\tprotected internalUserAdapterEE: RocketChatUserAdapterEE;\n\n\tconstructor() {\n\t\tconst internalQueueInstance = FederationFactoryEE.buildFederationQueue();\n\t\tconst internalSettingsAdapter = FederationFactoryEE.buildInternalSettingsAdapter();\n\t\tconst bridgeEE = FederationFactoryEE.buildFederationBridge(internalSettingsAdapter, internalQueueInstance);\n\t\tsuper(bridgeEE, internalQueueInstance, internalSettingsAdapter);\n\n\t\tthis.internalRoomAdapterEE = FederationFactoryEE.buildInternalRoomAdapter();\n\t\tthis.internalUserAdapterEE = FederationFactoryEE.buildInternalUserAdapter();\n\t\tthis.internalUserServiceEE = FederationFactoryEE.buildRoomApplicationService(\n\t\t\tthis.getInternalSettingsAdapter(),\n\t\t\tthis.internalUserAdapterEE,\n\t\t\tthis.getInternalFileAdapter(),\n\t\t\tthis.getBridge(),\n\t\t);\n\t\tthis.directMessageRoomServiceSenderEE = FederationFactoryEE.buildDirectMessageRoomServiceSender(\n\t\t\tthis.internalRoomAdapterEE,\n\t\t\tthis.internalUserAdapterEE,\n\t\t\tthis.getInternalFileAdapter(),\n\t\t\tthis.getInternalSettingsAdapter(),\n\t\t\tthis.getBridge(),\n\t\t);\n\t\tthis.internalRoomServiceSenderEE = FederationFactoryEE.buildRoomServiceSenderEE(\n\t\t\tthis.internalRoomAdapterEE,\n\t\t\tthis.internalUserAdapterEE,\n\t\t\tthis.getInternalFileAdapter(),\n\t\t\tthis.getInternalSettingsAdapter(),\n\t\t\tthis.getInternalMessageAdapter(),\n\t\t\tthis.getInternalNotificationAdapter(),\n\t\t\tFederationFactoryEE.buildInternalQueueAdapter(),\n\t\t\tthis.getBridge(),\n\t\t);\n\t}\n\n\tprotected async setupInternalEphemeralListeners(): Promise<void> {\n\t\tawait this.getInternalNotificationAdapter().subscribeToUserTypingEventsOnFederatedRooms(\n\t\t\tthis.getInternalNotificationAdapter().broadcastUserTypingOnRoom.bind(this.getInternalNotificationAdapter()),\n\t\t);\n\t}\n\n\tprotected async setupInternalValidators(): Promise<void> {\n\t\tconst internalRoomHooksValidator = FederationFactoryEE.buildRoomInternalValidator(\n\t\t\tthis.internalRoomAdapterEE,\n\t\t\tthis.internalUserAdapterEE,\n\t\t\tthis.getInternalFileAdapter(),\n\t\t\tthis.getInternalSettingsAdapter(),\n\t\t\tthis.getBridge(),\n\t\t);\n\t\tFederationFactoryEE.setupValidators(internalRoomHooksValidator);\n\t}\n\n\tprotected async setupInternalActionListeners(): Promise<void> {\n\t\tconst internalRoomServiceSender = FederationFactoryEE.buildRoomServiceSender(\n\t\t\tthis.internalRoomAdapterEE,\n\t\t\tthis.internalUserAdapterEE,\n\t\t\tthis.getInternalFileAdapter(),\n\t\t\tthis.getInternalMessageAdapter(),\n\t\t\tthis.getInternalSettingsAdapter(),\n\t\t\tthis.getInternalNotificationAdapter(),\n\t\t\tthis.getBridge(),\n\t\t);\n\t\tconst internalMessageServiceSender = FederationFactoryEE.buildMessageServiceSender(\n\t\t\tthis.internalRoomAdapterEE,\n\t\t\tthis.internalUserAdapterEE,\n\t\t\tthis.getInternalSettingsAdapter(),\n\t\t\tthis.getInternalMessageAdapter(),\n\t\t\tthis.getBridge(),\n\t\t);\n\t\tFederationFactoryEE.setupListenersForLocalActions(internalRoomServiceSender, internalMessageServiceSender);\n\t\tFederationFactoryEE.setupListenersForLocalActionsEE(\n\t\t\tthis.internalRoomServiceSenderEE,\n\t\t\tthis.directMessageRoomServiceSenderEE,\n\t\t\tthis.getInternalSettingsAdapter(),\n\t\t);\n\t}\n\n\tprotected async onEnableFederation(): Promise<void> {\n\t\tawait super.setupFederation();\n\t\tawait this.startFederation();\n\t}\n\n\tprotected async onDisableFederation(): Promise<void> {\n\t\tawait this.stopFederation();\n\t}\n\n\tprivate getBridge(): IFederationBridgeEE {\n\t\treturn this.bridge as IFederationBridgeEE;\n\t}\n\n\tprivate async startFederation(): Promise<void> {\n\t\tif (!this.isFederationEnabled()) {\n\t\t\treturn;\n\t\t}\n\t\tawait this.bridge.start();\n\t\tthis.bridge.logFederationStartupInfo('Running Federation Enterprise V2');\n\t\tFederationFactoryEE.removeCEValidators();\n\t\tawait import('./infrastructure/rocket-chat/slash-commands');\n\t\tawait import('../../api/federation');\n\t}\n\n\tprivate async stopFederation(): Promise<void> {\n\t\tawait this.bridge.stop();\n\t\tFederationFactoryEE.removeAllListeners();\n\t\tawait super.cleanUpHandlers();\n\t}\n\n\tpublic async created(): Promise<void> {\n\t\tawait super.setupFederation();\n\t\tawait this.startFederation();\n\t}\n\n\tpublic async stopped(): Promise<void> {\n\t\tawait this.stopFederation();\n\t\tawait super.stopped();\n\t}\n}\n\nexport class FederationServiceEE extends AbstractBaseFederationServiceEE implements IFederationServiceEE {\n\tprotected name = 'federation-enterprise';\n\n\tpublic async createDirectMessageRoom(internalUserId: string, invitees: string[]): Promise<void> {\n\t\tawait this.directMessageRoomServiceSenderEE.createInternalLocalDirectMessageRoom(\n\t\t\tFederationRoomSenderConverterEE.toCreateDirectMessageDto(internalUserId, invitees),\n\t\t);\n\t}\n\n\tpublic async searchPublicRooms(\n\t\tserverName?: string,\n\t\troomName?: string,\n\t\tpageToken?: string,\n\t\tcount?: number,\n\t): Promise<\n\t\tFederationPaginatedResult<{\n\t\t\trooms: IFederationPublicRooms[];\n\t\t}>\n\t> {\n\t\treturn this.internalRoomServiceSenderEE.searchPublicRooms(\n\t\t\tnew FederationSearchPublicRoomsInputDto({\n\t\t\t\tserverName,\n\t\t\t\troomName,\n\t\t\t\tpageToken,\n\t\t\t\tcount,\n\t\t\t}),\n\t\t);\n\t}\n\n\tpublic async getSearchedServerNamesByInternalUserId(\n\t\tinternalUserId: string,\n\t): Promise<{ name: string; default: boolean; local: boolean }[]> {\n\t\treturn this.internalUserServiceEE.getSearchedServerNamesByInternalUserId(internalUserId);\n\t}\n\n\tpublic async addSearchedServerNameByInternalUserId(internalUserId: string, serverName: string): Promise<void> {\n\t\treturn this.internalUserServiceEE.addSearchedServerNameByInternalUserId(internalUserId, serverName);\n\t}\n\n\tpublic async removeSearchedServerNameByInternalUserId(internalUserId: string, serverName: string): Promise<void> {\n\t\treturn this.internalUserServiceEE.removeSearchedServerNameByInternalUserId(internalUserId, serverName);\n\t}\n\n\tpublic async scheduleJoinExternalPublicRoom(\n\t\tinternalUserId: string,\n\t\texternalRoomId: string,\n\t\troomName?: string,\n\t\tpageToken?: string,\n\t): Promise<void> {\n\t\tawait this.internalRoomServiceSenderEE.scheduleJoinExternalPublicRoom(internalUserId, externalRoomId, roomName, pageToken);\n\t}\n\n\tpublic async joinExternalPublicRoom(input: IFederationJoinExternalPublicRoomInput): Promise<void> {\n\t\tconst { internalUserId, externalRoomId, roomName, pageToken } = input;\n\t\tawait this.internalRoomServiceSenderEE.joinExternalPublicRoom(\n\t\t\tFederationRoomSenderConverterEE.toJoinExternalPublicRoomDto(internalUserId, externalRoomId, roomName, pageToken),\n\t\t);\n\t}\n\n\tpublic async verifyMatrixIds(matrixIds: string[]): Promise<Map<string, string>> {\n\t\treturn super.verifyMatrixIds(matrixIds);\n\t}\n\n\tstatic async createFederationService(): Promise<FederationServiceEE> {\n\t\tconst federationService = new FederationServiceEE();\n\t\tawait federationService.initialize();\n\t\treturn federationService;\n\t}\n\n\tasync created(): Promise<void> {\n\t\treturn super.created();\n\t}\n\n\tasync stopped(): Promise<void> {\n\t\treturn super.stopped();\n\t}\n\n\tpublic async verifyConfiguration(): Promise<void> {\n\t\treturn super.verifyConfiguration();\n\t}\n\n\tpublic async markConfigurationValid(): Promise<void> {\n\t\treturn super.markConfigurationValid();\n\t}\n\n\tpublic async markConfigurationInvalid(): Promise<void> {\n\t\treturn super.markConfigurationInvalid();\n\t}\n\n\tpublic async configurationStatus(): Promise<FederationConfigurationStatus> {\n\t\treturn super.configurationStatus();\n\t}\n\n\tpublic async beforeCreateRoom(room: Partial<IRoom>): Promise<void> {\n\t\treturn super.beforeCreateRoom(room);\n\t}\n\n\tasync deactivateRemoteUser(userId: string): Promise<void> {\n\t\treturn super.deactivateRemoteUser(userId);\n\t}\n}\n"]},"targets":{"android":"125.0.0","chrome":"125.0.0","edge":"125.0.0","firefox":"115.0.0","ie":"10.0.0","ios":"17.4.0","opera":"110.0.0","opera_mobile":"80.0.0","safari":"17.4.0","samsung":"24.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor","root":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":false,"enforceStrictMode":false,"dynamicImport":true,"generateLetDeclarations":true,"topLevelAwait":true},"externalDependencies":[]},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"version":"7.17.2","helpers":true,"useESModules":false,"corejs":false},"externalDependencies":[]},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-async-generator-functions","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-class-properties","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true},"externalDependencies":[]},{"key":"transform-react-jsx","visitor":{"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXFragment":{"exit":[null]},"JSXElement":{"exit":[null]},"JSXAttribute":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false},"externalDependencies":[]},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-nullish-coalescing-operator","visitor":{"LogicalExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-optional-chaining","visitor":{"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-optional-catch-binding","visitor":{"CatchClause":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-class-properties","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-async-generator-functions","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-logical-assignment-operators","visitor":{"AssignmentExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]}],"presets":[],"generatorOpts":{"filename":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/ee/server/local-services/federation/service.ts","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"ee/server/local-services/federation/service.ts","inputSourceMap":{"version":3,"file":"ee/server/local-services/federation/service.ts","sourceRoot":"","sources":["ee/server/local-services/federation/service.ts"],"names":[],"mappings":"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","sourcesContent":["import type {\n\tIFederationServiceEE,\n\tIFederationJoinExternalPublicRoomInput,\n\tFederationConfigurationStatus,\n} from '@rocket.chat/core-services';\nimport type { IRoom } from '@rocket.chat/core-typings';\nimport type { FederationPaginatedResult, IFederationPublicRooms } from '@rocket.chat/rest-typings';\n\nimport type { FederationUserServiceEE } from './application/UserService';\nimport type { FederationDirectMessageRoomServiceSender } from './application/room/sender/DirectMessageRoomServiceSender';\nimport type { FederationRoomServiceSender } from './application/room/sender/RoomServiceSender';\nimport { FederationSearchPublicRoomsInputDto } from './application/room/sender/input/RoomInputDto';\nimport type { IFederationBridgeEE } from './domain/IFederationBridge';\nimport { FederationFactoryEE } from './infrastructure/Factory';\nimport type { RocketChatRoomAdapterEE } from './infrastructure/rocket-chat/adapters/Room';\nimport type { RocketChatUserAdapterEE } from './infrastructure/rocket-chat/adapters/User';\nimport { FederationRoomSenderConverterEE } from './infrastructure/rocket-chat/converters/RoomSender';\nimport { AbstractFederationService } from '../../../../server/services/federation/service';\n\nabstract class AbstractBaseFederationServiceEE extends AbstractFederationService {\n\tprotected internalUserServiceEE: FederationUserServiceEE;\n\n\tprotected directMessageRoomServiceSenderEE: FederationDirectMessageRoomServiceSender;\n\n\tprotected internalRoomServiceSenderEE: FederationRoomServiceSender;\n\n\tprotected internalRoomAdapterEE: RocketChatRoomAdapterEE;\n\n\tprotected internalUserAdapterEE: RocketChatUserAdapterEE;\n\n\tconstructor() {\n\t\tconst internalQueueInstance = FederationFactoryEE.buildFederationQueue();\n\t\tconst internalSettingsAdapter = FederationFactoryEE.buildInternalSettingsAdapter();\n\t\tconst bridgeEE = FederationFactoryEE.buildFederationBridge(internalSettingsAdapter, internalQueueInstance);\n\t\tsuper(bridgeEE, internalQueueInstance, internalSettingsAdapter);\n\n\t\tthis.internalRoomAdapterEE = FederationFactoryEE.buildInternalRoomAdapter();\n\t\tthis.internalUserAdapterEE = FederationFactoryEE.buildInternalUserAdapter();\n\t\tthis.internalUserServiceEE = FederationFactoryEE.buildRoomApplicationService(\n\t\t\tthis.getInternalSettingsAdapter(),\n\t\t\tthis.internalUserAdapterEE,\n\t\t\tthis.getInternalFileAdapter(),\n\t\t\tthis.getBridge(),\n\t\t);\n\t\tthis.directMessageRoomServiceSenderEE = FederationFactoryEE.buildDirectMessageRoomServiceSender(\n\t\t\tthis.internalRoomAdapterEE,\n\t\t\tthis.internalUserAdapterEE,\n\t\t\tthis.getInternalFileAdapter(),\n\t\t\tthis.getInternalSettingsAdapter(),\n\t\t\tthis.getBridge(),\n\t\t);\n\t\tthis.internalRoomServiceSenderEE = FederationFactoryEE.buildRoomServiceSenderEE(\n\t\t\tthis.internalRoomAdapterEE,\n\t\t\tthis.internalUserAdapterEE,\n\t\t\tthis.getInternalFileAdapter(),\n\t\t\tthis.getInternalSettingsAdapter(),\n\t\t\tthis.getInternalMessageAdapter(),\n\t\t\tthis.getInternalNotificationAdapter(),\n\t\t\tFederationFactoryEE.buildInternalQueueAdapter(),\n\t\t\tthis.getBridge(),\n\t\t);\n\t}\n\n\tprotected async setupInternalEphemeralListeners(): Promise<void> {\n\t\tawait this.getInternalNotificationAdapter().subscribeToUserTypingEventsOnFederatedRooms(\n\t\t\tthis.getInternalNotificationAdapter().broadcastUserTypingOnRoom.bind(this.getInternalNotificationAdapter()),\n\t\t);\n\t}\n\n\tprotected async setupInternalValidators(): Promise<void> {\n\t\tconst internalRoomHooksValidator = FederationFactoryEE.buildRoomInternalValidator(\n\t\t\tthis.internalRoomAdapterEE,\n\t\t\tthis.internalUserAdapterEE,\n\t\t\tthis.getInternalFileAdapter(),\n\t\t\tthis.getInternalSettingsAdapter(),\n\t\t\tthis.getBridge(),\n\t\t);\n\t\tFederationFactoryEE.setupValidators(internalRoomHooksValidator);\n\t}\n\n\tprotected async setupInternalActionListeners(): Promise<void> {\n\t\tconst internalRoomServiceSender = FederationFactoryEE.buildRoomServiceSender(\n\t\t\tthis.internalRoomAdapterEE,\n\t\t\tthis.internalUserAdapterEE,\n\t\t\tthis.getInternalFileAdapter(),\n\t\t\tthis.getInternalMessageAdapter(),\n\t\t\tthis.getInternalSettingsAdapter(),\n\t\t\tthis.getInternalNotificationAdapter(),\n\t\t\tthis.getBridge(),\n\t\t);\n\t\tconst internalMessageServiceSender = FederationFactoryEE.buildMessageServiceSender(\n\t\t\tthis.internalRoomAdapterEE,\n\t\t\tthis.internalUserAdapterEE,\n\t\t\tthis.getInternalSettingsAdapter(),\n\t\t\tthis.getInternalMessageAdapter(),\n\t\t\tthis.getBridge(),\n\t\t);\n\t\tFederationFactoryEE.setupListenersForLocalActions(internalRoomServiceSender, internalMessageServiceSender);\n\t\tFederationFactoryEE.setupListenersForLocalActionsEE(\n\t\t\tthis.internalRoomServiceSenderEE,\n\t\t\tthis.directMessageRoomServiceSenderEE,\n\t\t\tthis.getInternalSettingsAdapter(),\n\t\t);\n\t}\n\n\tprotected async onEnableFederation(): Promise<void> {\n\t\tawait super.setupFederation();\n\t\tawait this.startFederation();\n\t}\n\n\tprotected async onDisableFederation(): Promise<void> {\n\t\tawait this.stopFederation();\n\t}\n\n\tprivate getBridge(): IFederationBridgeEE {\n\t\treturn this.bridge as IFederationBridgeEE;\n\t}\n\n\tprivate async startFederation(): Promise<void> {\n\t\tif (!this.isFederationEnabled()) {\n\t\t\treturn;\n\t\t}\n\t\tawait this.bridge.start();\n\t\tthis.bridge.logFederationStartupInfo('Running Federation Enterprise V2');\n\t\tFederationFactoryEE.removeCEValidators();\n\t\tawait import('./infrastructure/rocket-chat/slash-commands');\n\t\tawait import('../../api/federation');\n\t}\n\n\tprivate async stopFederation(): Promise<void> {\n\t\tawait this.bridge.stop();\n\t\tFederationFactoryEE.removeAllListeners();\n\t\tawait super.cleanUpHandlers();\n\t}\n\n\tpublic async created(): Promise<void> {\n\t\tawait super.setupFederation();\n\t\tawait this.startFederation();\n\t}\n\n\tpublic async stopped(): Promise<void> {\n\t\tawait this.stopFederation();\n\t\tawait super.stopped();\n\t}\n}\n\nexport class FederationServiceEE extends AbstractBaseFederationServiceEE implements IFederationServiceEE {\n\tprotected name = 'federation-enterprise';\n\n\tpublic async createDirectMessageRoom(internalUserId: string, invitees: string[]): Promise<void> {\n\t\tawait this.directMessageRoomServiceSenderEE.createInternalLocalDirectMessageRoom(\n\t\t\tFederationRoomSenderConverterEE.toCreateDirectMessageDto(internalUserId, invitees),\n\t\t);\n\t}\n\n\tpublic async searchPublicRooms(\n\t\tserverName?: string,\n\t\troomName?: string,\n\t\tpageToken?: string,\n\t\tcount?: number,\n\t): Promise<\n\t\tFederationPaginatedResult<{\n\t\t\trooms: IFederationPublicRooms[];\n\t\t}>\n\t> {\n\t\treturn this.internalRoomServiceSenderEE.searchPublicRooms(\n\t\t\tnew FederationSearchPublicRoomsInputDto({\n\t\t\t\tserverName,\n\t\t\t\troomName,\n\t\t\t\tpageToken,\n\t\t\t\tcount,\n\t\t\t}),\n\t\t);\n\t}\n\n\tpublic async getSearchedServerNamesByInternalUserId(\n\t\tinternalUserId: string,\n\t): Promise<{ name: string; default: boolean; local: boolean }[]> {\n\t\treturn this.internalUserServiceEE.getSearchedServerNamesByInternalUserId(internalUserId);\n\t}\n\n\tpublic async addSearchedServerNameByInternalUserId(internalUserId: string, serverName: string): Promise<void> {\n\t\treturn this.internalUserServiceEE.addSearchedServerNameByInternalUserId(internalUserId, serverName);\n\t}\n\n\tpublic async removeSearchedServerNameByInternalUserId(internalUserId: string, serverName: string): Promise<void> {\n\t\treturn this.internalUserServiceEE.removeSearchedServerNameByInternalUserId(internalUserId, serverName);\n\t}\n\n\tpublic async scheduleJoinExternalPublicRoom(\n\t\tinternalUserId: string,\n\t\texternalRoomId: string,\n\t\troomName?: string,\n\t\tpageToken?: string,\n\t): Promise<void> {\n\t\tawait this.internalRoomServiceSenderEE.scheduleJoinExternalPublicRoom(internalUserId, externalRoomId, roomName, pageToken);\n\t}\n\n\tpublic async joinExternalPublicRoom(input: IFederationJoinExternalPublicRoomInput): Promise<void> {\n\t\tconst { internalUserId, externalRoomId, roomName, pageToken } = input;\n\t\tawait this.internalRoomServiceSenderEE.joinExternalPublicRoom(\n\t\t\tFederationRoomSenderConverterEE.toJoinExternalPublicRoomDto(internalUserId, externalRoomId, roomName, pageToken),\n\t\t);\n\t}\n\n\tpublic async verifyMatrixIds(matrixIds: string[]): Promise<Map<string, string>> {\n\t\treturn super.verifyMatrixIds(matrixIds);\n\t}\n\n\tstatic async createFederationService(): Promise<FederationServiceEE> {\n\t\tconst federationService = new FederationServiceEE();\n\t\tawait federationService.initialize();\n\t\treturn federationService;\n\t}\n\n\tasync created(): Promise<void> {\n\t\treturn super.created();\n\t}\n\n\tasync stopped(): Promise<void> {\n\t\treturn super.stopped();\n\t}\n\n\tpublic async verifyConfiguration(): Promise<void> {\n\t\treturn super.verifyConfiguration();\n\t}\n\n\tpublic async markConfigurationValid(): Promise<void> {\n\t\treturn super.markConfigurationValid();\n\t}\n\n\tpublic async markConfigurationInvalid(): Promise<void> {\n\t\treturn super.markConfigurationInvalid();\n\t}\n\n\tpublic async configurationStatus(): Promise<FederationConfigurationStatus> {\n\t\treturn super.configurationStatus();\n\t}\n\n\tpublic async beforeCreateRoom(room: Partial<IRoom>): Promise<void> {\n\t\treturn super.beforeCreateRoom(room);\n\t}\n\n\tasync deactivateRemoteUser(userId: string): Promise<void> {\n\t\treturn super.deactivateRemoteUser(userId);\n\t}\n}\n"]}}},"code":"!module.wrapAsync(async function (module, __reifyWaitForDeps__, __reify_async_result__) {\n  \"use strict\";\n  try {\n    module.export({\n      FederationServiceEE: () => FederationServiceEE\n    });\n    let FederationSearchPublicRoomsInputDto;\n    module.link(\"./application/room/sender/input/RoomInputDto\", {\n      FederationSearchPublicRoomsInputDto(v) {\n        FederationSearchPublicRoomsInputDto = v;\n      }\n    }, 0);\n    let FederationFactoryEE;\n    module.link(\"./infrastructure/Factory\", {\n      FederationFactoryEE(v) {\n        FederationFactoryEE = v;\n      }\n    }, 1);\n    let FederationRoomSenderConverterEE;\n    module.link(\"./infrastructure/rocket-chat/converters/RoomSender\", {\n      FederationRoomSenderConverterEE(v) {\n        FederationRoomSenderConverterEE = v;\n      }\n    }, 2);\n    let AbstractFederationService;\n    module.link(\"../../../../server/services/federation/service\", {\n      AbstractFederationService(v) {\n        AbstractFederationService = v;\n      }\n    }, 3);\n    if (__reifyWaitForDeps__()) (await __reifyWaitForDeps__())();\n    class AbstractBaseFederationServiceEE extends AbstractFederationService {\n      constructor() {\n        const internalQueueInstance = FederationFactoryEE.buildFederationQueue();\n        const internalSettingsAdapter = FederationFactoryEE.buildInternalSettingsAdapter();\n        const bridgeEE = FederationFactoryEE.buildFederationBridge(internalSettingsAdapter, internalQueueInstance);\n        super(bridgeEE, internalQueueInstance, internalSettingsAdapter);\n        this.internalUserServiceEE = void 0;\n        this.directMessageRoomServiceSenderEE = void 0;\n        this.internalRoomServiceSenderEE = void 0;\n        this.internalRoomAdapterEE = void 0;\n        this.internalUserAdapterEE = void 0;\n        this.internalRoomAdapterEE = FederationFactoryEE.buildInternalRoomAdapter();\n        this.internalUserAdapterEE = FederationFactoryEE.buildInternalUserAdapter();\n        this.internalUserServiceEE = FederationFactoryEE.buildRoomApplicationService(this.getInternalSettingsAdapter(), this.internalUserAdapterEE, this.getInternalFileAdapter(), this.getBridge());\n        this.directMessageRoomServiceSenderEE = FederationFactoryEE.buildDirectMessageRoomServiceSender(this.internalRoomAdapterEE, this.internalUserAdapterEE, this.getInternalFileAdapter(), this.getInternalSettingsAdapter(), this.getBridge());\n        this.internalRoomServiceSenderEE = FederationFactoryEE.buildRoomServiceSenderEE(this.internalRoomAdapterEE, this.internalUserAdapterEE, this.getInternalFileAdapter(), this.getInternalSettingsAdapter(), this.getInternalMessageAdapter(), this.getInternalNotificationAdapter(), FederationFactoryEE.buildInternalQueueAdapter(), this.getBridge());\n      }\n      async setupInternalEphemeralListeners() {\n        await this.getInternalNotificationAdapter().subscribeToUserTypingEventsOnFederatedRooms(this.getInternalNotificationAdapter().broadcastUserTypingOnRoom.bind(this.getInternalNotificationAdapter()));\n      }\n      async setupInternalValidators() {\n        const internalRoomHooksValidator = FederationFactoryEE.buildRoomInternalValidator(this.internalRoomAdapterEE, this.internalUserAdapterEE, this.getInternalFileAdapter(), this.getInternalSettingsAdapter(), this.getBridge());\n        FederationFactoryEE.setupValidators(internalRoomHooksValidator);\n      }\n      async setupInternalActionListeners() {\n        const internalRoomServiceSender = FederationFactoryEE.buildRoomServiceSender(this.internalRoomAdapterEE, this.internalUserAdapterEE, this.getInternalFileAdapter(), this.getInternalMessageAdapter(), this.getInternalSettingsAdapter(), this.getInternalNotificationAdapter(), this.getBridge());\n        const internalMessageServiceSender = FederationFactoryEE.buildMessageServiceSender(this.internalRoomAdapterEE, this.internalUserAdapterEE, this.getInternalSettingsAdapter(), this.getInternalMessageAdapter(), this.getBridge());\n        FederationFactoryEE.setupListenersForLocalActions(internalRoomServiceSender, internalMessageServiceSender);\n        FederationFactoryEE.setupListenersForLocalActionsEE(this.internalRoomServiceSenderEE, this.directMessageRoomServiceSenderEE, this.getInternalSettingsAdapter());\n      }\n      async onEnableFederation() {\n        await super.setupFederation();\n        await this.startFederation();\n      }\n      async onDisableFederation() {\n        await this.stopFederation();\n      }\n      getBridge() {\n        return this.bridge;\n      }\n      async startFederation() {\n        if (!this.isFederationEnabled()) {\n          return;\n        }\n        await this.bridge.start();\n        this.bridge.logFederationStartupInfo('Running Federation Enterprise V2');\n        FederationFactoryEE.removeCEValidators();\n        await module.dynamicImport('./infrastructure/rocket-chat/slash-commands');\n        await module.dynamicImport('../../api/federation');\n      }\n      async stopFederation() {\n        await this.bridge.stop();\n        FederationFactoryEE.removeAllListeners();\n        await super.cleanUpHandlers();\n      }\n      async created() {\n        await super.setupFederation();\n        await this.startFederation();\n      }\n      async stopped() {\n        await this.stopFederation();\n        await super.stopped();\n      }\n    }\n    class FederationServiceEE extends AbstractBaseFederationServiceEE {\n      constructor() {\n        super(...arguments);\n        this.name = 'federation-enterprise';\n      }\n      async createDirectMessageRoom(internalUserId, invitees) {\n        await this.directMessageRoomServiceSenderEE.createInternalLocalDirectMessageRoom(FederationRoomSenderConverterEE.toCreateDirectMessageDto(internalUserId, invitees));\n      }\n      async searchPublicRooms(serverName, roomName, pageToken, count) {\n        return this.internalRoomServiceSenderEE.searchPublicRooms(new FederationSearchPublicRoomsInputDto({\n          serverName,\n          roomName,\n          pageToken,\n          count\n        }));\n      }\n      async getSearchedServerNamesByInternalUserId(internalUserId) {\n        return this.internalUserServiceEE.getSearchedServerNamesByInternalUserId(internalUserId);\n      }\n      async addSearchedServerNameByInternalUserId(internalUserId, serverName) {\n        return this.internalUserServiceEE.addSearchedServerNameByInternalUserId(internalUserId, serverName);\n      }\n      async removeSearchedServerNameByInternalUserId(internalUserId, serverName) {\n        return this.internalUserServiceEE.removeSearchedServerNameByInternalUserId(internalUserId, serverName);\n      }\n      async scheduleJoinExternalPublicRoom(internalUserId, externalRoomId, roomName, pageToken) {\n        await this.internalRoomServiceSenderEE.scheduleJoinExternalPublicRoom(internalUserId, externalRoomId, roomName, pageToken);\n      }\n      async joinExternalPublicRoom(input) {\n        const {\n          internalUserId,\n          externalRoomId,\n          roomName,\n          pageToken\n        } = input;\n        await this.internalRoomServiceSenderEE.joinExternalPublicRoom(FederationRoomSenderConverterEE.toJoinExternalPublicRoomDto(internalUserId, externalRoomId, roomName, pageToken));\n      }\n      async verifyMatrixIds(matrixIds) {\n        return super.verifyMatrixIds(matrixIds);\n      }\n      static async createFederationService() {\n        const federationService = new FederationServiceEE();\n        await federationService.initialize();\n        return federationService;\n      }\n      async created() {\n        return super.created();\n      }\n      async stopped() {\n        return super.stopped();\n      }\n      async verifyConfiguration() {\n        return super.verifyConfiguration();\n      }\n      async markConfigurationValid() {\n        return super.markConfigurationValid();\n      }\n      async markConfigurationInvalid() {\n        return super.markConfigurationInvalid();\n      }\n      async configurationStatus() {\n        return super.configurationStatus();\n      }\n      async beforeCreateRoom(room) {\n        return super.beforeCreateRoom(room);\n      }\n      async deactivateRemoteUser(userId) {\n        return super.deactivateRemoteUser(userId);\n      }\n    }\n    __reify_async_result__();\n  } catch (_reifyError) {\n    return __reify_async_result__(_reifyError);\n  }\n  __reify_async_result__()\n}, {\n  self: this,\n  async: false\n});","map":{"version":3,"names":["module","export","FederationServiceEE","FederationSearchPublicRoomsInputDto","link","v","FederationFactoryEE","FederationRoomSenderConverterEE","AbstractFederationService","__reifyWaitForDeps__","AbstractBaseFederationServiceEE","constructor","internalQueueInstance","buildFederationQueue","internalSettingsAdapter","buildInternalSettingsAdapter","bridgeEE","buildFederationBridge","internalUserServiceEE","directMessageRoomServiceSenderEE","internalRoomServiceSenderEE","internalRoomAdapterEE","internalUserAdapterEE","buildInternalRoomAdapter","buildInternalUserAdapter","buildRoomApplicationService","getInternalSettingsAdapter","getInternalFileAdapter","getBridge","buildDirectMessageRoomServiceSender","buildRoomServiceSenderEE","getInternalMessageAdapter","getInternalNotificationAdapter","buildInternalQueueAdapter","setupInternalEphemeralListeners","subscribeToUserTypingEventsOnFederatedRooms","broadcastUserTypingOnRoom","bind","setupInternalValidators","internalRoomHooksValidator","buildRoomInternalValidator","setupValidators","setupInternalActionListeners","internalRoomServiceSender","buildRoomServiceSender","internalMessageServiceSender","buildMessageServiceSender","setupListenersForLocalActions","setupListenersForLocalActionsEE","onEnableFederation","setupFederation","startFederation","onDisableFederation","stopFederation","bridge","isFederationEnabled","start","logFederationStartupInfo","removeCEValidators","dynamicImport","stop","removeAllListeners","cleanUpHandlers","created","stopped","arguments","name","createDirectMessageRoom","internalUserId","invitees","createInternalLocalDirectMessageRoom","toCreateDirectMessageDto","searchPublicRooms","serverName","roomName","pageToken","count","getSearchedServerNamesByInternalUserId","addSearchedServerNameByInternalUserId","removeSearchedServerNameByInternalUserId","scheduleJoinExternalPublicRoom","externalRoomId","joinExternalPublicRoom","input","toJoinExternalPublicRoomDto","verifyMatrixIds","matrixIds","createFederationService","federationService","initialize","verifyConfiguration","markConfigurationValid","markConfigurationInvalid","configurationStatus","beforeCreateRoom","room","deactivateRemoteUser","userId","__reify_async_result__","_reifyError","self","async"],"sources":["ee/server/local-services/federation/service.ts"],"sourcesContent":["import type {\n\tIFederationServiceEE,\n\tIFederationJoinExternalPublicRoomInput,\n\tFederationConfigurationStatus,\n} from '@rocket.chat/core-services';\nimport type { IRoom } from '@rocket.chat/core-typings';\nimport type { FederationPaginatedResult, IFederationPublicRooms } from '@rocket.chat/rest-typings';\n\nimport type { FederationUserServiceEE } from './application/UserService';\nimport type { FederationDirectMessageRoomServiceSender } from './application/room/sender/DirectMessageRoomServiceSender';\nimport type { FederationRoomServiceSender } from './application/room/sender/RoomServiceSender';\nimport { FederationSearchPublicRoomsInputDto } from './application/room/sender/input/RoomInputDto';\nimport type { IFederationBridgeEE } from './domain/IFederationBridge';\nimport { FederationFactoryEE } from './infrastructure/Factory';\nimport type { RocketChatRoomAdapterEE } from './infrastructure/rocket-chat/adapters/Room';\nimport type { RocketChatUserAdapterEE } from './infrastructure/rocket-chat/adapters/User';\nimport { FederationRoomSenderConverterEE } from './infrastructure/rocket-chat/converters/RoomSender';\nimport { AbstractFederationService } from '../../../../server/services/federation/service';\n\nabstract class AbstractBaseFederationServiceEE extends AbstractFederationService {\n\tprotected internalUserServiceEE: FederationUserServiceEE;\n\n\tprotected directMessageRoomServiceSenderEE: FederationDirectMessageRoomServiceSender;\n\n\tprotected internalRoomServiceSenderEE: FederationRoomServiceSender;\n\n\tprotected internalRoomAdapterEE: RocketChatRoomAdapterEE;\n\n\tprotected internalUserAdapterEE: RocketChatUserAdapterEE;\n\n\tconstructor() {\n\t\tconst internalQueueInstance = FederationFactoryEE.buildFederationQueue();\n\t\tconst internalSettingsAdapter = FederationFactoryEE.buildInternalSettingsAdapter();\n\t\tconst bridgeEE = FederationFactoryEE.buildFederationBridge(internalSettingsAdapter, internalQueueInstance);\n\t\tsuper(bridgeEE, internalQueueInstance, internalSettingsAdapter);\n\n\t\tthis.internalRoomAdapterEE = FederationFactoryEE.buildInternalRoomAdapter();\n\t\tthis.internalUserAdapterEE = FederationFactoryEE.buildInternalUserAdapter();\n\t\tthis.internalUserServiceEE = FederationFactoryEE.buildRoomApplicationService(\n\t\t\tthis.getInternalSettingsAdapter(),\n\t\t\tthis.internalUserAdapterEE,\n\t\t\tthis.getInternalFileAdapter(),\n\t\t\tthis.getBridge(),\n\t\t);\n\t\tthis.directMessageRoomServiceSenderEE = FederationFactoryEE.buildDirectMessageRoomServiceSender(\n\t\t\tthis.internalRoomAdapterEE,\n\t\t\tthis.internalUserAdapterEE,\n\t\t\tthis.getInternalFileAdapter(),\n\t\t\tthis.getInternalSettingsAdapter(),\n\t\t\tthis.getBridge(),\n\t\t);\n\t\tthis.internalRoomServiceSenderEE = FederationFactoryEE.buildRoomServiceSenderEE(\n\t\t\tthis.internalRoomAdapterEE,\n\t\t\tthis.internalUserAdapterEE,\n\t\t\tthis.getInternalFileAdapter(),\n\t\t\tthis.getInternalSettingsAdapter(),\n\t\t\tthis.getInternalMessageAdapter(),\n\t\t\tthis.getInternalNotificationAdapter(),\n\t\t\tFederationFactoryEE.buildInternalQueueAdapter(),\n\t\t\tthis.getBridge(),\n\t\t);\n\t}\n\n\tprotected async setupInternalEphemeralListeners(): Promise<void> {\n\t\tawait this.getInternalNotificationAdapter().subscribeToUserTypingEventsOnFederatedRooms(\n\t\t\tthis.getInternalNotificationAdapter().broadcastUserTypingOnRoom.bind(this.getInternalNotificationAdapter()),\n\t\t);\n\t}\n\n\tprotected async setupInternalValidators(): Promise<void> {\n\t\tconst internalRoomHooksValidator = FederationFactoryEE.buildRoomInternalValidator(\n\t\t\tthis.internalRoomAdapterEE,\n\t\t\tthis.internalUserAdapterEE,\n\t\t\tthis.getInternalFileAdapter(),\n\t\t\tthis.getInternalSettingsAdapter(),\n\t\t\tthis.getBridge(),\n\t\t);\n\t\tFederationFactoryEE.setupValidators(internalRoomHooksValidator);\n\t}\n\n\tprotected async setupInternalActionListeners(): Promise<void> {\n\t\tconst internalRoomServiceSender = FederationFactoryEE.buildRoomServiceSender(\n\t\t\tthis.internalRoomAdapterEE,\n\t\t\tthis.internalUserAdapterEE,\n\t\t\tthis.getInternalFileAdapter(),\n\t\t\tthis.getInternalMessageAdapter(),\n\t\t\tthis.getInternalSettingsAdapter(),\n\t\t\tthis.getInternalNotificationAdapter(),\n\t\t\tthis.getBridge(),\n\t\t);\n\t\tconst internalMessageServiceSender = FederationFactoryEE.buildMessageServiceSender(\n\t\t\tthis.internalRoomAdapterEE,\n\t\t\tthis.internalUserAdapterEE,\n\t\t\tthis.getInternalSettingsAdapter(),\n\t\t\tthis.getInternalMessageAdapter(),\n\t\t\tthis.getBridge(),\n\t\t);\n\t\tFederationFactoryEE.setupListenersForLocalActions(internalRoomServiceSender, internalMessageServiceSender);\n\t\tFederationFactoryEE.setupListenersForLocalActionsEE(\n\t\t\tthis.internalRoomServiceSenderEE,\n\t\t\tthis.directMessageRoomServiceSenderEE,\n\t\t\tthis.getInternalSettingsAdapter(),\n\t\t);\n\t}\n\n\tprotected async onEnableFederation(): Promise<void> {\n\t\tawait super.setupFederation();\n\t\tawait this.startFederation();\n\t}\n\n\tprotected async onDisableFederation(): Promise<void> {\n\t\tawait this.stopFederation();\n\t}\n\n\tprivate getBridge(): IFederationBridgeEE {\n\t\treturn this.bridge as IFederationBridgeEE;\n\t}\n\n\tprivate async startFederation(): Promise<void> {\n\t\tif (!this.isFederationEnabled()) {\n\t\t\treturn;\n\t\t}\n\t\tawait this.bridge.start();\n\t\tthis.bridge.logFederationStartupInfo('Running Federation Enterprise V2');\n\t\tFederationFactoryEE.removeCEValidators();\n\t\tawait import('./infrastructure/rocket-chat/slash-commands');\n\t\tawait import('../../api/federation');\n\t}\n\n\tprivate async stopFederation(): Promise<void> {\n\t\tawait this.bridge.stop();\n\t\tFederationFactoryEE.removeAllListeners();\n\t\tawait super.cleanUpHandlers();\n\t}\n\n\tpublic async created(): Promise<void> {\n\t\tawait super.setupFederation();\n\t\tawait this.startFederation();\n\t}\n\n\tpublic async stopped(): Promise<void> {\n\t\tawait this.stopFederation();\n\t\tawait super.stopped();\n\t}\n}\n\nexport class FederationServiceEE extends AbstractBaseFederationServiceEE implements IFederationServiceEE {\n\tprotected name = 'federation-enterprise';\n\n\tpublic async createDirectMessageRoom(internalUserId: string, invitees: string[]): Promise<void> {\n\t\tawait this.directMessageRoomServiceSenderEE.createInternalLocalDirectMessageRoom(\n\t\t\tFederationRoomSenderConverterEE.toCreateDirectMessageDto(internalUserId, invitees),\n\t\t);\n\t}\n\n\tpublic async searchPublicRooms(\n\t\tserverName?: string,\n\t\troomName?: string,\n\t\tpageToken?: string,\n\t\tcount?: number,\n\t): Promise<\n\t\tFederationPaginatedResult<{\n\t\t\trooms: IFederationPublicRooms[];\n\t\t}>\n\t> {\n\t\treturn this.internalRoomServiceSenderEE.searchPublicRooms(\n\t\t\tnew FederationSearchPublicRoomsInputDto({\n\t\t\t\tserverName,\n\t\t\t\troomName,\n\t\t\t\tpageToken,\n\t\t\t\tcount,\n\t\t\t}),\n\t\t);\n\t}\n\n\tpublic async getSearchedServerNamesByInternalUserId(\n\t\tinternalUserId: string,\n\t): Promise<{ name: string; default: boolean; local: boolean }[]> {\n\t\treturn this.internalUserServiceEE.getSearchedServerNamesByInternalUserId(internalUserId);\n\t}\n\n\tpublic async addSearchedServerNameByInternalUserId(internalUserId: string, serverName: string): Promise<void> {\n\t\treturn this.internalUserServiceEE.addSearchedServerNameByInternalUserId(internalUserId, serverName);\n\t}\n\n\tpublic async removeSearchedServerNameByInternalUserId(internalUserId: string, serverName: string): Promise<void> {\n\t\treturn this.internalUserServiceEE.removeSearchedServerNameByInternalUserId(internalUserId, serverName);\n\t}\n\n\tpublic async scheduleJoinExternalPublicRoom(\n\t\tinternalUserId: string,\n\t\texternalRoomId: string,\n\t\troomName?: string,\n\t\tpageToken?: string,\n\t): Promise<void> {\n\t\tawait this.internalRoomServiceSenderEE.scheduleJoinExternalPublicRoom(internalUserId, externalRoomId, roomName, pageToken);\n\t}\n\n\tpublic async joinExternalPublicRoom(input: IFederationJoinExternalPublicRoomInput): Promise<void> {\n\t\tconst { internalUserId, externalRoomId, roomName, pageToken } = input;\n\t\tawait this.internalRoomServiceSenderEE.joinExternalPublicRoom(\n\t\t\tFederationRoomSenderConverterEE.toJoinExternalPublicRoomDto(internalUserId, externalRoomId, roomName, pageToken),\n\t\t);\n\t}\n\n\tpublic async verifyMatrixIds(matrixIds: string[]): Promise<Map<string, string>> {\n\t\treturn super.verifyMatrixIds(matrixIds);\n\t}\n\n\tstatic async createFederationService(): Promise<FederationServiceEE> {\n\t\tconst federationService = new FederationServiceEE();\n\t\tawait federationService.initialize();\n\t\treturn federationService;\n\t}\n\n\tasync created(): Promise<void> {\n\t\treturn super.created();\n\t}\n\n\tasync stopped(): Promise<void> {\n\t\treturn super.stopped();\n\t}\n\n\tpublic async verifyConfiguration(): Promise<void> {\n\t\treturn super.verifyConfiguration();\n\t}\n\n\tpublic async markConfigurationValid(): Promise<void> {\n\t\treturn super.markConfigurationValid();\n\t}\n\n\tpublic async markConfigurationInvalid(): Promise<void> {\n\t\treturn super.markConfigurationInvalid();\n\t}\n\n\tpublic async configurationStatus(): Promise<FederationConfigurationStatus> {\n\t\treturn super.configurationStatus();\n\t}\n\n\tpublic async beforeCreateRoom(room: Partial<IRoom>): Promise<void> {\n\t\treturn super.beforeCreateRoom(room);\n\t}\n\n\tasync deactivateRemoteUser(userId: string): Promise<void> {\n\t\treturn super.deactivateRemoteUser(userId);\n\t}\n}\n"],"mappings":"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","ignoreList":[]},"sourceType":"module","externalDependencies":{},"hash":"1f5fd8121ceb598b90aa5f7fba4f35ca2020994e"}
