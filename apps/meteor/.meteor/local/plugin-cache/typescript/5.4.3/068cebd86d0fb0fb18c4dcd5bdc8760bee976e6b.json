{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/client/lib/chats/flows/uploadFiles.ts","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","topLevelAwait","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"web.browser.legacy"},"sourceFileName":"client/lib/chats/flows/uploadFiles.ts","filename":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/client/lib/chats/flows/uploadFiles.ts","inputSourceMap":{"version":3,"file":"client/lib/chats/flows/uploadFiles.ts","sourceRoot":"","sources":["client/lib/chats/flows/uploadFiles.ts"],"names":[],"mappings":"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","sourcesContent":["import type { IMessage, FileAttachmentProps, IE2EEMessage, IUpload } from '@rocket.chat/core-typings';\nimport { isRoomFederated } from '@rocket.chat/core-typings';\n\nimport { e2e } from '../../../../app/e2e/client';\nimport { settings } from '../../../../app/settings/client';\nimport { fileUploadIsValidContentType } from '../../../../app/utils/client';\nimport { getFileExtension } from '../../../../lib/utils/getFileExtension';\nimport FileUploadModal from '../../../views/room/modals/FileUploadModal';\nimport { imperativeModal } from '../../imperativeModal';\nimport { prependReplies } from '../../utils/prependReplies';\nimport type { ChatAPI } from '../ChatAPI';\n\nconst getHeightAndWidthFromDataUrl = (dataURL: string): Promise<{ height: number; width: number }> => {\n\treturn new Promise((resolve) => {\n\t\tconst img = new Image();\n\t\timg.onload = () => {\n\t\t\tresolve({\n\t\t\t\theight: img.height,\n\t\t\t\twidth: img.width,\n\t\t\t});\n\t\t};\n\t\timg.src = dataURL;\n\t});\n};\n\nexport const uploadFiles = async (chat: ChatAPI, files: readonly File[], resetFileInput?: () => void): Promise<void> => {\n\tconst replies = chat.composer?.quotedMessages.get() ?? [];\n\n\tconst msg = await prependReplies('', replies);\n\n\tconst room = await chat.data.getRoom();\n\n\tconst queue = [...files];\n\n\tconst uploadFile = (\n\t\tfile: File,\n\t\textraData?: Pick<IMessage, 't' | 'e2e'> & { description?: string },\n\t\tgetContent?: (fileId: string, fileUrl: string) => Promise<IE2EEMessage['content']>,\n\t\tfileContent?: { raw: Partial<IUpload>; encrypted: IE2EEMessage['content'] },\n\t) => {\n\t\tchat.uploads.send(\n\t\t\tfile,\n\t\t\t{\n\t\t\t\tmsg,\n\t\t\t\t...extraData,\n\t\t\t},\n\t\t\tgetContent,\n\t\t\tfileContent,\n\t\t);\n\t\tchat.composer?.clear();\n\t\timperativeModal.close();\n\t\tuploadNextFile();\n\t};\n\n\tconst uploadNextFile = (): void => {\n\t\tconst file = queue.pop();\n\t\tif (!file) {\n\t\t\tchat.composer?.dismissAllQuotedMessages();\n\t\t\treturn;\n\t\t}\n\n\t\timperativeModal.open({\n\t\t\tcomponent: FileUploadModal,\n\t\t\tprops: {\n\t\t\t\tfile,\n\t\t\t\tfileName: file.name,\n\t\t\t\tfileDescription: chat.composer?.text ?? '',\n\t\t\t\tshowDescription: room && !isRoomFederated(room),\n\t\t\t\tonClose: (): void => {\n\t\t\t\t\timperativeModal.close();\n\t\t\t\t\tuploadNextFile();\n\t\t\t\t},\n\t\t\t\tonSubmit: async (fileName: string, description?: string): Promise<void> => {\n\t\t\t\t\tObject.defineProperty(file, 'name', {\n\t\t\t\t\t\twritable: true,\n\t\t\t\t\t\tvalue: fileName,\n\t\t\t\t\t});\n\n\t\t\t\t\t// encrypt attachment description\n\t\t\t\t\tconst e2eRoom = await e2e.getInstanceByRoomId(room._id);\n\n\t\t\t\t\tif (!e2eRoom) {\n\t\t\t\t\t\tuploadFile(file, { description });\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tif (!settings.get('E2E_Enable_Encrypt_Files')) {\n\t\t\t\t\t\tuploadFile(file, { description });\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tconst shouldConvertSentMessages = await e2eRoom.shouldConvertSentMessages({ msg });\n\n\t\t\t\t\tif (!shouldConvertSentMessages) {\n\t\t\t\t\t\tuploadFile(file, { description });\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tconst encryptedFile = await e2eRoom.encryptFile(file);\n\n\t\t\t\t\tif (encryptedFile) {\n\t\t\t\t\t\tconst getContent = async (_id: string, fileUrl: string): Promise<IE2EEMessage['content']> => {\n\t\t\t\t\t\t\tconst attachments = [];\n\n\t\t\t\t\t\t\tconst attachment: FileAttachmentProps = {\n\t\t\t\t\t\t\t\ttitle: file.name,\n\t\t\t\t\t\t\t\ttype: 'file',\n\t\t\t\t\t\t\t\tdescription,\n\t\t\t\t\t\t\t\ttitle_link: fileUrl,\n\t\t\t\t\t\t\t\ttitle_link_download: true,\n\t\t\t\t\t\t\t\tencryption: {\n\t\t\t\t\t\t\t\t\tkey: encryptedFile.key,\n\t\t\t\t\t\t\t\t\tiv: encryptedFile.iv,\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\thashes: {\n\t\t\t\t\t\t\t\t\tsha256: encryptedFile.hash,\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t};\n\n\t\t\t\t\t\t\tif (/^image\\/.+/.test(file.type)) {\n\t\t\t\t\t\t\t\tconst dimensions = await getHeightAndWidthFromDataUrl(window.URL.createObjectURL(file));\n\n\t\t\t\t\t\t\t\tattachments.push({\n\t\t\t\t\t\t\t\t\t...attachment,\n\t\t\t\t\t\t\t\t\timage_url: fileUrl,\n\t\t\t\t\t\t\t\t\timage_type: file.type,\n\t\t\t\t\t\t\t\t\timage_size: file.size,\n\t\t\t\t\t\t\t\t\t...(dimensions && {\n\t\t\t\t\t\t\t\t\t\timage_dimensions: dimensions,\n\t\t\t\t\t\t\t\t\t}),\n\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t} else if (/^audio\\/.+/.test(file.type)) {\n\t\t\t\t\t\t\t\tattachments.push({\n\t\t\t\t\t\t\t\t\t...attachment,\n\t\t\t\t\t\t\t\t\taudio_url: fileUrl,\n\t\t\t\t\t\t\t\t\taudio_type: file.type,\n\t\t\t\t\t\t\t\t\taudio_size: file.size,\n\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t} else if (/^video\\/.+/.test(file.type)) {\n\t\t\t\t\t\t\t\tattachments.push({\n\t\t\t\t\t\t\t\t\t...attachment,\n\t\t\t\t\t\t\t\t\tvideo_url: fileUrl,\n\t\t\t\t\t\t\t\t\tvideo_type: file.type,\n\t\t\t\t\t\t\t\t\tvideo_size: file.size,\n\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\tattachments.push({\n\t\t\t\t\t\t\t\t\t...attachment,\n\t\t\t\t\t\t\t\t\tsize: file.size,\n\t\t\t\t\t\t\t\t\tformat: getFileExtension(file.name),\n\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\tconst files = [\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t_id,\n\t\t\t\t\t\t\t\t\tname: file.name,\n\t\t\t\t\t\t\t\t\ttype: file.type,\n\t\t\t\t\t\t\t\t\tsize: file.size,\n\t\t\t\t\t\t\t\t\t// \"format\": \"png\"\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t];\n\n\t\t\t\t\t\t\treturn e2eRoom.encryptMessageContent({\n\t\t\t\t\t\t\t\tattachments,\n\t\t\t\t\t\t\t\tfiles,\n\t\t\t\t\t\t\t\tfile: files[0],\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t};\n\n\t\t\t\t\t\tconst fileContentData = {\n\t\t\t\t\t\t\ttype: file.type,\n\t\t\t\t\t\t\ttypeGroup: file.type.split('/')[0],\n\t\t\t\t\t\t\tname: fileName,\n\t\t\t\t\t\t\tencryption: {\n\t\t\t\t\t\t\t\tkey: encryptedFile.key,\n\t\t\t\t\t\t\t\tiv: encryptedFile.iv,\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\thashes: {\n\t\t\t\t\t\t\t\tsha256: encryptedFile.hash,\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t};\n\n\t\t\t\t\t\tconst fileContent = {\n\t\t\t\t\t\t\traw: fileContentData,\n\t\t\t\t\t\t\tencrypted: await e2eRoom.encryptMessageContent(fileContentData),\n\t\t\t\t\t\t};\n\n\t\t\t\t\t\tuploadFile(\n\t\t\t\t\t\t\tencryptedFile.file,\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tt: 'e2e',\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\tgetContent,\n\t\t\t\t\t\t\tfileContent,\n\t\t\t\t\t\t);\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\tinvalidContentType: !fileUploadIsValidContentType(file?.type),\n\t\t\t},\n\t\t});\n\t};\n\n\tuploadNextFile();\n\tresetFileInput?.();\n};\n"]},"targets":{"android":"125.0.0","chrome":"125.0.0","edge":"125.0.0","firefox":"115.0.0","ie":"10.0.0","ios":"17.4.0","opera":"110.0.0","opera_mobile":"80.0.0","safari":"17.4.0","samsung":"24.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor","root":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":true,"enforceStrictMode":false,"dynamicImport":true},"externalDependencies":[]},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"version":"7.17.2","helpers":true,"useESModules":false,"corejs":false},"externalDependencies":[]},{"key":"proposal-class-properties","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true},"externalDependencies":[]},{"key":"base$0$3","visitor":{"FunctionExpression":{"exit":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"base$0$4","visitor":{"ForInStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-react-jsx","visitor":{"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXFragment":{"exit":[null]},"JSXElement":{"exit":[null]},"JSXAttribute":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false},"externalDependencies":[]},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-nullish-coalescing-operator","visitor":{"LogicalExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-optional-chaining","visitor":{"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-optional-catch-binding","visitor":{"CatchClause":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-class-properties","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-async-generator-functions","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-logical-assignment-operators","visitor":{"AssignmentExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-arrow-functions","visitor":{"ArrowFunctionExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-block-scoped-functions","visitor":{"BlockStatement":{"enter":[null]},"SwitchCase":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-block-scoping","visitor":{"VariableDeclaration":{"enter":[null,null]},"BlockStatement":{"enter":[null]},"SwitchCase":{"enter":[null]},"ClassDeclaration":{"enter":[null]},"DoWhileStatement":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForStatement":{"enter":[null]},"WhileStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-classes","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"ClassDeclaration":{"enter":[null]},"ClassExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"loose":true},"externalDependencies":[]},{"key":"transform-computed-properties","visitor":{"ObjectExpression":{"exit":[null]},"_exploded":true,"_verified":true},"options":{"loose":true},"externalDependencies":[]},{"key":"transform-destructuring","visitor":{"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"VariableDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"transform-for-of","visitor":{"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"loose":true},"externalDependencies":[]},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-object-super","visitor":{"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true,"DoWhileStatement":{"exit":[null]},"ForInStatement":{"exit":[null]},"ForStatement":{"exit":[null]},"WhileStatement":{"exit":[null]},"ForOfStatement":{"exit":[null]}},"options":{},"externalDependencies":[]},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"transform-shorthand-properties","visitor":{"ObjectMethod":{"enter":[null]},"ObjectProperty":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-spread","visitor":{"ArrayExpression":{"enter":[null]},"CallExpression":{"enter":[null]},"NewExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-sticky-regex","visitor":{"RegExpLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"loose":true},"externalDependencies":[]},{"key":"transform-typeof-symbol","visitor":{"UnaryExpression":{"enter":[null]},"_exploded":true,"_verified":true,"BlockStatement":{"enter":[null]},"CatchClause":{"enter":[null]},"DoWhileStatement":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForStatement":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"Program":{"enter":[null]},"ObjectMethod":{"enter":[null]},"SwitchStatement":{"enter":[null]},"WhileStatement":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]},"ForOfStatement":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"StaticBlock":{"enter":[null]},"TSModuleBlock":{"enter":[null]},"AssignmentPattern":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectPattern":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"transform-unicode-regex","visitor":{"RegExpLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-property-literals","visitor":{"ObjectProperty":{"exit":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-regenerator","visitor":{"ObjectMethod":{"enter":[null],"exit":[null]},"ClassMethod":{"enter":[null],"exit":[null]},"ClassPrivateMethod":{"enter":[null],"exit":[null]},"FunctionDeclaration":{"exit":[null]},"FunctionExpression":{"exit":[null]},"ArrowFunctionExpression":{"exit":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]}],"presets":[],"generatorOpts":{"filename":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/client/lib/chats/flows/uploadFiles.ts","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"client/lib/chats/flows/uploadFiles.ts","inputSourceMap":{"version":3,"file":"client/lib/chats/flows/uploadFiles.ts","sourceRoot":"","sources":["client/lib/chats/flows/uploadFiles.ts"],"names":[],"mappings":"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","sourcesContent":["import type { IMessage, FileAttachmentProps, IE2EEMessage, IUpload } from '@rocket.chat/core-typings';\nimport { isRoomFederated } from '@rocket.chat/core-typings';\n\nimport { e2e } from '../../../../app/e2e/client';\nimport { settings } from '../../../../app/settings/client';\nimport { fileUploadIsValidContentType } from '../../../../app/utils/client';\nimport { getFileExtension } from '../../../../lib/utils/getFileExtension';\nimport FileUploadModal from '../../../views/room/modals/FileUploadModal';\nimport { imperativeModal } from '../../imperativeModal';\nimport { prependReplies } from '../../utils/prependReplies';\nimport type { ChatAPI } from '../ChatAPI';\n\nconst getHeightAndWidthFromDataUrl = (dataURL: string): Promise<{ height: number; width: number }> => {\n\treturn new Promise((resolve) => {\n\t\tconst img = new Image();\n\t\timg.onload = () => {\n\t\t\tresolve({\n\t\t\t\theight: img.height,\n\t\t\t\twidth: img.width,\n\t\t\t});\n\t\t};\n\t\timg.src = dataURL;\n\t});\n};\n\nexport const uploadFiles = async (chat: ChatAPI, files: readonly File[], resetFileInput?: () => void): Promise<void> => {\n\tconst replies = chat.composer?.quotedMessages.get() ?? [];\n\n\tconst msg = await prependReplies('', replies);\n\n\tconst room = await chat.data.getRoom();\n\n\tconst queue = [...files];\n\n\tconst uploadFile = (\n\t\tfile: File,\n\t\textraData?: Pick<IMessage, 't' | 'e2e'> & { description?: string },\n\t\tgetContent?: (fileId: string, fileUrl: string) => Promise<IE2EEMessage['content']>,\n\t\tfileContent?: { raw: Partial<IUpload>; encrypted: IE2EEMessage['content'] },\n\t) => {\n\t\tchat.uploads.send(\n\t\t\tfile,\n\t\t\t{\n\t\t\t\tmsg,\n\t\t\t\t...extraData,\n\t\t\t},\n\t\t\tgetContent,\n\t\t\tfileContent,\n\t\t);\n\t\tchat.composer?.clear();\n\t\timperativeModal.close();\n\t\tuploadNextFile();\n\t};\n\n\tconst uploadNextFile = (): void => {\n\t\tconst file = queue.pop();\n\t\tif (!file) {\n\t\t\tchat.composer?.dismissAllQuotedMessages();\n\t\t\treturn;\n\t\t}\n\n\t\timperativeModal.open({\n\t\t\tcomponent: FileUploadModal,\n\t\t\tprops: {\n\t\t\t\tfile,\n\t\t\t\tfileName: file.name,\n\t\t\t\tfileDescription: chat.composer?.text ?? '',\n\t\t\t\tshowDescription: room && !isRoomFederated(room),\n\t\t\t\tonClose: (): void => {\n\t\t\t\t\timperativeModal.close();\n\t\t\t\t\tuploadNextFile();\n\t\t\t\t},\n\t\t\t\tonSubmit: async (fileName: string, description?: string): Promise<void> => {\n\t\t\t\t\tObject.defineProperty(file, 'name', {\n\t\t\t\t\t\twritable: true,\n\t\t\t\t\t\tvalue: fileName,\n\t\t\t\t\t});\n\n\t\t\t\t\t// encrypt attachment description\n\t\t\t\t\tconst e2eRoom = await e2e.getInstanceByRoomId(room._id);\n\n\t\t\t\t\tif (!e2eRoom) {\n\t\t\t\t\t\tuploadFile(file, { description });\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tif (!settings.get('E2E_Enable_Encrypt_Files')) {\n\t\t\t\t\t\tuploadFile(file, { description });\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tconst shouldConvertSentMessages = await e2eRoom.shouldConvertSentMessages({ msg });\n\n\t\t\t\t\tif (!shouldConvertSentMessages) {\n\t\t\t\t\t\tuploadFile(file, { description });\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tconst encryptedFile = await e2eRoom.encryptFile(file);\n\n\t\t\t\t\tif (encryptedFile) {\n\t\t\t\t\t\tconst getContent = async (_id: string, fileUrl: string): Promise<IE2EEMessage['content']> => {\n\t\t\t\t\t\t\tconst attachments = [];\n\n\t\t\t\t\t\t\tconst attachment: FileAttachmentProps = {\n\t\t\t\t\t\t\t\ttitle: file.name,\n\t\t\t\t\t\t\t\ttype: 'file',\n\t\t\t\t\t\t\t\tdescription,\n\t\t\t\t\t\t\t\ttitle_link: fileUrl,\n\t\t\t\t\t\t\t\ttitle_link_download: true,\n\t\t\t\t\t\t\t\tencryption: {\n\t\t\t\t\t\t\t\t\tkey: encryptedFile.key,\n\t\t\t\t\t\t\t\t\tiv: encryptedFile.iv,\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\thashes: {\n\t\t\t\t\t\t\t\t\tsha256: encryptedFile.hash,\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t};\n\n\t\t\t\t\t\t\tif (/^image\\/.+/.test(file.type)) {\n\t\t\t\t\t\t\t\tconst dimensions = await getHeightAndWidthFromDataUrl(window.URL.createObjectURL(file));\n\n\t\t\t\t\t\t\t\tattachments.push({\n\t\t\t\t\t\t\t\t\t...attachment,\n\t\t\t\t\t\t\t\t\timage_url: fileUrl,\n\t\t\t\t\t\t\t\t\timage_type: file.type,\n\t\t\t\t\t\t\t\t\timage_size: file.size,\n\t\t\t\t\t\t\t\t\t...(dimensions && {\n\t\t\t\t\t\t\t\t\t\timage_dimensions: dimensions,\n\t\t\t\t\t\t\t\t\t}),\n\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t} else if (/^audio\\/.+/.test(file.type)) {\n\t\t\t\t\t\t\t\tattachments.push({\n\t\t\t\t\t\t\t\t\t...attachment,\n\t\t\t\t\t\t\t\t\taudio_url: fileUrl,\n\t\t\t\t\t\t\t\t\taudio_type: file.type,\n\t\t\t\t\t\t\t\t\taudio_size: file.size,\n\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t} else if (/^video\\/.+/.test(file.type)) {\n\t\t\t\t\t\t\t\tattachments.push({\n\t\t\t\t\t\t\t\t\t...attachment,\n\t\t\t\t\t\t\t\t\tvideo_url: fileUrl,\n\t\t\t\t\t\t\t\t\tvideo_type: file.type,\n\t\t\t\t\t\t\t\t\tvideo_size: file.size,\n\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\tattachments.push({\n\t\t\t\t\t\t\t\t\t...attachment,\n\t\t\t\t\t\t\t\t\tsize: file.size,\n\t\t\t\t\t\t\t\t\tformat: getFileExtension(file.name),\n\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\tconst files = [\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t_id,\n\t\t\t\t\t\t\t\t\tname: file.name,\n\t\t\t\t\t\t\t\t\ttype: file.type,\n\t\t\t\t\t\t\t\t\tsize: file.size,\n\t\t\t\t\t\t\t\t\t// \"format\": \"png\"\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t];\n\n\t\t\t\t\t\t\treturn e2eRoom.encryptMessageContent({\n\t\t\t\t\t\t\t\tattachments,\n\t\t\t\t\t\t\t\tfiles,\n\t\t\t\t\t\t\t\tfile: files[0],\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t};\n\n\t\t\t\t\t\tconst fileContentData = {\n\t\t\t\t\t\t\ttype: file.type,\n\t\t\t\t\t\t\ttypeGroup: file.type.split('/')[0],\n\t\t\t\t\t\t\tname: fileName,\n\t\t\t\t\t\t\tencryption: {\n\t\t\t\t\t\t\t\tkey: encryptedFile.key,\n\t\t\t\t\t\t\t\tiv: encryptedFile.iv,\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\thashes: {\n\t\t\t\t\t\t\t\tsha256: encryptedFile.hash,\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t};\n\n\t\t\t\t\t\tconst fileContent = {\n\t\t\t\t\t\t\traw: fileContentData,\n\t\t\t\t\t\t\tencrypted: await e2eRoom.encryptMessageContent(fileContentData),\n\t\t\t\t\t\t};\n\n\t\t\t\t\t\tuploadFile(\n\t\t\t\t\t\t\tencryptedFile.file,\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tt: 'e2e',\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\tgetContent,\n\t\t\t\t\t\t\tfileContent,\n\t\t\t\t\t\t);\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\tinvalidContentType: !fileUploadIsValidContentType(file?.type),\n\t\t\t},\n\t\t});\n\t};\n\n\tuploadNextFile();\n\tresetFileInput?.();\n};\n"]}}},"code":"var _regeneratorRuntime;\nmodule.link(\"@babel/runtime/regenerator\", {\n  default: function (v) {\n    _regeneratorRuntime = v;\n  }\n}, 0);\nvar _objectSpread;\nmodule.link(\"@babel/runtime/helpers/objectSpread2\", {\n  default: function (v) {\n    _objectSpread = v;\n  }\n}, 1);\nvar _toConsumableArray;\nmodule.link(\"@babel/runtime/helpers/toConsumableArray\", {\n  default: function (v) {\n    _toConsumableArray = v;\n  }\n}, 2);\nmodule.export({\n  uploadFiles: function () {\n    return uploadFiles;\n  }\n});\nvar isRoomFederated;\nmodule.link(\"@rocket.chat/core-typings\", {\n  isRoomFederated: function (v) {\n    isRoomFederated = v;\n  }\n}, 0);\nvar e2e;\nmodule.link(\"../../../../app/e2e/client\", {\n  e2e: function (v) {\n    e2e = v;\n  }\n}, 1);\nvar settings;\nmodule.link(\"../../../../app/settings/client\", {\n  settings: function (v) {\n    settings = v;\n  }\n}, 2);\nvar fileUploadIsValidContentType;\nmodule.link(\"../../../../app/utils/client\", {\n  fileUploadIsValidContentType: function (v) {\n    fileUploadIsValidContentType = v;\n  }\n}, 3);\nvar getFileExtension;\nmodule.link(\"../../../../lib/utils/getFileExtension\", {\n  getFileExtension: function (v) {\n    getFileExtension = v;\n  }\n}, 4);\nvar FileUploadModal;\nmodule.link(\"../../../views/room/modals/FileUploadModal\", {\n  \"default\": function (v) {\n    FileUploadModal = v;\n  }\n}, 5);\nvar imperativeModal;\nmodule.link(\"../../imperativeModal\", {\n  imperativeModal: function (v) {\n    imperativeModal = v;\n  }\n}, 6);\nvar prependReplies;\nmodule.link(\"../../utils/prependReplies\", {\n  prependReplies: function (v) {\n    prependReplies = v;\n  }\n}, 7);\nvar getHeightAndWidthFromDataUrl = function (dataURL) {\n  return new Promise(function (resolve) {\n    var img = new Image();\n    img.onload = function () {\n      resolve({\n        height: img.height,\n        width: img.width\n      });\n    };\n    img.src = dataURL;\n  });\n};\nvar uploadFiles = function () {\n  function _callee3(chat, files, resetFileInput) {\n    var _chat$composer$quoted, _chat$composer;\n    var replies, msg, room, queue, uploadFile, uploadNextFile;\n    return _regeneratorRuntime.async(function () {\n      function _callee3$(_context3) {\n        while (1) switch (_context3.prev = _context3.next) {\n          case 0:\n            replies = (_chat$composer$quoted = (_chat$composer = chat.composer) === null || _chat$composer === void 0 ? void 0 : _chat$composer.quotedMessages.get()) !== null && _chat$composer$quoted !== void 0 ? _chat$composer$quoted : [];\n            _context3.next = 3;\n            return _regeneratorRuntime.awrap(prependReplies('', replies));\n          case 3:\n            msg = _context3.sent;\n            _context3.next = 6;\n            return _regeneratorRuntime.awrap(chat.data.getRoom());\n          case 6:\n            room = _context3.sent;\n            queue = _toConsumableArray(files);\n            uploadFile = function (file, extraData, getContent, fileContent) {\n              var _chat$composer2;\n              chat.uploads.send(file, _objectSpread({\n                msg: msg\n              }, extraData), getContent, fileContent);\n              (_chat$composer2 = chat.composer) === null || _chat$composer2 === void 0 ? void 0 : _chat$composer2.clear();\n              imperativeModal.close();\n              uploadNextFile();\n            };\n            uploadNextFile = function () {\n              var _chat$composer$text, _chat$composer4;\n              var file = queue.pop();\n              if (!file) {\n                var _chat$composer3;\n                (_chat$composer3 = chat.composer) === null || _chat$composer3 === void 0 ? void 0 : _chat$composer3.dismissAllQuotedMessages();\n                return;\n              }\n              imperativeModal.open({\n                component: FileUploadModal,\n                props: {\n                  file: file,\n                  fileName: file.name,\n                  fileDescription: (_chat$composer$text = (_chat$composer4 = chat.composer) === null || _chat$composer4 === void 0 ? void 0 : _chat$composer4.text) !== null && _chat$composer$text !== void 0 ? _chat$composer$text : '',\n                  showDescription: room && !isRoomFederated(room),\n                  onClose: function () {\n                    imperativeModal.close();\n                    uploadNextFile();\n                  },\n                  onSubmit: function () {\n                    function _callee2(fileName, description) {\n                      var e2eRoom, shouldConvertSentMessages, encryptedFile, getContent, fileContentData, fileContent;\n                      return _regeneratorRuntime.async(function () {\n                        function _callee2$(_context2) {\n                          while (1) switch (_context2.prev = _context2.next) {\n                            case 0:\n                              Object.defineProperty(file, 'name', {\n                                writable: true,\n                                value: fileName\n                              });\n                              // encrypt attachment description\n                              _context2.next = 3;\n                              return _regeneratorRuntime.awrap(e2e.getInstanceByRoomId(room._id));\n                            case 3:\n                              e2eRoom = _context2.sent;\n                              if (e2eRoom) {\n                                _context2.next = 7;\n                                break;\n                              }\n                              uploadFile(file, {\n                                description: description\n                              });\n                              return _context2.abrupt(\"return\");\n                            case 7:\n                              if (settings.get('E2E_Enable_Encrypt_Files')) {\n                                _context2.next = 10;\n                                break;\n                              }\n                              uploadFile(file, {\n                                description: description\n                              });\n                              return _context2.abrupt(\"return\");\n                            case 10:\n                              _context2.next = 12;\n                              return _regeneratorRuntime.awrap(e2eRoom.shouldConvertSentMessages({\n                                msg: msg\n                              }));\n                            case 12:\n                              shouldConvertSentMessages = _context2.sent;\n                              if (shouldConvertSentMessages) {\n                                _context2.next = 16;\n                                break;\n                              }\n                              uploadFile(file, {\n                                description: description\n                              });\n                              return _context2.abrupt(\"return\");\n                            case 16:\n                              _context2.next = 18;\n                              return _regeneratorRuntime.awrap(e2eRoom.encryptFile(file));\n                            case 18:\n                              encryptedFile = _context2.sent;\n                              if (!encryptedFile) {\n                                _context2.next = 28;\n                                break;\n                              }\n                              getContent = function () {\n                                function _callee(_id, fileUrl) {\n                                  var attachments, attachment, dimensions, files;\n                                  return _regeneratorRuntime.async(function () {\n                                    function _callee$(_context) {\n                                      while (1) switch (_context.prev = _context.next) {\n                                        case 0:\n                                          attachments = [];\n                                          attachment = {\n                                            title: file.name,\n                                            type: 'file',\n                                            description: description,\n                                            title_link: fileUrl,\n                                            title_link_download: true,\n                                            encryption: {\n                                              key: encryptedFile.key,\n                                              iv: encryptedFile.iv\n                                            },\n                                            hashes: {\n                                              sha256: encryptedFile.hash\n                                            }\n                                          };\n                                          if (!/^image\\/.+/.test(file.type)) {\n                                            _context.next = 9;\n                                            break;\n                                          }\n                                          _context.next = 5;\n                                          return _regeneratorRuntime.awrap(getHeightAndWidthFromDataUrl(window.URL.createObjectURL(file)));\n                                        case 5:\n                                          dimensions = _context.sent;\n                                          attachments.push(_objectSpread(_objectSpread({}, attachment), {}, {\n                                            image_url: fileUrl,\n                                            image_type: file.type,\n                                            image_size: file.size\n                                          }, dimensions && {\n                                            image_dimensions: dimensions\n                                          }));\n                                          _context.next = 10;\n                                          break;\n                                        case 9:\n                                          if (/^audio\\/.+/.test(file.type)) {\n                                            attachments.push(_objectSpread(_objectSpread({}, attachment), {}, {\n                                              audio_url: fileUrl,\n                                              audio_type: file.type,\n                                              audio_size: file.size\n                                            }));\n                                          } else if (/^video\\/.+/.test(file.type)) {\n                                            attachments.push(_objectSpread(_objectSpread({}, attachment), {}, {\n                                              video_url: fileUrl,\n                                              video_type: file.type,\n                                              video_size: file.size\n                                            }));\n                                          } else {\n                                            attachments.push(_objectSpread(_objectSpread({}, attachment), {}, {\n                                              size: file.size,\n                                              format: getFileExtension(file.name)\n                                            }));\n                                          }\n                                        case 10:\n                                          files = [{\n                                            _id: _id,\n                                            name: file.name,\n                                            type: file.type,\n                                            size: file.size\n                                            // \"format\": \"png\"\n                                          }];\n                                          return _context.abrupt(\"return\", e2eRoom.encryptMessageContent({\n                                            attachments: attachments,\n                                            files: files,\n                                            file: files[0]\n                                          }));\n                                        case 12:\n                                        case \"end\":\n                                          return _context.stop();\n                                      }\n                                    }\n                                    return _callee$;\n                                  }(), null, null, null, Promise);\n                                }\n                                return _callee;\n                              }();\n                              fileContentData = {\n                                type: file.type,\n                                typeGroup: file.type.split('/')[0],\n                                name: fileName,\n                                encryption: {\n                                  key: encryptedFile.key,\n                                  iv: encryptedFile.iv\n                                },\n                                hashes: {\n                                  sha256: encryptedFile.hash\n                                }\n                              };\n                              _context2.t0 = fileContentData;\n                              _context2.next = 25;\n                              return _regeneratorRuntime.awrap(e2eRoom.encryptMessageContent(fileContentData));\n                            case 25:\n                              _context2.t1 = _context2.sent;\n                              fileContent = {\n                                raw: _context2.t0,\n                                encrypted: _context2.t1\n                              };\n                              uploadFile(encryptedFile.file, {\n                                t: 'e2e'\n                              }, getContent, fileContent);\n                            case 28:\n                            case \"end\":\n                              return _context2.stop();\n                          }\n                        }\n                        return _callee2$;\n                      }(), null, null, null, Promise);\n                    }\n                    return _callee2;\n                  }(),\n                  invalidContentType: !fileUploadIsValidContentType(file === null || file === void 0 ? void 0 : file.type)\n                }\n              });\n            };\n            uploadNextFile();\n            resetFileInput === null || resetFileInput === void 0 ? void 0 : resetFileInput();\n          case 12:\n          case \"end\":\n            return _context3.stop();\n        }\n      }\n      return _callee3$;\n    }(), null, null, null, Promise);\n  }\n  return _callee3;\n}();","map":{"version":3,"names":["_regeneratorRuntime","module","link","default","v","_objectSpread","_toConsumableArray","export","uploadFiles","isRoomFederated","e2e","settings","fileUploadIsValidContentType","getFileExtension","FileUploadModal","imperativeModal","prependReplies","getHeightAndWidthFromDataUrl","dataURL","Promise","resolve","img","Image","onload","height","width","src","_callee3","chat","files","resetFileInput","_chat$composer$quoted","_chat$composer","replies","msg","room","queue","uploadFile","uploadNextFile","async","_callee3$","_context3","prev","next","composer","quotedMessages","get","awrap","sent","data","getRoom","file","extraData","getContent","fileContent","_chat$composer2","uploads","send","clear","close","_chat$composer$text","_chat$composer4","pop","_chat$composer3","dismissAllQuotedMessages","open","component","props","fileName","name","fileDescription","text","showDescription","onClose","onSubmit","_callee2","description","e2eRoom","shouldConvertSentMessages","encryptedFile","fileContentData","_callee2$","_context2","Object","defineProperty","writable","value","getInstanceByRoomId","_id","abrupt","encryptFile","_callee","fileUrl","attachments","attachment","dimensions","_callee$","_context","title","type","title_link","title_link_download","encryption","key","iv","hashes","sha256","hash","test","window","URL","createObjectURL","push","image_url","image_type","image_size","size","image_dimensions","audio_url","audio_type","audio_size","video_url","video_type","video_size","format","encryptMessageContent","stop","typeGroup","split","t0","t1","raw","encrypted","t","invalidContentType"],"sources":["client/lib/chats/flows/uploadFiles.ts"],"sourcesContent":["import type { IMessage, FileAttachmentProps, IE2EEMessage, IUpload } from '@rocket.chat/core-typings';\nimport { isRoomFederated } from '@rocket.chat/core-typings';\n\nimport { e2e } from '../../../../app/e2e/client';\nimport { settings } from '../../../../app/settings/client';\nimport { fileUploadIsValidContentType } from '../../../../app/utils/client';\nimport { getFileExtension } from '../../../../lib/utils/getFileExtension';\nimport FileUploadModal from '../../../views/room/modals/FileUploadModal';\nimport { imperativeModal } from '../../imperativeModal';\nimport { prependReplies } from '../../utils/prependReplies';\nimport type { ChatAPI } from '../ChatAPI';\n\nconst getHeightAndWidthFromDataUrl = (dataURL: string): Promise<{ height: number; width: number }> => {\n\treturn new Promise((resolve) => {\n\t\tconst img = new Image();\n\t\timg.onload = () => {\n\t\t\tresolve({\n\t\t\t\theight: img.height,\n\t\t\t\twidth: img.width,\n\t\t\t});\n\t\t};\n\t\timg.src = dataURL;\n\t});\n};\n\nexport const uploadFiles = async (chat: ChatAPI, files: readonly File[], resetFileInput?: () => void): Promise<void> => {\n\tconst replies = chat.composer?.quotedMessages.get() ?? [];\n\n\tconst msg = await prependReplies('', replies);\n\n\tconst room = await chat.data.getRoom();\n\n\tconst queue = [...files];\n\n\tconst uploadFile = (\n\t\tfile: File,\n\t\textraData?: Pick<IMessage, 't' | 'e2e'> & { description?: string },\n\t\tgetContent?: (fileId: string, fileUrl: string) => Promise<IE2EEMessage['content']>,\n\t\tfileContent?: { raw: Partial<IUpload>; encrypted: IE2EEMessage['content'] },\n\t) => {\n\t\tchat.uploads.send(\n\t\t\tfile,\n\t\t\t{\n\t\t\t\tmsg,\n\t\t\t\t...extraData,\n\t\t\t},\n\t\t\tgetContent,\n\t\t\tfileContent,\n\t\t);\n\t\tchat.composer?.clear();\n\t\timperativeModal.close();\n\t\tuploadNextFile();\n\t};\n\n\tconst uploadNextFile = (): void => {\n\t\tconst file = queue.pop();\n\t\tif (!file) {\n\t\t\tchat.composer?.dismissAllQuotedMessages();\n\t\t\treturn;\n\t\t}\n\n\t\timperativeModal.open({\n\t\t\tcomponent: FileUploadModal,\n\t\t\tprops: {\n\t\t\t\tfile,\n\t\t\t\tfileName: file.name,\n\t\t\t\tfileDescription: chat.composer?.text ?? '',\n\t\t\t\tshowDescription: room && !isRoomFederated(room),\n\t\t\t\tonClose: (): void => {\n\t\t\t\t\timperativeModal.close();\n\t\t\t\t\tuploadNextFile();\n\t\t\t\t},\n\t\t\t\tonSubmit: async (fileName: string, description?: string): Promise<void> => {\n\t\t\t\t\tObject.defineProperty(file, 'name', {\n\t\t\t\t\t\twritable: true,\n\t\t\t\t\t\tvalue: fileName,\n\t\t\t\t\t});\n\n\t\t\t\t\t// encrypt attachment description\n\t\t\t\t\tconst e2eRoom = await e2e.getInstanceByRoomId(room._id);\n\n\t\t\t\t\tif (!e2eRoom) {\n\t\t\t\t\t\tuploadFile(file, { description });\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tif (!settings.get('E2E_Enable_Encrypt_Files')) {\n\t\t\t\t\t\tuploadFile(file, { description });\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tconst shouldConvertSentMessages = await e2eRoom.shouldConvertSentMessages({ msg });\n\n\t\t\t\t\tif (!shouldConvertSentMessages) {\n\t\t\t\t\t\tuploadFile(file, { description });\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tconst encryptedFile = await e2eRoom.encryptFile(file);\n\n\t\t\t\t\tif (encryptedFile) {\n\t\t\t\t\t\tconst getContent = async (_id: string, fileUrl: string): Promise<IE2EEMessage['content']> => {\n\t\t\t\t\t\t\tconst attachments = [];\n\n\t\t\t\t\t\t\tconst attachment: FileAttachmentProps = {\n\t\t\t\t\t\t\t\ttitle: file.name,\n\t\t\t\t\t\t\t\ttype: 'file',\n\t\t\t\t\t\t\t\tdescription,\n\t\t\t\t\t\t\t\ttitle_link: fileUrl,\n\t\t\t\t\t\t\t\ttitle_link_download: true,\n\t\t\t\t\t\t\t\tencryption: {\n\t\t\t\t\t\t\t\t\tkey: encryptedFile.key,\n\t\t\t\t\t\t\t\t\tiv: encryptedFile.iv,\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\thashes: {\n\t\t\t\t\t\t\t\t\tsha256: encryptedFile.hash,\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t};\n\n\t\t\t\t\t\t\tif (/^image\\/.+/.test(file.type)) {\n\t\t\t\t\t\t\t\tconst dimensions = await getHeightAndWidthFromDataUrl(window.URL.createObjectURL(file));\n\n\t\t\t\t\t\t\t\tattachments.push({\n\t\t\t\t\t\t\t\t\t...attachment,\n\t\t\t\t\t\t\t\t\timage_url: fileUrl,\n\t\t\t\t\t\t\t\t\timage_type: file.type,\n\t\t\t\t\t\t\t\t\timage_size: file.size,\n\t\t\t\t\t\t\t\t\t...(dimensions && {\n\t\t\t\t\t\t\t\t\t\timage_dimensions: dimensions,\n\t\t\t\t\t\t\t\t\t}),\n\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t} else if (/^audio\\/.+/.test(file.type)) {\n\t\t\t\t\t\t\t\tattachments.push({\n\t\t\t\t\t\t\t\t\t...attachment,\n\t\t\t\t\t\t\t\t\taudio_url: fileUrl,\n\t\t\t\t\t\t\t\t\taudio_type: file.type,\n\t\t\t\t\t\t\t\t\taudio_size: file.size,\n\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t} else if (/^video\\/.+/.test(file.type)) {\n\t\t\t\t\t\t\t\tattachments.push({\n\t\t\t\t\t\t\t\t\t...attachment,\n\t\t\t\t\t\t\t\t\tvideo_url: fileUrl,\n\t\t\t\t\t\t\t\t\tvideo_type: file.type,\n\t\t\t\t\t\t\t\t\tvideo_size: file.size,\n\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\tattachments.push({\n\t\t\t\t\t\t\t\t\t...attachment,\n\t\t\t\t\t\t\t\t\tsize: file.size,\n\t\t\t\t\t\t\t\t\tformat: getFileExtension(file.name),\n\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\tconst files = [\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t_id,\n\t\t\t\t\t\t\t\t\tname: file.name,\n\t\t\t\t\t\t\t\t\ttype: file.type,\n\t\t\t\t\t\t\t\t\tsize: file.size,\n\t\t\t\t\t\t\t\t\t// \"format\": \"png\"\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t];\n\n\t\t\t\t\t\t\treturn e2eRoom.encryptMessageContent({\n\t\t\t\t\t\t\t\tattachments,\n\t\t\t\t\t\t\t\tfiles,\n\t\t\t\t\t\t\t\tfile: files[0],\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t};\n\n\t\t\t\t\t\tconst fileContentData = {\n\t\t\t\t\t\t\ttype: file.type,\n\t\t\t\t\t\t\ttypeGroup: file.type.split('/')[0],\n\t\t\t\t\t\t\tname: fileName,\n\t\t\t\t\t\t\tencryption: {\n\t\t\t\t\t\t\t\tkey: encryptedFile.key,\n\t\t\t\t\t\t\t\tiv: encryptedFile.iv,\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\thashes: {\n\t\t\t\t\t\t\t\tsha256: encryptedFile.hash,\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t};\n\n\t\t\t\t\t\tconst fileContent = {\n\t\t\t\t\t\t\traw: fileContentData,\n\t\t\t\t\t\t\tencrypted: await e2eRoom.encryptMessageContent(fileContentData),\n\t\t\t\t\t\t};\n\n\t\t\t\t\t\tuploadFile(\n\t\t\t\t\t\t\tencryptedFile.file,\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tt: 'e2e',\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\tgetContent,\n\t\t\t\t\t\t\tfileContent,\n\t\t\t\t\t\t);\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\tinvalidContentType: !fileUploadIsValidContentType(file?.type),\n\t\t\t},\n\t\t});\n\t};\n\n\tuploadNextFile();\n\tresetFileInput?.();\n};\n"],"mappings":"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","ignoreList":[]},"sourceType":"module","externalDependencies":{},"hash":"068cebd86d0fb0fb18c4dcd5bdc8760bee976e6b"}
