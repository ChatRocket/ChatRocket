{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/app/webrtc/client/WebRTCClass.ts","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","topLevelAwait","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"web.browser"},"sourceFileName":"app/webrtc/client/WebRTCClass.ts","filename":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/app/webrtc/client/WebRTCClass.ts","inputSourceMap":{"version":3,"file":"app/webrtc/client/WebRTCClass.ts","sourceRoot":"","sources":["app/webrtc/client/WebRTCClass.ts"],"names":[],"mappings":"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","sourcesContent":["import type { IRoom } from '@rocket.chat/core-typings';\nimport type { StreamKeys, StreamNames, StreamerCallbackArgs } from '@rocket.chat/ddp-client';\nimport { Emitter } from '@rocket.chat/emitter';\nimport { Meteor } from 'meteor/meteor';\nimport { ReactiveVar } from 'meteor/reactive-var';\nimport { Tracker } from 'meteor/tracker';\n\nimport { ChromeScreenShare } from './screenShare';\nimport GenericModal from '../../../client/components/GenericModal';\nimport { imperativeModal } from '../../../client/lib/imperativeModal';\nimport { goToRoomById } from '../../../client/lib/utils/goToRoomById';\nimport { ChatSubscription } from '../../models/client';\nimport { settings } from '../../settings/client';\nimport { sdk } from '../../utils/client/lib/SDKClient';\nimport { t } from '../../utils/lib/i18n';\nimport { WEB_RTC_EVENTS } from '../lib/constants';\n\n// FIXME: there is a mix of obsolete definitions and incorrect field assignments\n\ndeclare global {\n\t// eslint-disable-next-line @typescript-eslint/naming-convention\n\tinterface RTCPeerConnection {\n\t\t/** @deprecated non-standard */\n\t\tcreatedAt: number;\n\t\t/** @deprecated non-standard */\n\t\tremoteMedia: MediaStreamConstraints;\n\t}\n\n\t// eslint-disable-next-line @typescript-eslint/naming-convention\n\tinterface RTCOfferOptions {\n\t\t/** @deprecated non-standard */\n\t\tmandatory?: unknown;\n\t}\n\n\t// eslint-disable-next-line @typescript-eslint/naming-convention\n\tinterface MediaStream {\n\t\t/** @deprecated non-standard */\n\t\tvolume?: GainNode;\n\t}\n\n\t// eslint-disable-next-line @typescript-eslint/naming-convention\n\tinterface MediaStreamConstraints {\n\t\t/** @deprecated non-standard */\n\t\tdesktop?: boolean;\n\t}\n\n\t/** @deprecated browser-specific global */\n\tconst chrome: {\n\t\twebstore: {\n\t\t\tinstall(url: string, onSuccess: () => void, onError: (error: any) => void): void;\n\t\t};\n\t};\n\n\t// eslint-disable-next-line @typescript-eslint/naming-convention\n\tinterface Window {\n\t\trocketchatscreenshare?: unknown;\n\t\taudioContext?: AudioContext;\n\t}\n}\n\ntype EventData<TStreamName extends StreamNames, TStreamKey extends StreamKeys<TStreamName>, TType> = Extract<\n\tStreamerCallbackArgs<TStreamName, TStreamKey>,\n\t[type: TType, data: any]\n>[1];\n\ntype StatusData = EventData<'notify-room', `${string}/webrtc`, 'status'>;\ntype CallData = EventData<'notify-room-users', `${string}/webrtc`, 'call'>;\ntype CandidateData = EventData<'notify-user', `${string}/webrtc`, 'candidate'>;\ntype DescriptionData = EventData<'notify-user', `${string}/webrtc`, 'description'>;\ntype JoinData = EventData<'notify-user', `${string}/webrtc`, 'join'>;\n\ntype RemoteItem = {\n\tid: string;\n\turl: MediaStream;\n\tstate: RTCIceConnectionState;\n\tstateText?: string;\n\tconnected?: boolean;\n};\n\ntype RemoteConnection = {\n\tid: string;\n\tmedia: MediaStreamConstraints;\n};\n\nclass WebRTCTransportClass extends Emitter<{\n\tstatus: StatusData;\n\tcall: CallData;\n\tcandidate: CandidateData;\n\tdescription: DescriptionData;\n\tjoin: JoinData;\n}> {\n\tpublic debug = false;\n\n\tconstructor(public webrtcInstance: WebRTCClass) {\n\t\tsuper();\n\t\tsdk.stream('notify-room', [`${this.webrtcInstance.room}/${WEB_RTC_EVENTS.WEB_RTC}`], (type, data) => {\n\t\t\tthis.log('WebRTCTransportClass - onRoom', type, data);\n\t\t\tthis.emit(type, data);\n\t\t});\n\t}\n\n\tlog(...args: unknown[]) {\n\t\tif (this.debug === true) {\n\t\t\tconsole.log(...args);\n\t\t}\n\t}\n\n\tonUserStream(type: 'candidate', data: CandidateData): void;\n\n\tonUserStream(type: 'description', data: DescriptionData): void;\n\n\tonUserStream(type: 'join', data: JoinData): void;\n\n\tonUserStream(\n\t\t...[type, data]:\n\t\t\t| [type: 'candidate', data: CandidateData]\n\t\t\t| [type: 'description', data: DescriptionData]\n\t\t\t| [type: 'join', data: JoinData]\n\t) {\n\t\tif (data.room !== this.webrtcInstance.room) {\n\t\t\treturn;\n\t\t}\n\n\t\tthis.log('WebRTCTransportClass - onUser', type, data);\n\n\t\tswitch (type) {\n\t\t\tcase 'candidate':\n\t\t\t\tthis.emit('candidate', data);\n\t\t\t\tbreak;\n\t\t\tcase 'description':\n\t\t\t\tthis.emit('description', data);\n\t\t\t\tbreak;\n\t\t\tcase 'join':\n\t\t\t\tthis.emit('join', data);\n\t\t\t\tbreak;\n\t\t}\n\t}\n\n\tstartCall(data: CallData) {\n\t\tthis.log('WebRTCTransportClass - startCall', this.webrtcInstance.room, this.webrtcInstance.selfId);\n\t\tsdk.publish('notify-room-users', [\n\t\t\t`${this.webrtcInstance.room}/${WEB_RTC_EVENTS.WEB_RTC}`,\n\t\t\tWEB_RTC_EVENTS.CALL,\n\t\t\t{\n\t\t\t\tfrom: this.webrtcInstance.selfId,\n\t\t\t\troom: this.webrtcInstance.room,\n\t\t\t\tmedia: data.media,\n\t\t\t\tmonitor: data.monitor,\n\t\t\t},\n\t\t]);\n\t}\n\n\tjoinCall(data: JoinData) {\n\t\tthis.log('WebRTCTransportClass - joinCall', this.webrtcInstance.room, this.webrtcInstance.selfId);\n\t\tif (data.monitor === true) {\n\t\t\tsdk.publish('notify-user', [\n\t\t\t\t`${data.to}/${WEB_RTC_EVENTS.WEB_RTC}`,\n\t\t\t\tWEB_RTC_EVENTS.JOIN,\n\t\t\t\t{\n\t\t\t\t\tfrom: this.webrtcInstance.selfId,\n\t\t\t\t\troom: this.webrtcInstance.room,\n\t\t\t\t\tmedia: data.media,\n\t\t\t\t\tmonitor: data.monitor,\n\t\t\t\t},\n\t\t\t]);\n\t\t} else {\n\t\t\tsdk.publish('notify-room-users', [\n\t\t\t\t`${this.webrtcInstance.room}/${WEB_RTC_EVENTS.WEB_RTC}`,\n\t\t\t\tWEB_RTC_EVENTS.JOIN,\n\t\t\t\t{\n\t\t\t\t\tfrom: this.webrtcInstance.selfId,\n\t\t\t\t\troom: this.webrtcInstance.room,\n\t\t\t\t\tmedia: data.media,\n\t\t\t\t\tmonitor: data.monitor,\n\t\t\t\t},\n\t\t\t]);\n\t\t}\n\t}\n\n\tsendCandidate(data: CandidateData) {\n\t\tdata.from = this.webrtcInstance.selfId;\n\t\tdata.room = this.webrtcInstance.room;\n\t\tthis.log('WebRTCTransportClass - sendCandidate', data);\n\t\tsdk.publish('notify-user', [`${data.to}/${WEB_RTC_EVENTS.WEB_RTC}`, WEB_RTC_EVENTS.CANDIDATE, data]);\n\t}\n\n\tsendDescription(data: DescriptionData) {\n\t\tdata.from = this.webrtcInstance.selfId;\n\t\tdata.room = this.webrtcInstance.room;\n\t\tthis.log('WebRTCTransportClass - sendDescription', data);\n\t\tsdk.publish('notify-user', [`${data.to}/${WEB_RTC_EVENTS.WEB_RTC}`, WEB_RTC_EVENTS.DESCRIPTION, data]);\n\t}\n\n\tsendStatus(data: StatusData) {\n\t\tthis.log('WebRTCTransportClass - sendStatus', data, this.webrtcInstance.room);\n\t\tdata.from = this.webrtcInstance.selfId;\n\t\tsdk.publish('notify-room', [`${this.webrtcInstance.room}/${WEB_RTC_EVENTS.WEB_RTC}`, WEB_RTC_EVENTS.STATUS, data]);\n\t}\n\n\tonRemoteCall(fn: (data: CallData) => void) {\n\t\treturn this.on(WEB_RTC_EVENTS.CALL, fn);\n\t}\n\n\tonRemoteJoin(fn: (data: JoinData) => void) {\n\t\treturn this.on(WEB_RTC_EVENTS.JOIN, fn);\n\t}\n\n\tonRemoteCandidate(fn: (data: CandidateData) => void) {\n\t\treturn this.on(WEB_RTC_EVENTS.CANDIDATE, fn);\n\t}\n\n\tonRemoteDescription(fn: (data: DescriptionData) => void) {\n\t\treturn this.on(WEB_RTC_EVENTS.DESCRIPTION, fn);\n\t}\n\n\tonRemoteStatus(fn: (data: StatusData) => void) {\n\t\treturn this.on(WEB_RTC_EVENTS.STATUS, fn);\n\t}\n}\n\nclass WebRTCClass {\n\ttransport: WebRTCTransportClass;\n\n\tconfig: { iceServers: RTCIceServer[] };\n\n\tdebug: boolean;\n\n\tTransportClass: typeof WebRTCTransportClass;\n\n\tpeerConnections: Record<string, RTCPeerConnection> = {};\n\n\tremoteItems: ReactiveVar<RemoteItem[]>;\n\n\tremoteItemsById: ReactiveVar<Record<string, RemoteItem>>;\n\n\tcallInProgress: ReactiveVar<boolean>;\n\n\taudioEnabled: ReactiveVar<boolean>;\n\n\tvideoEnabled: ReactiveVar<boolean>;\n\n\toverlayEnabled: ReactiveVar<boolean>;\n\n\tscreenShareEnabled: ReactiveVar<boolean>;\n\n\tlocalUrl: ReactiveVar<MediaStream | undefined>;\n\n\tactive: boolean;\n\n\tremoteMonitoring: boolean;\n\n\tmonitor: boolean;\n\n\tnavigator: string | undefined;\n\n\tscreenShareAvailable: boolean;\n\n\tmedia: MediaStreamConstraints;\n\n\tconstructor(\n\t\tpublic selfId: string,\n\t\tpublic room: string,\n\t\tpublic autoAccept = false,\n\t) {\n\t\tthis.config = {\n\t\t\ticeServers: [],\n\t\t};\n\t\tthis.debug = false;\n\t\tthis.TransportClass = WebRTCTransportClass;\n\t\tlet servers = settings.get<string>('WebRTC_Servers');\n\t\tif (servers && servers.trim() !== '') {\n\t\t\tservers = servers.replace(/\\s/g, '');\n\n\t\t\tservers.split(',').forEach((server) => {\n\t\t\t\tconst parts = server.split('@');\n\t\t\t\tconst serverConfig: RTCIceServer = {\n\t\t\t\t\turls: parts.pop()!,\n\t\t\t\t};\n\t\t\t\tif (parts.length === 1) {\n\t\t\t\t\tconst [username, credential] = parts[0].split(':');\n\t\t\t\t\tserverConfig.username = decodeURIComponent(username);\n\t\t\t\t\tserverConfig.credential = decodeURIComponent(credential);\n\t\t\t\t}\n\t\t\t\tthis.config.iceServers.push(serverConfig);\n\t\t\t});\n\t\t}\n\t\tthis.peerConnections = {};\n\t\tthis.remoteItems = new ReactiveVar([]);\n\t\tthis.remoteItemsById = new ReactiveVar({});\n\t\tthis.callInProgress = new ReactiveVar(false);\n\t\tthis.audioEnabled = new ReactiveVar(false);\n\t\tthis.videoEnabled = new ReactiveVar(false);\n\t\tthis.overlayEnabled = new ReactiveVar(false);\n\t\tthis.screenShareEnabled = new ReactiveVar(false);\n\t\tthis.localUrl = new ReactiveVar(undefined);\n\t\tthis.active = false;\n\t\tthis.remoteMonitoring = false;\n\t\tthis.monitor = false;\n\t\tthis.navigator = undefined;\n\t\tconst userAgent = navigator.userAgent.toLocaleLowerCase();\n\n\t\tif (userAgent.indexOf('electron') !== -1) {\n\t\t\tthis.navigator = 'electron';\n\t\t} else if (userAgent.indexOf('chrome') !== -1) {\n\t\t\tthis.navigator = 'chrome';\n\t\t} else if (userAgent.indexOf('firefox') !== -1) {\n\t\t\tthis.navigator = 'firefox';\n\t\t} else if (userAgent.indexOf('safari') !== -1) {\n\t\t\tthis.navigator = 'safari';\n\t\t}\n\n\t\tthis.screenShareAvailable = ['chrome', 'firefox', 'electron'].includes(this.navigator!);\n\t\tthis.media = {\n\t\t\tvideo: true,\n\t\t\taudio: true,\n\t\t};\n\t\tthis.transport = new this.TransportClass(this);\n\t\tthis.transport.onRemoteCall(this.onRemoteCall.bind(this));\n\t\tthis.transport.onRemoteJoin(this.onRemoteJoin.bind(this));\n\t\tthis.transport.onRemoteCandidate(this.onRemoteCandidate.bind(this));\n\t\tthis.transport.onRemoteDescription(this.onRemoteDescription.bind(this));\n\t\tthis.transport.onRemoteStatus(this.onRemoteStatus.bind(this));\n\n\t\tsetInterval(this.checkPeerConnections.bind(this), 1000);\n\t}\n\n\tonUserStream(type: 'candidate', data: CandidateData): void;\n\n\tonUserStream(type: 'description', data: DescriptionData): void;\n\n\tonUserStream(type: 'join', data: JoinData): void;\n\n\tonUserStream(\n\t\t...[type, data]:\n\t\t\t| [type: 'candidate', data: CandidateData]\n\t\t\t| [type: 'description', data: DescriptionData]\n\t\t\t| [type: 'join', data: JoinData]\n\t) {\n\t\tswitch (type) {\n\t\t\tcase 'candidate':\n\t\t\t\tthis.transport.onUserStream('candidate', data);\n\t\t\t\tbreak;\n\n\t\t\tcase 'description':\n\t\t\t\tthis.transport.onUserStream('description', data);\n\t\t\t\tbreak;\n\n\t\t\tcase 'join':\n\t\t\t\tthis.transport.onUserStream('join', data);\n\t\t\t\tbreak;\n\t\t}\n\t}\n\n\tlog(...args: unknown[]) {\n\t\tif (this.debug === true) {\n\t\t\tconsole.log(...args);\n\t\t}\n\t}\n\n\tonError(...args: unknown[]) {\n\t\tconsole.error(...args);\n\t}\n\n\tcheckPeerConnections() {\n\t\tconst { peerConnections } = this;\n\t\tconst date = Date.now();\n\t\tObject.entries(peerConnections).some(([id, peerConnection]) => {\n\t\t\tif (!['connected', 'completed'].includes(peerConnection.iceConnectionState) && peerConnection.createdAt + 5000 < date) {\n\t\t\t\tthis.stopPeerConnection(id);\n\t\t\t\treturn true;\n\t\t\t}\n\t\t\treturn false;\n\t\t});\n\t}\n\n\tupdateRemoteItems() {\n\t\tconst items: RemoteItem[] = [];\n\t\tconst itemsById: Record<string, RemoteItem> = {};\n\t\tconst { peerConnections } = this;\n\n\t\tObject.entries(peerConnections).forEach(([id, peerConnection]) => {\n\t\t\tpeerConnection.getRemoteStreams().forEach((remoteStream) => {\n\t\t\t\tconst item: RemoteItem = {\n\t\t\t\t\tid,\n\t\t\t\t\turl: remoteStream,\n\t\t\t\t\tstate: peerConnection.iceConnectionState,\n\t\t\t\t};\n\t\t\t\tswitch (peerConnection.iceConnectionState) {\n\t\t\t\t\tcase 'checking':\n\t\t\t\t\t\titem.stateText = 'Connecting...';\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tcase 'connected':\n\t\t\t\t\tcase 'completed':\n\t\t\t\t\t\titem.stateText = 'Connected';\n\t\t\t\t\t\titem.connected = true;\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tcase 'disconnected':\n\t\t\t\t\t\titem.stateText = 'Disconnected';\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tcase 'failed':\n\t\t\t\t\t\titem.stateText = 'Failed';\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tcase 'closed':\n\t\t\t\t\t\titem.stateText = 'Closed';\n\t\t\t\t}\n\t\t\t\titems.push(item);\n\t\t\t\titemsById[id] = item;\n\t\t\t});\n\t\t});\n\t\tthis.remoteItems.set(items);\n\t\tthis.remoteItemsById.set(itemsById);\n\t}\n\n\tresetCallInProgress = () => {\n\t\tthis.callInProgress.set(false);\n\t};\n\n\tbroadcastStatus() {\n\t\tif (this.active !== true || this.monitor === true || this.remoteMonitoring === true) {\n\t\t\treturn;\n\t\t}\n\t\tconst remoteConnections: RemoteConnection[] = [];\n\t\tconst { peerConnections } = this;\n\t\tObject.entries(peerConnections).forEach(([id, { remoteMedia: media }]) => {\n\t\t\tremoteConnections.push({\n\t\t\t\tid,\n\t\t\t\tmedia,\n\t\t\t});\n\t\t});\n\n\t\tthis.transport.sendStatus({\n\t\t\tmedia: this.media,\n\t\t\tremoteConnections,\n\t\t});\n\t}\n\n\tcallInProgressTimeout: ReturnType<typeof setTimeout> | undefined = undefined;\n\n\tonRemoteStatus(data: StatusData) {\n\t\t// this.log(onRemoteStatus, arguments);\n\t\tthis.callInProgress.set(true);\n\t\tclearTimeout(this.callInProgressTimeout);\n\t\tthis.callInProgressTimeout = setTimeout(this.resetCallInProgress, 2000);\n\t\tif (this.active !== true) {\n\t\t\treturn;\n\t\t}\n\t\tconst remoteConnections = [\n\t\t\t{\n\t\t\t\tid: data.from!,\n\t\t\t\tmedia: data.media,\n\t\t\t},\n\t\t\t...data.remoteConnections,\n\t\t];\n\n\t\tremoteConnections.forEach((remoteConnection) => {\n\t\t\tif (remoteConnection.id !== this.selfId && this.peerConnections[remoteConnection.id] == null) {\n\t\t\t\tthis.log('reconnecting with', remoteConnection.id);\n\t\t\t\tthis.onRemoteJoin({\n\t\t\t\t\tfrom: remoteConnection.id,\n\t\t\t\t\tmedia: remoteConnection.media,\n\t\t\t\t});\n\t\t\t}\n\t\t});\n\t}\n\n\tgetPeerConnection(id: string) {\n\t\tif (this.peerConnections[id] != null) {\n\t\t\treturn this.peerConnections[id];\n\t\t}\n\t\tconst peerConnection = new RTCPeerConnection(this.config);\n\n\t\tpeerConnection.createdAt = Date.now();\n\t\tpeerConnection.remoteMedia = {};\n\t\tthis.peerConnections[id] = peerConnection;\n\t\tconst eventNames = [\n\t\t\t'icecandidate',\n\t\t\t'addstream',\n\t\t\t'removestream',\n\t\t\t'iceconnectionstatechange',\n\t\t\t'datachannel',\n\t\t\t'identityresult',\n\t\t\t'idpassertionerror',\n\t\t\t'idpvalidationerror',\n\t\t\t'negotiationneeded',\n\t\t\t'peeridentity',\n\t\t\t'signalingstatechange',\n\t\t];\n\n\t\teventNames.forEach((eventName) => {\n\t\t\tpeerConnection.addEventListener(eventName, (e) => {\n\t\t\t\tthis.log(id, e.type, e);\n\t\t\t});\n\t\t});\n\n\t\tpeerConnection.addEventListener('icecandidate', (e) => {\n\t\t\tif (e.candidate == null) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tthis.transport.sendCandidate({\n\t\t\t\tto: id,\n\t\t\t\tcandidate: {\n\t\t\t\t\tcandidate: e.candidate.candidate,\n\t\t\t\t\tsdpMLineIndex: e.candidate.sdpMLineIndex,\n\t\t\t\t\tsdpMid: e.candidate.sdpMid,\n\t\t\t\t},\n\t\t\t});\n\t\t});\n\t\tpeerConnection.addEventListener('addstream', () => {\n\t\t\tthis.updateRemoteItems();\n\t\t});\n\t\tpeerConnection.addEventListener('removestream', () => {\n\t\t\tthis.updateRemoteItems();\n\t\t});\n\t\tpeerConnection.addEventListener('iceconnectionstatechange', () => {\n\t\t\tif (\n\t\t\t\t(peerConnection.iceConnectionState === 'disconnected' || peerConnection.iceConnectionState === 'closed') &&\n\t\t\t\tpeerConnection === this.peerConnections[id]\n\t\t\t) {\n\t\t\t\tthis.stopPeerConnection(id);\n\t\t\t\tsetTimeout(() => {\n\t\t\t\t\tif (Object.keys(this.peerConnections).length === 0) {\n\t\t\t\t\t\tthis.stop();\n\t\t\t\t\t}\n\t\t\t\t}, 3000);\n\t\t\t}\n\t\t\tthis.updateRemoteItems();\n\t\t});\n\t\treturn peerConnection;\n\t}\n\n\taudioContext: AudioContext | undefined;\n\n\t_getUserMedia(media: MediaStreamConstraints, onSuccess: (stream: MediaStream) => void, onError: (error?: any) => void) {\n\t\tconst onSuccessLocal = (stream: MediaStream) => {\n\t\t\tif (AudioContext && stream.getAudioTracks().length > 0) {\n\t\t\t\tconst audioContext = new AudioContext();\n\t\t\t\tconst source = audioContext.createMediaStreamSource(stream);\n\t\t\t\tconst volume = audioContext.createGain();\n\t\t\t\tsource.connect(volume);\n\t\t\t\tconst peer = audioContext.createMediaStreamDestination();\n\t\t\t\tvolume.connect(peer);\n\t\t\t\tvolume.gain.value = 0.6;\n\t\t\t\tstream.removeTrack(stream.getAudioTracks()[0]);\n\t\t\t\tstream.addTrack(peer.stream.getAudioTracks()[0]);\n\t\t\t\tstream.volume = volume;\n\t\t\t\tthis.audioContext = audioContext;\n\t\t\t}\n\t\t\tonSuccess(stream);\n\t\t};\n\n\t\tif (navigator.mediaDevices?.getUserMedia) {\n\t\t\treturn navigator.mediaDevices.getUserMedia(media).then(onSuccessLocal).catch(onError);\n\t\t}\n\n\t\tnavigator.getUserMedia?.(media, onSuccessLocal, onError);\n\t}\n\n\tgetUserMedia(media: MediaStreamConstraints, onSuccess: (stream: MediaStream) => void, onError: (error: any) => void = this.onError) {\n\t\tif (media.desktop !== true) {\n\t\t\tvoid this._getUserMedia(media, onSuccess, onError);\n\t\t\treturn;\n\t\t}\n\t\tif (this.screenShareAvailable !== true) {\n\t\t\tconsole.log('Screen share is not avaliable');\n\t\t\treturn;\n\t\t}\n\t\tconst getScreen = (audioStream?: MediaStream) => {\n\t\t\tconst refresh = function () {\n\t\t\t\timperativeModal.open({\n\t\t\t\t\tcomponent: GenericModal,\n\t\t\t\t\tprops: {\n\t\t\t\t\t\tvariant: 'warning',\n\t\t\t\t\t\ttitle: t('Refresh_your_page_after_install_to_enable_screen_sharing'),\n\t\t\t\t\t},\n\t\t\t\t});\n\t\t\t};\n\n\t\t\tconst isChromeExtensionInstalled = this.navigator === 'chrome' && ChromeScreenShare.installed;\n\t\t\tconst isFirefoxExtensionInstalled = this.navigator === 'firefox' && window.rocketchatscreenshare != null;\n\n\t\t\tif (!isChromeExtensionInstalled && !isFirefoxExtensionInstalled) {\n\t\t\t\timperativeModal.open({\n\t\t\t\t\tcomponent: GenericModal,\n\t\t\t\t\tprops: {\n\t\t\t\t\t\ttitle: t('Screen_Share'),\n\t\t\t\t\t\tvariant: 'warning',\n\t\t\t\t\t\tconfirmText: t('Install_Extension'),\n\t\t\t\t\t\tcancelText: t('Cancel'),\n\t\t\t\t\t\tchildren: t('You_need_install_an_extension_to_allow_screen_sharing'),\n\t\t\t\t\t\tonConfirm: () => {\n\t\t\t\t\t\t\tif (this.navigator === 'chrome') {\n\t\t\t\t\t\t\t\tconst url = 'https://chrome.google.com/webstore/detail/rocketchat-screen-share/nocfbnnmjnndkbipkabodnheejiegccf';\n\t\t\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\t\t\tchrome.webstore.install(url, refresh, () => {\n\t\t\t\t\t\t\t\t\t\twindow.open(url);\n\t\t\t\t\t\t\t\t\t\trefresh();\n\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\t} catch (_error) {\n\t\t\t\t\t\t\t\t\tconsole.log(_error);\n\t\t\t\t\t\t\t\t\twindow.open(url);\n\t\t\t\t\t\t\t\t\trefresh();\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t} else if (this.navigator === 'firefox') {\n\t\t\t\t\t\t\t\twindow.open('https://addons.mozilla.org/en-GB/firefox/addon/rocketchat-screen-share/');\n\t\t\t\t\t\t\t\trefresh();\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t});\n\n\t\t\t\treturn onError(false);\n\t\t\t}\n\n\t\t\tconst getScreenSuccess = (stream: MediaStream) => {\n\t\t\t\tif (audioStream != null) {\n\t\t\t\t\tstream.addTrack(audioStream.getAudioTracks()[0]);\n\t\t\t\t}\n\t\t\t\tonSuccess(stream);\n\t\t\t};\n\t\t\tif (this.navigator === 'firefox') {\n\t\t\t\tmedia = {\n\t\t\t\t\taudio: media.audio,\n\t\t\t\t\tvideo: {\n\t\t\t\t\t\tmozMediaSource: 'window',\n\t\t\t\t\t\tmediaSource: 'window',\n\t\t\t\t\t},\n\t\t\t\t};\n\t\t\t\tvoid this._getUserMedia(media, getScreenSuccess, onError);\n\t\t\t} else {\n\t\t\t\tChromeScreenShare.getSourceId(this.navigator!, (id) => {\n\t\t\t\t\tmedia = {\n\t\t\t\t\t\taudio: false,\n\t\t\t\t\t\tvideo: {\n\t\t\t\t\t\t\tmandatory: {\n\t\t\t\t\t\t\t\tchromeMediaSource: 'desktop',\n\t\t\t\t\t\t\t\tchromeMediaSourceId: id,\n\t\t\t\t\t\t\t\tmaxWidth: 1280,\n\t\t\t\t\t\t\t\tmaxHeight: 720,\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t};\n\t\t\t\t\tvoid this._getUserMedia(media, getScreenSuccess, onError);\n\t\t\t\t});\n\t\t\t}\n\t\t};\n\t\tif (this.navigator === 'firefox' || media.audio == null || media.audio === false) {\n\t\t\tgetScreen();\n\t\t} else {\n\t\t\tconst getAudioSuccess = (audioStream: MediaStream) => {\n\t\t\t\tgetScreen(audioStream);\n\t\t\t};\n\t\t\tconst getAudioError = () => {\n\t\t\t\tgetScreen();\n\t\t\t};\n\n\t\t\tvoid this._getUserMedia(\n\t\t\t\t{\n\t\t\t\t\taudio: media.audio,\n\t\t\t\t},\n\t\t\t\tgetAudioSuccess,\n\t\t\t\tgetAudioError,\n\t\t\t);\n\t\t}\n\t}\n\n\tgetLocalUserMedia(callback: (...args: any[]) => void, ...args: unknown[]) {\n\t\tthis.log('getLocalUserMedia', [callback, ...args]);\n\t\tif (this.localStream != null) {\n\t\t\treturn callback(null, this.localStream);\n\t\t}\n\t\tconst onSuccess = (stream: MediaStream) => {\n\t\t\tthis.localStream = stream;\n\t\t\t!this.audioEnabled.get() && this.disableAudio();\n\t\t\t!this.videoEnabled.get() && this.disableVideo();\n\t\t\tthis.localUrl.set(stream);\n\t\t\tconst { peerConnections } = this;\n\t\t\tObject.entries(peerConnections).forEach(([, peerConnection]) => peerConnection.addStream(stream));\n\t\t\tdocument.querySelector<HTMLVideoElement>('video#localVideo')!.srcObject = stream;\n\t\t\tcallback(null, this.localStream);\n\t\t};\n\t\tconst onError = (error: any) => {\n\t\t\tcallback(false);\n\t\t\tthis.onError(error);\n\t\t};\n\t\tthis.getUserMedia(this.media, onSuccess, onError);\n\t}\n\n\tstopPeerConnection = (id: string) => {\n\t\tconst peerConnection = this.peerConnections[id];\n\t\tif (peerConnection == null) {\n\t\t\treturn;\n\t\t}\n\t\tdelete this.peerConnections[id];\n\t\tpeerConnection.close();\n\t\tthis.updateRemoteItems();\n\t};\n\n\tstopAllPeerConnections() {\n\t\tconst { peerConnections } = this;\n\n\t\tObject.keys(peerConnections).forEach(this.stopPeerConnection);\n\n\t\tvoid window.audioContext?.close(); // FIXME: probably should be `this.audioContext`\n\t}\n\n\tsetAudioEnabled(enabled = true) {\n\t\tif (this.localStream != null) {\n\t\t\tthis.localStream.getAudioTracks().forEach((audio) => {\n\t\t\t\taudio.enabled = enabled;\n\t\t\t});\n\t\t\tthis.audioEnabled.set(enabled);\n\t\t}\n\t}\n\n\tdisableAudio() {\n\t\tthis.setAudioEnabled(false);\n\t}\n\n\tenableAudio() {\n\t\tthis.setAudioEnabled(true);\n\t}\n\n\ttoggleAudio() {\n\t\tif (this.audioEnabled.get()) {\n\t\t\treturn this.disableAudio();\n\t\t}\n\t\treturn this.enableAudio();\n\t}\n\n\tlocalStream: MediaStream | undefined;\n\n\tsetVideoEnabled(enabled = true) {\n\t\tif (this.localStream != null) {\n\t\t\tthis.localStream.getVideoTracks().forEach((video) => {\n\t\t\t\tvideo.enabled = enabled;\n\t\t\t});\n\t\t\tthis.videoEnabled.set(enabled);\n\t\t}\n\t}\n\n\tdisableScreenShare() {\n\t\tthis.setScreenShareEnabled(false);\n\t}\n\n\tenableScreenShare() {\n\t\tthis.setScreenShareEnabled(true);\n\t}\n\n\tsetScreenShareEnabled(enabled = true) {\n\t\tif (this.localStream != null) {\n\t\t\tthis.media.desktop = enabled;\n\t\t\tdelete this.localStream;\n\t\t\tthis.getLocalUserMedia((err) => {\n\t\t\t\tif (err != null) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\tthis.screenShareEnabled.set(enabled);\n\t\t\t\tthis.stopAllPeerConnections();\n\t\t\t\tthis.joinCall();\n\t\t\t});\n\t\t}\n\t}\n\n\tdisableVideo() {\n\t\tthis.setVideoEnabled(false);\n\t}\n\n\tenableVideo() {\n\t\tthis.setVideoEnabled(true);\n\t}\n\n\ttoggleVideo() {\n\t\tif (this.videoEnabled.get()) {\n\t\t\treturn this.disableVideo();\n\t\t}\n\t\treturn this.enableVideo();\n\t}\n\n\tstop() {\n\t\tthis.active = false;\n\t\tthis.monitor = false;\n\t\tthis.remoteMonitoring = false;\n\t\tif (this.localStream != null && typeof this.localStream !== 'undefined') {\n\t\t\tthis.localStream.getTracks().forEach((track) => track.stop());\n\t\t}\n\t\tthis.localUrl.set(undefined);\n\t\tdelete this.localStream;\n\t\tthis.stopAllPeerConnections();\n\t}\n\n\tstartCall(media: MediaStreamConstraints = {}, ...args: unknown[]) {\n\t\tthis.log('startCall', [media, ...args]);\n\t\tthis.media = media;\n\t\tthis.getLocalUserMedia(() => {\n\t\t\tthis.active = true;\n\t\t\tthis.transport.startCall({\n\t\t\t\tmedia: this.media,\n\t\t\t});\n\t\t});\n\t}\n\n\tstartCallAsMonitor(media: MediaStreamConstraints = {}, ...args: unknown[]) {\n\t\tthis.log('startCallAsMonitor', [media, ...args]);\n\t\tthis.media = media;\n\t\tthis.active = true;\n\t\tthis.monitor = true;\n\t\tthis.transport.startCall({\n\t\t\tmedia: this.media,\n\t\t\tmonitor: true,\n\t\t});\n\t}\n\n\tonRemoteCall(data: CallData) {\n\t\tif (this.autoAccept === true) {\n\t\t\tsetTimeout(() => {\n\t\t\t\tthis.joinCall({\n\t\t\t\t\tto: data.from,\n\t\t\t\t\tmonitor: data.monitor,\n\t\t\t\t\tmedia: data.media,\n\t\t\t\t});\n\t\t\t}, 0);\n\t\t\treturn;\n\t\t}\n\n\t\tconst user = Meteor.users.findOne(data.from);\n\t\tlet fromUsername = undefined;\n\t\tif (user?.username) {\n\t\t\tfromUsername = user.username;\n\t\t}\n\t\tconst subscription = ChatSubscription.findOne({\n\t\t\trid: data.room,\n\t\t})!;\n\n\t\tlet icon;\n\t\tlet title;\n\t\tif (data.monitor === true) {\n\t\t\ticon = 'eye' as const;\n\t\t\ttitle = t('WebRTC_monitor_call_from_%s', fromUsername);\n\t\t} else if (subscription && subscription.t === 'd') {\n\t\t\tif (data.media?.video) {\n\t\t\t\ticon = 'video' as const;\n\t\t\t\ttitle = t('WebRTC_direct_video_call_from_%s', fromUsername);\n\t\t\t} else {\n\t\t\t\ticon = 'phone' as const;\n\t\t\t\ttitle = t('WebRTC_direct_audio_call_from_%s', fromUsername);\n\t\t\t}\n\t\t} else if (data.media?.video) {\n\t\t\ticon = 'video' as const;\n\t\t\ttitle = t('WebRTC_group_video_call_from_%s', subscription.name);\n\t\t} else {\n\t\t\ticon = 'phone' as const;\n\t\t\ttitle = t('WebRTC_group_audio_call_from_%s', subscription.name);\n\t\t}\n\n\t\timperativeModal.open({\n\t\t\tcomponent: GenericModal,\n\t\t\tprops: {\n\t\t\t\ttitle,\n\t\t\t\ticon,\n\t\t\t\tconfirmText: t('Yes'),\n\t\t\t\tcancelText: t('No'),\n\t\t\t\tchildren: t('Do_you_want_to_accept'),\n\t\t\t\tonConfirm: () => {\n\t\t\t\t\tvoid goToRoomById(data.room!);\n\t\t\t\t\treturn this.joinCall({\n\t\t\t\t\t\tto: data.from,\n\t\t\t\t\t\tmonitor: data.monitor,\n\t\t\t\t\t\tmedia: data.media,\n\t\t\t\t\t});\n\t\t\t\t},\n\t\t\t\tonCancel: () => this.stop(),\n\t\t\t\tonClose: () => this.stop(),\n\t\t\t},\n\t\t});\n\t}\n\n\tjoinCall(data: JoinData = {}, ...args: unknown[]) {\n\t\tdata.media = this.media;\n\t\tthis.log('joinCall', [data, ...args]);\n\t\tthis.getLocalUserMedia(() => {\n\t\t\tthis.remoteMonitoring = data.monitor!;\n\t\t\tthis.active = true;\n\t\t\tthis.transport.joinCall(data);\n\t\t});\n\t}\n\n\tonRemoteJoin(data: JoinData, ...args: unknown[]) {\n\t\tif (this.active !== true) {\n\t\t\treturn;\n\t\t}\n\t\tthis.log('onRemoteJoin', [data, ...args]);\n\t\tlet peerConnection = this.getPeerConnection(data.from!);\n\n\t\t// needsRefresh = false\n\t\t// if peerConnection.iceConnectionState isnt 'new'\n\t\t// needsAudio = data.media.audio is true and peerConnection.remoteMedia.audio isnt true\n\t\t// needsVideo = data.media.video is true and peerConnection.remoteMedia.video isnt true\n\t\t// needsRefresh = needsAudio or needsVideo or data.media.desktop isnt peerConnection.remoteMedia.desktop\n\n\t\t// # if peerConnection.signalingState is \"have-local-offer\" or needsRefresh\n\n\t\tif ((peerConnection.signalingState as RTCSignalingState | 'checking') !== 'checking') {\n\t\t\tthis.stopPeerConnection(data.from!);\n\t\t\tpeerConnection = this.getPeerConnection(data.from!);\n\t\t}\n\t\tif (peerConnection.iceConnectionState !== 'new') {\n\t\t\treturn;\n\t\t}\n\t\tpeerConnection.remoteMedia = data.media!;\n\t\tif (this.localStream) {\n\t\t\tpeerConnection.addStream(this.localStream);\n\t\t}\n\t\tconst onOffer: RTCSessionDescriptionCallback = (offer) => {\n\t\t\tconst onLocalDescription = () => {\n\t\t\t\tthis.transport.sendDescription({\n\t\t\t\t\tto: data.from,\n\t\t\t\t\ttype: 'offer',\n\t\t\t\t\tts: peerConnection.createdAt,\n\t\t\t\t\tmedia: this.media,\n\t\t\t\t\tdescription: {\n\t\t\t\t\t\tsdp: offer.sdp,\n\t\t\t\t\t\ttype: offer.type,\n\t\t\t\t\t},\n\t\t\t\t});\n\t\t\t};\n\n\t\t\tvoid peerConnection.setLocalDescription(new RTCSessionDescription(offer), onLocalDescription, this.onError);\n\t\t};\n\n\t\tif (data.monitor === true) {\n\t\t\tvoid peerConnection.createOffer(onOffer, this.onError, {\n\t\t\t\tmandatory: {\n\t\t\t\t\tOfferToReceiveAudio: data.media?.audio,\n\t\t\t\t\tOfferToReceiveVideo: data.media?.video,\n\t\t\t\t},\n\t\t\t});\n\t\t} else {\n\t\t\tvoid peerConnection.createOffer(onOffer, this.onError);\n\t\t}\n\t}\n\n\tonRemoteOffer(data: Omit<DescriptionData, 'type'>, ...args: unknown[]) {\n\t\tif (this.active !== true) {\n\t\t\treturn;\n\t\t}\n\n\t\tthis.log('onRemoteOffer', [data, ...args]);\n\t\tlet peerConnection = this.getPeerConnection(data.from!);\n\n\t\tif (['have-local-offer', 'stable'].includes(peerConnection.signalingState) && peerConnection.createdAt < data.ts) {\n\t\t\tthis.stopPeerConnection(data.from!);\n\t\t\tpeerConnection = this.getPeerConnection(data.from!);\n\t\t}\n\n\t\tif (peerConnection.iceConnectionState !== 'new') {\n\t\t\treturn;\n\t\t}\n\n\t\tvoid peerConnection.setRemoteDescription(new RTCSessionDescription(data.description));\n\n\t\ttry {\n\t\t\tif (this.localStream) {\n\t\t\t\tpeerConnection.addStream(this.localStream);\n\t\t\t}\n\t\t} catch (error) {\n\t\t\tconsole.log(error);\n\t\t}\n\n\t\tconst onAnswer: RTCSessionDescriptionCallback = (answer) => {\n\t\t\tconst onLocalDescription = () => {\n\t\t\t\tthis.transport.sendDescription({\n\t\t\t\t\tto: data.from,\n\t\t\t\t\ttype: 'answer',\n\t\t\t\t\tts: peerConnection.createdAt,\n\t\t\t\t\tdescription: {\n\t\t\t\t\t\tsdp: answer.sdp,\n\t\t\t\t\t\ttype: answer.type,\n\t\t\t\t\t},\n\t\t\t\t});\n\t\t\t};\n\n\t\t\tvoid peerConnection.setLocalDescription(new RTCSessionDescription(answer), onLocalDescription, this.onError);\n\t\t};\n\n\t\tvoid peerConnection.createAnswer(onAnswer, this.onError);\n\t}\n\n\tonRemoteCandidate(data: CandidateData, ...args: unknown[]) {\n\t\tif (this.active !== true) {\n\t\t\treturn;\n\t\t}\n\t\tif (data.to !== this.selfId) {\n\t\t\treturn;\n\t\t}\n\t\tthis.log('onRemoteCandidate', [data, ...args]);\n\t\tconst peerConnection = this.getPeerConnection(data.from!);\n\t\tif (\n\t\t\tpeerConnection.iceConnectionState !== 'closed' &&\n\t\t\tpeerConnection.iceConnectionState !== 'failed' &&\n\t\t\tpeerConnection.iceConnectionState !== 'disconnected' &&\n\t\t\tpeerConnection.iceConnectionState !== 'completed'\n\t\t) {\n\t\t\tvoid peerConnection.addIceCandidate(new RTCIceCandidate(data.candidate));\n\t\t}\n\t\tdocument.querySelector<HTMLVideoElement>('video#remoteVideo')!.srcObject = this.remoteItems.get()[0]?.url;\n\t}\n\n\tonRemoteDescription(data: DescriptionData, ...args: unknown[]) {\n\t\tif (this.active !== true) {\n\t\t\treturn;\n\t\t}\n\t\tif (data.to !== this.selfId) {\n\t\t\treturn;\n\t\t}\n\t\tthis.log('onRemoteDescription', [data, ...args]);\n\t\tconst peerConnection = this.getPeerConnection(data.from!);\n\t\tif (data.type === 'offer') {\n\t\t\tpeerConnection.remoteMedia = data.media;\n\t\t\tthis.onRemoteOffer({\n\t\t\t\tfrom: data.from,\n\t\t\t\tts: data.ts,\n\t\t\t\tdescription: data.description,\n\t\t\t});\n\t\t} else {\n\t\t\tvoid peerConnection.setRemoteDescription(new RTCSessionDescription(data.description));\n\t\t}\n\t}\n}\n\nconst WebRTC = new (class {\n\tinstancesByRoomId: Record<string, WebRTCClass> = {};\n\n\tconstructor() {\n\t\tthis.instancesByRoomId = {};\n\t}\n\n\tgetInstanceByRoomId(rid: IRoom['_id'], visitorId: string | null = null) {\n\t\tlet enabled = false;\n\t\tif (!visitorId) {\n\t\t\tconst subscription = ChatSubscription.findOne({ rid });\n\t\t\tif (!subscription) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tswitch (subscription.t) {\n\t\t\t\tcase 'd':\n\t\t\t\t\tenabled = settings.get('WebRTC_Enable_Direct');\n\t\t\t\t\tbreak;\n\t\t\t\tcase 'p':\n\t\t\t\t\tenabled = settings.get('WebRTC_Enable_Private');\n\t\t\t\t\tbreak;\n\t\t\t\tcase 'c':\n\t\t\t\t\tenabled = settings.get('WebRTC_Enable_Channel');\n\t\t\t\t\tbreak;\n\t\t\t\tcase 'l':\n\t\t\t\t\tenabled = settings.get<string>('Omnichannel_call_provider') === 'WebRTC';\n\t\t\t}\n\t\t} else {\n\t\t\tenabled = settings.get<string>('Omnichannel_call_provider') === 'WebRTC';\n\t\t}\n\t\tenabled = enabled && settings.get('WebRTC_Enabled');\n\t\tif (enabled === false) {\n\t\t\treturn;\n\t\t}\n\t\tif (this.instancesByRoomId[rid] == null) {\n\t\t\tlet uid = Meteor.userId()!;\n\t\t\tlet autoAccept = false;\n\t\t\tif (visitorId) {\n\t\t\t\tuid = visitorId;\n\t\t\t\tautoAccept = true;\n\t\t\t}\n\t\t\tthis.instancesByRoomId[rid] = new WebRTCClass(uid, rid, autoAccept);\n\t\t}\n\t\treturn this.instancesByRoomId[rid];\n\t}\n})();\n\nMeteor.startup(() => {\n\tTracker.autorun(() => {\n\t\tconst uid = Meteor.userId();\n\n\t\tif (uid) {\n\t\t\tsdk.stream('notify-user', [`${uid}/${WEB_RTC_EVENTS.WEB_RTC}`], (type, data) => {\n\t\t\t\tif (data.room == null) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\tconst webrtc = WebRTC.getInstanceByRoomId(data.room);\n\n\t\t\t\tswitch (type) {\n\t\t\t\t\tcase 'candidate':\n\t\t\t\t\t\twebrtc?.onUserStream('candidate', data);\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tcase 'description':\n\t\t\t\t\t\twebrtc?.onUserStream('description', data);\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tcase 'join':\n\t\t\t\t\t\twebrtc?.onUserStream('join', data);\n\t\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t});\n});\n\nexport { WebRTC };\n"]},"targets":{"android":"125.0.0","chrome":"125.0.0","edge":"125.0.0","firefox":"115.0.0","ie":"10.0.0","ios":"17.4.0","opera":"110.0.0","opera_mobile":"80.0.0","safari":"17.4.0","samsung":"24.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor","root":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":false,"enforceStrictMode":false,"dynamicImport":true,"generateLetDeclarations":true},"externalDependencies":[]},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"version":"7.17.2","helpers":true,"useESModules":false,"corejs":false},"externalDependencies":[]},{"key":"proposal-class-properties","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true},"externalDependencies":[]},{"key":"transform-react-jsx","visitor":{"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXFragment":{"exit":[null]},"JSXElement":{"exit":[null]},"JSXAttribute":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false},"externalDependencies":[]},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-nullish-coalescing-operator","visitor":{"LogicalExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-optional-chaining","visitor":{"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-optional-catch-binding","visitor":{"CatchClause":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-class-properties","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-async-generator-functions","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-logical-assignment-operators","visitor":{"AssignmentExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]}],"presets":[],"generatorOpts":{"filename":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/app/webrtc/client/WebRTCClass.ts","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"app/webrtc/client/WebRTCClass.ts","inputSourceMap":{"version":3,"file":"app/webrtc/client/WebRTCClass.ts","sourceRoot":"","sources":["app/webrtc/client/WebRTCClass.ts"],"names":[],"mappings":"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","sourcesContent":["import type { IRoom } from '@rocket.chat/core-typings';\nimport type { StreamKeys, StreamNames, StreamerCallbackArgs } from '@rocket.chat/ddp-client';\nimport { Emitter } from '@rocket.chat/emitter';\nimport { Meteor } from 'meteor/meteor';\nimport { ReactiveVar } from 'meteor/reactive-var';\nimport { Tracker } from 'meteor/tracker';\n\nimport { ChromeScreenShare } from './screenShare';\nimport GenericModal from '../../../client/components/GenericModal';\nimport { imperativeModal } from '../../../client/lib/imperativeModal';\nimport { goToRoomById } from '../../../client/lib/utils/goToRoomById';\nimport { ChatSubscription } from '../../models/client';\nimport { settings } from '../../settings/client';\nimport { sdk } from '../../utils/client/lib/SDKClient';\nimport { t } from '../../utils/lib/i18n';\nimport { WEB_RTC_EVENTS } from '../lib/constants';\n\n// FIXME: there is a mix of obsolete definitions and incorrect field assignments\n\ndeclare global {\n\t// eslint-disable-next-line @typescript-eslint/naming-convention\n\tinterface RTCPeerConnection {\n\t\t/** @deprecated non-standard */\n\t\tcreatedAt: number;\n\t\t/** @deprecated non-standard */\n\t\tremoteMedia: MediaStreamConstraints;\n\t}\n\n\t// eslint-disable-next-line @typescript-eslint/naming-convention\n\tinterface RTCOfferOptions {\n\t\t/** @deprecated non-standard */\n\t\tmandatory?: unknown;\n\t}\n\n\t// eslint-disable-next-line @typescript-eslint/naming-convention\n\tinterface MediaStream {\n\t\t/** @deprecated non-standard */\n\t\tvolume?: GainNode;\n\t}\n\n\t// eslint-disable-next-line @typescript-eslint/naming-convention\n\tinterface MediaStreamConstraints {\n\t\t/** @deprecated non-standard */\n\t\tdesktop?: boolean;\n\t}\n\n\t/** @deprecated browser-specific global */\n\tconst chrome: {\n\t\twebstore: {\n\t\t\tinstall(url: string, onSuccess: () => void, onError: (error: any) => void): void;\n\t\t};\n\t};\n\n\t// eslint-disable-next-line @typescript-eslint/naming-convention\n\tinterface Window {\n\t\trocketchatscreenshare?: unknown;\n\t\taudioContext?: AudioContext;\n\t}\n}\n\ntype EventData<TStreamName extends StreamNames, TStreamKey extends StreamKeys<TStreamName>, TType> = Extract<\n\tStreamerCallbackArgs<TStreamName, TStreamKey>,\n\t[type: TType, data: any]\n>[1];\n\ntype StatusData = EventData<'notify-room', `${string}/webrtc`, 'status'>;\ntype CallData = EventData<'notify-room-users', `${string}/webrtc`, 'call'>;\ntype CandidateData = EventData<'notify-user', `${string}/webrtc`, 'candidate'>;\ntype DescriptionData = EventData<'notify-user', `${string}/webrtc`, 'description'>;\ntype JoinData = EventData<'notify-user', `${string}/webrtc`, 'join'>;\n\ntype RemoteItem = {\n\tid: string;\n\turl: MediaStream;\n\tstate: RTCIceConnectionState;\n\tstateText?: string;\n\tconnected?: boolean;\n};\n\ntype RemoteConnection = {\n\tid: string;\n\tmedia: MediaStreamConstraints;\n};\n\nclass WebRTCTransportClass extends Emitter<{\n\tstatus: StatusData;\n\tcall: CallData;\n\tcandidate: CandidateData;\n\tdescription: DescriptionData;\n\tjoin: JoinData;\n}> {\n\tpublic debug = false;\n\n\tconstructor(public webrtcInstance: WebRTCClass) {\n\t\tsuper();\n\t\tsdk.stream('notify-room', [`${this.webrtcInstance.room}/${WEB_RTC_EVENTS.WEB_RTC}`], (type, data) => {\n\t\t\tthis.log('WebRTCTransportClass - onRoom', type, data);\n\t\t\tthis.emit(type, data);\n\t\t});\n\t}\n\n\tlog(...args: unknown[]) {\n\t\tif (this.debug === true) {\n\t\t\tconsole.log(...args);\n\t\t}\n\t}\n\n\tonUserStream(type: 'candidate', data: CandidateData): void;\n\n\tonUserStream(type: 'description', data: DescriptionData): void;\n\n\tonUserStream(type: 'join', data: JoinData): void;\n\n\tonUserStream(\n\t\t...[type, data]:\n\t\t\t| [type: 'candidate', data: CandidateData]\n\t\t\t| [type: 'description', data: DescriptionData]\n\t\t\t| [type: 'join', data: JoinData]\n\t) {\n\t\tif (data.room !== this.webrtcInstance.room) {\n\t\t\treturn;\n\t\t}\n\n\t\tthis.log('WebRTCTransportClass - onUser', type, data);\n\n\t\tswitch (type) {\n\t\t\tcase 'candidate':\n\t\t\t\tthis.emit('candidate', data);\n\t\t\t\tbreak;\n\t\t\tcase 'description':\n\t\t\t\tthis.emit('description', data);\n\t\t\t\tbreak;\n\t\t\tcase 'join':\n\t\t\t\tthis.emit('join', data);\n\t\t\t\tbreak;\n\t\t}\n\t}\n\n\tstartCall(data: CallData) {\n\t\tthis.log('WebRTCTransportClass - startCall', this.webrtcInstance.room, this.webrtcInstance.selfId);\n\t\tsdk.publish('notify-room-users', [\n\t\t\t`${this.webrtcInstance.room}/${WEB_RTC_EVENTS.WEB_RTC}`,\n\t\t\tWEB_RTC_EVENTS.CALL,\n\t\t\t{\n\t\t\t\tfrom: this.webrtcInstance.selfId,\n\t\t\t\troom: this.webrtcInstance.room,\n\t\t\t\tmedia: data.media,\n\t\t\t\tmonitor: data.monitor,\n\t\t\t},\n\t\t]);\n\t}\n\n\tjoinCall(data: JoinData) {\n\t\tthis.log('WebRTCTransportClass - joinCall', this.webrtcInstance.room, this.webrtcInstance.selfId);\n\t\tif (data.monitor === true) {\n\t\t\tsdk.publish('notify-user', [\n\t\t\t\t`${data.to}/${WEB_RTC_EVENTS.WEB_RTC}`,\n\t\t\t\tWEB_RTC_EVENTS.JOIN,\n\t\t\t\t{\n\t\t\t\t\tfrom: this.webrtcInstance.selfId,\n\t\t\t\t\troom: this.webrtcInstance.room,\n\t\t\t\t\tmedia: data.media,\n\t\t\t\t\tmonitor: data.monitor,\n\t\t\t\t},\n\t\t\t]);\n\t\t} else {\n\t\t\tsdk.publish('notify-room-users', [\n\t\t\t\t`${this.webrtcInstance.room}/${WEB_RTC_EVENTS.WEB_RTC}`,\n\t\t\t\tWEB_RTC_EVENTS.JOIN,\n\t\t\t\t{\n\t\t\t\t\tfrom: this.webrtcInstance.selfId,\n\t\t\t\t\troom: this.webrtcInstance.room,\n\t\t\t\t\tmedia: data.media,\n\t\t\t\t\tmonitor: data.monitor,\n\t\t\t\t},\n\t\t\t]);\n\t\t}\n\t}\n\n\tsendCandidate(data: CandidateData) {\n\t\tdata.from = this.webrtcInstance.selfId;\n\t\tdata.room = this.webrtcInstance.room;\n\t\tthis.log('WebRTCTransportClass - sendCandidate', data);\n\t\tsdk.publish('notify-user', [`${data.to}/${WEB_RTC_EVENTS.WEB_RTC}`, WEB_RTC_EVENTS.CANDIDATE, data]);\n\t}\n\n\tsendDescription(data: DescriptionData) {\n\t\tdata.from = this.webrtcInstance.selfId;\n\t\tdata.room = this.webrtcInstance.room;\n\t\tthis.log('WebRTCTransportClass - sendDescription', data);\n\t\tsdk.publish('notify-user', [`${data.to}/${WEB_RTC_EVENTS.WEB_RTC}`, WEB_RTC_EVENTS.DESCRIPTION, data]);\n\t}\n\n\tsendStatus(data: StatusData) {\n\t\tthis.log('WebRTCTransportClass - sendStatus', data, this.webrtcInstance.room);\n\t\tdata.from = this.webrtcInstance.selfId;\n\t\tsdk.publish('notify-room', [`${this.webrtcInstance.room}/${WEB_RTC_EVENTS.WEB_RTC}`, WEB_RTC_EVENTS.STATUS, data]);\n\t}\n\n\tonRemoteCall(fn: (data: CallData) => void) {\n\t\treturn this.on(WEB_RTC_EVENTS.CALL, fn);\n\t}\n\n\tonRemoteJoin(fn: (data: JoinData) => void) {\n\t\treturn this.on(WEB_RTC_EVENTS.JOIN, fn);\n\t}\n\n\tonRemoteCandidate(fn: (data: CandidateData) => void) {\n\t\treturn this.on(WEB_RTC_EVENTS.CANDIDATE, fn);\n\t}\n\n\tonRemoteDescription(fn: (data: DescriptionData) => void) {\n\t\treturn this.on(WEB_RTC_EVENTS.DESCRIPTION, fn);\n\t}\n\n\tonRemoteStatus(fn: (data: StatusData) => void) {\n\t\treturn this.on(WEB_RTC_EVENTS.STATUS, fn);\n\t}\n}\n\nclass WebRTCClass {\n\ttransport: WebRTCTransportClass;\n\n\tconfig: { iceServers: RTCIceServer[] };\n\n\tdebug: boolean;\n\n\tTransportClass: typeof WebRTCTransportClass;\n\n\tpeerConnections: Record<string, RTCPeerConnection> = {};\n\n\tremoteItems: ReactiveVar<RemoteItem[]>;\n\n\tremoteItemsById: ReactiveVar<Record<string, RemoteItem>>;\n\n\tcallInProgress: ReactiveVar<boolean>;\n\n\taudioEnabled: ReactiveVar<boolean>;\n\n\tvideoEnabled: ReactiveVar<boolean>;\n\n\toverlayEnabled: ReactiveVar<boolean>;\n\n\tscreenShareEnabled: ReactiveVar<boolean>;\n\n\tlocalUrl: ReactiveVar<MediaStream | undefined>;\n\n\tactive: boolean;\n\n\tremoteMonitoring: boolean;\n\n\tmonitor: boolean;\n\n\tnavigator: string | undefined;\n\n\tscreenShareAvailable: boolean;\n\n\tmedia: MediaStreamConstraints;\n\n\tconstructor(\n\t\tpublic selfId: string,\n\t\tpublic room: string,\n\t\tpublic autoAccept = false,\n\t) {\n\t\tthis.config = {\n\t\t\ticeServers: [],\n\t\t};\n\t\tthis.debug = false;\n\t\tthis.TransportClass = WebRTCTransportClass;\n\t\tlet servers = settings.get<string>('WebRTC_Servers');\n\t\tif (servers && servers.trim() !== '') {\n\t\t\tservers = servers.replace(/\\s/g, '');\n\n\t\t\tservers.split(',').forEach((server) => {\n\t\t\t\tconst parts = server.split('@');\n\t\t\t\tconst serverConfig: RTCIceServer = {\n\t\t\t\t\turls: parts.pop()!,\n\t\t\t\t};\n\t\t\t\tif (parts.length === 1) {\n\t\t\t\t\tconst [username, credential] = parts[0].split(':');\n\t\t\t\t\tserverConfig.username = decodeURIComponent(username);\n\t\t\t\t\tserverConfig.credential = decodeURIComponent(credential);\n\t\t\t\t}\n\t\t\t\tthis.config.iceServers.push(serverConfig);\n\t\t\t});\n\t\t}\n\t\tthis.peerConnections = {};\n\t\tthis.remoteItems = new ReactiveVar([]);\n\t\tthis.remoteItemsById = new ReactiveVar({});\n\t\tthis.callInProgress = new ReactiveVar(false);\n\t\tthis.audioEnabled = new ReactiveVar(false);\n\t\tthis.videoEnabled = new ReactiveVar(false);\n\t\tthis.overlayEnabled = new ReactiveVar(false);\n\t\tthis.screenShareEnabled = new ReactiveVar(false);\n\t\tthis.localUrl = new ReactiveVar(undefined);\n\t\tthis.active = false;\n\t\tthis.remoteMonitoring = false;\n\t\tthis.monitor = false;\n\t\tthis.navigator = undefined;\n\t\tconst userAgent = navigator.userAgent.toLocaleLowerCase();\n\n\t\tif (userAgent.indexOf('electron') !== -1) {\n\t\t\tthis.navigator = 'electron';\n\t\t} else if (userAgent.indexOf('chrome') !== -1) {\n\t\t\tthis.navigator = 'chrome';\n\t\t} else if (userAgent.indexOf('firefox') !== -1) {\n\t\t\tthis.navigator = 'firefox';\n\t\t} else if (userAgent.indexOf('safari') !== -1) {\n\t\t\tthis.navigator = 'safari';\n\t\t}\n\n\t\tthis.screenShareAvailable = ['chrome', 'firefox', 'electron'].includes(this.navigator!);\n\t\tthis.media = {\n\t\t\tvideo: true,\n\t\t\taudio: true,\n\t\t};\n\t\tthis.transport = new this.TransportClass(this);\n\t\tthis.transport.onRemoteCall(this.onRemoteCall.bind(this));\n\t\tthis.transport.onRemoteJoin(this.onRemoteJoin.bind(this));\n\t\tthis.transport.onRemoteCandidate(this.onRemoteCandidate.bind(this));\n\t\tthis.transport.onRemoteDescription(this.onRemoteDescription.bind(this));\n\t\tthis.transport.onRemoteStatus(this.onRemoteStatus.bind(this));\n\n\t\tsetInterval(this.checkPeerConnections.bind(this), 1000);\n\t}\n\n\tonUserStream(type: 'candidate', data: CandidateData): void;\n\n\tonUserStream(type: 'description', data: DescriptionData): void;\n\n\tonUserStream(type: 'join', data: JoinData): void;\n\n\tonUserStream(\n\t\t...[type, data]:\n\t\t\t| [type: 'candidate', data: CandidateData]\n\t\t\t| [type: 'description', data: DescriptionData]\n\t\t\t| [type: 'join', data: JoinData]\n\t) {\n\t\tswitch (type) {\n\t\t\tcase 'candidate':\n\t\t\t\tthis.transport.onUserStream('candidate', data);\n\t\t\t\tbreak;\n\n\t\t\tcase 'description':\n\t\t\t\tthis.transport.onUserStream('description', data);\n\t\t\t\tbreak;\n\n\t\t\tcase 'join':\n\t\t\t\tthis.transport.onUserStream('join', data);\n\t\t\t\tbreak;\n\t\t}\n\t}\n\n\tlog(...args: unknown[]) {\n\t\tif (this.debug === true) {\n\t\t\tconsole.log(...args);\n\t\t}\n\t}\n\n\tonError(...args: unknown[]) {\n\t\tconsole.error(...args);\n\t}\n\n\tcheckPeerConnections() {\n\t\tconst { peerConnections } = this;\n\t\tconst date = Date.now();\n\t\tObject.entries(peerConnections).some(([id, peerConnection]) => {\n\t\t\tif (!['connected', 'completed'].includes(peerConnection.iceConnectionState) && peerConnection.createdAt + 5000 < date) {\n\t\t\t\tthis.stopPeerConnection(id);\n\t\t\t\treturn true;\n\t\t\t}\n\t\t\treturn false;\n\t\t});\n\t}\n\n\tupdateRemoteItems() {\n\t\tconst items: RemoteItem[] = [];\n\t\tconst itemsById: Record<string, RemoteItem> = {};\n\t\tconst { peerConnections } = this;\n\n\t\tObject.entries(peerConnections).forEach(([id, peerConnection]) => {\n\t\t\tpeerConnection.getRemoteStreams().forEach((remoteStream) => {\n\t\t\t\tconst item: RemoteItem = {\n\t\t\t\t\tid,\n\t\t\t\t\turl: remoteStream,\n\t\t\t\t\tstate: peerConnection.iceConnectionState,\n\t\t\t\t};\n\t\t\t\tswitch (peerConnection.iceConnectionState) {\n\t\t\t\t\tcase 'checking':\n\t\t\t\t\t\titem.stateText = 'Connecting...';\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tcase 'connected':\n\t\t\t\t\tcase 'completed':\n\t\t\t\t\t\titem.stateText = 'Connected';\n\t\t\t\t\t\titem.connected = true;\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tcase 'disconnected':\n\t\t\t\t\t\titem.stateText = 'Disconnected';\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tcase 'failed':\n\t\t\t\t\t\titem.stateText = 'Failed';\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tcase 'closed':\n\t\t\t\t\t\titem.stateText = 'Closed';\n\t\t\t\t}\n\t\t\t\titems.push(item);\n\t\t\t\titemsById[id] = item;\n\t\t\t});\n\t\t});\n\t\tthis.remoteItems.set(items);\n\t\tthis.remoteItemsById.set(itemsById);\n\t}\n\n\tresetCallInProgress = () => {\n\t\tthis.callInProgress.set(false);\n\t};\n\n\tbroadcastStatus() {\n\t\tif (this.active !== true || this.monitor === true || this.remoteMonitoring === true) {\n\t\t\treturn;\n\t\t}\n\t\tconst remoteConnections: RemoteConnection[] = [];\n\t\tconst { peerConnections } = this;\n\t\tObject.entries(peerConnections).forEach(([id, { remoteMedia: media }]) => {\n\t\t\tremoteConnections.push({\n\t\t\t\tid,\n\t\t\t\tmedia,\n\t\t\t});\n\t\t});\n\n\t\tthis.transport.sendStatus({\n\t\t\tmedia: this.media,\n\t\t\tremoteConnections,\n\t\t});\n\t}\n\n\tcallInProgressTimeout: ReturnType<typeof setTimeout> | undefined = undefined;\n\n\tonRemoteStatus(data: StatusData) {\n\t\t// this.log(onRemoteStatus, arguments);\n\t\tthis.callInProgress.set(true);\n\t\tclearTimeout(this.callInProgressTimeout);\n\t\tthis.callInProgressTimeout = setTimeout(this.resetCallInProgress, 2000);\n\t\tif (this.active !== true) {\n\t\t\treturn;\n\t\t}\n\t\tconst remoteConnections = [\n\t\t\t{\n\t\t\t\tid: data.from!,\n\t\t\t\tmedia: data.media,\n\t\t\t},\n\t\t\t...data.remoteConnections,\n\t\t];\n\n\t\tremoteConnections.forEach((remoteConnection) => {\n\t\t\tif (remoteConnection.id !== this.selfId && this.peerConnections[remoteConnection.id] == null) {\n\t\t\t\tthis.log('reconnecting with', remoteConnection.id);\n\t\t\t\tthis.onRemoteJoin({\n\t\t\t\t\tfrom: remoteConnection.id,\n\t\t\t\t\tmedia: remoteConnection.media,\n\t\t\t\t});\n\t\t\t}\n\t\t});\n\t}\n\n\tgetPeerConnection(id: string) {\n\t\tif (this.peerConnections[id] != null) {\n\t\t\treturn this.peerConnections[id];\n\t\t}\n\t\tconst peerConnection = new RTCPeerConnection(this.config);\n\n\t\tpeerConnection.createdAt = Date.now();\n\t\tpeerConnection.remoteMedia = {};\n\t\tthis.peerConnections[id] = peerConnection;\n\t\tconst eventNames = [\n\t\t\t'icecandidate',\n\t\t\t'addstream',\n\t\t\t'removestream',\n\t\t\t'iceconnectionstatechange',\n\t\t\t'datachannel',\n\t\t\t'identityresult',\n\t\t\t'idpassertionerror',\n\t\t\t'idpvalidationerror',\n\t\t\t'negotiationneeded',\n\t\t\t'peeridentity',\n\t\t\t'signalingstatechange',\n\t\t];\n\n\t\teventNames.forEach((eventName) => {\n\t\t\tpeerConnection.addEventListener(eventName, (e) => {\n\t\t\t\tthis.log(id, e.type, e);\n\t\t\t});\n\t\t});\n\n\t\tpeerConnection.addEventListener('icecandidate', (e) => {\n\t\t\tif (e.candidate == null) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tthis.transport.sendCandidate({\n\t\t\t\tto: id,\n\t\t\t\tcandidate: {\n\t\t\t\t\tcandidate: e.candidate.candidate,\n\t\t\t\t\tsdpMLineIndex: e.candidate.sdpMLineIndex,\n\t\t\t\t\tsdpMid: e.candidate.sdpMid,\n\t\t\t\t},\n\t\t\t});\n\t\t});\n\t\tpeerConnection.addEventListener('addstream', () => {\n\t\t\tthis.updateRemoteItems();\n\t\t});\n\t\tpeerConnection.addEventListener('removestream', () => {\n\t\t\tthis.updateRemoteItems();\n\t\t});\n\t\tpeerConnection.addEventListener('iceconnectionstatechange', () => {\n\t\t\tif (\n\t\t\t\t(peerConnection.iceConnectionState === 'disconnected' || peerConnection.iceConnectionState === 'closed') &&\n\t\t\t\tpeerConnection === this.peerConnections[id]\n\t\t\t) {\n\t\t\t\tthis.stopPeerConnection(id);\n\t\t\t\tsetTimeout(() => {\n\t\t\t\t\tif (Object.keys(this.peerConnections).length === 0) {\n\t\t\t\t\t\tthis.stop();\n\t\t\t\t\t}\n\t\t\t\t}, 3000);\n\t\t\t}\n\t\t\tthis.updateRemoteItems();\n\t\t});\n\t\treturn peerConnection;\n\t}\n\n\taudioContext: AudioContext | undefined;\n\n\t_getUserMedia(media: MediaStreamConstraints, onSuccess: (stream: MediaStream) => void, onError: (error?: any) => void) {\n\t\tconst onSuccessLocal = (stream: MediaStream) => {\n\t\t\tif (AudioContext && stream.getAudioTracks().length > 0) {\n\t\t\t\tconst audioContext = new AudioContext();\n\t\t\t\tconst source = audioContext.createMediaStreamSource(stream);\n\t\t\t\tconst volume = audioContext.createGain();\n\t\t\t\tsource.connect(volume);\n\t\t\t\tconst peer = audioContext.createMediaStreamDestination();\n\t\t\t\tvolume.connect(peer);\n\t\t\t\tvolume.gain.value = 0.6;\n\t\t\t\tstream.removeTrack(stream.getAudioTracks()[0]);\n\t\t\t\tstream.addTrack(peer.stream.getAudioTracks()[0]);\n\t\t\t\tstream.volume = volume;\n\t\t\t\tthis.audioContext = audioContext;\n\t\t\t}\n\t\t\tonSuccess(stream);\n\t\t};\n\n\t\tif (navigator.mediaDevices?.getUserMedia) {\n\t\t\treturn navigator.mediaDevices.getUserMedia(media).then(onSuccessLocal).catch(onError);\n\t\t}\n\n\t\tnavigator.getUserMedia?.(media, onSuccessLocal, onError);\n\t}\n\n\tgetUserMedia(media: MediaStreamConstraints, onSuccess: (stream: MediaStream) => void, onError: (error: any) => void = this.onError) {\n\t\tif (media.desktop !== true) {\n\t\t\tvoid this._getUserMedia(media, onSuccess, onError);\n\t\t\treturn;\n\t\t}\n\t\tif (this.screenShareAvailable !== true) {\n\t\t\tconsole.log('Screen share is not avaliable');\n\t\t\treturn;\n\t\t}\n\t\tconst getScreen = (audioStream?: MediaStream) => {\n\t\t\tconst refresh = function () {\n\t\t\t\timperativeModal.open({\n\t\t\t\t\tcomponent: GenericModal,\n\t\t\t\t\tprops: {\n\t\t\t\t\t\tvariant: 'warning',\n\t\t\t\t\t\ttitle: t('Refresh_your_page_after_install_to_enable_screen_sharing'),\n\t\t\t\t\t},\n\t\t\t\t});\n\t\t\t};\n\n\t\t\tconst isChromeExtensionInstalled = this.navigator === 'chrome' && ChromeScreenShare.installed;\n\t\t\tconst isFirefoxExtensionInstalled = this.navigator === 'firefox' && window.rocketchatscreenshare != null;\n\n\t\t\tif (!isChromeExtensionInstalled && !isFirefoxExtensionInstalled) {\n\t\t\t\timperativeModal.open({\n\t\t\t\t\tcomponent: GenericModal,\n\t\t\t\t\tprops: {\n\t\t\t\t\t\ttitle: t('Screen_Share'),\n\t\t\t\t\t\tvariant: 'warning',\n\t\t\t\t\t\tconfirmText: t('Install_Extension'),\n\t\t\t\t\t\tcancelText: t('Cancel'),\n\t\t\t\t\t\tchildren: t('You_need_install_an_extension_to_allow_screen_sharing'),\n\t\t\t\t\t\tonConfirm: () => {\n\t\t\t\t\t\t\tif (this.navigator === 'chrome') {\n\t\t\t\t\t\t\t\tconst url = 'https://chrome.google.com/webstore/detail/rocketchat-screen-share/nocfbnnmjnndkbipkabodnheejiegccf';\n\t\t\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\t\t\tchrome.webstore.install(url, refresh, () => {\n\t\t\t\t\t\t\t\t\t\twindow.open(url);\n\t\t\t\t\t\t\t\t\t\trefresh();\n\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\t} catch (_error) {\n\t\t\t\t\t\t\t\t\tconsole.log(_error);\n\t\t\t\t\t\t\t\t\twindow.open(url);\n\t\t\t\t\t\t\t\t\trefresh();\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t} else if (this.navigator === 'firefox') {\n\t\t\t\t\t\t\t\twindow.open('https://addons.mozilla.org/en-GB/firefox/addon/rocketchat-screen-share/');\n\t\t\t\t\t\t\t\trefresh();\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t});\n\n\t\t\t\treturn onError(false);\n\t\t\t}\n\n\t\t\tconst getScreenSuccess = (stream: MediaStream) => {\n\t\t\t\tif (audioStream != null) {\n\t\t\t\t\tstream.addTrack(audioStream.getAudioTracks()[0]);\n\t\t\t\t}\n\t\t\t\tonSuccess(stream);\n\t\t\t};\n\t\t\tif (this.navigator === 'firefox') {\n\t\t\t\tmedia = {\n\t\t\t\t\taudio: media.audio,\n\t\t\t\t\tvideo: {\n\t\t\t\t\t\tmozMediaSource: 'window',\n\t\t\t\t\t\tmediaSource: 'window',\n\t\t\t\t\t},\n\t\t\t\t};\n\t\t\t\tvoid this._getUserMedia(media, getScreenSuccess, onError);\n\t\t\t} else {\n\t\t\t\tChromeScreenShare.getSourceId(this.navigator!, (id) => {\n\t\t\t\t\tmedia = {\n\t\t\t\t\t\taudio: false,\n\t\t\t\t\t\tvideo: {\n\t\t\t\t\t\t\tmandatory: {\n\t\t\t\t\t\t\t\tchromeMediaSource: 'desktop',\n\t\t\t\t\t\t\t\tchromeMediaSourceId: id,\n\t\t\t\t\t\t\t\tmaxWidth: 1280,\n\t\t\t\t\t\t\t\tmaxHeight: 720,\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t};\n\t\t\t\t\tvoid this._getUserMedia(media, getScreenSuccess, onError);\n\t\t\t\t});\n\t\t\t}\n\t\t};\n\t\tif (this.navigator === 'firefox' || media.audio == null || media.audio === false) {\n\t\t\tgetScreen();\n\t\t} else {\n\t\t\tconst getAudioSuccess = (audioStream: MediaStream) => {\n\t\t\t\tgetScreen(audioStream);\n\t\t\t};\n\t\t\tconst getAudioError = () => {\n\t\t\t\tgetScreen();\n\t\t\t};\n\n\t\t\tvoid this._getUserMedia(\n\t\t\t\t{\n\t\t\t\t\taudio: media.audio,\n\t\t\t\t},\n\t\t\t\tgetAudioSuccess,\n\t\t\t\tgetAudioError,\n\t\t\t);\n\t\t}\n\t}\n\n\tgetLocalUserMedia(callback: (...args: any[]) => void, ...args: unknown[]) {\n\t\tthis.log('getLocalUserMedia', [callback, ...args]);\n\t\tif (this.localStream != null) {\n\t\t\treturn callback(null, this.localStream);\n\t\t}\n\t\tconst onSuccess = (stream: MediaStream) => {\n\t\t\tthis.localStream = stream;\n\t\t\t!this.audioEnabled.get() && this.disableAudio();\n\t\t\t!this.videoEnabled.get() && this.disableVideo();\n\t\t\tthis.localUrl.set(stream);\n\t\t\tconst { peerConnections } = this;\n\t\t\tObject.entries(peerConnections).forEach(([, peerConnection]) => peerConnection.addStream(stream));\n\t\t\tdocument.querySelector<HTMLVideoElement>('video#localVideo')!.srcObject = stream;\n\t\t\tcallback(null, this.localStream);\n\t\t};\n\t\tconst onError = (error: any) => {\n\t\t\tcallback(false);\n\t\t\tthis.onError(error);\n\t\t};\n\t\tthis.getUserMedia(this.media, onSuccess, onError);\n\t}\n\n\tstopPeerConnection = (id: string) => {\n\t\tconst peerConnection = this.peerConnections[id];\n\t\tif (peerConnection == null) {\n\t\t\treturn;\n\t\t}\n\t\tdelete this.peerConnections[id];\n\t\tpeerConnection.close();\n\t\tthis.updateRemoteItems();\n\t};\n\n\tstopAllPeerConnections() {\n\t\tconst { peerConnections } = this;\n\n\t\tObject.keys(peerConnections).forEach(this.stopPeerConnection);\n\n\t\tvoid window.audioContext?.close(); // FIXME: probably should be `this.audioContext`\n\t}\n\n\tsetAudioEnabled(enabled = true) {\n\t\tif (this.localStream != null) {\n\t\t\tthis.localStream.getAudioTracks().forEach((audio) => {\n\t\t\t\taudio.enabled = enabled;\n\t\t\t});\n\t\t\tthis.audioEnabled.set(enabled);\n\t\t}\n\t}\n\n\tdisableAudio() {\n\t\tthis.setAudioEnabled(false);\n\t}\n\n\tenableAudio() {\n\t\tthis.setAudioEnabled(true);\n\t}\n\n\ttoggleAudio() {\n\t\tif (this.audioEnabled.get()) {\n\t\t\treturn this.disableAudio();\n\t\t}\n\t\treturn this.enableAudio();\n\t}\n\n\tlocalStream: MediaStream | undefined;\n\n\tsetVideoEnabled(enabled = true) {\n\t\tif (this.localStream != null) {\n\t\t\tthis.localStream.getVideoTracks().forEach((video) => {\n\t\t\t\tvideo.enabled = enabled;\n\t\t\t});\n\t\t\tthis.videoEnabled.set(enabled);\n\t\t}\n\t}\n\n\tdisableScreenShare() {\n\t\tthis.setScreenShareEnabled(false);\n\t}\n\n\tenableScreenShare() {\n\t\tthis.setScreenShareEnabled(true);\n\t}\n\n\tsetScreenShareEnabled(enabled = true) {\n\t\tif (this.localStream != null) {\n\t\t\tthis.media.desktop = enabled;\n\t\t\tdelete this.localStream;\n\t\t\tthis.getLocalUserMedia((err) => {\n\t\t\t\tif (err != null) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\tthis.screenShareEnabled.set(enabled);\n\t\t\t\tthis.stopAllPeerConnections();\n\t\t\t\tthis.joinCall();\n\t\t\t});\n\t\t}\n\t}\n\n\tdisableVideo() {\n\t\tthis.setVideoEnabled(false);\n\t}\n\n\tenableVideo() {\n\t\tthis.setVideoEnabled(true);\n\t}\n\n\ttoggleVideo() {\n\t\tif (this.videoEnabled.get()) {\n\t\t\treturn this.disableVideo();\n\t\t}\n\t\treturn this.enableVideo();\n\t}\n\n\tstop() {\n\t\tthis.active = false;\n\t\tthis.monitor = false;\n\t\tthis.remoteMonitoring = false;\n\t\tif (this.localStream != null && typeof this.localStream !== 'undefined') {\n\t\t\tthis.localStream.getTracks().forEach((track) => track.stop());\n\t\t}\n\t\tthis.localUrl.set(undefined);\n\t\tdelete this.localStream;\n\t\tthis.stopAllPeerConnections();\n\t}\n\n\tstartCall(media: MediaStreamConstraints = {}, ...args: unknown[]) {\n\t\tthis.log('startCall', [media, ...args]);\n\t\tthis.media = media;\n\t\tthis.getLocalUserMedia(() => {\n\t\t\tthis.active = true;\n\t\t\tthis.transport.startCall({\n\t\t\t\tmedia: this.media,\n\t\t\t});\n\t\t});\n\t}\n\n\tstartCallAsMonitor(media: MediaStreamConstraints = {}, ...args: unknown[]) {\n\t\tthis.log('startCallAsMonitor', [media, ...args]);\n\t\tthis.media = media;\n\t\tthis.active = true;\n\t\tthis.monitor = true;\n\t\tthis.transport.startCall({\n\t\t\tmedia: this.media,\n\t\t\tmonitor: true,\n\t\t});\n\t}\n\n\tonRemoteCall(data: CallData) {\n\t\tif (this.autoAccept === true) {\n\t\t\tsetTimeout(() => {\n\t\t\t\tthis.joinCall({\n\t\t\t\t\tto: data.from,\n\t\t\t\t\tmonitor: data.monitor,\n\t\t\t\t\tmedia: data.media,\n\t\t\t\t});\n\t\t\t}, 0);\n\t\t\treturn;\n\t\t}\n\n\t\tconst user = Meteor.users.findOne(data.from);\n\t\tlet fromUsername = undefined;\n\t\tif (user?.username) {\n\t\t\tfromUsername = user.username;\n\t\t}\n\t\tconst subscription = ChatSubscription.findOne({\n\t\t\trid: data.room,\n\t\t})!;\n\n\t\tlet icon;\n\t\tlet title;\n\t\tif (data.monitor === true) {\n\t\t\ticon = 'eye' as const;\n\t\t\ttitle = t('WebRTC_monitor_call_from_%s', fromUsername);\n\t\t} else if (subscription && subscription.t === 'd') {\n\t\t\tif (data.media?.video) {\n\t\t\t\ticon = 'video' as const;\n\t\t\t\ttitle = t('WebRTC_direct_video_call_from_%s', fromUsername);\n\t\t\t} else {\n\t\t\t\ticon = 'phone' as const;\n\t\t\t\ttitle = t('WebRTC_direct_audio_call_from_%s', fromUsername);\n\t\t\t}\n\t\t} else if (data.media?.video) {\n\t\t\ticon = 'video' as const;\n\t\t\ttitle = t('WebRTC_group_video_call_from_%s', subscription.name);\n\t\t} else {\n\t\t\ticon = 'phone' as const;\n\t\t\ttitle = t('WebRTC_group_audio_call_from_%s', subscription.name);\n\t\t}\n\n\t\timperativeModal.open({\n\t\t\tcomponent: GenericModal,\n\t\t\tprops: {\n\t\t\t\ttitle,\n\t\t\t\ticon,\n\t\t\t\tconfirmText: t('Yes'),\n\t\t\t\tcancelText: t('No'),\n\t\t\t\tchildren: t('Do_you_want_to_accept'),\n\t\t\t\tonConfirm: () => {\n\t\t\t\t\tvoid goToRoomById(data.room!);\n\t\t\t\t\treturn this.joinCall({\n\t\t\t\t\t\tto: data.from,\n\t\t\t\t\t\tmonitor: data.monitor,\n\t\t\t\t\t\tmedia: data.media,\n\t\t\t\t\t});\n\t\t\t\t},\n\t\t\t\tonCancel: () => this.stop(),\n\t\t\t\tonClose: () => this.stop(),\n\t\t\t},\n\t\t});\n\t}\n\n\tjoinCall(data: JoinData = {}, ...args: unknown[]) {\n\t\tdata.media = this.media;\n\t\tthis.log('joinCall', [data, ...args]);\n\t\tthis.getLocalUserMedia(() => {\n\t\t\tthis.remoteMonitoring = data.monitor!;\n\t\t\tthis.active = true;\n\t\t\tthis.transport.joinCall(data);\n\t\t});\n\t}\n\n\tonRemoteJoin(data: JoinData, ...args: unknown[]) {\n\t\tif (this.active !== true) {\n\t\t\treturn;\n\t\t}\n\t\tthis.log('onRemoteJoin', [data, ...args]);\n\t\tlet peerConnection = this.getPeerConnection(data.from!);\n\n\t\t// needsRefresh = false\n\t\t// if peerConnection.iceConnectionState isnt 'new'\n\t\t// needsAudio = data.media.audio is true and peerConnection.remoteMedia.audio isnt true\n\t\t// needsVideo = data.media.video is true and peerConnection.remoteMedia.video isnt true\n\t\t// needsRefresh = needsAudio or needsVideo or data.media.desktop isnt peerConnection.remoteMedia.desktop\n\n\t\t// # if peerConnection.signalingState is \"have-local-offer\" or needsRefresh\n\n\t\tif ((peerConnection.signalingState as RTCSignalingState | 'checking') !== 'checking') {\n\t\t\tthis.stopPeerConnection(data.from!);\n\t\t\tpeerConnection = this.getPeerConnection(data.from!);\n\t\t}\n\t\tif (peerConnection.iceConnectionState !== 'new') {\n\t\t\treturn;\n\t\t}\n\t\tpeerConnection.remoteMedia = data.media!;\n\t\tif (this.localStream) {\n\t\t\tpeerConnection.addStream(this.localStream);\n\t\t}\n\t\tconst onOffer: RTCSessionDescriptionCallback = (offer) => {\n\t\t\tconst onLocalDescription = () => {\n\t\t\t\tthis.transport.sendDescription({\n\t\t\t\t\tto: data.from,\n\t\t\t\t\ttype: 'offer',\n\t\t\t\t\tts: peerConnection.createdAt,\n\t\t\t\t\tmedia: this.media,\n\t\t\t\t\tdescription: {\n\t\t\t\t\t\tsdp: offer.sdp,\n\t\t\t\t\t\ttype: offer.type,\n\t\t\t\t\t},\n\t\t\t\t});\n\t\t\t};\n\n\t\t\tvoid peerConnection.setLocalDescription(new RTCSessionDescription(offer), onLocalDescription, this.onError);\n\t\t};\n\n\t\tif (data.monitor === true) {\n\t\t\tvoid peerConnection.createOffer(onOffer, this.onError, {\n\t\t\t\tmandatory: {\n\t\t\t\t\tOfferToReceiveAudio: data.media?.audio,\n\t\t\t\t\tOfferToReceiveVideo: data.media?.video,\n\t\t\t\t},\n\t\t\t});\n\t\t} else {\n\t\t\tvoid peerConnection.createOffer(onOffer, this.onError);\n\t\t}\n\t}\n\n\tonRemoteOffer(data: Omit<DescriptionData, 'type'>, ...args: unknown[]) {\n\t\tif (this.active !== true) {\n\t\t\treturn;\n\t\t}\n\n\t\tthis.log('onRemoteOffer', [data, ...args]);\n\t\tlet peerConnection = this.getPeerConnection(data.from!);\n\n\t\tif (['have-local-offer', 'stable'].includes(peerConnection.signalingState) && peerConnection.createdAt < data.ts) {\n\t\t\tthis.stopPeerConnection(data.from!);\n\t\t\tpeerConnection = this.getPeerConnection(data.from!);\n\t\t}\n\n\t\tif (peerConnection.iceConnectionState !== 'new') {\n\t\t\treturn;\n\t\t}\n\n\t\tvoid peerConnection.setRemoteDescription(new RTCSessionDescription(data.description));\n\n\t\ttry {\n\t\t\tif (this.localStream) {\n\t\t\t\tpeerConnection.addStream(this.localStream);\n\t\t\t}\n\t\t} catch (error) {\n\t\t\tconsole.log(error);\n\t\t}\n\n\t\tconst onAnswer: RTCSessionDescriptionCallback = (answer) => {\n\t\t\tconst onLocalDescription = () => {\n\t\t\t\tthis.transport.sendDescription({\n\t\t\t\t\tto: data.from,\n\t\t\t\t\ttype: 'answer',\n\t\t\t\t\tts: peerConnection.createdAt,\n\t\t\t\t\tdescription: {\n\t\t\t\t\t\tsdp: answer.sdp,\n\t\t\t\t\t\ttype: answer.type,\n\t\t\t\t\t},\n\t\t\t\t});\n\t\t\t};\n\n\t\t\tvoid peerConnection.setLocalDescription(new RTCSessionDescription(answer), onLocalDescription, this.onError);\n\t\t};\n\n\t\tvoid peerConnection.createAnswer(onAnswer, this.onError);\n\t}\n\n\tonRemoteCandidate(data: CandidateData, ...args: unknown[]) {\n\t\tif (this.active !== true) {\n\t\t\treturn;\n\t\t}\n\t\tif (data.to !== this.selfId) {\n\t\t\treturn;\n\t\t}\n\t\tthis.log('onRemoteCandidate', [data, ...args]);\n\t\tconst peerConnection = this.getPeerConnection(data.from!);\n\t\tif (\n\t\t\tpeerConnection.iceConnectionState !== 'closed' &&\n\t\t\tpeerConnection.iceConnectionState !== 'failed' &&\n\t\t\tpeerConnection.iceConnectionState !== 'disconnected' &&\n\t\t\tpeerConnection.iceConnectionState !== 'completed'\n\t\t) {\n\t\t\tvoid peerConnection.addIceCandidate(new RTCIceCandidate(data.candidate));\n\t\t}\n\t\tdocument.querySelector<HTMLVideoElement>('video#remoteVideo')!.srcObject = this.remoteItems.get()[0]?.url;\n\t}\n\n\tonRemoteDescription(data: DescriptionData, ...args: unknown[]) {\n\t\tif (this.active !== true) {\n\t\t\treturn;\n\t\t}\n\t\tif (data.to !== this.selfId) {\n\t\t\treturn;\n\t\t}\n\t\tthis.log('onRemoteDescription', [data, ...args]);\n\t\tconst peerConnection = this.getPeerConnection(data.from!);\n\t\tif (data.type === 'offer') {\n\t\t\tpeerConnection.remoteMedia = data.media;\n\t\t\tthis.onRemoteOffer({\n\t\t\t\tfrom: data.from,\n\t\t\t\tts: data.ts,\n\t\t\t\tdescription: data.description,\n\t\t\t});\n\t\t} else {\n\t\t\tvoid peerConnection.setRemoteDescription(new RTCSessionDescription(data.description));\n\t\t}\n\t}\n}\n\nconst WebRTC = new (class {\n\tinstancesByRoomId: Record<string, WebRTCClass> = {};\n\n\tconstructor() {\n\t\tthis.instancesByRoomId = {};\n\t}\n\n\tgetInstanceByRoomId(rid: IRoom['_id'], visitorId: string | null = null) {\n\t\tlet enabled = false;\n\t\tif (!visitorId) {\n\t\t\tconst subscription = ChatSubscription.findOne({ rid });\n\t\t\tif (!subscription) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tswitch (subscription.t) {\n\t\t\t\tcase 'd':\n\t\t\t\t\tenabled = settings.get('WebRTC_Enable_Direct');\n\t\t\t\t\tbreak;\n\t\t\t\tcase 'p':\n\t\t\t\t\tenabled = settings.get('WebRTC_Enable_Private');\n\t\t\t\t\tbreak;\n\t\t\t\tcase 'c':\n\t\t\t\t\tenabled = settings.get('WebRTC_Enable_Channel');\n\t\t\t\t\tbreak;\n\t\t\t\tcase 'l':\n\t\t\t\t\tenabled = settings.get<string>('Omnichannel_call_provider') === 'WebRTC';\n\t\t\t}\n\t\t} else {\n\t\t\tenabled = settings.get<string>('Omnichannel_call_provider') === 'WebRTC';\n\t\t}\n\t\tenabled = enabled && settings.get('WebRTC_Enabled');\n\t\tif (enabled === false) {\n\t\t\treturn;\n\t\t}\n\t\tif (this.instancesByRoomId[rid] == null) {\n\t\t\tlet uid = Meteor.userId()!;\n\t\t\tlet autoAccept = false;\n\t\t\tif (visitorId) {\n\t\t\t\tuid = visitorId;\n\t\t\t\tautoAccept = true;\n\t\t\t}\n\t\t\tthis.instancesByRoomId[rid] = new WebRTCClass(uid, rid, autoAccept);\n\t\t}\n\t\treturn this.instancesByRoomId[rid];\n\t}\n})();\n\nMeteor.startup(() => {\n\tTracker.autorun(() => {\n\t\tconst uid = Meteor.userId();\n\n\t\tif (uid) {\n\t\t\tsdk.stream('notify-user', [`${uid}/${WEB_RTC_EVENTS.WEB_RTC}`], (type, data) => {\n\t\t\t\tif (data.room == null) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\tconst webrtc = WebRTC.getInstanceByRoomId(data.room);\n\n\t\t\t\tswitch (type) {\n\t\t\t\t\tcase 'candidate':\n\t\t\t\t\t\twebrtc?.onUserStream('candidate', data);\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tcase 'description':\n\t\t\t\t\t\twebrtc?.onUserStream('description', data);\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tcase 'join':\n\t\t\t\t\t\twebrtc?.onUserStream('join', data);\n\t\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t});\n});\n\nexport { WebRTC };\n"]}}},"code":"module.export({\n  WebRTC: () => WebRTC\n});\nlet Emitter;\nmodule.link(\"@rocket.chat/emitter\", {\n  Emitter(v) {\n    Emitter = v;\n  }\n}, 0);\nlet Meteor;\nmodule.link(\"meteor/meteor\", {\n  Meteor(v) {\n    Meteor = v;\n  }\n}, 1);\nlet ReactiveVar;\nmodule.link(\"meteor/reactive-var\", {\n  ReactiveVar(v) {\n    ReactiveVar = v;\n  }\n}, 2);\nlet Tracker;\nmodule.link(\"meteor/tracker\", {\n  Tracker(v) {\n    Tracker = v;\n  }\n}, 3);\nlet ChromeScreenShare;\nmodule.link(\"./screenShare\", {\n  ChromeScreenShare(v) {\n    ChromeScreenShare = v;\n  }\n}, 4);\nlet GenericModal;\nmodule.link(\"../../../client/components/GenericModal\", {\n  default(v) {\n    GenericModal = v;\n  }\n}, 5);\nlet imperativeModal;\nmodule.link(\"../../../client/lib/imperativeModal\", {\n  imperativeModal(v) {\n    imperativeModal = v;\n  }\n}, 6);\nlet goToRoomById;\nmodule.link(\"../../../client/lib/utils/goToRoomById\", {\n  goToRoomById(v) {\n    goToRoomById = v;\n  }\n}, 7);\nlet ChatSubscription;\nmodule.link(\"../../models/client\", {\n  ChatSubscription(v) {\n    ChatSubscription = v;\n  }\n}, 8);\nlet settings;\nmodule.link(\"../../settings/client\", {\n  settings(v) {\n    settings = v;\n  }\n}, 9);\nlet sdk;\nmodule.link(\"../../utils/client/lib/SDKClient\", {\n  sdk(v) {\n    sdk = v;\n  }\n}, 10);\nlet t;\nmodule.link(\"../../utils/lib/i18n\", {\n  t(v) {\n    t = v;\n  }\n}, 11);\nlet WEB_RTC_EVENTS;\nmodule.link(\"../lib/constants\", {\n  WEB_RTC_EVENTS(v) {\n    WEB_RTC_EVENTS = v;\n  }\n}, 12);\nclass WebRTCTransportClass extends Emitter {\n  constructor(webrtcInstance) {\n    super();\n    this.webrtcInstance = void 0;\n    this.debug = false;\n    this.webrtcInstance = webrtcInstance;\n    sdk.stream('notify-room', [\"\".concat(this.webrtcInstance.room, \"/\").concat(WEB_RTC_EVENTS.WEB_RTC)], (type, data) => {\n      this.log('WebRTCTransportClass - onRoom', type, data);\n      this.emit(type, data);\n    });\n  }\n  log() {\n    if (this.debug === true) {\n      console.log(...arguments);\n    }\n  }\n  onUserStream() {\n    for (var _len = arguments.length, _ref = new Array(_len), _key = 0; _key < _len; _key++) {\n      _ref[_key] = arguments[_key];\n    }\n    let [type, data] = _ref;\n    if (data.room !== this.webrtcInstance.room) {\n      return;\n    }\n    this.log('WebRTCTransportClass - onUser', type, data);\n    switch (type) {\n      case 'candidate':\n        this.emit('candidate', data);\n        break;\n      case 'description':\n        this.emit('description', data);\n        break;\n      case 'join':\n        this.emit('join', data);\n        break;\n    }\n  }\n  startCall(data) {\n    this.log('WebRTCTransportClass - startCall', this.webrtcInstance.room, this.webrtcInstance.selfId);\n    sdk.publish('notify-room-users', [\"\".concat(this.webrtcInstance.room, \"/\").concat(WEB_RTC_EVENTS.WEB_RTC), WEB_RTC_EVENTS.CALL, {\n      from: this.webrtcInstance.selfId,\n      room: this.webrtcInstance.room,\n      media: data.media,\n      monitor: data.monitor\n    }]);\n  }\n  joinCall(data) {\n    this.log('WebRTCTransportClass - joinCall', this.webrtcInstance.room, this.webrtcInstance.selfId);\n    if (data.monitor === true) {\n      sdk.publish('notify-user', [\"\".concat(data.to, \"/\").concat(WEB_RTC_EVENTS.WEB_RTC), WEB_RTC_EVENTS.JOIN, {\n        from: this.webrtcInstance.selfId,\n        room: this.webrtcInstance.room,\n        media: data.media,\n        monitor: data.monitor\n      }]);\n    } else {\n      sdk.publish('notify-room-users', [\"\".concat(this.webrtcInstance.room, \"/\").concat(WEB_RTC_EVENTS.WEB_RTC), WEB_RTC_EVENTS.JOIN, {\n        from: this.webrtcInstance.selfId,\n        room: this.webrtcInstance.room,\n        media: data.media,\n        monitor: data.monitor\n      }]);\n    }\n  }\n  sendCandidate(data) {\n    data.from = this.webrtcInstance.selfId;\n    data.room = this.webrtcInstance.room;\n    this.log('WebRTCTransportClass - sendCandidate', data);\n    sdk.publish('notify-user', [\"\".concat(data.to, \"/\").concat(WEB_RTC_EVENTS.WEB_RTC), WEB_RTC_EVENTS.CANDIDATE, data]);\n  }\n  sendDescription(data) {\n    data.from = this.webrtcInstance.selfId;\n    data.room = this.webrtcInstance.room;\n    this.log('WebRTCTransportClass - sendDescription', data);\n    sdk.publish('notify-user', [\"\".concat(data.to, \"/\").concat(WEB_RTC_EVENTS.WEB_RTC), WEB_RTC_EVENTS.DESCRIPTION, data]);\n  }\n  sendStatus(data) {\n    this.log('WebRTCTransportClass - sendStatus', data, this.webrtcInstance.room);\n    data.from = this.webrtcInstance.selfId;\n    sdk.publish('notify-room', [\"\".concat(this.webrtcInstance.room, \"/\").concat(WEB_RTC_EVENTS.WEB_RTC), WEB_RTC_EVENTS.STATUS, data]);\n  }\n  onRemoteCall(fn) {\n    return this.on(WEB_RTC_EVENTS.CALL, fn);\n  }\n  onRemoteJoin(fn) {\n    return this.on(WEB_RTC_EVENTS.JOIN, fn);\n  }\n  onRemoteCandidate(fn) {\n    return this.on(WEB_RTC_EVENTS.CANDIDATE, fn);\n  }\n  onRemoteDescription(fn) {\n    return this.on(WEB_RTC_EVENTS.DESCRIPTION, fn);\n  }\n  onRemoteStatus(fn) {\n    return this.on(WEB_RTC_EVENTS.STATUS, fn);\n  }\n}\nclass WebRTCClass {\n  constructor(selfId, room) {\n    let autoAccept = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : false;\n    this.selfId = void 0;\n    this.room = void 0;\n    this.autoAccept = void 0;\n    this.transport = void 0;\n    this.config = void 0;\n    this.debug = void 0;\n    this.TransportClass = void 0;\n    this.peerConnections = {};\n    this.remoteItems = void 0;\n    this.remoteItemsById = void 0;\n    this.callInProgress = void 0;\n    this.audioEnabled = void 0;\n    this.videoEnabled = void 0;\n    this.overlayEnabled = void 0;\n    this.screenShareEnabled = void 0;\n    this.localUrl = void 0;\n    this.active = void 0;\n    this.remoteMonitoring = void 0;\n    this.monitor = void 0;\n    this.navigator = void 0;\n    this.screenShareAvailable = void 0;\n    this.media = void 0;\n    this.resetCallInProgress = () => {\n      this.callInProgress.set(false);\n    };\n    this.callInProgressTimeout = undefined;\n    this.audioContext = void 0;\n    this.stopPeerConnection = id => {\n      const peerConnection = this.peerConnections[id];\n      if (peerConnection == null) {\n        return;\n      }\n      delete this.peerConnections[id];\n      peerConnection.close();\n      this.updateRemoteItems();\n    };\n    this.localStream = void 0;\n    this.selfId = selfId;\n    this.room = room;\n    this.autoAccept = autoAccept;\n    this.config = {\n      iceServers: []\n    };\n    this.debug = false;\n    this.TransportClass = WebRTCTransportClass;\n    let servers = settings.get('WebRTC_Servers');\n    if (servers && servers.trim() !== '') {\n      servers = servers.replace(/\\s/g, '');\n      servers.split(',').forEach(server => {\n        const parts = server.split('@');\n        const serverConfig = {\n          urls: parts.pop()\n        };\n        if (parts.length === 1) {\n          const [username, credential] = parts[0].split(':');\n          serverConfig.username = decodeURIComponent(username);\n          serverConfig.credential = decodeURIComponent(credential);\n        }\n        this.config.iceServers.push(serverConfig);\n      });\n    }\n    this.peerConnections = {};\n    this.remoteItems = new ReactiveVar([]);\n    this.remoteItemsById = new ReactiveVar({});\n    this.callInProgress = new ReactiveVar(false);\n    this.audioEnabled = new ReactiveVar(false);\n    this.videoEnabled = new ReactiveVar(false);\n    this.overlayEnabled = new ReactiveVar(false);\n    this.screenShareEnabled = new ReactiveVar(false);\n    this.localUrl = new ReactiveVar(undefined);\n    this.active = false;\n    this.remoteMonitoring = false;\n    this.monitor = false;\n    this.navigator = undefined;\n    const userAgent = navigator.userAgent.toLocaleLowerCase();\n    if (userAgent.indexOf('electron') !== -1) {\n      this.navigator = 'electron';\n    } else if (userAgent.indexOf('chrome') !== -1) {\n      this.navigator = 'chrome';\n    } else if (userAgent.indexOf('firefox') !== -1) {\n      this.navigator = 'firefox';\n    } else if (userAgent.indexOf('safari') !== -1) {\n      this.navigator = 'safari';\n    }\n    this.screenShareAvailable = ['chrome', 'firefox', 'electron'].includes(this.navigator);\n    this.media = {\n      video: true,\n      audio: true\n    };\n    this.transport = new this.TransportClass(this);\n    this.transport.onRemoteCall(this.onRemoteCall.bind(this));\n    this.transport.onRemoteJoin(this.onRemoteJoin.bind(this));\n    this.transport.onRemoteCandidate(this.onRemoteCandidate.bind(this));\n    this.transport.onRemoteDescription(this.onRemoteDescription.bind(this));\n    this.transport.onRemoteStatus(this.onRemoteStatus.bind(this));\n    setInterval(this.checkPeerConnections.bind(this), 1000);\n  }\n  onUserStream() {\n    for (var _len2 = arguments.length, _ref2 = new Array(_len2), _key2 = 0; _key2 < _len2; _key2++) {\n      _ref2[_key2] = arguments[_key2];\n    }\n    let [type, data] = _ref2;\n    switch (type) {\n      case 'candidate':\n        this.transport.onUserStream('candidate', data);\n        break;\n      case 'description':\n        this.transport.onUserStream('description', data);\n        break;\n      case 'join':\n        this.transport.onUserStream('join', data);\n        break;\n    }\n  }\n  log() {\n    if (this.debug === true) {\n      console.log(...arguments);\n    }\n  }\n  onError() {\n    console.error(...arguments);\n  }\n  checkPeerConnections() {\n    const {\n      peerConnections\n    } = this;\n    const date = Date.now();\n    Object.entries(peerConnections).some(_ref3 => {\n      let [id, peerConnection] = _ref3;\n      if (!['connected', 'completed'].includes(peerConnection.iceConnectionState) && peerConnection.createdAt + 5000 < date) {\n        this.stopPeerConnection(id);\n        return true;\n      }\n      return false;\n    });\n  }\n  updateRemoteItems() {\n    const items = [];\n    const itemsById = {};\n    const {\n      peerConnections\n    } = this;\n    Object.entries(peerConnections).forEach(_ref4 => {\n      let [id, peerConnection] = _ref4;\n      peerConnection.getRemoteStreams().forEach(remoteStream => {\n        const item = {\n          id,\n          url: remoteStream,\n          state: peerConnection.iceConnectionState\n        };\n        switch (peerConnection.iceConnectionState) {\n          case 'checking':\n            item.stateText = 'Connecting...';\n            break;\n          case 'connected':\n          case 'completed':\n            item.stateText = 'Connected';\n            item.connected = true;\n            break;\n          case 'disconnected':\n            item.stateText = 'Disconnected';\n            break;\n          case 'failed':\n            item.stateText = 'Failed';\n            break;\n          case 'closed':\n            item.stateText = 'Closed';\n        }\n        items.push(item);\n        itemsById[id] = item;\n      });\n    });\n    this.remoteItems.set(items);\n    this.remoteItemsById.set(itemsById);\n  }\n  broadcastStatus() {\n    if (this.active !== true || this.monitor === true || this.remoteMonitoring === true) {\n      return;\n    }\n    const remoteConnections = [];\n    const {\n      peerConnections\n    } = this;\n    Object.entries(peerConnections).forEach(_ref5 => {\n      let [id, {\n        remoteMedia: media\n      }] = _ref5;\n      remoteConnections.push({\n        id,\n        media\n      });\n    });\n    this.transport.sendStatus({\n      media: this.media,\n      remoteConnections\n    });\n  }\n  onRemoteStatus(data) {\n    // this.log(onRemoteStatus, arguments);\n    this.callInProgress.set(true);\n    clearTimeout(this.callInProgressTimeout);\n    this.callInProgressTimeout = setTimeout(this.resetCallInProgress, 2000);\n    if (this.active !== true) {\n      return;\n    }\n    const remoteConnections = [{\n      id: data.from,\n      media: data.media\n    }, ...data.remoteConnections];\n    remoteConnections.forEach(remoteConnection => {\n      if (remoteConnection.id !== this.selfId && this.peerConnections[remoteConnection.id] == null) {\n        this.log('reconnecting with', remoteConnection.id);\n        this.onRemoteJoin({\n          from: remoteConnection.id,\n          media: remoteConnection.media\n        });\n      }\n    });\n  }\n  getPeerConnection(id) {\n    if (this.peerConnections[id] != null) {\n      return this.peerConnections[id];\n    }\n    const peerConnection = new RTCPeerConnection(this.config);\n    peerConnection.createdAt = Date.now();\n    peerConnection.remoteMedia = {};\n    this.peerConnections[id] = peerConnection;\n    const eventNames = ['icecandidate', 'addstream', 'removestream', 'iceconnectionstatechange', 'datachannel', 'identityresult', 'idpassertionerror', 'idpvalidationerror', 'negotiationneeded', 'peeridentity', 'signalingstatechange'];\n    eventNames.forEach(eventName => {\n      peerConnection.addEventListener(eventName, e => {\n        this.log(id, e.type, e);\n      });\n    });\n    peerConnection.addEventListener('icecandidate', e => {\n      if (e.candidate == null) {\n        return;\n      }\n      this.transport.sendCandidate({\n        to: id,\n        candidate: {\n          candidate: e.candidate.candidate,\n          sdpMLineIndex: e.candidate.sdpMLineIndex,\n          sdpMid: e.candidate.sdpMid\n        }\n      });\n    });\n    peerConnection.addEventListener('addstream', () => {\n      this.updateRemoteItems();\n    });\n    peerConnection.addEventListener('removestream', () => {\n      this.updateRemoteItems();\n    });\n    peerConnection.addEventListener('iceconnectionstatechange', () => {\n      if ((peerConnection.iceConnectionState === 'disconnected' || peerConnection.iceConnectionState === 'closed') && peerConnection === this.peerConnections[id]) {\n        this.stopPeerConnection(id);\n        setTimeout(() => {\n          if (Object.keys(this.peerConnections).length === 0) {\n            this.stop();\n          }\n        }, 3000);\n      }\n      this.updateRemoteItems();\n    });\n    return peerConnection;\n  }\n  _getUserMedia(media, onSuccess, onError) {\n    var _navigator$mediaDevic, _navigator$getUserMed, _navigator;\n    const onSuccessLocal = stream => {\n      if (AudioContext && stream.getAudioTracks().length > 0) {\n        const audioContext = new AudioContext();\n        const source = audioContext.createMediaStreamSource(stream);\n        const volume = audioContext.createGain();\n        source.connect(volume);\n        const peer = audioContext.createMediaStreamDestination();\n        volume.connect(peer);\n        volume.gain.value = 0.6;\n        stream.removeTrack(stream.getAudioTracks()[0]);\n        stream.addTrack(peer.stream.getAudioTracks()[0]);\n        stream.volume = volume;\n        this.audioContext = audioContext;\n      }\n      onSuccess(stream);\n    };\n    if ((_navigator$mediaDevic = navigator.mediaDevices) !== null && _navigator$mediaDevic !== void 0 && _navigator$mediaDevic.getUserMedia) {\n      return navigator.mediaDevices.getUserMedia(media).then(onSuccessLocal).catch(onError);\n    }\n    (_navigator$getUserMed = (_navigator = navigator).getUserMedia) === null || _navigator$getUserMed === void 0 ? void 0 : _navigator$getUserMed.call(_navigator, media, onSuccessLocal, onError);\n  }\n  getUserMedia(media, onSuccess) {\n    let onError = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : this.onError;\n    if (media.desktop !== true) {\n      void this._getUserMedia(media, onSuccess, onError);\n      return;\n    }\n    if (this.screenShareAvailable !== true) {\n      console.log('Screen share is not avaliable');\n      return;\n    }\n    const getScreen = audioStream => {\n      const refresh = function () {\n        imperativeModal.open({\n          component: GenericModal,\n          props: {\n            variant: 'warning',\n            title: t('Refresh_your_page_after_install_to_enable_screen_sharing')\n          }\n        });\n      };\n      const isChromeExtensionInstalled = this.navigator === 'chrome' && ChromeScreenShare.installed;\n      const isFirefoxExtensionInstalled = this.navigator === 'firefox' && window.rocketchatscreenshare != null;\n      if (!isChromeExtensionInstalled && !isFirefoxExtensionInstalled) {\n        imperativeModal.open({\n          component: GenericModal,\n          props: {\n            title: t('Screen_Share'),\n            variant: 'warning',\n            confirmText: t('Install_Extension'),\n            cancelText: t('Cancel'),\n            children: t('You_need_install_an_extension_to_allow_screen_sharing'),\n            onConfirm: () => {\n              if (this.navigator === 'chrome') {\n                const url = 'https://chrome.google.com/webstore/detail/rocketchat-screen-share/nocfbnnmjnndkbipkabodnheejiegccf';\n                try {\n                  chrome.webstore.install(url, refresh, () => {\n                    window.open(url);\n                    refresh();\n                  });\n                } catch (_error) {\n                  console.log(_error);\n                  window.open(url);\n                  refresh();\n                }\n              } else if (this.navigator === 'firefox') {\n                window.open('https://addons.mozilla.org/en-GB/firefox/addon/rocketchat-screen-share/');\n                refresh();\n              }\n            }\n          }\n        });\n        return onError(false);\n      }\n      const getScreenSuccess = stream => {\n        if (audioStream != null) {\n          stream.addTrack(audioStream.getAudioTracks()[0]);\n        }\n        onSuccess(stream);\n      };\n      if (this.navigator === 'firefox') {\n        media = {\n          audio: media.audio,\n          video: {\n            mozMediaSource: 'window',\n            mediaSource: 'window'\n          }\n        };\n        void this._getUserMedia(media, getScreenSuccess, onError);\n      } else {\n        ChromeScreenShare.getSourceId(this.navigator, id => {\n          media = {\n            audio: false,\n            video: {\n              mandatory: {\n                chromeMediaSource: 'desktop',\n                chromeMediaSourceId: id,\n                maxWidth: 1280,\n                maxHeight: 720\n              }\n            }\n          };\n          void this._getUserMedia(media, getScreenSuccess, onError);\n        });\n      }\n    };\n    if (this.navigator === 'firefox' || media.audio == null || media.audio === false) {\n      getScreen();\n    } else {\n      const getAudioSuccess = audioStream => {\n        getScreen(audioStream);\n      };\n      const getAudioError = () => {\n        getScreen();\n      };\n      void this._getUserMedia({\n        audio: media.audio\n      }, getAudioSuccess, getAudioError);\n    }\n  }\n  getLocalUserMedia(callback) {\n    for (var _len3 = arguments.length, args = new Array(_len3 > 1 ? _len3 - 1 : 0), _key3 = 1; _key3 < _len3; _key3++) {\n      args[_key3 - 1] = arguments[_key3];\n    }\n    this.log('getLocalUserMedia', [callback, ...args]);\n    if (this.localStream != null) {\n      return callback(null, this.localStream);\n    }\n    const onSuccess = stream => {\n      this.localStream = stream;\n      !this.audioEnabled.get() && this.disableAudio();\n      !this.videoEnabled.get() && this.disableVideo();\n      this.localUrl.set(stream);\n      const {\n        peerConnections\n      } = this;\n      Object.entries(peerConnections).forEach(_ref6 => {\n        let [, peerConnection] = _ref6;\n        return peerConnection.addStream(stream);\n      });\n      document.querySelector('video#localVideo').srcObject = stream;\n      callback(null, this.localStream);\n    };\n    const onError = error => {\n      callback(false);\n      this.onError(error);\n    };\n    this.getUserMedia(this.media, onSuccess, onError);\n  }\n  stopAllPeerConnections() {\n    var _window$audioContext;\n    const {\n      peerConnections\n    } = this;\n    Object.keys(peerConnections).forEach(this.stopPeerConnection);\n    void ((_window$audioContext = window.audioContext) === null || _window$audioContext === void 0 ? void 0 : _window$audioContext.close()); // FIXME: probably should be `this.audioContext`\n  }\n  setAudioEnabled() {\n    let enabled = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : true;\n    if (this.localStream != null) {\n      this.localStream.getAudioTracks().forEach(audio => {\n        audio.enabled = enabled;\n      });\n      this.audioEnabled.set(enabled);\n    }\n  }\n  disableAudio() {\n    this.setAudioEnabled(false);\n  }\n  enableAudio() {\n    this.setAudioEnabled(true);\n  }\n  toggleAudio() {\n    if (this.audioEnabled.get()) {\n      return this.disableAudio();\n    }\n    return this.enableAudio();\n  }\n  setVideoEnabled() {\n    let enabled = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : true;\n    if (this.localStream != null) {\n      this.localStream.getVideoTracks().forEach(video => {\n        video.enabled = enabled;\n      });\n      this.videoEnabled.set(enabled);\n    }\n  }\n  disableScreenShare() {\n    this.setScreenShareEnabled(false);\n  }\n  enableScreenShare() {\n    this.setScreenShareEnabled(true);\n  }\n  setScreenShareEnabled() {\n    let enabled = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : true;\n    if (this.localStream != null) {\n      this.media.desktop = enabled;\n      delete this.localStream;\n      this.getLocalUserMedia(err => {\n        if (err != null) {\n          return;\n        }\n        this.screenShareEnabled.set(enabled);\n        this.stopAllPeerConnections();\n        this.joinCall();\n      });\n    }\n  }\n  disableVideo() {\n    this.setVideoEnabled(false);\n  }\n  enableVideo() {\n    this.setVideoEnabled(true);\n  }\n  toggleVideo() {\n    if (this.videoEnabled.get()) {\n      return this.disableVideo();\n    }\n    return this.enableVideo();\n  }\n  stop() {\n    this.active = false;\n    this.monitor = false;\n    this.remoteMonitoring = false;\n    if (this.localStream != null && typeof this.localStream !== 'undefined') {\n      this.localStream.getTracks().forEach(track => track.stop());\n    }\n    this.localUrl.set(undefined);\n    delete this.localStream;\n    this.stopAllPeerConnections();\n  }\n  startCall() {\n    let media = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {};\n    for (var _len4 = arguments.length, args = new Array(_len4 > 1 ? _len4 - 1 : 0), _key4 = 1; _key4 < _len4; _key4++) {\n      args[_key4 - 1] = arguments[_key4];\n    }\n    this.log('startCall', [media, ...args]);\n    this.media = media;\n    this.getLocalUserMedia(() => {\n      this.active = true;\n      this.transport.startCall({\n        media: this.media\n      });\n    });\n  }\n  startCallAsMonitor() {\n    let media = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {};\n    for (var _len5 = arguments.length, args = new Array(_len5 > 1 ? _len5 - 1 : 0), _key5 = 1; _key5 < _len5; _key5++) {\n      args[_key5 - 1] = arguments[_key5];\n    }\n    this.log('startCallAsMonitor', [media, ...args]);\n    this.media = media;\n    this.active = true;\n    this.monitor = true;\n    this.transport.startCall({\n      media: this.media,\n      monitor: true\n    });\n  }\n  onRemoteCall(data) {\n    var _data$media2;\n    if (this.autoAccept === true) {\n      setTimeout(() => {\n        this.joinCall({\n          to: data.from,\n          monitor: data.monitor,\n          media: data.media\n        });\n      }, 0);\n      return;\n    }\n    const user = Meteor.users.findOne(data.from);\n    let fromUsername = undefined;\n    if (user !== null && user !== void 0 && user.username) {\n      fromUsername = user.username;\n    }\n    const subscription = ChatSubscription.findOne({\n      rid: data.room\n    });\n    let icon;\n    let title;\n    if (data.monitor === true) {\n      icon = 'eye';\n      title = t('WebRTC_monitor_call_from_%s', fromUsername);\n    } else if (subscription && subscription.t === 'd') {\n      var _data$media;\n      if ((_data$media = data.media) !== null && _data$media !== void 0 && _data$media.video) {\n        icon = 'video';\n        title = t('WebRTC_direct_video_call_from_%s', fromUsername);\n      } else {\n        icon = 'phone';\n        title = t('WebRTC_direct_audio_call_from_%s', fromUsername);\n      }\n    } else if ((_data$media2 = data.media) !== null && _data$media2 !== void 0 && _data$media2.video) {\n      icon = 'video';\n      title = t('WebRTC_group_video_call_from_%s', subscription.name);\n    } else {\n      icon = 'phone';\n      title = t('WebRTC_group_audio_call_from_%s', subscription.name);\n    }\n    imperativeModal.open({\n      component: GenericModal,\n      props: {\n        title,\n        icon,\n        confirmText: t('Yes'),\n        cancelText: t('No'),\n        children: t('Do_you_want_to_accept'),\n        onConfirm: () => {\n          void goToRoomById(data.room);\n          return this.joinCall({\n            to: data.from,\n            monitor: data.monitor,\n            media: data.media\n          });\n        },\n        onCancel: () => this.stop(),\n        onClose: () => this.stop()\n      }\n    });\n  }\n  joinCall() {\n    let data = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {};\n    data.media = this.media;\n    for (var _len6 = arguments.length, args = new Array(_len6 > 1 ? _len6 - 1 : 0), _key6 = 1; _key6 < _len6; _key6++) {\n      args[_key6 - 1] = arguments[_key6];\n    }\n    this.log('joinCall', [data, ...args]);\n    this.getLocalUserMedia(() => {\n      this.remoteMonitoring = data.monitor;\n      this.active = true;\n      this.transport.joinCall(data);\n    });\n  }\n  onRemoteJoin(data) {\n    if (this.active !== true) {\n      return;\n    }\n    for (var _len7 = arguments.length, args = new Array(_len7 > 1 ? _len7 - 1 : 0), _key7 = 1; _key7 < _len7; _key7++) {\n      args[_key7 - 1] = arguments[_key7];\n    }\n    this.log('onRemoteJoin', [data, ...args]);\n    let peerConnection = this.getPeerConnection(data.from);\n    // needsRefresh = false\n    // if peerConnection.iceConnectionState isnt 'new'\n    // needsAudio = data.media.audio is true and peerConnection.remoteMedia.audio isnt true\n    // needsVideo = data.media.video is true and peerConnection.remoteMedia.video isnt true\n    // needsRefresh = needsAudio or needsVideo or data.media.desktop isnt peerConnection.remoteMedia.desktop\n    // # if peerConnection.signalingState is \"have-local-offer\" or needsRefresh\n    if (peerConnection.signalingState !== 'checking') {\n      this.stopPeerConnection(data.from);\n      peerConnection = this.getPeerConnection(data.from);\n    }\n    if (peerConnection.iceConnectionState !== 'new') {\n      return;\n    }\n    peerConnection.remoteMedia = data.media;\n    if (this.localStream) {\n      peerConnection.addStream(this.localStream);\n    }\n    const onOffer = offer => {\n      const onLocalDescription = () => {\n        this.transport.sendDescription({\n          to: data.from,\n          type: 'offer',\n          ts: peerConnection.createdAt,\n          media: this.media,\n          description: {\n            sdp: offer.sdp,\n            type: offer.type\n          }\n        });\n      };\n      void peerConnection.setLocalDescription(new RTCSessionDescription(offer), onLocalDescription, this.onError);\n    };\n    if (data.monitor === true) {\n      var _data$media3, _data$media4;\n      void peerConnection.createOffer(onOffer, this.onError, {\n        mandatory: {\n          OfferToReceiveAudio: (_data$media3 = data.media) === null || _data$media3 === void 0 ? void 0 : _data$media3.audio,\n          OfferToReceiveVideo: (_data$media4 = data.media) === null || _data$media4 === void 0 ? void 0 : _data$media4.video\n        }\n      });\n    } else {\n      void peerConnection.createOffer(onOffer, this.onError);\n    }\n  }\n  onRemoteOffer(data) {\n    if (this.active !== true) {\n      return;\n    }\n    for (var _len8 = arguments.length, args = new Array(_len8 > 1 ? _len8 - 1 : 0), _key8 = 1; _key8 < _len8; _key8++) {\n      args[_key8 - 1] = arguments[_key8];\n    }\n    this.log('onRemoteOffer', [data, ...args]);\n    let peerConnection = this.getPeerConnection(data.from);\n    if (['have-local-offer', 'stable'].includes(peerConnection.signalingState) && peerConnection.createdAt < data.ts) {\n      this.stopPeerConnection(data.from);\n      peerConnection = this.getPeerConnection(data.from);\n    }\n    if (peerConnection.iceConnectionState !== 'new') {\n      return;\n    }\n    void peerConnection.setRemoteDescription(new RTCSessionDescription(data.description));\n    try {\n      if (this.localStream) {\n        peerConnection.addStream(this.localStream);\n      }\n    } catch (error) {\n      console.log(error);\n    }\n    const onAnswer = answer => {\n      const onLocalDescription = () => {\n        this.transport.sendDescription({\n          to: data.from,\n          type: 'answer',\n          ts: peerConnection.createdAt,\n          description: {\n            sdp: answer.sdp,\n            type: answer.type\n          }\n        });\n      };\n      void peerConnection.setLocalDescription(new RTCSessionDescription(answer), onLocalDescription, this.onError);\n    };\n    void peerConnection.createAnswer(onAnswer, this.onError);\n  }\n  onRemoteCandidate(data) {\n    var _this$remoteItems$get;\n    if (this.active !== true) {\n      return;\n    }\n    if (data.to !== this.selfId) {\n      return;\n    }\n    for (var _len9 = arguments.length, args = new Array(_len9 > 1 ? _len9 - 1 : 0), _key9 = 1; _key9 < _len9; _key9++) {\n      args[_key9 - 1] = arguments[_key9];\n    }\n    this.log('onRemoteCandidate', [data, ...args]);\n    const peerConnection = this.getPeerConnection(data.from);\n    if (peerConnection.iceConnectionState !== 'closed' && peerConnection.iceConnectionState !== 'failed' && peerConnection.iceConnectionState !== 'disconnected' && peerConnection.iceConnectionState !== 'completed') {\n      void peerConnection.addIceCandidate(new RTCIceCandidate(data.candidate));\n    }\n    document.querySelector('video#remoteVideo').srcObject = (_this$remoteItems$get = this.remoteItems.get()[0]) === null || _this$remoteItems$get === void 0 ? void 0 : _this$remoteItems$get.url;\n  }\n  onRemoteDescription(data) {\n    if (this.active !== true) {\n      return;\n    }\n    if (data.to !== this.selfId) {\n      return;\n    }\n    for (var _len10 = arguments.length, args = new Array(_len10 > 1 ? _len10 - 1 : 0), _key10 = 1; _key10 < _len10; _key10++) {\n      args[_key10 - 1] = arguments[_key10];\n    }\n    this.log('onRemoteDescription', [data, ...args]);\n    const peerConnection = this.getPeerConnection(data.from);\n    if (data.type === 'offer') {\n      peerConnection.remoteMedia = data.media;\n      this.onRemoteOffer({\n        from: data.from,\n        ts: data.ts,\n        description: data.description\n      });\n    } else {\n      void peerConnection.setRemoteDescription(new RTCSessionDescription(data.description));\n    }\n  }\n}\nconst WebRTC = new class {\n  constructor() {\n    this.instancesByRoomId = {};\n    this.instancesByRoomId = {};\n  }\n  getInstanceByRoomId(rid) {\n    let visitorId = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : null;\n    let enabled = false;\n    if (!visitorId) {\n      const subscription = ChatSubscription.findOne({\n        rid\n      });\n      if (!subscription) {\n        return;\n      }\n      switch (subscription.t) {\n        case 'd':\n          enabled = settings.get('WebRTC_Enable_Direct');\n          break;\n        case 'p':\n          enabled = settings.get('WebRTC_Enable_Private');\n          break;\n        case 'c':\n          enabled = settings.get('WebRTC_Enable_Channel');\n          break;\n        case 'l':\n          enabled = settings.get('Omnichannel_call_provider') === 'WebRTC';\n      }\n    } else {\n      enabled = settings.get('Omnichannel_call_provider') === 'WebRTC';\n    }\n    enabled = enabled && settings.get('WebRTC_Enabled');\n    if (enabled === false) {\n      return;\n    }\n    if (this.instancesByRoomId[rid] == null) {\n      let uid = Meteor.userId();\n      let autoAccept = false;\n      if (visitorId) {\n        uid = visitorId;\n        autoAccept = true;\n      }\n      this.instancesByRoomId[rid] = new WebRTCClass(uid, rid, autoAccept);\n    }\n    return this.instancesByRoomId[rid];\n  }\n}();\nMeteor.startup(() => {\n  Tracker.autorun(() => {\n    const uid = Meteor.userId();\n    if (uid) {\n      sdk.stream('notify-user', [\"\".concat(uid, \"/\").concat(WEB_RTC_EVENTS.WEB_RTC)], (type, data) => {\n        if (data.room == null) {\n          return;\n        }\n        const webrtc = WebRTC.getInstanceByRoomId(data.room);\n        switch (type) {\n          case 'candidate':\n            webrtc === null || webrtc === void 0 ? void 0 : webrtc.onUserStream('candidate', data);\n            break;\n          case 'description':\n            webrtc === null || webrtc === void 0 ? void 0 : webrtc.onUserStream('description', data);\n            break;\n          case 'join':\n            webrtc === null || webrtc === void 0 ? void 0 : webrtc.onUserStream('join', data);\n            break;\n        }\n      });\n    }\n  });\n});","map":{"version":3,"names":["module","export","WebRTC","Emitter","link","v","Meteor","ReactiveVar","Tracker","ChromeScreenShare","GenericModal","default","imperativeModal","goToRoomById","ChatSubscription","settings","sdk","t","WEB_RTC_EVENTS","WebRTCTransportClass","constructor","webrtcInstance","debug","stream","concat","room","WEB_RTC","type","data","log","emit","console","arguments","onUserStream","_len","length","_ref","Array","_key","startCall","selfId","publish","CALL","from","media","monitor","joinCall","to","JOIN","sendCandidate","CANDIDATE","sendDescription","DESCRIPTION","sendStatus","STATUS","onRemoteCall","fn","on","onRemoteJoin","onRemoteCandidate","onRemoteDescription","onRemoteStatus","WebRTCClass","autoAccept","undefined","transport","config","TransportClass","peerConnections","remoteItems","remoteItemsById","callInProgress","audioEnabled","videoEnabled","overlayEnabled","screenShareEnabled","localUrl","active","remoteMonitoring","navigator","screenShareAvailable","resetCallInProgress","set","callInProgressTimeout","audioContext","stopPeerConnection","id","peerConnection","close","updateRemoteItems","localStream","iceServers","servers","get","trim","replace","split","forEach","server","parts","serverConfig","urls","pop","username","credential","decodeURIComponent","push","userAgent","toLocaleLowerCase","indexOf","includes","video","audio","bind","setInterval","checkPeerConnections","_len2","_ref2","_key2","onError","error","date","Date","now","Object","entries","some","_ref3","iceConnectionState","createdAt","items","itemsById","_ref4","getRemoteStreams","remoteStream","item","url","state","stateText","connected","broadcastStatus","remoteConnections","_ref5","remoteMedia","clearTimeout","setTimeout","remoteConnection","getPeerConnection","RTCPeerConnection","eventNames","eventName","addEventListener","e","candidate","sdpMLineIndex","sdpMid","keys","stop","_getUserMedia","onSuccess","_navigator$mediaDevic","_navigator$getUserMed","_navigator","onSuccessLocal","AudioContext","getAudioTracks","source","createMediaStreamSource","volume","createGain","connect","peer","createMediaStreamDestination","gain","value","removeTrack","addTrack","mediaDevices","getUserMedia","then","catch","call","desktop","getScreen","audioStream","refresh","open","component","props","variant","title","isChromeExtensionInstalled","installed","isFirefoxExtensionInstalled","window","rocketchatscreenshare","confirmText","cancelText","children","onConfirm","chrome","webstore","install","_error","getScreenSuccess","mozMediaSource","mediaSource","getSourceId","mandatory","chromeMediaSource","chromeMediaSourceId","maxWidth","maxHeight","getAudioSuccess","getAudioError","getLocalUserMedia","callback","_len3","args","_key3","disableAudio","disableVideo","_ref6","addStream","document","querySelector","srcObject","stopAllPeerConnections","_window$audioContext","setAudioEnabled","enabled","enableAudio","toggleAudio","setVideoEnabled","getVideoTracks","disableScreenShare","setScreenShareEnabled","enableScreenShare","err","enableVideo","toggleVideo","getTracks","track","_len4","_key4","startCallAsMonitor","_len5","_key5","_data$media2","user","users","findOne","fromUsername","subscription","rid","icon","_data$media","name","onCancel","onClose","_len6","_key6","_len7","_key7","signalingState","onOffer","offer","onLocalDescription","ts","description","sdp","setLocalDescription","RTCSessionDescription","_data$media3","_data$media4","createOffer","OfferToReceiveAudio","OfferToReceiveVideo","onRemoteOffer","_len8","_key8","setRemoteDescription","onAnswer","answer","createAnswer","_this$remoteItems$get","_len9","_key9","addIceCandidate","RTCIceCandidate","_len10","_key10","instancesByRoomId","getInstanceByRoomId","visitorId","uid","userId","startup","autorun","webrtc"],"sources":["app/webrtc/client/WebRTCClass.ts"],"sourcesContent":["import type { IRoom } from '@rocket.chat/core-typings';\nimport type { StreamKeys, StreamNames, StreamerCallbackArgs } from '@rocket.chat/ddp-client';\nimport { Emitter } from '@rocket.chat/emitter';\nimport { Meteor } from 'meteor/meteor';\nimport { ReactiveVar } from 'meteor/reactive-var';\nimport { Tracker } from 'meteor/tracker';\n\nimport { ChromeScreenShare } from './screenShare';\nimport GenericModal from '../../../client/components/GenericModal';\nimport { imperativeModal } from '../../../client/lib/imperativeModal';\nimport { goToRoomById } from '../../../client/lib/utils/goToRoomById';\nimport { ChatSubscription } from '../../models/client';\nimport { settings } from '../../settings/client';\nimport { sdk } from '../../utils/client/lib/SDKClient';\nimport { t } from '../../utils/lib/i18n';\nimport { WEB_RTC_EVENTS } from '../lib/constants';\n\n// FIXME: there is a mix of obsolete definitions and incorrect field assignments\n\ndeclare global {\n\t// eslint-disable-next-line @typescript-eslint/naming-convention\n\tinterface RTCPeerConnection {\n\t\t/** @deprecated non-standard */\n\t\tcreatedAt: number;\n\t\t/** @deprecated non-standard */\n\t\tremoteMedia: MediaStreamConstraints;\n\t}\n\n\t// eslint-disable-next-line @typescript-eslint/naming-convention\n\tinterface RTCOfferOptions {\n\t\t/** @deprecated non-standard */\n\t\tmandatory?: unknown;\n\t}\n\n\t// eslint-disable-next-line @typescript-eslint/naming-convention\n\tinterface MediaStream {\n\t\t/** @deprecated non-standard */\n\t\tvolume?: GainNode;\n\t}\n\n\t// eslint-disable-next-line @typescript-eslint/naming-convention\n\tinterface MediaStreamConstraints {\n\t\t/** @deprecated non-standard */\n\t\tdesktop?: boolean;\n\t}\n\n\t/** @deprecated browser-specific global */\n\tconst chrome: {\n\t\twebstore: {\n\t\t\tinstall(url: string, onSuccess: () => void, onError: (error: any) => void): void;\n\t\t};\n\t};\n\n\t// eslint-disable-next-line @typescript-eslint/naming-convention\n\tinterface Window {\n\t\trocketchatscreenshare?: unknown;\n\t\taudioContext?: AudioContext;\n\t}\n}\n\ntype EventData<TStreamName extends StreamNames, TStreamKey extends StreamKeys<TStreamName>, TType> = Extract<\n\tStreamerCallbackArgs<TStreamName, TStreamKey>,\n\t[type: TType, data: any]\n>[1];\n\ntype StatusData = EventData<'notify-room', `${string}/webrtc`, 'status'>;\ntype CallData = EventData<'notify-room-users', `${string}/webrtc`, 'call'>;\ntype CandidateData = EventData<'notify-user', `${string}/webrtc`, 'candidate'>;\ntype DescriptionData = EventData<'notify-user', `${string}/webrtc`, 'description'>;\ntype JoinData = EventData<'notify-user', `${string}/webrtc`, 'join'>;\n\ntype RemoteItem = {\n\tid: string;\n\turl: MediaStream;\n\tstate: RTCIceConnectionState;\n\tstateText?: string;\n\tconnected?: boolean;\n};\n\ntype RemoteConnection = {\n\tid: string;\n\tmedia: MediaStreamConstraints;\n};\n\nclass WebRTCTransportClass extends Emitter<{\n\tstatus: StatusData;\n\tcall: CallData;\n\tcandidate: CandidateData;\n\tdescription: DescriptionData;\n\tjoin: JoinData;\n}> {\n\tpublic debug = false;\n\n\tconstructor(public webrtcInstance: WebRTCClass) {\n\t\tsuper();\n\t\tsdk.stream('notify-room', [`${this.webrtcInstance.room}/${WEB_RTC_EVENTS.WEB_RTC}`], (type, data) => {\n\t\t\tthis.log('WebRTCTransportClass - onRoom', type, data);\n\t\t\tthis.emit(type, data);\n\t\t});\n\t}\n\n\tlog(...args: unknown[]) {\n\t\tif (this.debug === true) {\n\t\t\tconsole.log(...args);\n\t\t}\n\t}\n\n\tonUserStream(type: 'candidate', data: CandidateData): void;\n\n\tonUserStream(type: 'description', data: DescriptionData): void;\n\n\tonUserStream(type: 'join', data: JoinData): void;\n\n\tonUserStream(\n\t\t...[type, data]:\n\t\t\t| [type: 'candidate', data: CandidateData]\n\t\t\t| [type: 'description', data: DescriptionData]\n\t\t\t| [type: 'join', data: JoinData]\n\t) {\n\t\tif (data.room !== this.webrtcInstance.room) {\n\t\t\treturn;\n\t\t}\n\n\t\tthis.log('WebRTCTransportClass - onUser', type, data);\n\n\t\tswitch (type) {\n\t\t\tcase 'candidate':\n\t\t\t\tthis.emit('candidate', data);\n\t\t\t\tbreak;\n\t\t\tcase 'description':\n\t\t\t\tthis.emit('description', data);\n\t\t\t\tbreak;\n\t\t\tcase 'join':\n\t\t\t\tthis.emit('join', data);\n\t\t\t\tbreak;\n\t\t}\n\t}\n\n\tstartCall(data: CallData) {\n\t\tthis.log('WebRTCTransportClass - startCall', this.webrtcInstance.room, this.webrtcInstance.selfId);\n\t\tsdk.publish('notify-room-users', [\n\t\t\t`${this.webrtcInstance.room}/${WEB_RTC_EVENTS.WEB_RTC}`,\n\t\t\tWEB_RTC_EVENTS.CALL,\n\t\t\t{\n\t\t\t\tfrom: this.webrtcInstance.selfId,\n\t\t\t\troom: this.webrtcInstance.room,\n\t\t\t\tmedia: data.media,\n\t\t\t\tmonitor: data.monitor,\n\t\t\t},\n\t\t]);\n\t}\n\n\tjoinCall(data: JoinData) {\n\t\tthis.log('WebRTCTransportClass - joinCall', this.webrtcInstance.room, this.webrtcInstance.selfId);\n\t\tif (data.monitor === true) {\n\t\t\tsdk.publish('notify-user', [\n\t\t\t\t`${data.to}/${WEB_RTC_EVENTS.WEB_RTC}`,\n\t\t\t\tWEB_RTC_EVENTS.JOIN,\n\t\t\t\t{\n\t\t\t\t\tfrom: this.webrtcInstance.selfId,\n\t\t\t\t\troom: this.webrtcInstance.room,\n\t\t\t\t\tmedia: data.media,\n\t\t\t\t\tmonitor: data.monitor,\n\t\t\t\t},\n\t\t\t]);\n\t\t} else {\n\t\t\tsdk.publish('notify-room-users', [\n\t\t\t\t`${this.webrtcInstance.room}/${WEB_RTC_EVENTS.WEB_RTC}`,\n\t\t\t\tWEB_RTC_EVENTS.JOIN,\n\t\t\t\t{\n\t\t\t\t\tfrom: this.webrtcInstance.selfId,\n\t\t\t\t\troom: this.webrtcInstance.room,\n\t\t\t\t\tmedia: data.media,\n\t\t\t\t\tmonitor: data.monitor,\n\t\t\t\t},\n\t\t\t]);\n\t\t}\n\t}\n\n\tsendCandidate(data: CandidateData) {\n\t\tdata.from = this.webrtcInstance.selfId;\n\t\tdata.room = this.webrtcInstance.room;\n\t\tthis.log('WebRTCTransportClass - sendCandidate', data);\n\t\tsdk.publish('notify-user', [`${data.to}/${WEB_RTC_EVENTS.WEB_RTC}`, WEB_RTC_EVENTS.CANDIDATE, data]);\n\t}\n\n\tsendDescription(data: DescriptionData) {\n\t\tdata.from = this.webrtcInstance.selfId;\n\t\tdata.room = this.webrtcInstance.room;\n\t\tthis.log('WebRTCTransportClass - sendDescription', data);\n\t\tsdk.publish('notify-user', [`${data.to}/${WEB_RTC_EVENTS.WEB_RTC}`, WEB_RTC_EVENTS.DESCRIPTION, data]);\n\t}\n\n\tsendStatus(data: StatusData) {\n\t\tthis.log('WebRTCTransportClass - sendStatus', data, this.webrtcInstance.room);\n\t\tdata.from = this.webrtcInstance.selfId;\n\t\tsdk.publish('notify-room', [`${this.webrtcInstance.room}/${WEB_RTC_EVENTS.WEB_RTC}`, WEB_RTC_EVENTS.STATUS, data]);\n\t}\n\n\tonRemoteCall(fn: (data: CallData) => void) {\n\t\treturn this.on(WEB_RTC_EVENTS.CALL, fn);\n\t}\n\n\tonRemoteJoin(fn: (data: JoinData) => void) {\n\t\treturn this.on(WEB_RTC_EVENTS.JOIN, fn);\n\t}\n\n\tonRemoteCandidate(fn: (data: CandidateData) => void) {\n\t\treturn this.on(WEB_RTC_EVENTS.CANDIDATE, fn);\n\t}\n\n\tonRemoteDescription(fn: (data: DescriptionData) => void) {\n\t\treturn this.on(WEB_RTC_EVENTS.DESCRIPTION, fn);\n\t}\n\n\tonRemoteStatus(fn: (data: StatusData) => void) {\n\t\treturn this.on(WEB_RTC_EVENTS.STATUS, fn);\n\t}\n}\n\nclass WebRTCClass {\n\ttransport: WebRTCTransportClass;\n\n\tconfig: { iceServers: RTCIceServer[] };\n\n\tdebug: boolean;\n\n\tTransportClass: typeof WebRTCTransportClass;\n\n\tpeerConnections: Record<string, RTCPeerConnection> = {};\n\n\tremoteItems: ReactiveVar<RemoteItem[]>;\n\n\tremoteItemsById: ReactiveVar<Record<string, RemoteItem>>;\n\n\tcallInProgress: ReactiveVar<boolean>;\n\n\taudioEnabled: ReactiveVar<boolean>;\n\n\tvideoEnabled: ReactiveVar<boolean>;\n\n\toverlayEnabled: ReactiveVar<boolean>;\n\n\tscreenShareEnabled: ReactiveVar<boolean>;\n\n\tlocalUrl: ReactiveVar<MediaStream | undefined>;\n\n\tactive: boolean;\n\n\tremoteMonitoring: boolean;\n\n\tmonitor: boolean;\n\n\tnavigator: string | undefined;\n\n\tscreenShareAvailable: boolean;\n\n\tmedia: MediaStreamConstraints;\n\n\tconstructor(\n\t\tpublic selfId: string,\n\t\tpublic room: string,\n\t\tpublic autoAccept = false,\n\t) {\n\t\tthis.config = {\n\t\t\ticeServers: [],\n\t\t};\n\t\tthis.debug = false;\n\t\tthis.TransportClass = WebRTCTransportClass;\n\t\tlet servers = settings.get<string>('WebRTC_Servers');\n\t\tif (servers && servers.trim() !== '') {\n\t\t\tservers = servers.replace(/\\s/g, '');\n\n\t\t\tservers.split(',').forEach((server) => {\n\t\t\t\tconst parts = server.split('@');\n\t\t\t\tconst serverConfig: RTCIceServer = {\n\t\t\t\t\turls: parts.pop()!,\n\t\t\t\t};\n\t\t\t\tif (parts.length === 1) {\n\t\t\t\t\tconst [username, credential] = parts[0].split(':');\n\t\t\t\t\tserverConfig.username = decodeURIComponent(username);\n\t\t\t\t\tserverConfig.credential = decodeURIComponent(credential);\n\t\t\t\t}\n\t\t\t\tthis.config.iceServers.push(serverConfig);\n\t\t\t});\n\t\t}\n\t\tthis.peerConnections = {};\n\t\tthis.remoteItems = new ReactiveVar([]);\n\t\tthis.remoteItemsById = new ReactiveVar({});\n\t\tthis.callInProgress = new ReactiveVar(false);\n\t\tthis.audioEnabled = new ReactiveVar(false);\n\t\tthis.videoEnabled = new ReactiveVar(false);\n\t\tthis.overlayEnabled = new ReactiveVar(false);\n\t\tthis.screenShareEnabled = new ReactiveVar(false);\n\t\tthis.localUrl = new ReactiveVar(undefined);\n\t\tthis.active = false;\n\t\tthis.remoteMonitoring = false;\n\t\tthis.monitor = false;\n\t\tthis.navigator = undefined;\n\t\tconst userAgent = navigator.userAgent.toLocaleLowerCase();\n\n\t\tif (userAgent.indexOf('electron') !== -1) {\n\t\t\tthis.navigator = 'electron';\n\t\t} else if (userAgent.indexOf('chrome') !== -1) {\n\t\t\tthis.navigator = 'chrome';\n\t\t} else if (userAgent.indexOf('firefox') !== -1) {\n\t\t\tthis.navigator = 'firefox';\n\t\t} else if (userAgent.indexOf('safari') !== -1) {\n\t\t\tthis.navigator = 'safari';\n\t\t}\n\n\t\tthis.screenShareAvailable = ['chrome', 'firefox', 'electron'].includes(this.navigator!);\n\t\tthis.media = {\n\t\t\tvideo: true,\n\t\t\taudio: true,\n\t\t};\n\t\tthis.transport = new this.TransportClass(this);\n\t\tthis.transport.onRemoteCall(this.onRemoteCall.bind(this));\n\t\tthis.transport.onRemoteJoin(this.onRemoteJoin.bind(this));\n\t\tthis.transport.onRemoteCandidate(this.onRemoteCandidate.bind(this));\n\t\tthis.transport.onRemoteDescription(this.onRemoteDescription.bind(this));\n\t\tthis.transport.onRemoteStatus(this.onRemoteStatus.bind(this));\n\n\t\tsetInterval(this.checkPeerConnections.bind(this), 1000);\n\t}\n\n\tonUserStream(type: 'candidate', data: CandidateData): void;\n\n\tonUserStream(type: 'description', data: DescriptionData): void;\n\n\tonUserStream(type: 'join', data: JoinData): void;\n\n\tonUserStream(\n\t\t...[type, data]:\n\t\t\t| [type: 'candidate', data: CandidateData]\n\t\t\t| [type: 'description', data: DescriptionData]\n\t\t\t| [type: 'join', data: JoinData]\n\t) {\n\t\tswitch (type) {\n\t\t\tcase 'candidate':\n\t\t\t\tthis.transport.onUserStream('candidate', data);\n\t\t\t\tbreak;\n\n\t\t\tcase 'description':\n\t\t\t\tthis.transport.onUserStream('description', data);\n\t\t\t\tbreak;\n\n\t\t\tcase 'join':\n\t\t\t\tthis.transport.onUserStream('join', data);\n\t\t\t\tbreak;\n\t\t}\n\t}\n\n\tlog(...args: unknown[]) {\n\t\tif (this.debug === true) {\n\t\t\tconsole.log(...args);\n\t\t}\n\t}\n\n\tonError(...args: unknown[]) {\n\t\tconsole.error(...args);\n\t}\n\n\tcheckPeerConnections() {\n\t\tconst { peerConnections } = this;\n\t\tconst date = Date.now();\n\t\tObject.entries(peerConnections).some(([id, peerConnection]) => {\n\t\t\tif (!['connected', 'completed'].includes(peerConnection.iceConnectionState) && peerConnection.createdAt + 5000 < date) {\n\t\t\t\tthis.stopPeerConnection(id);\n\t\t\t\treturn true;\n\t\t\t}\n\t\t\treturn false;\n\t\t});\n\t}\n\n\tupdateRemoteItems() {\n\t\tconst items: RemoteItem[] = [];\n\t\tconst itemsById: Record<string, RemoteItem> = {};\n\t\tconst { peerConnections } = this;\n\n\t\tObject.entries(peerConnections).forEach(([id, peerConnection]) => {\n\t\t\tpeerConnection.getRemoteStreams().forEach((remoteStream) => {\n\t\t\t\tconst item: RemoteItem = {\n\t\t\t\t\tid,\n\t\t\t\t\turl: remoteStream,\n\t\t\t\t\tstate: peerConnection.iceConnectionState,\n\t\t\t\t};\n\t\t\t\tswitch (peerConnection.iceConnectionState) {\n\t\t\t\t\tcase 'checking':\n\t\t\t\t\t\titem.stateText = 'Connecting...';\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tcase 'connected':\n\t\t\t\t\tcase 'completed':\n\t\t\t\t\t\titem.stateText = 'Connected';\n\t\t\t\t\t\titem.connected = true;\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tcase 'disconnected':\n\t\t\t\t\t\titem.stateText = 'Disconnected';\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tcase 'failed':\n\t\t\t\t\t\titem.stateText = 'Failed';\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tcase 'closed':\n\t\t\t\t\t\titem.stateText = 'Closed';\n\t\t\t\t}\n\t\t\t\titems.push(item);\n\t\t\t\titemsById[id] = item;\n\t\t\t});\n\t\t});\n\t\tthis.remoteItems.set(items);\n\t\tthis.remoteItemsById.set(itemsById);\n\t}\n\n\tresetCallInProgress = () => {\n\t\tthis.callInProgress.set(false);\n\t};\n\n\tbroadcastStatus() {\n\t\tif (this.active !== true || this.monitor === true || this.remoteMonitoring === true) {\n\t\t\treturn;\n\t\t}\n\t\tconst remoteConnections: RemoteConnection[] = [];\n\t\tconst { peerConnections } = this;\n\t\tObject.entries(peerConnections).forEach(([id, { remoteMedia: media }]) => {\n\t\t\tremoteConnections.push({\n\t\t\t\tid,\n\t\t\t\tmedia,\n\t\t\t});\n\t\t});\n\n\t\tthis.transport.sendStatus({\n\t\t\tmedia: this.media,\n\t\t\tremoteConnections,\n\t\t});\n\t}\n\n\tcallInProgressTimeout: ReturnType<typeof setTimeout> | undefined = undefined;\n\n\tonRemoteStatus(data: StatusData) {\n\t\t// this.log(onRemoteStatus, arguments);\n\t\tthis.callInProgress.set(true);\n\t\tclearTimeout(this.callInProgressTimeout);\n\t\tthis.callInProgressTimeout = setTimeout(this.resetCallInProgress, 2000);\n\t\tif (this.active !== true) {\n\t\t\treturn;\n\t\t}\n\t\tconst remoteConnections = [\n\t\t\t{\n\t\t\t\tid: data.from!,\n\t\t\t\tmedia: data.media,\n\t\t\t},\n\t\t\t...data.remoteConnections,\n\t\t];\n\n\t\tremoteConnections.forEach((remoteConnection) => {\n\t\t\tif (remoteConnection.id !== this.selfId && this.peerConnections[remoteConnection.id] == null) {\n\t\t\t\tthis.log('reconnecting with', remoteConnection.id);\n\t\t\t\tthis.onRemoteJoin({\n\t\t\t\t\tfrom: remoteConnection.id,\n\t\t\t\t\tmedia: remoteConnection.media,\n\t\t\t\t});\n\t\t\t}\n\t\t});\n\t}\n\n\tgetPeerConnection(id: string) {\n\t\tif (this.peerConnections[id] != null) {\n\t\t\treturn this.peerConnections[id];\n\t\t}\n\t\tconst peerConnection = new RTCPeerConnection(this.config);\n\n\t\tpeerConnection.createdAt = Date.now();\n\t\tpeerConnection.remoteMedia = {};\n\t\tthis.peerConnections[id] = peerConnection;\n\t\tconst eventNames = [\n\t\t\t'icecandidate',\n\t\t\t'addstream',\n\t\t\t'removestream',\n\t\t\t'iceconnectionstatechange',\n\t\t\t'datachannel',\n\t\t\t'identityresult',\n\t\t\t'idpassertionerror',\n\t\t\t'idpvalidationerror',\n\t\t\t'negotiationneeded',\n\t\t\t'peeridentity',\n\t\t\t'signalingstatechange',\n\t\t];\n\n\t\teventNames.forEach((eventName) => {\n\t\t\tpeerConnection.addEventListener(eventName, (e) => {\n\t\t\t\tthis.log(id, e.type, e);\n\t\t\t});\n\t\t});\n\n\t\tpeerConnection.addEventListener('icecandidate', (e) => {\n\t\t\tif (e.candidate == null) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tthis.transport.sendCandidate({\n\t\t\t\tto: id,\n\t\t\t\tcandidate: {\n\t\t\t\t\tcandidate: e.candidate.candidate,\n\t\t\t\t\tsdpMLineIndex: e.candidate.sdpMLineIndex,\n\t\t\t\t\tsdpMid: e.candidate.sdpMid,\n\t\t\t\t},\n\t\t\t});\n\t\t});\n\t\tpeerConnection.addEventListener('addstream', () => {\n\t\t\tthis.updateRemoteItems();\n\t\t});\n\t\tpeerConnection.addEventListener('removestream', () => {\n\t\t\tthis.updateRemoteItems();\n\t\t});\n\t\tpeerConnection.addEventListener('iceconnectionstatechange', () => {\n\t\t\tif (\n\t\t\t\t(peerConnection.iceConnectionState === 'disconnected' || peerConnection.iceConnectionState === 'closed') &&\n\t\t\t\tpeerConnection === this.peerConnections[id]\n\t\t\t) {\n\t\t\t\tthis.stopPeerConnection(id);\n\t\t\t\tsetTimeout(() => {\n\t\t\t\t\tif (Object.keys(this.peerConnections).length === 0) {\n\t\t\t\t\t\tthis.stop();\n\t\t\t\t\t}\n\t\t\t\t}, 3000);\n\t\t\t}\n\t\t\tthis.updateRemoteItems();\n\t\t});\n\t\treturn peerConnection;\n\t}\n\n\taudioContext: AudioContext | undefined;\n\n\t_getUserMedia(media: MediaStreamConstraints, onSuccess: (stream: MediaStream) => void, onError: (error?: any) => void) {\n\t\tconst onSuccessLocal = (stream: MediaStream) => {\n\t\t\tif (AudioContext && stream.getAudioTracks().length > 0) {\n\t\t\t\tconst audioContext = new AudioContext();\n\t\t\t\tconst source = audioContext.createMediaStreamSource(stream);\n\t\t\t\tconst volume = audioContext.createGain();\n\t\t\t\tsource.connect(volume);\n\t\t\t\tconst peer = audioContext.createMediaStreamDestination();\n\t\t\t\tvolume.connect(peer);\n\t\t\t\tvolume.gain.value = 0.6;\n\t\t\t\tstream.removeTrack(stream.getAudioTracks()[0]);\n\t\t\t\tstream.addTrack(peer.stream.getAudioTracks()[0]);\n\t\t\t\tstream.volume = volume;\n\t\t\t\tthis.audioContext = audioContext;\n\t\t\t}\n\t\t\tonSuccess(stream);\n\t\t};\n\n\t\tif (navigator.mediaDevices?.getUserMedia) {\n\t\t\treturn navigator.mediaDevices.getUserMedia(media).then(onSuccessLocal).catch(onError);\n\t\t}\n\n\t\tnavigator.getUserMedia?.(media, onSuccessLocal, onError);\n\t}\n\n\tgetUserMedia(media: MediaStreamConstraints, onSuccess: (stream: MediaStream) => void, onError: (error: any) => void = this.onError) {\n\t\tif (media.desktop !== true) {\n\t\t\tvoid this._getUserMedia(media, onSuccess, onError);\n\t\t\treturn;\n\t\t}\n\t\tif (this.screenShareAvailable !== true) {\n\t\t\tconsole.log('Screen share is not avaliable');\n\t\t\treturn;\n\t\t}\n\t\tconst getScreen = (audioStream?: MediaStream) => {\n\t\t\tconst refresh = function () {\n\t\t\t\timperativeModal.open({\n\t\t\t\t\tcomponent: GenericModal,\n\t\t\t\t\tprops: {\n\t\t\t\t\t\tvariant: 'warning',\n\t\t\t\t\t\ttitle: t('Refresh_your_page_after_install_to_enable_screen_sharing'),\n\t\t\t\t\t},\n\t\t\t\t});\n\t\t\t};\n\n\t\t\tconst isChromeExtensionInstalled = this.navigator === 'chrome' && ChromeScreenShare.installed;\n\t\t\tconst isFirefoxExtensionInstalled = this.navigator === 'firefox' && window.rocketchatscreenshare != null;\n\n\t\t\tif (!isChromeExtensionInstalled && !isFirefoxExtensionInstalled) {\n\t\t\t\timperativeModal.open({\n\t\t\t\t\tcomponent: GenericModal,\n\t\t\t\t\tprops: {\n\t\t\t\t\t\ttitle: t('Screen_Share'),\n\t\t\t\t\t\tvariant: 'warning',\n\t\t\t\t\t\tconfirmText: t('Install_Extension'),\n\t\t\t\t\t\tcancelText: t('Cancel'),\n\t\t\t\t\t\tchildren: t('You_need_install_an_extension_to_allow_screen_sharing'),\n\t\t\t\t\t\tonConfirm: () => {\n\t\t\t\t\t\t\tif (this.navigator === 'chrome') {\n\t\t\t\t\t\t\t\tconst url = 'https://chrome.google.com/webstore/detail/rocketchat-screen-share/nocfbnnmjnndkbipkabodnheejiegccf';\n\t\t\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\t\t\tchrome.webstore.install(url, refresh, () => {\n\t\t\t\t\t\t\t\t\t\twindow.open(url);\n\t\t\t\t\t\t\t\t\t\trefresh();\n\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\t} catch (_error) {\n\t\t\t\t\t\t\t\t\tconsole.log(_error);\n\t\t\t\t\t\t\t\t\twindow.open(url);\n\t\t\t\t\t\t\t\t\trefresh();\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t} else if (this.navigator === 'firefox') {\n\t\t\t\t\t\t\t\twindow.open('https://addons.mozilla.org/en-GB/firefox/addon/rocketchat-screen-share/');\n\t\t\t\t\t\t\t\trefresh();\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t});\n\n\t\t\t\treturn onError(false);\n\t\t\t}\n\n\t\t\tconst getScreenSuccess = (stream: MediaStream) => {\n\t\t\t\tif (audioStream != null) {\n\t\t\t\t\tstream.addTrack(audioStream.getAudioTracks()[0]);\n\t\t\t\t}\n\t\t\t\tonSuccess(stream);\n\t\t\t};\n\t\t\tif (this.navigator === 'firefox') {\n\t\t\t\tmedia = {\n\t\t\t\t\taudio: media.audio,\n\t\t\t\t\tvideo: {\n\t\t\t\t\t\tmozMediaSource: 'window',\n\t\t\t\t\t\tmediaSource: 'window',\n\t\t\t\t\t},\n\t\t\t\t};\n\t\t\t\tvoid this._getUserMedia(media, getScreenSuccess, onError);\n\t\t\t} else {\n\t\t\t\tChromeScreenShare.getSourceId(this.navigator!, (id) => {\n\t\t\t\t\tmedia = {\n\t\t\t\t\t\taudio: false,\n\t\t\t\t\t\tvideo: {\n\t\t\t\t\t\t\tmandatory: {\n\t\t\t\t\t\t\t\tchromeMediaSource: 'desktop',\n\t\t\t\t\t\t\t\tchromeMediaSourceId: id,\n\t\t\t\t\t\t\t\tmaxWidth: 1280,\n\t\t\t\t\t\t\t\tmaxHeight: 720,\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t};\n\t\t\t\t\tvoid this._getUserMedia(media, getScreenSuccess, onError);\n\t\t\t\t});\n\t\t\t}\n\t\t};\n\t\tif (this.navigator === 'firefox' || media.audio == null || media.audio === false) {\n\t\t\tgetScreen();\n\t\t} else {\n\t\t\tconst getAudioSuccess = (audioStream: MediaStream) => {\n\t\t\t\tgetScreen(audioStream);\n\t\t\t};\n\t\t\tconst getAudioError = () => {\n\t\t\t\tgetScreen();\n\t\t\t};\n\n\t\t\tvoid this._getUserMedia(\n\t\t\t\t{\n\t\t\t\t\taudio: media.audio,\n\t\t\t\t},\n\t\t\t\tgetAudioSuccess,\n\t\t\t\tgetAudioError,\n\t\t\t);\n\t\t}\n\t}\n\n\tgetLocalUserMedia(callback: (...args: any[]) => void, ...args: unknown[]) {\n\t\tthis.log('getLocalUserMedia', [callback, ...args]);\n\t\tif (this.localStream != null) {\n\t\t\treturn callback(null, this.localStream);\n\t\t}\n\t\tconst onSuccess = (stream: MediaStream) => {\n\t\t\tthis.localStream = stream;\n\t\t\t!this.audioEnabled.get() && this.disableAudio();\n\t\t\t!this.videoEnabled.get() && this.disableVideo();\n\t\t\tthis.localUrl.set(stream);\n\t\t\tconst { peerConnections } = this;\n\t\t\tObject.entries(peerConnections).forEach(([, peerConnection]) => peerConnection.addStream(stream));\n\t\t\tdocument.querySelector<HTMLVideoElement>('video#localVideo')!.srcObject = stream;\n\t\t\tcallback(null, this.localStream);\n\t\t};\n\t\tconst onError = (error: any) => {\n\t\t\tcallback(false);\n\t\t\tthis.onError(error);\n\t\t};\n\t\tthis.getUserMedia(this.media, onSuccess, onError);\n\t}\n\n\tstopPeerConnection = (id: string) => {\n\t\tconst peerConnection = this.peerConnections[id];\n\t\tif (peerConnection == null) {\n\t\t\treturn;\n\t\t}\n\t\tdelete this.peerConnections[id];\n\t\tpeerConnection.close();\n\t\tthis.updateRemoteItems();\n\t};\n\n\tstopAllPeerConnections() {\n\t\tconst { peerConnections } = this;\n\n\t\tObject.keys(peerConnections).forEach(this.stopPeerConnection);\n\n\t\tvoid window.audioContext?.close(); // FIXME: probably should be `this.audioContext`\n\t}\n\n\tsetAudioEnabled(enabled = true) {\n\t\tif (this.localStream != null) {\n\t\t\tthis.localStream.getAudioTracks().forEach((audio) => {\n\t\t\t\taudio.enabled = enabled;\n\t\t\t});\n\t\t\tthis.audioEnabled.set(enabled);\n\t\t}\n\t}\n\n\tdisableAudio() {\n\t\tthis.setAudioEnabled(false);\n\t}\n\n\tenableAudio() {\n\t\tthis.setAudioEnabled(true);\n\t}\n\n\ttoggleAudio() {\n\t\tif (this.audioEnabled.get()) {\n\t\t\treturn this.disableAudio();\n\t\t}\n\t\treturn this.enableAudio();\n\t}\n\n\tlocalStream: MediaStream | undefined;\n\n\tsetVideoEnabled(enabled = true) {\n\t\tif (this.localStream != null) {\n\t\t\tthis.localStream.getVideoTracks().forEach((video) => {\n\t\t\t\tvideo.enabled = enabled;\n\t\t\t});\n\t\t\tthis.videoEnabled.set(enabled);\n\t\t}\n\t}\n\n\tdisableScreenShare() {\n\t\tthis.setScreenShareEnabled(false);\n\t}\n\n\tenableScreenShare() {\n\t\tthis.setScreenShareEnabled(true);\n\t}\n\n\tsetScreenShareEnabled(enabled = true) {\n\t\tif (this.localStream != null) {\n\t\t\tthis.media.desktop = enabled;\n\t\t\tdelete this.localStream;\n\t\t\tthis.getLocalUserMedia((err) => {\n\t\t\t\tif (err != null) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\tthis.screenShareEnabled.set(enabled);\n\t\t\t\tthis.stopAllPeerConnections();\n\t\t\t\tthis.joinCall();\n\t\t\t});\n\t\t}\n\t}\n\n\tdisableVideo() {\n\t\tthis.setVideoEnabled(false);\n\t}\n\n\tenableVideo() {\n\t\tthis.setVideoEnabled(true);\n\t}\n\n\ttoggleVideo() {\n\t\tif (this.videoEnabled.get()) {\n\t\t\treturn this.disableVideo();\n\t\t}\n\t\treturn this.enableVideo();\n\t}\n\n\tstop() {\n\t\tthis.active = false;\n\t\tthis.monitor = false;\n\t\tthis.remoteMonitoring = false;\n\t\tif (this.localStream != null && typeof this.localStream !== 'undefined') {\n\t\t\tthis.localStream.getTracks().forEach((track) => track.stop());\n\t\t}\n\t\tthis.localUrl.set(undefined);\n\t\tdelete this.localStream;\n\t\tthis.stopAllPeerConnections();\n\t}\n\n\tstartCall(media: MediaStreamConstraints = {}, ...args: unknown[]) {\n\t\tthis.log('startCall', [media, ...args]);\n\t\tthis.media = media;\n\t\tthis.getLocalUserMedia(() => {\n\t\t\tthis.active = true;\n\t\t\tthis.transport.startCall({\n\t\t\t\tmedia: this.media,\n\t\t\t});\n\t\t});\n\t}\n\n\tstartCallAsMonitor(media: MediaStreamConstraints = {}, ...args: unknown[]) {\n\t\tthis.log('startCallAsMonitor', [media, ...args]);\n\t\tthis.media = media;\n\t\tthis.active = true;\n\t\tthis.monitor = true;\n\t\tthis.transport.startCall({\n\t\t\tmedia: this.media,\n\t\t\tmonitor: true,\n\t\t});\n\t}\n\n\tonRemoteCall(data: CallData) {\n\t\tif (this.autoAccept === true) {\n\t\t\tsetTimeout(() => {\n\t\t\t\tthis.joinCall({\n\t\t\t\t\tto: data.from,\n\t\t\t\t\tmonitor: data.monitor,\n\t\t\t\t\tmedia: data.media,\n\t\t\t\t});\n\t\t\t}, 0);\n\t\t\treturn;\n\t\t}\n\n\t\tconst user = Meteor.users.findOne(data.from);\n\t\tlet fromUsername = undefined;\n\t\tif (user?.username) {\n\t\t\tfromUsername = user.username;\n\t\t}\n\t\tconst subscription = ChatSubscription.findOne({\n\t\t\trid: data.room,\n\t\t})!;\n\n\t\tlet icon;\n\t\tlet title;\n\t\tif (data.monitor === true) {\n\t\t\ticon = 'eye' as const;\n\t\t\ttitle = t('WebRTC_monitor_call_from_%s', fromUsername);\n\t\t} else if (subscription && subscription.t === 'd') {\n\t\t\tif (data.media?.video) {\n\t\t\t\ticon = 'video' as const;\n\t\t\t\ttitle = t('WebRTC_direct_video_call_from_%s', fromUsername);\n\t\t\t} else {\n\t\t\t\ticon = 'phone' as const;\n\t\t\t\ttitle = t('WebRTC_direct_audio_call_from_%s', fromUsername);\n\t\t\t}\n\t\t} else if (data.media?.video) {\n\t\t\ticon = 'video' as const;\n\t\t\ttitle = t('WebRTC_group_video_call_from_%s', subscription.name);\n\t\t} else {\n\t\t\ticon = 'phone' as const;\n\t\t\ttitle = t('WebRTC_group_audio_call_from_%s', subscription.name);\n\t\t}\n\n\t\timperativeModal.open({\n\t\t\tcomponent: GenericModal,\n\t\t\tprops: {\n\t\t\t\ttitle,\n\t\t\t\ticon,\n\t\t\t\tconfirmText: t('Yes'),\n\t\t\t\tcancelText: t('No'),\n\t\t\t\tchildren: t('Do_you_want_to_accept'),\n\t\t\t\tonConfirm: () => {\n\t\t\t\t\tvoid goToRoomById(data.room!);\n\t\t\t\t\treturn this.joinCall({\n\t\t\t\t\t\tto: data.from,\n\t\t\t\t\t\tmonitor: data.monitor,\n\t\t\t\t\t\tmedia: data.media,\n\t\t\t\t\t});\n\t\t\t\t},\n\t\t\t\tonCancel: () => this.stop(),\n\t\t\t\tonClose: () => this.stop(),\n\t\t\t},\n\t\t});\n\t}\n\n\tjoinCall(data: JoinData = {}, ...args: unknown[]) {\n\t\tdata.media = this.media;\n\t\tthis.log('joinCall', [data, ...args]);\n\t\tthis.getLocalUserMedia(() => {\n\t\t\tthis.remoteMonitoring = data.monitor!;\n\t\t\tthis.active = true;\n\t\t\tthis.transport.joinCall(data);\n\t\t});\n\t}\n\n\tonRemoteJoin(data: JoinData, ...args: unknown[]) {\n\t\tif (this.active !== true) {\n\t\t\treturn;\n\t\t}\n\t\tthis.log('onRemoteJoin', [data, ...args]);\n\t\tlet peerConnection = this.getPeerConnection(data.from!);\n\n\t\t// needsRefresh = false\n\t\t// if peerConnection.iceConnectionState isnt 'new'\n\t\t// needsAudio = data.media.audio is true and peerConnection.remoteMedia.audio isnt true\n\t\t// needsVideo = data.media.video is true and peerConnection.remoteMedia.video isnt true\n\t\t// needsRefresh = needsAudio or needsVideo or data.media.desktop isnt peerConnection.remoteMedia.desktop\n\n\t\t// # if peerConnection.signalingState is \"have-local-offer\" or needsRefresh\n\n\t\tif ((peerConnection.signalingState as RTCSignalingState | 'checking') !== 'checking') {\n\t\t\tthis.stopPeerConnection(data.from!);\n\t\t\tpeerConnection = this.getPeerConnection(data.from!);\n\t\t}\n\t\tif (peerConnection.iceConnectionState !== 'new') {\n\t\t\treturn;\n\t\t}\n\t\tpeerConnection.remoteMedia = data.media!;\n\t\tif (this.localStream) {\n\t\t\tpeerConnection.addStream(this.localStream);\n\t\t}\n\t\tconst onOffer: RTCSessionDescriptionCallback = (offer) => {\n\t\t\tconst onLocalDescription = () => {\n\t\t\t\tthis.transport.sendDescription({\n\t\t\t\t\tto: data.from,\n\t\t\t\t\ttype: 'offer',\n\t\t\t\t\tts: peerConnection.createdAt,\n\t\t\t\t\tmedia: this.media,\n\t\t\t\t\tdescription: {\n\t\t\t\t\t\tsdp: offer.sdp,\n\t\t\t\t\t\ttype: offer.type,\n\t\t\t\t\t},\n\t\t\t\t});\n\t\t\t};\n\n\t\t\tvoid peerConnection.setLocalDescription(new RTCSessionDescription(offer), onLocalDescription, this.onError);\n\t\t};\n\n\t\tif (data.monitor === true) {\n\t\t\tvoid peerConnection.createOffer(onOffer, this.onError, {\n\t\t\t\tmandatory: {\n\t\t\t\t\tOfferToReceiveAudio: data.media?.audio,\n\t\t\t\t\tOfferToReceiveVideo: data.media?.video,\n\t\t\t\t},\n\t\t\t});\n\t\t} else {\n\t\t\tvoid peerConnection.createOffer(onOffer, this.onError);\n\t\t}\n\t}\n\n\tonRemoteOffer(data: Omit<DescriptionData, 'type'>, ...args: unknown[]) {\n\t\tif (this.active !== true) {\n\t\t\treturn;\n\t\t}\n\n\t\tthis.log('onRemoteOffer', [data, ...args]);\n\t\tlet peerConnection = this.getPeerConnection(data.from!);\n\n\t\tif (['have-local-offer', 'stable'].includes(peerConnection.signalingState) && peerConnection.createdAt < data.ts) {\n\t\t\tthis.stopPeerConnection(data.from!);\n\t\t\tpeerConnection = this.getPeerConnection(data.from!);\n\t\t}\n\n\t\tif (peerConnection.iceConnectionState !== 'new') {\n\t\t\treturn;\n\t\t}\n\n\t\tvoid peerConnection.setRemoteDescription(new RTCSessionDescription(data.description));\n\n\t\ttry {\n\t\t\tif (this.localStream) {\n\t\t\t\tpeerConnection.addStream(this.localStream);\n\t\t\t}\n\t\t} catch (error) {\n\t\t\tconsole.log(error);\n\t\t}\n\n\t\tconst onAnswer: RTCSessionDescriptionCallback = (answer) => {\n\t\t\tconst onLocalDescription = () => {\n\t\t\t\tthis.transport.sendDescription({\n\t\t\t\t\tto: data.from,\n\t\t\t\t\ttype: 'answer',\n\t\t\t\t\tts: peerConnection.createdAt,\n\t\t\t\t\tdescription: {\n\t\t\t\t\t\tsdp: answer.sdp,\n\t\t\t\t\t\ttype: answer.type,\n\t\t\t\t\t},\n\t\t\t\t});\n\t\t\t};\n\n\t\t\tvoid peerConnection.setLocalDescription(new RTCSessionDescription(answer), onLocalDescription, this.onError);\n\t\t};\n\n\t\tvoid peerConnection.createAnswer(onAnswer, this.onError);\n\t}\n\n\tonRemoteCandidate(data: CandidateData, ...args: unknown[]) {\n\t\tif (this.active !== true) {\n\t\t\treturn;\n\t\t}\n\t\tif (data.to !== this.selfId) {\n\t\t\treturn;\n\t\t}\n\t\tthis.log('onRemoteCandidate', [data, ...args]);\n\t\tconst peerConnection = this.getPeerConnection(data.from!);\n\t\tif (\n\t\t\tpeerConnection.iceConnectionState !== 'closed' &&\n\t\t\tpeerConnection.iceConnectionState !== 'failed' &&\n\t\t\tpeerConnection.iceConnectionState !== 'disconnected' &&\n\t\t\tpeerConnection.iceConnectionState !== 'completed'\n\t\t) {\n\t\t\tvoid peerConnection.addIceCandidate(new RTCIceCandidate(data.candidate));\n\t\t}\n\t\tdocument.querySelector<HTMLVideoElement>('video#remoteVideo')!.srcObject = this.remoteItems.get()[0]?.url;\n\t}\n\n\tonRemoteDescription(data: DescriptionData, ...args: unknown[]) {\n\t\tif (this.active !== true) {\n\t\t\treturn;\n\t\t}\n\t\tif (data.to !== this.selfId) {\n\t\t\treturn;\n\t\t}\n\t\tthis.log('onRemoteDescription', [data, ...args]);\n\t\tconst peerConnection = this.getPeerConnection(data.from!);\n\t\tif (data.type === 'offer') {\n\t\t\tpeerConnection.remoteMedia = data.media;\n\t\t\tthis.onRemoteOffer({\n\t\t\t\tfrom: data.from,\n\t\t\t\tts: data.ts,\n\t\t\t\tdescription: data.description,\n\t\t\t});\n\t\t} else {\n\t\t\tvoid peerConnection.setRemoteDescription(new RTCSessionDescription(data.description));\n\t\t}\n\t}\n}\n\nconst WebRTC = new (class {\n\tinstancesByRoomId: Record<string, WebRTCClass> = {};\n\n\tconstructor() {\n\t\tthis.instancesByRoomId = {};\n\t}\n\n\tgetInstanceByRoomId(rid: IRoom['_id'], visitorId: string | null = null) {\n\t\tlet enabled = false;\n\t\tif (!visitorId) {\n\t\t\tconst subscription = ChatSubscription.findOne({ rid });\n\t\t\tif (!subscription) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tswitch (subscription.t) {\n\t\t\t\tcase 'd':\n\t\t\t\t\tenabled = settings.get('WebRTC_Enable_Direct');\n\t\t\t\t\tbreak;\n\t\t\t\tcase 'p':\n\t\t\t\t\tenabled = settings.get('WebRTC_Enable_Private');\n\t\t\t\t\tbreak;\n\t\t\t\tcase 'c':\n\t\t\t\t\tenabled = settings.get('WebRTC_Enable_Channel');\n\t\t\t\t\tbreak;\n\t\t\t\tcase 'l':\n\t\t\t\t\tenabled = settings.get<string>('Omnichannel_call_provider') === 'WebRTC';\n\t\t\t}\n\t\t} else {\n\t\t\tenabled = settings.get<string>('Omnichannel_call_provider') === 'WebRTC';\n\t\t}\n\t\tenabled = enabled && settings.get('WebRTC_Enabled');\n\t\tif (enabled === false) {\n\t\t\treturn;\n\t\t}\n\t\tif (this.instancesByRoomId[rid] == null) {\n\t\t\tlet uid = Meteor.userId()!;\n\t\t\tlet autoAccept = false;\n\t\t\tif (visitorId) {\n\t\t\t\tuid = visitorId;\n\t\t\t\tautoAccept = true;\n\t\t\t}\n\t\t\tthis.instancesByRoomId[rid] = new WebRTCClass(uid, rid, autoAccept);\n\t\t}\n\t\treturn this.instancesByRoomId[rid];\n\t}\n})();\n\nMeteor.startup(() => {\n\tTracker.autorun(() => {\n\t\tconst uid = Meteor.userId();\n\n\t\tif (uid) {\n\t\t\tsdk.stream('notify-user', [`${uid}/${WEB_RTC_EVENTS.WEB_RTC}`], (type, data) => {\n\t\t\t\tif (data.room == null) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\tconst webrtc = WebRTC.getInstanceByRoomId(data.room);\n\n\t\t\t\tswitch (type) {\n\t\t\t\t\tcase 'candidate':\n\t\t\t\t\t\twebrtc?.onUserStream('candidate', data);\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tcase 'description':\n\t\t\t\t\t\twebrtc?.onUserStream('description', data);\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tcase 'join':\n\t\t\t\t\t\twebrtc?.onUserStream('join', data);\n\t\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t});\n});\n\nexport { WebRTC };\n"],"mappings":"AAEAA,MAAA,CAAOC,MAAE;EAAAC,MAAS,EAAAA,CAAA,KAAMA;AAAA;AAAA,IAAAC,OAAsB;AAACH,MAAA,CAAAI,IAAA;EAAAD,QAAAE,CAAA;IAAAF,OAAA,GAAAE,CAAA;EAAA;AAAA;AAAA,IAAAC,MAAA;AAAAN,MAAA,CAAAI,IAAA;EAAAE,OAAAD,CAAA;IAAAC,MAAA,GAAAD,CAAA;EAAA;AAAA;AAAA,IAAAE,WAAA;AAAAP,MAAA,CAAAI,IAAA;EAAAG,YAAAF,CAAA;IAAAE,WAAA,GAAAF,CAAA;EAAA;AAAA;AAAA,IAAAG,OAAA;AAAAR,MAAA,CAAAI,IAAA;EAAAI,QAAAH,CAAA;IAAAG,OAAA,GAAAH,CAAA;EAAA;AAAA;AAAA,IAAAI,iBAAA;AAAAT,MAAA,CAAAI,IAAA;EAAAK,kBAAAJ,CAAA;IAAAI,iBAAA,GAAAJ,CAAA;EAAA;AAAA;AAAA,IAAAK,YAAA;AAAAV,MAAA,CAAAI,IAAA;EAAAO,QAAAN,CAAA;IAAAK,YAAA,GAAAL,CAAA;EAAA;AAAA;AAAA,IAAAO,eAAA;AAAAZ,MAAA,CAAAI,IAAA;EAAAQ,gBAAAP,CAAA;IAAAO,eAAA,GAAAP,CAAA;EAAA;AAAA;AAAA,IAAAQ,YAAA;AAAAb,MAAA,CAAAI,IAAA;EAAAS,aAAAR,CAAA;IAAAQ,YAAA,GAAAR,CAAA;EAAA;AAAA;AAAA,IAAAS,gBAAA;AAAAd,MAAA,CAAAI,IAAA;EAAAU,iBAAAT,CAAA;IAAAS,gBAAA,GAAAT,CAAA;EAAA;AAAA;AAAA,IAAAU,QAAA;AAAAf,MAAA,CAAAI,IAAA;EAAAW,SAAAV,CAAA;IAAAU,QAAA,GAAAV,CAAA;EAAA;AAAA;AAAA,IAAAW,GAAA;AAAAhB,MAAA,CAAAI,IAAA;EAAAY,IAAAX,CAAA;IAAAW,GAAA,GAAAX,CAAA;EAAA;AAAA;AAAA,IAAAY,CAAA;AAAAjB,MAAA,CAAAI,IAAA;EAAAa,EAAAZ,CAAA;IAAAY,CAAA,GAAAZ,CAAA;EAAA;AAAA;AAAA,IAAAa,cAAA;AAAAlB,MAAA,CAAAI,IAAA;EAAAc,eAAAb,CAAA;IAAAa,cAAA,GAAAb,CAAA;EAAA;AAAA;AAkF/C,MAAMc,oBAAqB,SAAQhB,OAMjC;EAGDiB,YAAmBC,cAA2B;IAC7C,KAAK,EAAE;IAAC,KADUA,cAAA;IAAA,KAFZC,KAAK,GAAG,KAAK;IAED,KAAAD,cAAc,GAAdA,cAAc;IAEhCL,GAAG,CAACO,MAAM,CAAC,aAAa,EAAE,IAAAC,MAAA,CAAI,IAAI,CAACH,cAAc,CAACI,IAAI,OAAAD,MAAA,CAAIN,cAAc,CAACQ,OAAO,EAAG,EAAE,CAACC,IAAI,EAAEC,IAAI,KAAI;MACnG,IAAI,CAACC,GAAG,CAAC,+BAA+B,EAAEF,IAAI,EAAEC,IAAI,CAAC;MACrD,IAAI,CAACE,IAAI,CAACH,IAAI,EAAEC,IAAI,CAAC;IACtB,CAAC,CAAC;EACH;EAEAC,GAAGA,CAAA,EAAmB;IACrB,IAAI,IAAI,CAACP,KAAK,KAAK,IAAI,EAAE;MACxBS,OAAO,CAACF,GAAG,CAAC,GAAAG,SAAO,CAAC;IACrB;EACD;EAQAC,YAAYA,CAAA,EAIsB;IAAA,SAAAC,IAAA,GAAAF,SAAA,CAAAG,MAAA,EAAAC,IAAA,OAAAC,KAAA,CAAAH,IAAA,GAAAI,IAAA,MAAAA,IAAA,GAAAJ,IAAA,EAAAI,IAAA;MAAAF,IAAA,CAAAE,IAAA,IAAAN,SAAA,CAAAM,IAAA;IAAA;IAAA,IAH9B,CAACX,IAAI,EAAEC,IAAI,CAGmB,GAAAQ,IAAA;IAEjC,IAAIR,IAAI,CAACH,IAAI,KAAK,IAAI,CAACJ,cAAc,CAACI,IAAI,EAAE;MAC3C;IACD;IAEA,IAAI,CAACI,GAAG,CAAC,+BAA+B,EAAEF,IAAI,EAAEC,IAAI,CAAC;IAErD,QAAQD,IAAI;MACX,KAAK,WAAW;QACf,IAAI,CAACG,IAAI,CAAC,WAAW,EAAEF,IAAI,CAAC;QAC5B;MACD,KAAK,aAAa;QACjB,IAAI,CAACE,IAAI,CAAC,aAAa,EAAEF,IAAI,CAAC;QAC9B;MACD,KAAK,MAAM;QACV,IAAI,CAACE,IAAI,CAAC,MAAM,EAAEF,IAAI,CAAC;QACvB;IACF;EACD;EAEAW,SAASA,CAACX,IAAc;IACvB,IAAI,CAACC,GAAG,CAAC,kCAAkC,EAAE,IAAI,CAACR,cAAc,CAACI,IAAI,EAAE,IAAI,CAACJ,cAAc,CAACmB,MAAM,CAAC;IAClGxB,GAAG,CAACyB,OAAO,CAAC,mBAAmB,EAAE,IAAAjB,MAAA,CAC7B,IAAI,CAACH,cAAc,CAACI,IAAI,OAAAD,MAAA,CAAIN,cAAc,CAACQ,OAAO,GACrDR,cAAc,CAACwB,IAAI,EACnB;MACCC,IAAI,EAAE,IAAI,CAACtB,cAAc,CAACmB,MAAM;MAChCf,IAAI,EAAE,IAAI,CAACJ,cAAc,CAACI,IAAI;MAC9BmB,KAAK,EAAEhB,IAAI,CAACgB,KAAK;MACjBC,OAAO,EAAEjB,IAAI,CAACiB;KACd,CACD,CAAC;EACH;EAEAC,QAAQA,CAAClB,IAAc;IACtB,IAAI,CAACC,GAAG,CAAC,iCAAiC,EAAE,IAAI,CAACR,cAAc,CAACI,IAAI,EAAE,IAAI,CAACJ,cAAc,CAACmB,MAAM,CAAC;IACjG,IAAIZ,IAAI,CAACiB,OAAO,KAAK,IAAI,EAAE;MAC1B7B,GAAG,CAACyB,OAAO,CAAC,aAAa,EAAE,IAAAjB,MAAA,CACvBI,IAAI,CAACmB,EAAE,OAAAvB,MAAA,CAAIN,cAAc,CAACQ,OAAO,GACpCR,cAAc,CAAC8B,IAAI,EACnB;QACCL,IAAI,EAAE,IAAI,CAACtB,cAAc,CAACmB,MAAM;QAChCf,IAAI,EAAE,IAAI,CAACJ,cAAc,CAACI,IAAI;QAC9BmB,KAAK,EAAEhB,IAAI,CAACgB,KAAK;QACjBC,OAAO,EAAEjB,IAAI,CAACiB;OACd,CACD,CAAC;IACH,CAAC,MAAM;MACN7B,GAAG,CAACyB,OAAO,CAAC,mBAAmB,EAAE,IAAAjB,MAAA,CAC7B,IAAI,CAACH,cAAc,CAACI,IAAI,OAAAD,MAAA,CAAIN,cAAc,CAACQ,OAAO,GACrDR,cAAc,CAAC8B,IAAI,EACnB;QACCL,IAAI,EAAE,IAAI,CAACtB,cAAc,CAACmB,MAAM;QAChCf,IAAI,EAAE,IAAI,CAACJ,cAAc,CAACI,IAAI;QAC9BmB,KAAK,EAAEhB,IAAI,CAACgB,KAAK;QACjBC,OAAO,EAAEjB,IAAI,CAACiB;OACd,CACD,CAAC;IACH;EACD;EAEAI,aAAaA,CAACrB,IAAmB;IAChCA,IAAI,CAACe,IAAI,GAAG,IAAI,CAACtB,cAAc,CAACmB,MAAM;IACtCZ,IAAI,CAACH,IAAI,GAAG,IAAI,CAACJ,cAAc,CAACI,IAAI;IACpC,IAAI,CAACI,GAAG,CAAC,sCAAsC,EAAED,IAAI,CAAC;IACtDZ,GAAG,CAACyB,OAAO,CAAC,aAAa,EAAE,IAAAjB,MAAA,CAAII,IAAI,CAACmB,EAAE,OAAAvB,MAAA,CAAIN,cAAc,CAACQ,OAAO,GAAIR,cAAc,CAACgC,SAAS,EAAEtB,IAAI,CAAC,CAAC;EACrG;EAEAuB,eAAeA,CAACvB,IAAqB;IACpCA,IAAI,CAACe,IAAI,GAAG,IAAI,CAACtB,cAAc,CAACmB,MAAM;IACtCZ,IAAI,CAACH,IAAI,GAAG,IAAI,CAACJ,cAAc,CAACI,IAAI;IACpC,IAAI,CAACI,GAAG,CAAC,wCAAwC,EAAED,IAAI,CAAC;IACxDZ,GAAG,CAACyB,OAAO,CAAC,aAAa,EAAE,IAAAjB,MAAA,CAAII,IAAI,CAACmB,EAAE,OAAAvB,MAAA,CAAIN,cAAc,CAACQ,OAAO,GAAIR,cAAc,CAACkC,WAAW,EAAExB,IAAI,CAAC,CAAC;EACvG;EAEAyB,UAAUA,CAACzB,IAAgB;IAC1B,IAAI,CAACC,GAAG,CAAC,mCAAmC,EAAED,IAAI,EAAE,IAAI,CAACP,cAAc,CAACI,IAAI,CAAC;IAC7EG,IAAI,CAACe,IAAI,GAAG,IAAI,CAACtB,cAAc,CAACmB,MAAM;IACtCxB,GAAG,CAACyB,OAAO,CAAC,aAAa,EAAE,IAAAjB,MAAA,CAAI,IAAI,CAACH,cAAc,CAACI,IAAI,OAAAD,MAAA,CAAIN,cAAc,CAACQ,OAAO,GAAIR,cAAc,CAACoC,MAAM,EAAE1B,IAAI,CAAC,CAAC;EACnH;EAEA2B,YAAYA,CAACC,EAA4B;IACxC,OAAO,IAAI,CAACC,EAAE,CAACvC,cAAc,CAACwB,IAAI,EAAEc,EAAE,CAAC;EACxC;EAEAE,YAAYA,CAACF,EAA4B;IACxC,OAAO,IAAI,CAACC,EAAE,CAACvC,cAAc,CAAC8B,IAAI,EAAEQ,EAAE,CAAC;EACxC;EAEAG,iBAAiBA,CAACH,EAAiC;IAClD,OAAO,IAAI,CAACC,EAAE,CAACvC,cAAc,CAACgC,SAAS,EAAEM,EAAE,CAAC;EAC7C;EAEAI,mBAAmBA,CAACJ,EAAmC;IACtD,OAAO,IAAI,CAACC,EAAE,CAACvC,cAAc,CAACkC,WAAW,EAAEI,EAAE,CAAC;EAC/C;EAEAK,cAAcA,CAACL,EAA8B;IAC5C,OAAO,IAAI,CAACC,EAAE,CAACvC,cAAc,CAACoC,MAAM,EAAEE,EAAE,CAAC;EAC1C;;AAGD,MAAMM,WAAW;EAuChB1C,YACQoB,MAAc,EACdf,IAAY,EACM;IAAA,IAAlBsC,UAAA,GAAA/B,SAAA,CAAAG,MAAA,QAAAH,SAAA,QAAAgC,SAAA,GAAAhC,SAAA,MAAa,KAAK;IAAA,KAFlBQ,MAAA;IAAA,KACAf,IAAA;IAAA,KACAsC,UAAA;IAAA,KAzCRE,SAAS;IAAA,KAETC,MAAM;IAAA,KAEN5C,KAAK;IAAA,KAEL6C,cAAc;IAAA,KAEdC,eAAe,GAAsC,EAAE;IAAA,KAEvDC,WAAW;IAAA,KAEXC,eAAe;IAAA,KAEfC,cAAc;IAAA,KAEdC,YAAY;IAAA,KAEZC,YAAY;IAAA,KAEZC,cAAc;IAAA,KAEdC,kBAAkB;IAAA,KAElBC,QAAQ;IAAA,KAERC,MAAM;IAAA,KAENC,gBAAgB;IAAA,KAEhBjC,OAAO;IAAA,KAEPkC,SAAS;IAAA,KAETC,oBAAoB;IAAA,KAEpBpC,KAAK;IAAA,KA4JLqC,mBAAmB,GAAG,MAAK;MAC1B,IAAI,CAACV,cAAc,CAACW,GAAG,CAAC,KAAK,CAAC;IAC/B,CAAC;IAAA,KAqBDC,qBAAqB,GAA8CnB,SAAS;IAAA,KA8F5EoB,YAAY;IAAA,KA6JZC,kBAAkB,GAAIC,EAAU,IAAI;MACnC,MAAMC,cAAc,GAAG,IAAI,CAACnB,eAAe,CAACkB,EAAE,CAAC;MAC/C,IAAIC,cAAc,IAAI,IAAI,EAAE;QAC3B;MACD;MACA,OAAO,IAAI,CAACnB,eAAe,CAACkB,EAAE,CAAC;MAC/BC,cAAc,CAACC,KAAK,EAAE;MACtB,IAAI,CAACC,iBAAiB,EAAE;IACzB,CAAC;IAAA,KAkCDC,WAAW;IArdH,KAAAlD,MAAM,GAANA,MAAM;IACN,KAAAf,IAAI,GAAJA,IAAI;IACJ,KAAAsC,UAAU,GAAVA,UAAU;IAEjB,IAAI,CAACG,MAAM,GAAG;MACbyB,UAAU,EAAE;KACZ;IACD,IAAI,CAACrE,KAAK,GAAG,KAAK;IAClB,IAAI,CAAC6C,cAAc,GAAGhD,oBAAoB;IAC1C,IAAIyE,OAAO,GAAG7E,QAAQ,CAAC8E,GAAG,CAAS,gBAAgB,CAAC;IACpD,IAAID,OAAO,IAAIA,OAAO,CAACE,IAAI,EAAE,KAAK,EAAE,EAAE;MACrCF,OAAO,GAAGA,OAAO,CAACG,OAAO,CAAC,KAAK,EAAE,EAAE,CAAC;MAEpCH,OAAO,CAACI,KAAK,CAAC,GAAG,CAAC,CAACC,OAAO,CAAEC,MAAM,IAAI;QACrC,MAAMC,KAAK,GAAGD,MAAM,CAACF,KAAK,CAAC,GAAG,CAAC;QAC/B,MAAMI,YAAY,GAAiB;UAClCC,IAAI,EAAEF,KAAK,CAACG,GAAG;SACf;QACD,IAAIH,KAAK,CAAChE,MAAM,KAAK,CAAC,EAAE;UACvB,MAAM,CAACoE,QAAQ,EAAEC,UAAU,CAAC,GAAGL,KAAK,CAAC,CAAC,CAAC,CAACH,KAAK,CAAC,GAAG,CAAC;UAClDI,YAAY,CAACG,QAAQ,GAAGE,kBAAkB,CAACF,QAAQ,CAAC;UACpDH,YAAY,CAACI,UAAU,GAAGC,kBAAkB,CAACD,UAAU,CAAC;QACzD;QACA,IAAI,CAACtC,MAAM,CAACyB,UAAU,CAACe,IAAI,CAACN,YAAY,CAAC;MAC1C,CAAC,CAAC;IACH;IACA,IAAI,CAAChC,eAAe,GAAG,EAAE;IACzB,IAAI,CAACC,WAAW,GAAG,IAAI9D,WAAW,CAAC,EAAE,CAAC;IACtC,IAAI,CAAC+D,eAAe,GAAG,IAAI/D,WAAW,CAAC,EAAE,CAAC;IAC1C,IAAI,CAACgE,cAAc,GAAG,IAAIhE,WAAW,CAAC,KAAK,CAAC;IAC5C,IAAI,CAACiE,YAAY,GAAG,IAAIjE,WAAW,CAAC,KAAK,CAAC;IAC1C,IAAI,CAACkE,YAAY,GAAG,IAAIlE,WAAW,CAAC,KAAK,CAAC;IAC1C,IAAI,CAACmE,cAAc,GAAG,IAAInE,WAAW,CAAC,KAAK,CAAC;IAC5C,IAAI,CAACoE,kBAAkB,GAAG,IAAIpE,WAAW,CAAC,KAAK,CAAC;IAChD,IAAI,CAACqE,QAAQ,GAAG,IAAIrE,WAAW,CAACyD,SAAS,CAAC;IAC1C,IAAI,CAACa,MAAM,GAAG,KAAK;IACnB,IAAI,CAACC,gBAAgB,GAAG,KAAK;IAC7B,IAAI,CAACjC,OAAO,GAAG,KAAK;IACpB,IAAI,CAACkC,SAAS,GAAGf,SAAS;IAC1B,MAAM2C,SAAS,GAAG5B,SAAS,CAAC4B,SAAS,CAACC,iBAAiB,EAAE;IAEzD,IAAID,SAAS,CAACE,OAAO,CAAC,UAAU,CAAC,KAAK,CAAC,CAAC,EAAE;MACzC,IAAI,CAAC9B,SAAS,GAAG,UAAU;IAC5B,CAAC,MAAM,IAAI4B,SAAS,CAACE,OAAO,CAAC,QAAQ,CAAC,KAAK,CAAC,CAAC,EAAE;MAC9C,IAAI,CAAC9B,SAAS,GAAG,QAAQ;IAC1B,CAAC,MAAM,IAAI4B,SAAS,CAACE,OAAO,CAAC,SAAS,CAAC,KAAK,CAAC,CAAC,EAAE;MAC/C,IAAI,CAAC9B,SAAS,GAAG,SAAS;IAC3B,CAAC,MAAM,IAAI4B,SAAS,CAACE,OAAO,CAAC,QAAQ,CAAC,KAAK,CAAC,CAAC,EAAE;MAC9C,IAAI,CAAC9B,SAAS,GAAG,QAAQ;IAC1B;IAEA,IAAI,CAACC,oBAAoB,GAAG,CAAC,QAAQ,EAAE,SAAS,EAAE,UAAU,CAAC,CAAC8B,QAAQ,CAAC,IAAI,CAAC/B,SAAU,CAAC;IACvF,IAAI,CAACnC,KAAK,GAAG;MACZmE,KAAK,EAAE,IAAI;MACXC,KAAK,EAAE;KACP;IACD,IAAI,CAAC/C,SAAS,GAAG,IAAI,IAAI,CAACE,cAAc,CAAC,IAAI,CAAC;IAC9C,IAAI,CAACF,SAAS,CAACV,YAAY,CAAC,IAAI,CAACA,YAAY,CAAC0D,IAAI,CAAC,IAAI,CAAC,CAAC;IACzD,IAAI,CAAChD,SAAS,CAACP,YAAY,CAAC,IAAI,CAACA,YAAY,CAACuD,IAAI,CAAC,IAAI,CAAC,CAAC;IACzD,IAAI,CAAChD,SAAS,CAACN,iBAAiB,CAAC,IAAI,CAACA,iBAAiB,CAACsD,IAAI,CAAC,IAAI,CAAC,CAAC;IACnE,IAAI,CAAChD,SAAS,CAACL,mBAAmB,CAAC,IAAI,CAACA,mBAAmB,CAACqD,IAAI,CAAC,IAAI,CAAC,CAAC;IACvE,IAAI,CAAChD,SAAS,CAACJ,cAAc,CAAC,IAAI,CAACA,cAAc,CAACoD,IAAI,CAAC,IAAI,CAAC,CAAC;IAE7DC,WAAW,CAAC,IAAI,CAACC,oBAAoB,CAACF,IAAI,CAAC,IAAI,CAAC,EAAE,IAAI,CAAC;EACxD;EAQAhF,YAAYA,CAAA,EAIsB;IAAA,SAAAmF,KAAA,GAAApF,SAAA,CAAAG,MAAA,EAAAkF,KAAA,OAAAhF,KAAA,CAAA+E,KAAA,GAAAE,KAAA,MAAAA,KAAA,GAAAF,KAAA,EAAAE,KAAA;MAAAD,KAAA,CAAAC,KAAA,IAAAtF,SAAA,CAAAsF,KAAA;IAAA;IAAA,IAH9B,CAAC3F,IAAI,EAAEC,IAAI,CAGmB,GAAAyF,KAAA;IAEjC,QAAQ1F,IAAI;MACX,KAAK,WAAW;QACf,IAAI,CAACsC,SAAS,CAAChC,YAAY,CAAC,WAAW,EAAEL,IAAI,CAAC;QAC9C;MAED,KAAK,aAAa;QACjB,IAAI,CAACqC,SAAS,CAAChC,YAAY,CAAC,aAAa,EAAEL,IAAI,CAAC;QAChD;MAED,KAAK,MAAM;QACV,IAAI,CAACqC,SAAS,CAAChC,YAAY,CAAC,MAAM,EAAEL,IAAI,CAAC;QACzC;IACF;EACD;EAEAC,GAAGA,CAAA,EAAmB;IACrB,IAAI,IAAI,CAACP,KAAK,KAAK,IAAI,EAAE;MACxBS,OAAO,CAACF,GAAG,CAAC,GAAAG,SAAO,CAAC;IACrB;EACD;EAEAuF,OAAOA,CAAA,EAAmB;IACzBxF,OAAO,CAACyF,KAAK,CAAC,GAAAxF,SAAO,CAAC;EACvB;EAEAmF,oBAAoBA,CAAA;IACnB,MAAM;MAAE/C;IAAe,CAAE,GAAG,IAAI;IAChC,MAAMqD,IAAI,GAAGC,IAAI,CAACC,GAAG,EAAE;IACvBC,MAAM,CAACC,OAAO,CAACzD,eAAe,CAAC,CAAC0D,IAAI,CAACC,KAAA,IAAyB;MAAA,IAAxB,CAACzC,EAAE,EAAEC,cAAc,CAAC,GAAAwC,KAAA;MACzD,IAAI,CAAC,CAAC,WAAW,EAAE,WAAW,CAAC,CAACjB,QAAQ,CAACvB,cAAc,CAACyC,kBAAkB,CAAC,IAAIzC,cAAc,CAAC0C,SAAS,GAAG,IAAI,GAAGR,IAAI,EAAE;QACtH,IAAI,CAACpC,kBAAkB,CAACC,EAAE,CAAC;QAC3B,OAAO,IAAI;MACZ;MACA,OAAO,KAAK;IACb,CAAC,CAAC;EACH;EAEAG,iBAAiBA,CAAA;IAChB,MAAMyC,KAAK,GAAiB,EAAE;IAC9B,MAAMC,SAAS,GAA+B,EAAE;IAChD,MAAM;MAAE/D;IAAe,CAAE,GAAG,IAAI;IAEhCwD,MAAM,CAACC,OAAO,CAACzD,eAAe,CAAC,CAAC6B,OAAO,CAACmC,KAAA,IAAyB;MAAA,IAAxB,CAAC9C,EAAE,EAAEC,cAAc,CAAC,GAAA6C,KAAA;MAC5D7C,cAAc,CAAC8C,gBAAgB,EAAE,CAACpC,OAAO,CAAEqC,YAAY,IAAI;QAC1D,MAAMC,IAAI,GAAe;UACxBjD,EAAE;UACFkD,GAAG,EAAEF,YAAY;UACjBG,KAAK,EAAElD,cAAc,CAACyC;SACtB;QACD,QAAQzC,cAAc,CAACyC,kBAAkB;UACxC,KAAK,UAAU;YACdO,IAAI,CAACG,SAAS,GAAG,eAAe;YAChC;UACD,KAAK,WAAW;UAChB,KAAK,WAAW;YACfH,IAAI,CAACG,SAAS,GAAG,WAAW;YAC5BH,IAAI,CAACI,SAAS,GAAG,IAAI;YACrB;UACD,KAAK,cAAc;YAClBJ,IAAI,CAACG,SAAS,GAAG,cAAc;YAC/B;UACD,KAAK,QAAQ;YACZH,IAAI,CAACG,SAAS,GAAG,QAAQ;YACzB;UACD,KAAK,QAAQ;YACZH,IAAI,CAACG,SAAS,GAAG,QAAQ;QAC3B;QACAR,KAAK,CAACxB,IAAI,CAAC6B,IAAI,CAAC;QAChBJ,SAAS,CAAC7C,EAAE,CAAC,GAAGiD,IAAI;MACrB,CAAC,CAAC;IACH,CAAC,CAAC;IACF,IAAI,CAAClE,WAAW,CAACa,GAAG,CAACgD,KAAK,CAAC;IAC3B,IAAI,CAAC5D,eAAe,CAACY,GAAG,CAACiD,SAAS,CAAC;EACpC;EAMAS,eAAeA,CAAA;IACd,IAAI,IAAI,CAAC/D,MAAM,KAAK,IAAI,IAAI,IAAI,CAAChC,OAAO,KAAK,IAAI,IAAI,IAAI,CAACiC,gBAAgB,KAAK,IAAI,EAAE;MACpF;IACD;IACA,MAAM+D,iBAAiB,GAAuB,EAAE;IAChD,MAAM;MAAEzE;IAAe,CAAE,GAAG,IAAI;IAChCwD,MAAM,CAACC,OAAO,CAACzD,eAAe,CAAC,CAAC6B,OAAO,CAAC6C,KAAA,IAAiC;MAAA,IAAhC,CAACxD,EAAE,EAAE;QAAEyD,WAAW,EAAEnG;MAAK,CAAE,CAAC,GAAAkG,KAAA;MACpED,iBAAiB,CAACnC,IAAI,CAAC;QACtBpB,EAAE;QACF1C;OACA,CAAC;IACH,CAAC,CAAC;IAEF,IAAI,CAACqB,SAAS,CAACZ,UAAU,CAAC;MACzBT,KAAK,EAAE,IAAI,CAACA,KAAK;MACjBiG;KACA,CAAC;EACH;EAIAhF,cAAcA,CAACjC,IAAgB;IAC9B;IACA,IAAI,CAAC2C,cAAc,CAACW,GAAG,CAAC,IAAI,CAAC;IAC7B8D,YAAY,CAAC,IAAI,CAAC7D,qBAAqB,CAAC;IACxC,IAAI,CAACA,qBAAqB,GAAG8D,UAAU,CAAC,IAAI,CAAChE,mBAAmB,EAAE,IAAI,CAAC;IACvE,IAAI,IAAI,CAACJ,MAAM,KAAK,IAAI,EAAE;MACzB;IACD;IACA,MAAMgE,iBAAiB,GAAG,CACzB;MACCvD,EAAE,EAAE1D,IAAI,CAACe,IAAK;MACdC,KAAK,EAAEhB,IAAI,CAACgB;KACZ,EACD,GAAGhB,IAAI,CAACiH,iBAAiB,CACzB;IAEDA,iBAAiB,CAAC5C,OAAO,CAAEiD,gBAAgB,IAAI;MAC9C,IAAIA,gBAAgB,CAAC5D,EAAE,KAAK,IAAI,CAAC9C,MAAM,IAAI,IAAI,CAAC4B,eAAe,CAAC8E,gBAAgB,CAAC5D,EAAE,CAAC,IAAI,IAAI,EAAE;QAC7F,IAAI,CAACzD,GAAG,CAAC,mBAAmB,EAAEqH,gBAAgB,CAAC5D,EAAE,CAAC;QAClD,IAAI,CAAC5B,YAAY,CAAC;UACjBf,IAAI,EAAEuG,gBAAgB,CAAC5D,EAAE;UACzB1C,KAAK,EAAEsG,gBAAgB,CAACtG;SACxB,CAAC;MACH;IACD,CAAC,CAAC;EACH;EAEAuG,iBAAiBA,CAAC7D,EAAU;IAC3B,IAAI,IAAI,CAAClB,eAAe,CAACkB,EAAE,CAAC,IAAI,IAAI,EAAE;MACrC,OAAO,IAAI,CAAClB,eAAe,CAACkB,EAAE,CAAC;IAChC;IACA,MAAMC,cAAc,GAAG,IAAI6D,iBAAiB,CAAC,IAAI,CAAClF,MAAM,CAAC;IAEzDqB,cAAc,CAAC0C,SAAS,GAAGP,IAAI,CAACC,GAAG,EAAE;IACrCpC,cAAc,CAACwD,WAAW,GAAG,EAAE;IAC/B,IAAI,CAAC3E,eAAe,CAACkB,EAAE,CAAC,GAAGC,cAAc;IACzC,MAAM8D,UAAU,GAAG,CAClB,cAAc,EACd,WAAW,EACX,cAAc,EACd,0BAA0B,EAC1B,aAAa,EACb,gBAAgB,EAChB,mBAAmB,EACnB,oBAAoB,EACpB,mBAAmB,EACnB,cAAc,EACd,sBAAsB,CACtB;IAEDA,UAAU,CAACpD,OAAO,CAAEqD,SAAS,IAAI;MAChC/D,cAAc,CAACgE,gBAAgB,CAACD,SAAS,EAAGE,CAAC,IAAI;QAChD,IAAI,CAAC3H,GAAG,CAACyD,EAAE,EAAEkE,CAAC,CAAC7H,IAAI,EAAE6H,CAAC,CAAC;MACxB,CAAC,CAAC;IACH,CAAC,CAAC;IAEFjE,cAAc,CAACgE,gBAAgB,CAAC,cAAc,EAAGC,CAAC,IAAI;MACrD,IAAIA,CAAC,CAACC,SAAS,IAAI,IAAI,EAAE;QACxB;MACD;MACA,IAAI,CAACxF,SAAS,CAAChB,aAAa,CAAC;QAC5BF,EAAE,EAAEuC,EAAE;QACNmE,SAAS,EAAE;UACVA,SAAS,EAAED,CAAC,CAACC,SAAS,CAACA,SAAS;UAChCC,aAAa,EAAEF,CAAC,CAACC,SAAS,CAACC,aAAa;UACxCC,MAAM,EAAEH,CAAC,CAACC,SAAS,CAACE;;OAErB,CAAC;IACH,CAAC,CAAC;IACFpE,cAAc,CAACgE,gBAAgB,CAAC,WAAW,EAAE,MAAK;MACjD,IAAI,CAAC9D,iBAAiB,EAAE;IACzB,CAAC,CAAC;IACFF,cAAc,CAACgE,gBAAgB,CAAC,cAAc,EAAE,MAAK;MACpD,IAAI,CAAC9D,iBAAiB,EAAE;IACzB,CAAC,CAAC;IACFF,cAAc,CAACgE,gBAAgB,CAAC,0BAA0B,EAAE,MAAK;MAChE,IACC,CAAChE,cAAc,CAACyC,kBAAkB,KAAK,cAAc,IAAIzC,cAAc,CAACyC,kBAAkB,KAAK,QAAQ,KACvGzC,cAAc,KAAK,IAAI,CAACnB,eAAe,CAACkB,EAAE,CAAC,EAC1C;QACD,IAAI,CAACD,kBAAkB,CAACC,EAAE,CAAC;QAC3B2D,UAAU,CAAC,MAAK;UACf,IAAIrB,MAAM,CAACgC,IAAI,CAAC,IAAI,CAACxF,eAAe,CAAC,CAACjC,MAAM,KAAK,CAAC,EAAE;YACnD,IAAI,CAAC0H,IAAI,EAAE;UACZ;QACD,CAAC,EAAE,IAAI,CAAC;MACT;MACA,IAAI,CAACpE,iBAAiB,EAAE;IACzB,CAAC,CAAC;IACF,OAAOF,cAAc;EACtB;EAIAuE,aAAaA,CAAClH,KAA6B,EAAEmH,SAAwC,EAAExC,OAA8B;IAAA,IAAAyC,qBAAA,EAAAC,qBAAA,EAAAC,UAAA;IACpH,MAAMC,cAAc,GAAI5I,MAAmB,IAAI;MAC9C,IAAI6I,YAAY,IAAI7I,MAAM,CAAC8I,cAAc,EAAE,CAAClI,MAAM,GAAG,CAAC,EAAE;QACvD,MAAMiD,YAAY,GAAG,IAAIgF,YAAY,EAAE;QACvC,MAAME,MAAM,GAAGlF,YAAY,CAACmF,uBAAuB,CAAChJ,MAAM,CAAC;QAC3D,MAAMiJ,MAAM,GAAGpF,YAAY,CAACqF,UAAU,EAAE;QACxCH,MAAM,CAACI,OAAO,CAACF,MAAM,CAAC;QACtB,MAAMG,IAAI,GAAGvF,YAAY,CAACwF,4BAA4B,EAAE;QACxDJ,MAAM,CAACE,OAAO,CAACC,IAAI,CAAC;QACpBH,MAAM,CAACK,IAAI,CAACC,KAAK,GAAG,GAAG;QACvBvJ,MAAM,CAACwJ,WAAW,CAACxJ,MAAM,CAAC8I,cAAc,EAAE,CAAC,CAAC,CAAC,CAAC;QAC9C9I,MAAM,CAACyJ,QAAQ,CAACL,IAAI,CAACpJ,MAAM,CAAC8I,cAAc,EAAE,CAAC,CAAC,CAAC,CAAC;QAChD9I,MAAM,CAACiJ,MAAM,GAAGA,MAAM;QACtB,IAAI,CAACpF,YAAY,GAAGA,YAAY;MACjC;MACA2E,SAAS,CAACxI,MAAM,CAAC;IAClB,CAAC;IAED,KAAAyI,qBAAA,GAAIjF,SAAS,CAACkG,YAAY,cAAAjB,qBAAA,eAAtBA,qBAAA,CAAwBkB,YAAY,EAAE;MACzC,OAAOnG,SAAS,CAACkG,YAAY,CAACC,YAAY,CAACtI,KAAK,CAAC,CAACuI,IAAI,CAAChB,cAAc,CAAC,CAACiB,KAAK,CAAC7D,OAAO,CAAC;IACtF;IAEA,CAAA0C,qBAAA,IAAAC,UAAA,GAAAnF,SAAS,EAACmG,YAAY,cAAAjB,qBAAA,uBAAtBA,qBAAA,CAAAoB,IAAA,CAAAnB,UAAA,EAAyBtH,KAAK,EAAEuH,cAAc,EAAE5C,OAAO,CAAC;EACzD;EAEA2D,YAAYA,CAACtI,KAA6B,EAAEmH,SAAwC,EAA8C;IAAA,IAA5CxC,OAAA,GAAAvF,SAAA,CAAAG,MAAA,QAAAH,SAAA,QAAAgC,SAAA,GAAAhC,SAAA,MAAgC,IAAI,CAACuF,OAAO;IACjI,IAAI3E,KAAK,CAAC0I,OAAO,KAAK,IAAI,EAAE;MAC3B,KAAK,IAAI,CAACxB,aAAa,CAAClH,KAAK,EAAEmH,SAAS,EAAExC,OAAO,CAAC;MAClD;IACD;IACA,IAAI,IAAI,CAACvC,oBAAoB,KAAK,IAAI,EAAE;MACvCjD,OAAO,CAACF,GAAG,CAAC,+BAA+B,CAAC;MAC5C;IACD;IACA,MAAM0J,SAAS,GAAIC,WAAyB,IAAI;MAC/C,MAAMC,OAAO,GAAG,SAAAA,CAAA;QACf7K,eAAe,CAAC8K,IAAI,CAAC;UACpBC,SAAS,EAAEjL,YAAY;UACvBkL,KAAK,EAAE;YACNC,OAAO,EAAE,SAAS;YAClBC,KAAK,EAAE7K,CAAC,CAAC,0DAA0D;;SAEpE,CAAC;MACH,CAAC;MAED,MAAM8K,0BAA0B,GAAG,IAAI,CAAChH,SAAS,KAAK,QAAQ,IAAItE,iBAAiB,CAACuL,SAAS;MAC7F,MAAMC,2BAA2B,GAAG,IAAI,CAAClH,SAAS,KAAK,SAAS,IAAImH,MAAM,CAACC,qBAAqB,IAAI,IAAI;MAExG,IAAI,CAACJ,0BAA0B,IAAI,CAACE,2BAA2B,EAAE;QAChErL,eAAe,CAAC8K,IAAI,CAAC;UACpBC,SAAS,EAAEjL,YAAY;UACvBkL,KAAK,EAAE;YACNE,KAAK,EAAE7K,CAAC,CAAC,cAAc,CAAC;YACxB4K,OAAO,EAAE,SAAS;YAClBO,WAAW,EAAEnL,CAAC,CAAC,mBAAmB,CAAC;YACnCoL,UAAU,EAAEpL,CAAC,CAAC,QAAQ,CAAC;YACvBqL,QAAQ,EAAErL,CAAC,CAAC,uDAAuD,CAAC;YACpEsL,SAAS,EAAEA,CAAA,KAAK;cACf,IAAI,IAAI,CAACxH,SAAS,KAAK,QAAQ,EAAE;gBAChC,MAAMyD,GAAG,GAAG,oGAAoG;gBAChH,IAAI;kBACHgE,MAAM,CAACC,QAAQ,CAACC,OAAO,CAAClE,GAAG,EAAEiD,OAAO,EAAE,MAAK;oBAC1CS,MAAM,CAACR,IAAI,CAAClD,GAAG,CAAC;oBAChBiD,OAAO,EAAE;kBACV,CAAC,CAAC;gBACH,CAAC,CAAC,OAAOkB,MAAM,EAAE;kBAChB5K,OAAO,CAACF,GAAG,CAAC8K,MAAM,CAAC;kBACnBT,MAAM,CAACR,IAAI,CAAClD,GAAG,CAAC;kBAChBiD,OAAO,EAAE;gBACV;cACD,CAAC,MAAM,IAAI,IAAI,CAAC1G,SAAS,KAAK,SAAS,EAAE;gBACxCmH,MAAM,CAACR,IAAI,CAAC,yEAAyE,CAAC;gBACtFD,OAAO,EAAE;cACV;YACD;;SAED,CAAC;QAEF,OAAOlE,OAAO,CAAC,KAAK,CAAC;MACtB;MAEA,MAAMqF,gBAAgB,GAAIrL,MAAmB,IAAI;QAChD,IAAIiK,WAAW,IAAI,IAAI,EAAE;UACxBjK,MAAM,CAACyJ,QAAQ,CAACQ,WAAW,CAACnB,cAAc,EAAE,CAAC,CAAC,CAAC,CAAC;QACjD;QACAN,SAAS,CAACxI,MAAM,CAAC;MAClB,CAAC;MACD,IAAI,IAAI,CAACwD,SAAS,KAAK,SAAS,EAAE;QACjCnC,KAAK,GAAG;UACPoE,KAAK,EAAEpE,KAAK,CAACoE,KAAK;UAClBD,KAAK,EAAE;YACN8F,cAAc,EAAE,QAAQ;YACxBC,WAAW,EAAE;;SAEd;QACD,KAAK,IAAI,CAAChD,aAAa,CAAClH,KAAK,EAAEgK,gBAAgB,EAAErF,OAAO,CAAC;MAC1D,CAAC,MAAM;QACN9G,iBAAiB,CAACsM,WAAW,CAAC,IAAI,CAAChI,SAAU,EAAGO,EAAE,IAAI;UACrD1C,KAAK,GAAG;YACPoE,KAAK,EAAE,KAAK;YACZD,KAAK,EAAE;cACNiG,SAAS,EAAE;gBACVC,iBAAiB,EAAE,SAAS;gBAC5BC,mBAAmB,EAAE5H,EAAE;gBACvB6H,QAAQ,EAAE,IAAI;gBACdC,SAAS,EAAE;;;WAGb;UACD,KAAK,IAAI,CAACtD,aAAa,CAAClH,KAAK,EAAEgK,gBAAgB,EAAErF,OAAO,CAAC;QAC1D,CAAC,CAAC;MACH;IACD,CAAC;IACD,IAAI,IAAI,CAACxC,SAAS,KAAK,SAAS,IAAInC,KAAK,CAACoE,KAAK,IAAI,IAAI,IAAIpE,KAAK,CAACoE,KAAK,KAAK,KAAK,EAAE;MACjFuE,SAAS,EAAE;IACZ,CAAC,MAAM;MACN,MAAM8B,eAAe,GAAI7B,WAAwB,IAAI;QACpDD,SAAS,CAACC,WAAW,CAAC;MACvB,CAAC;MACD,MAAM8B,aAAa,GAAGA,CAAA,KAAK;QAC1B/B,SAAS,EAAE;MACZ,CAAC;MAED,KAAK,IAAI,CAACzB,aAAa,CACtB;QACC9C,KAAK,EAAEpE,KAAK,CAACoE;OACb,EACDqG,eAAe,EACfC,aAAa,CACb;IACF;EACD;EAEAC,iBAAiBA,CAACC,QAAkC,EAAoB;IAAA,SAAAC,KAAA,GAAAzL,SAAA,CAAAG,MAAA,EAAfuL,IAAe,OAAArL,KAAA,CAAAoL,KAAA,OAAAA,KAAA,WAAAE,KAAA,MAAAA,KAAA,GAAAF,KAAA,EAAAE,KAAA;MAAfD,IAAe,CAAAC,KAAA,QAAA3L,SAAA,CAAA2L,KAAA;IAAA;IACvE,IAAI,CAAC9L,GAAG,CAAC,mBAAmB,EAAE,CAAC2L,QAAQ,EAAE,GAAGE,IAAI,CAAC,CAAC;IAClD,IAAI,IAAI,CAAChI,WAAW,IAAI,IAAI,EAAE;MAC7B,OAAO8H,QAAQ,CAAC,IAAI,EAAE,IAAI,CAAC9H,WAAW,CAAC;IACxC;IACA,MAAMqE,SAAS,GAAIxI,MAAmB,IAAI;MACzC,IAAI,CAACmE,WAAW,GAAGnE,MAAM;MACzB,CAAC,IAAI,CAACiD,YAAY,CAACqB,GAAG,EAAE,IAAI,IAAI,CAAC+H,YAAY,EAAE;MAC/C,CAAC,IAAI,CAACnJ,YAAY,CAACoB,GAAG,EAAE,IAAI,IAAI,CAACgI,YAAY,EAAE;MAC/C,IAAI,CAACjJ,QAAQ,CAACM,GAAG,CAAC3D,MAAM,CAAC;MACzB,MAAM;QAAE6C;MAAe,CAAE,GAAG,IAAI;MAChCwD,MAAM,CAACC,OAAO,CAACzD,eAAe,CAAC,CAAC6B,OAAO,CAAC6H,KAAA;QAAA,IAAC,GAAGvI,cAAc,CAAC,GAAAuI,KAAA;QAAA,OAAKvI,cAAc,CAACwI,SAAS,CAACxM,MAAM,CAAC;MAAA,EAAC;MACjGyM,QAAQ,CAACC,aAAa,CAAmB,kBAAkB,CAAE,CAACC,SAAS,GAAG3M,MAAM;MAChFiM,QAAQ,CAAC,IAAI,EAAE,IAAI,CAAC9H,WAAW,CAAC;IACjC,CAAC;IACD,MAAM6B,OAAO,GAAIC,KAAU,IAAI;MAC9BgG,QAAQ,CAAC,KAAK,CAAC;MACf,IAAI,CAACjG,OAAO,CAACC,KAAK,CAAC;IACpB,CAAC;IACD,IAAI,CAAC0D,YAAY,CAAC,IAAI,CAACtI,KAAK,EAAEmH,SAAS,EAAExC,OAAO,CAAC;EAClD;EAYA4G,sBAAsBA,CAAA;IAAA,IAAAC,oBAAA;IACrB,MAAM;MAAEhK;IAAe,CAAE,GAAG,IAAI;IAEhCwD,MAAM,CAACgC,IAAI,CAACxF,eAAe,CAAC,CAAC6B,OAAO,CAAC,IAAI,CAACZ,kBAAkB,CAAC;IAE7D,OAAA+I,oBAAA,GAAKlC,MAAM,CAAC9G,YAAY,cAAAgJ,oBAAA,uBAAnBA,oBAAA,CAAqB5I,KAAK,EAAE,EAAC,CAAC;EACpC;EAEA6I,eAAeA,CAAA,EAAe;IAAA,IAAdC,OAAO,GAAAtM,SAAA,CAAAG,MAAA,QAAAH,SAAA,QAAAgC,SAAA,GAAAhC,SAAA,MAAG,IAAI;IAC7B,IAAI,IAAI,CAAC0D,WAAW,IAAI,IAAI,EAAE;MAC7B,IAAI,CAACA,WAAW,CAAC2E,cAAc,EAAE,CAACpE,OAAO,CAAEe,KAAK,IAAI;QACnDA,KAAK,CAACsH,OAAO,GAAGA,OAAO;MACxB,CAAC,CAAC;MACF,IAAI,CAAC9J,YAAY,CAACU,GAAG,CAACoJ,OAAO,CAAC;IAC/B;EACD;EAEAV,YAAYA,CAAA;IACX,IAAI,CAACS,eAAe,CAAC,KAAK,CAAC;EAC5B;EAEAE,WAAWA,CAAA;IACV,IAAI,CAACF,eAAe,CAAC,IAAI,CAAC;EAC3B;EAEAG,WAAWA,CAAA;IACV,IAAI,IAAI,CAAChK,YAAY,CAACqB,GAAG,EAAE,EAAE;MAC5B,OAAO,IAAI,CAAC+H,YAAY,EAAE;IAC3B;IACA,OAAO,IAAI,CAACW,WAAW,EAAE;EAC1B;EAIAE,eAAeA,CAAA,EAAe;IAAA,IAAdH,OAAO,GAAAtM,SAAA,CAAAG,MAAA,QAAAH,SAAA,QAAAgC,SAAA,GAAAhC,SAAA,MAAG,IAAI;IAC7B,IAAI,IAAI,CAAC0D,WAAW,IAAI,IAAI,EAAE;MAC7B,IAAI,CAACA,WAAW,CAACgJ,cAAc,EAAE,CAACzI,OAAO,CAAEc,KAAK,IAAI;QACnDA,KAAK,CAACuH,OAAO,GAAGA,OAAO;MACxB,CAAC,CAAC;MACF,IAAI,CAAC7J,YAAY,CAACS,GAAG,CAACoJ,OAAO,CAAC;IAC/B;EACD;EAEAK,kBAAkBA,CAAA;IACjB,IAAI,CAACC,qBAAqB,CAAC,KAAK,CAAC;EAClC;EAEAC,iBAAiBA,CAAA;IAChB,IAAI,CAACD,qBAAqB,CAAC,IAAI,CAAC;EACjC;EAEAA,qBAAqBA,CAAA,EAAe;IAAA,IAAdN,OAAO,GAAAtM,SAAA,CAAAG,MAAA,QAAAH,SAAA,QAAAgC,SAAA,GAAAhC,SAAA,MAAG,IAAI;IACnC,IAAI,IAAI,CAAC0D,WAAW,IAAI,IAAI,EAAE;MAC7B,IAAI,CAAC9C,KAAK,CAAC0I,OAAO,GAAGgD,OAAO;MAC5B,OAAO,IAAI,CAAC5I,WAAW;MACvB,IAAI,CAAC6H,iBAAiB,CAAEuB,GAAG,IAAI;QAC9B,IAAIA,GAAG,IAAI,IAAI,EAAE;UAChB;QACD;QACA,IAAI,CAACnK,kBAAkB,CAACO,GAAG,CAACoJ,OAAO,CAAC;QACpC,IAAI,CAACH,sBAAsB,EAAE;QAC7B,IAAI,CAACrL,QAAQ,EAAE;MAChB,CAAC,CAAC;IACH;EACD;EAEA+K,YAAYA,CAAA;IACX,IAAI,CAACY,eAAe,CAAC,KAAK,CAAC;EAC5B;EAEAM,WAAWA,CAAA;IACV,IAAI,CAACN,eAAe,CAAC,IAAI,CAAC;EAC3B;EAEAO,WAAWA,CAAA;IACV,IAAI,IAAI,CAACvK,YAAY,CAACoB,GAAG,EAAE,EAAE;MAC5B,OAAO,IAAI,CAACgI,YAAY,EAAE;IAC3B;IACA,OAAO,IAAI,CAACkB,WAAW,EAAE;EAC1B;EAEAlF,IAAIA,CAAA;IACH,IAAI,CAAChF,MAAM,GAAG,KAAK;IACnB,IAAI,CAAChC,OAAO,GAAG,KAAK;IACpB,IAAI,CAACiC,gBAAgB,GAAG,KAAK;IAC7B,IAAI,IAAI,CAACY,WAAW,IAAI,IAAI,IAAI,OAAO,IAAI,CAACA,WAAW,KAAK,WAAW,EAAE;MACxE,IAAI,CAACA,WAAW,CAACuJ,SAAS,EAAE,CAAChJ,OAAO,CAAEiJ,KAAK,IAAKA,KAAK,CAACrF,IAAI,EAAE,CAAC;IAC9D;IACA,IAAI,CAACjF,QAAQ,CAACM,GAAG,CAAClB,SAAS,CAAC;IAC5B,OAAO,IAAI,CAAC0B,WAAW;IACvB,IAAI,CAACyI,sBAAsB,EAAE;EAC9B;EAEA5L,SAASA,CAAA,EAAuD;IAAA,IAAtDK,KAAA,GAAAZ,SAAA,CAAAG,MAAA,QAAAH,SAAA,QAAAgC,SAAA,GAAAhC,SAAA,MAAgC,EAAE;IAAA,SAAAmN,KAAA,GAAAnN,SAAA,CAAAG,MAAA,EAAKuL,IAAe,OAAArL,KAAA,CAAA8M,KAAA,OAAAA,KAAA,WAAAC,KAAA,MAAAA,KAAA,GAAAD,KAAA,EAAAC,KAAA;MAAf1B,IAAe,CAAA0B,KAAA,QAAApN,SAAA,CAAAoN,KAAA;IAAA;IAC/D,IAAI,CAACvN,GAAG,CAAC,WAAW,EAAE,CAACe,KAAK,EAAE,GAAG8K,IAAI,CAAC,CAAC;IACvC,IAAI,CAAC9K,KAAK,GAAGA,KAAK;IAClB,IAAI,CAAC2K,iBAAiB,CAAC,MAAK;MAC3B,IAAI,CAAC1I,MAAM,GAAG,IAAI;MAClB,IAAI,CAACZ,SAAS,CAAC1B,SAAS,CAAC;QACxBK,KAAK,EAAE,IAAI,CAACA;OACZ,CAAC;IACH,CAAC,CAAC;EACH;EAEAyM,kBAAkBA,CAAA,EAAuD;IAAA,IAAtDzM,KAAA,GAAAZ,SAAA,CAAAG,MAAA,QAAAH,SAAA,QAAAgC,SAAA,GAAAhC,SAAA,MAAgC,EAAE;IAAA,SAAAsN,KAAA,GAAAtN,SAAA,CAAAG,MAAA,EAAKuL,IAAe,OAAArL,KAAA,CAAAiN,KAAA,OAAAA,KAAA,WAAAC,KAAA,MAAAA,KAAA,GAAAD,KAAA,EAAAC,KAAA;MAAf7B,IAAe,CAAA6B,KAAA,QAAAvN,SAAA,CAAAuN,KAAA;IAAA;IACxE,IAAI,CAAC1N,GAAG,CAAC,oBAAoB,EAAE,CAACe,KAAK,EAAE,GAAG8K,IAAI,CAAC,CAAC;IAChD,IAAI,CAAC9K,KAAK,GAAGA,KAAK;IAClB,IAAI,CAACiC,MAAM,GAAG,IAAI;IAClB,IAAI,CAAChC,OAAO,GAAG,IAAI;IACnB,IAAI,CAACoB,SAAS,CAAC1B,SAAS,CAAC;MACxBK,KAAK,EAAE,IAAI,CAACA,KAAK;MACjBC,OAAO,EAAE;KACT,CAAC;EACH;EAEAU,YAAYA,CAAC3B,IAAc;IAAA,IAAA4N,YAAA;IAC1B,IAAI,IAAI,CAACzL,UAAU,KAAK,IAAI,EAAE;MAC7BkF,UAAU,CAAC,MAAK;QACf,IAAI,CAACnG,QAAQ,CAAC;UACbC,EAAE,EAAEnB,IAAI,CAACe,IAAI;UACbE,OAAO,EAAEjB,IAAI,CAACiB,OAAO;UACrBD,KAAK,EAAEhB,IAAI,CAACgB;SACZ,CAAC;MACH,CAAC,EAAE,CAAC,CAAC;MACL;IACD;IAEA,MAAM6M,IAAI,GAAGnP,MAAM,CAACoP,KAAK,CAACC,OAAO,CAAC/N,IAAI,CAACe,IAAI,CAAC;IAC5C,IAAIiN,YAAY,GAAG5L,SAAS;IAC5B,IAAIyL,IAAI,aAAJA,IAAI,eAAJA,IAAI,CAAElJ,QAAQ,EAAE;MACnBqJ,YAAY,GAAGH,IAAI,CAAClJ,QAAQ;IAC7B;IACA,MAAMsJ,YAAY,GAAG/O,gBAAgB,CAAC6O,OAAO,CAAC;MAC7CG,GAAG,EAAElO,IAAI,CAACH;KACV,CAAE;IAEH,IAAIsO,IAAI;IACR,IAAIjE,KAAK;IACT,IAAIlK,IAAI,CAACiB,OAAO,KAAK,IAAI,EAAE;MAC1BkN,IAAI,GAAG,KAAc;MACrBjE,KAAK,GAAG7K,CAAC,CAAC,6BAA6B,EAAE2O,YAAY,CAAC;IACvD,CAAC,MAAM,IAAIC,YAAY,IAAIA,YAAY,CAAC5O,CAAC,KAAK,GAAG,EAAE;MAAA,IAAA+O,WAAA;MAClD,KAAAA,WAAA,GAAIpO,IAAI,CAACgB,KAAK,cAAAoN,WAAA,eAAVA,WAAA,CAAYjJ,KAAK,EAAE;QACtBgJ,IAAI,GAAG,OAAgB;QACvBjE,KAAK,GAAG7K,CAAC,CAAC,kCAAkC,EAAE2O,YAAY,CAAC;MAC5D,CAAC,MAAM;QACNG,IAAI,GAAG,OAAgB;QACvBjE,KAAK,GAAG7K,CAAC,CAAC,kCAAkC,EAAE2O,YAAY,CAAC;MAC5D;IACD,CAAC,MAAM,KAAAJ,YAAA,GAAI5N,IAAI,CAACgB,KAAK,cAAA4M,YAAA,eAAVA,YAAA,CAAYzI,KAAK,EAAE;MAC7BgJ,IAAI,GAAG,OAAgB;MACvBjE,KAAK,GAAG7K,CAAC,CAAC,iCAAiC,EAAE4O,YAAY,CAACI,IAAI,CAAC;IAChE,CAAC,MAAM;MACNF,IAAI,GAAG,OAAgB;MACvBjE,KAAK,GAAG7K,CAAC,CAAC,iCAAiC,EAAE4O,YAAY,CAACI,IAAI,CAAC;IAChE;IAEArP,eAAe,CAAC8K,IAAI,CAAC;MACpBC,SAAS,EAAEjL,YAAY;MACvBkL,KAAK,EAAE;QACNE,KAAK;QACLiE,IAAI;QACJ3D,WAAW,EAAEnL,CAAC,CAAC,KAAK,CAAC;QACrBoL,UAAU,EAAEpL,CAAC,CAAC,IAAI,CAAC;QACnBqL,QAAQ,EAAErL,CAAC,CAAC,uBAAuB,CAAC;QACpCsL,SAAS,EAAEA,CAAA,KAAK;UACf,KAAK1L,YAAY,CAACe,IAAI,CAACH,IAAK,CAAC;UAC7B,OAAO,IAAI,CAACqB,QAAQ,CAAC;YACpBC,EAAE,EAAEnB,IAAI,CAACe,IAAI;YACbE,OAAO,EAAEjB,IAAI,CAACiB,OAAO;YACrBD,KAAK,EAAEhB,IAAI,CAACgB;WACZ,CAAC;QACH,CAAC;QACDsN,QAAQ,EAAEA,CAAA,KAAM,IAAI,CAACrG,IAAI,EAAE;QAC3BsG,OAAO,EAAEA,CAAA,KAAM,IAAI,CAACtG,IAAI;;KAEzB,CAAC;EACH;EAEA/G,QAAQA,CAAA,EAAwC;IAAA,IAAvClB,IAAA,GAAAI,SAAA,CAAAG,MAAA,QAAAH,SAAA,QAAAgC,SAAA,GAAAhC,SAAA,MAAiB,EAAE;IAC3BJ,IAAI,CAACgB,KAAK,GAAG,IAAI,CAACA,KAAK;IAAC,SAAAwN,KAAA,GAAApO,SAAA,CAAAG,MAAA,EADQuL,IAAe,OAAArL,KAAA,CAAA+N,KAAA,OAAAA,KAAA,WAAAC,KAAA,MAAAA,KAAA,GAAAD,KAAA,EAAAC,KAAA;MAAf3C,IAAe,CAAA2C,KAAA,QAAArO,SAAA,CAAAqO,KAAA;IAAA;IAE/C,IAAI,CAACxO,GAAG,CAAC,UAAU,EAAE,CAACD,IAAI,EAAE,GAAG8L,IAAI,CAAC,CAAC;IACrC,IAAI,CAACH,iBAAiB,CAAC,MAAK;MAC3B,IAAI,CAACzI,gBAAgB,GAAGlD,IAAI,CAACiB,OAAQ;MACrC,IAAI,CAACgC,MAAM,GAAG,IAAI;MAClB,IAAI,CAACZ,SAAS,CAACnB,QAAQ,CAAClB,IAAI,CAAC;IAC9B,CAAC,CAAC;EACH;EAEA8B,YAAYA,CAAC9B,IAAc,EAAoB;IAC9C,IAAI,IAAI,CAACiD,MAAM,KAAK,IAAI,EAAE;MACzB;IACD;IAAC,SAAAyL,KAAA,GAAAtO,SAAA,CAAAG,MAAA,EAH8BuL,IAAe,OAAArL,KAAA,CAAAiO,KAAA,OAAAA,KAAA,WAAAC,KAAA,MAAAA,KAAA,GAAAD,KAAA,EAAAC,KAAA;MAAf7C,IAAe,CAAA6C,KAAA,QAAAvO,SAAA,CAAAuO,KAAA;IAAA;IAI9C,IAAI,CAAC1O,GAAG,CAAC,cAAc,EAAE,CAACD,IAAI,EAAE,GAAG8L,IAAI,CAAC,CAAC;IACzC,IAAInI,cAAc,GAAG,IAAI,CAAC4D,iBAAiB,CAACvH,IAAI,CAACe,IAAK,CAAC;IAEvD;IACA;IACA;IACA;IACA;IAEA;IAEA,IAAK4C,cAAc,CAACiL,cAAiD,KAAK,UAAU,EAAE;MACrF,IAAI,CAACnL,kBAAkB,CAACzD,IAAI,CAACe,IAAK,CAAC;MACnC4C,cAAc,GAAG,IAAI,CAAC4D,iBAAiB,CAACvH,IAAI,CAACe,IAAK,CAAC;IACpD;IACA,IAAI4C,cAAc,CAACyC,kBAAkB,KAAK,KAAK,EAAE;MAChD;IACD;IACAzC,cAAc,CAACwD,WAAW,GAAGnH,IAAI,CAACgB,KAAM;IACxC,IAAI,IAAI,CAAC8C,WAAW,EAAE;MACrBH,cAAc,CAACwI,SAAS,CAAC,IAAI,CAACrI,WAAW,CAAC;IAC3C;IACA,MAAM+K,OAAO,GAAmCC,KAAK,IAAI;MACxD,MAAMC,kBAAkB,GAAGA,CAAA,KAAK;QAC/B,IAAI,CAAC1M,SAAS,CAACd,eAAe,CAAC;UAC9BJ,EAAE,EAAEnB,IAAI,CAACe,IAAI;UACbhB,IAAI,EAAE,OAAO;UACbiP,EAAE,EAAErL,cAAc,CAAC0C,SAAS;UAC5BrF,KAAK,EAAE,IAAI,CAACA,KAAK;UACjBiO,WAAW,EAAE;YACZC,GAAG,EAAEJ,KAAK,CAACI,GAAG;YACdnP,IAAI,EAAE+O,KAAK,CAAC/O;;SAEb,CAAC;MACH,CAAC;MAED,KAAK4D,cAAc,CAACwL,mBAAmB,CAAC,IAAIC,qBAAqB,CAACN,KAAK,CAAC,EAAEC,kBAAkB,EAAE,IAAI,CAACpJ,OAAO,CAAC;IAC5G,CAAC;IAED,IAAI3F,IAAI,CAACiB,OAAO,KAAK,IAAI,EAAE;MAAA,IAAAoO,YAAA,EAAAC,YAAA;MAC1B,KAAK3L,cAAc,CAAC4L,WAAW,CAACV,OAAO,EAAE,IAAI,CAAClJ,OAAO,EAAE;QACtDyF,SAAS,EAAE;UACVoE,mBAAmB,GAAAH,YAAA,GAAErP,IAAI,CAACgB,KAAK,cAAAqO,YAAA,uBAAVA,YAAA,CAAYjK,KAAK;UACtCqK,mBAAmB,GAAAH,YAAA,GAAEtP,IAAI,CAACgB,KAAK,cAAAsO,YAAA,uBAAVA,YAAA,CAAYnK;;OAElC,CAAC;IACH,CAAC,MAAM;MACN,KAAKxB,cAAc,CAAC4L,WAAW,CAACV,OAAO,EAAE,IAAI,CAAClJ,OAAO,CAAC;IACvD;EACD;EAEA+J,aAAaA,CAAC1P,IAAmC,EAAoB;IACpE,IAAI,IAAI,CAACiD,MAAM,KAAK,IAAI,EAAE;MACzB;IACD;IAAC,SAAA0M,KAAA,GAAAvP,SAAA,CAAAG,MAAA,EAHoDuL,IAAe,OAAArL,KAAA,CAAAkP,KAAA,OAAAA,KAAA,WAAAC,KAAA,MAAAA,KAAA,GAAAD,KAAA,EAAAC,KAAA;MAAf9D,IAAe,CAAA8D,KAAA,QAAAxP,SAAA,CAAAwP,KAAA;IAAA;IAKpE,IAAI,CAAC3P,GAAG,CAAC,eAAe,EAAE,CAACD,IAAI,EAAE,GAAG8L,IAAI,CAAC,CAAC;IAC1C,IAAInI,cAAc,GAAG,IAAI,CAAC4D,iBAAiB,CAACvH,IAAI,CAACe,IAAK,CAAC;IAEvD,IAAI,CAAC,kBAAkB,EAAE,QAAQ,CAAC,CAACmE,QAAQ,CAACvB,cAAc,CAACiL,cAAc,CAAC,IAAIjL,cAAc,CAAC0C,SAAS,GAAGrG,IAAI,CAACgP,EAAE,EAAE;MACjH,IAAI,CAACvL,kBAAkB,CAACzD,IAAI,CAACe,IAAK,CAAC;MACnC4C,cAAc,GAAG,IAAI,CAAC4D,iBAAiB,CAACvH,IAAI,CAACe,IAAK,CAAC;IACpD;IAEA,IAAI4C,cAAc,CAACyC,kBAAkB,KAAK,KAAK,EAAE;MAChD;IACD;IAEA,KAAKzC,cAAc,CAACkM,oBAAoB,CAAC,IAAIT,qBAAqB,CAACpP,IAAI,CAACiP,WAAW,CAAC,CAAC;IAErF,IAAI;MACH,IAAI,IAAI,CAACnL,WAAW,EAAE;QACrBH,cAAc,CAACwI,SAAS,CAAC,IAAI,CAACrI,WAAW,CAAC;MAC3C;IACD,CAAC,CAAC,OAAO8B,KAAK,EAAE;MACfzF,OAAO,CAACF,GAAG,CAAC2F,KAAK,CAAC;IACnB;IAEA,MAAMkK,QAAQ,GAAmCC,MAAM,IAAI;MAC1D,MAAMhB,kBAAkB,GAAGA,CAAA,KAAK;QAC/B,IAAI,CAAC1M,SAAS,CAACd,eAAe,CAAC;UAC9BJ,EAAE,EAAEnB,IAAI,CAACe,IAAI;UACbhB,IAAI,EAAE,QAAQ;UACdiP,EAAE,EAAErL,cAAc,CAAC0C,SAAS;UAC5B4I,WAAW,EAAE;YACZC,GAAG,EAAEa,MAAM,CAACb,GAAG;YACfnP,IAAI,EAAEgQ,MAAM,CAAChQ;;SAEd,CAAC;MACH,CAAC;MAED,KAAK4D,cAAc,CAACwL,mBAAmB,CAAC,IAAIC,qBAAqB,CAACW,MAAM,CAAC,EAAEhB,kBAAkB,EAAE,IAAI,CAACpJ,OAAO,CAAC;IAC7G,CAAC;IAED,KAAKhC,cAAc,CAACqM,YAAY,CAACF,QAAQ,EAAE,IAAI,CAACnK,OAAO,CAAC;EACzD;EAEA5D,iBAAiBA,CAAC/B,IAAmB,EAAoB;IAAA,IAAAiQ,qBAAA;IACxD,IAAI,IAAI,CAAChN,MAAM,KAAK,IAAI,EAAE;MACzB;IACD;IACA,IAAIjD,IAAI,CAACmB,EAAE,KAAK,IAAI,CAACP,MAAM,EAAE;MAC5B;IACD;IAAC,SAAAsP,KAAA,GAAA9P,SAAA,CAAAG,MAAA,EANwCuL,IAAe,OAAArL,KAAA,CAAAyP,KAAA,OAAAA,KAAA,WAAAC,KAAA,MAAAA,KAAA,GAAAD,KAAA,EAAAC,KAAA;MAAfrE,IAAe,CAAAqE,KAAA,QAAA/P,SAAA,CAAA+P,KAAA;IAAA;IAOxD,IAAI,CAAClQ,GAAG,CAAC,mBAAmB,EAAE,CAACD,IAAI,EAAE,GAAG8L,IAAI,CAAC,CAAC;IAC9C,MAAMnI,cAAc,GAAG,IAAI,CAAC4D,iBAAiB,CAACvH,IAAI,CAACe,IAAK,CAAC;IACzD,IACC4C,cAAc,CAACyC,kBAAkB,KAAK,QAAQ,IAC9CzC,cAAc,CAACyC,kBAAkB,KAAK,QAAQ,IAC9CzC,cAAc,CAACyC,kBAAkB,KAAK,cAAc,IACpDzC,cAAc,CAACyC,kBAAkB,KAAK,WAAW,EAChD;MACD,KAAKzC,cAAc,CAACyM,eAAe,CAAC,IAAIC,eAAe,CAACrQ,IAAI,CAAC6H,SAAS,CAAC,CAAC;IACzE;IACAuE,QAAQ,CAACC,aAAa,CAAmB,mBAAmB,CAAE,CAACC,SAAS,IAAA2D,qBAAA,GAAG,IAAI,CAACxN,WAAW,CAACwB,GAAG,EAAE,CAAC,CAAC,CAAC,cAAAgM,qBAAA,uBAAzBA,qBAAA,CAA2BrJ,GAAG;EAC1G;EAEA5E,mBAAmBA,CAAChC,IAAqB,EAAoB;IAC5D,IAAI,IAAI,CAACiD,MAAM,KAAK,IAAI,EAAE;MACzB;IACD;IACA,IAAIjD,IAAI,CAACmB,EAAE,KAAK,IAAI,CAACP,MAAM,EAAE;MAC5B;IACD;IAAC,SAAA0P,MAAA,GAAAlQ,SAAA,CAAAG,MAAA,EAN4CuL,IAAe,OAAArL,KAAA,CAAA6P,MAAA,OAAAA,MAAA,WAAAC,MAAA,MAAAA,MAAA,GAAAD,MAAA,EAAAC,MAAA;MAAfzE,IAAe,CAAAyE,MAAA,QAAAnQ,SAAA,CAAAmQ,MAAA;IAAA;IAO5D,IAAI,CAACtQ,GAAG,CAAC,qBAAqB,EAAE,CAACD,IAAI,EAAE,GAAG8L,IAAI,CAAC,CAAC;IAChD,MAAMnI,cAAc,GAAG,IAAI,CAAC4D,iBAAiB,CAACvH,IAAI,CAACe,IAAK,CAAC;IACzD,IAAIf,IAAI,CAACD,IAAI,KAAK,OAAO,EAAE;MAC1B4D,cAAc,CAACwD,WAAW,GAAGnH,IAAI,CAACgB,KAAK;MACvC,IAAI,CAAC0O,aAAa,CAAC;QAClB3O,IAAI,EAAEf,IAAI,CAACe,IAAI;QACfiO,EAAE,EAAEhP,IAAI,CAACgP,EAAE;QACXC,WAAW,EAAEjP,IAAI,CAACiP;OAClB,CAAC;IACH,CAAC,MAAM;MACN,KAAKtL,cAAc,CAACkM,oBAAoB,CAAC,IAAIT,qBAAqB,CAACpP,IAAI,CAACiP,WAAW,CAAC,CAAC;IACtF;EACD;;AAGD,MAAM3Q,MAAM,GAAG,IAAK;EAGnBkB,YAAA;IAAA,KAFAgR,iBAAiB,GAAgC,EAAE;IAGlD,IAAI,CAACA,iBAAiB,GAAG,EAAE;EAC5B;EAEAC,mBAAmBA,CAACvC,GAAiB,EAAiC;IAAA,IAA/BwC,SAAA,GAAAtQ,SAAA,CAAAG,MAAA,QAAAH,SAAA,QAAAgC,SAAA,GAAAhC,SAAA,MAA2B,IAAI;IACrE,IAAIsM,OAAO,GAAG,KAAK;IACnB,IAAI,CAACgE,SAAS,EAAE;MACf,MAAMzC,YAAY,GAAG/O,gBAAgB,CAAC6O,OAAO,CAAC;QAAEG;MAAG,CAAE,CAAC;MACtD,IAAI,CAACD,YAAY,EAAE;QAClB;MACD;MACA,QAAQA,YAAY,CAAC5O,CAAC;QACrB,KAAK,GAAG;UACPqN,OAAO,GAAGvN,QAAQ,CAAC8E,GAAG,CAAC,sBAAsB,CAAC;UAC9C;QACD,KAAK,GAAG;UACPyI,OAAO,GAAGvN,QAAQ,CAAC8E,GAAG,CAAC,uBAAuB,CAAC;UAC/C;QACD,KAAK,GAAG;UACPyI,OAAO,GAAGvN,QAAQ,CAAC8E,GAAG,CAAC,uBAAuB,CAAC;UAC/C;QACD,KAAK,GAAG;UACPyI,OAAO,GAAGvN,QAAQ,CAAC8E,GAAG,CAAS,2BAA2B,CAAC,KAAK,QAAQ;MAC1E;IACD,CAAC,MAAM;MACNyI,OAAO,GAAGvN,QAAQ,CAAC8E,GAAG,CAAS,2BAA2B,CAAC,KAAK,QAAQ;IACzE;IACAyI,OAAO,GAAGA,OAAO,IAAIvN,QAAQ,CAAC8E,GAAG,CAAC,gBAAgB,CAAC;IACnD,IAAIyI,OAAO,KAAK,KAAK,EAAE;MACtB;IACD;IACA,IAAI,IAAI,CAAC8D,iBAAiB,CAACtC,GAAG,CAAC,IAAI,IAAI,EAAE;MACxC,IAAIyC,GAAG,GAAGjS,MAAM,CAACkS,MAAM,EAAG;MAC1B,IAAIzO,UAAU,GAAG,KAAK;MACtB,IAAIuO,SAAS,EAAE;QACdC,GAAG,GAAGD,SAAS;QACfvO,UAAU,GAAG,IAAI;MAClB;MACA,IAAI,CAACqO,iBAAiB,CAACtC,GAAG,CAAC,GAAG,IAAIhM,WAAW,CAACyO,GAAG,EAAEzC,GAAG,EAAE/L,UAAU,CAAC;IACpE;IACA,OAAO,IAAI,CAACqO,iBAAiB,CAACtC,GAAG,CAAC;EACnC;CACA,CAAC,CAAE;AAEJxP,MAAM,CAACmS,OAAO,CAAC,MAAK;EACnBjS,OAAO,CAACkS,OAAO,CAAC,MAAK;IACpB,MAAMH,GAAG,GAAGjS,MAAM,CAACkS,MAAM,EAAE;IAE3B,IAAID,GAAG,EAAE;MACRvR,GAAG,CAACO,MAAM,CAAC,aAAa,EAAE,IAAAC,MAAA,CAAI+Q,GAAG,OAAA/Q,MAAA,CAAIN,cAAc,CAACQ,OAAO,EAAG,EAAE,CAACC,IAAI,EAAEC,IAAI,KAAI;QAC9E,IAAIA,IAAI,CAACH,IAAI,IAAI,IAAI,EAAE;UACtB;QACD;QACA,MAAMkR,MAAM,GAAGzS,MAAM,CAACmS,mBAAmB,CAACzQ,IAAI,CAACH,IAAI,CAAC;QAEpD,QAAQE,IAAI;UACX,KAAK,WAAW;YACfgR,MAAM,aAANA,MAAM,uBAANA,MAAM,CAAE1Q,YAAY,CAAC,WAAW,EAAEL,IAAI,CAAC;YACvC;UACD,KAAK,aAAa;YACjB+Q,MAAM,aAANA,MAAM,uBAANA,MAAM,CAAE1Q,YAAY,CAAC,aAAa,EAAEL,IAAI,CAAC;YACzC;UACD,KAAK,MAAM;YACV+Q,MAAM,aAANA,MAAM,uBAANA,MAAM,CAAE1Q,YAAY,CAAC,MAAM,EAAEL,IAAI,CAAC;YAClC;QACF;MACD,CAAC,CAAC;IACH;EACD,CAAC,CAAC;AACH,CAAC,CAAC","ignoreList":[]},"sourceType":"module","externalDependencies":{},"hash":"f2b92ef2489ea6dc2503398148492cd3aae6d933"}
