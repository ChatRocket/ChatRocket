{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/app/livechat/server/lib/departmentsLib.ts","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","topLevelAwait","objectRestSpread","objectRestSpread","asyncGenerators","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"os.osx.arm64"},"sourceFileName":"app/livechat/server/lib/departmentsLib.ts","filename":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/app/livechat/server/lib/departmentsLib.ts","inputSourceMap":{"version":3,"file":"app/livechat/server/lib/departmentsLib.ts","sourceRoot":"","sources":["app/livechat/server/lib/departmentsLib.ts"],"names":[],"mappings":"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","sourcesContent":["import type { LivechatDepartmentDTO, ILivechatDepartment, ILivechatDepartmentAgents } from '@rocket.chat/core-typings';\nimport { LivechatDepartment, LivechatDepartmentAgents, LivechatVisitors, LivechatRooms } from '@rocket.chat/models';\nimport { Meteor } from 'meteor/meteor';\n\nimport { callbacks } from '../../../../lib/callbacks';\nimport {\n\tnotifyOnLivechatDepartmentAgentChangedByDepartmentId,\n\tnotifyOnLivechatDepartmentAgentChanged,\n} from '../../../lib/server/lib/notifyListener';\nimport { updateDepartmentAgents } from './Helper';\nimport { isDepartmentCreationAvailable } from './isDepartmentCreationAvailable';\nimport { livechatLogger } from './logger';\n/**\n * @param {string|null} _id - The department id\n * @param {Partial<import('@rocket.chat/core-typings').ILivechatDepartment>} departmentData\n * @param {{upsert?: { agentId: string; count?: number; order?: number; }[], remove?: { agentId: string; count?: number; order?: number; }}} [departmentAgents] - The department agents\n * @param {{_id?: string}} [departmentUnit] - The department's unit id\n */\nexport async function saveDepartment(\n\tuserId: string,\n\t_id: string | null,\n\tdepartmentData: LivechatDepartmentDTO,\n\tdepartmentAgents?: {\n\t\tupsert?: { agentId: string; count?: number; order?: number }[];\n\t\tremove?: { agentId: string; count?: number; order?: number };\n\t},\n\tdepartmentUnit?: { _id?: string },\n) {\n\tcheck(_id, Match.Maybe(String));\n\tif (departmentUnit?._id !== undefined && typeof departmentUnit._id !== 'string') {\n\t\tthrow new Meteor.Error('error-invalid-department-unit', 'Invalid department unit id provided', {\n\t\t\tmethod: 'livechat:saveDepartment',\n\t\t});\n\t}\n\n\tconst department = _id\n\t\t? await LivechatDepartment.findOneById(_id, { projection: { _id: 1, archived: 1, enabled: 1, parentId: 1 } })\n\t\t: null;\n\n\tif (departmentUnit && !departmentUnit._id && department && department.parentId) {\n\t\tconst isLastDepartmentInUnit = (await LivechatDepartment.countDepartmentsInUnit(department.parentId)) === 1;\n\t\tif (isLastDepartmentInUnit) {\n\t\t\tthrow new Meteor.Error('error-unit-cant-be-empty', \"The last department in a unit can't be removed\", {\n\t\t\t\tmethod: 'livechat:saveDepartment',\n\t\t\t});\n\t\t}\n\t}\n\n\tif (!department && !(await isDepartmentCreationAvailable())) {\n\t\tthrow new Meteor.Error('error-max-departments-number-reached', 'Maximum number of departments reached', {\n\t\t\tmethod: 'livechat:saveDepartment',\n\t\t});\n\t}\n\n\tif (department?.archived && departmentData.enabled) {\n\t\tthrow new Meteor.Error('error-archived-department-cant-be-enabled', 'Archived departments cant be enabled', {\n\t\t\tmethod: 'livechat:saveDepartment',\n\t\t});\n\t}\n\n\tconst defaultValidations: Record<string, Match.Matcher<any> | BooleanConstructor | StringConstructor> = {\n\t\tenabled: Boolean,\n\t\tname: String,\n\t\tdescription: Match.Optional(String),\n\t\tshowOnRegistration: Boolean,\n\t\temail: String,\n\t\tshowOnOfflineForm: Boolean,\n\t\trequestTagBeforeClosingChat: Match.Optional(Boolean),\n\t\tchatClosingTags: Match.Optional([String]),\n\t\tfallbackForwardDepartment: Match.Optional(String),\n\t\tdepartmentsAllowedToForward: Match.Optional([String]),\n\t\tallowReceiveForwardOffline: Match.Optional(Boolean),\n\t};\n\n\t// The Livechat Form department support addition/custom fields, so those fields need to be added before validating\n\tObject.keys(departmentData).forEach((field) => {\n\t\tif (!defaultValidations.hasOwnProperty(field)) {\n\t\t\tdefaultValidations[field] = Match.OneOf(String, Match.Integer, Boolean);\n\t\t}\n\t});\n\n\tcheck(departmentData, defaultValidations);\n\tcheck(\n\t\tdepartmentAgents,\n\t\tMatch.Maybe({\n\t\t\tupsert: Match.Maybe(Array),\n\t\t\tremove: Match.Maybe(Array),\n\t\t}),\n\t);\n\n\tconst { requestTagBeforeClosingChat, chatClosingTags, fallbackForwardDepartment } = departmentData;\n\tif (requestTagBeforeClosingChat && (!chatClosingTags || chatClosingTags.length === 0)) {\n\t\tthrow new Meteor.Error(\n\t\t\t'error-validating-department-chat-closing-tags',\n\t\t\t'At least one closing tag is required when the department requires tag(s) on closing conversations.',\n\t\t\t{ method: 'livechat:saveDepartment' },\n\t\t);\n\t}\n\n\tif (_id && !department) {\n\t\tthrow new Meteor.Error('error-department-not-found', 'Department not found', {\n\t\t\tmethod: 'livechat:saveDepartment',\n\t\t});\n\t}\n\n\tif (fallbackForwardDepartment === _id) {\n\t\tthrow new Meteor.Error(\n\t\t\t'error-fallback-department-circular',\n\t\t\t'Cannot save department. Circular reference between fallback department and department',\n\t\t);\n\t}\n\n\tif (fallbackForwardDepartment) {\n\t\tconst fallbackDep = await LivechatDepartment.findOneById(fallbackForwardDepartment, {\n\t\t\tprojection: { _id: 1, fallbackForwardDepartment: 1 },\n\t\t});\n\t\tif (!fallbackDep) {\n\t\t\tthrow new Meteor.Error('error-fallback-department-not-found', 'Fallback department not found', {\n\t\t\t\tmethod: 'livechat:saveDepartment',\n\t\t\t});\n\t\t}\n\t}\n\n\tconst departmentDB = await LivechatDepartment.createOrUpdateDepartment(_id, departmentData);\n\tif (departmentDB && departmentAgents) {\n\t\tawait updateDepartmentAgents(departmentDB._id, departmentAgents, departmentDB.enabled);\n\t}\n\n\t// Disable event\n\tif (department?.enabled && !departmentDB?.enabled) {\n\t\tawait callbacks.run('livechat.afterDepartmentDisabled', departmentDB);\n\t}\n\n\tif (departmentUnit) {\n\t\tawait callbacks.run('livechat.manageDepartmentUnit', { userId, departmentId: departmentDB._id, unitId: departmentUnit._id });\n\t}\n\n\treturn departmentDB;\n}\n\nexport async function archiveDepartment(_id: string) {\n\tconst department = await LivechatDepartment.findOneById<Pick<ILivechatDepartment, '_id' | 'businessHourId'>>(_id, {\n\t\tprojection: { _id: 1, businessHourId: 1 },\n\t});\n\n\tif (!department) {\n\t\tthrow new Error('department-not-found');\n\t}\n\n\tawait Promise.all([LivechatDepartmentAgents.disableAgentsByDepartmentId(_id), LivechatDepartment.archiveDepartment(_id)]);\n\n\tvoid notifyOnLivechatDepartmentAgentChangedByDepartmentId(_id);\n\n\tawait callbacks.run('livechat.afterDepartmentArchived', department);\n}\n\nexport async function unarchiveDepartment(_id: string) {\n\tconst department = await LivechatDepartment.findOneById(_id, { projection: { _id: 1 } });\n\n\tif (!department) {\n\t\tthrow new Meteor.Error('department-not-found');\n\t}\n\n\t// TODO: these kind of actions should be on events instead of here\n\tawait Promise.all([LivechatDepartmentAgents.enableAgentsByDepartmentId(_id), LivechatDepartment.unarchiveDepartment(_id)]);\n\n\tvoid notifyOnLivechatDepartmentAgentChangedByDepartmentId(_id);\n\n\treturn true;\n}\n\nexport async function saveDepartmentAgents(\n\t_id: string,\n\tdepartmentAgents: {\n\t\tupsert?: Pick<ILivechatDepartmentAgents, 'agentId' | 'count' | 'order' | 'username'>[];\n\t\tremove?: Pick<ILivechatDepartmentAgents, 'agentId'>[];\n\t},\n) {\n\tcheck(_id, String);\n\tcheck(departmentAgents, {\n\t\tupsert: Match.Maybe([\n\t\t\tMatch.ObjectIncluding({\n\t\t\t\tagentId: String,\n\t\t\t\tusername: String,\n\t\t\t\tcount: Match.Maybe(Match.Integer),\n\t\t\t\torder: Match.Maybe(Match.Integer),\n\t\t\t}),\n\t\t]),\n\t\tremove: Match.Maybe([\n\t\t\tMatch.ObjectIncluding({\n\t\t\t\tagentId: String,\n\t\t\t\tusername: Match.Maybe(String),\n\t\t\t\tcount: Match.Maybe(Match.Integer),\n\t\t\t\torder: Match.Maybe(Match.Integer),\n\t\t\t}),\n\t\t]),\n\t});\n\n\tconst department = await LivechatDepartment.findOneById<Pick<ILivechatDepartment, 'enabled'>>(_id, { projection: { enabled: 1 } });\n\tif (!department) {\n\t\tthrow new Meteor.Error('error-department-not-found', 'Department not found');\n\t}\n\n\treturn updateDepartmentAgents(_id, departmentAgents, department.enabled);\n}\n\nexport async function setDepartmentForGuest({ token, department }: { token: string; department: string }) {\n\tcheck(token, String);\n\tcheck(department, String);\n\n\tlivechatLogger.debug(`Switching departments for user with token ${token} (to ${department})`);\n\n\tconst updateUser = {\n\t\t$set: {\n\t\t\tdepartment,\n\t\t},\n\t};\n\n\tconst dep = await LivechatDepartment.findOneById<Pick<ILivechatDepartment, '_id'>>(department, { projection: { _id: 1 } });\n\tif (!dep) {\n\t\tthrow new Meteor.Error('invalid-department', 'Provided department does not exists');\n\t}\n\n\tconst visitor = await LivechatVisitors.getVisitorByToken(token, { projection: { _id: 1 } });\n\tif (!visitor) {\n\t\tthrow new Meteor.Error('invalid-token', 'Provided token is invalid');\n\t}\n\tawait LivechatVisitors.updateById(visitor._id, updateUser);\n}\n\nexport async function removeDepartment(departmentId: string) {\n\tlivechatLogger.debug(`Removing department: ${departmentId}`);\n\n\tconst department = await LivechatDepartment.findOneById<Pick<ILivechatDepartment, '_id' | 'businessHourId'>>(departmentId, {\n\t\tprojection: { _id: 1, businessHourId: 1 },\n\t});\n\tif (!department) {\n\t\tthrow new Error('error-department-not-found');\n\t}\n\n\tconst { _id } = department;\n\n\tconst ret = await LivechatDepartment.removeById(_id);\n\tif (ret.acknowledged !== true) {\n\t\tthrow new Error('error-failed-to-delete-department');\n\t}\n\n\tconst removedAgents = await LivechatDepartmentAgents.findByDepartmentId(department._id, { projection: { agentId: 1 } }).toArray();\n\n\tlivechatLogger.debug(\n\t\t`Performing post-department-removal actions: ${_id}. Removing department agents, unsetting fallback department and removing department from rooms`,\n\t);\n\n\tconst removeByDept = LivechatDepartmentAgents.removeByDepartmentId(_id);\n\n\tconst promiseResponses = await Promise.allSettled([\n\t\tremoveByDept,\n\t\tLivechatDepartment.unsetFallbackDepartmentByDepartmentId(_id),\n\t\tLivechatRooms.bulkRemoveDepartmentAndUnitsFromRooms(_id),\n\t]);\n\n\tpromiseResponses.forEach((response, index) => {\n\t\tif (response.status === 'rejected') {\n\t\t\tlivechatLogger.error(`Error while performing post-department-removal actions: ${_id}. Action No: ${index}. Error:`, response.reason);\n\t\t}\n\t});\n\n\tconst { deletedCount } = await removeByDept;\n\n\tif (deletedCount > 0) {\n\t\tremovedAgents.forEach(({ _id: docId, agentId }) => {\n\t\t\tvoid notifyOnLivechatDepartmentAgentChanged(\n\t\t\t\t{\n\t\t\t\t\t_id: docId,\n\t\t\t\t\tagentId,\n\t\t\t\t\tdepartmentId: _id,\n\t\t\t\t},\n\t\t\t\t'removed',\n\t\t\t);\n\t\t});\n\t}\n\n\tawait callbacks.run('livechat.afterRemoveDepartment', { department, agentsIds: removedAgents.map(({ agentId }) => agentId) });\n\n\treturn ret;\n}\n\nexport async function getRequiredDepartment(onlineRequired = true) {\n\tconst departments = LivechatDepartment.findEnabledWithAgents();\n\n\tfor await (const dept of departments) {\n\t\tif (!dept.showOnRegistration) {\n\t\t\tcontinue;\n\t\t}\n\t\tif (!onlineRequired) {\n\t\t\treturn dept;\n\t\t}\n\n\t\tconst onlineAgents = await LivechatDepartmentAgents.countOnlineForDepartment(dept._id);\n\t\tif (onlineAgents) {\n\t\t\treturn dept;\n\t\t}\n\t}\n}\n"]},"targets":{"android":"125.0.0","chrome":"125.0.0","edge":"125.0.0","firefox":"115.0.0","ie":"10.0.0","ios":"17.4.0","opera":"110.0.0","opera_mobile":"80.0.0","safari":"17.4.0","samsung":"24.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor","root":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":false,"enforceStrictMode":false,"dynamicImport":true,"generateLetDeclarations":true,"topLevelAwait":true},"externalDependencies":[]},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"version":"7.17.2","helpers":true,"useESModules":false,"corejs":false},"externalDependencies":[]},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-async-generator-functions","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-class-properties","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true},"externalDependencies":[]},{"key":"transform-react-jsx","visitor":{"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXFragment":{"exit":[null]},"JSXElement":{"exit":[null]},"JSXAttribute":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false},"externalDependencies":[]},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-nullish-coalescing-operator","visitor":{"LogicalExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-optional-chaining","visitor":{"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-optional-catch-binding","visitor":{"CatchClause":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-class-properties","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-async-generator-functions","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-logical-assignment-operators","visitor":{"AssignmentExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]}],"presets":[],"generatorOpts":{"filename":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/app/livechat/server/lib/departmentsLib.ts","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"app/livechat/server/lib/departmentsLib.ts","inputSourceMap":{"version":3,"file":"app/livechat/server/lib/departmentsLib.ts","sourceRoot":"","sources":["app/livechat/server/lib/departmentsLib.ts"],"names":[],"mappings":"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","sourcesContent":["import type { LivechatDepartmentDTO, ILivechatDepartment, ILivechatDepartmentAgents } from '@rocket.chat/core-typings';\nimport { LivechatDepartment, LivechatDepartmentAgents, LivechatVisitors, LivechatRooms } from '@rocket.chat/models';\nimport { Meteor } from 'meteor/meteor';\n\nimport { callbacks } from '../../../../lib/callbacks';\nimport {\n\tnotifyOnLivechatDepartmentAgentChangedByDepartmentId,\n\tnotifyOnLivechatDepartmentAgentChanged,\n} from '../../../lib/server/lib/notifyListener';\nimport { updateDepartmentAgents } from './Helper';\nimport { isDepartmentCreationAvailable } from './isDepartmentCreationAvailable';\nimport { livechatLogger } from './logger';\n/**\n * @param {string|null} _id - The department id\n * @param {Partial<import('@rocket.chat/core-typings').ILivechatDepartment>} departmentData\n * @param {{upsert?: { agentId: string; count?: number; order?: number; }[], remove?: { agentId: string; count?: number; order?: number; }}} [departmentAgents] - The department agents\n * @param {{_id?: string}} [departmentUnit] - The department's unit id\n */\nexport async function saveDepartment(\n\tuserId: string,\n\t_id: string | null,\n\tdepartmentData: LivechatDepartmentDTO,\n\tdepartmentAgents?: {\n\t\tupsert?: { agentId: string; count?: number; order?: number }[];\n\t\tremove?: { agentId: string; count?: number; order?: number };\n\t},\n\tdepartmentUnit?: { _id?: string },\n) {\n\tcheck(_id, Match.Maybe(String));\n\tif (departmentUnit?._id !== undefined && typeof departmentUnit._id !== 'string') {\n\t\tthrow new Meteor.Error('error-invalid-department-unit', 'Invalid department unit id provided', {\n\t\t\tmethod: 'livechat:saveDepartment',\n\t\t});\n\t}\n\n\tconst department = _id\n\t\t? await LivechatDepartment.findOneById(_id, { projection: { _id: 1, archived: 1, enabled: 1, parentId: 1 } })\n\t\t: null;\n\n\tif (departmentUnit && !departmentUnit._id && department && department.parentId) {\n\t\tconst isLastDepartmentInUnit = (await LivechatDepartment.countDepartmentsInUnit(department.parentId)) === 1;\n\t\tif (isLastDepartmentInUnit) {\n\t\t\tthrow new Meteor.Error('error-unit-cant-be-empty', \"The last department in a unit can't be removed\", {\n\t\t\t\tmethod: 'livechat:saveDepartment',\n\t\t\t});\n\t\t}\n\t}\n\n\tif (!department && !(await isDepartmentCreationAvailable())) {\n\t\tthrow new Meteor.Error('error-max-departments-number-reached', 'Maximum number of departments reached', {\n\t\t\tmethod: 'livechat:saveDepartment',\n\t\t});\n\t}\n\n\tif (department?.archived && departmentData.enabled) {\n\t\tthrow new Meteor.Error('error-archived-department-cant-be-enabled', 'Archived departments cant be enabled', {\n\t\t\tmethod: 'livechat:saveDepartment',\n\t\t});\n\t}\n\n\tconst defaultValidations: Record<string, Match.Matcher<any> | BooleanConstructor | StringConstructor> = {\n\t\tenabled: Boolean,\n\t\tname: String,\n\t\tdescription: Match.Optional(String),\n\t\tshowOnRegistration: Boolean,\n\t\temail: String,\n\t\tshowOnOfflineForm: Boolean,\n\t\trequestTagBeforeClosingChat: Match.Optional(Boolean),\n\t\tchatClosingTags: Match.Optional([String]),\n\t\tfallbackForwardDepartment: Match.Optional(String),\n\t\tdepartmentsAllowedToForward: Match.Optional([String]),\n\t\tallowReceiveForwardOffline: Match.Optional(Boolean),\n\t};\n\n\t// The Livechat Form department support addition/custom fields, so those fields need to be added before validating\n\tObject.keys(departmentData).forEach((field) => {\n\t\tif (!defaultValidations.hasOwnProperty(field)) {\n\t\t\tdefaultValidations[field] = Match.OneOf(String, Match.Integer, Boolean);\n\t\t}\n\t});\n\n\tcheck(departmentData, defaultValidations);\n\tcheck(\n\t\tdepartmentAgents,\n\t\tMatch.Maybe({\n\t\t\tupsert: Match.Maybe(Array),\n\t\t\tremove: Match.Maybe(Array),\n\t\t}),\n\t);\n\n\tconst { requestTagBeforeClosingChat, chatClosingTags, fallbackForwardDepartment } = departmentData;\n\tif (requestTagBeforeClosingChat && (!chatClosingTags || chatClosingTags.length === 0)) {\n\t\tthrow new Meteor.Error(\n\t\t\t'error-validating-department-chat-closing-tags',\n\t\t\t'At least one closing tag is required when the department requires tag(s) on closing conversations.',\n\t\t\t{ method: 'livechat:saveDepartment' },\n\t\t);\n\t}\n\n\tif (_id && !department) {\n\t\tthrow new Meteor.Error('error-department-not-found', 'Department not found', {\n\t\t\tmethod: 'livechat:saveDepartment',\n\t\t});\n\t}\n\n\tif (fallbackForwardDepartment === _id) {\n\t\tthrow new Meteor.Error(\n\t\t\t'error-fallback-department-circular',\n\t\t\t'Cannot save department. Circular reference between fallback department and department',\n\t\t);\n\t}\n\n\tif (fallbackForwardDepartment) {\n\t\tconst fallbackDep = await LivechatDepartment.findOneById(fallbackForwardDepartment, {\n\t\t\tprojection: { _id: 1, fallbackForwardDepartment: 1 },\n\t\t});\n\t\tif (!fallbackDep) {\n\t\t\tthrow new Meteor.Error('error-fallback-department-not-found', 'Fallback department not found', {\n\t\t\t\tmethod: 'livechat:saveDepartment',\n\t\t\t});\n\t\t}\n\t}\n\n\tconst departmentDB = await LivechatDepartment.createOrUpdateDepartment(_id, departmentData);\n\tif (departmentDB && departmentAgents) {\n\t\tawait updateDepartmentAgents(departmentDB._id, departmentAgents, departmentDB.enabled);\n\t}\n\n\t// Disable event\n\tif (department?.enabled && !departmentDB?.enabled) {\n\t\tawait callbacks.run('livechat.afterDepartmentDisabled', departmentDB);\n\t}\n\n\tif (departmentUnit) {\n\t\tawait callbacks.run('livechat.manageDepartmentUnit', { userId, departmentId: departmentDB._id, unitId: departmentUnit._id });\n\t}\n\n\treturn departmentDB;\n}\n\nexport async function archiveDepartment(_id: string) {\n\tconst department = await LivechatDepartment.findOneById<Pick<ILivechatDepartment, '_id' | 'businessHourId'>>(_id, {\n\t\tprojection: { _id: 1, businessHourId: 1 },\n\t});\n\n\tif (!department) {\n\t\tthrow new Error('department-not-found');\n\t}\n\n\tawait Promise.all([LivechatDepartmentAgents.disableAgentsByDepartmentId(_id), LivechatDepartment.archiveDepartment(_id)]);\n\n\tvoid notifyOnLivechatDepartmentAgentChangedByDepartmentId(_id);\n\n\tawait callbacks.run('livechat.afterDepartmentArchived', department);\n}\n\nexport async function unarchiveDepartment(_id: string) {\n\tconst department = await LivechatDepartment.findOneById(_id, { projection: { _id: 1 } });\n\n\tif (!department) {\n\t\tthrow new Meteor.Error('department-not-found');\n\t}\n\n\t// TODO: these kind of actions should be on events instead of here\n\tawait Promise.all([LivechatDepartmentAgents.enableAgentsByDepartmentId(_id), LivechatDepartment.unarchiveDepartment(_id)]);\n\n\tvoid notifyOnLivechatDepartmentAgentChangedByDepartmentId(_id);\n\n\treturn true;\n}\n\nexport async function saveDepartmentAgents(\n\t_id: string,\n\tdepartmentAgents: {\n\t\tupsert?: Pick<ILivechatDepartmentAgents, 'agentId' | 'count' | 'order' | 'username'>[];\n\t\tremove?: Pick<ILivechatDepartmentAgents, 'agentId'>[];\n\t},\n) {\n\tcheck(_id, String);\n\tcheck(departmentAgents, {\n\t\tupsert: Match.Maybe([\n\t\t\tMatch.ObjectIncluding({\n\t\t\t\tagentId: String,\n\t\t\t\tusername: String,\n\t\t\t\tcount: Match.Maybe(Match.Integer),\n\t\t\t\torder: Match.Maybe(Match.Integer),\n\t\t\t}),\n\t\t]),\n\t\tremove: Match.Maybe([\n\t\t\tMatch.ObjectIncluding({\n\t\t\t\tagentId: String,\n\t\t\t\tusername: Match.Maybe(String),\n\t\t\t\tcount: Match.Maybe(Match.Integer),\n\t\t\t\torder: Match.Maybe(Match.Integer),\n\t\t\t}),\n\t\t]),\n\t});\n\n\tconst department = await LivechatDepartment.findOneById<Pick<ILivechatDepartment, 'enabled'>>(_id, { projection: { enabled: 1 } });\n\tif (!department) {\n\t\tthrow new Meteor.Error('error-department-not-found', 'Department not found');\n\t}\n\n\treturn updateDepartmentAgents(_id, departmentAgents, department.enabled);\n}\n\nexport async function setDepartmentForGuest({ token, department }: { token: string; department: string }) {\n\tcheck(token, String);\n\tcheck(department, String);\n\n\tlivechatLogger.debug(`Switching departments for user with token ${token} (to ${department})`);\n\n\tconst updateUser = {\n\t\t$set: {\n\t\t\tdepartment,\n\t\t},\n\t};\n\n\tconst dep = await LivechatDepartment.findOneById<Pick<ILivechatDepartment, '_id'>>(department, { projection: { _id: 1 } });\n\tif (!dep) {\n\t\tthrow new Meteor.Error('invalid-department', 'Provided department does not exists');\n\t}\n\n\tconst visitor = await LivechatVisitors.getVisitorByToken(token, { projection: { _id: 1 } });\n\tif (!visitor) {\n\t\tthrow new Meteor.Error('invalid-token', 'Provided token is invalid');\n\t}\n\tawait LivechatVisitors.updateById(visitor._id, updateUser);\n}\n\nexport async function removeDepartment(departmentId: string) {\n\tlivechatLogger.debug(`Removing department: ${departmentId}`);\n\n\tconst department = await LivechatDepartment.findOneById<Pick<ILivechatDepartment, '_id' | 'businessHourId'>>(departmentId, {\n\t\tprojection: { _id: 1, businessHourId: 1 },\n\t});\n\tif (!department) {\n\t\tthrow new Error('error-department-not-found');\n\t}\n\n\tconst { _id } = department;\n\n\tconst ret = await LivechatDepartment.removeById(_id);\n\tif (ret.acknowledged !== true) {\n\t\tthrow new Error('error-failed-to-delete-department');\n\t}\n\n\tconst removedAgents = await LivechatDepartmentAgents.findByDepartmentId(department._id, { projection: { agentId: 1 } }).toArray();\n\n\tlivechatLogger.debug(\n\t\t`Performing post-department-removal actions: ${_id}. Removing department agents, unsetting fallback department and removing department from rooms`,\n\t);\n\n\tconst removeByDept = LivechatDepartmentAgents.removeByDepartmentId(_id);\n\n\tconst promiseResponses = await Promise.allSettled([\n\t\tremoveByDept,\n\t\tLivechatDepartment.unsetFallbackDepartmentByDepartmentId(_id),\n\t\tLivechatRooms.bulkRemoveDepartmentAndUnitsFromRooms(_id),\n\t]);\n\n\tpromiseResponses.forEach((response, index) => {\n\t\tif (response.status === 'rejected') {\n\t\t\tlivechatLogger.error(`Error while performing post-department-removal actions: ${_id}. Action No: ${index}. Error:`, response.reason);\n\t\t}\n\t});\n\n\tconst { deletedCount } = await removeByDept;\n\n\tif (deletedCount > 0) {\n\t\tremovedAgents.forEach(({ _id: docId, agentId }) => {\n\t\t\tvoid notifyOnLivechatDepartmentAgentChanged(\n\t\t\t\t{\n\t\t\t\t\t_id: docId,\n\t\t\t\t\tagentId,\n\t\t\t\t\tdepartmentId: _id,\n\t\t\t\t},\n\t\t\t\t'removed',\n\t\t\t);\n\t\t});\n\t}\n\n\tawait callbacks.run('livechat.afterRemoveDepartment', { department, agentsIds: removedAgents.map(({ agentId }) => agentId) });\n\n\treturn ret;\n}\n\nexport async function getRequiredDepartment(onlineRequired = true) {\n\tconst departments = LivechatDepartment.findEnabledWithAgents();\n\n\tfor await (const dept of departments) {\n\t\tif (!dept.showOnRegistration) {\n\t\t\tcontinue;\n\t\t}\n\t\tif (!onlineRequired) {\n\t\t\treturn dept;\n\t\t}\n\n\t\tconst onlineAgents = await LivechatDepartmentAgents.countOnlineForDepartment(dept._id);\n\t\tif (onlineAgents) {\n\t\t\treturn dept;\n\t\t}\n\t}\n}\n"]}}},"code":"!module.wrapAsync(async function (module, __reifyWaitForDeps__, __reify_async_result__) {\n  \"use strict\";\n  try {\n    let _asyncIterator;\n    module.link(\"@babel/runtime/helpers/asyncIterator\", {\n      default(v) {\n        _asyncIterator = v;\n      }\n    }, 0);\n    module.export({\n      saveDepartment: () => saveDepartment,\n      archiveDepartment: () => archiveDepartment,\n      unarchiveDepartment: () => unarchiveDepartment,\n      saveDepartmentAgents: () => saveDepartmentAgents,\n      setDepartmentForGuest: () => setDepartmentForGuest,\n      removeDepartment: () => removeDepartment,\n      getRequiredDepartment: () => getRequiredDepartment\n    });\n    let LivechatDepartment, LivechatDepartmentAgents, LivechatVisitors, LivechatRooms;\n    module.link(\"@rocket.chat/models\", {\n      LivechatDepartment(v) {\n        LivechatDepartment = v;\n      },\n      LivechatDepartmentAgents(v) {\n        LivechatDepartmentAgents = v;\n      },\n      LivechatVisitors(v) {\n        LivechatVisitors = v;\n      },\n      LivechatRooms(v) {\n        LivechatRooms = v;\n      }\n    }, 0);\n    let Meteor;\n    module.link(\"meteor/meteor\", {\n      Meteor(v) {\n        Meteor = v;\n      }\n    }, 1);\n    let callbacks;\n    module.link(\"../../../../lib/callbacks\", {\n      callbacks(v) {\n        callbacks = v;\n      }\n    }, 2);\n    let notifyOnLivechatDepartmentAgentChangedByDepartmentId, notifyOnLivechatDepartmentAgentChanged;\n    module.link(\"../../../lib/server/lib/notifyListener\", {\n      notifyOnLivechatDepartmentAgentChangedByDepartmentId(v) {\n        notifyOnLivechatDepartmentAgentChangedByDepartmentId = v;\n      },\n      notifyOnLivechatDepartmentAgentChanged(v) {\n        notifyOnLivechatDepartmentAgentChanged = v;\n      }\n    }, 3);\n    let updateDepartmentAgents;\n    module.link(\"./Helper\", {\n      updateDepartmentAgents(v) {\n        updateDepartmentAgents = v;\n      }\n    }, 4);\n    let isDepartmentCreationAvailable;\n    module.link(\"./isDepartmentCreationAvailable\", {\n      isDepartmentCreationAvailable(v) {\n        isDepartmentCreationAvailable = v;\n      }\n    }, 5);\n    let livechatLogger;\n    module.link(\"./logger\", {\n      livechatLogger(v) {\n        livechatLogger = v;\n      }\n    }, 6);\n    if (__reifyWaitForDeps__()) (await __reifyWaitForDeps__())();\n    async function saveDepartment(userId, _id, departmentData, departmentAgents, departmentUnit) {\n      check(_id, Match.Maybe(String));\n      if ((departmentUnit === null || departmentUnit === void 0 ? void 0 : departmentUnit._id) !== undefined && typeof departmentUnit._id !== 'string') {\n        throw new Meteor.Error('error-invalid-department-unit', 'Invalid department unit id provided', {\n          method: 'livechat:saveDepartment'\n        });\n      }\n      const department = _id ? await LivechatDepartment.findOneById(_id, {\n        projection: {\n          _id: 1,\n          archived: 1,\n          enabled: 1,\n          parentId: 1\n        }\n      }) : null;\n      if (departmentUnit && !departmentUnit._id && department && department.parentId) {\n        const isLastDepartmentInUnit = (await LivechatDepartment.countDepartmentsInUnit(department.parentId)) === 1;\n        if (isLastDepartmentInUnit) {\n          throw new Meteor.Error('error-unit-cant-be-empty', \"The last department in a unit can't be removed\", {\n            method: 'livechat:saveDepartment'\n          });\n        }\n      }\n      if (!department && !(await isDepartmentCreationAvailable())) {\n        throw new Meteor.Error('error-max-departments-number-reached', 'Maximum number of departments reached', {\n          method: 'livechat:saveDepartment'\n        });\n      }\n      if (department !== null && department !== void 0 && department.archived && departmentData.enabled) {\n        throw new Meteor.Error('error-archived-department-cant-be-enabled', 'Archived departments cant be enabled', {\n          method: 'livechat:saveDepartment'\n        });\n      }\n      const defaultValidations = {\n        enabled: Boolean,\n        name: String,\n        description: Match.Optional(String),\n        showOnRegistration: Boolean,\n        email: String,\n        showOnOfflineForm: Boolean,\n        requestTagBeforeClosingChat: Match.Optional(Boolean),\n        chatClosingTags: Match.Optional([String]),\n        fallbackForwardDepartment: Match.Optional(String),\n        departmentsAllowedToForward: Match.Optional([String]),\n        allowReceiveForwardOffline: Match.Optional(Boolean)\n      };\n      // The Livechat Form department support addition/custom fields, so those fields need to be added before validating\n      Object.keys(departmentData).forEach(field => {\n        if (!defaultValidations.hasOwnProperty(field)) {\n          defaultValidations[field] = Match.OneOf(String, Match.Integer, Boolean);\n        }\n      });\n      check(departmentData, defaultValidations);\n      check(departmentAgents, Match.Maybe({\n        upsert: Match.Maybe(Array),\n        remove: Match.Maybe(Array)\n      }));\n      const {\n        requestTagBeforeClosingChat,\n        chatClosingTags,\n        fallbackForwardDepartment\n      } = departmentData;\n      if (requestTagBeforeClosingChat && (!chatClosingTags || chatClosingTags.length === 0)) {\n        throw new Meteor.Error('error-validating-department-chat-closing-tags', 'At least one closing tag is required when the department requires tag(s) on closing conversations.', {\n          method: 'livechat:saveDepartment'\n        });\n      }\n      if (_id && !department) {\n        throw new Meteor.Error('error-department-not-found', 'Department not found', {\n          method: 'livechat:saveDepartment'\n        });\n      }\n      if (fallbackForwardDepartment === _id) {\n        throw new Meteor.Error('error-fallback-department-circular', 'Cannot save department. Circular reference between fallback department and department');\n      }\n      if (fallbackForwardDepartment) {\n        const fallbackDep = await LivechatDepartment.findOneById(fallbackForwardDepartment, {\n          projection: {\n            _id: 1,\n            fallbackForwardDepartment: 1\n          }\n        });\n        if (!fallbackDep) {\n          throw new Meteor.Error('error-fallback-department-not-found', 'Fallback department not found', {\n            method: 'livechat:saveDepartment'\n          });\n        }\n      }\n      const departmentDB = await LivechatDepartment.createOrUpdateDepartment(_id, departmentData);\n      if (departmentDB && departmentAgents) {\n        await updateDepartmentAgents(departmentDB._id, departmentAgents, departmentDB.enabled);\n      }\n      // Disable event\n      if (department !== null && department !== void 0 && department.enabled && !(departmentDB !== null && departmentDB !== void 0 && departmentDB.enabled)) {\n        await callbacks.run('livechat.afterDepartmentDisabled', departmentDB);\n      }\n      if (departmentUnit) {\n        await callbacks.run('livechat.manageDepartmentUnit', {\n          userId,\n          departmentId: departmentDB._id,\n          unitId: departmentUnit._id\n        });\n      }\n      return departmentDB;\n    }\n    async function archiveDepartment(_id) {\n      const department = await LivechatDepartment.findOneById(_id, {\n        projection: {\n          _id: 1,\n          businessHourId: 1\n        }\n      });\n      if (!department) {\n        throw new Error('department-not-found');\n      }\n      await Promise.all([LivechatDepartmentAgents.disableAgentsByDepartmentId(_id), LivechatDepartment.archiveDepartment(_id)]);\n      void notifyOnLivechatDepartmentAgentChangedByDepartmentId(_id);\n      await callbacks.run('livechat.afterDepartmentArchived', department);\n    }\n    async function unarchiveDepartment(_id) {\n      const department = await LivechatDepartment.findOneById(_id, {\n        projection: {\n          _id: 1\n        }\n      });\n      if (!department) {\n        throw new Meteor.Error('department-not-found');\n      }\n      // TODO: these kind of actions should be on events instead of here\n      await Promise.all([LivechatDepartmentAgents.enableAgentsByDepartmentId(_id), LivechatDepartment.unarchiveDepartment(_id)]);\n      void notifyOnLivechatDepartmentAgentChangedByDepartmentId(_id);\n      return true;\n    }\n    async function saveDepartmentAgents(_id, departmentAgents) {\n      check(_id, String);\n      check(departmentAgents, {\n        upsert: Match.Maybe([Match.ObjectIncluding({\n          agentId: String,\n          username: String,\n          count: Match.Maybe(Match.Integer),\n          order: Match.Maybe(Match.Integer)\n        })]),\n        remove: Match.Maybe([Match.ObjectIncluding({\n          agentId: String,\n          username: Match.Maybe(String),\n          count: Match.Maybe(Match.Integer),\n          order: Match.Maybe(Match.Integer)\n        })])\n      });\n      const department = await LivechatDepartment.findOneById(_id, {\n        projection: {\n          enabled: 1\n        }\n      });\n      if (!department) {\n        throw new Meteor.Error('error-department-not-found', 'Department not found');\n      }\n      return updateDepartmentAgents(_id, departmentAgents, department.enabled);\n    }\n    async function setDepartmentForGuest(_ref) {\n      let {\n        token,\n        department\n      } = _ref;\n      check(token, String);\n      check(department, String);\n      livechatLogger.debug(\"Switching departments for user with token \".concat(token, \" (to \").concat(department, \")\"));\n      const updateUser = {\n        $set: {\n          department\n        }\n      };\n      const dep = await LivechatDepartment.findOneById(department, {\n        projection: {\n          _id: 1\n        }\n      });\n      if (!dep) {\n        throw new Meteor.Error('invalid-department', 'Provided department does not exists');\n      }\n      const visitor = await LivechatVisitors.getVisitorByToken(token, {\n        projection: {\n          _id: 1\n        }\n      });\n      if (!visitor) {\n        throw new Meteor.Error('invalid-token', 'Provided token is invalid');\n      }\n      await LivechatVisitors.updateById(visitor._id, updateUser);\n    }\n    async function removeDepartment(departmentId) {\n      livechatLogger.debug(\"Removing department: \".concat(departmentId));\n      const department = await LivechatDepartment.findOneById(departmentId, {\n        projection: {\n          _id: 1,\n          businessHourId: 1\n        }\n      });\n      if (!department) {\n        throw new Error('error-department-not-found');\n      }\n      const {\n        _id\n      } = department;\n      const ret = await LivechatDepartment.removeById(_id);\n      if (ret.acknowledged !== true) {\n        throw new Error('error-failed-to-delete-department');\n      }\n      const removedAgents = await LivechatDepartmentAgents.findByDepartmentId(department._id, {\n        projection: {\n          agentId: 1\n        }\n      }).toArray();\n      livechatLogger.debug(\"Performing post-department-removal actions: \".concat(_id, \". Removing department agents, unsetting fallback department and removing department from rooms\"));\n      const removeByDept = LivechatDepartmentAgents.removeByDepartmentId(_id);\n      const promiseResponses = await Promise.allSettled([removeByDept, LivechatDepartment.unsetFallbackDepartmentByDepartmentId(_id), LivechatRooms.bulkRemoveDepartmentAndUnitsFromRooms(_id)]);\n      promiseResponses.forEach((response, index) => {\n        if (response.status === 'rejected') {\n          livechatLogger.error(\"Error while performing post-department-removal actions: \".concat(_id, \". Action No: \").concat(index, \". Error:\"), response.reason);\n        }\n      });\n      const {\n        deletedCount\n      } = await removeByDept;\n      if (deletedCount > 0) {\n        removedAgents.forEach(_ref2 => {\n          let {\n            _id: docId,\n            agentId\n          } = _ref2;\n          void notifyOnLivechatDepartmentAgentChanged({\n            _id: docId,\n            agentId,\n            departmentId: _id\n          }, 'removed');\n        });\n      }\n      await callbacks.run('livechat.afterRemoveDepartment', {\n        department,\n        agentsIds: removedAgents.map(_ref3 => {\n          let {\n            agentId\n          } = _ref3;\n          return agentId;\n        })\n      });\n      return ret;\n    }\n    async function getRequiredDepartment() {\n      let onlineRequired = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : true;\n      const departments = LivechatDepartment.findEnabledWithAgents();\n      var _iteratorAbruptCompletion = false;\n      var _didIteratorError = false;\n      var _iteratorError;\n      try {\n        for (var _iterator = _asyncIterator(departments), _step; _iteratorAbruptCompletion = !(_step = await _iterator.next()).done; _iteratorAbruptCompletion = false) {\n          const dept = _step.value;\n          {\n            if (!dept.showOnRegistration) {\n              continue;\n            }\n            if (!onlineRequired) {\n              return dept;\n            }\n            const onlineAgents = await LivechatDepartmentAgents.countOnlineForDepartment(dept._id);\n            if (onlineAgents) {\n              return dept;\n            }\n          }\n        }\n      } catch (err) {\n        _didIteratorError = true;\n        _iteratorError = err;\n      } finally {\n        try {\n          if (_iteratorAbruptCompletion && _iterator.return != null) {\n            await _iterator.return();\n          }\n        } finally {\n          if (_didIteratorError) {\n            throw _iteratorError;\n          }\n        }\n      }\n    }\n    __reify_async_result__();\n  } catch (_reifyError) {\n    return __reify_async_result__(_reifyError);\n  }\n  __reify_async_result__()\n}, {\n  self: this,\n  async: false\n});","map":{"version":3,"names":["_asyncIterator","module","link","default","v","export","saveDepartment","archiveDepartment","unarchiveDepartment","saveDepartmentAgents","setDepartmentForGuest","removeDepartment","getRequiredDepartment","LivechatDepartment","LivechatDepartmentAgents","LivechatVisitors","LivechatRooms","Meteor","callbacks","notifyOnLivechatDepartmentAgentChangedByDepartmentId","notifyOnLivechatDepartmentAgentChanged","updateDepartmentAgents","isDepartmentCreationAvailable","livechatLogger","__reifyWaitForDeps__","userId","_id","departmentData","departmentAgents","departmentUnit","check","Match","Maybe","String","undefined","Error","method","department","findOneById","projection","archived","enabled","parentId","isLastDepartmentInUnit","countDepartmentsInUnit","defaultValidations","Boolean","name","description","Optional","showOnRegistration","email","showOnOfflineForm","requestTagBeforeClosingChat","chatClosingTags","fallbackForwardDepartment","departmentsAllowedToForward","allowReceiveForwardOffline","Object","keys","forEach","field","hasOwnProperty","OneOf","Integer","upsert","Array","remove","length","fallbackDep","departmentDB","createOrUpdateDepartment","run","departmentId","unitId","businessHourId","Promise","all","disableAgentsByDepartmentId","enableAgentsByDepartmentId","ObjectIncluding","agentId","username","count","order","_ref","token","debug","concat","updateUser","$set","dep","visitor","getVisitorByToken","updateById","ret","removeById","acknowledged","removedAgents","findByDepartmentId","toArray","removeByDept","removeByDepartmentId","promiseResponses","allSettled","unsetFallbackDepartmentByDepartmentId","bulkRemoveDepartmentAndUnitsFromRooms","response","index","status","error","reason","deletedCount","_ref2","docId","agentsIds","map","_ref3","onlineRequired","arguments","departments","findEnabledWithAgents","_iteratorAbruptCompletion","_didIteratorError","_iteratorError","_iterator","_step","next","done","dept","value","onlineAgents","countOnlineForDepartment","err","return","__reify_async_result__","_reifyError","self","async"],"sources":["app/livechat/server/lib/departmentsLib.ts"],"sourcesContent":["import type { LivechatDepartmentDTO, ILivechatDepartment, ILivechatDepartmentAgents } from '@rocket.chat/core-typings';\nimport { LivechatDepartment, LivechatDepartmentAgents, LivechatVisitors, LivechatRooms } from '@rocket.chat/models';\nimport { Meteor } from 'meteor/meteor';\n\nimport { callbacks } from '../../../../lib/callbacks';\nimport {\n\tnotifyOnLivechatDepartmentAgentChangedByDepartmentId,\n\tnotifyOnLivechatDepartmentAgentChanged,\n} from '../../../lib/server/lib/notifyListener';\nimport { updateDepartmentAgents } from './Helper';\nimport { isDepartmentCreationAvailable } from './isDepartmentCreationAvailable';\nimport { livechatLogger } from './logger';\n/**\n * @param {string|null} _id - The department id\n * @param {Partial<import('@rocket.chat/core-typings').ILivechatDepartment>} departmentData\n * @param {{upsert?: { agentId: string; count?: number; order?: number; }[], remove?: { agentId: string; count?: number; order?: number; }}} [departmentAgents] - The department agents\n * @param {{_id?: string}} [departmentUnit] - The department's unit id\n */\nexport async function saveDepartment(\n\tuserId: string,\n\t_id: string | null,\n\tdepartmentData: LivechatDepartmentDTO,\n\tdepartmentAgents?: {\n\t\tupsert?: { agentId: string; count?: number; order?: number }[];\n\t\tremove?: { agentId: string; count?: number; order?: number };\n\t},\n\tdepartmentUnit?: { _id?: string },\n) {\n\tcheck(_id, Match.Maybe(String));\n\tif (departmentUnit?._id !== undefined && typeof departmentUnit._id !== 'string') {\n\t\tthrow new Meteor.Error('error-invalid-department-unit', 'Invalid department unit id provided', {\n\t\t\tmethod: 'livechat:saveDepartment',\n\t\t});\n\t}\n\n\tconst department = _id\n\t\t? await LivechatDepartment.findOneById(_id, { projection: { _id: 1, archived: 1, enabled: 1, parentId: 1 } })\n\t\t: null;\n\n\tif (departmentUnit && !departmentUnit._id && department && department.parentId) {\n\t\tconst isLastDepartmentInUnit = (await LivechatDepartment.countDepartmentsInUnit(department.parentId)) === 1;\n\t\tif (isLastDepartmentInUnit) {\n\t\t\tthrow new Meteor.Error('error-unit-cant-be-empty', \"The last department in a unit can't be removed\", {\n\t\t\t\tmethod: 'livechat:saveDepartment',\n\t\t\t});\n\t\t}\n\t}\n\n\tif (!department && !(await isDepartmentCreationAvailable())) {\n\t\tthrow new Meteor.Error('error-max-departments-number-reached', 'Maximum number of departments reached', {\n\t\t\tmethod: 'livechat:saveDepartment',\n\t\t});\n\t}\n\n\tif (department?.archived && departmentData.enabled) {\n\t\tthrow new Meteor.Error('error-archived-department-cant-be-enabled', 'Archived departments cant be enabled', {\n\t\t\tmethod: 'livechat:saveDepartment',\n\t\t});\n\t}\n\n\tconst defaultValidations: Record<string, Match.Matcher<any> | BooleanConstructor | StringConstructor> = {\n\t\tenabled: Boolean,\n\t\tname: String,\n\t\tdescription: Match.Optional(String),\n\t\tshowOnRegistration: Boolean,\n\t\temail: String,\n\t\tshowOnOfflineForm: Boolean,\n\t\trequestTagBeforeClosingChat: Match.Optional(Boolean),\n\t\tchatClosingTags: Match.Optional([String]),\n\t\tfallbackForwardDepartment: Match.Optional(String),\n\t\tdepartmentsAllowedToForward: Match.Optional([String]),\n\t\tallowReceiveForwardOffline: Match.Optional(Boolean),\n\t};\n\n\t// The Livechat Form department support addition/custom fields, so those fields need to be added before validating\n\tObject.keys(departmentData).forEach((field) => {\n\t\tif (!defaultValidations.hasOwnProperty(field)) {\n\t\t\tdefaultValidations[field] = Match.OneOf(String, Match.Integer, Boolean);\n\t\t}\n\t});\n\n\tcheck(departmentData, defaultValidations);\n\tcheck(\n\t\tdepartmentAgents,\n\t\tMatch.Maybe({\n\t\t\tupsert: Match.Maybe(Array),\n\t\t\tremove: Match.Maybe(Array),\n\t\t}),\n\t);\n\n\tconst { requestTagBeforeClosingChat, chatClosingTags, fallbackForwardDepartment } = departmentData;\n\tif (requestTagBeforeClosingChat && (!chatClosingTags || chatClosingTags.length === 0)) {\n\t\tthrow new Meteor.Error(\n\t\t\t'error-validating-department-chat-closing-tags',\n\t\t\t'At least one closing tag is required when the department requires tag(s) on closing conversations.',\n\t\t\t{ method: 'livechat:saveDepartment' },\n\t\t);\n\t}\n\n\tif (_id && !department) {\n\t\tthrow new Meteor.Error('error-department-not-found', 'Department not found', {\n\t\t\tmethod: 'livechat:saveDepartment',\n\t\t});\n\t}\n\n\tif (fallbackForwardDepartment === _id) {\n\t\tthrow new Meteor.Error(\n\t\t\t'error-fallback-department-circular',\n\t\t\t'Cannot save department. Circular reference between fallback department and department',\n\t\t);\n\t}\n\n\tif (fallbackForwardDepartment) {\n\t\tconst fallbackDep = await LivechatDepartment.findOneById(fallbackForwardDepartment, {\n\t\t\tprojection: { _id: 1, fallbackForwardDepartment: 1 },\n\t\t});\n\t\tif (!fallbackDep) {\n\t\t\tthrow new Meteor.Error('error-fallback-department-not-found', 'Fallback department not found', {\n\t\t\t\tmethod: 'livechat:saveDepartment',\n\t\t\t});\n\t\t}\n\t}\n\n\tconst departmentDB = await LivechatDepartment.createOrUpdateDepartment(_id, departmentData);\n\tif (departmentDB && departmentAgents) {\n\t\tawait updateDepartmentAgents(departmentDB._id, departmentAgents, departmentDB.enabled);\n\t}\n\n\t// Disable event\n\tif (department?.enabled && !departmentDB?.enabled) {\n\t\tawait callbacks.run('livechat.afterDepartmentDisabled', departmentDB);\n\t}\n\n\tif (departmentUnit) {\n\t\tawait callbacks.run('livechat.manageDepartmentUnit', { userId, departmentId: departmentDB._id, unitId: departmentUnit._id });\n\t}\n\n\treturn departmentDB;\n}\n\nexport async function archiveDepartment(_id: string) {\n\tconst department = await LivechatDepartment.findOneById<Pick<ILivechatDepartment, '_id' | 'businessHourId'>>(_id, {\n\t\tprojection: { _id: 1, businessHourId: 1 },\n\t});\n\n\tif (!department) {\n\t\tthrow new Error('department-not-found');\n\t}\n\n\tawait Promise.all([LivechatDepartmentAgents.disableAgentsByDepartmentId(_id), LivechatDepartment.archiveDepartment(_id)]);\n\n\tvoid notifyOnLivechatDepartmentAgentChangedByDepartmentId(_id);\n\n\tawait callbacks.run('livechat.afterDepartmentArchived', department);\n}\n\nexport async function unarchiveDepartment(_id: string) {\n\tconst department = await LivechatDepartment.findOneById(_id, { projection: { _id: 1 } });\n\n\tif (!department) {\n\t\tthrow new Meteor.Error('department-not-found');\n\t}\n\n\t// TODO: these kind of actions should be on events instead of here\n\tawait Promise.all([LivechatDepartmentAgents.enableAgentsByDepartmentId(_id), LivechatDepartment.unarchiveDepartment(_id)]);\n\n\tvoid notifyOnLivechatDepartmentAgentChangedByDepartmentId(_id);\n\n\treturn true;\n}\n\nexport async function saveDepartmentAgents(\n\t_id: string,\n\tdepartmentAgents: {\n\t\tupsert?: Pick<ILivechatDepartmentAgents, 'agentId' | 'count' | 'order' | 'username'>[];\n\t\tremove?: Pick<ILivechatDepartmentAgents, 'agentId'>[];\n\t},\n) {\n\tcheck(_id, String);\n\tcheck(departmentAgents, {\n\t\tupsert: Match.Maybe([\n\t\t\tMatch.ObjectIncluding({\n\t\t\t\tagentId: String,\n\t\t\t\tusername: String,\n\t\t\t\tcount: Match.Maybe(Match.Integer),\n\t\t\t\torder: Match.Maybe(Match.Integer),\n\t\t\t}),\n\t\t]),\n\t\tremove: Match.Maybe([\n\t\t\tMatch.ObjectIncluding({\n\t\t\t\tagentId: String,\n\t\t\t\tusername: Match.Maybe(String),\n\t\t\t\tcount: Match.Maybe(Match.Integer),\n\t\t\t\torder: Match.Maybe(Match.Integer),\n\t\t\t}),\n\t\t]),\n\t});\n\n\tconst department = await LivechatDepartment.findOneById<Pick<ILivechatDepartment, 'enabled'>>(_id, { projection: { enabled: 1 } });\n\tif (!department) {\n\t\tthrow new Meteor.Error('error-department-not-found', 'Department not found');\n\t}\n\n\treturn updateDepartmentAgents(_id, departmentAgents, department.enabled);\n}\n\nexport async function setDepartmentForGuest({ token, department }: { token: string; department: string }) {\n\tcheck(token, String);\n\tcheck(department, String);\n\n\tlivechatLogger.debug(`Switching departments for user with token ${token} (to ${department})`);\n\n\tconst updateUser = {\n\t\t$set: {\n\t\t\tdepartment,\n\t\t},\n\t};\n\n\tconst dep = await LivechatDepartment.findOneById<Pick<ILivechatDepartment, '_id'>>(department, { projection: { _id: 1 } });\n\tif (!dep) {\n\t\tthrow new Meteor.Error('invalid-department', 'Provided department does not exists');\n\t}\n\n\tconst visitor = await LivechatVisitors.getVisitorByToken(token, { projection: { _id: 1 } });\n\tif (!visitor) {\n\t\tthrow new Meteor.Error('invalid-token', 'Provided token is invalid');\n\t}\n\tawait LivechatVisitors.updateById(visitor._id, updateUser);\n}\n\nexport async function removeDepartment(departmentId: string) {\n\tlivechatLogger.debug(`Removing department: ${departmentId}`);\n\n\tconst department = await LivechatDepartment.findOneById<Pick<ILivechatDepartment, '_id' | 'businessHourId'>>(departmentId, {\n\t\tprojection: { _id: 1, businessHourId: 1 },\n\t});\n\tif (!department) {\n\t\tthrow new Error('error-department-not-found');\n\t}\n\n\tconst { _id } = department;\n\n\tconst ret = await LivechatDepartment.removeById(_id);\n\tif (ret.acknowledged !== true) {\n\t\tthrow new Error('error-failed-to-delete-department');\n\t}\n\n\tconst removedAgents = await LivechatDepartmentAgents.findByDepartmentId(department._id, { projection: { agentId: 1 } }).toArray();\n\n\tlivechatLogger.debug(\n\t\t`Performing post-department-removal actions: ${_id}. Removing department agents, unsetting fallback department and removing department from rooms`,\n\t);\n\n\tconst removeByDept = LivechatDepartmentAgents.removeByDepartmentId(_id);\n\n\tconst promiseResponses = await Promise.allSettled([\n\t\tremoveByDept,\n\t\tLivechatDepartment.unsetFallbackDepartmentByDepartmentId(_id),\n\t\tLivechatRooms.bulkRemoveDepartmentAndUnitsFromRooms(_id),\n\t]);\n\n\tpromiseResponses.forEach((response, index) => {\n\t\tif (response.status === 'rejected') {\n\t\t\tlivechatLogger.error(`Error while performing post-department-removal actions: ${_id}. Action No: ${index}. Error:`, response.reason);\n\t\t}\n\t});\n\n\tconst { deletedCount } = await removeByDept;\n\n\tif (deletedCount > 0) {\n\t\tremovedAgents.forEach(({ _id: docId, agentId }) => {\n\t\t\tvoid notifyOnLivechatDepartmentAgentChanged(\n\t\t\t\t{\n\t\t\t\t\t_id: docId,\n\t\t\t\t\tagentId,\n\t\t\t\t\tdepartmentId: _id,\n\t\t\t\t},\n\t\t\t\t'removed',\n\t\t\t);\n\t\t});\n\t}\n\n\tawait callbacks.run('livechat.afterRemoveDepartment', { department, agentsIds: removedAgents.map(({ agentId }) => agentId) });\n\n\treturn ret;\n}\n\nexport async function getRequiredDepartment(onlineRequired = true) {\n\tconst departments = LivechatDepartment.findEnabledWithAgents();\n\n\tfor await (const dept of departments) {\n\t\tif (!dept.showOnRegistration) {\n\t\t\tcontinue;\n\t\t}\n\t\tif (!onlineRequired) {\n\t\t\treturn dept;\n\t\t}\n\n\t\tconst onlineAgents = await LivechatDepartmentAgents.countOnlineForDepartment(dept._id);\n\t\tif (onlineAgents) {\n\t\t\treturn dept;\n\t\t}\n\t}\n}\n"],"mappings":"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","ignoreList":[]},"sourceType":"module","externalDependencies":{},"hash":"4789c49c39af2c6f5ef61e6c51eb59ca10b0934a"}
