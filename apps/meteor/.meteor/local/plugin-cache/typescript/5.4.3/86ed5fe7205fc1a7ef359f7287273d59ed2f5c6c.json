{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/app/assets/server/assets.ts","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","topLevelAwait","objectRestSpread","objectRestSpread","asyncGenerators","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"os.osx.arm64"},"sourceFileName":"app/assets/server/assets.ts","filename":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/app/assets/server/assets.ts","inputSourceMap":{"version":3,"file":"app/assets/server/assets.ts","sourceRoot":"","sources":["app/assets/server/assets.ts"],"names":[],"mappings":"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","sourcesContent":["import crypto from 'crypto';\nimport type { ServerResponse, IncomingMessage } from 'http';\n\nimport type { IRocketChatAssets, IRocketChatAsset, ISetting } from '@rocket.chat/core-typings';\nimport { Settings } from '@rocket.chat/models';\nimport type { NextHandleFunction } from 'connect';\nimport sizeOf from 'image-size';\nimport { Meteor } from 'meteor/meteor';\nimport { WebApp, WebAppInternals } from 'meteor/webapp';\nimport sharp from 'sharp';\n\nimport { hasPermissionAsync } from '../../authorization/server/functions/hasPermission';\nimport { RocketChatFile } from '../../file/server';\nimport { notifyOnSettingChangedById } from '../../lib/server/lib/notifyListener';\nimport { settings, settingsRegistry } from '../../settings/server';\nimport { getExtension } from '../../utils/lib/mimeTypes';\nimport { getURL } from '../../utils/server/getURL';\n\nconst RocketChatAssetsInstance = new RocketChatFile.GridFS({\n\tname: 'assets',\n});\n\ntype IRocketChatAssetsConfig = Record<keyof IRocketChatAssets, IRocketChatAsset & { settingOptions?: Partial<ISetting> }>;\n\nconst assets: IRocketChatAssetsConfig = {\n\tlogo: {\n\t\tlabel: 'logo (svg, png, jpg)',\n\t\tdefaultUrl: 'images/logo/logo.svg',\n\t\tconstraints: {\n\t\t\ttype: 'image',\n\t\t\textensions: ['svg', 'png', 'jpg', 'jpeg'],\n\t\t},\n\t\twizard: {\n\t\t\tstep: 3,\n\t\t\torder: 2,\n\t\t},\n\t},\n\tlogo_dark: {\n\t\tlabel: 'logo - dark theme (svg, png, jpg)',\n\t\tdefaultUrl: 'images/logo/logo_dark.svg',\n\t\tconstraints: {\n\t\t\ttype: 'image',\n\t\t\textensions: ['svg', 'png', 'jpg', 'jpeg'],\n\t\t},\n\t},\n\tbackground: {\n\t\tlabel: 'login background (svg, png, jpg)',\n\t\tconstraints: {\n\t\t\ttype: 'image',\n\t\t\textensions: ['svg', 'png', 'jpg', 'jpeg'],\n\t\t},\n\t},\n\tbackground_dark: {\n\t\tlabel: 'login background - dark theme (svg, png, jpg)',\n\t\tconstraints: {\n\t\t\ttype: 'image',\n\t\t\textensions: ['svg', 'png', 'jpg', 'jpeg'],\n\t\t},\n\t},\n\tfavicon_ico: {\n\t\tlabel: 'favicon (ico)',\n\t\tdefaultUrl: 'favicon.ico',\n\t\tconstraints: {\n\t\t\ttype: 'image',\n\t\t\textensions: ['ico'],\n\t\t},\n\t},\n\tfavicon: {\n\t\tlabel: 'favicon (svg)',\n\t\tdefaultUrl: 'images/logo/icon.svg',\n\t\tconstraints: {\n\t\t\ttype: 'image',\n\t\t\textensions: ['svg'],\n\t\t},\n\t},\n\tfavicon_16: {\n\t\tlabel: 'favicon 16x16 (png)',\n\t\tdefaultUrl: 'images/logo/favicon-16x16.png',\n\t\tconstraints: {\n\t\t\ttype: 'image',\n\t\t\textensions: ['png'],\n\t\t\twidth: 16,\n\t\t\theight: 16,\n\t\t},\n\t},\n\tfavicon_32: {\n\t\tlabel: 'favicon 32x32 (png)',\n\t\tdefaultUrl: 'images/logo/favicon-32x32.png',\n\t\tconstraints: {\n\t\t\ttype: 'image',\n\t\t\textensions: ['png'],\n\t\t\twidth: 32,\n\t\t\theight: 32,\n\t\t},\n\t},\n\tfavicon_192: {\n\t\tlabel: 'android-chrome 192x192 (png)',\n\t\tdefaultUrl: 'images/logo/android-chrome-192x192.png',\n\t\tconstraints: {\n\t\t\ttype: 'image',\n\t\t\textensions: ['png'],\n\t\t\twidth: 192,\n\t\t\theight: 192,\n\t\t},\n\t},\n\tfavicon_512: {\n\t\tlabel: 'android-chrome 512x512 (png)',\n\t\tdefaultUrl: 'images/logo/android-chrome-512x512.png',\n\t\tconstraints: {\n\t\t\ttype: 'image',\n\t\t\textensions: ['png'],\n\t\t\twidth: 512,\n\t\t\theight: 512,\n\t\t},\n\t},\n\ttouchicon_180: {\n\t\tlabel: 'apple-touch-icon 180x180 (png)',\n\t\tdefaultUrl: 'images/logo/apple-touch-icon.png',\n\t\tconstraints: {\n\t\t\ttype: 'image',\n\t\t\textensions: ['png'],\n\t\t\twidth: 180,\n\t\t\theight: 180,\n\t\t},\n\t},\n\ttouchicon_180_pre: {\n\t\tlabel: 'apple-touch-icon-precomposed 180x180 (png)',\n\t\tdefaultUrl: 'images/logo/apple-touch-icon-precomposed.png',\n\t\tconstraints: {\n\t\t\ttype: 'image',\n\t\t\textensions: ['png'],\n\t\t\twidth: 180,\n\t\t\theight: 180,\n\t\t},\n\t},\n\ttile_70: {\n\t\tlabel: 'mstile 70x70 (png)',\n\t\tdefaultUrl: 'images/logo/mstile-70x70.png',\n\t\tconstraints: {\n\t\t\ttype: 'image',\n\t\t\textensions: ['png'],\n\t\t\twidth: 70,\n\t\t\theight: 70,\n\t\t},\n\t},\n\ttile_144: {\n\t\tlabel: 'mstile 144x144 (png)',\n\t\tdefaultUrl: 'images/logo/mstile-144x144.png',\n\t\tconstraints: {\n\t\t\ttype: 'image',\n\t\t\textensions: ['png'],\n\t\t\twidth: 144,\n\t\t\theight: 144,\n\t\t},\n\t},\n\ttile_150: {\n\t\tlabel: 'mstile 150x150 (png)',\n\t\tdefaultUrl: 'images/logo/mstile-150x150.png',\n\t\tconstraints: {\n\t\t\ttype: 'image',\n\t\t\textensions: ['png'],\n\t\t\twidth: 150,\n\t\t\theight: 150,\n\t\t},\n\t},\n\ttile_310_square: {\n\t\tlabel: 'mstile 310x310 (png)',\n\t\tdefaultUrl: 'images/logo/mstile-310x310.png',\n\t\tconstraints: {\n\t\t\ttype: 'image',\n\t\t\textensions: ['png'],\n\t\t\twidth: 310,\n\t\t\theight: 310,\n\t\t},\n\t},\n\ttile_310_wide: {\n\t\tlabel: 'mstile 310x150 (png)',\n\t\tdefaultUrl: 'images/logo/mstile-310x150.png',\n\t\tconstraints: {\n\t\t\ttype: 'image',\n\t\t\textensions: ['png'],\n\t\t\twidth: 310,\n\t\t\theight: 150,\n\t\t},\n\t},\n\tsafari_pinned: {\n\t\tlabel: 'safari pinned tab (svg)',\n\t\tdefaultUrl: 'images/logo/safari-pinned-tab.svg',\n\t\tconstraints: {\n\t\t\ttype: 'image',\n\t\t\textensions: ['svg'],\n\t\t},\n\t},\n\tlivechat_widget_logo: {\n\t\tlabel: 'widget logo (svg, png, jpg)',\n\t\tconstraints: {\n\t\t\ttype: 'image',\n\t\t\textensions: ['svg', 'png', 'jpg', 'jpeg'],\n\t\t},\n\t\tsettingOptions: {\n\t\t\tsection: 'Livechat',\n\t\t\tgroup: 'Omnichannel',\n\t\t\tinvalidValue: {\n\t\t\t\tdefaultUrl: undefined,\n\t\t\t},\n\t\t\tenableQuery: { _id: 'Livechat_enabled', value: true },\n\t\t\tenterprise: true,\n\t\t\tmodules: ['livechat-enterprise'],\n\t\t\tsorter: 999 + 1,\n\t\t},\n\t},\n};\n\nfunction getAssetByKey(key: string) {\n\treturn assets[key as keyof IRocketChatAssets];\n}\n\nclass RocketChatAssetsClass {\n\tget assets(): IRocketChatAssets {\n\t\treturn assets;\n\t}\n\n\tpublic async setAsset(binaryContent: string, contentType: string, asset: string): Promise<void> {\n\t\tconst file = Buffer.from(binaryContent, 'binary');\n\t\tawait this.setAssetWithBuffer(file, contentType, asset);\n\t}\n\n\tpublic async setAssetWithBuffer(binaryContent: Buffer, contentType: string, asset: string): Promise<void> {\n\t\tawait this._setAsset(binaryContent, contentType, asset);\n\t}\n\n\tprivate async _setAsset(file: Buffer, contentType: string, asset: string): Promise<void> {\n\t\tconst assetInstance = getAssetByKey(asset);\n\t\tif (!assetInstance) {\n\t\t\tthrow new Meteor.Error('error-invalid-asset', 'Invalid asset', {\n\t\t\t\tfunction: 'RocketChat.Assets.setAsset',\n\t\t\t});\n\t\t}\n\n\t\tconst extension = getExtension(contentType);\n\t\tif (assetInstance.constraints.extensions.includes(extension) === false) {\n\t\t\tthrow new Meteor.Error('error-invalid-file-type', `Invalid file type: ${contentType}`, {\n\t\t\t\tfunction: 'RocketChat.Assets.setAsset',\n\t\t\t});\n\t\t}\n\n\t\tif (assetInstance.constraints.width || assetInstance.constraints.height) {\n\t\t\tconst dimensions = sizeOf(file);\n\t\t\tif (assetInstance.constraints.width && assetInstance.constraints.width !== dimensions.width) {\n\t\t\t\tthrow new Meteor.Error('error-invalid-file-width', 'Invalid file width', {\n\t\t\t\t\tfunction: 'Invalid file width',\n\t\t\t\t});\n\t\t\t}\n\t\t\tif (assetInstance.constraints.height && assetInstance.constraints.height !== dimensions.height) {\n\t\t\t\tthrow new Meteor.Error('error-invalid-file-height');\n\t\t\t}\n\t\t}\n\n\t\tconst rs = RocketChatFile.bufferToStream(file);\n\t\tawait RocketChatAssetsInstance.deleteFile(asset);\n\n\t\tconst ws = RocketChatAssetsInstance.createWriteStream(asset, contentType);\n\t\tws.on('end', () => {\n\t\t\treturn setTimeout(async () => {\n\t\t\t\tconst key = `Assets_${asset}`;\n\t\t\t\tconst value = {\n\t\t\t\t\turl: `assets/${asset}.${extension}`,\n\t\t\t\t\tdefaultUrl: assetInstance.defaultUrl,\n\t\t\t\t};\n\n\t\t\t\tvoid (async () => {\n\t\t\t\t\t// TODO: audit\n\t\t\t\t\tconst { modifiedCount } = await Settings.updateValueById(key, value);\n\t\t\t\t\tif (modifiedCount) {\n\t\t\t\t\t\tvoid notifyOnSettingChangedById(key);\n\t\t\t\t\t}\n\t\t\t\t})();\n\n\t\t\t\treturn RocketChatAssets.processAsset(key, value);\n\t\t\t}, 200);\n\t\t});\n\n\t\trs.pipe(ws);\n\t}\n\n\tpublic async unsetAsset(asset: string): Promise<void> {\n\t\tif (!getAssetByKey(asset)) {\n\t\t\tthrow new Meteor.Error('error-invalid-asset', 'Invalid asset', {\n\t\t\t\tfunction: 'RocketChat.Assets.unsetAsset',\n\t\t\t});\n\t\t}\n\n\t\tawait RocketChatAssetsInstance.deleteFile(asset);\n\t\tconst key = `Assets_${asset}`;\n\t\tconst value = {\n\t\t\tdefaultUrl: getAssetByKey(asset).defaultUrl,\n\t\t};\n\n\t\tvoid (async () => {\n\t\t\t// TODO: audit\n\t\t\tconst { modifiedCount } = await Settings.updateValueById(key, value);\n\t\t\tif (modifiedCount) {\n\t\t\t\tvoid notifyOnSettingChangedById(key);\n\t\t\t}\n\t\t})();\n\n\t\tawait RocketChatAssets.processAsset(key, value);\n\t}\n\n\tpublic refreshClients(): boolean {\n\t\treturn process.emit('message', {\n\t\t\trefresh: 'client',\n\t\t});\n\t}\n\n\tpublic async processAsset(settingKey: string, settingValue: any): Promise<Record<string, any> | undefined> {\n\t\tif (settingKey.indexOf('Assets_') !== 0) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst assetKey = settingKey.replace(/^Assets_/, '');\n\t\tconst assetValue = getAssetByKey(assetKey);\n\n\t\tif (!assetValue) {\n\t\t\treturn;\n\t\t}\n\n\t\tif (!settingValue?.url) {\n\t\t\tassetValue.cache = undefined;\n\t\t\treturn;\n\t\t}\n\n\t\tconst file = await RocketChatAssetsInstance.getFile(assetKey);\n\t\tif (!file) {\n\t\t\tassetValue.cache = undefined;\n\t\t\treturn;\n\t\t}\n\n\t\tconst hash = crypto.createHash('sha1').update(file.buffer).digest('hex');\n\t\tconst extension = settingValue.url.split('.').pop();\n\n\t\tassetValue.cache = {\n\t\t\tpath: `assets/${assetKey}.${extension}`,\n\t\t\tcacheable: false,\n\t\t\tsourceMapUrl: undefined,\n\t\t\twhere: 'client',\n\t\t\ttype: 'asset',\n\t\t\tcontent: file.buffer,\n\t\t\textension,\n\t\t\turl: `/assets/${assetKey}.${extension}?${hash}`,\n\t\t\tsize: file.length,\n\t\t\tuploadDate: file.uploadDate,\n\t\t\tcontentType: file.contentType,\n\t\t\thash,\n\t\t};\n\n\t\treturn assetValue.cache;\n\t}\n\n\tpublic getURL(assetName: string, options = { cdn: false, full: true }): string {\n\t\tconst asset = settings.get<IRocketChatAsset>(assetName);\n\t\tconst url = asset.url || asset.defaultUrl;\n\n\t\treturn getURL(url as string, options);\n\t}\n}\n\nexport const RocketChatAssets = new RocketChatAssetsClass();\n\nexport async function addAssetToSetting(asset: string, value: IRocketChatAsset, options?: Partial<ISetting>): Promise<void> {\n\tconst key = `Assets_${asset}`;\n\n\tawait settingsRegistry.add(\n\t\tkey,\n\t\t{\n\t\t\tdefaultUrl: value.defaultUrl,\n\t\t},\n\t\t{\n\t\t\ttype: 'asset',\n\t\t\tgroup: 'Assets',\n\t\t\tfileConstraints: value.constraints,\n\t\t\ti18nLabel: value.label,\n\t\t\tasset,\n\t\t\tpublic: true,\n\t\t\t...options,\n\t\t},\n\t);\n\n\tconst currentValue = settings.get<IRocketChatAsset>(key);\n\n\tif (currentValue && typeof currentValue === 'object' && currentValue.defaultUrl !== getAssetByKey(asset).defaultUrl) {\n\t\tcurrentValue.defaultUrl = getAssetByKey(asset).defaultUrl;\n\n\t\t(await Settings.updateValueById(key, currentValue)).modifiedCount && void notifyOnSettingChangedById(key);\n\t}\n}\n\nvoid (async () => {\n\tfor await (const key of Object.keys(assets)) {\n\t\tconst { wizard, settingOptions, ...value } = getAssetByKey(key);\n\t\tawait addAssetToSetting(key, value, { ...settingOptions, wizard });\n\t}\n})();\n\nsettings.watchByRegex(/^Assets_/, (key, value) => RocketChatAssets.processAsset(key, value));\n\nMeteor.startup(() => {\n\tsetTimeout(() => {\n\t\tprocess.emit('message', {\n\t\t\trefresh: 'client',\n\t\t});\n\t}, 200);\n});\n\nexport const refreshClients = async (userId: string) => {\n\tif (!userId) {\n\t\tthrow new Error('Invalid user');\n\t}\n\n\tconst _hasPermission = await hasPermissionAsync(userId, 'manage-assets');\n\tif (!_hasPermission) {\n\t\tthrow new Error('Managing assets not allowed');\n\t}\n\n\treturn RocketChatAssets.refreshClients();\n};\n\nexport const unsetAsset = async (userId: string, asset: string) => {\n\tif (!userId) {\n\t\tthrow new Error('Invalid user');\n\t}\n\n\tconst _hasPermission = await hasPermissionAsync(userId, 'manage-assets');\n\tif (!_hasPermission) {\n\t\tthrow new Error('Managing assets not allowed');\n\t}\n\n\treturn RocketChatAssets.unsetAsset(asset);\n};\n\nexport const setAsset = async (userId: string, binaryContent: Buffer, contentType: string, asset: string) => {\n\tif (!userId) {\n\t\tthrow new Error('Invalid user');\n\t}\n\n\tconst _hasPermission = await hasPermissionAsync(userId, 'manage-assets');\n\tif (!_hasPermission) {\n\t\tthrow new Error('Managing assets not allowed');\n\t}\n\n\tawait RocketChatAssets.setAssetWithBuffer(binaryContent, contentType, asset);\n};\n\nconst listener = (req: IncomingMessage, res: ServerResponse, next: NextHandleFunction) => {\n\tif (!req.url) {\n\t\treturn;\n\t}\n\tconst params = {\n\t\tasset: decodeURIComponent(req.url.replace(/^\\//, '').replace(/\\?.*$/, '')).replace(/\\.[^.]*$/, ''),\n\t};\n\n\tconst asset = getAssetByKey(params.asset);\n\tconst file = asset?.cache;\n\n\tconst format = req.url.replace(/.*\\.([a-z]+)(?:$|\\?.*)/i, '$1');\n\n\tif (asset && Array.isArray(asset.constraints.extensions) && !asset.constraints.extensions.includes(format)) {\n\t\tres.writeHead(403);\n\t\treturn res.end();\n\t}\n\tif (!file) {\n\t\tconst defaultUrl = asset?.defaultUrl;\n\t\tif (defaultUrl) {\n\t\t\tconst assetUrl = format && ['png', 'svg'].includes(format) ? defaultUrl.replace(/(svg|png)$/, format) : defaultUrl;\n\t\t\treq.url = `/${assetUrl}`;\n\t\t\tWebAppInternals.staticFilesMiddleware((WebAppInternals as Record<string, any>).staticFilesByArch, req, res, next);\n\t\t} else {\n\t\t\tres.writeHead(404);\n\t\t\tres.end();\n\t\t}\n\n\t\treturn;\n\t}\n\n\tconst reqModifiedHeader = req.headers['if-modified-since'];\n\tif (reqModifiedHeader) {\n\t\tif (reqModifiedHeader === file.uploadDate?.toUTCString()) {\n\t\t\tres.setHeader('Last-Modified', reqModifiedHeader);\n\t\t\tres.writeHead(304);\n\t\t\tres.end();\n\t\t\treturn;\n\t\t}\n\t}\n\n\tres.setHeader('Cache-Control', 'public, max-age=0');\n\tres.setHeader('Expires', '-1');\n\n\tif (format && format !== file.extension && ['png', 'jpg', 'jpeg'].includes(format)) {\n\t\tres.setHeader('Content-Type', `image/${format}`);\n\t\tsharp(file.content)\n\t\t\t.toFormat(format as any)\n\t\t\t.pipe(res);\n\t\treturn;\n\t}\n\n\tres.setHeader('Last-Modified', file.uploadDate?.toUTCString() || new Date().toUTCString());\n\tif (file.contentType) res.setHeader('Content-Type', file.contentType);\n\tif (file.size) res.setHeader('Content-Length', file.size);\n\tres.writeHead(200);\n\tres.end(file.content);\n};\n\nWebApp.connectHandlers.use('/assets/', listener);\n"]},"targets":{"android":"125.0.0","chrome":"125.0.0","edge":"125.0.0","firefox":"115.0.0","ie":"10.0.0","ios":"17.4.0","opera":"110.0.0","opera_mobile":"80.0.0","safari":"17.4.0","samsung":"24.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor","root":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":false,"enforceStrictMode":false,"dynamicImport":true,"generateLetDeclarations":true,"topLevelAwait":true},"externalDependencies":[]},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"version":"7.17.2","helpers":true,"useESModules":false,"corejs":false},"externalDependencies":[]},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-async-generator-functions","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-class-properties","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true},"externalDependencies":[]},{"key":"transform-react-jsx","visitor":{"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXFragment":{"exit":[null]},"JSXElement":{"exit":[null]},"JSXAttribute":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false},"externalDependencies":[]},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-nullish-coalescing-operator","visitor":{"LogicalExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-optional-chaining","visitor":{"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-optional-catch-binding","visitor":{"CatchClause":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-class-properties","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-async-generator-functions","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-logical-assignment-operators","visitor":{"AssignmentExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]}],"presets":[],"generatorOpts":{"filename":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/app/assets/server/assets.ts","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"app/assets/server/assets.ts","inputSourceMap":{"version":3,"file":"app/assets/server/assets.ts","sourceRoot":"","sources":["app/assets/server/assets.ts"],"names":[],"mappings":"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","sourcesContent":["import crypto from 'crypto';\nimport type { ServerResponse, IncomingMessage } from 'http';\n\nimport type { IRocketChatAssets, IRocketChatAsset, ISetting } from '@rocket.chat/core-typings';\nimport { Settings } from '@rocket.chat/models';\nimport type { NextHandleFunction } from 'connect';\nimport sizeOf from 'image-size';\nimport { Meteor } from 'meteor/meteor';\nimport { WebApp, WebAppInternals } from 'meteor/webapp';\nimport sharp from 'sharp';\n\nimport { hasPermissionAsync } from '../../authorization/server/functions/hasPermission';\nimport { RocketChatFile } from '../../file/server';\nimport { notifyOnSettingChangedById } from '../../lib/server/lib/notifyListener';\nimport { settings, settingsRegistry } from '../../settings/server';\nimport { getExtension } from '../../utils/lib/mimeTypes';\nimport { getURL } from '../../utils/server/getURL';\n\nconst RocketChatAssetsInstance = new RocketChatFile.GridFS({\n\tname: 'assets',\n});\n\ntype IRocketChatAssetsConfig = Record<keyof IRocketChatAssets, IRocketChatAsset & { settingOptions?: Partial<ISetting> }>;\n\nconst assets: IRocketChatAssetsConfig = {\n\tlogo: {\n\t\tlabel: 'logo (svg, png, jpg)',\n\t\tdefaultUrl: 'images/logo/logo.svg',\n\t\tconstraints: {\n\t\t\ttype: 'image',\n\t\t\textensions: ['svg', 'png', 'jpg', 'jpeg'],\n\t\t},\n\t\twizard: {\n\t\t\tstep: 3,\n\t\t\torder: 2,\n\t\t},\n\t},\n\tlogo_dark: {\n\t\tlabel: 'logo - dark theme (svg, png, jpg)',\n\t\tdefaultUrl: 'images/logo/logo_dark.svg',\n\t\tconstraints: {\n\t\t\ttype: 'image',\n\t\t\textensions: ['svg', 'png', 'jpg', 'jpeg'],\n\t\t},\n\t},\n\tbackground: {\n\t\tlabel: 'login background (svg, png, jpg)',\n\t\tconstraints: {\n\t\t\ttype: 'image',\n\t\t\textensions: ['svg', 'png', 'jpg', 'jpeg'],\n\t\t},\n\t},\n\tbackground_dark: {\n\t\tlabel: 'login background - dark theme (svg, png, jpg)',\n\t\tconstraints: {\n\t\t\ttype: 'image',\n\t\t\textensions: ['svg', 'png', 'jpg', 'jpeg'],\n\t\t},\n\t},\n\tfavicon_ico: {\n\t\tlabel: 'favicon (ico)',\n\t\tdefaultUrl: 'favicon.ico',\n\t\tconstraints: {\n\t\t\ttype: 'image',\n\t\t\textensions: ['ico'],\n\t\t},\n\t},\n\tfavicon: {\n\t\tlabel: 'favicon (svg)',\n\t\tdefaultUrl: 'images/logo/icon.svg',\n\t\tconstraints: {\n\t\t\ttype: 'image',\n\t\t\textensions: ['svg'],\n\t\t},\n\t},\n\tfavicon_16: {\n\t\tlabel: 'favicon 16x16 (png)',\n\t\tdefaultUrl: 'images/logo/favicon-16x16.png',\n\t\tconstraints: {\n\t\t\ttype: 'image',\n\t\t\textensions: ['png'],\n\t\t\twidth: 16,\n\t\t\theight: 16,\n\t\t},\n\t},\n\tfavicon_32: {\n\t\tlabel: 'favicon 32x32 (png)',\n\t\tdefaultUrl: 'images/logo/favicon-32x32.png',\n\t\tconstraints: {\n\t\t\ttype: 'image',\n\t\t\textensions: ['png'],\n\t\t\twidth: 32,\n\t\t\theight: 32,\n\t\t},\n\t},\n\tfavicon_192: {\n\t\tlabel: 'android-chrome 192x192 (png)',\n\t\tdefaultUrl: 'images/logo/android-chrome-192x192.png',\n\t\tconstraints: {\n\t\t\ttype: 'image',\n\t\t\textensions: ['png'],\n\t\t\twidth: 192,\n\t\t\theight: 192,\n\t\t},\n\t},\n\tfavicon_512: {\n\t\tlabel: 'android-chrome 512x512 (png)',\n\t\tdefaultUrl: 'images/logo/android-chrome-512x512.png',\n\t\tconstraints: {\n\t\t\ttype: 'image',\n\t\t\textensions: ['png'],\n\t\t\twidth: 512,\n\t\t\theight: 512,\n\t\t},\n\t},\n\ttouchicon_180: {\n\t\tlabel: 'apple-touch-icon 180x180 (png)',\n\t\tdefaultUrl: 'images/logo/apple-touch-icon.png',\n\t\tconstraints: {\n\t\t\ttype: 'image',\n\t\t\textensions: ['png'],\n\t\t\twidth: 180,\n\t\t\theight: 180,\n\t\t},\n\t},\n\ttouchicon_180_pre: {\n\t\tlabel: 'apple-touch-icon-precomposed 180x180 (png)',\n\t\tdefaultUrl: 'images/logo/apple-touch-icon-precomposed.png',\n\t\tconstraints: {\n\t\t\ttype: 'image',\n\t\t\textensions: ['png'],\n\t\t\twidth: 180,\n\t\t\theight: 180,\n\t\t},\n\t},\n\ttile_70: {\n\t\tlabel: 'mstile 70x70 (png)',\n\t\tdefaultUrl: 'images/logo/mstile-70x70.png',\n\t\tconstraints: {\n\t\t\ttype: 'image',\n\t\t\textensions: ['png'],\n\t\t\twidth: 70,\n\t\t\theight: 70,\n\t\t},\n\t},\n\ttile_144: {\n\t\tlabel: 'mstile 144x144 (png)',\n\t\tdefaultUrl: 'images/logo/mstile-144x144.png',\n\t\tconstraints: {\n\t\t\ttype: 'image',\n\t\t\textensions: ['png'],\n\t\t\twidth: 144,\n\t\t\theight: 144,\n\t\t},\n\t},\n\ttile_150: {\n\t\tlabel: 'mstile 150x150 (png)',\n\t\tdefaultUrl: 'images/logo/mstile-150x150.png',\n\t\tconstraints: {\n\t\t\ttype: 'image',\n\t\t\textensions: ['png'],\n\t\t\twidth: 150,\n\t\t\theight: 150,\n\t\t},\n\t},\n\ttile_310_square: {\n\t\tlabel: 'mstile 310x310 (png)',\n\t\tdefaultUrl: 'images/logo/mstile-310x310.png',\n\t\tconstraints: {\n\t\t\ttype: 'image',\n\t\t\textensions: ['png'],\n\t\t\twidth: 310,\n\t\t\theight: 310,\n\t\t},\n\t},\n\ttile_310_wide: {\n\t\tlabel: 'mstile 310x150 (png)',\n\t\tdefaultUrl: 'images/logo/mstile-310x150.png',\n\t\tconstraints: {\n\t\t\ttype: 'image',\n\t\t\textensions: ['png'],\n\t\t\twidth: 310,\n\t\t\theight: 150,\n\t\t},\n\t},\n\tsafari_pinned: {\n\t\tlabel: 'safari pinned tab (svg)',\n\t\tdefaultUrl: 'images/logo/safari-pinned-tab.svg',\n\t\tconstraints: {\n\t\t\ttype: 'image',\n\t\t\textensions: ['svg'],\n\t\t},\n\t},\n\tlivechat_widget_logo: {\n\t\tlabel: 'widget logo (svg, png, jpg)',\n\t\tconstraints: {\n\t\t\ttype: 'image',\n\t\t\textensions: ['svg', 'png', 'jpg', 'jpeg'],\n\t\t},\n\t\tsettingOptions: {\n\t\t\tsection: 'Livechat',\n\t\t\tgroup: 'Omnichannel',\n\t\t\tinvalidValue: {\n\t\t\t\tdefaultUrl: undefined,\n\t\t\t},\n\t\t\tenableQuery: { _id: 'Livechat_enabled', value: true },\n\t\t\tenterprise: true,\n\t\t\tmodules: ['livechat-enterprise'],\n\t\t\tsorter: 999 + 1,\n\t\t},\n\t},\n};\n\nfunction getAssetByKey(key: string) {\n\treturn assets[key as keyof IRocketChatAssets];\n}\n\nclass RocketChatAssetsClass {\n\tget assets(): IRocketChatAssets {\n\t\treturn assets;\n\t}\n\n\tpublic async setAsset(binaryContent: string, contentType: string, asset: string): Promise<void> {\n\t\tconst file = Buffer.from(binaryContent, 'binary');\n\t\tawait this.setAssetWithBuffer(file, contentType, asset);\n\t}\n\n\tpublic async setAssetWithBuffer(binaryContent: Buffer, contentType: string, asset: string): Promise<void> {\n\t\tawait this._setAsset(binaryContent, contentType, asset);\n\t}\n\n\tprivate async _setAsset(file: Buffer, contentType: string, asset: string): Promise<void> {\n\t\tconst assetInstance = getAssetByKey(asset);\n\t\tif (!assetInstance) {\n\t\t\tthrow new Meteor.Error('error-invalid-asset', 'Invalid asset', {\n\t\t\t\tfunction: 'RocketChat.Assets.setAsset',\n\t\t\t});\n\t\t}\n\n\t\tconst extension = getExtension(contentType);\n\t\tif (assetInstance.constraints.extensions.includes(extension) === false) {\n\t\t\tthrow new Meteor.Error('error-invalid-file-type', `Invalid file type: ${contentType}`, {\n\t\t\t\tfunction: 'RocketChat.Assets.setAsset',\n\t\t\t});\n\t\t}\n\n\t\tif (assetInstance.constraints.width || assetInstance.constraints.height) {\n\t\t\tconst dimensions = sizeOf(file);\n\t\t\tif (assetInstance.constraints.width && assetInstance.constraints.width !== dimensions.width) {\n\t\t\t\tthrow new Meteor.Error('error-invalid-file-width', 'Invalid file width', {\n\t\t\t\t\tfunction: 'Invalid file width',\n\t\t\t\t});\n\t\t\t}\n\t\t\tif (assetInstance.constraints.height && assetInstance.constraints.height !== dimensions.height) {\n\t\t\t\tthrow new Meteor.Error('error-invalid-file-height');\n\t\t\t}\n\t\t}\n\n\t\tconst rs = RocketChatFile.bufferToStream(file);\n\t\tawait RocketChatAssetsInstance.deleteFile(asset);\n\n\t\tconst ws = RocketChatAssetsInstance.createWriteStream(asset, contentType);\n\t\tws.on('end', () => {\n\t\t\treturn setTimeout(async () => {\n\t\t\t\tconst key = `Assets_${asset}`;\n\t\t\t\tconst value = {\n\t\t\t\t\turl: `assets/${asset}.${extension}`,\n\t\t\t\t\tdefaultUrl: assetInstance.defaultUrl,\n\t\t\t\t};\n\n\t\t\t\tvoid (async () => {\n\t\t\t\t\t// TODO: audit\n\t\t\t\t\tconst { modifiedCount } = await Settings.updateValueById(key, value);\n\t\t\t\t\tif (modifiedCount) {\n\t\t\t\t\t\tvoid notifyOnSettingChangedById(key);\n\t\t\t\t\t}\n\t\t\t\t})();\n\n\t\t\t\treturn RocketChatAssets.processAsset(key, value);\n\t\t\t}, 200);\n\t\t});\n\n\t\trs.pipe(ws);\n\t}\n\n\tpublic async unsetAsset(asset: string): Promise<void> {\n\t\tif (!getAssetByKey(asset)) {\n\t\t\tthrow new Meteor.Error('error-invalid-asset', 'Invalid asset', {\n\t\t\t\tfunction: 'RocketChat.Assets.unsetAsset',\n\t\t\t});\n\t\t}\n\n\t\tawait RocketChatAssetsInstance.deleteFile(asset);\n\t\tconst key = `Assets_${asset}`;\n\t\tconst value = {\n\t\t\tdefaultUrl: getAssetByKey(asset).defaultUrl,\n\t\t};\n\n\t\tvoid (async () => {\n\t\t\t// TODO: audit\n\t\t\tconst { modifiedCount } = await Settings.updateValueById(key, value);\n\t\t\tif (modifiedCount) {\n\t\t\t\tvoid notifyOnSettingChangedById(key);\n\t\t\t}\n\t\t})();\n\n\t\tawait RocketChatAssets.processAsset(key, value);\n\t}\n\n\tpublic refreshClients(): boolean {\n\t\treturn process.emit('message', {\n\t\t\trefresh: 'client',\n\t\t});\n\t}\n\n\tpublic async processAsset(settingKey: string, settingValue: any): Promise<Record<string, any> | undefined> {\n\t\tif (settingKey.indexOf('Assets_') !== 0) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst assetKey = settingKey.replace(/^Assets_/, '');\n\t\tconst assetValue = getAssetByKey(assetKey);\n\n\t\tif (!assetValue) {\n\t\t\treturn;\n\t\t}\n\n\t\tif (!settingValue?.url) {\n\t\t\tassetValue.cache = undefined;\n\t\t\treturn;\n\t\t}\n\n\t\tconst file = await RocketChatAssetsInstance.getFile(assetKey);\n\t\tif (!file) {\n\t\t\tassetValue.cache = undefined;\n\t\t\treturn;\n\t\t}\n\n\t\tconst hash = crypto.createHash('sha1').update(file.buffer).digest('hex');\n\t\tconst extension = settingValue.url.split('.').pop();\n\n\t\tassetValue.cache = {\n\t\t\tpath: `assets/${assetKey}.${extension}`,\n\t\t\tcacheable: false,\n\t\t\tsourceMapUrl: undefined,\n\t\t\twhere: 'client',\n\t\t\ttype: 'asset',\n\t\t\tcontent: file.buffer,\n\t\t\textension,\n\t\t\turl: `/assets/${assetKey}.${extension}?${hash}`,\n\t\t\tsize: file.length,\n\t\t\tuploadDate: file.uploadDate,\n\t\t\tcontentType: file.contentType,\n\t\t\thash,\n\t\t};\n\n\t\treturn assetValue.cache;\n\t}\n\n\tpublic getURL(assetName: string, options = { cdn: false, full: true }): string {\n\t\tconst asset = settings.get<IRocketChatAsset>(assetName);\n\t\tconst url = asset.url || asset.defaultUrl;\n\n\t\treturn getURL(url as string, options);\n\t}\n}\n\nexport const RocketChatAssets = new RocketChatAssetsClass();\n\nexport async function addAssetToSetting(asset: string, value: IRocketChatAsset, options?: Partial<ISetting>): Promise<void> {\n\tconst key = `Assets_${asset}`;\n\n\tawait settingsRegistry.add(\n\t\tkey,\n\t\t{\n\t\t\tdefaultUrl: value.defaultUrl,\n\t\t},\n\t\t{\n\t\t\ttype: 'asset',\n\t\t\tgroup: 'Assets',\n\t\t\tfileConstraints: value.constraints,\n\t\t\ti18nLabel: value.label,\n\t\t\tasset,\n\t\t\tpublic: true,\n\t\t\t...options,\n\t\t},\n\t);\n\n\tconst currentValue = settings.get<IRocketChatAsset>(key);\n\n\tif (currentValue && typeof currentValue === 'object' && currentValue.defaultUrl !== getAssetByKey(asset).defaultUrl) {\n\t\tcurrentValue.defaultUrl = getAssetByKey(asset).defaultUrl;\n\n\t\t(await Settings.updateValueById(key, currentValue)).modifiedCount && void notifyOnSettingChangedById(key);\n\t}\n}\n\nvoid (async () => {\n\tfor await (const key of Object.keys(assets)) {\n\t\tconst { wizard, settingOptions, ...value } = getAssetByKey(key);\n\t\tawait addAssetToSetting(key, value, { ...settingOptions, wizard });\n\t}\n})();\n\nsettings.watchByRegex(/^Assets_/, (key, value) => RocketChatAssets.processAsset(key, value));\n\nMeteor.startup(() => {\n\tsetTimeout(() => {\n\t\tprocess.emit('message', {\n\t\t\trefresh: 'client',\n\t\t});\n\t}, 200);\n});\n\nexport const refreshClients = async (userId: string) => {\n\tif (!userId) {\n\t\tthrow new Error('Invalid user');\n\t}\n\n\tconst _hasPermission = await hasPermissionAsync(userId, 'manage-assets');\n\tif (!_hasPermission) {\n\t\tthrow new Error('Managing assets not allowed');\n\t}\n\n\treturn RocketChatAssets.refreshClients();\n};\n\nexport const unsetAsset = async (userId: string, asset: string) => {\n\tif (!userId) {\n\t\tthrow new Error('Invalid user');\n\t}\n\n\tconst _hasPermission = await hasPermissionAsync(userId, 'manage-assets');\n\tif (!_hasPermission) {\n\t\tthrow new Error('Managing assets not allowed');\n\t}\n\n\treturn RocketChatAssets.unsetAsset(asset);\n};\n\nexport const setAsset = async (userId: string, binaryContent: Buffer, contentType: string, asset: string) => {\n\tif (!userId) {\n\t\tthrow new Error('Invalid user');\n\t}\n\n\tconst _hasPermission = await hasPermissionAsync(userId, 'manage-assets');\n\tif (!_hasPermission) {\n\t\tthrow new Error('Managing assets not allowed');\n\t}\n\n\tawait RocketChatAssets.setAssetWithBuffer(binaryContent, contentType, asset);\n};\n\nconst listener = (req: IncomingMessage, res: ServerResponse, next: NextHandleFunction) => {\n\tif (!req.url) {\n\t\treturn;\n\t}\n\tconst params = {\n\t\tasset: decodeURIComponent(req.url.replace(/^\\//, '').replace(/\\?.*$/, '')).replace(/\\.[^.]*$/, ''),\n\t};\n\n\tconst asset = getAssetByKey(params.asset);\n\tconst file = asset?.cache;\n\n\tconst format = req.url.replace(/.*\\.([a-z]+)(?:$|\\?.*)/i, '$1');\n\n\tif (asset && Array.isArray(asset.constraints.extensions) && !asset.constraints.extensions.includes(format)) {\n\t\tres.writeHead(403);\n\t\treturn res.end();\n\t}\n\tif (!file) {\n\t\tconst defaultUrl = asset?.defaultUrl;\n\t\tif (defaultUrl) {\n\t\t\tconst assetUrl = format && ['png', 'svg'].includes(format) ? defaultUrl.replace(/(svg|png)$/, format) : defaultUrl;\n\t\t\treq.url = `/${assetUrl}`;\n\t\t\tWebAppInternals.staticFilesMiddleware((WebAppInternals as Record<string, any>).staticFilesByArch, req, res, next);\n\t\t} else {\n\t\t\tres.writeHead(404);\n\t\t\tres.end();\n\t\t}\n\n\t\treturn;\n\t}\n\n\tconst reqModifiedHeader = req.headers['if-modified-since'];\n\tif (reqModifiedHeader) {\n\t\tif (reqModifiedHeader === file.uploadDate?.toUTCString()) {\n\t\t\tres.setHeader('Last-Modified', reqModifiedHeader);\n\t\t\tres.writeHead(304);\n\t\t\tres.end();\n\t\t\treturn;\n\t\t}\n\t}\n\n\tres.setHeader('Cache-Control', 'public, max-age=0');\n\tres.setHeader('Expires', '-1');\n\n\tif (format && format !== file.extension && ['png', 'jpg', 'jpeg'].includes(format)) {\n\t\tres.setHeader('Content-Type', `image/${format}`);\n\t\tsharp(file.content)\n\t\t\t.toFormat(format as any)\n\t\t\t.pipe(res);\n\t\treturn;\n\t}\n\n\tres.setHeader('Last-Modified', file.uploadDate?.toUTCString() || new Date().toUTCString());\n\tif (file.contentType) res.setHeader('Content-Type', file.contentType);\n\tif (file.size) res.setHeader('Content-Length', file.size);\n\tres.writeHead(200);\n\tres.end(file.content);\n};\n\nWebApp.connectHandlers.use('/assets/', listener);\n"]}}},"code":"!module.wrapAsync(async function (module, __reifyWaitForDeps__, __reify_async_result__) {\n  \"use strict\";\n  try {\n    let _objectWithoutProperties;\n    module.link(\"@babel/runtime/helpers/objectWithoutProperties\", {\n      default(v) {\n        _objectWithoutProperties = v;\n      }\n    }, 0);\n    let _objectSpread;\n    module.link(\"@babel/runtime/helpers/objectSpread2\", {\n      default(v) {\n        _objectSpread = v;\n      }\n    }, 1);\n    let _asyncIterator;\n    module.link(\"@babel/runtime/helpers/asyncIterator\", {\n      default(v) {\n        _asyncIterator = v;\n      }\n    }, 2);\n    const _excluded = [\"wizard\", \"settingOptions\"];\n    module.export({\n      RocketChatAssets: () => RocketChatAssets,\n      addAssetToSetting: () => addAssetToSetting,\n      refreshClients: () => refreshClients,\n      unsetAsset: () => unsetAsset,\n      setAsset: () => setAsset\n    });\n    let crypto;\n    module.link(\"crypto\", {\n      default(v) {\n        crypto = v;\n      }\n    }, 0);\n    let Settings;\n    module.link(\"@rocket.chat/models\", {\n      Settings(v) {\n        Settings = v;\n      }\n    }, 1);\n    let sizeOf;\n    module.link(\"image-size\", {\n      default(v) {\n        sizeOf = v;\n      }\n    }, 2);\n    let Meteor;\n    module.link(\"meteor/meteor\", {\n      Meteor(v) {\n        Meteor = v;\n      }\n    }, 3);\n    let WebApp, WebAppInternals;\n    module.link(\"meteor/webapp\", {\n      WebApp(v) {\n        WebApp = v;\n      },\n      WebAppInternals(v) {\n        WebAppInternals = v;\n      }\n    }, 4);\n    let sharp;\n    module.link(\"sharp\", {\n      default(v) {\n        sharp = v;\n      }\n    }, 5);\n    let hasPermissionAsync;\n    module.link(\"../../authorization/server/functions/hasPermission\", {\n      hasPermissionAsync(v) {\n        hasPermissionAsync = v;\n      }\n    }, 6);\n    let RocketChatFile;\n    module.link(\"../../file/server\", {\n      RocketChatFile(v) {\n        RocketChatFile = v;\n      }\n    }, 7);\n    let notifyOnSettingChangedById;\n    module.link(\"../../lib/server/lib/notifyListener\", {\n      notifyOnSettingChangedById(v) {\n        notifyOnSettingChangedById = v;\n      }\n    }, 8);\n    let settings, settingsRegistry;\n    module.link(\"../../settings/server\", {\n      settings(v) {\n        settings = v;\n      },\n      settingsRegistry(v) {\n        settingsRegistry = v;\n      }\n    }, 9);\n    let getExtension;\n    module.link(\"../../utils/lib/mimeTypes\", {\n      getExtension(v) {\n        getExtension = v;\n      }\n    }, 10);\n    let getURL;\n    module.link(\"../../utils/server/getURL\", {\n      getURL(v) {\n        getURL = v;\n      }\n    }, 11);\n    if (__reifyWaitForDeps__()) (await __reifyWaitForDeps__())();\n    const RocketChatAssetsInstance = new RocketChatFile.GridFS({\n      name: 'assets'\n    });\n    const assets = {\n      logo: {\n        label: 'logo (svg, png, jpg)',\n        defaultUrl: 'images/logo/logo.svg',\n        constraints: {\n          type: 'image',\n          extensions: ['svg', 'png', 'jpg', 'jpeg']\n        },\n        wizard: {\n          step: 3,\n          order: 2\n        }\n      },\n      logo_dark: {\n        label: 'logo - dark theme (svg, png, jpg)',\n        defaultUrl: 'images/logo/logo_dark.svg',\n        constraints: {\n          type: 'image',\n          extensions: ['svg', 'png', 'jpg', 'jpeg']\n        }\n      },\n      background: {\n        label: 'login background (svg, png, jpg)',\n        constraints: {\n          type: 'image',\n          extensions: ['svg', 'png', 'jpg', 'jpeg']\n        }\n      },\n      background_dark: {\n        label: 'login background - dark theme (svg, png, jpg)',\n        constraints: {\n          type: 'image',\n          extensions: ['svg', 'png', 'jpg', 'jpeg']\n        }\n      },\n      favicon_ico: {\n        label: 'favicon (ico)',\n        defaultUrl: 'favicon.ico',\n        constraints: {\n          type: 'image',\n          extensions: ['ico']\n        }\n      },\n      favicon: {\n        label: 'favicon (svg)',\n        defaultUrl: 'images/logo/icon.svg',\n        constraints: {\n          type: 'image',\n          extensions: ['svg']\n        }\n      },\n      favicon_16: {\n        label: 'favicon 16x16 (png)',\n        defaultUrl: 'images/logo/favicon-16x16.png',\n        constraints: {\n          type: 'image',\n          extensions: ['png'],\n          width: 16,\n          height: 16\n        }\n      },\n      favicon_32: {\n        label: 'favicon 32x32 (png)',\n        defaultUrl: 'images/logo/favicon-32x32.png',\n        constraints: {\n          type: 'image',\n          extensions: ['png'],\n          width: 32,\n          height: 32\n        }\n      },\n      favicon_192: {\n        label: 'android-chrome 192x192 (png)',\n        defaultUrl: 'images/logo/android-chrome-192x192.png',\n        constraints: {\n          type: 'image',\n          extensions: ['png'],\n          width: 192,\n          height: 192\n        }\n      },\n      favicon_512: {\n        label: 'android-chrome 512x512 (png)',\n        defaultUrl: 'images/logo/android-chrome-512x512.png',\n        constraints: {\n          type: 'image',\n          extensions: ['png'],\n          width: 512,\n          height: 512\n        }\n      },\n      touchicon_180: {\n        label: 'apple-touch-icon 180x180 (png)',\n        defaultUrl: 'images/logo/apple-touch-icon.png',\n        constraints: {\n          type: 'image',\n          extensions: ['png'],\n          width: 180,\n          height: 180\n        }\n      },\n      touchicon_180_pre: {\n        label: 'apple-touch-icon-precomposed 180x180 (png)',\n        defaultUrl: 'images/logo/apple-touch-icon-precomposed.png',\n        constraints: {\n          type: 'image',\n          extensions: ['png'],\n          width: 180,\n          height: 180\n        }\n      },\n      tile_70: {\n        label: 'mstile 70x70 (png)',\n        defaultUrl: 'images/logo/mstile-70x70.png',\n        constraints: {\n          type: 'image',\n          extensions: ['png'],\n          width: 70,\n          height: 70\n        }\n      },\n      tile_144: {\n        label: 'mstile 144x144 (png)',\n        defaultUrl: 'images/logo/mstile-144x144.png',\n        constraints: {\n          type: 'image',\n          extensions: ['png'],\n          width: 144,\n          height: 144\n        }\n      },\n      tile_150: {\n        label: 'mstile 150x150 (png)',\n        defaultUrl: 'images/logo/mstile-150x150.png',\n        constraints: {\n          type: 'image',\n          extensions: ['png'],\n          width: 150,\n          height: 150\n        }\n      },\n      tile_310_square: {\n        label: 'mstile 310x310 (png)',\n        defaultUrl: 'images/logo/mstile-310x310.png',\n        constraints: {\n          type: 'image',\n          extensions: ['png'],\n          width: 310,\n          height: 310\n        }\n      },\n      tile_310_wide: {\n        label: 'mstile 310x150 (png)',\n        defaultUrl: 'images/logo/mstile-310x150.png',\n        constraints: {\n          type: 'image',\n          extensions: ['png'],\n          width: 310,\n          height: 150\n        }\n      },\n      safari_pinned: {\n        label: 'safari pinned tab (svg)',\n        defaultUrl: 'images/logo/safari-pinned-tab.svg',\n        constraints: {\n          type: 'image',\n          extensions: ['svg']\n        }\n      },\n      livechat_widget_logo: {\n        label: 'widget logo (svg, png, jpg)',\n        constraints: {\n          type: 'image',\n          extensions: ['svg', 'png', 'jpg', 'jpeg']\n        },\n        settingOptions: {\n          section: 'Livechat',\n          group: 'Omnichannel',\n          invalidValue: {\n            defaultUrl: undefined\n          },\n          enableQuery: {\n            _id: 'Livechat_enabled',\n            value: true\n          },\n          enterprise: true,\n          modules: ['livechat-enterprise'],\n          sorter: 999 + 1\n        }\n      }\n    };\n    function getAssetByKey(key) {\n      return assets[key];\n    }\n    class RocketChatAssetsClass {\n      get assets() {\n        return assets;\n      }\n      async setAsset(binaryContent, contentType, asset) {\n        const file = Buffer.from(binaryContent, 'binary');\n        await this.setAssetWithBuffer(file, contentType, asset);\n      }\n      async setAssetWithBuffer(binaryContent, contentType, asset) {\n        await this._setAsset(binaryContent, contentType, asset);\n      }\n      async _setAsset(file, contentType, asset) {\n        const assetInstance = getAssetByKey(asset);\n        if (!assetInstance) {\n          throw new Meteor.Error('error-invalid-asset', 'Invalid asset', {\n            function: 'RocketChat.Assets.setAsset'\n          });\n        }\n        const extension = getExtension(contentType);\n        if (assetInstance.constraints.extensions.includes(extension) === false) {\n          throw new Meteor.Error('error-invalid-file-type', \"Invalid file type: \".concat(contentType), {\n            function: 'RocketChat.Assets.setAsset'\n          });\n        }\n        if (assetInstance.constraints.width || assetInstance.constraints.height) {\n          const dimensions = sizeOf(file);\n          if (assetInstance.constraints.width && assetInstance.constraints.width !== dimensions.width) {\n            throw new Meteor.Error('error-invalid-file-width', 'Invalid file width', {\n              function: 'Invalid file width'\n            });\n          }\n          if (assetInstance.constraints.height && assetInstance.constraints.height !== dimensions.height) {\n            throw new Meteor.Error('error-invalid-file-height');\n          }\n        }\n        const rs = RocketChatFile.bufferToStream(file);\n        await RocketChatAssetsInstance.deleteFile(asset);\n        const ws = RocketChatAssetsInstance.createWriteStream(asset, contentType);\n        ws.on('end', () => {\n          return setTimeout(async () => {\n            const key = \"Assets_\".concat(asset);\n            const value = {\n              url: \"assets/\".concat(asset, \".\").concat(extension),\n              defaultUrl: assetInstance.defaultUrl\n            };\n            void (async () => {\n              // TODO: audit\n              const {\n                modifiedCount\n              } = await Settings.updateValueById(key, value);\n              if (modifiedCount) {\n                void notifyOnSettingChangedById(key);\n              }\n            })();\n            return RocketChatAssets.processAsset(key, value);\n          }, 200);\n        });\n        rs.pipe(ws);\n      }\n      async unsetAsset(asset) {\n        if (!getAssetByKey(asset)) {\n          throw new Meteor.Error('error-invalid-asset', 'Invalid asset', {\n            function: 'RocketChat.Assets.unsetAsset'\n          });\n        }\n        await RocketChatAssetsInstance.deleteFile(asset);\n        const key = \"Assets_\".concat(asset);\n        const value = {\n          defaultUrl: getAssetByKey(asset).defaultUrl\n        };\n        void (async () => {\n          // TODO: audit\n          const {\n            modifiedCount\n          } = await Settings.updateValueById(key, value);\n          if (modifiedCount) {\n            void notifyOnSettingChangedById(key);\n          }\n        })();\n        await RocketChatAssets.processAsset(key, value);\n      }\n      refreshClients() {\n        return process.emit('message', {\n          refresh: 'client'\n        });\n      }\n      async processAsset(settingKey, settingValue) {\n        if (settingKey.indexOf('Assets_') !== 0) {\n          return;\n        }\n        const assetKey = settingKey.replace(/^Assets_/, '');\n        const assetValue = getAssetByKey(assetKey);\n        if (!assetValue) {\n          return;\n        }\n        if (!(settingValue !== null && settingValue !== void 0 && settingValue.url)) {\n          assetValue.cache = undefined;\n          return;\n        }\n        const file = await RocketChatAssetsInstance.getFile(assetKey);\n        if (!file) {\n          assetValue.cache = undefined;\n          return;\n        }\n        const hash = crypto.createHash('sha1').update(file.buffer).digest('hex');\n        const extension = settingValue.url.split('.').pop();\n        assetValue.cache = {\n          path: \"assets/\".concat(assetKey, \".\").concat(extension),\n          cacheable: false,\n          sourceMapUrl: undefined,\n          where: 'client',\n          type: 'asset',\n          content: file.buffer,\n          extension,\n          url: \"/assets/\".concat(assetKey, \".\").concat(extension, \"?\").concat(hash),\n          size: file.length,\n          uploadDate: file.uploadDate,\n          contentType: file.contentType,\n          hash\n        };\n        return assetValue.cache;\n      }\n      getURL(assetName) {\n        let options = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {\n          cdn: false,\n          full: true\n        };\n        const asset = settings.get(assetName);\n        const url = asset.url || asset.defaultUrl;\n        return getURL(url, options);\n      }\n    }\n    const RocketChatAssets = new RocketChatAssetsClass();\n    async function addAssetToSetting(asset, value, options) {\n      const key = \"Assets_\".concat(asset);\n      await settingsRegistry.add(key, {\n        defaultUrl: value.defaultUrl\n      }, _objectSpread({\n        type: 'asset',\n        group: 'Assets',\n        fileConstraints: value.constraints,\n        i18nLabel: value.label,\n        asset,\n        public: true\n      }, options));\n      const currentValue = settings.get(key);\n      if (currentValue && typeof currentValue === 'object' && currentValue.defaultUrl !== getAssetByKey(asset).defaultUrl) {\n        currentValue.defaultUrl = getAssetByKey(asset).defaultUrl;\n        (await Settings.updateValueById(key, currentValue)).modifiedCount && void notifyOnSettingChangedById(key);\n      }\n    }\n    void (async () => {\n      var _iteratorAbruptCompletion = false;\n      var _didIteratorError = false;\n      var _iteratorError;\n      try {\n        for (var _iterator = _asyncIterator(Object.keys(assets)), _step; _iteratorAbruptCompletion = !(_step = await _iterator.next()).done; _iteratorAbruptCompletion = false) {\n          const key = _step.value;\n          {\n            const _getAssetByKey = getAssetByKey(key),\n              {\n                wizard,\n                settingOptions\n              } = _getAssetByKey,\n              value = _objectWithoutProperties(_getAssetByKey, _excluded);\n            await addAssetToSetting(key, value, _objectSpread(_objectSpread({}, settingOptions), {}, {\n              wizard\n            }));\n          }\n        }\n      } catch (err) {\n        _didIteratorError = true;\n        _iteratorError = err;\n      } finally {\n        try {\n          if (_iteratorAbruptCompletion && _iterator.return != null) {\n            await _iterator.return();\n          }\n        } finally {\n          if (_didIteratorError) {\n            throw _iteratorError;\n          }\n        }\n      }\n    })();\n    settings.watchByRegex(/^Assets_/, (key, value) => RocketChatAssets.processAsset(key, value));\n    Meteor.startup(() => {\n      setTimeout(() => {\n        process.emit('message', {\n          refresh: 'client'\n        });\n      }, 200);\n    });\n    const refreshClients = async userId => {\n      if (!userId) {\n        throw new Error('Invalid user');\n      }\n      const _hasPermission = await hasPermissionAsync(userId, 'manage-assets');\n      if (!_hasPermission) {\n        throw new Error('Managing assets not allowed');\n      }\n      return RocketChatAssets.refreshClients();\n    };\n    const unsetAsset = async (userId, asset) => {\n      if (!userId) {\n        throw new Error('Invalid user');\n      }\n      const _hasPermission = await hasPermissionAsync(userId, 'manage-assets');\n      if (!_hasPermission) {\n        throw new Error('Managing assets not allowed');\n      }\n      return RocketChatAssets.unsetAsset(asset);\n    };\n    const setAsset = async (userId, binaryContent, contentType, asset) => {\n      if (!userId) {\n        throw new Error('Invalid user');\n      }\n      const _hasPermission = await hasPermissionAsync(userId, 'manage-assets');\n      if (!_hasPermission) {\n        throw new Error('Managing assets not allowed');\n      }\n      await RocketChatAssets.setAssetWithBuffer(binaryContent, contentType, asset);\n    };\n    const listener = (req, res, next) => {\n      var _file$uploadDate2;\n      if (!req.url) {\n        return;\n      }\n      const params = {\n        asset: decodeURIComponent(req.url.replace(/^\\//, '').replace(/\\?.*$/, '')).replace(/\\.[^.]*$/, '')\n      };\n      const asset = getAssetByKey(params.asset);\n      const file = asset === null || asset === void 0 ? void 0 : asset.cache;\n      const format = req.url.replace(/.*\\.([a-z]+)(?:$|\\?.*)/i, '$1');\n      if (asset && Array.isArray(asset.constraints.extensions) && !asset.constraints.extensions.includes(format)) {\n        res.writeHead(403);\n        return res.end();\n      }\n      if (!file) {\n        const defaultUrl = asset === null || asset === void 0 ? void 0 : asset.defaultUrl;\n        if (defaultUrl) {\n          const assetUrl = format && ['png', 'svg'].includes(format) ? defaultUrl.replace(/(svg|png)$/, format) : defaultUrl;\n          req.url = \"/\".concat(assetUrl);\n          WebAppInternals.staticFilesMiddleware(WebAppInternals.staticFilesByArch, req, res, next);\n        } else {\n          res.writeHead(404);\n          res.end();\n        }\n        return;\n      }\n      const reqModifiedHeader = req.headers['if-modified-since'];\n      if (reqModifiedHeader) {\n        var _file$uploadDate;\n        if (reqModifiedHeader === ((_file$uploadDate = file.uploadDate) === null || _file$uploadDate === void 0 ? void 0 : _file$uploadDate.toUTCString())) {\n          res.setHeader('Last-Modified', reqModifiedHeader);\n          res.writeHead(304);\n          res.end();\n          return;\n        }\n      }\n      res.setHeader('Cache-Control', 'public, max-age=0');\n      res.setHeader('Expires', '-1');\n      if (format && format !== file.extension && ['png', 'jpg', 'jpeg'].includes(format)) {\n        res.setHeader('Content-Type', \"image/\".concat(format));\n        sharp(file.content).toFormat(format).pipe(res);\n        return;\n      }\n      res.setHeader('Last-Modified', ((_file$uploadDate2 = file.uploadDate) === null || _file$uploadDate2 === void 0 ? void 0 : _file$uploadDate2.toUTCString()) || new Date().toUTCString());\n      if (file.contentType) res.setHeader('Content-Type', file.contentType);\n      if (file.size) res.setHeader('Content-Length', file.size);\n      res.writeHead(200);\n      res.end(file.content);\n    };\n    WebApp.connectHandlers.use('/assets/', listener);\n    __reify_async_result__();\n  } catch (_reifyError) {\n    return __reify_async_result__(_reifyError);\n  }\n  __reify_async_result__()\n}, {\n  self: this,\n  async: false\n});","map":{"version":3,"names":["_objectWithoutProperties","module","link","default","v","_objectSpread","_asyncIterator","_excluded","export","RocketChatAssets","addAssetToSetting","refreshClients","unsetAsset","setAsset","crypto","Settings","sizeOf","Meteor","WebApp","WebAppInternals","sharp","hasPermissionAsync","RocketChatFile","notifyOnSettingChangedById","settings","settingsRegistry","getExtension","getURL","__reifyWaitForDeps__","RocketChatAssetsInstance","GridFS","name","assets","logo","label","defaultUrl","constraints","type","extensions","wizard","step","order","logo_dark","background","background_dark","favicon_ico","favicon","favicon_16","width","height","favicon_32","favicon_192","favicon_512","touchicon_180","touchicon_180_pre","tile_70","tile_144","tile_150","tile_310_square","tile_310_wide","safari_pinned","livechat_widget_logo","settingOptions","section","group","invalidValue","undefined","enableQuery","_id","value","enterprise","modules","sorter","getAssetByKey","key","RocketChatAssetsClass","binaryContent","contentType","asset","file","Buffer","from","setAssetWithBuffer","_setAsset","assetInstance","Error","function","extension","includes","concat","dimensions","rs","bufferToStream","deleteFile","ws","createWriteStream","on","setTimeout","url","modifiedCount","updateValueById","processAsset","pipe","process","emit","refresh","settingKey","settingValue","indexOf","assetKey","replace","assetValue","cache","getFile","hash","createHash","update","buffer","digest","split","pop","path","cacheable","sourceMapUrl","where","content","size","length","uploadDate","assetName","options","arguments","cdn","full","get","add","fileConstraints","i18nLabel","public","currentValue","_iteratorAbruptCompletion","_didIteratorError","_iteratorError","_iterator","Object","keys","_step","next","done","_getAssetByKey","err","return","watchByRegex","startup","userId","_hasPermission","listener","req","res","_file$uploadDate2","params","decodeURIComponent","format","Array","isArray","writeHead","end","assetUrl","staticFilesMiddleware","staticFilesByArch","reqModifiedHeader","headers","_file$uploadDate","toUTCString","setHeader","toFormat","Date","connectHandlers","use","__reify_async_result__","_reifyError","self","async"],"sources":["app/assets/server/assets.ts"],"sourcesContent":["import crypto from 'crypto';\nimport type { ServerResponse, IncomingMessage } from 'http';\n\nimport type { IRocketChatAssets, IRocketChatAsset, ISetting } from '@rocket.chat/core-typings';\nimport { Settings } from '@rocket.chat/models';\nimport type { NextHandleFunction } from 'connect';\nimport sizeOf from 'image-size';\nimport { Meteor } from 'meteor/meteor';\nimport { WebApp, WebAppInternals } from 'meteor/webapp';\nimport sharp from 'sharp';\n\nimport { hasPermissionAsync } from '../../authorization/server/functions/hasPermission';\nimport { RocketChatFile } from '../../file/server';\nimport { notifyOnSettingChangedById } from '../../lib/server/lib/notifyListener';\nimport { settings, settingsRegistry } from '../../settings/server';\nimport { getExtension } from '../../utils/lib/mimeTypes';\nimport { getURL } from '../../utils/server/getURL';\n\nconst RocketChatAssetsInstance = new RocketChatFile.GridFS({\n\tname: 'assets',\n});\n\ntype IRocketChatAssetsConfig = Record<keyof IRocketChatAssets, IRocketChatAsset & { settingOptions?: Partial<ISetting> }>;\n\nconst assets: IRocketChatAssetsConfig = {\n\tlogo: {\n\t\tlabel: 'logo (svg, png, jpg)',\n\t\tdefaultUrl: 'images/logo/logo.svg',\n\t\tconstraints: {\n\t\t\ttype: 'image',\n\t\t\textensions: ['svg', 'png', 'jpg', 'jpeg'],\n\t\t},\n\t\twizard: {\n\t\t\tstep: 3,\n\t\t\torder: 2,\n\t\t},\n\t},\n\tlogo_dark: {\n\t\tlabel: 'logo - dark theme (svg, png, jpg)',\n\t\tdefaultUrl: 'images/logo/logo_dark.svg',\n\t\tconstraints: {\n\t\t\ttype: 'image',\n\t\t\textensions: ['svg', 'png', 'jpg', 'jpeg'],\n\t\t},\n\t},\n\tbackground: {\n\t\tlabel: 'login background (svg, png, jpg)',\n\t\tconstraints: {\n\t\t\ttype: 'image',\n\t\t\textensions: ['svg', 'png', 'jpg', 'jpeg'],\n\t\t},\n\t},\n\tbackground_dark: {\n\t\tlabel: 'login background - dark theme (svg, png, jpg)',\n\t\tconstraints: {\n\t\t\ttype: 'image',\n\t\t\textensions: ['svg', 'png', 'jpg', 'jpeg'],\n\t\t},\n\t},\n\tfavicon_ico: {\n\t\tlabel: 'favicon (ico)',\n\t\tdefaultUrl: 'favicon.ico',\n\t\tconstraints: {\n\t\t\ttype: 'image',\n\t\t\textensions: ['ico'],\n\t\t},\n\t},\n\tfavicon: {\n\t\tlabel: 'favicon (svg)',\n\t\tdefaultUrl: 'images/logo/icon.svg',\n\t\tconstraints: {\n\t\t\ttype: 'image',\n\t\t\textensions: ['svg'],\n\t\t},\n\t},\n\tfavicon_16: {\n\t\tlabel: 'favicon 16x16 (png)',\n\t\tdefaultUrl: 'images/logo/favicon-16x16.png',\n\t\tconstraints: {\n\t\t\ttype: 'image',\n\t\t\textensions: ['png'],\n\t\t\twidth: 16,\n\t\t\theight: 16,\n\t\t},\n\t},\n\tfavicon_32: {\n\t\tlabel: 'favicon 32x32 (png)',\n\t\tdefaultUrl: 'images/logo/favicon-32x32.png',\n\t\tconstraints: {\n\t\t\ttype: 'image',\n\t\t\textensions: ['png'],\n\t\t\twidth: 32,\n\t\t\theight: 32,\n\t\t},\n\t},\n\tfavicon_192: {\n\t\tlabel: 'android-chrome 192x192 (png)',\n\t\tdefaultUrl: 'images/logo/android-chrome-192x192.png',\n\t\tconstraints: {\n\t\t\ttype: 'image',\n\t\t\textensions: ['png'],\n\t\t\twidth: 192,\n\t\t\theight: 192,\n\t\t},\n\t},\n\tfavicon_512: {\n\t\tlabel: 'android-chrome 512x512 (png)',\n\t\tdefaultUrl: 'images/logo/android-chrome-512x512.png',\n\t\tconstraints: {\n\t\t\ttype: 'image',\n\t\t\textensions: ['png'],\n\t\t\twidth: 512,\n\t\t\theight: 512,\n\t\t},\n\t},\n\ttouchicon_180: {\n\t\tlabel: 'apple-touch-icon 180x180 (png)',\n\t\tdefaultUrl: 'images/logo/apple-touch-icon.png',\n\t\tconstraints: {\n\t\t\ttype: 'image',\n\t\t\textensions: ['png'],\n\t\t\twidth: 180,\n\t\t\theight: 180,\n\t\t},\n\t},\n\ttouchicon_180_pre: {\n\t\tlabel: 'apple-touch-icon-precomposed 180x180 (png)',\n\t\tdefaultUrl: 'images/logo/apple-touch-icon-precomposed.png',\n\t\tconstraints: {\n\t\t\ttype: 'image',\n\t\t\textensions: ['png'],\n\t\t\twidth: 180,\n\t\t\theight: 180,\n\t\t},\n\t},\n\ttile_70: {\n\t\tlabel: 'mstile 70x70 (png)',\n\t\tdefaultUrl: 'images/logo/mstile-70x70.png',\n\t\tconstraints: {\n\t\t\ttype: 'image',\n\t\t\textensions: ['png'],\n\t\t\twidth: 70,\n\t\t\theight: 70,\n\t\t},\n\t},\n\ttile_144: {\n\t\tlabel: 'mstile 144x144 (png)',\n\t\tdefaultUrl: 'images/logo/mstile-144x144.png',\n\t\tconstraints: {\n\t\t\ttype: 'image',\n\t\t\textensions: ['png'],\n\t\t\twidth: 144,\n\t\t\theight: 144,\n\t\t},\n\t},\n\ttile_150: {\n\t\tlabel: 'mstile 150x150 (png)',\n\t\tdefaultUrl: 'images/logo/mstile-150x150.png',\n\t\tconstraints: {\n\t\t\ttype: 'image',\n\t\t\textensions: ['png'],\n\t\t\twidth: 150,\n\t\t\theight: 150,\n\t\t},\n\t},\n\ttile_310_square: {\n\t\tlabel: 'mstile 310x310 (png)',\n\t\tdefaultUrl: 'images/logo/mstile-310x310.png',\n\t\tconstraints: {\n\t\t\ttype: 'image',\n\t\t\textensions: ['png'],\n\t\t\twidth: 310,\n\t\t\theight: 310,\n\t\t},\n\t},\n\ttile_310_wide: {\n\t\tlabel: 'mstile 310x150 (png)',\n\t\tdefaultUrl: 'images/logo/mstile-310x150.png',\n\t\tconstraints: {\n\t\t\ttype: 'image',\n\t\t\textensions: ['png'],\n\t\t\twidth: 310,\n\t\t\theight: 150,\n\t\t},\n\t},\n\tsafari_pinned: {\n\t\tlabel: 'safari pinned tab (svg)',\n\t\tdefaultUrl: 'images/logo/safari-pinned-tab.svg',\n\t\tconstraints: {\n\t\t\ttype: 'image',\n\t\t\textensions: ['svg'],\n\t\t},\n\t},\n\tlivechat_widget_logo: {\n\t\tlabel: 'widget logo (svg, png, jpg)',\n\t\tconstraints: {\n\t\t\ttype: 'image',\n\t\t\textensions: ['svg', 'png', 'jpg', 'jpeg'],\n\t\t},\n\t\tsettingOptions: {\n\t\t\tsection: 'Livechat',\n\t\t\tgroup: 'Omnichannel',\n\t\t\tinvalidValue: {\n\t\t\t\tdefaultUrl: undefined,\n\t\t\t},\n\t\t\tenableQuery: { _id: 'Livechat_enabled', value: true },\n\t\t\tenterprise: true,\n\t\t\tmodules: ['livechat-enterprise'],\n\t\t\tsorter: 999 + 1,\n\t\t},\n\t},\n};\n\nfunction getAssetByKey(key: string) {\n\treturn assets[key as keyof IRocketChatAssets];\n}\n\nclass RocketChatAssetsClass {\n\tget assets(): IRocketChatAssets {\n\t\treturn assets;\n\t}\n\n\tpublic async setAsset(binaryContent: string, contentType: string, asset: string): Promise<void> {\n\t\tconst file = Buffer.from(binaryContent, 'binary');\n\t\tawait this.setAssetWithBuffer(file, contentType, asset);\n\t}\n\n\tpublic async setAssetWithBuffer(binaryContent: Buffer, contentType: string, asset: string): Promise<void> {\n\t\tawait this._setAsset(binaryContent, contentType, asset);\n\t}\n\n\tprivate async _setAsset(file: Buffer, contentType: string, asset: string): Promise<void> {\n\t\tconst assetInstance = getAssetByKey(asset);\n\t\tif (!assetInstance) {\n\t\t\tthrow new Meteor.Error('error-invalid-asset', 'Invalid asset', {\n\t\t\t\tfunction: 'RocketChat.Assets.setAsset',\n\t\t\t});\n\t\t}\n\n\t\tconst extension = getExtension(contentType);\n\t\tif (assetInstance.constraints.extensions.includes(extension) === false) {\n\t\t\tthrow new Meteor.Error('error-invalid-file-type', `Invalid file type: ${contentType}`, {\n\t\t\t\tfunction: 'RocketChat.Assets.setAsset',\n\t\t\t});\n\t\t}\n\n\t\tif (assetInstance.constraints.width || assetInstance.constraints.height) {\n\t\t\tconst dimensions = sizeOf(file);\n\t\t\tif (assetInstance.constraints.width && assetInstance.constraints.width !== dimensions.width) {\n\t\t\t\tthrow new Meteor.Error('error-invalid-file-width', 'Invalid file width', {\n\t\t\t\t\tfunction: 'Invalid file width',\n\t\t\t\t});\n\t\t\t}\n\t\t\tif (assetInstance.constraints.height && assetInstance.constraints.height !== dimensions.height) {\n\t\t\t\tthrow new Meteor.Error('error-invalid-file-height');\n\t\t\t}\n\t\t}\n\n\t\tconst rs = RocketChatFile.bufferToStream(file);\n\t\tawait RocketChatAssetsInstance.deleteFile(asset);\n\n\t\tconst ws = RocketChatAssetsInstance.createWriteStream(asset, contentType);\n\t\tws.on('end', () => {\n\t\t\treturn setTimeout(async () => {\n\t\t\t\tconst key = `Assets_${asset}`;\n\t\t\t\tconst value = {\n\t\t\t\t\turl: `assets/${asset}.${extension}`,\n\t\t\t\t\tdefaultUrl: assetInstance.defaultUrl,\n\t\t\t\t};\n\n\t\t\t\tvoid (async () => {\n\t\t\t\t\t// TODO: audit\n\t\t\t\t\tconst { modifiedCount } = await Settings.updateValueById(key, value);\n\t\t\t\t\tif (modifiedCount) {\n\t\t\t\t\t\tvoid notifyOnSettingChangedById(key);\n\t\t\t\t\t}\n\t\t\t\t})();\n\n\t\t\t\treturn RocketChatAssets.processAsset(key, value);\n\t\t\t}, 200);\n\t\t});\n\n\t\trs.pipe(ws);\n\t}\n\n\tpublic async unsetAsset(asset: string): Promise<void> {\n\t\tif (!getAssetByKey(asset)) {\n\t\t\tthrow new Meteor.Error('error-invalid-asset', 'Invalid asset', {\n\t\t\t\tfunction: 'RocketChat.Assets.unsetAsset',\n\t\t\t});\n\t\t}\n\n\t\tawait RocketChatAssetsInstance.deleteFile(asset);\n\t\tconst key = `Assets_${asset}`;\n\t\tconst value = {\n\t\t\tdefaultUrl: getAssetByKey(asset).defaultUrl,\n\t\t};\n\n\t\tvoid (async () => {\n\t\t\t// TODO: audit\n\t\t\tconst { modifiedCount } = await Settings.updateValueById(key, value);\n\t\t\tif (modifiedCount) {\n\t\t\t\tvoid notifyOnSettingChangedById(key);\n\t\t\t}\n\t\t})();\n\n\t\tawait RocketChatAssets.processAsset(key, value);\n\t}\n\n\tpublic refreshClients(): boolean {\n\t\treturn process.emit('message', {\n\t\t\trefresh: 'client',\n\t\t});\n\t}\n\n\tpublic async processAsset(settingKey: string, settingValue: any): Promise<Record<string, any> | undefined> {\n\t\tif (settingKey.indexOf('Assets_') !== 0) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst assetKey = settingKey.replace(/^Assets_/, '');\n\t\tconst assetValue = getAssetByKey(assetKey);\n\n\t\tif (!assetValue) {\n\t\t\treturn;\n\t\t}\n\n\t\tif (!settingValue?.url) {\n\t\t\tassetValue.cache = undefined;\n\t\t\treturn;\n\t\t}\n\n\t\tconst file = await RocketChatAssetsInstance.getFile(assetKey);\n\t\tif (!file) {\n\t\t\tassetValue.cache = undefined;\n\t\t\treturn;\n\t\t}\n\n\t\tconst hash = crypto.createHash('sha1').update(file.buffer).digest('hex');\n\t\tconst extension = settingValue.url.split('.').pop();\n\n\t\tassetValue.cache = {\n\t\t\tpath: `assets/${assetKey}.${extension}`,\n\t\t\tcacheable: false,\n\t\t\tsourceMapUrl: undefined,\n\t\t\twhere: 'client',\n\t\t\ttype: 'asset',\n\t\t\tcontent: file.buffer,\n\t\t\textension,\n\t\t\turl: `/assets/${assetKey}.${extension}?${hash}`,\n\t\t\tsize: file.length,\n\t\t\tuploadDate: file.uploadDate,\n\t\t\tcontentType: file.contentType,\n\t\t\thash,\n\t\t};\n\n\t\treturn assetValue.cache;\n\t}\n\n\tpublic getURL(assetName: string, options = { cdn: false, full: true }): string {\n\t\tconst asset = settings.get<IRocketChatAsset>(assetName);\n\t\tconst url = asset.url || asset.defaultUrl;\n\n\t\treturn getURL(url as string, options);\n\t}\n}\n\nexport const RocketChatAssets = new RocketChatAssetsClass();\n\nexport async function addAssetToSetting(asset: string, value: IRocketChatAsset, options?: Partial<ISetting>): Promise<void> {\n\tconst key = `Assets_${asset}`;\n\n\tawait settingsRegistry.add(\n\t\tkey,\n\t\t{\n\t\t\tdefaultUrl: value.defaultUrl,\n\t\t},\n\t\t{\n\t\t\ttype: 'asset',\n\t\t\tgroup: 'Assets',\n\t\t\tfileConstraints: value.constraints,\n\t\t\ti18nLabel: value.label,\n\t\t\tasset,\n\t\t\tpublic: true,\n\t\t\t...options,\n\t\t},\n\t);\n\n\tconst currentValue = settings.get<IRocketChatAsset>(key);\n\n\tif (currentValue && typeof currentValue === 'object' && currentValue.defaultUrl !== getAssetByKey(asset).defaultUrl) {\n\t\tcurrentValue.defaultUrl = getAssetByKey(asset).defaultUrl;\n\n\t\t(await Settings.updateValueById(key, currentValue)).modifiedCount && void notifyOnSettingChangedById(key);\n\t}\n}\n\nvoid (async () => {\n\tfor await (const key of Object.keys(assets)) {\n\t\tconst { wizard, settingOptions, ...value } = getAssetByKey(key);\n\t\tawait addAssetToSetting(key, value, { ...settingOptions, wizard });\n\t}\n})();\n\nsettings.watchByRegex(/^Assets_/, (key, value) => RocketChatAssets.processAsset(key, value));\n\nMeteor.startup(() => {\n\tsetTimeout(() => {\n\t\tprocess.emit('message', {\n\t\t\trefresh: 'client',\n\t\t});\n\t}, 200);\n});\n\nexport const refreshClients = async (userId: string) => {\n\tif (!userId) {\n\t\tthrow new Error('Invalid user');\n\t}\n\n\tconst _hasPermission = await hasPermissionAsync(userId, 'manage-assets');\n\tif (!_hasPermission) {\n\t\tthrow new Error('Managing assets not allowed');\n\t}\n\n\treturn RocketChatAssets.refreshClients();\n};\n\nexport const unsetAsset = async (userId: string, asset: string) => {\n\tif (!userId) {\n\t\tthrow new Error('Invalid user');\n\t}\n\n\tconst _hasPermission = await hasPermissionAsync(userId, 'manage-assets');\n\tif (!_hasPermission) {\n\t\tthrow new Error('Managing assets not allowed');\n\t}\n\n\treturn RocketChatAssets.unsetAsset(asset);\n};\n\nexport const setAsset = async (userId: string, binaryContent: Buffer, contentType: string, asset: string) => {\n\tif (!userId) {\n\t\tthrow new Error('Invalid user');\n\t}\n\n\tconst _hasPermission = await hasPermissionAsync(userId, 'manage-assets');\n\tif (!_hasPermission) {\n\t\tthrow new Error('Managing assets not allowed');\n\t}\n\n\tawait RocketChatAssets.setAssetWithBuffer(binaryContent, contentType, asset);\n};\n\nconst listener = (req: IncomingMessage, res: ServerResponse, next: NextHandleFunction) => {\n\tif (!req.url) {\n\t\treturn;\n\t}\n\tconst params = {\n\t\tasset: decodeURIComponent(req.url.replace(/^\\//, '').replace(/\\?.*$/, '')).replace(/\\.[^.]*$/, ''),\n\t};\n\n\tconst asset = getAssetByKey(params.asset);\n\tconst file = asset?.cache;\n\n\tconst format = req.url.replace(/.*\\.([a-z]+)(?:$|\\?.*)/i, '$1');\n\n\tif (asset && Array.isArray(asset.constraints.extensions) && !asset.constraints.extensions.includes(format)) {\n\t\tres.writeHead(403);\n\t\treturn res.end();\n\t}\n\tif (!file) {\n\t\tconst defaultUrl = asset?.defaultUrl;\n\t\tif (defaultUrl) {\n\t\t\tconst assetUrl = format && ['png', 'svg'].includes(format) ? defaultUrl.replace(/(svg|png)$/, format) : defaultUrl;\n\t\t\treq.url = `/${assetUrl}`;\n\t\t\tWebAppInternals.staticFilesMiddleware((WebAppInternals as Record<string, any>).staticFilesByArch, req, res, next);\n\t\t} else {\n\t\t\tres.writeHead(404);\n\t\t\tres.end();\n\t\t}\n\n\t\treturn;\n\t}\n\n\tconst reqModifiedHeader = req.headers['if-modified-since'];\n\tif (reqModifiedHeader) {\n\t\tif (reqModifiedHeader === file.uploadDate?.toUTCString()) {\n\t\t\tres.setHeader('Last-Modified', reqModifiedHeader);\n\t\t\tres.writeHead(304);\n\t\t\tres.end();\n\t\t\treturn;\n\t\t}\n\t}\n\n\tres.setHeader('Cache-Control', 'public, max-age=0');\n\tres.setHeader('Expires', '-1');\n\n\tif (format && format !== file.extension && ['png', 'jpg', 'jpeg'].includes(format)) {\n\t\tres.setHeader('Content-Type', `image/${format}`);\n\t\tsharp(file.content)\n\t\t\t.toFormat(format as any)\n\t\t\t.pipe(res);\n\t\treturn;\n\t}\n\n\tres.setHeader('Last-Modified', file.uploadDate?.toUTCString() || new Date().toUTCString());\n\tif (file.contentType) res.setHeader('Content-Type', file.contentType);\n\tif (file.size) res.setHeader('Content-Length', file.size);\n\tres.writeHead(200);\n\tres.end(file.content);\n};\n\nWebApp.connectHandlers.use('/assets/', listener);\n"],"mappings":"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","ignoreList":[]},"sourceType":"module","externalDependencies":{},"hash":"86ed5fe7205fc1a7ef359f7287273d59ed2f5c6c"}
