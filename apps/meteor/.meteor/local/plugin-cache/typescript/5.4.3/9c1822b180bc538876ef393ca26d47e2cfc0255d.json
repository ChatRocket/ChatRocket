{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/app/livechat/server/lib/routing/External.ts","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","topLevelAwait","objectRestSpread","objectRestSpread","asyncGenerators","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"os.osx.arm64"},"sourceFileName":"app/livechat/server/lib/routing/External.ts","filename":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/app/livechat/server/lib/routing/External.ts","inputSourceMap":{"version":3,"file":"app/livechat/server/lib/routing/External.ts","sourceRoot":"","sources":["app/livechat/server/lib/routing/External.ts"],"names":[],"mappings":"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","sourcesContent":["import type { IRoutingMethod, RoutingMethodConfig, SelectedAgent } from '@rocket.chat/core-typings';\nimport { Users } from '@rocket.chat/models';\nimport { serverFetch as fetch } from '@rocket.chat/server-fetch';\nimport { Meteor } from 'meteor/meteor';\n\nimport { SystemLogger } from '../../../../../server/lib/logger/system';\nimport { settings } from '../../../../settings/server';\nimport { RoutingManager } from '../RoutingManager';\n\nclass ExternalQueue implements IRoutingMethod {\n\tconfig: RoutingMethodConfig;\n\n\tconstructor() {\n\t\tthis.config = {\n\t\t\tpreviewRoom: false,\n\t\t\tshowConnecting: false,\n\t\t\tshowQueue: false,\n\t\t\tshowQueueLink: false,\n\t\t\treturnQueue: false,\n\t\t\tenableTriggerAction: true,\n\t\t\tautoAssignAgent: true,\n\t\t};\n\t}\n\n\tasync getNextAgent(department?: string, ignoreAgentId?: string): Promise<SelectedAgent | null | undefined> {\n\t\tconst promises = [];\n\t\tfor (let i = 0; i < 10; i++) {\n\t\t\tpromises.push(this.getAgentFromExternalQueue(department, ignoreAgentId));\n\t\t}\n\t\ttry {\n\t\t\tconst results = (await Promise.all(promises)).filter(Boolean);\n\t\t\tif (!results.length) {\n\t\t\t\tthrow new Meteor.Error('no-agent-online', 'Sorry, no online agents');\n\t\t\t}\n\t\t\treturn results[0];\n\t\t} catch (err) {\n\t\t\tSystemLogger.error({ msg: 'Error requesting agent from external queue.', err });\n\t\t\tthrow err;\n\t\t}\n\t}\n\n\tprivate async getAgentFromExternalQueue(department?: string, ignoreAgentId?: string): Promise<SelectedAgent | null | undefined> {\n\t\ttry {\n\t\t\tconst request = await fetch(`${settings.get('Livechat_External_Queue_URL')}`, {\n\t\t\t\theaders: {\n\t\t\t\t\t'User-Agent': 'RocketChat Server',\n\t\t\t\t\t'Accept': 'application/json',\n\t\t\t\t\t'X-RocketChat-Secret-Token': settings.get('Livechat_External_Queue_Token'),\n\t\t\t\t},\n\t\t\t\tparams: {\n\t\t\t\t\t...(department && { departmentId: department }),\n\t\t\t\t\t...(ignoreAgentId && { ignoreAgentId }),\n\t\t\t\t},\n\t\t\t});\n\t\t\tconst result = (await request.json()) as { username?: string };\n\n\t\t\tif (result?.username) {\n\t\t\t\tconst agent = await Users.findOneOnlineAgentByUserList(result.username);\n\n\t\t\t\tif (!agent?.username) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\treturn {\n\t\t\t\t\tagentId: agent._id,\n\t\t\t\t\tusername: agent.username,\n\t\t\t\t};\n\t\t\t}\n\t\t} catch (err) {\n\t\t\tSystemLogger.error({ msg: 'Error requesting agent from external queue.', err });\n\t\t}\n\t}\n}\n\nRoutingManager.registerMethod('External', ExternalQueue);\n"]},"targets":{"android":"125.0.0","chrome":"125.0.0","edge":"125.0.0","firefox":"115.0.0","ie":"10.0.0","ios":"17.4.0","opera":"110.0.0","opera_mobile":"80.0.0","safari":"17.4.0","samsung":"24.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor","root":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":false,"enforceStrictMode":false,"dynamicImport":true,"generateLetDeclarations":true,"topLevelAwait":true},"externalDependencies":[]},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"version":"7.17.2","helpers":true,"useESModules":false,"corejs":false},"externalDependencies":[]},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-async-generator-functions","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-class-properties","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true},"externalDependencies":[]},{"key":"transform-react-jsx","visitor":{"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXFragment":{"exit":[null]},"JSXElement":{"exit":[null]},"JSXAttribute":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false},"externalDependencies":[]},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-nullish-coalescing-operator","visitor":{"LogicalExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-optional-chaining","visitor":{"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-optional-catch-binding","visitor":{"CatchClause":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-class-properties","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-async-generator-functions","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-logical-assignment-operators","visitor":{"AssignmentExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]}],"presets":[],"generatorOpts":{"filename":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/app/livechat/server/lib/routing/External.ts","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"app/livechat/server/lib/routing/External.ts","inputSourceMap":{"version":3,"file":"app/livechat/server/lib/routing/External.ts","sourceRoot":"","sources":["app/livechat/server/lib/routing/External.ts"],"names":[],"mappings":"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","sourcesContent":["import type { IRoutingMethod, RoutingMethodConfig, SelectedAgent } from '@rocket.chat/core-typings';\nimport { Users } from '@rocket.chat/models';\nimport { serverFetch as fetch } from '@rocket.chat/server-fetch';\nimport { Meteor } from 'meteor/meteor';\n\nimport { SystemLogger } from '../../../../../server/lib/logger/system';\nimport { settings } from '../../../../settings/server';\nimport { RoutingManager } from '../RoutingManager';\n\nclass ExternalQueue implements IRoutingMethod {\n\tconfig: RoutingMethodConfig;\n\n\tconstructor() {\n\t\tthis.config = {\n\t\t\tpreviewRoom: false,\n\t\t\tshowConnecting: false,\n\t\t\tshowQueue: false,\n\t\t\tshowQueueLink: false,\n\t\t\treturnQueue: false,\n\t\t\tenableTriggerAction: true,\n\t\t\tautoAssignAgent: true,\n\t\t};\n\t}\n\n\tasync getNextAgent(department?: string, ignoreAgentId?: string): Promise<SelectedAgent | null | undefined> {\n\t\tconst promises = [];\n\t\tfor (let i = 0; i < 10; i++) {\n\t\t\tpromises.push(this.getAgentFromExternalQueue(department, ignoreAgentId));\n\t\t}\n\t\ttry {\n\t\t\tconst results = (await Promise.all(promises)).filter(Boolean);\n\t\t\tif (!results.length) {\n\t\t\t\tthrow new Meteor.Error('no-agent-online', 'Sorry, no online agents');\n\t\t\t}\n\t\t\treturn results[0];\n\t\t} catch (err) {\n\t\t\tSystemLogger.error({ msg: 'Error requesting agent from external queue.', err });\n\t\t\tthrow err;\n\t\t}\n\t}\n\n\tprivate async getAgentFromExternalQueue(department?: string, ignoreAgentId?: string): Promise<SelectedAgent | null | undefined> {\n\t\ttry {\n\t\t\tconst request = await fetch(`${settings.get('Livechat_External_Queue_URL')}`, {\n\t\t\t\theaders: {\n\t\t\t\t\t'User-Agent': 'RocketChat Server',\n\t\t\t\t\t'Accept': 'application/json',\n\t\t\t\t\t'X-RocketChat-Secret-Token': settings.get('Livechat_External_Queue_Token'),\n\t\t\t\t},\n\t\t\t\tparams: {\n\t\t\t\t\t...(department && { departmentId: department }),\n\t\t\t\t\t...(ignoreAgentId && { ignoreAgentId }),\n\t\t\t\t},\n\t\t\t});\n\t\t\tconst result = (await request.json()) as { username?: string };\n\n\t\t\tif (result?.username) {\n\t\t\t\tconst agent = await Users.findOneOnlineAgentByUserList(result.username);\n\n\t\t\t\tif (!agent?.username) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\treturn {\n\t\t\t\t\tagentId: agent._id,\n\t\t\t\t\tusername: agent.username,\n\t\t\t\t};\n\t\t\t}\n\t\t} catch (err) {\n\t\t\tSystemLogger.error({ msg: 'Error requesting agent from external queue.', err });\n\t\t}\n\t}\n}\n\nRoutingManager.registerMethod('External', ExternalQueue);\n"]}}},"code":"!module.wrapAsync(async function (module, __reifyWaitForDeps__, __reify_async_result__) {\n  \"use strict\";\n  try {\n    let _objectSpread;\n    module.link(\"@babel/runtime/helpers/objectSpread2\", {\n      default(v) {\n        _objectSpread = v;\n      }\n    }, 0);\n    let Users;\n    module.link(\"@rocket.chat/models\", {\n      Users(v) {\n        Users = v;\n      }\n    }, 0);\n    let fetch;\n    module.link(\"@rocket.chat/server-fetch\", {\n      serverFetch(v) {\n        fetch = v;\n      }\n    }, 1);\n    let Meteor;\n    module.link(\"meteor/meteor\", {\n      Meteor(v) {\n        Meteor = v;\n      }\n    }, 2);\n    let SystemLogger;\n    module.link(\"../../../../../server/lib/logger/system\", {\n      SystemLogger(v) {\n        SystemLogger = v;\n      }\n    }, 3);\n    let settings;\n    module.link(\"../../../../settings/server\", {\n      settings(v) {\n        settings = v;\n      }\n    }, 4);\n    let RoutingManager;\n    module.link(\"../RoutingManager\", {\n      RoutingManager(v) {\n        RoutingManager = v;\n      }\n    }, 5);\n    if (__reifyWaitForDeps__()) (await __reifyWaitForDeps__())();\n    class ExternalQueue {\n      constructor() {\n        this.config = void 0;\n        this.config = {\n          previewRoom: false,\n          showConnecting: false,\n          showQueue: false,\n          showQueueLink: false,\n          returnQueue: false,\n          enableTriggerAction: true,\n          autoAssignAgent: true\n        };\n      }\n      async getNextAgent(department, ignoreAgentId) {\n        const promises = [];\n        for (let i = 0; i < 10; i++) {\n          promises.push(this.getAgentFromExternalQueue(department, ignoreAgentId));\n        }\n        try {\n          const results = (await Promise.all(promises)).filter(Boolean);\n          if (!results.length) {\n            throw new Meteor.Error('no-agent-online', 'Sorry, no online agents');\n          }\n          return results[0];\n        } catch (err) {\n          SystemLogger.error({\n            msg: 'Error requesting agent from external queue.',\n            err\n          });\n          throw err;\n        }\n      }\n      async getAgentFromExternalQueue(department, ignoreAgentId) {\n        try {\n          const request = await fetch(\"\".concat(settings.get('Livechat_External_Queue_URL')), {\n            headers: {\n              'User-Agent': 'RocketChat Server',\n              'Accept': 'application/json',\n              'X-RocketChat-Secret-Token': settings.get('Livechat_External_Queue_Token')\n            },\n            params: _objectSpread(_objectSpread({}, department && {\n              departmentId: department\n            }), ignoreAgentId && {\n              ignoreAgentId\n            })\n          });\n          const result = await request.json();\n          if (result !== null && result !== void 0 && result.username) {\n            const agent = await Users.findOneOnlineAgentByUserList(result.username);\n            if (!(agent !== null && agent !== void 0 && agent.username)) {\n              return;\n            }\n            return {\n              agentId: agent._id,\n              username: agent.username\n            };\n          }\n        } catch (err) {\n          SystemLogger.error({\n            msg: 'Error requesting agent from external queue.',\n            err\n          });\n        }\n      }\n    }\n    RoutingManager.registerMethod('External', ExternalQueue);\n    __reify_async_result__();\n  } catch (_reifyError) {\n    return __reify_async_result__(_reifyError);\n  }\n  __reify_async_result__()\n}, {\n  self: this,\n  async: false\n});","map":{"version":3,"names":["_objectSpread","module","link","default","v","Users","fetch","serverFetch","Meteor","SystemLogger","settings","RoutingManager","__reifyWaitForDeps__","ExternalQueue","constructor","config","previewRoom","showConnecting","showQueue","showQueueLink","returnQueue","enableTriggerAction","autoAssignAgent","getNextAgent","department","ignoreAgentId","promises","i","push","getAgentFromExternalQueue","results","Promise","all","filter","Boolean","length","Error","err","error","msg","request","concat","get","headers","params","departmentId","result","json","username","agent","findOneOnlineAgentByUserList","agentId","_id","registerMethod","__reify_async_result__","_reifyError","self","async"],"sources":["app/livechat/server/lib/routing/External.ts"],"sourcesContent":["import type { IRoutingMethod, RoutingMethodConfig, SelectedAgent } from '@rocket.chat/core-typings';\nimport { Users } from '@rocket.chat/models';\nimport { serverFetch as fetch } from '@rocket.chat/server-fetch';\nimport { Meteor } from 'meteor/meteor';\n\nimport { SystemLogger } from '../../../../../server/lib/logger/system';\nimport { settings } from '../../../../settings/server';\nimport { RoutingManager } from '../RoutingManager';\n\nclass ExternalQueue implements IRoutingMethod {\n\tconfig: RoutingMethodConfig;\n\n\tconstructor() {\n\t\tthis.config = {\n\t\t\tpreviewRoom: false,\n\t\t\tshowConnecting: false,\n\t\t\tshowQueue: false,\n\t\t\tshowQueueLink: false,\n\t\t\treturnQueue: false,\n\t\t\tenableTriggerAction: true,\n\t\t\tautoAssignAgent: true,\n\t\t};\n\t}\n\n\tasync getNextAgent(department?: string, ignoreAgentId?: string): Promise<SelectedAgent | null | undefined> {\n\t\tconst promises = [];\n\t\tfor (let i = 0; i < 10; i++) {\n\t\t\tpromises.push(this.getAgentFromExternalQueue(department, ignoreAgentId));\n\t\t}\n\t\ttry {\n\t\t\tconst results = (await Promise.all(promises)).filter(Boolean);\n\t\t\tif (!results.length) {\n\t\t\t\tthrow new Meteor.Error('no-agent-online', 'Sorry, no online agents');\n\t\t\t}\n\t\t\treturn results[0];\n\t\t} catch (err) {\n\t\t\tSystemLogger.error({ msg: 'Error requesting agent from external queue.', err });\n\t\t\tthrow err;\n\t\t}\n\t}\n\n\tprivate async getAgentFromExternalQueue(department?: string, ignoreAgentId?: string): Promise<SelectedAgent | null | undefined> {\n\t\ttry {\n\t\t\tconst request = await fetch(`${settings.get('Livechat_External_Queue_URL')}`, {\n\t\t\t\theaders: {\n\t\t\t\t\t'User-Agent': 'RocketChat Server',\n\t\t\t\t\t'Accept': 'application/json',\n\t\t\t\t\t'X-RocketChat-Secret-Token': settings.get('Livechat_External_Queue_Token'),\n\t\t\t\t},\n\t\t\t\tparams: {\n\t\t\t\t\t...(department && { departmentId: department }),\n\t\t\t\t\t...(ignoreAgentId && { ignoreAgentId }),\n\t\t\t\t},\n\t\t\t});\n\t\t\tconst result = (await request.json()) as { username?: string };\n\n\t\t\tif (result?.username) {\n\t\t\t\tconst agent = await Users.findOneOnlineAgentByUserList(result.username);\n\n\t\t\t\tif (!agent?.username) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\treturn {\n\t\t\t\t\tagentId: agent._id,\n\t\t\t\t\tusername: agent.username,\n\t\t\t\t};\n\t\t\t}\n\t\t} catch (err) {\n\t\t\tSystemLogger.error({ msg: 'Error requesting agent from external queue.', err });\n\t\t}\n\t}\n}\n\nRoutingManager.registerMethod('External', ExternalQueue);\n"],"mappings":"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","ignoreList":[]},"sourceType":"module","externalDependencies":{},"hash":"9c1822b180bc538876ef393ca26d47e2cfc0255d"}
