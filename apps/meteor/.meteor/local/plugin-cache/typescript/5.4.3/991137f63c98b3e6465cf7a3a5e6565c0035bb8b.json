{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/client/views/marketplace/hooks/useAppInstallationHandler.tsx","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","topLevelAwait","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"web.browser"},"sourceFileName":"client/views/marketplace/hooks/useAppInstallationHandler.tsx","filename":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/client/views/marketplace/hooks/useAppInstallationHandler.tsx","inputSourceMap":{"version":3,"file":"client/views/marketplace/hooks/useAppInstallationHandler.tsx","sourceRoot":"","sources":["client/views/marketplace/hooks/useAppInstallationHandler.tsx"],"names":[],"mappings":"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","sourcesContent":["import type { App } from '@rocket.chat/core-typings';\nimport { useEndpoint, useRouteParameter, useSetModal, useToastMessageDispatch } from '@rocket.chat/ui-contexts';\nimport React, { useCallback } from 'react';\n\nimport { useExternalLink } from '../../../hooks/useExternalLink';\nimport { useCheckoutUrl } from '../../admin/subscription/hooks/useCheckoutUrl';\nimport IframeModal from '../IframeModal';\nimport AppInstallModal from '../components/AppInstallModal/AppInstallModal';\nimport type { Actions } from '../helpers';\nimport { handleAPIError } from '../helpers/handleAPIError';\nimport { isMarketplaceRouteContext, useAppsCountQuery } from './useAppsCountQuery';\nimport { useAppsOrchestration } from './useAppsOrchestration';\nimport { useOpenAppPermissionsReviewModal } from './useOpenAppPermissionsReviewModal';\nimport { useOpenIncompatibleModal } from './useOpenIncompatibleModal';\n\nexport type AppInstallationHandlerParams = {\n\tapp: App;\n\taction: Actions | '';\n\tisAppPurchased?: boolean;\n\tonDismiss: () => void;\n\tonSuccess: (action: Actions | '', appPermissions?: App['permissions']) => void;\n\tsetIsPurchased: (purchased: boolean) => void;\n};\n\nexport function useAppInstallationHandler({\n\tapp,\n\taction,\n\tisAppPurchased,\n\tonDismiss,\n\tonSuccess,\n\tsetIsPurchased,\n}: AppInstallationHandlerParams) {\n\tconst dispatchToastMessage = useToastMessageDispatch();\n\tconst setModal = useSetModal();\n\n\tconst routeContext = String(useRouteParameter('context'));\n\tconst context = isMarketplaceRouteContext(routeContext) ? routeContext : 'explore';\n\n\tconst appCountQuery = useAppsCountQuery(context);\n\n\tconst notifyAdmins = useEndpoint('POST', `/apps/notify-admins`);\n\n\tconst openIncompatibleModal = useOpenIncompatibleModal();\n\n\tconst openExternalLink = useExternalLink();\n\tconst manageSubscriptionUrl = useCheckoutUrl()({ target: 'user-page', action: 'buy_more' });\n\n\tconst closeModal = useCallback(() => {\n\t\tsetModal(null);\n\t\tonDismiss();\n\t}, [onDismiss, setModal]);\n\n\tconst success = useCallback(\n\t\t(appPermissions?: App['permissions']) => {\n\t\t\tsetModal(null);\n\t\t\tonSuccess(action, appPermissions);\n\t\t},\n\t\t[action, onSuccess, setModal],\n\t);\n\n\tconst openPermissionModal = useOpenAppPermissionsReviewModal({ app, onCancel: closeModal, onConfirm: success });\n\n\tconst appsOrchestrator = useAppsOrchestration();\n\n\tif (!appsOrchestrator) {\n\t\tthrow new Error('Apps orchestrator is not available');\n\t}\n\n\tconst acquireApp = useCallback(async () => {\n\t\tif (action === 'purchase' && !isAppPurchased) {\n\t\t\ttry {\n\t\t\t\tconst data = await appsOrchestrator.buildExternalUrl(app.id, app.purchaseType, false);\n\t\t\t\tsetModal(\n\t\t\t\t\t<IframeModal\n\t\t\t\t\t\turl={data.url}\n\t\t\t\t\t\tcancel={onDismiss}\n\t\t\t\t\t\tconfirm={() => {\n\t\t\t\t\t\t\tsetIsPurchased(true);\n\t\t\t\t\t\t\topenPermissionModal();\n\t\t\t\t\t\t}}\n\t\t\t\t\t/>,\n\t\t\t\t);\n\t\t\t} catch (error) {\n\t\t\t\thandleAPIError(error);\n\t\t\t}\n\t\t\treturn;\n\t\t}\n\n\t\topenPermissionModal();\n\t}, [action, isAppPurchased, openPermissionModal, appsOrchestrator, app.id, app.purchaseType, setModal, onDismiss, setIsPurchased]);\n\n\treturn useCallback(async () => {\n\t\tif (app?.versionIncompatible) {\n\t\t\topenIncompatibleModal(app, action, closeModal);\n\t\t\treturn;\n\t\t}\n\n\t\tif (action === 'request') {\n\t\t\tconst requestConfirmAction = (postMessage: Record<string, unknown>) => {\n\t\t\t\tsetModal(null);\n\t\t\t\tdispatchToastMessage({ type: 'success', message: 'App request submitted' });\n\n\t\t\t\tnotifyAdmins({\n\t\t\t\t\tappId: app.id,\n\t\t\t\t\tappName: app.name,\n\t\t\t\t\tappVersion: app.marketplaceVersion,\n\t\t\t\t\tmessage: typeof postMessage.message === 'string' ? postMessage.message : '',\n\t\t\t\t});\n\n\t\t\t\tsuccess();\n\t\t\t};\n\n\t\t\ttry {\n\t\t\t\tconst data = await appsOrchestrator.buildExternalAppRequest(app.id);\n\t\t\t\tsetModal(<IframeModal url={data.url} wrapperHeight='x460' cancel={onDismiss} confirm={requestConfirmAction} />);\n\t\t\t} catch (error) {\n\t\t\t\thandleAPIError(error);\n\t\t\t}\n\t\t\treturn;\n\t\t}\n\n\t\tif (!appCountQuery.data) {\n\t\t\treturn;\n\t\t}\n\n\t\tif (appCountQuery.data.hasUnlimitedApps) {\n\t\t\treturn acquireApp();\n\t\t}\n\n\t\tsetModal(\n\t\t\t<AppInstallModal\n\t\t\t\tenabled={appCountQuery.data.enabled}\n\t\t\t\tlimit={appCountQuery.data.limit}\n\t\t\t\tappName={app.name}\n\t\t\t\thandleClose={closeModal}\n\t\t\t\thandleConfirm={acquireApp}\n\t\t\t\thandleEnableUnlimitedApps={() => {\n\t\t\t\t\topenExternalLink(manageSubscriptionUrl);\n\t\t\t\t\tsetModal(null);\n\t\t\t\t}}\n\t\t\t/>,\n\t\t);\n\t}, [\n\t\tapp,\n\t\taction,\n\t\tappCountQuery.data,\n\t\tsetModal,\n\t\tcloseModal,\n\t\tacquireApp,\n\t\topenIncompatibleModal,\n\t\tdispatchToastMessage,\n\t\tnotifyAdmins,\n\t\tsuccess,\n\t\tappsOrchestrator,\n\t\tonDismiss,\n\t\topenExternalLink,\n\t\tmanageSubscriptionUrl,\n\t]);\n}\n"]},"targets":{"android":"125.0.0","chrome":"125.0.0","edge":"125.0.0","firefox":"115.0.0","ie":"10.0.0","ios":"17.4.0","opera":"110.0.0","opera_mobile":"80.0.0","safari":"17.4.0","samsung":"24.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor","root":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":false,"enforceStrictMode":false,"dynamicImport":true,"generateLetDeclarations":true},"externalDependencies":[]},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"version":"7.17.2","helpers":true,"useESModules":false,"corejs":false},"externalDependencies":[]},{"key":"proposal-class-properties","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true},"externalDependencies":[]},{"key":"transform-react-jsx","visitor":{"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXFragment":{"exit":[null]},"JSXElement":{"exit":[null]},"JSXAttribute":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false},"externalDependencies":[]},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-nullish-coalescing-operator","visitor":{"LogicalExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-optional-chaining","visitor":{"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-optional-catch-binding","visitor":{"CatchClause":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-class-properties","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-async-generator-functions","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-logical-assignment-operators","visitor":{"AssignmentExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]}],"presets":[],"generatorOpts":{"filename":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/client/views/marketplace/hooks/useAppInstallationHandler.tsx","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"client/views/marketplace/hooks/useAppInstallationHandler.tsx","inputSourceMap":{"version":3,"file":"client/views/marketplace/hooks/useAppInstallationHandler.tsx","sourceRoot":"","sources":["client/views/marketplace/hooks/useAppInstallationHandler.tsx"],"names":[],"mappings":"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","sourcesContent":["import type { App } from '@rocket.chat/core-typings';\nimport { useEndpoint, useRouteParameter, useSetModal, useToastMessageDispatch } from '@rocket.chat/ui-contexts';\nimport React, { useCallback } from 'react';\n\nimport { useExternalLink } from '../../../hooks/useExternalLink';\nimport { useCheckoutUrl } from '../../admin/subscription/hooks/useCheckoutUrl';\nimport IframeModal from '../IframeModal';\nimport AppInstallModal from '../components/AppInstallModal/AppInstallModal';\nimport type { Actions } from '../helpers';\nimport { handleAPIError } from '../helpers/handleAPIError';\nimport { isMarketplaceRouteContext, useAppsCountQuery } from './useAppsCountQuery';\nimport { useAppsOrchestration } from './useAppsOrchestration';\nimport { useOpenAppPermissionsReviewModal } from './useOpenAppPermissionsReviewModal';\nimport { useOpenIncompatibleModal } from './useOpenIncompatibleModal';\n\nexport type AppInstallationHandlerParams = {\n\tapp: App;\n\taction: Actions | '';\n\tisAppPurchased?: boolean;\n\tonDismiss: () => void;\n\tonSuccess: (action: Actions | '', appPermissions?: App['permissions']) => void;\n\tsetIsPurchased: (purchased: boolean) => void;\n};\n\nexport function useAppInstallationHandler({\n\tapp,\n\taction,\n\tisAppPurchased,\n\tonDismiss,\n\tonSuccess,\n\tsetIsPurchased,\n}: AppInstallationHandlerParams) {\n\tconst dispatchToastMessage = useToastMessageDispatch();\n\tconst setModal = useSetModal();\n\n\tconst routeContext = String(useRouteParameter('context'));\n\tconst context = isMarketplaceRouteContext(routeContext) ? routeContext : 'explore';\n\n\tconst appCountQuery = useAppsCountQuery(context);\n\n\tconst notifyAdmins = useEndpoint('POST', `/apps/notify-admins`);\n\n\tconst openIncompatibleModal = useOpenIncompatibleModal();\n\n\tconst openExternalLink = useExternalLink();\n\tconst manageSubscriptionUrl = useCheckoutUrl()({ target: 'user-page', action: 'buy_more' });\n\n\tconst closeModal = useCallback(() => {\n\t\tsetModal(null);\n\t\tonDismiss();\n\t}, [onDismiss, setModal]);\n\n\tconst success = useCallback(\n\t\t(appPermissions?: App['permissions']) => {\n\t\t\tsetModal(null);\n\t\t\tonSuccess(action, appPermissions);\n\t\t},\n\t\t[action, onSuccess, setModal],\n\t);\n\n\tconst openPermissionModal = useOpenAppPermissionsReviewModal({ app, onCancel: closeModal, onConfirm: success });\n\n\tconst appsOrchestrator = useAppsOrchestration();\n\n\tif (!appsOrchestrator) {\n\t\tthrow new Error('Apps orchestrator is not available');\n\t}\n\n\tconst acquireApp = useCallback(async () => {\n\t\tif (action === 'purchase' && !isAppPurchased) {\n\t\t\ttry {\n\t\t\t\tconst data = await appsOrchestrator.buildExternalUrl(app.id, app.purchaseType, false);\n\t\t\t\tsetModal(\n\t\t\t\t\t<IframeModal\n\t\t\t\t\t\turl={data.url}\n\t\t\t\t\t\tcancel={onDismiss}\n\t\t\t\t\t\tconfirm={() => {\n\t\t\t\t\t\t\tsetIsPurchased(true);\n\t\t\t\t\t\t\topenPermissionModal();\n\t\t\t\t\t\t}}\n\t\t\t\t\t/>,\n\t\t\t\t);\n\t\t\t} catch (error) {\n\t\t\t\thandleAPIError(error);\n\t\t\t}\n\t\t\treturn;\n\t\t}\n\n\t\topenPermissionModal();\n\t}, [action, isAppPurchased, openPermissionModal, appsOrchestrator, app.id, app.purchaseType, setModal, onDismiss, setIsPurchased]);\n\n\treturn useCallback(async () => {\n\t\tif (app?.versionIncompatible) {\n\t\t\topenIncompatibleModal(app, action, closeModal);\n\t\t\treturn;\n\t\t}\n\n\t\tif (action === 'request') {\n\t\t\tconst requestConfirmAction = (postMessage: Record<string, unknown>) => {\n\t\t\t\tsetModal(null);\n\t\t\t\tdispatchToastMessage({ type: 'success', message: 'App request submitted' });\n\n\t\t\t\tnotifyAdmins({\n\t\t\t\t\tappId: app.id,\n\t\t\t\t\tappName: app.name,\n\t\t\t\t\tappVersion: app.marketplaceVersion,\n\t\t\t\t\tmessage: typeof postMessage.message === 'string' ? postMessage.message : '',\n\t\t\t\t});\n\n\t\t\t\tsuccess();\n\t\t\t};\n\n\t\t\ttry {\n\t\t\t\tconst data = await appsOrchestrator.buildExternalAppRequest(app.id);\n\t\t\t\tsetModal(<IframeModal url={data.url} wrapperHeight='x460' cancel={onDismiss} confirm={requestConfirmAction} />);\n\t\t\t} catch (error) {\n\t\t\t\thandleAPIError(error);\n\t\t\t}\n\t\t\treturn;\n\t\t}\n\n\t\tif (!appCountQuery.data) {\n\t\t\treturn;\n\t\t}\n\n\t\tif (appCountQuery.data.hasUnlimitedApps) {\n\t\t\treturn acquireApp();\n\t\t}\n\n\t\tsetModal(\n\t\t\t<AppInstallModal\n\t\t\t\tenabled={appCountQuery.data.enabled}\n\t\t\t\tlimit={appCountQuery.data.limit}\n\t\t\t\tappName={app.name}\n\t\t\t\thandleClose={closeModal}\n\t\t\t\thandleConfirm={acquireApp}\n\t\t\t\thandleEnableUnlimitedApps={() => {\n\t\t\t\t\topenExternalLink(manageSubscriptionUrl);\n\t\t\t\t\tsetModal(null);\n\t\t\t\t}}\n\t\t\t/>,\n\t\t);\n\t}, [\n\t\tapp,\n\t\taction,\n\t\tappCountQuery.data,\n\t\tsetModal,\n\t\tcloseModal,\n\t\tacquireApp,\n\t\topenIncompatibleModal,\n\t\tdispatchToastMessage,\n\t\tnotifyAdmins,\n\t\tsuccess,\n\t\tappsOrchestrator,\n\t\tonDismiss,\n\t\topenExternalLink,\n\t\tmanageSubscriptionUrl,\n\t]);\n}\n"]}}},"code":"module.export({\n  useAppInstallationHandler: () => useAppInstallationHandler\n});\nlet useEndpoint, useRouteParameter, useSetModal, useToastMessageDispatch;\nmodule.link(\"@rocket.chat/ui-contexts\", {\n  useEndpoint(v) {\n    useEndpoint = v;\n  },\n  useRouteParameter(v) {\n    useRouteParameter = v;\n  },\n  useSetModal(v) {\n    useSetModal = v;\n  },\n  useToastMessageDispatch(v) {\n    useToastMessageDispatch = v;\n  }\n}, 0);\nlet React, useCallback;\nmodule.link(\"react\", {\n  default(v) {\n    React = v;\n  },\n  useCallback(v) {\n    useCallback = v;\n  }\n}, 1);\nlet useExternalLink;\nmodule.link(\"../../../hooks/useExternalLink\", {\n  useExternalLink(v) {\n    useExternalLink = v;\n  }\n}, 2);\nlet useCheckoutUrl;\nmodule.link(\"../../admin/subscription/hooks/useCheckoutUrl\", {\n  useCheckoutUrl(v) {\n    useCheckoutUrl = v;\n  }\n}, 3);\nlet IframeModal;\nmodule.link(\"../IframeModal\", {\n  default(v) {\n    IframeModal = v;\n  }\n}, 4);\nlet AppInstallModal;\nmodule.link(\"../components/AppInstallModal/AppInstallModal\", {\n  default(v) {\n    AppInstallModal = v;\n  }\n}, 5);\nlet handleAPIError;\nmodule.link(\"../helpers/handleAPIError\", {\n  handleAPIError(v) {\n    handleAPIError = v;\n  }\n}, 6);\nlet isMarketplaceRouteContext, useAppsCountQuery;\nmodule.link(\"./useAppsCountQuery\", {\n  isMarketplaceRouteContext(v) {\n    isMarketplaceRouteContext = v;\n  },\n  useAppsCountQuery(v) {\n    useAppsCountQuery = v;\n  }\n}, 7);\nlet useAppsOrchestration;\nmodule.link(\"./useAppsOrchestration\", {\n  useAppsOrchestration(v) {\n    useAppsOrchestration = v;\n  }\n}, 8);\nlet useOpenAppPermissionsReviewModal;\nmodule.link(\"./useOpenAppPermissionsReviewModal\", {\n  useOpenAppPermissionsReviewModal(v) {\n    useOpenAppPermissionsReviewModal = v;\n  }\n}, 9);\nlet useOpenIncompatibleModal;\nmodule.link(\"./useOpenIncompatibleModal\", {\n  useOpenIncompatibleModal(v) {\n    useOpenIncompatibleModal = v;\n  }\n}, 10);\nfunction useAppInstallationHandler(_ref) {\n  let {\n    app,\n    action,\n    isAppPurchased,\n    onDismiss,\n    onSuccess,\n    setIsPurchased\n  } = _ref;\n  const dispatchToastMessage = useToastMessageDispatch();\n  const setModal = useSetModal();\n  const routeContext = String(useRouteParameter('context'));\n  const context = isMarketplaceRouteContext(routeContext) ? routeContext : 'explore';\n  const appCountQuery = useAppsCountQuery(context);\n  const notifyAdmins = useEndpoint('POST', \"/apps/notify-admins\");\n  const openIncompatibleModal = useOpenIncompatibleModal();\n  const openExternalLink = useExternalLink();\n  const manageSubscriptionUrl = useCheckoutUrl()({\n    target: 'user-page',\n    action: 'buy_more'\n  });\n  const closeModal = useCallback(() => {\n    setModal(null);\n    onDismiss();\n  }, [onDismiss, setModal]);\n  const success = useCallback(appPermissions => {\n    setModal(null);\n    onSuccess(action, appPermissions);\n  }, [action, onSuccess, setModal]);\n  const openPermissionModal = useOpenAppPermissionsReviewModal({\n    app,\n    onCancel: closeModal,\n    onConfirm: success\n  });\n  const appsOrchestrator = useAppsOrchestration();\n  if (!appsOrchestrator) {\n    throw new Error('Apps orchestrator is not available');\n  }\n  const acquireApp = useCallback(async () => {\n    if (action === 'purchase' && !isAppPurchased) {\n      try {\n        const data = await appsOrchestrator.buildExternalUrl(app.id, app.purchaseType, false);\n        setModal( /*#__PURE__*/React.createElement(IframeModal, {\n          url: data.url,\n          cancel: onDismiss,\n          confirm: () => {\n            setIsPurchased(true);\n            openPermissionModal();\n          }\n        }));\n      } catch (error) {\n        handleAPIError(error);\n      }\n      return;\n    }\n    openPermissionModal();\n  }, [action, isAppPurchased, openPermissionModal, appsOrchestrator, app.id, app.purchaseType, setModal, onDismiss, setIsPurchased]);\n  return useCallback(async () => {\n    if (app !== null && app !== void 0 && app.versionIncompatible) {\n      openIncompatibleModal(app, action, closeModal);\n      return;\n    }\n    if (action === 'request') {\n      const requestConfirmAction = postMessage => {\n        setModal(null);\n        dispatchToastMessage({\n          type: 'success',\n          message: 'App request submitted'\n        });\n        notifyAdmins({\n          appId: app.id,\n          appName: app.name,\n          appVersion: app.marketplaceVersion,\n          message: typeof postMessage.message === 'string' ? postMessage.message : ''\n        });\n        success();\n      };\n      try {\n        const data = await appsOrchestrator.buildExternalAppRequest(app.id);\n        setModal( /*#__PURE__*/React.createElement(IframeModal, {\n          url: data.url,\n          wrapperHeight: \"x460\",\n          cancel: onDismiss,\n          confirm: requestConfirmAction\n        }));\n      } catch (error) {\n        handleAPIError(error);\n      }\n      return;\n    }\n    if (!appCountQuery.data) {\n      return;\n    }\n    if (appCountQuery.data.hasUnlimitedApps) {\n      return acquireApp();\n    }\n    setModal( /*#__PURE__*/React.createElement(AppInstallModal, {\n      enabled: appCountQuery.data.enabled,\n      limit: appCountQuery.data.limit,\n      appName: app.name,\n      handleClose: closeModal,\n      handleConfirm: acquireApp,\n      handleEnableUnlimitedApps: () => {\n        openExternalLink(manageSubscriptionUrl);\n        setModal(null);\n      }\n    }));\n  }, [app, action, appCountQuery.data, setModal, closeModal, acquireApp, openIncompatibleModal, dispatchToastMessage, notifyAdmins, success, appsOrchestrator, onDismiss, openExternalLink, manageSubscriptionUrl]);\n}","map":{"version":3,"names":["module","export","useAppInstallationHandler","useEndpoint","useRouteParameter","useSetModal","useToastMessageDispatch","link","v","React","useCallback","default","useExternalLink","useCheckoutUrl","IframeModal","AppInstallModal","handleAPIError","isMarketplaceRouteContext","useAppsCountQuery","useAppsOrchestration","useOpenAppPermissionsReviewModal","useOpenIncompatibleModal","_ref","app","action","isAppPurchased","onDismiss","onSuccess","setIsPurchased","dispatchToastMessage","setModal","routeContext","String","context","appCountQuery","notifyAdmins","openIncompatibleModal","openExternalLink","manageSubscriptionUrl","target","closeModal","success","appPermissions","openPermissionModal","onCancel","onConfirm","appsOrchestrator","Error","acquireApp","data","buildExternalUrl","id","purchaseType","createElement","url","cancel","confirm","error","versionIncompatible","requestConfirmAction","postMessage","type","message","appId","appName","name","appVersion","marketplaceVersion","buildExternalAppRequest","wrapperHeight","hasUnlimitedApps","enabled","limit","handleClose","handleConfirm","handleEnableUnlimitedApps"],"sources":["client/views/marketplace/hooks/useAppInstallationHandler.tsx"],"sourcesContent":["import type { App } from '@rocket.chat/core-typings';\nimport { useEndpoint, useRouteParameter, useSetModal, useToastMessageDispatch } from '@rocket.chat/ui-contexts';\nimport React, { useCallback } from 'react';\n\nimport { useExternalLink } from '../../../hooks/useExternalLink';\nimport { useCheckoutUrl } from '../../admin/subscription/hooks/useCheckoutUrl';\nimport IframeModal from '../IframeModal';\nimport AppInstallModal from '../components/AppInstallModal/AppInstallModal';\nimport type { Actions } from '../helpers';\nimport { handleAPIError } from '../helpers/handleAPIError';\nimport { isMarketplaceRouteContext, useAppsCountQuery } from './useAppsCountQuery';\nimport { useAppsOrchestration } from './useAppsOrchestration';\nimport { useOpenAppPermissionsReviewModal } from './useOpenAppPermissionsReviewModal';\nimport { useOpenIncompatibleModal } from './useOpenIncompatibleModal';\n\nexport type AppInstallationHandlerParams = {\n\tapp: App;\n\taction: Actions | '';\n\tisAppPurchased?: boolean;\n\tonDismiss: () => void;\n\tonSuccess: (action: Actions | '', appPermissions?: App['permissions']) => void;\n\tsetIsPurchased: (purchased: boolean) => void;\n};\n\nexport function useAppInstallationHandler({\n\tapp,\n\taction,\n\tisAppPurchased,\n\tonDismiss,\n\tonSuccess,\n\tsetIsPurchased,\n}: AppInstallationHandlerParams) {\n\tconst dispatchToastMessage = useToastMessageDispatch();\n\tconst setModal = useSetModal();\n\n\tconst routeContext = String(useRouteParameter('context'));\n\tconst context = isMarketplaceRouteContext(routeContext) ? routeContext : 'explore';\n\n\tconst appCountQuery = useAppsCountQuery(context);\n\n\tconst notifyAdmins = useEndpoint('POST', `/apps/notify-admins`);\n\n\tconst openIncompatibleModal = useOpenIncompatibleModal();\n\n\tconst openExternalLink = useExternalLink();\n\tconst manageSubscriptionUrl = useCheckoutUrl()({ target: 'user-page', action: 'buy_more' });\n\n\tconst closeModal = useCallback(() => {\n\t\tsetModal(null);\n\t\tonDismiss();\n\t}, [onDismiss, setModal]);\n\n\tconst success = useCallback(\n\t\t(appPermissions?: App['permissions']) => {\n\t\t\tsetModal(null);\n\t\t\tonSuccess(action, appPermissions);\n\t\t},\n\t\t[action, onSuccess, setModal],\n\t);\n\n\tconst openPermissionModal = useOpenAppPermissionsReviewModal({ app, onCancel: closeModal, onConfirm: success });\n\n\tconst appsOrchestrator = useAppsOrchestration();\n\n\tif (!appsOrchestrator) {\n\t\tthrow new Error('Apps orchestrator is not available');\n\t}\n\n\tconst acquireApp = useCallback(async () => {\n\t\tif (action === 'purchase' && !isAppPurchased) {\n\t\t\ttry {\n\t\t\t\tconst data = await appsOrchestrator.buildExternalUrl(app.id, app.purchaseType, false);\n\t\t\t\tsetModal(\n\t\t\t\t\t<IframeModal\n\t\t\t\t\t\turl={data.url}\n\t\t\t\t\t\tcancel={onDismiss}\n\t\t\t\t\t\tconfirm={() => {\n\t\t\t\t\t\t\tsetIsPurchased(true);\n\t\t\t\t\t\t\topenPermissionModal();\n\t\t\t\t\t\t}}\n\t\t\t\t\t/>,\n\t\t\t\t);\n\t\t\t} catch (error) {\n\t\t\t\thandleAPIError(error);\n\t\t\t}\n\t\t\treturn;\n\t\t}\n\n\t\topenPermissionModal();\n\t}, [action, isAppPurchased, openPermissionModal, appsOrchestrator, app.id, app.purchaseType, setModal, onDismiss, setIsPurchased]);\n\n\treturn useCallback(async () => {\n\t\tif (app?.versionIncompatible) {\n\t\t\topenIncompatibleModal(app, action, closeModal);\n\t\t\treturn;\n\t\t}\n\n\t\tif (action === 'request') {\n\t\t\tconst requestConfirmAction = (postMessage: Record<string, unknown>) => {\n\t\t\t\tsetModal(null);\n\t\t\t\tdispatchToastMessage({ type: 'success', message: 'App request submitted' });\n\n\t\t\t\tnotifyAdmins({\n\t\t\t\t\tappId: app.id,\n\t\t\t\t\tappName: app.name,\n\t\t\t\t\tappVersion: app.marketplaceVersion,\n\t\t\t\t\tmessage: typeof postMessage.message === 'string' ? postMessage.message : '',\n\t\t\t\t});\n\n\t\t\t\tsuccess();\n\t\t\t};\n\n\t\t\ttry {\n\t\t\t\tconst data = await appsOrchestrator.buildExternalAppRequest(app.id);\n\t\t\t\tsetModal(<IframeModal url={data.url} wrapperHeight='x460' cancel={onDismiss} confirm={requestConfirmAction} />);\n\t\t\t} catch (error) {\n\t\t\t\thandleAPIError(error);\n\t\t\t}\n\t\t\treturn;\n\t\t}\n\n\t\tif (!appCountQuery.data) {\n\t\t\treturn;\n\t\t}\n\n\t\tif (appCountQuery.data.hasUnlimitedApps) {\n\t\t\treturn acquireApp();\n\t\t}\n\n\t\tsetModal(\n\t\t\t<AppInstallModal\n\t\t\t\tenabled={appCountQuery.data.enabled}\n\t\t\t\tlimit={appCountQuery.data.limit}\n\t\t\t\tappName={app.name}\n\t\t\t\thandleClose={closeModal}\n\t\t\t\thandleConfirm={acquireApp}\n\t\t\t\thandleEnableUnlimitedApps={() => {\n\t\t\t\t\topenExternalLink(manageSubscriptionUrl);\n\t\t\t\t\tsetModal(null);\n\t\t\t\t}}\n\t\t\t/>,\n\t\t);\n\t}, [\n\t\tapp,\n\t\taction,\n\t\tappCountQuery.data,\n\t\tsetModal,\n\t\tcloseModal,\n\t\tacquireApp,\n\t\topenIncompatibleModal,\n\t\tdispatchToastMessage,\n\t\tnotifyAdmins,\n\t\tsuccess,\n\t\tappsOrchestrator,\n\t\tonDismiss,\n\t\topenExternalLink,\n\t\tmanageSubscriptionUrl,\n\t]);\n}\n"],"mappings":"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","ignoreList":[]},"sourceType":"module","externalDependencies":{},"hash":"991137f63c98b3e6465cf7a3a5e6565c0035bb8b"}
