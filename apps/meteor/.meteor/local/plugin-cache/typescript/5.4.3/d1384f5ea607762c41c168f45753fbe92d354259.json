{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/server/modules/core-apps/cloudAnnouncements.module.ts","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","topLevelAwait","objectRestSpread","objectRestSpread","asyncGenerators","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"os.osx.arm64"},"sourceFileName":"server/modules/core-apps/cloudAnnouncements.module.ts","filename":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/server/modules/core-apps/cloudAnnouncements.module.ts","inputSourceMap":{"version":3,"file":"server/modules/core-apps/cloudAnnouncements.module.ts","sourceRoot":"","sources":["server/modules/core-apps/cloudAnnouncements.module.ts"],"names":[],"mappings":"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","sourcesContent":["import { Banner } from '@rocket.chat/core-services';\nimport type { IUiKitCoreApp, UiKitCoreAppPayload } from '@rocket.chat/core-services';\nimport type { Cloud, IBanner, IUser } from '@rocket.chat/core-typings';\nimport { Banners } from '@rocket.chat/models';\nimport { serverFetch as fetch } from '@rocket.chat/server-fetch';\nimport type * as UiKit from '@rocket.chat/ui-kit';\n\nimport { getWorkspaceAccessToken } from '../../../app/cloud/server';\nimport { syncWorkspace } from '../../../app/cloud/server/functions/syncWorkspace';\nimport { settings } from '../../../app/settings/server';\nimport { CloudWorkspaceConnectionError } from '../../../lib/errors/CloudWorkspaceConnectionError';\nimport { InvalidCloudAnnouncementInteractionError } from '../../../lib/errors/InvalidCloudAnnouncementInteractionError';\nimport { InvalidCoreAppInteractionError } from '../../../lib/errors/InvalidCoreAppInteractionError';\nimport { SystemLogger } from '../../lib/logger/system';\n\ntype CloudAnnouncementInteractant =\n\t| {\n\t\t\tuser: Pick<IUser, '_id' | 'username' | 'name'>;\n\t  }\n\t| {\n\t\t\tvisitor: Pick<Required<UiKitCoreAppPayload>['visitor'], 'id' | 'username' | 'name' | 'department' | 'phone'>;\n\t  };\n\ntype CloudAnnouncementInteractionRequest = UiKit.UserInteraction & CloudAnnouncementInteractant;\n\nexport class CloudAnnouncementsModule implements IUiKitCoreApp {\n\tappId = 'cloud-announcements-core';\n\n\tprotected async getWorkspaceAccessToken() {\n\t\treturn getWorkspaceAccessToken(true);\n\t}\n\n\tprotected getCloudUrl() {\n\t\treturn settings.get('Cloud_Url');\n\t}\n\n\tblockAction(payload: UiKitCoreAppPayload): Promise<UiKit.ServerInteraction | void> {\n\t\treturn this.handlePayload(payload);\n\t}\n\n\tviewSubmit(payload: UiKitCoreAppPayload): Promise<UiKit.ServerInteraction | void> {\n\t\treturn this.handlePayload(payload);\n\t}\n\n\tasync viewClosed(payload: UiKitCoreAppPayload): Promise<UiKit.ServerInteraction> {\n\t\tconst {\n\t\t\tpayload: { view: { viewId } = {} },\n\t\t\tuser: { _id: userId } = {},\n\t\t} = payload;\n\n\t\tif (!userId) {\n\t\t\tthrow new Error('invalid user');\n\t\t}\n\n\t\tif (!viewId) {\n\t\t\tthrow new Error('invalid view');\n\t\t}\n\n\t\tif (!payload.triggerId) {\n\t\t\tthrow new Error('invalid triggerId');\n\t\t}\n\n\t\tawait Banner.dismiss(userId, viewId);\n\n\t\tconst announcement = await Banners.findOneById<Pick<IBanner, 'surface'>>(viewId, { projection: { surface: 1 } });\n\n\t\tconst type = announcement?.surface === 'banner' ? 'banner.close' : 'modal.close';\n\n\t\t// for viewClosed we just need to let Cloud know that the banner was closed, no need to wait for the response\n\t\tsetImmediate(async () => {\n\t\t\tawait this.handlePayload(payload);\n\t\t});\n\n\t\treturn {\n\t\t\ttype,\n\t\t\ttriggerId: payload.triggerId,\n\t\t\tappId: payload.appId,\n\t\t\tviewId,\n\t\t};\n\t}\n\n\tprotected async handlePayload(payload: UiKitCoreAppPayload): Promise<UiKit.ServerInteraction | void> {\n\t\tconst interactant = this.getInteractant(payload);\n\t\tconst interaction = this.getInteraction(payload);\n\n\t\ttry {\n\t\t\tconst serverInteraction = await this.pushUserInteraction(interactant, interaction);\n\n\t\t\tif (serverInteraction.appId !== this.appId) {\n\t\t\t\tthrow new InvalidCloudAnnouncementInteractionError(`Invalid appId`);\n\t\t\t}\n\n\t\t\tif (serverInteraction.triggerId !== interaction.triggerId) {\n\t\t\t\tthrow new InvalidCloudAnnouncementInteractionError(`Invalid triggerId`);\n\t\t\t}\n\n\t\t\treturn serverInteraction;\n\t\t} catch (error) {\n\t\t\tSystemLogger.error(error);\n\t\t}\n\t}\n\n\tprotected getInteractant(payload: UiKitCoreAppPayload): CloudAnnouncementInteractant {\n\t\tif (payload.user) {\n\t\t\treturn {\n\t\t\t\tuser: {\n\t\t\t\t\t_id: payload.user._id,\n\t\t\t\t\tusername: payload.user.username,\n\t\t\t\t\tname: payload.user.name,\n\t\t\t\t},\n\t\t\t};\n\t\t}\n\n\t\tif (payload.visitor) {\n\t\t\treturn {\n\t\t\t\tvisitor: {\n\t\t\t\t\tid: payload.visitor.id,\n\t\t\t\t\tusername: payload.visitor.username,\n\t\t\t\t\tname: payload.visitor.name,\n\t\t\t\t\tdepartment: payload.visitor.department,\n\t\t\t\t\tphone: payload.visitor.phone,\n\t\t\t\t},\n\t\t\t};\n\t\t}\n\n\t\tthrow new CloudWorkspaceConnectionError(`Invalid user data received from Rocket.Chat Cloud`);\n\t}\n\n\t/**\n\t * Transform the payload received from the Core App back to the format the UI sends from the client\n\t */\n\tprotected getInteraction(payload: UiKitCoreAppPayload): UiKit.UserInteraction {\n\t\tif (payload.type === 'blockAction' && payload.container?.type === 'message') {\n\t\t\tconst {\n\t\t\t\tactionId,\n\t\t\t\tpayload: { blockId, value },\n\t\t\t\tmessage,\n\t\t\t\troom,\n\t\t\t\ttriggerId,\n\t\t\t} = payload;\n\n\t\t\tif (!actionId || !blockId || !triggerId) {\n\t\t\t\tthrow new InvalidCoreAppInteractionError();\n\t\t\t}\n\n\t\t\treturn {\n\t\t\t\ttype: 'blockAction',\n\t\t\t\tactionId,\n\t\t\t\tpayload: {\n\t\t\t\t\tblockId,\n\t\t\t\t\tvalue,\n\t\t\t\t},\n\t\t\t\tcontainer: {\n\t\t\t\t\ttype: 'message',\n\t\t\t\t\tid: String(message),\n\t\t\t\t},\n\t\t\t\tmid: String(message),\n\t\t\t\ttmid: undefined,\n\t\t\t\trid: String(room),\n\t\t\t\ttriggerId,\n\t\t\t};\n\t\t}\n\n\t\tif (payload.type === 'blockAction' && payload.container?.type === 'view') {\n\t\t\tconst {\n\t\t\t\tactionId,\n\t\t\t\tpayload: { blockId, value },\n\t\t\t\tcontainer: { id },\n\t\t\t\ttriggerId,\n\t\t\t} = payload;\n\n\t\t\tif (!actionId || !blockId || !triggerId) {\n\t\t\t\tthrow new InvalidCoreAppInteractionError();\n\t\t\t}\n\n\t\t\treturn {\n\t\t\t\ttype: 'blockAction',\n\t\t\t\tactionId,\n\t\t\t\tpayload: {\n\t\t\t\t\tblockId,\n\t\t\t\t\tvalue,\n\t\t\t\t},\n\t\t\t\tcontainer: {\n\t\t\t\t\ttype: 'view',\n\t\t\t\t\tid,\n\t\t\t\t},\n\t\t\t\ttriggerId,\n\t\t\t};\n\t\t}\n\n\t\tif (payload.type === 'viewClosed') {\n\t\t\tconst {\n\t\t\t\tpayload: { view, isCleared },\n\t\t\t\ttriggerId,\n\t\t\t} = payload;\n\n\t\t\tif (!view?.id || !triggerId) {\n\t\t\t\tthrow new InvalidCoreAppInteractionError();\n\t\t\t}\n\n\t\t\treturn {\n\t\t\t\ttype: 'viewClosed',\n\t\t\t\tpayload: {\n\t\t\t\t\tviewId: view.id,\n\t\t\t\t\tview: view as any,\n\t\t\t\t\tisCleared: Boolean(isCleared),\n\t\t\t\t},\n\t\t\t\ttriggerId,\n\t\t\t};\n\t\t}\n\n\t\tif (payload.type === 'viewSubmit') {\n\t\t\tconst {\n\t\t\t\tpayload: { view },\n\t\t\t\ttriggerId,\n\t\t\t} = payload;\n\n\t\t\tif (!view?.id || !triggerId) {\n\t\t\t\tthrow new InvalidCoreAppInteractionError();\n\t\t\t}\n\n\t\t\treturn {\n\t\t\t\ttype: 'viewSubmit',\n\t\t\t\tpayload: {\n\t\t\t\t\tview: view as any,\n\t\t\t\t},\n\t\t\t\ttriggerId,\n\t\t\t\tviewId: view.id,\n\t\t\t};\n\t\t}\n\n\t\tthrow new InvalidCoreAppInteractionError();\n\t}\n\n\tprotected async pushUserInteraction(\n\t\tinteractant: CloudAnnouncementInteractant,\n\t\tuserInteraction: UiKit.UserInteraction,\n\t): Promise<UiKit.ServerInteraction> {\n\t\tconst token = await this.getWorkspaceAccessToken();\n\n\t\tconst request: CloudAnnouncementInteractionRequest = {\n\t\t\t...interactant,\n\t\t\t...userInteraction,\n\t\t};\n\n\t\t/**\n\t\t * I20241018-22:16:34.820(-3)? {\nI20241018-22:16:34.821(-3)?   type: 'blockAction',\nI20241018-22:16:34.821(-3)?   actionId: 'callout-action',\nI20241018-22:16:34.821(-3)?   payload: { blockId: 'section-button', value: '' },\nI20241018-22:16:34.821(-3)?   container: { type: 'view', id: 'subscription-announcement' },\nI20241018-22:16:34.821(-3)?   triggerId: '8pt3w2xaaj565QPW5'\nI20241018-22:16:34.821(-3)? }\n\t\t */\n\n\t\tif (\n\t\t\tuserInteraction.type === 'blockAction' &&\n\t\t\tuserInteraction.container?.type === 'view' &&\n\t\t\tuserInteraction.container?.id === 'subscription-announcement'\n\t\t) {\n\t\t\t// type OpenModalServerInteraction = {\n\t\t\t// \ttype: 'modal.open';\n\t\t\t// \ttriggerId: string;\n\t\t\t// \tappId: string;\n\t\t\t// \tview: ModalView;\n\t\t\t// };\n\t\t\treturn {\n\t\t\t\ttype: 'modal.open',\n\t\t\t\ttriggerId: userInteraction.triggerId,\n\t\t\t\tappId: this.appId,\n\t\t\t\tview: {\n\t\t\t\t\tshowIcon: false,\n\t\t\t\t\tid: userInteraction.container.id,\n\t\t\t\t\ttitle: {\n\t\t\t\t\t\ttype: 'plain_text',\n\t\t\t\t\t\ttext: 'Hello from Cloud',\n\t\t\t\t\t},\n\t\t\t\t\tblocks: [\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\ttype: 'image',\n\t\t\t\t\t\t\ttitle: {\n\t\t\t\t\t\t\t\ttype: 'plain_text',\n\t\t\t\t\t\t\t\ttext: 'I Need a Marg',\n\t\t\t\t\t\t\t\temoji: true,\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\timageUrl: 'https://picsum.photos/200/300',\n\t\t\t\t\t\t\taltText: 'marg',\n\t\t\t\t\t\t},\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\ttype: 'context',\n\t\t\t\t\t\t\telements: [\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\ttype: 'mrkdwn',\n\t\t\t\t\t\t\t\t\ttext: '*This* is :smile: markdown',\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t],\n\t\t\t\t\t\t},\n\t\t\t\t\t],\n\t\t\t\t\tappId: this.appId,\n\t\t\t\t\tshowIcon: true,\n\t\t\t\t},\n\t\t\t};\n\t\t}\n\n\t\tconsole.log(userInteraction);\n\n\t\tconst response = await fetch(`${this.getCloudUrl()}/api/v3/comms/workspace/interaction`, {\n\t\t\tmethod: 'POST',\n\t\t\theaders: {\n\t\t\t\tAuthorization: `Bearer ${token}`,\n\t\t\t},\n\t\t\tbody: JSON.stringify(request),\n\t\t});\n\n\t\tif (!response.ok) {\n\t\t\tconst { error } = await response.json();\n\t\t\tthrow new CloudWorkspaceConnectionError(`Failed to connect to Rocket.Chat Cloud: ${error}`);\n\t\t}\n\n\t\tconst payload: Cloud.WorkspaceInteractionResponsePayload = await response.json();\n\n\t\tconst { serverInteraction, serverAction } = payload;\n\n\t\tif (serverAction) {\n\t\t\tswitch (serverAction) {\n\t\t\t\tcase 'syncWorkspace': {\n\t\t\t\t\tawait syncWorkspace();\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\treturn serverInteraction;\n\t}\n}\n"]},"targets":{"android":"125.0.0","chrome":"125.0.0","edge":"125.0.0","firefox":"115.0.0","ie":"10.0.0","ios":"17.4.0","opera":"110.0.0","opera_mobile":"80.0.0","safari":"17.4.0","samsung":"24.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor","root":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":false,"enforceStrictMode":false,"dynamicImport":true,"generateLetDeclarations":true,"topLevelAwait":true},"externalDependencies":[]},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"version":"7.17.2","helpers":true,"useESModules":false,"corejs":false},"externalDependencies":[]},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-async-generator-functions","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-class-properties","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true},"externalDependencies":[]},{"key":"transform-react-jsx","visitor":{"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXFragment":{"exit":[null]},"JSXElement":{"exit":[null]},"JSXAttribute":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false},"externalDependencies":[]},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-nullish-coalescing-operator","visitor":{"LogicalExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-optional-chaining","visitor":{"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-optional-catch-binding","visitor":{"CatchClause":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-class-properties","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-async-generator-functions","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-logical-assignment-operators","visitor":{"AssignmentExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]}],"presets":[],"generatorOpts":{"filename":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/server/modules/core-apps/cloudAnnouncements.module.ts","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"server/modules/core-apps/cloudAnnouncements.module.ts","inputSourceMap":{"version":3,"file":"server/modules/core-apps/cloudAnnouncements.module.ts","sourceRoot":"","sources":["server/modules/core-apps/cloudAnnouncements.module.ts"],"names":[],"mappings":"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","sourcesContent":["import { Banner } from '@rocket.chat/core-services';\nimport type { IUiKitCoreApp, UiKitCoreAppPayload } from '@rocket.chat/core-services';\nimport type { Cloud, IBanner, IUser } from '@rocket.chat/core-typings';\nimport { Banners } from '@rocket.chat/models';\nimport { serverFetch as fetch } from '@rocket.chat/server-fetch';\nimport type * as UiKit from '@rocket.chat/ui-kit';\n\nimport { getWorkspaceAccessToken } from '../../../app/cloud/server';\nimport { syncWorkspace } from '../../../app/cloud/server/functions/syncWorkspace';\nimport { settings } from '../../../app/settings/server';\nimport { CloudWorkspaceConnectionError } from '../../../lib/errors/CloudWorkspaceConnectionError';\nimport { InvalidCloudAnnouncementInteractionError } from '../../../lib/errors/InvalidCloudAnnouncementInteractionError';\nimport { InvalidCoreAppInteractionError } from '../../../lib/errors/InvalidCoreAppInteractionError';\nimport { SystemLogger } from '../../lib/logger/system';\n\ntype CloudAnnouncementInteractant =\n\t| {\n\t\t\tuser: Pick<IUser, '_id' | 'username' | 'name'>;\n\t  }\n\t| {\n\t\t\tvisitor: Pick<Required<UiKitCoreAppPayload>['visitor'], 'id' | 'username' | 'name' | 'department' | 'phone'>;\n\t  };\n\ntype CloudAnnouncementInteractionRequest = UiKit.UserInteraction & CloudAnnouncementInteractant;\n\nexport class CloudAnnouncementsModule implements IUiKitCoreApp {\n\tappId = 'cloud-announcements-core';\n\n\tprotected async getWorkspaceAccessToken() {\n\t\treturn getWorkspaceAccessToken(true);\n\t}\n\n\tprotected getCloudUrl() {\n\t\treturn settings.get('Cloud_Url');\n\t}\n\n\tblockAction(payload: UiKitCoreAppPayload): Promise<UiKit.ServerInteraction | void> {\n\t\treturn this.handlePayload(payload);\n\t}\n\n\tviewSubmit(payload: UiKitCoreAppPayload): Promise<UiKit.ServerInteraction | void> {\n\t\treturn this.handlePayload(payload);\n\t}\n\n\tasync viewClosed(payload: UiKitCoreAppPayload): Promise<UiKit.ServerInteraction> {\n\t\tconst {\n\t\t\tpayload: { view: { viewId } = {} },\n\t\t\tuser: { _id: userId } = {},\n\t\t} = payload;\n\n\t\tif (!userId) {\n\t\t\tthrow new Error('invalid user');\n\t\t}\n\n\t\tif (!viewId) {\n\t\t\tthrow new Error('invalid view');\n\t\t}\n\n\t\tif (!payload.triggerId) {\n\t\t\tthrow new Error('invalid triggerId');\n\t\t}\n\n\t\tawait Banner.dismiss(userId, viewId);\n\n\t\tconst announcement = await Banners.findOneById<Pick<IBanner, 'surface'>>(viewId, { projection: { surface: 1 } });\n\n\t\tconst type = announcement?.surface === 'banner' ? 'banner.close' : 'modal.close';\n\n\t\t// for viewClosed we just need to let Cloud know that the banner was closed, no need to wait for the response\n\t\tsetImmediate(async () => {\n\t\t\tawait this.handlePayload(payload);\n\t\t});\n\n\t\treturn {\n\t\t\ttype,\n\t\t\ttriggerId: payload.triggerId,\n\t\t\tappId: payload.appId,\n\t\t\tviewId,\n\t\t};\n\t}\n\n\tprotected async handlePayload(payload: UiKitCoreAppPayload): Promise<UiKit.ServerInteraction | void> {\n\t\tconst interactant = this.getInteractant(payload);\n\t\tconst interaction = this.getInteraction(payload);\n\n\t\ttry {\n\t\t\tconst serverInteraction = await this.pushUserInteraction(interactant, interaction);\n\n\t\t\tif (serverInteraction.appId !== this.appId) {\n\t\t\t\tthrow new InvalidCloudAnnouncementInteractionError(`Invalid appId`);\n\t\t\t}\n\n\t\t\tif (serverInteraction.triggerId !== interaction.triggerId) {\n\t\t\t\tthrow new InvalidCloudAnnouncementInteractionError(`Invalid triggerId`);\n\t\t\t}\n\n\t\t\treturn serverInteraction;\n\t\t} catch (error) {\n\t\t\tSystemLogger.error(error);\n\t\t}\n\t}\n\n\tprotected getInteractant(payload: UiKitCoreAppPayload): CloudAnnouncementInteractant {\n\t\tif (payload.user) {\n\t\t\treturn {\n\t\t\t\tuser: {\n\t\t\t\t\t_id: payload.user._id,\n\t\t\t\t\tusername: payload.user.username,\n\t\t\t\t\tname: payload.user.name,\n\t\t\t\t},\n\t\t\t};\n\t\t}\n\n\t\tif (payload.visitor) {\n\t\t\treturn {\n\t\t\t\tvisitor: {\n\t\t\t\t\tid: payload.visitor.id,\n\t\t\t\t\tusername: payload.visitor.username,\n\t\t\t\t\tname: payload.visitor.name,\n\t\t\t\t\tdepartment: payload.visitor.department,\n\t\t\t\t\tphone: payload.visitor.phone,\n\t\t\t\t},\n\t\t\t};\n\t\t}\n\n\t\tthrow new CloudWorkspaceConnectionError(`Invalid user data received from Rocket.Chat Cloud`);\n\t}\n\n\t/**\n\t * Transform the payload received from the Core App back to the format the UI sends from the client\n\t */\n\tprotected getInteraction(payload: UiKitCoreAppPayload): UiKit.UserInteraction {\n\t\tif (payload.type === 'blockAction' && payload.container?.type === 'message') {\n\t\t\tconst {\n\t\t\t\tactionId,\n\t\t\t\tpayload: { blockId, value },\n\t\t\t\tmessage,\n\t\t\t\troom,\n\t\t\t\ttriggerId,\n\t\t\t} = payload;\n\n\t\t\tif (!actionId || !blockId || !triggerId) {\n\t\t\t\tthrow new InvalidCoreAppInteractionError();\n\t\t\t}\n\n\t\t\treturn {\n\t\t\t\ttype: 'blockAction',\n\t\t\t\tactionId,\n\t\t\t\tpayload: {\n\t\t\t\t\tblockId,\n\t\t\t\t\tvalue,\n\t\t\t\t},\n\t\t\t\tcontainer: {\n\t\t\t\t\ttype: 'message',\n\t\t\t\t\tid: String(message),\n\t\t\t\t},\n\t\t\t\tmid: String(message),\n\t\t\t\ttmid: undefined,\n\t\t\t\trid: String(room),\n\t\t\t\ttriggerId,\n\t\t\t};\n\t\t}\n\n\t\tif (payload.type === 'blockAction' && payload.container?.type === 'view') {\n\t\t\tconst {\n\t\t\t\tactionId,\n\t\t\t\tpayload: { blockId, value },\n\t\t\t\tcontainer: { id },\n\t\t\t\ttriggerId,\n\t\t\t} = payload;\n\n\t\t\tif (!actionId || !blockId || !triggerId) {\n\t\t\t\tthrow new InvalidCoreAppInteractionError();\n\t\t\t}\n\n\t\t\treturn {\n\t\t\t\ttype: 'blockAction',\n\t\t\t\tactionId,\n\t\t\t\tpayload: {\n\t\t\t\t\tblockId,\n\t\t\t\t\tvalue,\n\t\t\t\t},\n\t\t\t\tcontainer: {\n\t\t\t\t\ttype: 'view',\n\t\t\t\t\tid,\n\t\t\t\t},\n\t\t\t\ttriggerId,\n\t\t\t};\n\t\t}\n\n\t\tif (payload.type === 'viewClosed') {\n\t\t\tconst {\n\t\t\t\tpayload: { view, isCleared },\n\t\t\t\ttriggerId,\n\t\t\t} = payload;\n\n\t\t\tif (!view?.id || !triggerId) {\n\t\t\t\tthrow new InvalidCoreAppInteractionError();\n\t\t\t}\n\n\t\t\treturn {\n\t\t\t\ttype: 'viewClosed',\n\t\t\t\tpayload: {\n\t\t\t\t\tviewId: view.id,\n\t\t\t\t\tview: view as any,\n\t\t\t\t\tisCleared: Boolean(isCleared),\n\t\t\t\t},\n\t\t\t\ttriggerId,\n\t\t\t};\n\t\t}\n\n\t\tif (payload.type === 'viewSubmit') {\n\t\t\tconst {\n\t\t\t\tpayload: { view },\n\t\t\t\ttriggerId,\n\t\t\t} = payload;\n\n\t\t\tif (!view?.id || !triggerId) {\n\t\t\t\tthrow new InvalidCoreAppInteractionError();\n\t\t\t}\n\n\t\t\treturn {\n\t\t\t\ttype: 'viewSubmit',\n\t\t\t\tpayload: {\n\t\t\t\t\tview: view as any,\n\t\t\t\t},\n\t\t\t\ttriggerId,\n\t\t\t\tviewId: view.id,\n\t\t\t};\n\t\t}\n\n\t\tthrow new InvalidCoreAppInteractionError();\n\t}\n\n\tprotected async pushUserInteraction(\n\t\tinteractant: CloudAnnouncementInteractant,\n\t\tuserInteraction: UiKit.UserInteraction,\n\t): Promise<UiKit.ServerInteraction> {\n\t\tconst token = await this.getWorkspaceAccessToken();\n\n\t\tconst request: CloudAnnouncementInteractionRequest = {\n\t\t\t...interactant,\n\t\t\t...userInteraction,\n\t\t};\n\n\t\t/**\n\t\t * I20241018-22:16:34.820(-3)? {\nI20241018-22:16:34.821(-3)?   type: 'blockAction',\nI20241018-22:16:34.821(-3)?   actionId: 'callout-action',\nI20241018-22:16:34.821(-3)?   payload: { blockId: 'section-button', value: '' },\nI20241018-22:16:34.821(-3)?   container: { type: 'view', id: 'subscription-announcement' },\nI20241018-22:16:34.821(-3)?   triggerId: '8pt3w2xaaj565QPW5'\nI20241018-22:16:34.821(-3)? }\n\t\t */\n\n\t\tif (\n\t\t\tuserInteraction.type === 'blockAction' &&\n\t\t\tuserInteraction.container?.type === 'view' &&\n\t\t\tuserInteraction.container?.id === 'subscription-announcement'\n\t\t) {\n\t\t\t// type OpenModalServerInteraction = {\n\t\t\t// \ttype: 'modal.open';\n\t\t\t// \ttriggerId: string;\n\t\t\t// \tappId: string;\n\t\t\t// \tview: ModalView;\n\t\t\t// };\n\t\t\treturn {\n\t\t\t\ttype: 'modal.open',\n\t\t\t\ttriggerId: userInteraction.triggerId,\n\t\t\t\tappId: this.appId,\n\t\t\t\tview: {\n\t\t\t\t\tshowIcon: false,\n\t\t\t\t\tid: userInteraction.container.id,\n\t\t\t\t\ttitle: {\n\t\t\t\t\t\ttype: 'plain_text',\n\t\t\t\t\t\ttext: 'Hello from Cloud',\n\t\t\t\t\t},\n\t\t\t\t\tblocks: [\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\ttype: 'image',\n\t\t\t\t\t\t\ttitle: {\n\t\t\t\t\t\t\t\ttype: 'plain_text',\n\t\t\t\t\t\t\t\ttext: 'I Need a Marg',\n\t\t\t\t\t\t\t\temoji: true,\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\timageUrl: 'https://picsum.photos/200/300',\n\t\t\t\t\t\t\taltText: 'marg',\n\t\t\t\t\t\t},\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\ttype: 'context',\n\t\t\t\t\t\t\telements: [\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\ttype: 'mrkdwn',\n\t\t\t\t\t\t\t\t\ttext: '*This* is :smile: markdown',\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t],\n\t\t\t\t\t\t},\n\t\t\t\t\t],\n\t\t\t\t\tappId: this.appId,\n\t\t\t\t\tshowIcon: true,\n\t\t\t\t},\n\t\t\t};\n\t\t}\n\n\t\tconsole.log(userInteraction);\n\n\t\tconst response = await fetch(`${this.getCloudUrl()}/api/v3/comms/workspace/interaction`, {\n\t\t\tmethod: 'POST',\n\t\t\theaders: {\n\t\t\t\tAuthorization: `Bearer ${token}`,\n\t\t\t},\n\t\t\tbody: JSON.stringify(request),\n\t\t});\n\n\t\tif (!response.ok) {\n\t\t\tconst { error } = await response.json();\n\t\t\tthrow new CloudWorkspaceConnectionError(`Failed to connect to Rocket.Chat Cloud: ${error}`);\n\t\t}\n\n\t\tconst payload: Cloud.WorkspaceInteractionResponsePayload = await response.json();\n\n\t\tconst { serverInteraction, serverAction } = payload;\n\n\t\tif (serverAction) {\n\t\t\tswitch (serverAction) {\n\t\t\t\tcase 'syncWorkspace': {\n\t\t\t\t\tawait syncWorkspace();\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\treturn serverInteraction;\n\t}\n}\n"]}}},"code":"!module.wrapAsync(async function (module, __reifyWaitForDeps__, __reify_async_result__) {\n  \"use strict\";\n  try {\n    let _objectSpread;\n    module.link(\"@babel/runtime/helpers/objectSpread2\", {\n      default(v) {\n        _objectSpread = v;\n      }\n    }, 0);\n    module.export({\n      CloudAnnouncementsModule: () => CloudAnnouncementsModule\n    });\n    let Banner;\n    module.link(\"@rocket.chat/core-services\", {\n      Banner(v) {\n        Banner = v;\n      }\n    }, 0);\n    let Banners;\n    module.link(\"@rocket.chat/models\", {\n      Banners(v) {\n        Banners = v;\n      }\n    }, 1);\n    let fetch;\n    module.link(\"@rocket.chat/server-fetch\", {\n      serverFetch(v) {\n        fetch = v;\n      }\n    }, 2);\n    let getWorkspaceAccessToken;\n    module.link(\"../../../app/cloud/server\", {\n      getWorkspaceAccessToken(v) {\n        getWorkspaceAccessToken = v;\n      }\n    }, 3);\n    let syncWorkspace;\n    module.link(\"../../../app/cloud/server/functions/syncWorkspace\", {\n      syncWorkspace(v) {\n        syncWorkspace = v;\n      }\n    }, 4);\n    let settings;\n    module.link(\"../../../app/settings/server\", {\n      settings(v) {\n        settings = v;\n      }\n    }, 5);\n    let CloudWorkspaceConnectionError;\n    module.link(\"../../../lib/errors/CloudWorkspaceConnectionError\", {\n      CloudWorkspaceConnectionError(v) {\n        CloudWorkspaceConnectionError = v;\n      }\n    }, 6);\n    let InvalidCloudAnnouncementInteractionError;\n    module.link(\"../../../lib/errors/InvalidCloudAnnouncementInteractionError\", {\n      InvalidCloudAnnouncementInteractionError(v) {\n        InvalidCloudAnnouncementInteractionError = v;\n      }\n    }, 7);\n    let InvalidCoreAppInteractionError;\n    module.link(\"../../../lib/errors/InvalidCoreAppInteractionError\", {\n      InvalidCoreAppInteractionError(v) {\n        InvalidCoreAppInteractionError = v;\n      }\n    }, 8);\n    let SystemLogger;\n    module.link(\"../../lib/logger/system\", {\n      SystemLogger(v) {\n        SystemLogger = v;\n      }\n    }, 9);\n    if (__reifyWaitForDeps__()) (await __reifyWaitForDeps__())();\n    class CloudAnnouncementsModule {\n      constructor() {\n        this.appId = 'cloud-announcements-core';\n      }\n      async getWorkspaceAccessToken() {\n        return getWorkspaceAccessToken(true);\n      }\n      getCloudUrl() {\n        return settings.get('Cloud_Url');\n      }\n      blockAction(payload) {\n        return this.handlePayload(payload);\n      }\n      viewSubmit(payload) {\n        return this.handlePayload(payload);\n      }\n      async viewClosed(payload) {\n        const {\n          payload: {\n            view: {\n              viewId\n            } = {}\n          },\n          user: {\n            _id: userId\n          } = {}\n        } = payload;\n        if (!userId) {\n          throw new Error('invalid user');\n        }\n        if (!viewId) {\n          throw new Error('invalid view');\n        }\n        if (!payload.triggerId) {\n          throw new Error('invalid triggerId');\n        }\n        await Banner.dismiss(userId, viewId);\n        const announcement = await Banners.findOneById(viewId, {\n          projection: {\n            surface: 1\n          }\n        });\n        const type = (announcement === null || announcement === void 0 ? void 0 : announcement.surface) === 'banner' ? 'banner.close' : 'modal.close';\n        // for viewClosed we just need to let Cloud know that the banner was closed, no need to wait for the response\n        setImmediate(async () => {\n          await this.handlePayload(payload);\n        });\n        return {\n          type,\n          triggerId: payload.triggerId,\n          appId: payload.appId,\n          viewId\n        };\n      }\n      async handlePayload(payload) {\n        const interactant = this.getInteractant(payload);\n        const interaction = this.getInteraction(payload);\n        try {\n          const serverInteraction = await this.pushUserInteraction(interactant, interaction);\n          if (serverInteraction.appId !== this.appId) {\n            throw new InvalidCloudAnnouncementInteractionError(\"Invalid appId\");\n          }\n          if (serverInteraction.triggerId !== interaction.triggerId) {\n            throw new InvalidCloudAnnouncementInteractionError(\"Invalid triggerId\");\n          }\n          return serverInteraction;\n        } catch (error) {\n          SystemLogger.error(error);\n        }\n      }\n      getInteractant(payload) {\n        if (payload.user) {\n          return {\n            user: {\n              _id: payload.user._id,\n              username: payload.user.username,\n              name: payload.user.name\n            }\n          };\n        }\n        if (payload.visitor) {\n          return {\n            visitor: {\n              id: payload.visitor.id,\n              username: payload.visitor.username,\n              name: payload.visitor.name,\n              department: payload.visitor.department,\n              phone: payload.visitor.phone\n            }\n          };\n        }\n        throw new CloudWorkspaceConnectionError(\"Invalid user data received from Rocket.Chat Cloud\");\n      }\n      /**\n       * Transform the payload received from the Core App back to the format the UI sends from the client\n       */\n      getInteraction(payload) {\n        var _payload$container, _payload$container2;\n        if (payload.type === 'blockAction' && ((_payload$container = payload.container) === null || _payload$container === void 0 ? void 0 : _payload$container.type) === 'message') {\n          const {\n            actionId,\n            payload: {\n              blockId,\n              value\n            },\n            message,\n            room,\n            triggerId\n          } = payload;\n          if (!actionId || !blockId || !triggerId) {\n            throw new InvalidCoreAppInteractionError();\n          }\n          return {\n            type: 'blockAction',\n            actionId,\n            payload: {\n              blockId,\n              value\n            },\n            container: {\n              type: 'message',\n              id: String(message)\n            },\n            mid: String(message),\n            tmid: undefined,\n            rid: String(room),\n            triggerId\n          };\n        }\n        if (payload.type === 'blockAction' && ((_payload$container2 = payload.container) === null || _payload$container2 === void 0 ? void 0 : _payload$container2.type) === 'view') {\n          const {\n            actionId,\n            payload: {\n              blockId,\n              value\n            },\n            container: {\n              id\n            },\n            triggerId\n          } = payload;\n          if (!actionId || !blockId || !triggerId) {\n            throw new InvalidCoreAppInteractionError();\n          }\n          return {\n            type: 'blockAction',\n            actionId,\n            payload: {\n              blockId,\n              value\n            },\n            container: {\n              type: 'view',\n              id\n            },\n            triggerId\n          };\n        }\n        if (payload.type === 'viewClosed') {\n          const {\n            payload: {\n              view,\n              isCleared\n            },\n            triggerId\n          } = payload;\n          if (!(view !== null && view !== void 0 && view.id) || !triggerId) {\n            throw new InvalidCoreAppInteractionError();\n          }\n          return {\n            type: 'viewClosed',\n            payload: {\n              viewId: view.id,\n              view: view,\n              isCleared: Boolean(isCleared)\n            },\n            triggerId\n          };\n        }\n        if (payload.type === 'viewSubmit') {\n          const {\n            payload: {\n              view\n            },\n            triggerId\n          } = payload;\n          if (!(view !== null && view !== void 0 && view.id) || !triggerId) {\n            throw new InvalidCoreAppInteractionError();\n          }\n          return {\n            type: 'viewSubmit',\n            payload: {\n              view: view\n            },\n            triggerId,\n            viewId: view.id\n          };\n        }\n        throw new InvalidCoreAppInteractionError();\n      }\n      async pushUserInteraction(interactant, userInteraction) {\n        var _userInteraction$cont, _userInteraction$cont2;\n        const token = await this.getWorkspaceAccessToken();\n        const request = _objectSpread(_objectSpread({}, interactant), userInteraction);\n        /**\n         * I20241018-22:16:34.820(-3)? {\n        I20241018-22:16:34.821(-3)?   type: 'blockAction',\n        I20241018-22:16:34.821(-3)?   actionId: 'callout-action',\n        I20241018-22:16:34.821(-3)?   payload: { blockId: 'section-button', value: '' },\n        I20241018-22:16:34.821(-3)?   container: { type: 'view', id: 'subscription-announcement' },\n        I20241018-22:16:34.821(-3)?   triggerId: '8pt3w2xaaj565QPW5'\n        I20241018-22:16:34.821(-3)? }\n         */\n        if (userInteraction.type === 'blockAction' && ((_userInteraction$cont = userInteraction.container) === null || _userInteraction$cont === void 0 ? void 0 : _userInteraction$cont.type) === 'view' && ((_userInteraction$cont2 = userInteraction.container) === null || _userInteraction$cont2 === void 0 ? void 0 : _userInteraction$cont2.id) === 'subscription-announcement') {\n          // type OpenModalServerInteraction = {\n          // \ttype: 'modal.open';\n          // \ttriggerId: string;\n          // \tappId: string;\n          // \tview: ModalView;\n          // };\n          return {\n            type: 'modal.open',\n            triggerId: userInteraction.triggerId,\n            appId: this.appId,\n            view: {\n              showIcon: false,\n              id: userInteraction.container.id,\n              title: {\n                type: 'plain_text',\n                text: 'Hello from Cloud'\n              },\n              blocks: [{\n                type: 'image',\n                title: {\n                  type: 'plain_text',\n                  text: 'I Need a Marg',\n                  emoji: true\n                },\n                imageUrl: 'https://picsum.photos/200/300',\n                altText: 'marg'\n              }, {\n                type: 'context',\n                elements: [{\n                  type: 'mrkdwn',\n                  text: '*This* is :smile: markdown'\n                }]\n              }],\n              appId: this.appId,\n              showIcon: true\n            }\n          };\n        }\n        console.log(userInteraction);\n        const response = await fetch(\"\".concat(this.getCloudUrl(), \"/api/v3/comms/workspace/interaction\"), {\n          method: 'POST',\n          headers: {\n            Authorization: \"Bearer \".concat(token)\n          },\n          body: JSON.stringify(request)\n        });\n        if (!response.ok) {\n          const {\n            error\n          } = await response.json();\n          throw new CloudWorkspaceConnectionError(\"Failed to connect to Rocket.Chat Cloud: \".concat(error));\n        }\n        const payload = await response.json();\n        const {\n          serverInteraction,\n          serverAction\n        } = payload;\n        if (serverAction) {\n          switch (serverAction) {\n            case 'syncWorkspace':\n              {\n                await syncWorkspace();\n                break;\n              }\n          }\n        }\n        return serverInteraction;\n      }\n    }\n    __reify_async_result__();\n  } catch (_reifyError) {\n    return __reify_async_result__(_reifyError);\n  }\n  __reify_async_result__()\n}, {\n  self: this,\n  async: false\n});","map":{"version":3,"names":["_objectSpread","module","link","default","v","export","CloudAnnouncementsModule","Banner","Banners","fetch","serverFetch","getWorkspaceAccessToken","syncWorkspace","settings","CloudWorkspaceConnectionError","InvalidCloudAnnouncementInteractionError","InvalidCoreAppInteractionError","SystemLogger","__reifyWaitForDeps__","constructor","appId","getCloudUrl","get","blockAction","payload","handlePayload","viewSubmit","viewClosed","view","viewId","user","_id","userId","Error","triggerId","dismiss","announcement","findOneById","projection","surface","type","setImmediate","interactant","getInteractant","interaction","getInteraction","serverInteraction","pushUserInteraction","error","username","name","visitor","id","department","phone","_payload$container","_payload$container2","container","actionId","blockId","value","message","room","String","mid","tmid","undefined","rid","isCleared","Boolean","userInteraction","_userInteraction$cont","_userInteraction$cont2","token","request","showIcon","title","text","blocks","emoji","imageUrl","altText","elements","console","log","response","concat","method","headers","Authorization","body","JSON","stringify","ok","json","serverAction","__reify_async_result__","_reifyError","self","async"],"sources":["server/modules/core-apps/cloudAnnouncements.module.ts"],"sourcesContent":["import { Banner } from '@rocket.chat/core-services';\nimport type { IUiKitCoreApp, UiKitCoreAppPayload } from '@rocket.chat/core-services';\nimport type { Cloud, IBanner, IUser } from '@rocket.chat/core-typings';\nimport { Banners } from '@rocket.chat/models';\nimport { serverFetch as fetch } from '@rocket.chat/server-fetch';\nimport type * as UiKit from '@rocket.chat/ui-kit';\n\nimport { getWorkspaceAccessToken } from '../../../app/cloud/server';\nimport { syncWorkspace } from '../../../app/cloud/server/functions/syncWorkspace';\nimport { settings } from '../../../app/settings/server';\nimport { CloudWorkspaceConnectionError } from '../../../lib/errors/CloudWorkspaceConnectionError';\nimport { InvalidCloudAnnouncementInteractionError } from '../../../lib/errors/InvalidCloudAnnouncementInteractionError';\nimport { InvalidCoreAppInteractionError } from '../../../lib/errors/InvalidCoreAppInteractionError';\nimport { SystemLogger } from '../../lib/logger/system';\n\ntype CloudAnnouncementInteractant =\n\t| {\n\t\t\tuser: Pick<IUser, '_id' | 'username' | 'name'>;\n\t  }\n\t| {\n\t\t\tvisitor: Pick<Required<UiKitCoreAppPayload>['visitor'], 'id' | 'username' | 'name' | 'department' | 'phone'>;\n\t  };\n\ntype CloudAnnouncementInteractionRequest = UiKit.UserInteraction & CloudAnnouncementInteractant;\n\nexport class CloudAnnouncementsModule implements IUiKitCoreApp {\n\tappId = 'cloud-announcements-core';\n\n\tprotected async getWorkspaceAccessToken() {\n\t\treturn getWorkspaceAccessToken(true);\n\t}\n\n\tprotected getCloudUrl() {\n\t\treturn settings.get('Cloud_Url');\n\t}\n\n\tblockAction(payload: UiKitCoreAppPayload): Promise<UiKit.ServerInteraction | void> {\n\t\treturn this.handlePayload(payload);\n\t}\n\n\tviewSubmit(payload: UiKitCoreAppPayload): Promise<UiKit.ServerInteraction | void> {\n\t\treturn this.handlePayload(payload);\n\t}\n\n\tasync viewClosed(payload: UiKitCoreAppPayload): Promise<UiKit.ServerInteraction> {\n\t\tconst {\n\t\t\tpayload: { view: { viewId } = {} },\n\t\t\tuser: { _id: userId } = {},\n\t\t} = payload;\n\n\t\tif (!userId) {\n\t\t\tthrow new Error('invalid user');\n\t\t}\n\n\t\tif (!viewId) {\n\t\t\tthrow new Error('invalid view');\n\t\t}\n\n\t\tif (!payload.triggerId) {\n\t\t\tthrow new Error('invalid triggerId');\n\t\t}\n\n\t\tawait Banner.dismiss(userId, viewId);\n\n\t\tconst announcement = await Banners.findOneById<Pick<IBanner, 'surface'>>(viewId, { projection: { surface: 1 } });\n\n\t\tconst type = announcement?.surface === 'banner' ? 'banner.close' : 'modal.close';\n\n\t\t// for viewClosed we just need to let Cloud know that the banner was closed, no need to wait for the response\n\t\tsetImmediate(async () => {\n\t\t\tawait this.handlePayload(payload);\n\t\t});\n\n\t\treturn {\n\t\t\ttype,\n\t\t\ttriggerId: payload.triggerId,\n\t\t\tappId: payload.appId,\n\t\t\tviewId,\n\t\t};\n\t}\n\n\tprotected async handlePayload(payload: UiKitCoreAppPayload): Promise<UiKit.ServerInteraction | void> {\n\t\tconst interactant = this.getInteractant(payload);\n\t\tconst interaction = this.getInteraction(payload);\n\n\t\ttry {\n\t\t\tconst serverInteraction = await this.pushUserInteraction(interactant, interaction);\n\n\t\t\tif (serverInteraction.appId !== this.appId) {\n\t\t\t\tthrow new InvalidCloudAnnouncementInteractionError(`Invalid appId`);\n\t\t\t}\n\n\t\t\tif (serverInteraction.triggerId !== interaction.triggerId) {\n\t\t\t\tthrow new InvalidCloudAnnouncementInteractionError(`Invalid triggerId`);\n\t\t\t}\n\n\t\t\treturn serverInteraction;\n\t\t} catch (error) {\n\t\t\tSystemLogger.error(error);\n\t\t}\n\t}\n\n\tprotected getInteractant(payload: UiKitCoreAppPayload): CloudAnnouncementInteractant {\n\t\tif (payload.user) {\n\t\t\treturn {\n\t\t\t\tuser: {\n\t\t\t\t\t_id: payload.user._id,\n\t\t\t\t\tusername: payload.user.username,\n\t\t\t\t\tname: payload.user.name,\n\t\t\t\t},\n\t\t\t};\n\t\t}\n\n\t\tif (payload.visitor) {\n\t\t\treturn {\n\t\t\t\tvisitor: {\n\t\t\t\t\tid: payload.visitor.id,\n\t\t\t\t\tusername: payload.visitor.username,\n\t\t\t\t\tname: payload.visitor.name,\n\t\t\t\t\tdepartment: payload.visitor.department,\n\t\t\t\t\tphone: payload.visitor.phone,\n\t\t\t\t},\n\t\t\t};\n\t\t}\n\n\t\tthrow new CloudWorkspaceConnectionError(`Invalid user data received from Rocket.Chat Cloud`);\n\t}\n\n\t/**\n\t * Transform the payload received from the Core App back to the format the UI sends from the client\n\t */\n\tprotected getInteraction(payload: UiKitCoreAppPayload): UiKit.UserInteraction {\n\t\tif (payload.type === 'blockAction' && payload.container?.type === 'message') {\n\t\t\tconst {\n\t\t\t\tactionId,\n\t\t\t\tpayload: { blockId, value },\n\t\t\t\tmessage,\n\t\t\t\troom,\n\t\t\t\ttriggerId,\n\t\t\t} = payload;\n\n\t\t\tif (!actionId || !blockId || !triggerId) {\n\t\t\t\tthrow new InvalidCoreAppInteractionError();\n\t\t\t}\n\n\t\t\treturn {\n\t\t\t\ttype: 'blockAction',\n\t\t\t\tactionId,\n\t\t\t\tpayload: {\n\t\t\t\t\tblockId,\n\t\t\t\t\tvalue,\n\t\t\t\t},\n\t\t\t\tcontainer: {\n\t\t\t\t\ttype: 'message',\n\t\t\t\t\tid: String(message),\n\t\t\t\t},\n\t\t\t\tmid: String(message),\n\t\t\t\ttmid: undefined,\n\t\t\t\trid: String(room),\n\t\t\t\ttriggerId,\n\t\t\t};\n\t\t}\n\n\t\tif (payload.type === 'blockAction' && payload.container?.type === 'view') {\n\t\t\tconst {\n\t\t\t\tactionId,\n\t\t\t\tpayload: { blockId, value },\n\t\t\t\tcontainer: { id },\n\t\t\t\ttriggerId,\n\t\t\t} = payload;\n\n\t\t\tif (!actionId || !blockId || !triggerId) {\n\t\t\t\tthrow new InvalidCoreAppInteractionError();\n\t\t\t}\n\n\t\t\treturn {\n\t\t\t\ttype: 'blockAction',\n\t\t\t\tactionId,\n\t\t\t\tpayload: {\n\t\t\t\t\tblockId,\n\t\t\t\t\tvalue,\n\t\t\t\t},\n\t\t\t\tcontainer: {\n\t\t\t\t\ttype: 'view',\n\t\t\t\t\tid,\n\t\t\t\t},\n\t\t\t\ttriggerId,\n\t\t\t};\n\t\t}\n\n\t\tif (payload.type === 'viewClosed') {\n\t\t\tconst {\n\t\t\t\tpayload: { view, isCleared },\n\t\t\t\ttriggerId,\n\t\t\t} = payload;\n\n\t\t\tif (!view?.id || !triggerId) {\n\t\t\t\tthrow new InvalidCoreAppInteractionError();\n\t\t\t}\n\n\t\t\treturn {\n\t\t\t\ttype: 'viewClosed',\n\t\t\t\tpayload: {\n\t\t\t\t\tviewId: view.id,\n\t\t\t\t\tview: view as any,\n\t\t\t\t\tisCleared: Boolean(isCleared),\n\t\t\t\t},\n\t\t\t\ttriggerId,\n\t\t\t};\n\t\t}\n\n\t\tif (payload.type === 'viewSubmit') {\n\t\t\tconst {\n\t\t\t\tpayload: { view },\n\t\t\t\ttriggerId,\n\t\t\t} = payload;\n\n\t\t\tif (!view?.id || !triggerId) {\n\t\t\t\tthrow new InvalidCoreAppInteractionError();\n\t\t\t}\n\n\t\t\treturn {\n\t\t\t\ttype: 'viewSubmit',\n\t\t\t\tpayload: {\n\t\t\t\t\tview: view as any,\n\t\t\t\t},\n\t\t\t\ttriggerId,\n\t\t\t\tviewId: view.id,\n\t\t\t};\n\t\t}\n\n\t\tthrow new InvalidCoreAppInteractionError();\n\t}\n\n\tprotected async pushUserInteraction(\n\t\tinteractant: CloudAnnouncementInteractant,\n\t\tuserInteraction: UiKit.UserInteraction,\n\t): Promise<UiKit.ServerInteraction> {\n\t\tconst token = await this.getWorkspaceAccessToken();\n\n\t\tconst request: CloudAnnouncementInteractionRequest = {\n\t\t\t...interactant,\n\t\t\t...userInteraction,\n\t\t};\n\n\t\t/**\n\t\t * I20241018-22:16:34.820(-3)? {\nI20241018-22:16:34.821(-3)?   type: 'blockAction',\nI20241018-22:16:34.821(-3)?   actionId: 'callout-action',\nI20241018-22:16:34.821(-3)?   payload: { blockId: 'section-button', value: '' },\nI20241018-22:16:34.821(-3)?   container: { type: 'view', id: 'subscription-announcement' },\nI20241018-22:16:34.821(-3)?   triggerId: '8pt3w2xaaj565QPW5'\nI20241018-22:16:34.821(-3)? }\n\t\t */\n\n\t\tif (\n\t\t\tuserInteraction.type === 'blockAction' &&\n\t\t\tuserInteraction.container?.type === 'view' &&\n\t\t\tuserInteraction.container?.id === 'subscription-announcement'\n\t\t) {\n\t\t\t// type OpenModalServerInteraction = {\n\t\t\t// \ttype: 'modal.open';\n\t\t\t// \ttriggerId: string;\n\t\t\t// \tappId: string;\n\t\t\t// \tview: ModalView;\n\t\t\t// };\n\t\t\treturn {\n\t\t\t\ttype: 'modal.open',\n\t\t\t\ttriggerId: userInteraction.triggerId,\n\t\t\t\tappId: this.appId,\n\t\t\t\tview: {\n\t\t\t\t\tshowIcon: false,\n\t\t\t\t\tid: userInteraction.container.id,\n\t\t\t\t\ttitle: {\n\t\t\t\t\t\ttype: 'plain_text',\n\t\t\t\t\t\ttext: 'Hello from Cloud',\n\t\t\t\t\t},\n\t\t\t\t\tblocks: [\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\ttype: 'image',\n\t\t\t\t\t\t\ttitle: {\n\t\t\t\t\t\t\t\ttype: 'plain_text',\n\t\t\t\t\t\t\t\ttext: 'I Need a Marg',\n\t\t\t\t\t\t\t\temoji: true,\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\timageUrl: 'https://picsum.photos/200/300',\n\t\t\t\t\t\t\taltText: 'marg',\n\t\t\t\t\t\t},\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\ttype: 'context',\n\t\t\t\t\t\t\telements: [\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\ttype: 'mrkdwn',\n\t\t\t\t\t\t\t\t\ttext: '*This* is :smile: markdown',\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t],\n\t\t\t\t\t\t},\n\t\t\t\t\t],\n\t\t\t\t\tappId: this.appId,\n\t\t\t\t\tshowIcon: true,\n\t\t\t\t},\n\t\t\t};\n\t\t}\n\n\t\tconsole.log(userInteraction);\n\n\t\tconst response = await fetch(`${this.getCloudUrl()}/api/v3/comms/workspace/interaction`, {\n\t\t\tmethod: 'POST',\n\t\t\theaders: {\n\t\t\t\tAuthorization: `Bearer ${token}`,\n\t\t\t},\n\t\t\tbody: JSON.stringify(request),\n\t\t});\n\n\t\tif (!response.ok) {\n\t\t\tconst { error } = await response.json();\n\t\t\tthrow new CloudWorkspaceConnectionError(`Failed to connect to Rocket.Chat Cloud: ${error}`);\n\t\t}\n\n\t\tconst payload: Cloud.WorkspaceInteractionResponsePayload = await response.json();\n\n\t\tconst { serverInteraction, serverAction } = payload;\n\n\t\tif (serverAction) {\n\t\t\tswitch (serverAction) {\n\t\t\t\tcase 'syncWorkspace': {\n\t\t\t\t\tawait syncWorkspace();\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\treturn serverInteraction;\n\t}\n}\n"],"mappings":"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","ignoreList":[]},"sourceType":"module","externalDependencies":{},"hash":"d1384f5ea607762c41c168f45753fbe92d354259"}
