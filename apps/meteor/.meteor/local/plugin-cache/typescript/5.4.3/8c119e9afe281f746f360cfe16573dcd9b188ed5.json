{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/server/services/federation/application/room/message/receiver/message-redaction-helper.ts","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","topLevelAwait","objectRestSpread","objectRestSpread","asyncGenerators","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"os.osx.arm64"},"sourceFileName":"server/services/federation/application/room/message/receiver/message-redaction-helper.ts","filename":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/server/services/federation/application/room/message/receiver/message-redaction-helper.ts","inputSourceMap":{"version":3,"file":"server/services/federation/application/room/message/receiver/message-redaction-helper.ts","sourceRoot":"","sources":["server/services/federation/application/room/message/receiver/message-redaction-helper.ts"],"names":[],"mappings":"AAEA,OAAO,EAAE,UAAU,EAAE,MAAM,wBAAwB,CAAC;AAQpD,MAAM,oBAAoB;IAEP;IACA;IACA;IAHlB,YACkB,sBAAgD,EAChD,OAAiB,EACjB,aAA4B;QAF5B,2BAAsB,GAAtB,sBAAsB,CAA0B;QAChD,YAAO,GAAP,OAAO,CAAU;QACjB,kBAAa,GAAb,aAAa,CAAe;IAC3C,CAAC;IAEG,KAAK,CAAC,MAAM;QAClB,MAAM,IAAI,CAAC,sBAAsB,CAAC,aAAa,CAAC,IAAI,CAAC,OAAO,EAAE,IAAI,CAAC,aAAa,CAAC,CAAC;IACnF,CAAC;CACD;AAED,MAAM,uBAAuB;IAEV;IACA;IACA;IACA;IAJlB,YACkB,sBAAgD,EAChD,OAAiB,EACjB,aAA4B,EAC5B,aAAqB;QAHrB,2BAAsB,GAAtB,sBAAsB,CAA0B;QAChD,YAAO,GAAP,OAAO,CAAU;QACjB,kBAAa,GAAb,aAAa,CAAe;QAC5B,kBAAa,GAAb,aAAa,CAAQ;IACpC,CAAC;IAEG,KAAK,CAAC,MAAM;QAClB,MAAM,iBAAiB,GAAG,UAAU,CAAC,+BAA+B,CAAC,IAAI,CAAC,aAAa,CAAC,CAAC;QACzF,MAAM,QAAQ,GAAG,MAAM,CAAC,IAAI,CAAC,IAAI,CAAC,OAAO,CAAC,SAAS,IAAI,EAAE,CAAC,CAAC,IAAI,CAC9D,CAAC,GAAG,EAAE,EAAE,CACP,IAAI,CAAC,OAAO,CAAC,SAAS,EAAE,CAAC,GAAG,CAAC,EAAE,0BAA0B,EAAE,CAAC,iBAAiB,CAAC,KAAK,IAAI,CAAC,aAAa,CAAC,WAAW,EAAE;YACnH,IAAI,CAAC,OAAO,CAAC,SAAS,EAAE,CAAC,GAAG,CAAC,EAAE,SAAS,EAAE,QAAQ,CAAC,IAAI,CAAC,aAAa,CAAC,WAAW,EAAE,IAAI,EAAE,CAAC,CAC3F,CAAC;QACF,IAAI,CAAC,QAAQ,EAAE,CAAC;YACf,OAAO;QACR,CAAC;QACD,MAAM,IAAI,CAAC,sBAAsB,CAAC,gBAAgB,CAAC,IAAI,CAAC,aAAa,EAAE,IAAI,CAAC,OAAO,EAAE,QAAQ,EAAE,IAAI,CAAC,aAAa,CAAC,CAAC;IACpH,CAAC;CACD;AAED,MAAM,CAAC,MAAM,0BAA0B,GAAG,KAAK,EAC9C,sBAAgD,EAChD,YAAoB,EACpB,aAA4B,EACiB,EAAE;IAC/C,MAAM,OAAO,GAAG,MAAM,sBAAsB,CAAC,wBAAwB,CAAC,YAAY,CAAC,CAAC;IACpF,MAAM,mBAAmB,GAAG,MAAM,sBAAsB,CAAC,gCAAgC,CAAC,YAAY,EAAE,aAAa,CAAC,CAAC;IACvH,IAAI,CAAC,OAAO,IAAI,CAAC,mBAAmB,EAAE,CAAC;QACtC,OAAO;IACR,CAAC;IACD,IAAI,mBAAmB,EAAE,CAAC;QACzB,OAAO,IAAI,uBAAuB,CAAC,sBAAsB,EAAE,mBAAmB,EAAE,aAAa,EAAE,YAAY,CAAC,CAAC;IAC9G,CAAC;IACD,IAAI,OAAO,EAAE,CAAC;QACb,OAAO,IAAI,oBAAoB,CAAC,sBAAsB,EAAE,OAAO,EAAE,aAAa,CAAC,CAAC;IACjF,CAAC;AACF,CAAC,CAAC","sourcesContent":["import type { IMessage } from '@rocket.chat/core-typings';\n\nimport { Federation } from '../../../../Federation';\nimport type { FederatedUser } from '../../../../domain/FederatedUser';\nimport type { RocketChatMessageAdapter } from '../../../../infrastructure/rocket-chat/adapters/Message';\n\ninterface IRoomRedactionHandler {\n\thandle(): Promise<void>;\n}\n\nclass DeleteMessageHandler implements IRoomRedactionHandler {\n\tconstructor(\n\t\tprivate readonly internalMessageAdapter: RocketChatMessageAdapter,\n\t\tprivate readonly message: IMessage,\n\t\tprivate readonly federatedUser: FederatedUser,\n\t) {}\n\n\tpublic async handle(): Promise<void> {\n\t\tawait this.internalMessageAdapter.deleteMessage(this.message, this.federatedUser);\n\t}\n}\n\nclass UnreactToMessageHandler implements IRoomRedactionHandler {\n\tconstructor(\n\t\tprivate readonly internalMessageAdapter: RocketChatMessageAdapter,\n\t\tprivate readonly message: IMessage,\n\t\tprivate readonly federatedUser: FederatedUser,\n\t\tprivate readonly redactsEvents: string,\n\t) {}\n\n\tpublic async handle(): Promise<void> {\n\t\tconst normalizedEventId = Federation.escapeExternalFederationEventId(this.redactsEvents);\n\t\tconst reaction = Object.keys(this.message.reactions || {}).find(\n\t\t\t(key) =>\n\t\t\t\tthis.message.reactions?.[key]?.federationReactionEventIds?.[normalizedEventId] === this.federatedUser.getUsername() &&\n\t\t\t\tthis.message.reactions?.[key]?.usernames?.includes(this.federatedUser.getUsername() || ''),\n\t\t);\n\t\tif (!reaction) {\n\t\t\treturn;\n\t\t}\n\t\tawait this.internalMessageAdapter.unreactToMessage(this.federatedUser, this.message, reaction, this.redactsEvents);\n\t}\n}\n\nexport const getMessageRedactionHandler = async (\n\tinternalMessageAdapter: RocketChatMessageAdapter,\n\tredactsEvent: string,\n\tfederatedUser: FederatedUser,\n): Promise<IRoomRedactionHandler | undefined> => {\n\tconst message = await internalMessageAdapter.getMessageByFederationId(redactsEvent);\n\tconst messageWithReaction = await internalMessageAdapter.findOneByFederationIdOnReactions(redactsEvent, federatedUser);\n\tif (!message && !messageWithReaction) {\n\t\treturn;\n\t}\n\tif (messageWithReaction) {\n\t\treturn new UnreactToMessageHandler(internalMessageAdapter, messageWithReaction, federatedUser, redactsEvent);\n\t}\n\tif (message) {\n\t\treturn new DeleteMessageHandler(internalMessageAdapter, message, federatedUser);\n\t}\n};\n"]},"targets":{"android":"125.0.0","chrome":"125.0.0","edge":"125.0.0","firefox":"115.0.0","ie":"10.0.0","ios":"17.4.0","opera":"110.0.0","opera_mobile":"80.0.0","safari":"17.4.0","samsung":"24.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor","root":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":false,"enforceStrictMode":false,"dynamicImport":true,"generateLetDeclarations":true,"topLevelAwait":true},"externalDependencies":[]},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"version":"7.17.2","helpers":true,"useESModules":false,"corejs":false},"externalDependencies":[]},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-async-generator-functions","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-class-properties","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true},"externalDependencies":[]},{"key":"transform-react-jsx","visitor":{"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXFragment":{"exit":[null]},"JSXElement":{"exit":[null]},"JSXAttribute":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false},"externalDependencies":[]},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-nullish-coalescing-operator","visitor":{"LogicalExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-optional-chaining","visitor":{"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-optional-catch-binding","visitor":{"CatchClause":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-class-properties","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-async-generator-functions","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-logical-assignment-operators","visitor":{"AssignmentExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]}],"presets":[],"generatorOpts":{"filename":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/server/services/federation/application/room/message/receiver/message-redaction-helper.ts","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"server/services/federation/application/room/message/receiver/message-redaction-helper.ts","inputSourceMap":{"version":3,"file":"server/services/federation/application/room/message/receiver/message-redaction-helper.ts","sourceRoot":"","sources":["server/services/federation/application/room/message/receiver/message-redaction-helper.ts"],"names":[],"mappings":"AAEA,OAAO,EAAE,UAAU,EAAE,MAAM,wBAAwB,CAAC;AAQpD,MAAM,oBAAoB;IAEP;IACA;IACA;IAHlB,YACkB,sBAAgD,EAChD,OAAiB,EACjB,aAA4B;QAF5B,2BAAsB,GAAtB,sBAAsB,CAA0B;QAChD,YAAO,GAAP,OAAO,CAAU;QACjB,kBAAa,GAAb,aAAa,CAAe;IAC3C,CAAC;IAEG,KAAK,CAAC,MAAM;QAClB,MAAM,IAAI,CAAC,sBAAsB,CAAC,aAAa,CAAC,IAAI,CAAC,OAAO,EAAE,IAAI,CAAC,aAAa,CAAC,CAAC;IACnF,CAAC;CACD;AAED,MAAM,uBAAuB;IAEV;IACA;IACA;IACA;IAJlB,YACkB,sBAAgD,EAChD,OAAiB,EACjB,aAA4B,EAC5B,aAAqB;QAHrB,2BAAsB,GAAtB,sBAAsB,CAA0B;QAChD,YAAO,GAAP,OAAO,CAAU;QACjB,kBAAa,GAAb,aAAa,CAAe;QAC5B,kBAAa,GAAb,aAAa,CAAQ;IACpC,CAAC;IAEG,KAAK,CAAC,MAAM;QAClB,MAAM,iBAAiB,GAAG,UAAU,CAAC,+BAA+B,CAAC,IAAI,CAAC,aAAa,CAAC,CAAC;QACzF,MAAM,QAAQ,GAAG,MAAM,CAAC,IAAI,CAAC,IAAI,CAAC,OAAO,CAAC,SAAS,IAAI,EAAE,CAAC,CAAC,IAAI,CAC9D,CAAC,GAAG,EAAE,EAAE,CACP,IAAI,CAAC,OAAO,CAAC,SAAS,EAAE,CAAC,GAAG,CAAC,EAAE,0BAA0B,EAAE,CAAC,iBAAiB,CAAC,KAAK,IAAI,CAAC,aAAa,CAAC,WAAW,EAAE;YACnH,IAAI,CAAC,OAAO,CAAC,SAAS,EAAE,CAAC,GAAG,CAAC,EAAE,SAAS,EAAE,QAAQ,CAAC,IAAI,CAAC,aAAa,CAAC,WAAW,EAAE,IAAI,EAAE,CAAC,CAC3F,CAAC;QACF,IAAI,CAAC,QAAQ,EAAE,CAAC;YACf,OAAO;QACR,CAAC;QACD,MAAM,IAAI,CAAC,sBAAsB,CAAC,gBAAgB,CAAC,IAAI,CAAC,aAAa,EAAE,IAAI,CAAC,OAAO,EAAE,QAAQ,EAAE,IAAI,CAAC,aAAa,CAAC,CAAC;IACpH,CAAC;CACD;AAED,MAAM,CAAC,MAAM,0BAA0B,GAAG,KAAK,EAC9C,sBAAgD,EAChD,YAAoB,EACpB,aAA4B,EACiB,EAAE;IAC/C,MAAM,OAAO,GAAG,MAAM,sBAAsB,CAAC,wBAAwB,CAAC,YAAY,CAAC,CAAC;IACpF,MAAM,mBAAmB,GAAG,MAAM,sBAAsB,CAAC,gCAAgC,CAAC,YAAY,EAAE,aAAa,CAAC,CAAC;IACvH,IAAI,CAAC,OAAO,IAAI,CAAC,mBAAmB,EAAE,CAAC;QACtC,OAAO;IACR,CAAC;IACD,IAAI,mBAAmB,EAAE,CAAC;QACzB,OAAO,IAAI,uBAAuB,CAAC,sBAAsB,EAAE,mBAAmB,EAAE,aAAa,EAAE,YAAY,CAAC,CAAC;IAC9G,CAAC;IACD,IAAI,OAAO,EAAE,CAAC;QACb,OAAO,IAAI,oBAAoB,CAAC,sBAAsB,EAAE,OAAO,EAAE,aAAa,CAAC,CAAC;IACjF,CAAC;AACF,CAAC,CAAC","sourcesContent":["import type { IMessage } from '@rocket.chat/core-typings';\n\nimport { Federation } from '../../../../Federation';\nimport type { FederatedUser } from '../../../../domain/FederatedUser';\nimport type { RocketChatMessageAdapter } from '../../../../infrastructure/rocket-chat/adapters/Message';\n\ninterface IRoomRedactionHandler {\n\thandle(): Promise<void>;\n}\n\nclass DeleteMessageHandler implements IRoomRedactionHandler {\n\tconstructor(\n\t\tprivate readonly internalMessageAdapter: RocketChatMessageAdapter,\n\t\tprivate readonly message: IMessage,\n\t\tprivate readonly federatedUser: FederatedUser,\n\t) {}\n\n\tpublic async handle(): Promise<void> {\n\t\tawait this.internalMessageAdapter.deleteMessage(this.message, this.federatedUser);\n\t}\n}\n\nclass UnreactToMessageHandler implements IRoomRedactionHandler {\n\tconstructor(\n\t\tprivate readonly internalMessageAdapter: RocketChatMessageAdapter,\n\t\tprivate readonly message: IMessage,\n\t\tprivate readonly federatedUser: FederatedUser,\n\t\tprivate readonly redactsEvents: string,\n\t) {}\n\n\tpublic async handle(): Promise<void> {\n\t\tconst normalizedEventId = Federation.escapeExternalFederationEventId(this.redactsEvents);\n\t\tconst reaction = Object.keys(this.message.reactions || {}).find(\n\t\t\t(key) =>\n\t\t\t\tthis.message.reactions?.[key]?.federationReactionEventIds?.[normalizedEventId] === this.federatedUser.getUsername() &&\n\t\t\t\tthis.message.reactions?.[key]?.usernames?.includes(this.federatedUser.getUsername() || ''),\n\t\t);\n\t\tif (!reaction) {\n\t\t\treturn;\n\t\t}\n\t\tawait this.internalMessageAdapter.unreactToMessage(this.federatedUser, this.message, reaction, this.redactsEvents);\n\t}\n}\n\nexport const getMessageRedactionHandler = async (\n\tinternalMessageAdapter: RocketChatMessageAdapter,\n\tredactsEvent: string,\n\tfederatedUser: FederatedUser,\n): Promise<IRoomRedactionHandler | undefined> => {\n\tconst message = await internalMessageAdapter.getMessageByFederationId(redactsEvent);\n\tconst messageWithReaction = await internalMessageAdapter.findOneByFederationIdOnReactions(redactsEvent, federatedUser);\n\tif (!message && !messageWithReaction) {\n\t\treturn;\n\t}\n\tif (messageWithReaction) {\n\t\treturn new UnreactToMessageHandler(internalMessageAdapter, messageWithReaction, federatedUser, redactsEvent);\n\t}\n\tif (message) {\n\t\treturn new DeleteMessageHandler(internalMessageAdapter, message, federatedUser);\n\t}\n};\n"]}}},"code":"!module.wrapAsync(async function (module, __reifyWaitForDeps__, __reify_async_result__) {\n  \"use strict\";\n  try {\n    module.export({\n      getMessageRedactionHandler: () => getMessageRedactionHandler\n    });\n    let Federation;\n    module.link(\"../../../../Federation\", {\n      Federation(v) {\n        Federation = v;\n      }\n    }, 0);\n    if (__reifyWaitForDeps__()) (await __reifyWaitForDeps__())();\n    class DeleteMessageHandler {\n      constructor(internalMessageAdapter, message, federatedUser) {\n        this.internalMessageAdapter = void 0;\n        this.message = void 0;\n        this.federatedUser = void 0;\n        this.internalMessageAdapter = internalMessageAdapter;\n        this.message = message;\n        this.federatedUser = federatedUser;\n      }\n      async handle() {\n        await this.internalMessageAdapter.deleteMessage(this.message, this.federatedUser);\n      }\n    }\n    class UnreactToMessageHandler {\n      constructor(internalMessageAdapter, message, federatedUser, redactsEvents) {\n        this.internalMessageAdapter = void 0;\n        this.message = void 0;\n        this.federatedUser = void 0;\n        this.redactsEvents = void 0;\n        this.internalMessageAdapter = internalMessageAdapter;\n        this.message = message;\n        this.federatedUser = federatedUser;\n        this.redactsEvents = redactsEvents;\n      }\n      async handle() {\n        const normalizedEventId = Federation.escapeExternalFederationEventId(this.redactsEvents);\n        const reaction = Object.keys(this.message.reactions || {}).find(key => {\n          var _this$message$reactio, _this$message$reactio2, _this$message$reactio3, _this$message$reactio4, _this$message$reactio5, _this$message$reactio6;\n          return ((_this$message$reactio = this.message.reactions) === null || _this$message$reactio === void 0 ? void 0 : (_this$message$reactio2 = _this$message$reactio[key]) === null || _this$message$reactio2 === void 0 ? void 0 : (_this$message$reactio3 = _this$message$reactio2.federationReactionEventIds) === null || _this$message$reactio3 === void 0 ? void 0 : _this$message$reactio3[normalizedEventId]) === this.federatedUser.getUsername() && ((_this$message$reactio4 = this.message.reactions) === null || _this$message$reactio4 === void 0 ? void 0 : (_this$message$reactio5 = _this$message$reactio4[key]) === null || _this$message$reactio5 === void 0 ? void 0 : (_this$message$reactio6 = _this$message$reactio5.usernames) === null || _this$message$reactio6 === void 0 ? void 0 : _this$message$reactio6.includes(this.federatedUser.getUsername() || ''));\n        });\n        if (!reaction) {\n          return;\n        }\n        await this.internalMessageAdapter.unreactToMessage(this.federatedUser, this.message, reaction, this.redactsEvents);\n      }\n    }\n    const getMessageRedactionHandler = async (internalMessageAdapter, redactsEvent, federatedUser) => {\n      const message = await internalMessageAdapter.getMessageByFederationId(redactsEvent);\n      const messageWithReaction = await internalMessageAdapter.findOneByFederationIdOnReactions(redactsEvent, federatedUser);\n      if (!message && !messageWithReaction) {\n        return;\n      }\n      if (messageWithReaction) {\n        return new UnreactToMessageHandler(internalMessageAdapter, messageWithReaction, federatedUser, redactsEvent);\n      }\n      if (message) {\n        return new DeleteMessageHandler(internalMessageAdapter, message, federatedUser);\n      }\n    };\n    __reify_async_result__();\n  } catch (_reifyError) {\n    return __reify_async_result__(_reifyError);\n  }\n  __reify_async_result__()\n}, {\n  self: this,\n  async: false\n});","map":{"version":3,"names":["module","export","getMessageRedactionHandler","Federation","link","v","__reifyWaitForDeps__","DeleteMessageHandler","constructor","internalMessageAdapter","message","federatedUser","handle","deleteMessage","UnreactToMessageHandler","redactsEvents","normalizedEventId","escapeExternalFederationEventId","reaction","Object","keys","reactions","find","key","_this$message$reactio","_this$message$reactio2","_this$message$reactio3","_this$message$reactio4","_this$message$reactio5","_this$message$reactio6","federationReactionEventIds","getUsername","usernames","includes","unreactToMessage","redactsEvent","getMessageByFederationId","messageWithReaction","findOneByFederationIdOnReactions","__reify_async_result__","_reifyError","self","async"],"sources":["server/services/federation/application/room/message/receiver/message-redaction-helper.ts"],"sourcesContent":["import type { IMessage } from '@rocket.chat/core-typings';\n\nimport { Federation } from '../../../../Federation';\nimport type { FederatedUser } from '../../../../domain/FederatedUser';\nimport type { RocketChatMessageAdapter } from '../../../../infrastructure/rocket-chat/adapters/Message';\n\ninterface IRoomRedactionHandler {\n\thandle(): Promise<void>;\n}\n\nclass DeleteMessageHandler implements IRoomRedactionHandler {\n\tconstructor(\n\t\tprivate readonly internalMessageAdapter: RocketChatMessageAdapter,\n\t\tprivate readonly message: IMessage,\n\t\tprivate readonly federatedUser: FederatedUser,\n\t) {}\n\n\tpublic async handle(): Promise<void> {\n\t\tawait this.internalMessageAdapter.deleteMessage(this.message, this.federatedUser);\n\t}\n}\n\nclass UnreactToMessageHandler implements IRoomRedactionHandler {\n\tconstructor(\n\t\tprivate readonly internalMessageAdapter: RocketChatMessageAdapter,\n\t\tprivate readonly message: IMessage,\n\t\tprivate readonly federatedUser: FederatedUser,\n\t\tprivate readonly redactsEvents: string,\n\t) {}\n\n\tpublic async handle(): Promise<void> {\n\t\tconst normalizedEventId = Federation.escapeExternalFederationEventId(this.redactsEvents);\n\t\tconst reaction = Object.keys(this.message.reactions || {}).find(\n\t\t\t(key) =>\n\t\t\t\tthis.message.reactions?.[key]?.federationReactionEventIds?.[normalizedEventId] === this.federatedUser.getUsername() &&\n\t\t\t\tthis.message.reactions?.[key]?.usernames?.includes(this.federatedUser.getUsername() || ''),\n\t\t);\n\t\tif (!reaction) {\n\t\t\treturn;\n\t\t}\n\t\tawait this.internalMessageAdapter.unreactToMessage(this.federatedUser, this.message, reaction, this.redactsEvents);\n\t}\n}\n\nexport const getMessageRedactionHandler = async (\n\tinternalMessageAdapter: RocketChatMessageAdapter,\n\tredactsEvent: string,\n\tfederatedUser: FederatedUser,\n): Promise<IRoomRedactionHandler | undefined> => {\n\tconst message = await internalMessageAdapter.getMessageByFederationId(redactsEvent);\n\tconst messageWithReaction = await internalMessageAdapter.findOneByFederationIdOnReactions(redactsEvent, federatedUser);\n\tif (!message && !messageWithReaction) {\n\t\treturn;\n\t}\n\tif (messageWithReaction) {\n\t\treturn new UnreactToMessageHandler(internalMessageAdapter, messageWithReaction, federatedUser, redactsEvent);\n\t}\n\tif (message) {\n\t\treturn new DeleteMessageHandler(internalMessageAdapter, message, federatedUser);\n\t}\n};\n"],"mappings":"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","ignoreList":[]},"sourceType":"module","externalDependencies":{},"hash":"8c119e9afe281f746f360cfe16573dcd9b188ed5"}
