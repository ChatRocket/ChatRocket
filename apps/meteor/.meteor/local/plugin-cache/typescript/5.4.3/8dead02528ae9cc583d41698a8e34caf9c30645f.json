{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/client/lib/chats/flows/uploadFiles.ts","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","topLevelAwait","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"web.browser"},"sourceFileName":"client/lib/chats/flows/uploadFiles.ts","filename":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/client/lib/chats/flows/uploadFiles.ts","inputSourceMap":{"version":3,"file":"client/lib/chats/flows/uploadFiles.ts","sourceRoot":"","sources":["client/lib/chats/flows/uploadFiles.ts"],"names":[],"mappings":"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","sourcesContent":["import type { IMessage, FileAttachmentProps, IE2EEMessage, IUpload } from '@rocket.chat/core-typings';\nimport { isRoomFederated } from '@rocket.chat/core-typings';\n\nimport { e2e } from '../../../../app/e2e/client';\nimport { settings } from '../../../../app/settings/client';\nimport { fileUploadIsValidContentType } from '../../../../app/utils/client';\nimport { getFileExtension } from '../../../../lib/utils/getFileExtension';\nimport FileUploadModal from '../../../views/room/modals/FileUploadModal';\nimport { imperativeModal } from '../../imperativeModal';\nimport { prependReplies } from '../../utils/prependReplies';\nimport type { ChatAPI } from '../ChatAPI';\n\nconst getHeightAndWidthFromDataUrl = (dataURL: string): Promise<{ height: number; width: number }> => {\n\treturn new Promise((resolve) => {\n\t\tconst img = new Image();\n\t\timg.onload = () => {\n\t\t\tresolve({\n\t\t\t\theight: img.height,\n\t\t\t\twidth: img.width,\n\t\t\t});\n\t\t};\n\t\timg.src = dataURL;\n\t});\n};\n\nexport const uploadFiles = async (chat: ChatAPI, files: readonly File[], resetFileInput?: () => void): Promise<void> => {\n\tconst replies = chat.composer?.quotedMessages.get() ?? [];\n\n\tconst msg = await prependReplies('', replies);\n\n\tconst room = await chat.data.getRoom();\n\n\tconst queue = [...files];\n\n\tconst uploadFile = (\n\t\tfile: File,\n\t\textraData?: Pick<IMessage, 't' | 'e2e'> & { description?: string },\n\t\tgetContent?: (fileId: string, fileUrl: string) => Promise<IE2EEMessage['content']>,\n\t\tfileContent?: { raw: Partial<IUpload>; encrypted: IE2EEMessage['content'] },\n\t) => {\n\t\tchat.uploads.send(\n\t\t\tfile,\n\t\t\t{\n\t\t\t\tmsg,\n\t\t\t\t...extraData,\n\t\t\t},\n\t\t\tgetContent,\n\t\t\tfileContent,\n\t\t);\n\t\tchat.composer?.clear();\n\t\timperativeModal.close();\n\t\tuploadNextFile();\n\t};\n\n\tconst uploadNextFile = (): void => {\n\t\tconst file = queue.pop();\n\t\tif (!file) {\n\t\t\tchat.composer?.dismissAllQuotedMessages();\n\t\t\treturn;\n\t\t}\n\n\t\timperativeModal.open({\n\t\t\tcomponent: FileUploadModal,\n\t\t\tprops: {\n\t\t\t\tfile,\n\t\t\t\tfileName: file.name,\n\t\t\t\tfileDescription: chat.composer?.text ?? '',\n\t\t\t\tshowDescription: room && !isRoomFederated(room),\n\t\t\t\tonClose: (): void => {\n\t\t\t\t\timperativeModal.close();\n\t\t\t\t\tuploadNextFile();\n\t\t\t\t},\n\t\t\t\tonSubmit: async (fileName: string, description?: string): Promise<void> => {\n\t\t\t\t\tObject.defineProperty(file, 'name', {\n\t\t\t\t\t\twritable: true,\n\t\t\t\t\t\tvalue: fileName,\n\t\t\t\t\t});\n\n\t\t\t\t\t// encrypt attachment description\n\t\t\t\t\tconst e2eRoom = await e2e.getInstanceByRoomId(room._id);\n\n\t\t\t\t\tif (!e2eRoom) {\n\t\t\t\t\t\tuploadFile(file, { description });\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tif (!settings.get('E2E_Enable_Encrypt_Files')) {\n\t\t\t\t\t\tuploadFile(file, { description });\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tconst shouldConvertSentMessages = await e2eRoom.shouldConvertSentMessages({ msg });\n\n\t\t\t\t\tif (!shouldConvertSentMessages) {\n\t\t\t\t\t\tuploadFile(file, { description });\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tconst encryptedFile = await e2eRoom.encryptFile(file);\n\n\t\t\t\t\tif (encryptedFile) {\n\t\t\t\t\t\tconst getContent = async (_id: string, fileUrl: string): Promise<IE2EEMessage['content']> => {\n\t\t\t\t\t\t\tconst attachments = [];\n\n\t\t\t\t\t\t\tconst attachment: FileAttachmentProps = {\n\t\t\t\t\t\t\t\ttitle: file.name,\n\t\t\t\t\t\t\t\ttype: 'file',\n\t\t\t\t\t\t\t\tdescription,\n\t\t\t\t\t\t\t\ttitle_link: fileUrl,\n\t\t\t\t\t\t\t\ttitle_link_download: true,\n\t\t\t\t\t\t\t\tencryption: {\n\t\t\t\t\t\t\t\t\tkey: encryptedFile.key,\n\t\t\t\t\t\t\t\t\tiv: encryptedFile.iv,\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\thashes: {\n\t\t\t\t\t\t\t\t\tsha256: encryptedFile.hash,\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t};\n\n\t\t\t\t\t\t\tif (/^image\\/.+/.test(file.type)) {\n\t\t\t\t\t\t\t\tconst dimensions = await getHeightAndWidthFromDataUrl(window.URL.createObjectURL(file));\n\n\t\t\t\t\t\t\t\tattachments.push({\n\t\t\t\t\t\t\t\t\t...attachment,\n\t\t\t\t\t\t\t\t\timage_url: fileUrl,\n\t\t\t\t\t\t\t\t\timage_type: file.type,\n\t\t\t\t\t\t\t\t\timage_size: file.size,\n\t\t\t\t\t\t\t\t\t...(dimensions && {\n\t\t\t\t\t\t\t\t\t\timage_dimensions: dimensions,\n\t\t\t\t\t\t\t\t\t}),\n\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t} else if (/^audio\\/.+/.test(file.type)) {\n\t\t\t\t\t\t\t\tattachments.push({\n\t\t\t\t\t\t\t\t\t...attachment,\n\t\t\t\t\t\t\t\t\taudio_url: fileUrl,\n\t\t\t\t\t\t\t\t\taudio_type: file.type,\n\t\t\t\t\t\t\t\t\taudio_size: file.size,\n\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t} else if (/^video\\/.+/.test(file.type)) {\n\t\t\t\t\t\t\t\tattachments.push({\n\t\t\t\t\t\t\t\t\t...attachment,\n\t\t\t\t\t\t\t\t\tvideo_url: fileUrl,\n\t\t\t\t\t\t\t\t\tvideo_type: file.type,\n\t\t\t\t\t\t\t\t\tvideo_size: file.size,\n\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\tattachments.push({\n\t\t\t\t\t\t\t\t\t...attachment,\n\t\t\t\t\t\t\t\t\tsize: file.size,\n\t\t\t\t\t\t\t\t\tformat: getFileExtension(file.name),\n\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\tconst files = [\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t_id,\n\t\t\t\t\t\t\t\t\tname: file.name,\n\t\t\t\t\t\t\t\t\ttype: file.type,\n\t\t\t\t\t\t\t\t\tsize: file.size,\n\t\t\t\t\t\t\t\t\t// \"format\": \"png\"\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t];\n\n\t\t\t\t\t\t\treturn e2eRoom.encryptMessageContent({\n\t\t\t\t\t\t\t\tattachments,\n\t\t\t\t\t\t\t\tfiles,\n\t\t\t\t\t\t\t\tfile: files[0],\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t};\n\n\t\t\t\t\t\tconst fileContentData = {\n\t\t\t\t\t\t\ttype: file.type,\n\t\t\t\t\t\t\ttypeGroup: file.type.split('/')[0],\n\t\t\t\t\t\t\tname: fileName,\n\t\t\t\t\t\t\tencryption: {\n\t\t\t\t\t\t\t\tkey: encryptedFile.key,\n\t\t\t\t\t\t\t\tiv: encryptedFile.iv,\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\thashes: {\n\t\t\t\t\t\t\t\tsha256: encryptedFile.hash,\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t};\n\n\t\t\t\t\t\tconst fileContent = {\n\t\t\t\t\t\t\traw: fileContentData,\n\t\t\t\t\t\t\tencrypted: await e2eRoom.encryptMessageContent(fileContentData),\n\t\t\t\t\t\t};\n\n\t\t\t\t\t\tuploadFile(\n\t\t\t\t\t\t\tencryptedFile.file,\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tt: 'e2e',\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\tgetContent,\n\t\t\t\t\t\t\tfileContent,\n\t\t\t\t\t\t);\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\tinvalidContentType: !fileUploadIsValidContentType(file?.type),\n\t\t\t},\n\t\t});\n\t};\n\n\tuploadNextFile();\n\tresetFileInput?.();\n};\n"]},"targets":{"android":"125.0.0","chrome":"125.0.0","edge":"125.0.0","firefox":"115.0.0","ie":"10.0.0","ios":"17.4.0","opera":"110.0.0","opera_mobile":"80.0.0","safari":"17.4.0","samsung":"24.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor","root":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":false,"enforceStrictMode":false,"dynamicImport":true,"generateLetDeclarations":true},"externalDependencies":[]},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"version":"7.17.2","helpers":true,"useESModules":false,"corejs":false},"externalDependencies":[]},{"key":"proposal-class-properties","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true},"externalDependencies":[]},{"key":"transform-react-jsx","visitor":{"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXFragment":{"exit":[null]},"JSXElement":{"exit":[null]},"JSXAttribute":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false},"externalDependencies":[]},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-nullish-coalescing-operator","visitor":{"LogicalExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-optional-chaining","visitor":{"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-optional-catch-binding","visitor":{"CatchClause":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-class-properties","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-async-generator-functions","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-logical-assignment-operators","visitor":{"AssignmentExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]}],"presets":[],"generatorOpts":{"filename":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/client/lib/chats/flows/uploadFiles.ts","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"client/lib/chats/flows/uploadFiles.ts","inputSourceMap":{"version":3,"file":"client/lib/chats/flows/uploadFiles.ts","sourceRoot":"","sources":["client/lib/chats/flows/uploadFiles.ts"],"names":[],"mappings":"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","sourcesContent":["import type { IMessage, FileAttachmentProps, IE2EEMessage, IUpload } from '@rocket.chat/core-typings';\nimport { isRoomFederated } from '@rocket.chat/core-typings';\n\nimport { e2e } from '../../../../app/e2e/client';\nimport { settings } from '../../../../app/settings/client';\nimport { fileUploadIsValidContentType } from '../../../../app/utils/client';\nimport { getFileExtension } from '../../../../lib/utils/getFileExtension';\nimport FileUploadModal from '../../../views/room/modals/FileUploadModal';\nimport { imperativeModal } from '../../imperativeModal';\nimport { prependReplies } from '../../utils/prependReplies';\nimport type { ChatAPI } from '../ChatAPI';\n\nconst getHeightAndWidthFromDataUrl = (dataURL: string): Promise<{ height: number; width: number }> => {\n\treturn new Promise((resolve) => {\n\t\tconst img = new Image();\n\t\timg.onload = () => {\n\t\t\tresolve({\n\t\t\t\theight: img.height,\n\t\t\t\twidth: img.width,\n\t\t\t});\n\t\t};\n\t\timg.src = dataURL;\n\t});\n};\n\nexport const uploadFiles = async (chat: ChatAPI, files: readonly File[], resetFileInput?: () => void): Promise<void> => {\n\tconst replies = chat.composer?.quotedMessages.get() ?? [];\n\n\tconst msg = await prependReplies('', replies);\n\n\tconst room = await chat.data.getRoom();\n\n\tconst queue = [...files];\n\n\tconst uploadFile = (\n\t\tfile: File,\n\t\textraData?: Pick<IMessage, 't' | 'e2e'> & { description?: string },\n\t\tgetContent?: (fileId: string, fileUrl: string) => Promise<IE2EEMessage['content']>,\n\t\tfileContent?: { raw: Partial<IUpload>; encrypted: IE2EEMessage['content'] },\n\t) => {\n\t\tchat.uploads.send(\n\t\t\tfile,\n\t\t\t{\n\t\t\t\tmsg,\n\t\t\t\t...extraData,\n\t\t\t},\n\t\t\tgetContent,\n\t\t\tfileContent,\n\t\t);\n\t\tchat.composer?.clear();\n\t\timperativeModal.close();\n\t\tuploadNextFile();\n\t};\n\n\tconst uploadNextFile = (): void => {\n\t\tconst file = queue.pop();\n\t\tif (!file) {\n\t\t\tchat.composer?.dismissAllQuotedMessages();\n\t\t\treturn;\n\t\t}\n\n\t\timperativeModal.open({\n\t\t\tcomponent: FileUploadModal,\n\t\t\tprops: {\n\t\t\t\tfile,\n\t\t\t\tfileName: file.name,\n\t\t\t\tfileDescription: chat.composer?.text ?? '',\n\t\t\t\tshowDescription: room && !isRoomFederated(room),\n\t\t\t\tonClose: (): void => {\n\t\t\t\t\timperativeModal.close();\n\t\t\t\t\tuploadNextFile();\n\t\t\t\t},\n\t\t\t\tonSubmit: async (fileName: string, description?: string): Promise<void> => {\n\t\t\t\t\tObject.defineProperty(file, 'name', {\n\t\t\t\t\t\twritable: true,\n\t\t\t\t\t\tvalue: fileName,\n\t\t\t\t\t});\n\n\t\t\t\t\t// encrypt attachment description\n\t\t\t\t\tconst e2eRoom = await e2e.getInstanceByRoomId(room._id);\n\n\t\t\t\t\tif (!e2eRoom) {\n\t\t\t\t\t\tuploadFile(file, { description });\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tif (!settings.get('E2E_Enable_Encrypt_Files')) {\n\t\t\t\t\t\tuploadFile(file, { description });\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tconst shouldConvertSentMessages = await e2eRoom.shouldConvertSentMessages({ msg });\n\n\t\t\t\t\tif (!shouldConvertSentMessages) {\n\t\t\t\t\t\tuploadFile(file, { description });\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tconst encryptedFile = await e2eRoom.encryptFile(file);\n\n\t\t\t\t\tif (encryptedFile) {\n\t\t\t\t\t\tconst getContent = async (_id: string, fileUrl: string): Promise<IE2EEMessage['content']> => {\n\t\t\t\t\t\t\tconst attachments = [];\n\n\t\t\t\t\t\t\tconst attachment: FileAttachmentProps = {\n\t\t\t\t\t\t\t\ttitle: file.name,\n\t\t\t\t\t\t\t\ttype: 'file',\n\t\t\t\t\t\t\t\tdescription,\n\t\t\t\t\t\t\t\ttitle_link: fileUrl,\n\t\t\t\t\t\t\t\ttitle_link_download: true,\n\t\t\t\t\t\t\t\tencryption: {\n\t\t\t\t\t\t\t\t\tkey: encryptedFile.key,\n\t\t\t\t\t\t\t\t\tiv: encryptedFile.iv,\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\thashes: {\n\t\t\t\t\t\t\t\t\tsha256: encryptedFile.hash,\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t};\n\n\t\t\t\t\t\t\tif (/^image\\/.+/.test(file.type)) {\n\t\t\t\t\t\t\t\tconst dimensions = await getHeightAndWidthFromDataUrl(window.URL.createObjectURL(file));\n\n\t\t\t\t\t\t\t\tattachments.push({\n\t\t\t\t\t\t\t\t\t...attachment,\n\t\t\t\t\t\t\t\t\timage_url: fileUrl,\n\t\t\t\t\t\t\t\t\timage_type: file.type,\n\t\t\t\t\t\t\t\t\timage_size: file.size,\n\t\t\t\t\t\t\t\t\t...(dimensions && {\n\t\t\t\t\t\t\t\t\t\timage_dimensions: dimensions,\n\t\t\t\t\t\t\t\t\t}),\n\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t} else if (/^audio\\/.+/.test(file.type)) {\n\t\t\t\t\t\t\t\tattachments.push({\n\t\t\t\t\t\t\t\t\t...attachment,\n\t\t\t\t\t\t\t\t\taudio_url: fileUrl,\n\t\t\t\t\t\t\t\t\taudio_type: file.type,\n\t\t\t\t\t\t\t\t\taudio_size: file.size,\n\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t} else if (/^video\\/.+/.test(file.type)) {\n\t\t\t\t\t\t\t\tattachments.push({\n\t\t\t\t\t\t\t\t\t...attachment,\n\t\t\t\t\t\t\t\t\tvideo_url: fileUrl,\n\t\t\t\t\t\t\t\t\tvideo_type: file.type,\n\t\t\t\t\t\t\t\t\tvideo_size: file.size,\n\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\tattachments.push({\n\t\t\t\t\t\t\t\t\t...attachment,\n\t\t\t\t\t\t\t\t\tsize: file.size,\n\t\t\t\t\t\t\t\t\tformat: getFileExtension(file.name),\n\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\tconst files = [\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t_id,\n\t\t\t\t\t\t\t\t\tname: file.name,\n\t\t\t\t\t\t\t\t\ttype: file.type,\n\t\t\t\t\t\t\t\t\tsize: file.size,\n\t\t\t\t\t\t\t\t\t// \"format\": \"png\"\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t];\n\n\t\t\t\t\t\t\treturn e2eRoom.encryptMessageContent({\n\t\t\t\t\t\t\t\tattachments,\n\t\t\t\t\t\t\t\tfiles,\n\t\t\t\t\t\t\t\tfile: files[0],\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t};\n\n\t\t\t\t\t\tconst fileContentData = {\n\t\t\t\t\t\t\ttype: file.type,\n\t\t\t\t\t\t\ttypeGroup: file.type.split('/')[0],\n\t\t\t\t\t\t\tname: fileName,\n\t\t\t\t\t\t\tencryption: {\n\t\t\t\t\t\t\t\tkey: encryptedFile.key,\n\t\t\t\t\t\t\t\tiv: encryptedFile.iv,\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\thashes: {\n\t\t\t\t\t\t\t\tsha256: encryptedFile.hash,\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t};\n\n\t\t\t\t\t\tconst fileContent = {\n\t\t\t\t\t\t\traw: fileContentData,\n\t\t\t\t\t\t\tencrypted: await e2eRoom.encryptMessageContent(fileContentData),\n\t\t\t\t\t\t};\n\n\t\t\t\t\t\tuploadFile(\n\t\t\t\t\t\t\tencryptedFile.file,\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tt: 'e2e',\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\tgetContent,\n\t\t\t\t\t\t\tfileContent,\n\t\t\t\t\t\t);\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\tinvalidContentType: !fileUploadIsValidContentType(file?.type),\n\t\t\t},\n\t\t});\n\t};\n\n\tuploadNextFile();\n\tresetFileInput?.();\n};\n"]}}},"code":"let _objectSpread;\nmodule.link(\"@babel/runtime/helpers/objectSpread2\", {\n  default(v) {\n    _objectSpread = v;\n  }\n}, 0);\nmodule.export({\n  uploadFiles: () => uploadFiles\n});\nlet isRoomFederated;\nmodule.link(\"@rocket.chat/core-typings\", {\n  isRoomFederated(v) {\n    isRoomFederated = v;\n  }\n}, 0);\nlet e2e;\nmodule.link(\"../../../../app/e2e/client\", {\n  e2e(v) {\n    e2e = v;\n  }\n}, 1);\nlet settings;\nmodule.link(\"../../../../app/settings/client\", {\n  settings(v) {\n    settings = v;\n  }\n}, 2);\nlet fileUploadIsValidContentType;\nmodule.link(\"../../../../app/utils/client\", {\n  fileUploadIsValidContentType(v) {\n    fileUploadIsValidContentType = v;\n  }\n}, 3);\nlet getFileExtension;\nmodule.link(\"../../../../lib/utils/getFileExtension\", {\n  getFileExtension(v) {\n    getFileExtension = v;\n  }\n}, 4);\nlet FileUploadModal;\nmodule.link(\"../../../views/room/modals/FileUploadModal\", {\n  default(v) {\n    FileUploadModal = v;\n  }\n}, 5);\nlet imperativeModal;\nmodule.link(\"../../imperativeModal\", {\n  imperativeModal(v) {\n    imperativeModal = v;\n  }\n}, 6);\nlet prependReplies;\nmodule.link(\"../../utils/prependReplies\", {\n  prependReplies(v) {\n    prependReplies = v;\n  }\n}, 7);\nconst getHeightAndWidthFromDataUrl = dataURL => {\n  return new Promise(resolve => {\n    const img = new Image();\n    img.onload = () => {\n      resolve({\n        height: img.height,\n        width: img.width\n      });\n    };\n    img.src = dataURL;\n  });\n};\nconst uploadFiles = async (chat, files, resetFileInput) => {\n  var _chat$composer$quoted, _chat$composer;\n  const replies = (_chat$composer$quoted = (_chat$composer = chat.composer) === null || _chat$composer === void 0 ? void 0 : _chat$composer.quotedMessages.get()) !== null && _chat$composer$quoted !== void 0 ? _chat$composer$quoted : [];\n  const msg = await prependReplies('', replies);\n  const room = await chat.data.getRoom();\n  const queue = [...files];\n  const uploadFile = (file, extraData, getContent, fileContent) => {\n    var _chat$composer2;\n    chat.uploads.send(file, _objectSpread({\n      msg\n    }, extraData), getContent, fileContent);\n    (_chat$composer2 = chat.composer) === null || _chat$composer2 === void 0 ? void 0 : _chat$composer2.clear();\n    imperativeModal.close();\n    uploadNextFile();\n  };\n  const uploadNextFile = () => {\n    var _chat$composer$text, _chat$composer4;\n    const file = queue.pop();\n    if (!file) {\n      var _chat$composer3;\n      (_chat$composer3 = chat.composer) === null || _chat$composer3 === void 0 ? void 0 : _chat$composer3.dismissAllQuotedMessages();\n      return;\n    }\n    imperativeModal.open({\n      component: FileUploadModal,\n      props: {\n        file,\n        fileName: file.name,\n        fileDescription: (_chat$composer$text = (_chat$composer4 = chat.composer) === null || _chat$composer4 === void 0 ? void 0 : _chat$composer4.text) !== null && _chat$composer$text !== void 0 ? _chat$composer$text : '',\n        showDescription: room && !isRoomFederated(room),\n        onClose: () => {\n          imperativeModal.close();\n          uploadNextFile();\n        },\n        onSubmit: async (fileName, description) => {\n          Object.defineProperty(file, 'name', {\n            writable: true,\n            value: fileName\n          });\n          // encrypt attachment description\n          const e2eRoom = await e2e.getInstanceByRoomId(room._id);\n          if (!e2eRoom) {\n            uploadFile(file, {\n              description\n            });\n            return;\n          }\n          if (!settings.get('E2E_Enable_Encrypt_Files')) {\n            uploadFile(file, {\n              description\n            });\n            return;\n          }\n          const shouldConvertSentMessages = await e2eRoom.shouldConvertSentMessages({\n            msg\n          });\n          if (!shouldConvertSentMessages) {\n            uploadFile(file, {\n              description\n            });\n            return;\n          }\n          const encryptedFile = await e2eRoom.encryptFile(file);\n          if (encryptedFile) {\n            const getContent = async (_id, fileUrl) => {\n              const attachments = [];\n              const attachment = {\n                title: file.name,\n                type: 'file',\n                description,\n                title_link: fileUrl,\n                title_link_download: true,\n                encryption: {\n                  key: encryptedFile.key,\n                  iv: encryptedFile.iv\n                },\n                hashes: {\n                  sha256: encryptedFile.hash\n                }\n              };\n              if (/^image\\/.+/.test(file.type)) {\n                const dimensions = await getHeightAndWidthFromDataUrl(window.URL.createObjectURL(file));\n                attachments.push(_objectSpread(_objectSpread({}, attachment), {}, {\n                  image_url: fileUrl,\n                  image_type: file.type,\n                  image_size: file.size\n                }, dimensions && {\n                  image_dimensions: dimensions\n                }));\n              } else if (/^audio\\/.+/.test(file.type)) {\n                attachments.push(_objectSpread(_objectSpread({}, attachment), {}, {\n                  audio_url: fileUrl,\n                  audio_type: file.type,\n                  audio_size: file.size\n                }));\n              } else if (/^video\\/.+/.test(file.type)) {\n                attachments.push(_objectSpread(_objectSpread({}, attachment), {}, {\n                  video_url: fileUrl,\n                  video_type: file.type,\n                  video_size: file.size\n                }));\n              } else {\n                attachments.push(_objectSpread(_objectSpread({}, attachment), {}, {\n                  size: file.size,\n                  format: getFileExtension(file.name)\n                }));\n              }\n              const files = [{\n                _id,\n                name: file.name,\n                type: file.type,\n                size: file.size\n                // \"format\": \"png\"\n              }];\n              return e2eRoom.encryptMessageContent({\n                attachments,\n                files,\n                file: files[0]\n              });\n            };\n            const fileContentData = {\n              type: file.type,\n              typeGroup: file.type.split('/')[0],\n              name: fileName,\n              encryption: {\n                key: encryptedFile.key,\n                iv: encryptedFile.iv\n              },\n              hashes: {\n                sha256: encryptedFile.hash\n              }\n            };\n            const fileContent = {\n              raw: fileContentData,\n              encrypted: await e2eRoom.encryptMessageContent(fileContentData)\n            };\n            uploadFile(encryptedFile.file, {\n              t: 'e2e'\n            }, getContent, fileContent);\n          }\n        },\n        invalidContentType: !fileUploadIsValidContentType(file === null || file === void 0 ? void 0 : file.type)\n      }\n    });\n  };\n  uploadNextFile();\n  resetFileInput === null || resetFileInput === void 0 ? void 0 : resetFileInput();\n};","map":{"version":3,"names":["_objectSpread","module","link","default","v","export","uploadFiles","isRoomFederated","e2e","settings","fileUploadIsValidContentType","getFileExtension","FileUploadModal","imperativeModal","prependReplies","getHeightAndWidthFromDataUrl","dataURL","Promise","resolve","img","Image","onload","height","width","src","chat","files","resetFileInput","_chat$composer$quoted","_chat$composer","replies","composer","quotedMessages","get","msg","room","data","getRoom","queue","uploadFile","file","extraData","getContent","fileContent","_chat$composer2","uploads","send","clear","close","uploadNextFile","_chat$composer$text","_chat$composer4","pop","_chat$composer3","dismissAllQuotedMessages","open","component","props","fileName","name","fileDescription","text","showDescription","onClose","onSubmit","description","Object","defineProperty","writable","value","e2eRoom","getInstanceByRoomId","_id","shouldConvertSentMessages","encryptedFile","encryptFile","fileUrl","attachments","attachment","title","type","title_link","title_link_download","encryption","key","iv","hashes","sha256","hash","test","dimensions","window","URL","createObjectURL","push","image_url","image_type","image_size","size","image_dimensions","audio_url","audio_type","audio_size","video_url","video_type","video_size","format","encryptMessageContent","fileContentData","typeGroup","split","raw","encrypted","t","invalidContentType"],"sources":["client/lib/chats/flows/uploadFiles.ts"],"sourcesContent":["import type { IMessage, FileAttachmentProps, IE2EEMessage, IUpload } from '@rocket.chat/core-typings';\nimport { isRoomFederated } from '@rocket.chat/core-typings';\n\nimport { e2e } from '../../../../app/e2e/client';\nimport { settings } from '../../../../app/settings/client';\nimport { fileUploadIsValidContentType } from '../../../../app/utils/client';\nimport { getFileExtension } from '../../../../lib/utils/getFileExtension';\nimport FileUploadModal from '../../../views/room/modals/FileUploadModal';\nimport { imperativeModal } from '../../imperativeModal';\nimport { prependReplies } from '../../utils/prependReplies';\nimport type { ChatAPI } from '../ChatAPI';\n\nconst getHeightAndWidthFromDataUrl = (dataURL: string): Promise<{ height: number; width: number }> => {\n\treturn new Promise((resolve) => {\n\t\tconst img = new Image();\n\t\timg.onload = () => {\n\t\t\tresolve({\n\t\t\t\theight: img.height,\n\t\t\t\twidth: img.width,\n\t\t\t});\n\t\t};\n\t\timg.src = dataURL;\n\t});\n};\n\nexport const uploadFiles = async (chat: ChatAPI, files: readonly File[], resetFileInput?: () => void): Promise<void> => {\n\tconst replies = chat.composer?.quotedMessages.get() ?? [];\n\n\tconst msg = await prependReplies('', replies);\n\n\tconst room = await chat.data.getRoom();\n\n\tconst queue = [...files];\n\n\tconst uploadFile = (\n\t\tfile: File,\n\t\textraData?: Pick<IMessage, 't' | 'e2e'> & { description?: string },\n\t\tgetContent?: (fileId: string, fileUrl: string) => Promise<IE2EEMessage['content']>,\n\t\tfileContent?: { raw: Partial<IUpload>; encrypted: IE2EEMessage['content'] },\n\t) => {\n\t\tchat.uploads.send(\n\t\t\tfile,\n\t\t\t{\n\t\t\t\tmsg,\n\t\t\t\t...extraData,\n\t\t\t},\n\t\t\tgetContent,\n\t\t\tfileContent,\n\t\t);\n\t\tchat.composer?.clear();\n\t\timperativeModal.close();\n\t\tuploadNextFile();\n\t};\n\n\tconst uploadNextFile = (): void => {\n\t\tconst file = queue.pop();\n\t\tif (!file) {\n\t\t\tchat.composer?.dismissAllQuotedMessages();\n\t\t\treturn;\n\t\t}\n\n\t\timperativeModal.open({\n\t\t\tcomponent: FileUploadModal,\n\t\t\tprops: {\n\t\t\t\tfile,\n\t\t\t\tfileName: file.name,\n\t\t\t\tfileDescription: chat.composer?.text ?? '',\n\t\t\t\tshowDescription: room && !isRoomFederated(room),\n\t\t\t\tonClose: (): void => {\n\t\t\t\t\timperativeModal.close();\n\t\t\t\t\tuploadNextFile();\n\t\t\t\t},\n\t\t\t\tonSubmit: async (fileName: string, description?: string): Promise<void> => {\n\t\t\t\t\tObject.defineProperty(file, 'name', {\n\t\t\t\t\t\twritable: true,\n\t\t\t\t\t\tvalue: fileName,\n\t\t\t\t\t});\n\n\t\t\t\t\t// encrypt attachment description\n\t\t\t\t\tconst e2eRoom = await e2e.getInstanceByRoomId(room._id);\n\n\t\t\t\t\tif (!e2eRoom) {\n\t\t\t\t\t\tuploadFile(file, { description });\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tif (!settings.get('E2E_Enable_Encrypt_Files')) {\n\t\t\t\t\t\tuploadFile(file, { description });\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tconst shouldConvertSentMessages = await e2eRoom.shouldConvertSentMessages({ msg });\n\n\t\t\t\t\tif (!shouldConvertSentMessages) {\n\t\t\t\t\t\tuploadFile(file, { description });\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tconst encryptedFile = await e2eRoom.encryptFile(file);\n\n\t\t\t\t\tif (encryptedFile) {\n\t\t\t\t\t\tconst getContent = async (_id: string, fileUrl: string): Promise<IE2EEMessage['content']> => {\n\t\t\t\t\t\t\tconst attachments = [];\n\n\t\t\t\t\t\t\tconst attachment: FileAttachmentProps = {\n\t\t\t\t\t\t\t\ttitle: file.name,\n\t\t\t\t\t\t\t\ttype: 'file',\n\t\t\t\t\t\t\t\tdescription,\n\t\t\t\t\t\t\t\ttitle_link: fileUrl,\n\t\t\t\t\t\t\t\ttitle_link_download: true,\n\t\t\t\t\t\t\t\tencryption: {\n\t\t\t\t\t\t\t\t\tkey: encryptedFile.key,\n\t\t\t\t\t\t\t\t\tiv: encryptedFile.iv,\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\thashes: {\n\t\t\t\t\t\t\t\t\tsha256: encryptedFile.hash,\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t};\n\n\t\t\t\t\t\t\tif (/^image\\/.+/.test(file.type)) {\n\t\t\t\t\t\t\t\tconst dimensions = await getHeightAndWidthFromDataUrl(window.URL.createObjectURL(file));\n\n\t\t\t\t\t\t\t\tattachments.push({\n\t\t\t\t\t\t\t\t\t...attachment,\n\t\t\t\t\t\t\t\t\timage_url: fileUrl,\n\t\t\t\t\t\t\t\t\timage_type: file.type,\n\t\t\t\t\t\t\t\t\timage_size: file.size,\n\t\t\t\t\t\t\t\t\t...(dimensions && {\n\t\t\t\t\t\t\t\t\t\timage_dimensions: dimensions,\n\t\t\t\t\t\t\t\t\t}),\n\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t} else if (/^audio\\/.+/.test(file.type)) {\n\t\t\t\t\t\t\t\tattachments.push({\n\t\t\t\t\t\t\t\t\t...attachment,\n\t\t\t\t\t\t\t\t\taudio_url: fileUrl,\n\t\t\t\t\t\t\t\t\taudio_type: file.type,\n\t\t\t\t\t\t\t\t\taudio_size: file.size,\n\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t} else if (/^video\\/.+/.test(file.type)) {\n\t\t\t\t\t\t\t\tattachments.push({\n\t\t\t\t\t\t\t\t\t...attachment,\n\t\t\t\t\t\t\t\t\tvideo_url: fileUrl,\n\t\t\t\t\t\t\t\t\tvideo_type: file.type,\n\t\t\t\t\t\t\t\t\tvideo_size: file.size,\n\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\tattachments.push({\n\t\t\t\t\t\t\t\t\t...attachment,\n\t\t\t\t\t\t\t\t\tsize: file.size,\n\t\t\t\t\t\t\t\t\tformat: getFileExtension(file.name),\n\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\tconst files = [\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t_id,\n\t\t\t\t\t\t\t\t\tname: file.name,\n\t\t\t\t\t\t\t\t\ttype: file.type,\n\t\t\t\t\t\t\t\t\tsize: file.size,\n\t\t\t\t\t\t\t\t\t// \"format\": \"png\"\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t];\n\n\t\t\t\t\t\t\treturn e2eRoom.encryptMessageContent({\n\t\t\t\t\t\t\t\tattachments,\n\t\t\t\t\t\t\t\tfiles,\n\t\t\t\t\t\t\t\tfile: files[0],\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t};\n\n\t\t\t\t\t\tconst fileContentData = {\n\t\t\t\t\t\t\ttype: file.type,\n\t\t\t\t\t\t\ttypeGroup: file.type.split('/')[0],\n\t\t\t\t\t\t\tname: fileName,\n\t\t\t\t\t\t\tencryption: {\n\t\t\t\t\t\t\t\tkey: encryptedFile.key,\n\t\t\t\t\t\t\t\tiv: encryptedFile.iv,\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\thashes: {\n\t\t\t\t\t\t\t\tsha256: encryptedFile.hash,\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t};\n\n\t\t\t\t\t\tconst fileContent = {\n\t\t\t\t\t\t\traw: fileContentData,\n\t\t\t\t\t\t\tencrypted: await e2eRoom.encryptMessageContent(fileContentData),\n\t\t\t\t\t\t};\n\n\t\t\t\t\t\tuploadFile(\n\t\t\t\t\t\t\tencryptedFile.file,\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tt: 'e2e',\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\tgetContent,\n\t\t\t\t\t\t\tfileContent,\n\t\t\t\t\t\t);\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\tinvalidContentType: !fileUploadIsValidContentType(file?.type),\n\t\t\t},\n\t\t});\n\t};\n\n\tuploadNextFile();\n\tresetFileInput?.();\n};\n"],"mappings":"AACA,IAAAA,aAAS;AAAAC,MAAe,CAAAC,IAAE,uCAAkC;EAAAC,QAAAC,CAAA;IAAAJ,aAAA,GAAAI,CAAA;EAAA;AAAA;AAA5DH,MAAA,CAAOI,MAAE;EAAAC,WAAiB,EAAAA,CAAA,KAAAA;AAAM;AAAA,IAAAC,eAA4B;AAAAN,MAAA,CAAAC,IAAA;EAAAK,gBAAAH,CAAA;IAAAG,eAAA,GAAAH,CAAA;EAAA;AAAA;AAAA,IAAAI,GAAA;AAAAP,MAAA,CAAAC,IAAA;EAAAM,IAAAJ,CAAA;IAAAI,GAAA,GAAAJ,CAAA;EAAA;AAAA;AAAA,IAAAK,QAAA;AAAAR,MAAA,CAAAC,IAAA;EAAAO,SAAAL,CAAA;IAAAK,QAAA,GAAAL,CAAA;EAAA;AAAA;AAAA,IAAAM,4BAAA;AAAAT,MAAA,CAAAC,IAAA;EAAAQ,6BAAAN,CAAA;IAAAM,4BAAA,GAAAN,CAAA;EAAA;AAAA;AAAA,IAAAO,gBAAA;AAAAV,MAAA,CAAAC,IAAA;EAAAS,iBAAAP,CAAA;IAAAO,gBAAA,GAAAP,CAAA;EAAA;AAAA;AAAA,IAAAQ,eAAA;AAAAX,MAAA,CAAAC,IAAA;EAAAC,QAAAC,CAAA;IAAAQ,eAAA,GAAAR,CAAA;EAAA;AAAA;AAAA,IAAAS,eAAA;AAAAZ,MAAA,CAAAC,IAAA;EAAAW,gBAAAT,CAAA;IAAAS,eAAA,GAAAT,CAAA;EAAA;AAAA;AAAA,IAAAU,cAAA;AAAAb,MAAA,CAAAC,IAAA;EAAAY,eAAAV,CAAA;IAAAU,cAAA,GAAAV,CAAA;EAAA;AAAA;AAW5D,MAAMW,4BAA4B,GAAIC,OAAe,IAAgD;EACpG,OAAO,IAAIC,OAAO,CAAEC,OAAO,IAAI;IAC9B,MAAMC,GAAG,GAAG,IAAIC,KAAK,EAAE;IACvBD,GAAG,CAACE,MAAM,GAAG,MAAK;MACjBH,OAAO,CAAC;QACPI,MAAM,EAAEH,GAAG,CAACG,MAAM;QAClBC,KAAK,EAAEJ,GAAG,CAACI;OACX,CAAC;IACH,CAAC;IACDJ,GAAG,CAACK,GAAG,GAAGR,OAAO;EAClB,CAAC,CAAC;AACH,CAAC;AAEM,MAAMV,WAAW,GAAG,MAAAA,CAAOmB,IAAa,EAAEC,KAAsB,EAAEC,cAA2B,KAAmB;EAAA,IAAAC,qBAAA,EAAAC,cAAA;EACtH,MAAMC,OAAO,IAAAF,qBAAA,IAAAC,cAAA,GAAGJ,IAAI,CAACM,QAAQ,cAAAF,cAAA,uBAAbA,cAAA,CAAeG,cAAc,CAACC,GAAG,EAAE,cAAAL,qBAAA,cAAAA,qBAAA,GAAI,EAAE;EAEzD,MAAMM,GAAG,GAAG,MAAMpB,cAAc,CAAC,EAAE,EAAEgB,OAAO,CAAC;EAE7C,MAAMK,IAAI,GAAG,MAAMV,IAAI,CAACW,IAAI,CAACC,OAAO,EAAE;EAEtC,MAAMC,KAAK,GAAG,CAAC,GAAGZ,KAAK,CAAC;EAExB,MAAMa,UAAU,GAAGA,CAClBC,IAAU,EACVC,SAAkE,EAClEC,UAAkF,EAClFC,WAA2E,KACxE;IAAA,IAAAC,eAAA;IACHnB,IAAI,CAACoB,OAAO,CAACC,IAAI,CAChBN,IAAI,EAAAxC,aAAA;MAEHkC;IAAG,GACAO,SAAS,GAEbC,UAAU,EACVC,WAAW,CACX;IACD,CAAAC,eAAA,GAAAnB,IAAI,CAACM,QAAQ,cAAAa,eAAA,uBAAbA,eAAA,CAAeG,KAAK,EAAE;IACtBlC,eAAe,CAACmC,KAAK,EAAE;IACvBC,cAAc,EAAE;EACjB,CAAC;EAED,MAAMA,cAAc,GAAGA,CAAA,KAAW;IAAA,IAAAC,mBAAA,EAAAC,eAAA;IACjC,MAAMX,IAAI,GAAGF,KAAK,CAACc,GAAG,EAAE;IACxB,IAAI,CAACZ,IAAI,EAAE;MAAA,IAAAa,eAAA;MACV,CAAAA,eAAA,GAAA5B,IAAI,CAACM,QAAQ,cAAAsB,eAAA,uBAAbA,eAAA,CAAeC,wBAAwB,EAAE;MACzC;IACD;IAEAzC,eAAe,CAAC0C,IAAI,CAAC;MACpBC,SAAS,EAAE5C,eAAe;MAC1B6C,KAAK,EAAE;QACNjB,IAAI;QACJkB,QAAQ,EAAElB,IAAI,CAACmB,IAAI;QACnBC,eAAe,GAAAV,mBAAA,IAAAC,eAAA,GAAE1B,IAAI,CAACM,QAAQ,cAAAoB,eAAA,uBAAbA,eAAA,CAAeU,IAAI,cAAAX,mBAAA,cAAAA,mBAAA,GAAI,EAAE;QAC1CY,eAAe,EAAE3B,IAAI,IAAI,CAAC5B,eAAe,CAAC4B,IAAI,CAAC;QAC/C4B,OAAO,EAAEA,CAAA,KAAW;UACnBlD,eAAe,CAACmC,KAAK,EAAE;UACvBC,cAAc,EAAE;QACjB,CAAC;QACDe,QAAQ,EAAE,MAAAA,CAAON,QAAgB,EAAEO,WAAoB,KAAmB;UACzEC,MAAM,CAACC,cAAc,CAAC3B,IAAI,EAAE,MAAM,EAAE;YACnC4B,QAAQ,EAAE,IAAI;YACdC,KAAK,EAAEX;WACP,CAAC;UAEF;UACA,MAAMY,OAAO,GAAG,MAAM9D,GAAG,CAAC+D,mBAAmB,CAACpC,IAAI,CAACqC,GAAG,CAAC;UAEvD,IAAI,CAACF,OAAO,EAAE;YACb/B,UAAU,CAACC,IAAI,EAAE;cAAEyB;YAAW,CAAE,CAAC;YACjC;UACD;UAEA,IAAI,CAACxD,QAAQ,CAACwB,GAAG,CAAC,0BAA0B,CAAC,EAAE;YAC9CM,UAAU,CAACC,IAAI,EAAE;cAAEyB;YAAW,CAAE,CAAC;YACjC;UACD;UAEA,MAAMQ,yBAAyB,GAAG,MAAMH,OAAO,CAACG,yBAAyB,CAAC;YAAEvC;UAAG,CAAE,CAAC;UAElF,IAAI,CAACuC,yBAAyB,EAAE;YAC/BlC,UAAU,CAACC,IAAI,EAAE;cAAEyB;YAAW,CAAE,CAAC;YACjC;UACD;UAEA,MAAMS,aAAa,GAAG,MAAMJ,OAAO,CAACK,WAAW,CAACnC,IAAI,CAAC;UAErD,IAAIkC,aAAa,EAAE;YAClB,MAAMhC,UAAU,GAAG,MAAAA,CAAO8B,GAAW,EAAEI,OAAe,KAAsC;cAC3F,MAAMC,WAAW,GAAG,EAAE;cAEtB,MAAMC,UAAU,GAAwB;gBACvCC,KAAK,EAAEvC,IAAI,CAACmB,IAAI;gBAChBqB,IAAI,EAAE,MAAM;gBACZf,WAAW;gBACXgB,UAAU,EAAEL,OAAO;gBACnBM,mBAAmB,EAAE,IAAI;gBACzBC,UAAU,EAAE;kBACXC,GAAG,EAAEV,aAAa,CAACU,GAAG;kBACtBC,EAAE,EAAEX,aAAa,CAACW;iBAClB;gBACDC,MAAM,EAAE;kBACPC,MAAM,EAAEb,aAAa,CAACc;;eAEvB;cAED,IAAI,YAAY,CAACC,IAAI,CAACjD,IAAI,CAACwC,IAAI,CAAC,EAAE;gBACjC,MAAMU,UAAU,GAAG,MAAM3E,4BAA4B,CAAC4E,MAAM,CAACC,GAAG,CAACC,eAAe,CAACrD,IAAI,CAAC,CAAC;gBAEvFqC,WAAW,CAACiB,IAAI,CAAA9F,aAAA,CAAAA,aAAA,KACZ8E,UAAU;kBACbiB,SAAS,EAAEnB,OAAO;kBAClBoB,UAAU,EAAExD,IAAI,CAACwC,IAAI;kBACrBiB,UAAU,EAAEzD,IAAI,CAAC0D;gBAAI,GACjBR,UAAU,IAAI;kBACjBS,gBAAgB,EAAET;iBAClB,CACD,CAAC;cACH,CAAC,MAAM,IAAI,YAAY,CAACD,IAAI,CAACjD,IAAI,CAACwC,IAAI,CAAC,EAAE;gBACxCH,WAAW,CAACiB,IAAI,CAAA9F,aAAA,CAAAA,aAAA,KACZ8E,UAAU;kBACbsB,SAAS,EAAExB,OAAO;kBAClByB,UAAU,EAAE7D,IAAI,CAACwC,IAAI;kBACrBsB,UAAU,EAAE9D,IAAI,CAAC0D;gBAAI,EACrB,CAAC;cACH,CAAC,MAAM,IAAI,YAAY,CAACT,IAAI,CAACjD,IAAI,CAACwC,IAAI,CAAC,EAAE;gBACxCH,WAAW,CAACiB,IAAI,CAAA9F,aAAA,CAAAA,aAAA,KACZ8E,UAAU;kBACbyB,SAAS,EAAE3B,OAAO;kBAClB4B,UAAU,EAAEhE,IAAI,CAACwC,IAAI;kBACrByB,UAAU,EAAEjE,IAAI,CAAC0D;gBAAI,EACrB,CAAC;cACH,CAAC,MAAM;gBACNrB,WAAW,CAACiB,IAAI,CAAA9F,aAAA,CAAAA,aAAA,KACZ8E,UAAU;kBACboB,IAAI,EAAE1D,IAAI,CAAC0D,IAAI;kBACfQ,MAAM,EAAE/F,gBAAgB,CAAC6B,IAAI,CAACmB,IAAI;gBAAC,EACnC,CAAC;cACH;cAEA,MAAMjC,KAAK,GAAG,CACb;gBACC8C,GAAG;gBACHb,IAAI,EAAEnB,IAAI,CAACmB,IAAI;gBACfqB,IAAI,EAAExC,IAAI,CAACwC,IAAI;gBACfkB,IAAI,EAAE1D,IAAI,CAAC0D;gBACX;eACA,CACD;cAED,OAAO5B,OAAO,CAACqC,qBAAqB,CAAC;gBACpC9B,WAAW;gBACXnD,KAAK;gBACLc,IAAI,EAAEd,KAAK,CAAC,CAAC;eACb,CAAC;YACH,CAAC;YAED,MAAMkF,eAAe,GAAG;cACvB5B,IAAI,EAAExC,IAAI,CAACwC,IAAI;cACf6B,SAAS,EAAErE,IAAI,CAACwC,IAAI,CAAC8B,KAAK,CAAC,GAAG,CAAC,CAAC,CAAC,CAAC;cAClCnD,IAAI,EAAED,QAAQ;cACdyB,UAAU,EAAE;gBACXC,GAAG,EAAEV,aAAa,CAACU,GAAG;gBACtBC,EAAE,EAAEX,aAAa,CAACW;eAClB;cACDC,MAAM,EAAE;gBACPC,MAAM,EAAEb,aAAa,CAACc;;aAEvB;YAED,MAAM7C,WAAW,GAAG;cACnBoE,GAAG,EAAEH,eAAe;cACpBI,SAAS,EAAE,MAAM1C,OAAO,CAACqC,qBAAqB,CAACC,eAAe;aAC9D;YAEDrE,UAAU,CACTmC,aAAa,CAAClC,IAAI,EAClB;cACCyE,CAAC,EAAE;aACH,EACDvE,UAAU,EACVC,WAAW,CACX;UACF;QACD,CAAC;QACDuE,kBAAkB,EAAE,CAACxG,4BAA4B,CAAC8B,IAAI,aAAJA,IAAI,uBAAJA,IAAI,CAAEwC,IAAI;;KAE7D,CAAC;EACH,CAAC;EAED/B,cAAc,EAAE;EAChBtB,cAAc,aAAdA,cAAc,uBAAdA,cAAc,CAAE,CAAE;AACnB,CAAC","ignoreList":[]},"sourceType":"module","externalDependencies":{},"hash":"8dead02528ae9cc583d41698a8e34caf9c30645f"}
