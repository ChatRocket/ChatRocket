{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/app/cloud/server/functions/syncWorkspace/legacySyncWorkspace.ts","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","topLevelAwait","objectRestSpread","objectRestSpread","asyncGenerators","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"os.osx.arm64"},"sourceFileName":"app/cloud/server/functions/syncWorkspace/legacySyncWorkspace.ts","filename":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/app/cloud/server/functions/syncWorkspace/legacySyncWorkspace.ts","inputSourceMap":{"version":3,"file":"app/cloud/server/functions/syncWorkspace/legacySyncWorkspace.ts","sourceRoot":"","sources":["app/cloud/server/functions/syncWorkspace/legacySyncWorkspace.ts"],"names":[],"mappings":"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","sourcesContent":["import { type Cloud, type Serialized } from '@rocket.chat/core-typings';\nimport { Settings } from '@rocket.chat/models';\nimport { serverFetch as fetch } from '@rocket.chat/server-fetch';\nimport { v, compile } from 'suretype';\n\nimport { CloudWorkspaceConnectionError } from '../../../../../lib/errors/CloudWorkspaceConnectionError';\nimport { CloudWorkspaceRegistrationError } from '../../../../../lib/errors/CloudWorkspaceRegistrationError';\nimport { notifyOnSettingChangedById } from '../../../../lib/server/lib/notifyListener';\nimport { settings } from '../../../../settings/server';\nimport type { WorkspaceRegistrationData } from '../buildRegistrationData';\nimport { buildWorkspaceRegistrationData } from '../buildRegistrationData';\nimport { CloudWorkspaceAccessTokenEmptyError, getWorkspaceAccessToken } from '../getWorkspaceAccessToken';\nimport { getWorkspaceLicense } from '../getWorkspaceLicense';\nimport { retrieveRegistrationStatus } from '../retrieveRegistrationStatus';\nimport { handleBannerOnWorkspaceSync, handleNpsOnWorkspaceSync } from './handleCommsSync';\n\nconst workspaceClientPayloadSchema = v.object({\n\tworkspaceId: v.string().required(),\n\tpublicKey: v.string(),\n\ttrial: v.object({\n\t\ttrialing: v.boolean().required(),\n\t\ttrialID: v.string().required(),\n\t\tendDate: v.string().format('date-time').required(),\n\t\tmarketing: v\n\t\t\t.object({\n\t\t\t\tutmContent: v.string().required(),\n\t\t\t\tutmMedium: v.string().required(),\n\t\t\t\tutmSource: v.string().required(),\n\t\t\t\tutmCampaign: v.string().required(),\n\t\t\t})\n\t\t\t.required(),\n\t\tDowngradesToPlan: v\n\t\t\t.object({\n\t\t\t\tid: v.string().required(),\n\t\t\t})\n\t\t\t.required(),\n\t\ttrialRequested: v.boolean().required(),\n\t}),\n\tnps: v.object({\n\t\tid: v.string().required(),\n\t\tstartAt: v.string().format('date-time').required(),\n\t\texpireAt: v.string().format('date-time').required(),\n\t}),\n\tbanners: v.array(\n\t\tv.object({\n\t\t\t_id: v.string().required(),\n\t\t\t_updatedAt: v.string().format('date-time').required(),\n\t\t\tplatform: v.array(v.string()).required(),\n\t\t\texpireAt: v.string().format('date-time').required(),\n\t\t\tstartAt: v.string().format('date-time').required(),\n\t\t\troles: v.array(v.string()),\n\t\t\tcreatedBy: v.object({\n\t\t\t\t_id: v.string().required(),\n\t\t\t\tusername: v.string(),\n\t\t\t}),\n\t\t\tcreatedAt: v.string().format('date-time').required(),\n\t\t\tview: v.any(),\n\t\t\tactive: v.boolean(),\n\t\t\tinactivedAt: v.string().format('date-time'),\n\t\t\tsnapshot: v.string(),\n\t\t}),\n\t),\n\tannouncements: v.object({\n\t\tcreate: v.array(\n\t\t\tv.object({\n\t\t\t\t_id: v.string().required(),\n\t\t\t\t_updatedAt: v.string().format('date-time').required(),\n\t\t\t\tselector: v.object({\n\t\t\t\t\troles: v.array(v.string()),\n\t\t\t\t}),\n\t\t\t\tplatform: v.array(v.string().enum('web', 'mobile')).required(),\n\t\t\t\texpireAt: v.string().format('date-time').required(),\n\t\t\t\tstartAt: v.string().format('date-time').required(),\n\t\t\t\tcreatedBy: v.string().enum('cloud', 'system').required(),\n\t\t\t\tcreatedAt: v.string().format('date-time').required(),\n\t\t\t\tdictionary: v.object({}).additional(v.object({}).additional(v.string())),\n\t\t\t\tview: v.any(),\n\t\t\t\tsurface: v.string().enum('banner', 'modal').required(),\n\t\t\t}),\n\t\t),\n\t\tdelete: v.array(v.string()),\n\t}),\n});\n\nconst assertWorkspaceClientPayload = compile(workspaceClientPayloadSchema);\n\n/** @deprecated */\nconst fetchWorkspaceClientPayload = async ({\n\ttoken,\n\tworkspaceRegistrationData,\n}: {\n\ttoken: string;\n\tworkspaceRegistrationData: WorkspaceRegistrationData<undefined>;\n}): Promise<Serialized<Cloud.WorkspaceSyncPayload> | undefined> => {\n\tconst workspaceRegistrationClientUri = settings.get<string>('Cloud_Workspace_Registration_Client_Uri');\n\tconst response = await fetch(`${workspaceRegistrationClientUri}/client`, {\n\t\tmethod: 'POST',\n\t\theaders: {\n\t\t\tAuthorization: `Bearer ${token}`,\n\t\t},\n\t\tbody: workspaceRegistrationData,\n\t\ttimeout: 5000,\n\t});\n\n\tif (!response.ok) {\n\t\ttry {\n\t\t\tconst { error } = await response.json();\n\t\t\tthrow new CloudWorkspaceConnectionError(`Failed to connect to Rocket.Chat Cloud: ${error}`);\n\t\t} catch (error) {\n\t\t\tthrow new CloudWorkspaceConnectionError(`Failed to connect to Rocket.Chat Cloud: ${response.statusText}`);\n\t\t}\n\t}\n\n\tconst payload = await response.json();\n\n\tif (!payload) {\n\t\treturn undefined;\n\t}\n\n\tif (!assertWorkspaceClientPayload(payload)) {\n\t\tthrow new CloudWorkspaceConnectionError('Invalid response from Rocket.Chat Cloud');\n\t}\n\n\treturn payload;\n};\n\n/** @deprecated */\nconst consumeWorkspaceSyncPayload = async (result: Serialized<Cloud.WorkspaceSyncPayload>) => {\n\tif (result.publicKey) {\n\t\t(await Settings.updateValueById('Cloud_Workspace_PublicKey', result.publicKey)).modifiedCount &&\n\t\t\tvoid notifyOnSettingChangedById('Cloud_Workspace_PublicKey');\n\t}\n\n\tif (result.trial?.trialID) {\n\t\t(await Settings.updateValueById('Cloud_Workspace_Had_Trial', true)).modifiedCount &&\n\t\t\tvoid notifyOnSettingChangedById('Cloud_Workspace_Had_Trial');\n\t}\n\n\t// add banners\n\tif (result.banners) {\n\t\tawait handleBannerOnWorkspaceSync(result.banners);\n\t}\n\n\tif (result.nps) {\n\t\tawait handleNpsOnWorkspaceSync(result.nps);\n\t}\n};\n\n/** @deprecated */\nexport async function legacySyncWorkspace() {\n\tconst { workspaceRegistered } = await retrieveRegistrationStatus();\n\tif (!workspaceRegistered) {\n\t\tthrow new CloudWorkspaceRegistrationError('Workspace is not registered');\n\t}\n\n\tconst token = await getWorkspaceAccessToken(true);\n\tif (!token) {\n\t\tthrow new CloudWorkspaceAccessTokenEmptyError();\n\t}\n\n\tconst workspaceRegistrationData = await buildWorkspaceRegistrationData(undefined);\n\n\tconst payload = await fetchWorkspaceClientPayload({ token, workspaceRegistrationData });\n\n\tif (payload) {\n\t\tawait consumeWorkspaceSyncPayload(payload);\n\t}\n\n\tawait getWorkspaceLicense();\n\n\treturn true;\n}\n"]},"targets":{"android":"125.0.0","chrome":"125.0.0","edge":"125.0.0","firefox":"115.0.0","ie":"10.0.0","ios":"17.4.0","opera":"110.0.0","opera_mobile":"80.0.0","safari":"17.4.0","samsung":"24.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor","root":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":false,"enforceStrictMode":false,"dynamicImport":true,"generateLetDeclarations":true,"topLevelAwait":true},"externalDependencies":[]},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"version":"7.17.2","helpers":true,"useESModules":false,"corejs":false},"externalDependencies":[]},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-async-generator-functions","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-class-properties","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true},"externalDependencies":[]},{"key":"transform-react-jsx","visitor":{"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXFragment":{"exit":[null]},"JSXElement":{"exit":[null]},"JSXAttribute":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false},"externalDependencies":[]},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-nullish-coalescing-operator","visitor":{"LogicalExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-optional-chaining","visitor":{"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-optional-catch-binding","visitor":{"CatchClause":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-class-properties","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-async-generator-functions","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-logical-assignment-operators","visitor":{"AssignmentExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]}],"presets":[],"generatorOpts":{"filename":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/app/cloud/server/functions/syncWorkspace/legacySyncWorkspace.ts","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"app/cloud/server/functions/syncWorkspace/legacySyncWorkspace.ts","inputSourceMap":{"version":3,"file":"app/cloud/server/functions/syncWorkspace/legacySyncWorkspace.ts","sourceRoot":"","sources":["app/cloud/server/functions/syncWorkspace/legacySyncWorkspace.ts"],"names":[],"mappings":"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","sourcesContent":["import { type Cloud, type Serialized } from '@rocket.chat/core-typings';\nimport { Settings } from '@rocket.chat/models';\nimport { serverFetch as fetch } from '@rocket.chat/server-fetch';\nimport { v, compile } from 'suretype';\n\nimport { CloudWorkspaceConnectionError } from '../../../../../lib/errors/CloudWorkspaceConnectionError';\nimport { CloudWorkspaceRegistrationError } from '../../../../../lib/errors/CloudWorkspaceRegistrationError';\nimport { notifyOnSettingChangedById } from '../../../../lib/server/lib/notifyListener';\nimport { settings } from '../../../../settings/server';\nimport type { WorkspaceRegistrationData } from '../buildRegistrationData';\nimport { buildWorkspaceRegistrationData } from '../buildRegistrationData';\nimport { CloudWorkspaceAccessTokenEmptyError, getWorkspaceAccessToken } from '../getWorkspaceAccessToken';\nimport { getWorkspaceLicense } from '../getWorkspaceLicense';\nimport { retrieveRegistrationStatus } from '../retrieveRegistrationStatus';\nimport { handleBannerOnWorkspaceSync, handleNpsOnWorkspaceSync } from './handleCommsSync';\n\nconst workspaceClientPayloadSchema = v.object({\n\tworkspaceId: v.string().required(),\n\tpublicKey: v.string(),\n\ttrial: v.object({\n\t\ttrialing: v.boolean().required(),\n\t\ttrialID: v.string().required(),\n\t\tendDate: v.string().format('date-time').required(),\n\t\tmarketing: v\n\t\t\t.object({\n\t\t\t\tutmContent: v.string().required(),\n\t\t\t\tutmMedium: v.string().required(),\n\t\t\t\tutmSource: v.string().required(),\n\t\t\t\tutmCampaign: v.string().required(),\n\t\t\t})\n\t\t\t.required(),\n\t\tDowngradesToPlan: v\n\t\t\t.object({\n\t\t\t\tid: v.string().required(),\n\t\t\t})\n\t\t\t.required(),\n\t\ttrialRequested: v.boolean().required(),\n\t}),\n\tnps: v.object({\n\t\tid: v.string().required(),\n\t\tstartAt: v.string().format('date-time').required(),\n\t\texpireAt: v.string().format('date-time').required(),\n\t}),\n\tbanners: v.array(\n\t\tv.object({\n\t\t\t_id: v.string().required(),\n\t\t\t_updatedAt: v.string().format('date-time').required(),\n\t\t\tplatform: v.array(v.string()).required(),\n\t\t\texpireAt: v.string().format('date-time').required(),\n\t\t\tstartAt: v.string().format('date-time').required(),\n\t\t\troles: v.array(v.string()),\n\t\t\tcreatedBy: v.object({\n\t\t\t\t_id: v.string().required(),\n\t\t\t\tusername: v.string(),\n\t\t\t}),\n\t\t\tcreatedAt: v.string().format('date-time').required(),\n\t\t\tview: v.any(),\n\t\t\tactive: v.boolean(),\n\t\t\tinactivedAt: v.string().format('date-time'),\n\t\t\tsnapshot: v.string(),\n\t\t}),\n\t),\n\tannouncements: v.object({\n\t\tcreate: v.array(\n\t\t\tv.object({\n\t\t\t\t_id: v.string().required(),\n\t\t\t\t_updatedAt: v.string().format('date-time').required(),\n\t\t\t\tselector: v.object({\n\t\t\t\t\troles: v.array(v.string()),\n\t\t\t\t}),\n\t\t\t\tplatform: v.array(v.string().enum('web', 'mobile')).required(),\n\t\t\t\texpireAt: v.string().format('date-time').required(),\n\t\t\t\tstartAt: v.string().format('date-time').required(),\n\t\t\t\tcreatedBy: v.string().enum('cloud', 'system').required(),\n\t\t\t\tcreatedAt: v.string().format('date-time').required(),\n\t\t\t\tdictionary: v.object({}).additional(v.object({}).additional(v.string())),\n\t\t\t\tview: v.any(),\n\t\t\t\tsurface: v.string().enum('banner', 'modal').required(),\n\t\t\t}),\n\t\t),\n\t\tdelete: v.array(v.string()),\n\t}),\n});\n\nconst assertWorkspaceClientPayload = compile(workspaceClientPayloadSchema);\n\n/** @deprecated */\nconst fetchWorkspaceClientPayload = async ({\n\ttoken,\n\tworkspaceRegistrationData,\n}: {\n\ttoken: string;\n\tworkspaceRegistrationData: WorkspaceRegistrationData<undefined>;\n}): Promise<Serialized<Cloud.WorkspaceSyncPayload> | undefined> => {\n\tconst workspaceRegistrationClientUri = settings.get<string>('Cloud_Workspace_Registration_Client_Uri');\n\tconst response = await fetch(`${workspaceRegistrationClientUri}/client`, {\n\t\tmethod: 'POST',\n\t\theaders: {\n\t\t\tAuthorization: `Bearer ${token}`,\n\t\t},\n\t\tbody: workspaceRegistrationData,\n\t\ttimeout: 5000,\n\t});\n\n\tif (!response.ok) {\n\t\ttry {\n\t\t\tconst { error } = await response.json();\n\t\t\tthrow new CloudWorkspaceConnectionError(`Failed to connect to Rocket.Chat Cloud: ${error}`);\n\t\t} catch (error) {\n\t\t\tthrow new CloudWorkspaceConnectionError(`Failed to connect to Rocket.Chat Cloud: ${response.statusText}`);\n\t\t}\n\t}\n\n\tconst payload = await response.json();\n\n\tif (!payload) {\n\t\treturn undefined;\n\t}\n\n\tif (!assertWorkspaceClientPayload(payload)) {\n\t\tthrow new CloudWorkspaceConnectionError('Invalid response from Rocket.Chat Cloud');\n\t}\n\n\treturn payload;\n};\n\n/** @deprecated */\nconst consumeWorkspaceSyncPayload = async (result: Serialized<Cloud.WorkspaceSyncPayload>) => {\n\tif (result.publicKey) {\n\t\t(await Settings.updateValueById('Cloud_Workspace_PublicKey', result.publicKey)).modifiedCount &&\n\t\t\tvoid notifyOnSettingChangedById('Cloud_Workspace_PublicKey');\n\t}\n\n\tif (result.trial?.trialID) {\n\t\t(await Settings.updateValueById('Cloud_Workspace_Had_Trial', true)).modifiedCount &&\n\t\t\tvoid notifyOnSettingChangedById('Cloud_Workspace_Had_Trial');\n\t}\n\n\t// add banners\n\tif (result.banners) {\n\t\tawait handleBannerOnWorkspaceSync(result.banners);\n\t}\n\n\tif (result.nps) {\n\t\tawait handleNpsOnWorkspaceSync(result.nps);\n\t}\n};\n\n/** @deprecated */\nexport async function legacySyncWorkspace() {\n\tconst { workspaceRegistered } = await retrieveRegistrationStatus();\n\tif (!workspaceRegistered) {\n\t\tthrow new CloudWorkspaceRegistrationError('Workspace is not registered');\n\t}\n\n\tconst token = await getWorkspaceAccessToken(true);\n\tif (!token) {\n\t\tthrow new CloudWorkspaceAccessTokenEmptyError();\n\t}\n\n\tconst workspaceRegistrationData = await buildWorkspaceRegistrationData(undefined);\n\n\tconst payload = await fetchWorkspaceClientPayload({ token, workspaceRegistrationData });\n\n\tif (payload) {\n\t\tawait consumeWorkspaceSyncPayload(payload);\n\t}\n\n\tawait getWorkspaceLicense();\n\n\treturn true;\n}\n"]}}},"code":"!module.wrapAsync(async function (module, __reifyWaitForDeps__, __reify_async_result__) {\n  \"use strict\";\n  try {\n    module.export({\n      legacySyncWorkspace: () => legacySyncWorkspace\n    });\n    let Settings;\n    module.link(\"@rocket.chat/models\", {\n      Settings(v) {\n        Settings = v;\n      }\n    }, 0);\n    let fetch;\n    module.link(\"@rocket.chat/server-fetch\", {\n      serverFetch(v) {\n        fetch = v;\n      }\n    }, 1);\n    let v, compile;\n    module.link(\"suretype\", {\n      v(_v) {\n        v = _v;\n      },\n      compile(v) {\n        compile = v;\n      }\n    }, 2);\n    let CloudWorkspaceConnectionError;\n    module.link(\"../../../../../lib/errors/CloudWorkspaceConnectionError\", {\n      CloudWorkspaceConnectionError(v) {\n        CloudWorkspaceConnectionError = v;\n      }\n    }, 3);\n    let CloudWorkspaceRegistrationError;\n    module.link(\"../../../../../lib/errors/CloudWorkspaceRegistrationError\", {\n      CloudWorkspaceRegistrationError(v) {\n        CloudWorkspaceRegistrationError = v;\n      }\n    }, 4);\n    let notifyOnSettingChangedById;\n    module.link(\"../../../../lib/server/lib/notifyListener\", {\n      notifyOnSettingChangedById(v) {\n        notifyOnSettingChangedById = v;\n      }\n    }, 5);\n    let settings;\n    module.link(\"../../../../settings/server\", {\n      settings(v) {\n        settings = v;\n      }\n    }, 6);\n    let buildWorkspaceRegistrationData;\n    module.link(\"../buildRegistrationData\", {\n      buildWorkspaceRegistrationData(v) {\n        buildWorkspaceRegistrationData = v;\n      }\n    }, 7);\n    let CloudWorkspaceAccessTokenEmptyError, getWorkspaceAccessToken;\n    module.link(\"../getWorkspaceAccessToken\", {\n      CloudWorkspaceAccessTokenEmptyError(v) {\n        CloudWorkspaceAccessTokenEmptyError = v;\n      },\n      getWorkspaceAccessToken(v) {\n        getWorkspaceAccessToken = v;\n      }\n    }, 8);\n    let getWorkspaceLicense;\n    module.link(\"../getWorkspaceLicense\", {\n      getWorkspaceLicense(v) {\n        getWorkspaceLicense = v;\n      }\n    }, 9);\n    let retrieveRegistrationStatus;\n    module.link(\"../retrieveRegistrationStatus\", {\n      retrieveRegistrationStatus(v) {\n        retrieveRegistrationStatus = v;\n      }\n    }, 10);\n    let handleBannerOnWorkspaceSync, handleNpsOnWorkspaceSync;\n    module.link(\"./handleCommsSync\", {\n      handleBannerOnWorkspaceSync(v) {\n        handleBannerOnWorkspaceSync = v;\n      },\n      handleNpsOnWorkspaceSync(v) {\n        handleNpsOnWorkspaceSync = v;\n      }\n    }, 11);\n    if (__reifyWaitForDeps__()) (await __reifyWaitForDeps__())();\n    const workspaceClientPayloadSchema = v.object({\n      workspaceId: v.string().required(),\n      publicKey: v.string(),\n      trial: v.object({\n        trialing: v.boolean().required(),\n        trialID: v.string().required(),\n        endDate: v.string().format('date-time').required(),\n        marketing: v.object({\n          utmContent: v.string().required(),\n          utmMedium: v.string().required(),\n          utmSource: v.string().required(),\n          utmCampaign: v.string().required()\n        }).required(),\n        DowngradesToPlan: v.object({\n          id: v.string().required()\n        }).required(),\n        trialRequested: v.boolean().required()\n      }),\n      nps: v.object({\n        id: v.string().required(),\n        startAt: v.string().format('date-time').required(),\n        expireAt: v.string().format('date-time').required()\n      }),\n      banners: v.array(v.object({\n        _id: v.string().required(),\n        _updatedAt: v.string().format('date-time').required(),\n        platform: v.array(v.string()).required(),\n        expireAt: v.string().format('date-time').required(),\n        startAt: v.string().format('date-time').required(),\n        roles: v.array(v.string()),\n        createdBy: v.object({\n          _id: v.string().required(),\n          username: v.string()\n        }),\n        createdAt: v.string().format('date-time').required(),\n        view: v.any(),\n        active: v.boolean(),\n        inactivedAt: v.string().format('date-time'),\n        snapshot: v.string()\n      })),\n      announcements: v.object({\n        create: v.array(v.object({\n          _id: v.string().required(),\n          _updatedAt: v.string().format('date-time').required(),\n          selector: v.object({\n            roles: v.array(v.string())\n          }),\n          platform: v.array(v.string().enum('web', 'mobile')).required(),\n          expireAt: v.string().format('date-time').required(),\n          startAt: v.string().format('date-time').required(),\n          createdBy: v.string().enum('cloud', 'system').required(),\n          createdAt: v.string().format('date-time').required(),\n          dictionary: v.object({}).additional(v.object({}).additional(v.string())),\n          view: v.any(),\n          surface: v.string().enum('banner', 'modal').required()\n        })),\n        delete: v.array(v.string())\n      })\n    });\n    const assertWorkspaceClientPayload = compile(workspaceClientPayloadSchema);\n    /** @deprecated */\n    const fetchWorkspaceClientPayload = async _ref => {\n      let {\n        token,\n        workspaceRegistrationData\n      } = _ref;\n      const workspaceRegistrationClientUri = settings.get('Cloud_Workspace_Registration_Client_Uri');\n      const response = await fetch(\"\".concat(workspaceRegistrationClientUri, \"/client\"), {\n        method: 'POST',\n        headers: {\n          Authorization: \"Bearer \".concat(token)\n        },\n        body: workspaceRegistrationData,\n        timeout: 5000\n      });\n      if (!response.ok) {\n        try {\n          const {\n            error\n          } = await response.json();\n          throw new CloudWorkspaceConnectionError(\"Failed to connect to Rocket.Chat Cloud: \".concat(error));\n        } catch (error) {\n          throw new CloudWorkspaceConnectionError(\"Failed to connect to Rocket.Chat Cloud: \".concat(response.statusText));\n        }\n      }\n      const payload = await response.json();\n      if (!payload) {\n        return undefined;\n      }\n      if (!assertWorkspaceClientPayload(payload)) {\n        throw new CloudWorkspaceConnectionError('Invalid response from Rocket.Chat Cloud');\n      }\n      return payload;\n    };\n    /** @deprecated */\n    const consumeWorkspaceSyncPayload = async result => {\n      var _result$trial;\n      if (result.publicKey) {\n        (await Settings.updateValueById('Cloud_Workspace_PublicKey', result.publicKey)).modifiedCount && void notifyOnSettingChangedById('Cloud_Workspace_PublicKey');\n      }\n      if ((_result$trial = result.trial) !== null && _result$trial !== void 0 && _result$trial.trialID) {\n        (await Settings.updateValueById('Cloud_Workspace_Had_Trial', true)).modifiedCount && void notifyOnSettingChangedById('Cloud_Workspace_Had_Trial');\n      }\n      // add banners\n      if (result.banners) {\n        await handleBannerOnWorkspaceSync(result.banners);\n      }\n      if (result.nps) {\n        await handleNpsOnWorkspaceSync(result.nps);\n      }\n    };\n    /** @deprecated */\n    async function legacySyncWorkspace() {\n      const {\n        workspaceRegistered\n      } = await retrieveRegistrationStatus();\n      if (!workspaceRegistered) {\n        throw new CloudWorkspaceRegistrationError('Workspace is not registered');\n      }\n      const token = await getWorkspaceAccessToken(true);\n      if (!token) {\n        throw new CloudWorkspaceAccessTokenEmptyError();\n      }\n      const workspaceRegistrationData = await buildWorkspaceRegistrationData(undefined);\n      const payload = await fetchWorkspaceClientPayload({\n        token,\n        workspaceRegistrationData\n      });\n      if (payload) {\n        await consumeWorkspaceSyncPayload(payload);\n      }\n      await getWorkspaceLicense();\n      return true;\n    }\n    __reify_async_result__();\n  } catch (_reifyError) {\n    return __reify_async_result__(_reifyError);\n  }\n  __reify_async_result__()\n}, {\n  self: this,\n  async: false\n});","map":{"version":3,"names":["module","export","legacySyncWorkspace","Settings","link","v","fetch","serverFetch","compile","_v","CloudWorkspaceConnectionError","CloudWorkspaceRegistrationError","notifyOnSettingChangedById","settings","buildWorkspaceRegistrationData","CloudWorkspaceAccessTokenEmptyError","getWorkspaceAccessToken","getWorkspaceLicense","retrieveRegistrationStatus","handleBannerOnWorkspaceSync","handleNpsOnWorkspaceSync","__reifyWaitForDeps__","workspaceClientPayloadSchema","object","workspaceId","string","required","publicKey","trial","trialing","boolean","trialID","endDate","format","marketing","utmContent","utmMedium","utmSource","utmCampaign","DowngradesToPlan","id","trialRequested","nps","startAt","expireAt","banners","array","_id","_updatedAt","platform","roles","createdBy","username","createdAt","view","any","active","inactivedAt","snapshot","announcements","create","selector","enum","dictionary","additional","surface","delete","assertWorkspaceClientPayload","fetchWorkspaceClientPayload","_ref","token","workspaceRegistrationData","workspaceRegistrationClientUri","get","response","concat","method","headers","Authorization","body","timeout","ok","error","json","statusText","payload","undefined","consumeWorkspaceSyncPayload","result","_result$trial","updateValueById","modifiedCount","workspaceRegistered","__reify_async_result__","_reifyError","self","async"],"sources":["app/cloud/server/functions/syncWorkspace/legacySyncWorkspace.ts"],"sourcesContent":["import { type Cloud, type Serialized } from '@rocket.chat/core-typings';\nimport { Settings } from '@rocket.chat/models';\nimport { serverFetch as fetch } from '@rocket.chat/server-fetch';\nimport { v, compile } from 'suretype';\n\nimport { CloudWorkspaceConnectionError } from '../../../../../lib/errors/CloudWorkspaceConnectionError';\nimport { CloudWorkspaceRegistrationError } from '../../../../../lib/errors/CloudWorkspaceRegistrationError';\nimport { notifyOnSettingChangedById } from '../../../../lib/server/lib/notifyListener';\nimport { settings } from '../../../../settings/server';\nimport type { WorkspaceRegistrationData } from '../buildRegistrationData';\nimport { buildWorkspaceRegistrationData } from '../buildRegistrationData';\nimport { CloudWorkspaceAccessTokenEmptyError, getWorkspaceAccessToken } from '../getWorkspaceAccessToken';\nimport { getWorkspaceLicense } from '../getWorkspaceLicense';\nimport { retrieveRegistrationStatus } from '../retrieveRegistrationStatus';\nimport { handleBannerOnWorkspaceSync, handleNpsOnWorkspaceSync } from './handleCommsSync';\n\nconst workspaceClientPayloadSchema = v.object({\n\tworkspaceId: v.string().required(),\n\tpublicKey: v.string(),\n\ttrial: v.object({\n\t\ttrialing: v.boolean().required(),\n\t\ttrialID: v.string().required(),\n\t\tendDate: v.string().format('date-time').required(),\n\t\tmarketing: v\n\t\t\t.object({\n\t\t\t\tutmContent: v.string().required(),\n\t\t\t\tutmMedium: v.string().required(),\n\t\t\t\tutmSource: v.string().required(),\n\t\t\t\tutmCampaign: v.string().required(),\n\t\t\t})\n\t\t\t.required(),\n\t\tDowngradesToPlan: v\n\t\t\t.object({\n\t\t\t\tid: v.string().required(),\n\t\t\t})\n\t\t\t.required(),\n\t\ttrialRequested: v.boolean().required(),\n\t}),\n\tnps: v.object({\n\t\tid: v.string().required(),\n\t\tstartAt: v.string().format('date-time').required(),\n\t\texpireAt: v.string().format('date-time').required(),\n\t}),\n\tbanners: v.array(\n\t\tv.object({\n\t\t\t_id: v.string().required(),\n\t\t\t_updatedAt: v.string().format('date-time').required(),\n\t\t\tplatform: v.array(v.string()).required(),\n\t\t\texpireAt: v.string().format('date-time').required(),\n\t\t\tstartAt: v.string().format('date-time').required(),\n\t\t\troles: v.array(v.string()),\n\t\t\tcreatedBy: v.object({\n\t\t\t\t_id: v.string().required(),\n\t\t\t\tusername: v.string(),\n\t\t\t}),\n\t\t\tcreatedAt: v.string().format('date-time').required(),\n\t\t\tview: v.any(),\n\t\t\tactive: v.boolean(),\n\t\t\tinactivedAt: v.string().format('date-time'),\n\t\t\tsnapshot: v.string(),\n\t\t}),\n\t),\n\tannouncements: v.object({\n\t\tcreate: v.array(\n\t\t\tv.object({\n\t\t\t\t_id: v.string().required(),\n\t\t\t\t_updatedAt: v.string().format('date-time').required(),\n\t\t\t\tselector: v.object({\n\t\t\t\t\troles: v.array(v.string()),\n\t\t\t\t}),\n\t\t\t\tplatform: v.array(v.string().enum('web', 'mobile')).required(),\n\t\t\t\texpireAt: v.string().format('date-time').required(),\n\t\t\t\tstartAt: v.string().format('date-time').required(),\n\t\t\t\tcreatedBy: v.string().enum('cloud', 'system').required(),\n\t\t\t\tcreatedAt: v.string().format('date-time').required(),\n\t\t\t\tdictionary: v.object({}).additional(v.object({}).additional(v.string())),\n\t\t\t\tview: v.any(),\n\t\t\t\tsurface: v.string().enum('banner', 'modal').required(),\n\t\t\t}),\n\t\t),\n\t\tdelete: v.array(v.string()),\n\t}),\n});\n\nconst assertWorkspaceClientPayload = compile(workspaceClientPayloadSchema);\n\n/** @deprecated */\nconst fetchWorkspaceClientPayload = async ({\n\ttoken,\n\tworkspaceRegistrationData,\n}: {\n\ttoken: string;\n\tworkspaceRegistrationData: WorkspaceRegistrationData<undefined>;\n}): Promise<Serialized<Cloud.WorkspaceSyncPayload> | undefined> => {\n\tconst workspaceRegistrationClientUri = settings.get<string>('Cloud_Workspace_Registration_Client_Uri');\n\tconst response = await fetch(`${workspaceRegistrationClientUri}/client`, {\n\t\tmethod: 'POST',\n\t\theaders: {\n\t\t\tAuthorization: `Bearer ${token}`,\n\t\t},\n\t\tbody: workspaceRegistrationData,\n\t\ttimeout: 5000,\n\t});\n\n\tif (!response.ok) {\n\t\ttry {\n\t\t\tconst { error } = await response.json();\n\t\t\tthrow new CloudWorkspaceConnectionError(`Failed to connect to Rocket.Chat Cloud: ${error}`);\n\t\t} catch (error) {\n\t\t\tthrow new CloudWorkspaceConnectionError(`Failed to connect to Rocket.Chat Cloud: ${response.statusText}`);\n\t\t}\n\t}\n\n\tconst payload = await response.json();\n\n\tif (!payload) {\n\t\treturn undefined;\n\t}\n\n\tif (!assertWorkspaceClientPayload(payload)) {\n\t\tthrow new CloudWorkspaceConnectionError('Invalid response from Rocket.Chat Cloud');\n\t}\n\n\treturn payload;\n};\n\n/** @deprecated */\nconst consumeWorkspaceSyncPayload = async (result: Serialized<Cloud.WorkspaceSyncPayload>) => {\n\tif (result.publicKey) {\n\t\t(await Settings.updateValueById('Cloud_Workspace_PublicKey', result.publicKey)).modifiedCount &&\n\t\t\tvoid notifyOnSettingChangedById('Cloud_Workspace_PublicKey');\n\t}\n\n\tif (result.trial?.trialID) {\n\t\t(await Settings.updateValueById('Cloud_Workspace_Had_Trial', true)).modifiedCount &&\n\t\t\tvoid notifyOnSettingChangedById('Cloud_Workspace_Had_Trial');\n\t}\n\n\t// add banners\n\tif (result.banners) {\n\t\tawait handleBannerOnWorkspaceSync(result.banners);\n\t}\n\n\tif (result.nps) {\n\t\tawait handleNpsOnWorkspaceSync(result.nps);\n\t}\n};\n\n/** @deprecated */\nexport async function legacySyncWorkspace() {\n\tconst { workspaceRegistered } = await retrieveRegistrationStatus();\n\tif (!workspaceRegistered) {\n\t\tthrow new CloudWorkspaceRegistrationError('Workspace is not registered');\n\t}\n\n\tconst token = await getWorkspaceAccessToken(true);\n\tif (!token) {\n\t\tthrow new CloudWorkspaceAccessTokenEmptyError();\n\t}\n\n\tconst workspaceRegistrationData = await buildWorkspaceRegistrationData(undefined);\n\n\tconst payload = await fetchWorkspaceClientPayload({ token, workspaceRegistrationData });\n\n\tif (payload) {\n\t\tawait consumeWorkspaceSyncPayload(payload);\n\t}\n\n\tawait getWorkspaceLicense();\n\n\treturn true;\n}\n"],"mappings":"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","ignoreList":[]},"sourceType":"module","externalDependencies":{},"hash":"f3dc0de47814cbc98746554f33066cbb78a0bacf"}
