{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/app/oembed/server/providers.ts","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","topLevelAwait","objectRestSpread","objectRestSpread","asyncGenerators","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"os.osx.arm64"},"sourceFileName":"app/oembed/server/providers.ts","filename":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/app/oembed/server/providers.ts","inputSourceMap":{"version":3,"file":"app/oembed/server/providers.ts","sourceRoot":"","sources":["app/oembed/server/providers.ts"],"names":[],"mappings":"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","sourcesContent":["import type { OEmbedMeta, OEmbedUrlContent, OEmbedProvider } from '@rocket.chat/core-typings';\nimport { camelCase } from 'change-case';\n\nimport { callbacks } from '../../../lib/callbacks';\nimport { SystemLogger } from '../../../server/lib/logger/system';\n\nclass Providers {\n\tprivate providers: OEmbedProvider[];\n\n\tconstructor() {\n\t\tthis.providers = [];\n\t}\n\n\tstatic getConsumerUrl(provider: OEmbedProvider, url: string): string {\n\t\tconst urlObj = new URL(provider.endPoint);\n\t\turlObj.searchParams.set('url', url);\n\n\t\treturn urlObj.toString();\n\t}\n\n\tregisterProvider(provider: OEmbedProvider): number {\n\t\treturn this.providers.push(provider);\n\t}\n\n\tgetProviders(): OEmbedProvider[] {\n\t\treturn this.providers;\n\t}\n\n\tgetProviderForUrl(url: string): OEmbedProvider | undefined {\n\t\treturn this.providers?.find((provider) => {\n\t\t\treturn (\n\t\t\t\tprovider.urls?.some((re) => {\n\t\t\t\t\treturn re.test(url);\n\t\t\t\t}) ?? false\n\t\t\t);\n\t\t});\n\t}\n}\n\nconst providers = new Providers();\n\nproviders.registerProvider({\n\turls: [new RegExp('https?://soundcloud\\\\.com/\\\\S+')],\n\tendPoint: 'https://soundcloud.com/oembed?format=json&maxheight=150',\n});\n\nproviders.registerProvider({\n\turls: [\n\t\tnew RegExp('https?://vimeo\\\\.com/[^/]+'),\n\t\tnew RegExp('https?://vimeo\\\\.com/channels/[^/]+/[^/]+'),\n\t\tnew RegExp('https://vimeo\\\\.com/groups/[^/]+/videos/[^/]+'),\n\t],\n\tendPoint: 'https://vimeo.com/api/oembed.json?maxheight=200',\n});\n\nproviders.registerProvider({\n\turls: [new RegExp('https?://www\\\\.youtube\\\\.com/\\\\S+'), new RegExp('https?://youtu\\\\.be/\\\\S+')],\n\tendPoint: 'https://www.youtube.com/oembed?maxheight=200',\n});\n\nproviders.registerProvider({\n\turls: [new RegExp('https?://www\\\\.rdio\\\\.com/\\\\S+'), new RegExp('https?://rd\\\\.io/\\\\S+')],\n\tendPoint: 'https://www.rdio.com/api/oembed/?format=json&maxheight=150',\n});\n\nproviders.registerProvider({\n\turls: [new RegExp('https?://www\\\\.slideshare\\\\.net/[^/]+/[^/]+')],\n\tendPoint: 'https://www.slideshare.net/api/oembed/2?format=json&maxheight=200',\n});\n\nproviders.registerProvider({\n\turls: [new RegExp('https?://www\\\\.dailymotion\\\\.com/video/\\\\S+')],\n\tendPoint: 'https://www.dailymotion.com/services/oembed?maxheight=200',\n});\n\nproviders.registerProvider({\n\turls: [new RegExp('https?://(twitter|x)\\\\.com/[^/]+/status/\\\\S+')],\n\tendPoint: 'https://publish.twitter.com/oembed',\n});\n\nproviders.registerProvider({\n\turls: [new RegExp('https?://(play|open)\\\\.spotify\\\\.com/(track|album|playlist|show)/\\\\S+')],\n\tendPoint: 'https://open.spotify.com/oembed',\n});\n\nproviders.registerProvider({\n\turls: [new RegExp('https?://www\\\\.loom\\\\.com/\\\\S+')],\n\tendPoint: 'https://www.loom.com/v1/oembed?format=json',\n});\n\ncallbacks.add(\n\t'oembed:beforeGetUrlContent',\n\t(data) => {\n\t\tif (!data.urlObj) {\n\t\t\treturn data;\n\t\t}\n\n\t\tconst url = data.urlObj.toString();\n\t\tconst provider = providers.getProviderForUrl(url);\n\n\t\tif (!provider) {\n\t\t\treturn data;\n\t\t}\n\n\t\tconst consumerUrl = Providers.getConsumerUrl(provider, url);\n\n\t\treturn { ...data, urlObj: new URL(consumerUrl) };\n\t},\n\tcallbacks.priority.MEDIUM,\n\t'oembed-providers-before',\n);\n\nconst cleanupOembed = (data: {\n\turl: string;\n\tmeta: OEmbedMeta;\n\theaders: { [k: string]: string };\n\tcontent: OEmbedUrlContent;\n}): {\n\turl: string;\n\tmeta: Omit<OEmbedMeta, 'oembedHtml'>;\n\theaders: { [k: string]: string };\n\tcontent: OEmbedUrlContent;\n} => {\n\tif (!data?.meta) {\n\t\treturn data;\n\t}\n\n\t// remove oembedHtml key from original meta\n\tconst { oembedHtml, ...meta } = data.meta;\n\n\treturn {\n\t\t...data,\n\t\tmeta,\n\t};\n};\n\ncallbacks.add(\n\t'oembed:afterParseContent',\n\t(data) => {\n\t\tif (!data?.url || !data.content?.body) {\n\t\t\treturn cleanupOembed(data);\n\t\t}\n\n\t\tconst provider = providers.getProviderForUrl(data.url);\n\n\t\tif (!provider) {\n\t\t\treturn cleanupOembed(data);\n\t\t}\n\n\t\tdata.meta.oembedUrl = data.url;\n\n\t\ttry {\n\t\t\tconst metas = JSON.parse(data.content.body);\n\t\t\tObject.entries(metas).forEach(([key, value]) => {\n\t\t\t\tif (value && typeof value === 'string') {\n\t\t\t\t\tdata.meta[camelCase(`oembed_${key}`)] = value;\n\t\t\t\t}\n\t\t\t});\n\t\t} catch (error) {\n\t\t\tSystemLogger.error(error);\n\t\t}\n\t\treturn data;\n\t},\n\tcallbacks.priority.MEDIUM,\n\t'oembed-providers-after',\n);\n"]},"targets":{"android":"125.0.0","chrome":"125.0.0","edge":"125.0.0","firefox":"115.0.0","ie":"10.0.0","ios":"17.4.0","opera":"110.0.0","opera_mobile":"80.0.0","safari":"17.4.0","samsung":"24.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor","root":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":false,"enforceStrictMode":false,"dynamicImport":true,"generateLetDeclarations":true,"topLevelAwait":true},"externalDependencies":[]},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"version":"7.17.2","helpers":true,"useESModules":false,"corejs":false},"externalDependencies":[]},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-async-generator-functions","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-class-properties","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true},"externalDependencies":[]},{"key":"transform-react-jsx","visitor":{"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXFragment":{"exit":[null]},"JSXElement":{"exit":[null]},"JSXAttribute":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false},"externalDependencies":[]},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-nullish-coalescing-operator","visitor":{"LogicalExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-optional-chaining","visitor":{"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-optional-catch-binding","visitor":{"CatchClause":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-class-properties","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-async-generator-functions","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-logical-assignment-operators","visitor":{"AssignmentExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]}],"presets":[],"generatorOpts":{"filename":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/app/oembed/server/providers.ts","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"app/oembed/server/providers.ts","inputSourceMap":{"version":3,"file":"app/oembed/server/providers.ts","sourceRoot":"","sources":["app/oembed/server/providers.ts"],"names":[],"mappings":"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","sourcesContent":["import type { OEmbedMeta, OEmbedUrlContent, OEmbedProvider } from '@rocket.chat/core-typings';\nimport { camelCase } from 'change-case';\n\nimport { callbacks } from '../../../lib/callbacks';\nimport { SystemLogger } from '../../../server/lib/logger/system';\n\nclass Providers {\n\tprivate providers: OEmbedProvider[];\n\n\tconstructor() {\n\t\tthis.providers = [];\n\t}\n\n\tstatic getConsumerUrl(provider: OEmbedProvider, url: string): string {\n\t\tconst urlObj = new URL(provider.endPoint);\n\t\turlObj.searchParams.set('url', url);\n\n\t\treturn urlObj.toString();\n\t}\n\n\tregisterProvider(provider: OEmbedProvider): number {\n\t\treturn this.providers.push(provider);\n\t}\n\n\tgetProviders(): OEmbedProvider[] {\n\t\treturn this.providers;\n\t}\n\n\tgetProviderForUrl(url: string): OEmbedProvider | undefined {\n\t\treturn this.providers?.find((provider) => {\n\t\t\treturn (\n\t\t\t\tprovider.urls?.some((re) => {\n\t\t\t\t\treturn re.test(url);\n\t\t\t\t}) ?? false\n\t\t\t);\n\t\t});\n\t}\n}\n\nconst providers = new Providers();\n\nproviders.registerProvider({\n\turls: [new RegExp('https?://soundcloud\\\\.com/\\\\S+')],\n\tendPoint: 'https://soundcloud.com/oembed?format=json&maxheight=150',\n});\n\nproviders.registerProvider({\n\turls: [\n\t\tnew RegExp('https?://vimeo\\\\.com/[^/]+'),\n\t\tnew RegExp('https?://vimeo\\\\.com/channels/[^/]+/[^/]+'),\n\t\tnew RegExp('https://vimeo\\\\.com/groups/[^/]+/videos/[^/]+'),\n\t],\n\tendPoint: 'https://vimeo.com/api/oembed.json?maxheight=200',\n});\n\nproviders.registerProvider({\n\turls: [new RegExp('https?://www\\\\.youtube\\\\.com/\\\\S+'), new RegExp('https?://youtu\\\\.be/\\\\S+')],\n\tendPoint: 'https://www.youtube.com/oembed?maxheight=200',\n});\n\nproviders.registerProvider({\n\turls: [new RegExp('https?://www\\\\.rdio\\\\.com/\\\\S+'), new RegExp('https?://rd\\\\.io/\\\\S+')],\n\tendPoint: 'https://www.rdio.com/api/oembed/?format=json&maxheight=150',\n});\n\nproviders.registerProvider({\n\turls: [new RegExp('https?://www\\\\.slideshare\\\\.net/[^/]+/[^/]+')],\n\tendPoint: 'https://www.slideshare.net/api/oembed/2?format=json&maxheight=200',\n});\n\nproviders.registerProvider({\n\turls: [new RegExp('https?://www\\\\.dailymotion\\\\.com/video/\\\\S+')],\n\tendPoint: 'https://www.dailymotion.com/services/oembed?maxheight=200',\n});\n\nproviders.registerProvider({\n\turls: [new RegExp('https?://(twitter|x)\\\\.com/[^/]+/status/\\\\S+')],\n\tendPoint: 'https://publish.twitter.com/oembed',\n});\n\nproviders.registerProvider({\n\turls: [new RegExp('https?://(play|open)\\\\.spotify\\\\.com/(track|album|playlist|show)/\\\\S+')],\n\tendPoint: 'https://open.spotify.com/oembed',\n});\n\nproviders.registerProvider({\n\turls: [new RegExp('https?://www\\\\.loom\\\\.com/\\\\S+')],\n\tendPoint: 'https://www.loom.com/v1/oembed?format=json',\n});\n\ncallbacks.add(\n\t'oembed:beforeGetUrlContent',\n\t(data) => {\n\t\tif (!data.urlObj) {\n\t\t\treturn data;\n\t\t}\n\n\t\tconst url = data.urlObj.toString();\n\t\tconst provider = providers.getProviderForUrl(url);\n\n\t\tif (!provider) {\n\t\t\treturn data;\n\t\t}\n\n\t\tconst consumerUrl = Providers.getConsumerUrl(provider, url);\n\n\t\treturn { ...data, urlObj: new URL(consumerUrl) };\n\t},\n\tcallbacks.priority.MEDIUM,\n\t'oembed-providers-before',\n);\n\nconst cleanupOembed = (data: {\n\turl: string;\n\tmeta: OEmbedMeta;\n\theaders: { [k: string]: string };\n\tcontent: OEmbedUrlContent;\n}): {\n\turl: string;\n\tmeta: Omit<OEmbedMeta, 'oembedHtml'>;\n\theaders: { [k: string]: string };\n\tcontent: OEmbedUrlContent;\n} => {\n\tif (!data?.meta) {\n\t\treturn data;\n\t}\n\n\t// remove oembedHtml key from original meta\n\tconst { oembedHtml, ...meta } = data.meta;\n\n\treturn {\n\t\t...data,\n\t\tmeta,\n\t};\n};\n\ncallbacks.add(\n\t'oembed:afterParseContent',\n\t(data) => {\n\t\tif (!data?.url || !data.content?.body) {\n\t\t\treturn cleanupOembed(data);\n\t\t}\n\n\t\tconst provider = providers.getProviderForUrl(data.url);\n\n\t\tif (!provider) {\n\t\t\treturn cleanupOembed(data);\n\t\t}\n\n\t\tdata.meta.oembedUrl = data.url;\n\n\t\ttry {\n\t\t\tconst metas = JSON.parse(data.content.body);\n\t\t\tObject.entries(metas).forEach(([key, value]) => {\n\t\t\t\tif (value && typeof value === 'string') {\n\t\t\t\t\tdata.meta[camelCase(`oembed_${key}`)] = value;\n\t\t\t\t}\n\t\t\t});\n\t\t} catch (error) {\n\t\t\tSystemLogger.error(error);\n\t\t}\n\t\treturn data;\n\t},\n\tcallbacks.priority.MEDIUM,\n\t'oembed-providers-after',\n);\n"]}}},"code":"!module.wrapAsync(async function (module, __reifyWaitForDeps__, __reify_async_result__) {\n  \"use strict\";\n  try {\n    let _objectWithoutProperties;\n    module.link(\"@babel/runtime/helpers/objectWithoutProperties\", {\n      default(v) {\n        _objectWithoutProperties = v;\n      }\n    }, 0);\n    let _objectSpread;\n    module.link(\"@babel/runtime/helpers/objectSpread2\", {\n      default(v) {\n        _objectSpread = v;\n      }\n    }, 1);\n    const _excluded = [\"oembedHtml\"];\n    let camelCase;\n    module.link(\"change-case\", {\n      camelCase(v) {\n        camelCase = v;\n      }\n    }, 0);\n    let callbacks;\n    module.link(\"../../../lib/callbacks\", {\n      callbacks(v) {\n        callbacks = v;\n      }\n    }, 1);\n    let SystemLogger;\n    module.link(\"../../../server/lib/logger/system\", {\n      SystemLogger(v) {\n        SystemLogger = v;\n      }\n    }, 2);\n    if (__reifyWaitForDeps__()) (await __reifyWaitForDeps__())();\n    class Providers {\n      constructor() {\n        this.providers = void 0;\n        this.providers = [];\n      }\n      static getConsumerUrl(provider, url) {\n        const urlObj = new URL(provider.endPoint);\n        urlObj.searchParams.set('url', url);\n        return urlObj.toString();\n      }\n      registerProvider(provider) {\n        return this.providers.push(provider);\n      }\n      getProviders() {\n        return this.providers;\n      }\n      getProviderForUrl(url) {\n        var _this$providers;\n        return (_this$providers = this.providers) === null || _this$providers === void 0 ? void 0 : _this$providers.find(provider => {\n          var _provider$urls$some, _provider$urls;\n          return (_provider$urls$some = (_provider$urls = provider.urls) === null || _provider$urls === void 0 ? void 0 : _provider$urls.some(re => {\n            return re.test(url);\n          })) !== null && _provider$urls$some !== void 0 ? _provider$urls$some : false;\n        });\n      }\n    }\n    const providers = new Providers();\n    providers.registerProvider({\n      urls: [new RegExp('https?://soundcloud\\\\.com/\\\\S+')],\n      endPoint: 'https://soundcloud.com/oembed?format=json&maxheight=150'\n    });\n    providers.registerProvider({\n      urls: [new RegExp('https?://vimeo\\\\.com/[^/]+'), new RegExp('https?://vimeo\\\\.com/channels/[^/]+/[^/]+'), new RegExp('https://vimeo\\\\.com/groups/[^/]+/videos/[^/]+')],\n      endPoint: 'https://vimeo.com/api/oembed.json?maxheight=200'\n    });\n    providers.registerProvider({\n      urls: [new RegExp('https?://www\\\\.youtube\\\\.com/\\\\S+'), new RegExp('https?://youtu\\\\.be/\\\\S+')],\n      endPoint: 'https://www.youtube.com/oembed?maxheight=200'\n    });\n    providers.registerProvider({\n      urls: [new RegExp('https?://www\\\\.rdio\\\\.com/\\\\S+'), new RegExp('https?://rd\\\\.io/\\\\S+')],\n      endPoint: 'https://www.rdio.com/api/oembed/?format=json&maxheight=150'\n    });\n    providers.registerProvider({\n      urls: [new RegExp('https?://www\\\\.slideshare\\\\.net/[^/]+/[^/]+')],\n      endPoint: 'https://www.slideshare.net/api/oembed/2?format=json&maxheight=200'\n    });\n    providers.registerProvider({\n      urls: [new RegExp('https?://www\\\\.dailymotion\\\\.com/video/\\\\S+')],\n      endPoint: 'https://www.dailymotion.com/services/oembed?maxheight=200'\n    });\n    providers.registerProvider({\n      urls: [new RegExp('https?://(twitter|x)\\\\.com/[^/]+/status/\\\\S+')],\n      endPoint: 'https://publish.twitter.com/oembed'\n    });\n    providers.registerProvider({\n      urls: [new RegExp('https?://(play|open)\\\\.spotify\\\\.com/(track|album|playlist|show)/\\\\S+')],\n      endPoint: 'https://open.spotify.com/oembed'\n    });\n    providers.registerProvider({\n      urls: [new RegExp('https?://www\\\\.loom\\\\.com/\\\\S+')],\n      endPoint: 'https://www.loom.com/v1/oembed?format=json'\n    });\n    callbacks.add('oembed:beforeGetUrlContent', data => {\n      if (!data.urlObj) {\n        return data;\n      }\n      const url = data.urlObj.toString();\n      const provider = providers.getProviderForUrl(url);\n      if (!provider) {\n        return data;\n      }\n      const consumerUrl = Providers.getConsumerUrl(provider, url);\n      return _objectSpread(_objectSpread({}, data), {}, {\n        urlObj: new URL(consumerUrl)\n      });\n    }, callbacks.priority.MEDIUM, 'oembed-providers-before');\n    const cleanupOembed = data => {\n      if (!(data !== null && data !== void 0 && data.meta)) {\n        return data;\n      }\n      // remove oembedHtml key from original meta\n      const _data$meta = data.meta,\n        {\n          oembedHtml\n        } = _data$meta,\n        meta = _objectWithoutProperties(_data$meta, _excluded);\n      return _objectSpread(_objectSpread({}, data), {}, {\n        meta\n      });\n    };\n    callbacks.add('oembed:afterParseContent', data => {\n      var _data$content;\n      if (!(data !== null && data !== void 0 && data.url) || !((_data$content = data.content) !== null && _data$content !== void 0 && _data$content.body)) {\n        return cleanupOembed(data);\n      }\n      const provider = providers.getProviderForUrl(data.url);\n      if (!provider) {\n        return cleanupOembed(data);\n      }\n      data.meta.oembedUrl = data.url;\n      try {\n        const metas = JSON.parse(data.content.body);\n        Object.entries(metas).forEach(_ref => {\n          let [key, value] = _ref;\n          if (value && typeof value === 'string') {\n            data.meta[camelCase(\"oembed_\".concat(key))] = value;\n          }\n        });\n      } catch (error) {\n        SystemLogger.error(error);\n      }\n      return data;\n    }, callbacks.priority.MEDIUM, 'oembed-providers-after');\n    __reify_async_result__();\n  } catch (_reifyError) {\n    return __reify_async_result__(_reifyError);\n  }\n  __reify_async_result__()\n}, {\n  self: this,\n  async: false\n});","map":{"version":3,"names":["_objectWithoutProperties","module","link","default","v","_objectSpread","_excluded","camelCase","callbacks","SystemLogger","__reifyWaitForDeps__","Providers","constructor","providers","getConsumerUrl","provider","url","urlObj","URL","endPoint","searchParams","set","toString","registerProvider","push","getProviders","getProviderForUrl","_this$providers","find","_provider$urls$some","_provider$urls","urls","some","re","test","RegExp","add","data","consumerUrl","priority","MEDIUM","cleanupOembed","meta","_data$meta","oembedHtml","_data$content","content","body","oembedUrl","metas","JSON","parse","Object","entries","forEach","_ref","key","value","concat","error","__reify_async_result__","_reifyError","self","async"],"sources":["app/oembed/server/providers.ts"],"sourcesContent":["import type { OEmbedMeta, OEmbedUrlContent, OEmbedProvider } from '@rocket.chat/core-typings';\nimport { camelCase } from 'change-case';\n\nimport { callbacks } from '../../../lib/callbacks';\nimport { SystemLogger } from '../../../server/lib/logger/system';\n\nclass Providers {\n\tprivate providers: OEmbedProvider[];\n\n\tconstructor() {\n\t\tthis.providers = [];\n\t}\n\n\tstatic getConsumerUrl(provider: OEmbedProvider, url: string): string {\n\t\tconst urlObj = new URL(provider.endPoint);\n\t\turlObj.searchParams.set('url', url);\n\n\t\treturn urlObj.toString();\n\t}\n\n\tregisterProvider(provider: OEmbedProvider): number {\n\t\treturn this.providers.push(provider);\n\t}\n\n\tgetProviders(): OEmbedProvider[] {\n\t\treturn this.providers;\n\t}\n\n\tgetProviderForUrl(url: string): OEmbedProvider | undefined {\n\t\treturn this.providers?.find((provider) => {\n\t\t\treturn (\n\t\t\t\tprovider.urls?.some((re) => {\n\t\t\t\t\treturn re.test(url);\n\t\t\t\t}) ?? false\n\t\t\t);\n\t\t});\n\t}\n}\n\nconst providers = new Providers();\n\nproviders.registerProvider({\n\turls: [new RegExp('https?://soundcloud\\\\.com/\\\\S+')],\n\tendPoint: 'https://soundcloud.com/oembed?format=json&maxheight=150',\n});\n\nproviders.registerProvider({\n\turls: [\n\t\tnew RegExp('https?://vimeo\\\\.com/[^/]+'),\n\t\tnew RegExp('https?://vimeo\\\\.com/channels/[^/]+/[^/]+'),\n\t\tnew RegExp('https://vimeo\\\\.com/groups/[^/]+/videos/[^/]+'),\n\t],\n\tendPoint: 'https://vimeo.com/api/oembed.json?maxheight=200',\n});\n\nproviders.registerProvider({\n\turls: [new RegExp('https?://www\\\\.youtube\\\\.com/\\\\S+'), new RegExp('https?://youtu\\\\.be/\\\\S+')],\n\tendPoint: 'https://www.youtube.com/oembed?maxheight=200',\n});\n\nproviders.registerProvider({\n\turls: [new RegExp('https?://www\\\\.rdio\\\\.com/\\\\S+'), new RegExp('https?://rd\\\\.io/\\\\S+')],\n\tendPoint: 'https://www.rdio.com/api/oembed/?format=json&maxheight=150',\n});\n\nproviders.registerProvider({\n\turls: [new RegExp('https?://www\\\\.slideshare\\\\.net/[^/]+/[^/]+')],\n\tendPoint: 'https://www.slideshare.net/api/oembed/2?format=json&maxheight=200',\n});\n\nproviders.registerProvider({\n\turls: [new RegExp('https?://www\\\\.dailymotion\\\\.com/video/\\\\S+')],\n\tendPoint: 'https://www.dailymotion.com/services/oembed?maxheight=200',\n});\n\nproviders.registerProvider({\n\turls: [new RegExp('https?://(twitter|x)\\\\.com/[^/]+/status/\\\\S+')],\n\tendPoint: 'https://publish.twitter.com/oembed',\n});\n\nproviders.registerProvider({\n\turls: [new RegExp('https?://(play|open)\\\\.spotify\\\\.com/(track|album|playlist|show)/\\\\S+')],\n\tendPoint: 'https://open.spotify.com/oembed',\n});\n\nproviders.registerProvider({\n\turls: [new RegExp('https?://www\\\\.loom\\\\.com/\\\\S+')],\n\tendPoint: 'https://www.loom.com/v1/oembed?format=json',\n});\n\ncallbacks.add(\n\t'oembed:beforeGetUrlContent',\n\t(data) => {\n\t\tif (!data.urlObj) {\n\t\t\treturn data;\n\t\t}\n\n\t\tconst url = data.urlObj.toString();\n\t\tconst provider = providers.getProviderForUrl(url);\n\n\t\tif (!provider) {\n\t\t\treturn data;\n\t\t}\n\n\t\tconst consumerUrl = Providers.getConsumerUrl(provider, url);\n\n\t\treturn { ...data, urlObj: new URL(consumerUrl) };\n\t},\n\tcallbacks.priority.MEDIUM,\n\t'oembed-providers-before',\n);\n\nconst cleanupOembed = (data: {\n\turl: string;\n\tmeta: OEmbedMeta;\n\theaders: { [k: string]: string };\n\tcontent: OEmbedUrlContent;\n}): {\n\turl: string;\n\tmeta: Omit<OEmbedMeta, 'oembedHtml'>;\n\theaders: { [k: string]: string };\n\tcontent: OEmbedUrlContent;\n} => {\n\tif (!data?.meta) {\n\t\treturn data;\n\t}\n\n\t// remove oembedHtml key from original meta\n\tconst { oembedHtml, ...meta } = data.meta;\n\n\treturn {\n\t\t...data,\n\t\tmeta,\n\t};\n};\n\ncallbacks.add(\n\t'oembed:afterParseContent',\n\t(data) => {\n\t\tif (!data?.url || !data.content?.body) {\n\t\t\treturn cleanupOembed(data);\n\t\t}\n\n\t\tconst provider = providers.getProviderForUrl(data.url);\n\n\t\tif (!provider) {\n\t\t\treturn cleanupOembed(data);\n\t\t}\n\n\t\tdata.meta.oembedUrl = data.url;\n\n\t\ttry {\n\t\t\tconst metas = JSON.parse(data.content.body);\n\t\t\tObject.entries(metas).forEach(([key, value]) => {\n\t\t\t\tif (value && typeof value === 'string') {\n\t\t\t\t\tdata.meta[camelCase(`oembed_${key}`)] = value;\n\t\t\t\t}\n\t\t\t});\n\t\t} catch (error) {\n\t\t\tSystemLogger.error(error);\n\t\t}\n\t\treturn data;\n\t},\n\tcallbacks.priority.MEDIUM,\n\t'oembed-providers-after',\n);\n"],"mappings":"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","ignoreList":[]},"sourceType":"module","externalDependencies":{},"hash":"df49de9c78e9114c231a0ecbab92e2a546d826bc"}
