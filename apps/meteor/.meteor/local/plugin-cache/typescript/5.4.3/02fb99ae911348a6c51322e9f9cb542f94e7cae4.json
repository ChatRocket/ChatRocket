{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/app/livechat/server/api/lib/livechat.ts","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","topLevelAwait","objectRestSpread","objectRestSpread","asyncGenerators","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"os.osx.arm64"},"sourceFileName":"app/livechat/server/api/lib/livechat.ts","filename":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/app/livechat/server/api/lib/livechat.ts","inputSourceMap":{"version":3,"file":"app/livechat/server/api/lib/livechat.ts","sourceRoot":"","sources":["app/livechat/server/api/lib/livechat.ts"],"names":[],"mappings":"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","sourcesContent":["import type { ILivechatAgent, ILivechatDepartment, ILivechatTrigger, ILivechatVisitor, IOmnichannelRoom } from '@rocket.chat/core-typings';\nimport { License } from '@rocket.chat/license';\nimport { EmojiCustom, LivechatTrigger, LivechatVisitors, LivechatRooms, LivechatDepartment } from '@rocket.chat/models';\nimport { Meteor } from 'meteor/meteor';\n\nimport { callbacks } from '../../../../../lib/callbacks';\nimport { i18n } from '../../../../../server/lib/i18n';\nimport { normalizeAgent } from '../../lib/Helper';\nimport { Livechat as LivechatTyped } from '../../lib/LivechatTyped';\n\nexport function online(department: string, skipSettingCheck = false, skipFallbackCheck = false): Promise<boolean> {\n\treturn LivechatTyped.online(department, skipSettingCheck, skipFallbackCheck);\n}\n\nasync function findTriggers(): Promise<Pick<ILivechatTrigger, '_id' | 'actions' | 'conditions' | 'runOnce'>[]> {\n\tconst triggers = await LivechatTrigger.findEnabled().toArray();\n\tconst hasLicense = License.hasModule('livechat-enterprise');\n\tconst premiumActions = ['use-external-service'];\n\n\treturn triggers\n\t\t.filter(({ actions }) => hasLicense || actions.some((c) => !premiumActions.includes(c.name)))\n\t\t.map(({ _id, actions, conditions, runOnce }) => ({\n\t\t\t_id,\n\t\t\tactions,\n\t\t\tconditions,\n\t\t\trunOnce,\n\t\t}));\n}\n\nasync function findDepartments(\n\tbusinessUnit?: string,\n): Promise<Pick<ILivechatDepartment, '_id' | 'name' | 'showOnRegistration' | 'showOnOfflineForm'>[]> {\n\t// TODO: check this function usage\n\treturn (\n\t\tawait (\n\t\t\tawait LivechatDepartment.findEnabledWithAgentsAndBusinessUnit(businessUnit, {\n\t\t\t\t_id: 1,\n\t\t\t\tname: 1,\n\t\t\t\tshowOnRegistration: 1,\n\t\t\t\tshowOnOfflineForm: 1,\n\t\t\t})\n\t\t).toArray()\n\t).map(({ _id, name, showOnRegistration, showOnOfflineForm }) => ({\n\t\t_id,\n\t\tname,\n\t\tshowOnRegistration,\n\t\tshowOnOfflineForm,\n\t}));\n}\n\nexport function findGuest(token: string): Promise<ILivechatVisitor | null> {\n\treturn LivechatVisitors.getVisitorByToken(token, {\n\t\tprojection: {\n\t\t\tname: 1,\n\t\t\tusername: 1,\n\t\t\ttoken: 1,\n\t\t\tvisitorEmails: 1,\n\t\t\tdepartment: 1,\n\t\t\tactivity: 1,\n\t\t\tcontactId: 1,\n\t\t},\n\t});\n}\n\nexport function findGuestWithoutActivity(token: string): Promise<ILivechatVisitor | null> {\n\treturn LivechatVisitors.getVisitorByToken(token, { projection: { name: 1, username: 1, token: 1, visitorEmails: 1, department: 1 } });\n}\n\nexport async function findRoom(token: string, rid?: string): Promise<IOmnichannelRoom | null> {\n\tconst fields = {\n\t\tt: 1,\n\t\tdepartmentId: 1,\n\t\tservedBy: 1,\n\t\topen: 1,\n\t\tv: 1,\n\t\tts: 1,\n\t};\n\n\tif (!rid) {\n\t\treturn LivechatRooms.findOneByVisitorToken(token, fields);\n\t}\n\n\treturn LivechatRooms.findOneByIdAndVisitorToken(rid, token, fields);\n}\n\nexport async function findOpenRoom(token: string, departmentId?: string): Promise<IOmnichannelRoom | undefined> {\n\tconst options = {\n\t\tprojection: {\n\t\t\tdepartmentId: 1,\n\t\t\tservedBy: 1,\n\t\t\topen: 1,\n\t\t\tcallStatus: 1,\n\t\t},\n\t};\n\n\tconst extraQuery = await callbacks.run('livechat.applyRoomRestrictions', {});\n\tconst rooms = departmentId\n\t\t? await LivechatRooms.findOpenByVisitorTokenAndDepartmentId(token, departmentId, options, extraQuery).toArray()\n\t\t: await LivechatRooms.findOpenByVisitorToken(token, options, extraQuery).toArray();\n\tif (rooms && rooms.length > 0) {\n\t\treturn rooms[0];\n\t}\n}\n\nexport async function findAgent(agentId?: string): Promise<void | { hiddenInfo: boolean } | ILivechatAgent> {\n\treturn normalizeAgent(agentId);\n}\n\nexport function normalizeHttpHeaderData(headers: Record<string, string | string[] | undefined> = {}): {\n\thttpHeaders: Record<string, string | string[] | undefined>;\n} {\n\tconst httpHeaders = Object.assign({}, headers);\n\treturn { httpHeaders };\n}\n\nexport async function settings({ businessUnit = '' }: { businessUnit?: string } = {}): Promise<Record<string, string | number | any>> {\n\t// Putting this ugly conversion while we type the livechat service\n\tconst initSettings = await LivechatTyped.getInitSettings();\n\tconst triggers = await findTriggers();\n\tconst departments = await findDepartments(businessUnit);\n\tconst sound = `${Meteor.absoluteUrl()}sounds/chime.mp3`;\n\tconst emojis = await EmojiCustom.find().toArray();\n\treturn {\n\t\tenabled: initSettings.Livechat_enabled,\n\t\tsettings: {\n\t\t\tregistrationForm: initSettings.Livechat_registration_form,\n\t\t\tallowSwitchingDepartments: initSettings.Livechat_allow_switching_departments,\n\t\t\tnameFieldRegistrationForm: initSettings.Livechat_name_field_registration_form,\n\t\t\temailFieldRegistrationForm: initSettings.Livechat_email_field_registration_form,\n\t\t\tdisplayOfflineForm: initSettings.Livechat_display_offline_form,\n\t\t\tvideoCall: initSettings.Omnichannel_call_provider === 'default-provider',\n\t\t\tfileUpload: initSettings.Livechat_fileupload_enabled && initSettings.FileUpload_Enabled,\n\t\t\tlanguage: initSettings.Language,\n\t\t\ttranscript: initSettings.Livechat_enable_transcript,\n\t\t\thistoryMonitorType: initSettings.Livechat_history_monitor_type,\n\t\t\tforceAcceptDataProcessingConsent: initSettings.Livechat_force_accept_data_processing_consent,\n\t\t\tshowConnecting: initSettings.Livechat_Show_Connecting,\n\t\t\tagentHiddenInfo: initSettings.Livechat_show_agent_info === false,\n\t\t\tclearLocalStorageWhenChatEnded: initSettings.Livechat_clear_local_storage_when_chat_ended,\n\t\t\tlimitTextLength:\n\t\t\t\tinitSettings.Livechat_enable_message_character_limit &&\n\t\t\t\t(initSettings.Livechat_message_character_limit || initSettings.Message_MaxAllowedSize),\n\t\t\thiddenSystemMessages: initSettings.Livechat_hide_system_messages,\n\t\t\tlivechatLogo: initSettings.Assets_livechat_widget_logo,\n\t\t\thideWatermark: initSettings.Livechat_hide_watermark || false,\n\t\t\tvisitorsCanCloseChat: initSettings.Omnichannel_allow_visitors_to_close_conversation,\n\t\t},\n\t\ttheme: {\n\t\t\ttitle: initSettings.Livechat_title,\n\t\t\tcolor: initSettings.Livechat_title_color,\n\t\t\tofflineTitle: initSettings.Livechat_offline_title,\n\t\t\tofflineColor: initSettings.Livechat_offline_title_color,\n\t\t\tposition: initSettings.Livechat_widget_position || 'right',\n\t\t\tbackground: initSettings.Livechat_background,\n\t\t\tactionLinks: {\n\t\t\t\twebrtc: [\n\t\t\t\t\t{\n\t\t\t\t\t\tactionLinksAlignment: 'flex-start',\n\t\t\t\t\t\ti18nLabel: 'Join_call',\n\t\t\t\t\t\tlabel: i18n.t('Join_call'),\n\t\t\t\t\t\tmethod_id: 'joinLivechatWebRTCCall',\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\ti18nLabel: 'End_call',\n\t\t\t\t\t\tlabel: i18n.t('End_call'),\n\t\t\t\t\t\tmethod_id: 'endLivechatWebRTCCall',\n\t\t\t\t\t\tdanger: true,\n\t\t\t\t\t},\n\t\t\t\t],\n\t\t\t\tjitsi: [\n\t\t\t\t\t{ icon: 'icon-videocam', i18nLabel: 'Accept' },\n\t\t\t\t\t{ icon: 'icon-cancel', i18nLabel: 'Decline' },\n\t\t\t\t],\n\t\t\t},\n\t\t},\n\t\tmessages: {\n\t\t\tofflineMessage: initSettings.Livechat_offline_message,\n\t\t\tofflineSuccessMessage: initSettings.Livechat_offline_success_message,\n\t\t\tofflineUnavailableMessage: initSettings.Livechat_offline_form_unavailable,\n\t\t\tconversationFinishedMessage: initSettings.Livechat_conversation_finished_message,\n\t\t\tconversationFinishedText: initSettings.Livechat_conversation_finished_text,\n\t\t\ttranscriptMessage: initSettings.Livechat_transcript_message,\n\t\t\tregistrationFormMessage: initSettings.Livechat_registration_form_message,\n\t\t\tdataProcessingConsentText: initSettings.Livechat_data_processing_consent_text,\n\t\t},\n\t\tsurvey: {\n\t\t\titems: ['satisfaction', 'agentKnowledge', 'agentResposiveness', 'agentFriendliness'],\n\t\t\tvalues: ['1', '2', '3', '4', '5'],\n\t\t},\n\t\ttriggers,\n\t\tdepartments,\n\t\tresources: {\n\t\t\tsound,\n\t\t\temojis,\n\t\t},\n\t};\n}\n\nexport async function getExtraConfigInfo(room?: IOmnichannelRoom): Promise<any> {\n\treturn callbacks.run('livechat.onLoadConfigApi', { room });\n}\n\n// TODO: please forgive me for this. Still finding the good types for these callbacks\nexport function onCheckRoomParams(params: any): Promise<unknown> {\n\treturn callbacks.run('livechat.onCheckRoomApiParams', params);\n}\n"]},"targets":{"android":"125.0.0","chrome":"125.0.0","edge":"125.0.0","firefox":"115.0.0","ie":"10.0.0","ios":"17.4.0","opera":"110.0.0","opera_mobile":"80.0.0","safari":"17.4.0","samsung":"24.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor","root":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":false,"enforceStrictMode":false,"dynamicImport":true,"generateLetDeclarations":true,"topLevelAwait":true},"externalDependencies":[]},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"version":"7.17.2","helpers":true,"useESModules":false,"corejs":false},"externalDependencies":[]},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-async-generator-functions","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-class-properties","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true},"externalDependencies":[]},{"key":"transform-react-jsx","visitor":{"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXFragment":{"exit":[null]},"JSXElement":{"exit":[null]},"JSXAttribute":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false},"externalDependencies":[]},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-nullish-coalescing-operator","visitor":{"LogicalExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-optional-chaining","visitor":{"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-optional-catch-binding","visitor":{"CatchClause":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-class-properties","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-async-generator-functions","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-logical-assignment-operators","visitor":{"AssignmentExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]}],"presets":[],"generatorOpts":{"filename":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/app/livechat/server/api/lib/livechat.ts","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"app/livechat/server/api/lib/livechat.ts","inputSourceMap":{"version":3,"file":"app/livechat/server/api/lib/livechat.ts","sourceRoot":"","sources":["app/livechat/server/api/lib/livechat.ts"],"names":[],"mappings":"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","sourcesContent":["import type { ILivechatAgent, ILivechatDepartment, ILivechatTrigger, ILivechatVisitor, IOmnichannelRoom } from '@rocket.chat/core-typings';\nimport { License } from '@rocket.chat/license';\nimport { EmojiCustom, LivechatTrigger, LivechatVisitors, LivechatRooms, LivechatDepartment } from '@rocket.chat/models';\nimport { Meteor } from 'meteor/meteor';\n\nimport { callbacks } from '../../../../../lib/callbacks';\nimport { i18n } from '../../../../../server/lib/i18n';\nimport { normalizeAgent } from '../../lib/Helper';\nimport { Livechat as LivechatTyped } from '../../lib/LivechatTyped';\n\nexport function online(department: string, skipSettingCheck = false, skipFallbackCheck = false): Promise<boolean> {\n\treturn LivechatTyped.online(department, skipSettingCheck, skipFallbackCheck);\n}\n\nasync function findTriggers(): Promise<Pick<ILivechatTrigger, '_id' | 'actions' | 'conditions' | 'runOnce'>[]> {\n\tconst triggers = await LivechatTrigger.findEnabled().toArray();\n\tconst hasLicense = License.hasModule('livechat-enterprise');\n\tconst premiumActions = ['use-external-service'];\n\n\treturn triggers\n\t\t.filter(({ actions }) => hasLicense || actions.some((c) => !premiumActions.includes(c.name)))\n\t\t.map(({ _id, actions, conditions, runOnce }) => ({\n\t\t\t_id,\n\t\t\tactions,\n\t\t\tconditions,\n\t\t\trunOnce,\n\t\t}));\n}\n\nasync function findDepartments(\n\tbusinessUnit?: string,\n): Promise<Pick<ILivechatDepartment, '_id' | 'name' | 'showOnRegistration' | 'showOnOfflineForm'>[]> {\n\t// TODO: check this function usage\n\treturn (\n\t\tawait (\n\t\t\tawait LivechatDepartment.findEnabledWithAgentsAndBusinessUnit(businessUnit, {\n\t\t\t\t_id: 1,\n\t\t\t\tname: 1,\n\t\t\t\tshowOnRegistration: 1,\n\t\t\t\tshowOnOfflineForm: 1,\n\t\t\t})\n\t\t).toArray()\n\t).map(({ _id, name, showOnRegistration, showOnOfflineForm }) => ({\n\t\t_id,\n\t\tname,\n\t\tshowOnRegistration,\n\t\tshowOnOfflineForm,\n\t}));\n}\n\nexport function findGuest(token: string): Promise<ILivechatVisitor | null> {\n\treturn LivechatVisitors.getVisitorByToken(token, {\n\t\tprojection: {\n\t\t\tname: 1,\n\t\t\tusername: 1,\n\t\t\ttoken: 1,\n\t\t\tvisitorEmails: 1,\n\t\t\tdepartment: 1,\n\t\t\tactivity: 1,\n\t\t\tcontactId: 1,\n\t\t},\n\t});\n}\n\nexport function findGuestWithoutActivity(token: string): Promise<ILivechatVisitor | null> {\n\treturn LivechatVisitors.getVisitorByToken(token, { projection: { name: 1, username: 1, token: 1, visitorEmails: 1, department: 1 } });\n}\n\nexport async function findRoom(token: string, rid?: string): Promise<IOmnichannelRoom | null> {\n\tconst fields = {\n\t\tt: 1,\n\t\tdepartmentId: 1,\n\t\tservedBy: 1,\n\t\topen: 1,\n\t\tv: 1,\n\t\tts: 1,\n\t};\n\n\tif (!rid) {\n\t\treturn LivechatRooms.findOneByVisitorToken(token, fields);\n\t}\n\n\treturn LivechatRooms.findOneByIdAndVisitorToken(rid, token, fields);\n}\n\nexport async function findOpenRoom(token: string, departmentId?: string): Promise<IOmnichannelRoom | undefined> {\n\tconst options = {\n\t\tprojection: {\n\t\t\tdepartmentId: 1,\n\t\t\tservedBy: 1,\n\t\t\topen: 1,\n\t\t\tcallStatus: 1,\n\t\t},\n\t};\n\n\tconst extraQuery = await callbacks.run('livechat.applyRoomRestrictions', {});\n\tconst rooms = departmentId\n\t\t? await LivechatRooms.findOpenByVisitorTokenAndDepartmentId(token, departmentId, options, extraQuery).toArray()\n\t\t: await LivechatRooms.findOpenByVisitorToken(token, options, extraQuery).toArray();\n\tif (rooms && rooms.length > 0) {\n\t\treturn rooms[0];\n\t}\n}\n\nexport async function findAgent(agentId?: string): Promise<void | { hiddenInfo: boolean } | ILivechatAgent> {\n\treturn normalizeAgent(agentId);\n}\n\nexport function normalizeHttpHeaderData(headers: Record<string, string | string[] | undefined> = {}): {\n\thttpHeaders: Record<string, string | string[] | undefined>;\n} {\n\tconst httpHeaders = Object.assign({}, headers);\n\treturn { httpHeaders };\n}\n\nexport async function settings({ businessUnit = '' }: { businessUnit?: string } = {}): Promise<Record<string, string | number | any>> {\n\t// Putting this ugly conversion while we type the livechat service\n\tconst initSettings = await LivechatTyped.getInitSettings();\n\tconst triggers = await findTriggers();\n\tconst departments = await findDepartments(businessUnit);\n\tconst sound = `${Meteor.absoluteUrl()}sounds/chime.mp3`;\n\tconst emojis = await EmojiCustom.find().toArray();\n\treturn {\n\t\tenabled: initSettings.Livechat_enabled,\n\t\tsettings: {\n\t\t\tregistrationForm: initSettings.Livechat_registration_form,\n\t\t\tallowSwitchingDepartments: initSettings.Livechat_allow_switching_departments,\n\t\t\tnameFieldRegistrationForm: initSettings.Livechat_name_field_registration_form,\n\t\t\temailFieldRegistrationForm: initSettings.Livechat_email_field_registration_form,\n\t\t\tdisplayOfflineForm: initSettings.Livechat_display_offline_form,\n\t\t\tvideoCall: initSettings.Omnichannel_call_provider === 'default-provider',\n\t\t\tfileUpload: initSettings.Livechat_fileupload_enabled && initSettings.FileUpload_Enabled,\n\t\t\tlanguage: initSettings.Language,\n\t\t\ttranscript: initSettings.Livechat_enable_transcript,\n\t\t\thistoryMonitorType: initSettings.Livechat_history_monitor_type,\n\t\t\tforceAcceptDataProcessingConsent: initSettings.Livechat_force_accept_data_processing_consent,\n\t\t\tshowConnecting: initSettings.Livechat_Show_Connecting,\n\t\t\tagentHiddenInfo: initSettings.Livechat_show_agent_info === false,\n\t\t\tclearLocalStorageWhenChatEnded: initSettings.Livechat_clear_local_storage_when_chat_ended,\n\t\t\tlimitTextLength:\n\t\t\t\tinitSettings.Livechat_enable_message_character_limit &&\n\t\t\t\t(initSettings.Livechat_message_character_limit || initSettings.Message_MaxAllowedSize),\n\t\t\thiddenSystemMessages: initSettings.Livechat_hide_system_messages,\n\t\t\tlivechatLogo: initSettings.Assets_livechat_widget_logo,\n\t\t\thideWatermark: initSettings.Livechat_hide_watermark || false,\n\t\t\tvisitorsCanCloseChat: initSettings.Omnichannel_allow_visitors_to_close_conversation,\n\t\t},\n\t\ttheme: {\n\t\t\ttitle: initSettings.Livechat_title,\n\t\t\tcolor: initSettings.Livechat_title_color,\n\t\t\tofflineTitle: initSettings.Livechat_offline_title,\n\t\t\tofflineColor: initSettings.Livechat_offline_title_color,\n\t\t\tposition: initSettings.Livechat_widget_position || 'right',\n\t\t\tbackground: initSettings.Livechat_background,\n\t\t\tactionLinks: {\n\t\t\t\twebrtc: [\n\t\t\t\t\t{\n\t\t\t\t\t\tactionLinksAlignment: 'flex-start',\n\t\t\t\t\t\ti18nLabel: 'Join_call',\n\t\t\t\t\t\tlabel: i18n.t('Join_call'),\n\t\t\t\t\t\tmethod_id: 'joinLivechatWebRTCCall',\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\ti18nLabel: 'End_call',\n\t\t\t\t\t\tlabel: i18n.t('End_call'),\n\t\t\t\t\t\tmethod_id: 'endLivechatWebRTCCall',\n\t\t\t\t\t\tdanger: true,\n\t\t\t\t\t},\n\t\t\t\t],\n\t\t\t\tjitsi: [\n\t\t\t\t\t{ icon: 'icon-videocam', i18nLabel: 'Accept' },\n\t\t\t\t\t{ icon: 'icon-cancel', i18nLabel: 'Decline' },\n\t\t\t\t],\n\t\t\t},\n\t\t},\n\t\tmessages: {\n\t\t\tofflineMessage: initSettings.Livechat_offline_message,\n\t\t\tofflineSuccessMessage: initSettings.Livechat_offline_success_message,\n\t\t\tofflineUnavailableMessage: initSettings.Livechat_offline_form_unavailable,\n\t\t\tconversationFinishedMessage: initSettings.Livechat_conversation_finished_message,\n\t\t\tconversationFinishedText: initSettings.Livechat_conversation_finished_text,\n\t\t\ttranscriptMessage: initSettings.Livechat_transcript_message,\n\t\t\tregistrationFormMessage: initSettings.Livechat_registration_form_message,\n\t\t\tdataProcessingConsentText: initSettings.Livechat_data_processing_consent_text,\n\t\t},\n\t\tsurvey: {\n\t\t\titems: ['satisfaction', 'agentKnowledge', 'agentResposiveness', 'agentFriendliness'],\n\t\t\tvalues: ['1', '2', '3', '4', '5'],\n\t\t},\n\t\ttriggers,\n\t\tdepartments,\n\t\tresources: {\n\t\t\tsound,\n\t\t\temojis,\n\t\t},\n\t};\n}\n\nexport async function getExtraConfigInfo(room?: IOmnichannelRoom): Promise<any> {\n\treturn callbacks.run('livechat.onLoadConfigApi', { room });\n}\n\n// TODO: please forgive me for this. Still finding the good types for these callbacks\nexport function onCheckRoomParams(params: any): Promise<unknown> {\n\treturn callbacks.run('livechat.onCheckRoomApiParams', params);\n}\n"]}}},"code":"!module.wrapAsync(async function (module, __reifyWaitForDeps__, __reify_async_result__) {\n  \"use strict\";\n  try {\n    module.export({\n      online: () => online,\n      findGuest: () => findGuest,\n      findGuestWithoutActivity: () => findGuestWithoutActivity,\n      findRoom: () => findRoom,\n      findOpenRoom: () => findOpenRoom,\n      findAgent: () => findAgent,\n      normalizeHttpHeaderData: () => normalizeHttpHeaderData,\n      settings: () => settings,\n      getExtraConfigInfo: () => getExtraConfigInfo,\n      onCheckRoomParams: () => onCheckRoomParams\n    });\n    let License;\n    module.link(\"@rocket.chat/license\", {\n      License(v) {\n        License = v;\n      }\n    }, 0);\n    let EmojiCustom, LivechatTrigger, LivechatVisitors, LivechatRooms, LivechatDepartment;\n    module.link(\"@rocket.chat/models\", {\n      EmojiCustom(v) {\n        EmojiCustom = v;\n      },\n      LivechatTrigger(v) {\n        LivechatTrigger = v;\n      },\n      LivechatVisitors(v) {\n        LivechatVisitors = v;\n      },\n      LivechatRooms(v) {\n        LivechatRooms = v;\n      },\n      LivechatDepartment(v) {\n        LivechatDepartment = v;\n      }\n    }, 1);\n    let Meteor;\n    module.link(\"meteor/meteor\", {\n      Meteor(v) {\n        Meteor = v;\n      }\n    }, 2);\n    let callbacks;\n    module.link(\"../../../../../lib/callbacks\", {\n      callbacks(v) {\n        callbacks = v;\n      }\n    }, 3);\n    let i18n;\n    module.link(\"../../../../../server/lib/i18n\", {\n      i18n(v) {\n        i18n = v;\n      }\n    }, 4);\n    let normalizeAgent;\n    module.link(\"../../lib/Helper\", {\n      normalizeAgent(v) {\n        normalizeAgent = v;\n      }\n    }, 5);\n    let LivechatTyped;\n    module.link(\"../../lib/LivechatTyped\", {\n      Livechat(v) {\n        LivechatTyped = v;\n      }\n    }, 6);\n    if (__reifyWaitForDeps__()) (await __reifyWaitForDeps__())();\n    function online(department) {\n      let skipSettingCheck = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : false;\n      let skipFallbackCheck = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : false;\n      return LivechatTyped.online(department, skipSettingCheck, skipFallbackCheck);\n    }\n    async function findTriggers() {\n      const triggers = await LivechatTrigger.findEnabled().toArray();\n      const hasLicense = License.hasModule('livechat-enterprise');\n      const premiumActions = ['use-external-service'];\n      return triggers.filter(_ref => {\n        let {\n          actions\n        } = _ref;\n        return hasLicense || actions.some(c => !premiumActions.includes(c.name));\n      }).map(_ref2 => {\n        let {\n          _id,\n          actions,\n          conditions,\n          runOnce\n        } = _ref2;\n        return {\n          _id,\n          actions,\n          conditions,\n          runOnce\n        };\n      });\n    }\n    async function findDepartments(businessUnit) {\n      // TODO: check this function usage\n      return (await (await LivechatDepartment.findEnabledWithAgentsAndBusinessUnit(businessUnit, {\n        _id: 1,\n        name: 1,\n        showOnRegistration: 1,\n        showOnOfflineForm: 1\n      })).toArray()).map(_ref3 => {\n        let {\n          _id,\n          name,\n          showOnRegistration,\n          showOnOfflineForm\n        } = _ref3;\n        return {\n          _id,\n          name,\n          showOnRegistration,\n          showOnOfflineForm\n        };\n      });\n    }\n    function findGuest(token) {\n      return LivechatVisitors.getVisitorByToken(token, {\n        projection: {\n          name: 1,\n          username: 1,\n          token: 1,\n          visitorEmails: 1,\n          department: 1,\n          activity: 1,\n          contactId: 1\n        }\n      });\n    }\n    function findGuestWithoutActivity(token) {\n      return LivechatVisitors.getVisitorByToken(token, {\n        projection: {\n          name: 1,\n          username: 1,\n          token: 1,\n          visitorEmails: 1,\n          department: 1\n        }\n      });\n    }\n    async function findRoom(token, rid) {\n      const fields = {\n        t: 1,\n        departmentId: 1,\n        servedBy: 1,\n        open: 1,\n        v: 1,\n        ts: 1\n      };\n      if (!rid) {\n        return LivechatRooms.findOneByVisitorToken(token, fields);\n      }\n      return LivechatRooms.findOneByIdAndVisitorToken(rid, token, fields);\n    }\n    async function findOpenRoom(token, departmentId) {\n      const options = {\n        projection: {\n          departmentId: 1,\n          servedBy: 1,\n          open: 1,\n          callStatus: 1\n        }\n      };\n      const extraQuery = await callbacks.run('livechat.applyRoomRestrictions', {});\n      const rooms = departmentId ? await LivechatRooms.findOpenByVisitorTokenAndDepartmentId(token, departmentId, options, extraQuery).toArray() : await LivechatRooms.findOpenByVisitorToken(token, options, extraQuery).toArray();\n      if (rooms && rooms.length > 0) {\n        return rooms[0];\n      }\n    }\n    async function findAgent(agentId) {\n      return normalizeAgent(agentId);\n    }\n    function normalizeHttpHeaderData() {\n      let headers = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {};\n      const httpHeaders = Object.assign({}, headers);\n      return {\n        httpHeaders\n      };\n    }\n    async function settings() {\n      let {\n        businessUnit = ''\n      } = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {};\n      // Putting this ugly conversion while we type the livechat service\n      const initSettings = await LivechatTyped.getInitSettings();\n      const triggers = await findTriggers();\n      const departments = await findDepartments(businessUnit);\n      const sound = \"\".concat(Meteor.absoluteUrl(), \"sounds/chime.mp3\");\n      const emojis = await EmojiCustom.find().toArray();\n      return {\n        enabled: initSettings.Livechat_enabled,\n        settings: {\n          registrationForm: initSettings.Livechat_registration_form,\n          allowSwitchingDepartments: initSettings.Livechat_allow_switching_departments,\n          nameFieldRegistrationForm: initSettings.Livechat_name_field_registration_form,\n          emailFieldRegistrationForm: initSettings.Livechat_email_field_registration_form,\n          displayOfflineForm: initSettings.Livechat_display_offline_form,\n          videoCall: initSettings.Omnichannel_call_provider === 'default-provider',\n          fileUpload: initSettings.Livechat_fileupload_enabled && initSettings.FileUpload_Enabled,\n          language: initSettings.Language,\n          transcript: initSettings.Livechat_enable_transcript,\n          historyMonitorType: initSettings.Livechat_history_monitor_type,\n          forceAcceptDataProcessingConsent: initSettings.Livechat_force_accept_data_processing_consent,\n          showConnecting: initSettings.Livechat_Show_Connecting,\n          agentHiddenInfo: initSettings.Livechat_show_agent_info === false,\n          clearLocalStorageWhenChatEnded: initSettings.Livechat_clear_local_storage_when_chat_ended,\n          limitTextLength: initSettings.Livechat_enable_message_character_limit && (initSettings.Livechat_message_character_limit || initSettings.Message_MaxAllowedSize),\n          hiddenSystemMessages: initSettings.Livechat_hide_system_messages,\n          livechatLogo: initSettings.Assets_livechat_widget_logo,\n          hideWatermark: initSettings.Livechat_hide_watermark || false,\n          visitorsCanCloseChat: initSettings.Omnichannel_allow_visitors_to_close_conversation\n        },\n        theme: {\n          title: initSettings.Livechat_title,\n          color: initSettings.Livechat_title_color,\n          offlineTitle: initSettings.Livechat_offline_title,\n          offlineColor: initSettings.Livechat_offline_title_color,\n          position: initSettings.Livechat_widget_position || 'right',\n          background: initSettings.Livechat_background,\n          actionLinks: {\n            webrtc: [{\n              actionLinksAlignment: 'flex-start',\n              i18nLabel: 'Join_call',\n              label: i18n.t('Join_call'),\n              method_id: 'joinLivechatWebRTCCall'\n            }, {\n              i18nLabel: 'End_call',\n              label: i18n.t('End_call'),\n              method_id: 'endLivechatWebRTCCall',\n              danger: true\n            }],\n            jitsi: [{\n              icon: 'icon-videocam',\n              i18nLabel: 'Accept'\n            }, {\n              icon: 'icon-cancel',\n              i18nLabel: 'Decline'\n            }]\n          }\n        },\n        messages: {\n          offlineMessage: initSettings.Livechat_offline_message,\n          offlineSuccessMessage: initSettings.Livechat_offline_success_message,\n          offlineUnavailableMessage: initSettings.Livechat_offline_form_unavailable,\n          conversationFinishedMessage: initSettings.Livechat_conversation_finished_message,\n          conversationFinishedText: initSettings.Livechat_conversation_finished_text,\n          transcriptMessage: initSettings.Livechat_transcript_message,\n          registrationFormMessage: initSettings.Livechat_registration_form_message,\n          dataProcessingConsentText: initSettings.Livechat_data_processing_consent_text\n        },\n        survey: {\n          items: ['satisfaction', 'agentKnowledge', 'agentResposiveness', 'agentFriendliness'],\n          values: ['1', '2', '3', '4', '5']\n        },\n        triggers,\n        departments,\n        resources: {\n          sound,\n          emojis\n        }\n      };\n    }\n    async function getExtraConfigInfo(room) {\n      return callbacks.run('livechat.onLoadConfigApi', {\n        room\n      });\n    }\n    function onCheckRoomParams(params) {\n      return callbacks.run('livechat.onCheckRoomApiParams', params);\n    }\n    __reify_async_result__();\n  } catch (_reifyError) {\n    return __reify_async_result__(_reifyError);\n  }\n  __reify_async_result__()\n}, {\n  self: this,\n  async: false\n});","map":{"version":3,"names":["module","export","online","findGuest","findGuestWithoutActivity","findRoom","findOpenRoom","findAgent","normalizeHttpHeaderData","settings","getExtraConfigInfo","onCheckRoomParams","License","link","v","EmojiCustom","LivechatTrigger","LivechatVisitors","LivechatRooms","LivechatDepartment","Meteor","callbacks","i18n","normalizeAgent","LivechatTyped","Livechat","__reifyWaitForDeps__","department","skipSettingCheck","arguments","length","undefined","skipFallbackCheck","findTriggers","triggers","findEnabled","toArray","hasLicense","hasModule","premiumActions","filter","_ref","actions","some","c","includes","name","map","_ref2","_id","conditions","runOnce","findDepartments","businessUnit","findEnabledWithAgentsAndBusinessUnit","showOnRegistration","showOnOfflineForm","_ref3","token","getVisitorByToken","projection","username","visitorEmails","activity","contactId","rid","fields","t","departmentId","servedBy","open","ts","findOneByVisitorToken","findOneByIdAndVisitorToken","options","callStatus","extraQuery","run","rooms","findOpenByVisitorTokenAndDepartmentId","findOpenByVisitorToken","agentId","headers","httpHeaders","Object","assign","initSettings","getInitSettings","departments","sound","concat","absoluteUrl","emojis","find","enabled","Livechat_enabled","registrationForm","Livechat_registration_form","allowSwitchingDepartments","Livechat_allow_switching_departments","nameFieldRegistrationForm","Livechat_name_field_registration_form","emailFieldRegistrationForm","Livechat_email_field_registration_form","displayOfflineForm","Livechat_display_offline_form","videoCall","Omnichannel_call_provider","fileUpload","Livechat_fileupload_enabled","FileUpload_Enabled","language","Language","transcript","Livechat_enable_transcript","historyMonitorType","Livechat_history_monitor_type","forceAcceptDataProcessingConsent","Livechat_force_accept_data_processing_consent","showConnecting","Livechat_Show_Connecting","agentHiddenInfo","Livechat_show_agent_info","clearLocalStorageWhenChatEnded","Livechat_clear_local_storage_when_chat_ended","limitTextLength","Livechat_enable_message_character_limit","Livechat_message_character_limit","Message_MaxAllowedSize","hiddenSystemMessages","Livechat_hide_system_messages","livechatLogo","Assets_livechat_widget_logo","hideWatermark","Livechat_hide_watermark","visitorsCanCloseChat","Omnichannel_allow_visitors_to_close_conversation","theme","title","Livechat_title","color","Livechat_title_color","offlineTitle","Livechat_offline_title","offlineColor","Livechat_offline_title_color","position","Livechat_widget_position","background","Livechat_background","actionLinks","webrtc","actionLinksAlignment","i18nLabel","label","method_id","danger","jitsi","icon","messages","offlineMessage","Livechat_offline_message","offlineSuccessMessage","Livechat_offline_success_message","offlineUnavailableMessage","Livechat_offline_form_unavailable","conversationFinishedMessage","Livechat_conversation_finished_message","conversationFinishedText","Livechat_conversation_finished_text","transcriptMessage","Livechat_transcript_message","registrationFormMessage","Livechat_registration_form_message","dataProcessingConsentText","Livechat_data_processing_consent_text","survey","items","values","resources","room","params","__reify_async_result__","_reifyError","self","async"],"sources":["app/livechat/server/api/lib/livechat.ts"],"sourcesContent":["import type { ILivechatAgent, ILivechatDepartment, ILivechatTrigger, ILivechatVisitor, IOmnichannelRoom } from '@rocket.chat/core-typings';\nimport { License } from '@rocket.chat/license';\nimport { EmojiCustom, LivechatTrigger, LivechatVisitors, LivechatRooms, LivechatDepartment } from '@rocket.chat/models';\nimport { Meteor } from 'meteor/meteor';\n\nimport { callbacks } from '../../../../../lib/callbacks';\nimport { i18n } from '../../../../../server/lib/i18n';\nimport { normalizeAgent } from '../../lib/Helper';\nimport { Livechat as LivechatTyped } from '../../lib/LivechatTyped';\n\nexport function online(department: string, skipSettingCheck = false, skipFallbackCheck = false): Promise<boolean> {\n\treturn LivechatTyped.online(department, skipSettingCheck, skipFallbackCheck);\n}\n\nasync function findTriggers(): Promise<Pick<ILivechatTrigger, '_id' | 'actions' | 'conditions' | 'runOnce'>[]> {\n\tconst triggers = await LivechatTrigger.findEnabled().toArray();\n\tconst hasLicense = License.hasModule('livechat-enterprise');\n\tconst premiumActions = ['use-external-service'];\n\n\treturn triggers\n\t\t.filter(({ actions }) => hasLicense || actions.some((c) => !premiumActions.includes(c.name)))\n\t\t.map(({ _id, actions, conditions, runOnce }) => ({\n\t\t\t_id,\n\t\t\tactions,\n\t\t\tconditions,\n\t\t\trunOnce,\n\t\t}));\n}\n\nasync function findDepartments(\n\tbusinessUnit?: string,\n): Promise<Pick<ILivechatDepartment, '_id' | 'name' | 'showOnRegistration' | 'showOnOfflineForm'>[]> {\n\t// TODO: check this function usage\n\treturn (\n\t\tawait (\n\t\t\tawait LivechatDepartment.findEnabledWithAgentsAndBusinessUnit(businessUnit, {\n\t\t\t\t_id: 1,\n\t\t\t\tname: 1,\n\t\t\t\tshowOnRegistration: 1,\n\t\t\t\tshowOnOfflineForm: 1,\n\t\t\t})\n\t\t).toArray()\n\t).map(({ _id, name, showOnRegistration, showOnOfflineForm }) => ({\n\t\t_id,\n\t\tname,\n\t\tshowOnRegistration,\n\t\tshowOnOfflineForm,\n\t}));\n}\n\nexport function findGuest(token: string): Promise<ILivechatVisitor | null> {\n\treturn LivechatVisitors.getVisitorByToken(token, {\n\t\tprojection: {\n\t\t\tname: 1,\n\t\t\tusername: 1,\n\t\t\ttoken: 1,\n\t\t\tvisitorEmails: 1,\n\t\t\tdepartment: 1,\n\t\t\tactivity: 1,\n\t\t\tcontactId: 1,\n\t\t},\n\t});\n}\n\nexport function findGuestWithoutActivity(token: string): Promise<ILivechatVisitor | null> {\n\treturn LivechatVisitors.getVisitorByToken(token, { projection: { name: 1, username: 1, token: 1, visitorEmails: 1, department: 1 } });\n}\n\nexport async function findRoom(token: string, rid?: string): Promise<IOmnichannelRoom | null> {\n\tconst fields = {\n\t\tt: 1,\n\t\tdepartmentId: 1,\n\t\tservedBy: 1,\n\t\topen: 1,\n\t\tv: 1,\n\t\tts: 1,\n\t};\n\n\tif (!rid) {\n\t\treturn LivechatRooms.findOneByVisitorToken(token, fields);\n\t}\n\n\treturn LivechatRooms.findOneByIdAndVisitorToken(rid, token, fields);\n}\n\nexport async function findOpenRoom(token: string, departmentId?: string): Promise<IOmnichannelRoom | undefined> {\n\tconst options = {\n\t\tprojection: {\n\t\t\tdepartmentId: 1,\n\t\t\tservedBy: 1,\n\t\t\topen: 1,\n\t\t\tcallStatus: 1,\n\t\t},\n\t};\n\n\tconst extraQuery = await callbacks.run('livechat.applyRoomRestrictions', {});\n\tconst rooms = departmentId\n\t\t? await LivechatRooms.findOpenByVisitorTokenAndDepartmentId(token, departmentId, options, extraQuery).toArray()\n\t\t: await LivechatRooms.findOpenByVisitorToken(token, options, extraQuery).toArray();\n\tif (rooms && rooms.length > 0) {\n\t\treturn rooms[0];\n\t}\n}\n\nexport async function findAgent(agentId?: string): Promise<void | { hiddenInfo: boolean } | ILivechatAgent> {\n\treturn normalizeAgent(agentId);\n}\n\nexport function normalizeHttpHeaderData(headers: Record<string, string | string[] | undefined> = {}): {\n\thttpHeaders: Record<string, string | string[] | undefined>;\n} {\n\tconst httpHeaders = Object.assign({}, headers);\n\treturn { httpHeaders };\n}\n\nexport async function settings({ businessUnit = '' }: { businessUnit?: string } = {}): Promise<Record<string, string | number | any>> {\n\t// Putting this ugly conversion while we type the livechat service\n\tconst initSettings = await LivechatTyped.getInitSettings();\n\tconst triggers = await findTriggers();\n\tconst departments = await findDepartments(businessUnit);\n\tconst sound = `${Meteor.absoluteUrl()}sounds/chime.mp3`;\n\tconst emojis = await EmojiCustom.find().toArray();\n\treturn {\n\t\tenabled: initSettings.Livechat_enabled,\n\t\tsettings: {\n\t\t\tregistrationForm: initSettings.Livechat_registration_form,\n\t\t\tallowSwitchingDepartments: initSettings.Livechat_allow_switching_departments,\n\t\t\tnameFieldRegistrationForm: initSettings.Livechat_name_field_registration_form,\n\t\t\temailFieldRegistrationForm: initSettings.Livechat_email_field_registration_form,\n\t\t\tdisplayOfflineForm: initSettings.Livechat_display_offline_form,\n\t\t\tvideoCall: initSettings.Omnichannel_call_provider === 'default-provider',\n\t\t\tfileUpload: initSettings.Livechat_fileupload_enabled && initSettings.FileUpload_Enabled,\n\t\t\tlanguage: initSettings.Language,\n\t\t\ttranscript: initSettings.Livechat_enable_transcript,\n\t\t\thistoryMonitorType: initSettings.Livechat_history_monitor_type,\n\t\t\tforceAcceptDataProcessingConsent: initSettings.Livechat_force_accept_data_processing_consent,\n\t\t\tshowConnecting: initSettings.Livechat_Show_Connecting,\n\t\t\tagentHiddenInfo: initSettings.Livechat_show_agent_info === false,\n\t\t\tclearLocalStorageWhenChatEnded: initSettings.Livechat_clear_local_storage_when_chat_ended,\n\t\t\tlimitTextLength:\n\t\t\t\tinitSettings.Livechat_enable_message_character_limit &&\n\t\t\t\t(initSettings.Livechat_message_character_limit || initSettings.Message_MaxAllowedSize),\n\t\t\thiddenSystemMessages: initSettings.Livechat_hide_system_messages,\n\t\t\tlivechatLogo: initSettings.Assets_livechat_widget_logo,\n\t\t\thideWatermark: initSettings.Livechat_hide_watermark || false,\n\t\t\tvisitorsCanCloseChat: initSettings.Omnichannel_allow_visitors_to_close_conversation,\n\t\t},\n\t\ttheme: {\n\t\t\ttitle: initSettings.Livechat_title,\n\t\t\tcolor: initSettings.Livechat_title_color,\n\t\t\tofflineTitle: initSettings.Livechat_offline_title,\n\t\t\tofflineColor: initSettings.Livechat_offline_title_color,\n\t\t\tposition: initSettings.Livechat_widget_position || 'right',\n\t\t\tbackground: initSettings.Livechat_background,\n\t\t\tactionLinks: {\n\t\t\t\twebrtc: [\n\t\t\t\t\t{\n\t\t\t\t\t\tactionLinksAlignment: 'flex-start',\n\t\t\t\t\t\ti18nLabel: 'Join_call',\n\t\t\t\t\t\tlabel: i18n.t('Join_call'),\n\t\t\t\t\t\tmethod_id: 'joinLivechatWebRTCCall',\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\ti18nLabel: 'End_call',\n\t\t\t\t\t\tlabel: i18n.t('End_call'),\n\t\t\t\t\t\tmethod_id: 'endLivechatWebRTCCall',\n\t\t\t\t\t\tdanger: true,\n\t\t\t\t\t},\n\t\t\t\t],\n\t\t\t\tjitsi: [\n\t\t\t\t\t{ icon: 'icon-videocam', i18nLabel: 'Accept' },\n\t\t\t\t\t{ icon: 'icon-cancel', i18nLabel: 'Decline' },\n\t\t\t\t],\n\t\t\t},\n\t\t},\n\t\tmessages: {\n\t\t\tofflineMessage: initSettings.Livechat_offline_message,\n\t\t\tofflineSuccessMessage: initSettings.Livechat_offline_success_message,\n\t\t\tofflineUnavailableMessage: initSettings.Livechat_offline_form_unavailable,\n\t\t\tconversationFinishedMessage: initSettings.Livechat_conversation_finished_message,\n\t\t\tconversationFinishedText: initSettings.Livechat_conversation_finished_text,\n\t\t\ttranscriptMessage: initSettings.Livechat_transcript_message,\n\t\t\tregistrationFormMessage: initSettings.Livechat_registration_form_message,\n\t\t\tdataProcessingConsentText: initSettings.Livechat_data_processing_consent_text,\n\t\t},\n\t\tsurvey: {\n\t\t\titems: ['satisfaction', 'agentKnowledge', 'agentResposiveness', 'agentFriendliness'],\n\t\t\tvalues: ['1', '2', '3', '4', '5'],\n\t\t},\n\t\ttriggers,\n\t\tdepartments,\n\t\tresources: {\n\t\t\tsound,\n\t\t\temojis,\n\t\t},\n\t};\n}\n\nexport async function getExtraConfigInfo(room?: IOmnichannelRoom): Promise<any> {\n\treturn callbacks.run('livechat.onLoadConfigApi', { room });\n}\n\n// TODO: please forgive me for this. Still finding the good types for these callbacks\nexport function onCheckRoomParams(params: any): Promise<unknown> {\n\treturn callbacks.run('livechat.onCheckRoomApiParams', params);\n}\n"],"mappings":";;;IACAA,MAAA,CAAOC,MAAE;MAAAC,MAAS,EAAAA,CAAA,KAAMA,MAAA;MAAAC,SAAA,EAAAA,CAAA,KAAuBA,SAAA;MAAAC,wBAAA,EAAAA,CAAA,KAAAA,wBAAA;MAAAC,QAAA,EAAAA,CAAA,KAAAA,QAAA;MAAAC,YAAA,EAAAA,CAAA,KAAAA,YAAA;MAAAC,SAAA,EAAAA,CAAA,KAAAA,SAAA;MAAAC,uBAAA,EAAAA,CAAA,KAAAA,uBAAA;MAAAC,QAAA,EAAAA,CAAA,KAAAA,QAAA;MAAAC,kBAAA,EAAAA,CAAA,KAAAA,kBAAA;MAAAC,iBAAA,EAAAA,CAAA,KAAAA;IAAA;IAAA,IAAAC,OAAA;IAAAZ,MAAA,CAAAa,IAAA;MAAAD,QAAAE,CAAA;QAAAF,OAAA,GAAAE,CAAA;MAAA;IAAA;IAAA,IAAAC,WAAA,EAAAC,eAAA,EAAAC,gBAAA,EAAAC,aAAA,EAAAC,kBAAA;IAAAnB,MAAA,CAAAa,IAAA;MAAAE,YAAAD,CAAA;QAAAC,WAAA,GAAAD,CAAA;MAAA;MAAAE,gBAAAF,CAAA;QAAAE,eAAA,GAAAF,CAAA;MAAA;MAAAG,iBAAAH,CAAA;QAAAG,gBAAA,GAAAH,CAAA;MAAA;MAAAI,cAAAJ,CAAA;QAAAI,aAAA,GAAAJ,CAAA;MAAA;MAAAK,mBAAAL,CAAA;QAAAK,kBAAA,GAAAL,CAAA;MAAA;IAAA;IAAA,IAAAM,MAAA;IAAApB,MAAA,CAAAa,IAAA;MAAAO,OAAAN,CAAA;QAAAM,MAAA,GAAAN,CAAA;MAAA;IAAA;IAAA,IAAAO,SAAA;IAAArB,MAAA,CAAAa,IAAA;MAAAQ,UAAAP,CAAA;QAAAO,SAAA,GAAAP,CAAA;MAAA;IAAA;IAAA,IAAAQ,IAAA;IAAAtB,MAAA,CAAAa,IAAA;MAAAS,KAAAR,CAAA;QAAAQ,IAAA,GAAAR,CAAA;MAAA;IAAA;IAAA,IAAAS,cAAA;IAAAvB,MAAA,CAAAa,IAAA;MAAAU,eAAAT,CAAA;QAAAS,cAAA,GAAAT,CAAA;MAAA;IAAA;IAAA,IAAAU,aAAA;IAAAxB,MAAA,CAAAa,IAAA;MAAAY,SAAAX,CAAA;QAAAU,aAAA,GAAAV,CAAA;MAAA;IAAA;IAAA,IAAAY,oBAAA,WAAAA,oBAAA;IASzC,SAAUxB,MAAMA,CAACyB,UAAkB,EAAqD;MAAA,IAAnDC,gBAAgB,GAAAC,SAAA,CAAAC,MAAA,QAAAD,SAAA,QAAAE,SAAA,GAAAF,SAAA,MAAG,KAAK;MAAA,IAAEG,iBAAiB,GAAAH,SAAA,CAAAC,MAAA,QAAAD,SAAA,QAAAE,SAAA,GAAAF,SAAA,MAAG,KAAK;MAC7F,OAAOL,aAAa,CAACtB,MAAM,CAACyB,UAAU,EAAEC,gBAAgB,EAAEI,iBAAiB,CAAC;IAC7E;IAEA,eAAeC,YAAYA,CAAA;MAC1B,MAAMC,QAAQ,GAAG,MAAMlB,eAAe,CAACmB,WAAW,EAAE,CAACC,OAAO,EAAE;MAC9D,MAAMC,UAAU,GAAGzB,OAAO,CAAC0B,SAAS,CAAC,qBAAqB,CAAC;MAC3D,MAAMC,cAAc,GAAG,CAAC,sBAAsB,CAAC;MAE/C,OAAOL,QAAQ,CACbM,MAAM,CAACC,IAAA;QAAA,IAAC;UAAEC;QAAO,CAAE,GAAAD,IAAA;QAAA,OAAKJ,UAAU,IAAIK,OAAO,CAACC,IAAI,CAAEC,CAAC,IAAK,CAACL,cAAc,CAACM,QAAQ,CAACD,CAAC,CAACE,IAAI,CAAC,CAAC;MAAA,EAAC,CAC5FC,GAAG,CAACC,KAAA;QAAA,IAAC;UAAEC,GAAG;UAAEP,OAAO;UAAEQ,UAAU;UAAEC;QAAO,CAAE,GAAAH,KAAA;QAAA,OAAM;UAChDC,GAAG;UACHP,OAAO;UACPQ,UAAU;UACVC;SACA;MAAA,CAAC,CAAC;IACL;IAEA,eAAeC,eAAeA,CAC7BC,YAAqB;MAErB;MACA,OAAO,CACN,MAAM,CACL,MAAMlC,kBAAkB,CAACmC,oCAAoC,CAACD,YAAY,EAAE;QAC3EJ,GAAG,EAAE,CAAC;QACNH,IAAI,EAAE,CAAC;QACPS,kBAAkB,EAAE,CAAC;QACrBC,iBAAiB,EAAE;OACnB,CAAC,EACDpB,OAAO,EAAE,EACVW,GAAG,CAACU,KAAA;QAAA,IAAC;UAAER,GAAG;UAAEH,IAAI;UAAES,kBAAkB;UAAEC;QAAiB,CAAE,GAAAC,KAAA;QAAA,OAAM;UAChER,GAAG;UACHH,IAAI;UACJS,kBAAkB;UAClBC;SACA;MAAA,CAAC,CAAC;IACJ;IAEM,SAAUrD,SAASA,CAACuD,KAAa;MACtC,OAAOzC,gBAAgB,CAAC0C,iBAAiB,CAACD,KAAK,EAAE;QAChDE,UAAU,EAAE;UACXd,IAAI,EAAE,CAAC;UACPe,QAAQ,EAAE,CAAC;UACXH,KAAK,EAAE,CAAC;UACRI,aAAa,EAAE,CAAC;UAChBnC,UAAU,EAAE,CAAC;UACboC,QAAQ,EAAE,CAAC;UACXC,SAAS,EAAE;;OAEZ,CAAC;IACH;IAEM,SAAU5D,wBAAwBA,CAACsD,KAAa;MACrD,OAAOzC,gBAAgB,CAAC0C,iBAAiB,CAACD,KAAK,EAAE;QAAEE,UAAU,EAAE;UAAEd,IAAI,EAAE,CAAC;UAAEe,QAAQ,EAAE,CAAC;UAAEH,KAAK,EAAE,CAAC;UAAEI,aAAa,EAAE,CAAC;UAAEnC,UAAU,EAAE;QAAC;MAAE,CAAE,CAAC;IACtI;IAEO,eAAetB,QAAQA,CAACqD,KAAa,EAAEO,GAAY;MACzD,MAAMC,MAAM,GAAG;QACdC,CAAC,EAAE,CAAC;QACJC,YAAY,EAAE,CAAC;QACfC,QAAQ,EAAE,CAAC;QACXC,IAAI,EAAE,CAAC;QACPxD,CAAC,EAAE,CAAC;QACJyD,EAAE,EAAE;OACJ;MAED,IAAI,CAACN,GAAG,EAAE;QACT,OAAO/C,aAAa,CAACsD,qBAAqB,CAACd,KAAK,EAAEQ,MAAM,CAAC;MAC1D;MAEA,OAAOhD,aAAa,CAACuD,0BAA0B,CAACR,GAAG,EAAEP,KAAK,EAAEQ,MAAM,CAAC;IACpE;IAEO,eAAe5D,YAAYA,CAACoD,KAAa,EAAEU,YAAqB;MACtE,MAAMM,OAAO,GAAG;QACfd,UAAU,EAAE;UACXQ,YAAY,EAAE,CAAC;UACfC,QAAQ,EAAE,CAAC;UACXC,IAAI,EAAE,CAAC;UACPK,UAAU,EAAE;;OAEb;MAED,MAAMC,UAAU,GAAG,MAAMvD,SAAS,CAACwD,GAAG,CAAC,gCAAgC,EAAE,EAAE,CAAC;MAC5E,MAAMC,KAAK,GAAGV,YAAY,GACvB,MAAMlD,aAAa,CAAC6D,qCAAqC,CAACrB,KAAK,EAAEU,YAAY,EAAEM,OAAO,EAAEE,UAAU,CAAC,CAACxC,OAAO,EAAE,GAC7G,MAAMlB,aAAa,CAAC8D,sBAAsB,CAACtB,KAAK,EAAEgB,OAAO,EAAEE,UAAU,CAAC,CAACxC,OAAO,EAAE;MACnF,IAAI0C,KAAK,IAAIA,KAAK,CAAChD,MAAM,GAAG,CAAC,EAAE;QAC9B,OAAOgD,KAAK,CAAC,CAAC,CAAC;MAChB;IACD;IAEO,eAAevE,SAASA,CAAC0E,OAAgB;MAC/C,OAAO1D,cAAc,CAAC0D,OAAO,CAAC;IAC/B;IAEM,SAAUzE,uBAAuBA,CAAA,EAA4D;MAAA,IAA3D0E,OAAA,GAAArD,SAAA,CAAAC,MAAA,QAAAD,SAAA,QAAAE,SAAA,GAAAF,SAAA,MAAyD,EAAE;MAGlG,MAAMsD,WAAW,GAAGC,MAAM,CAACC,MAAM,CAAC,EAAE,EAAEH,OAAO,CAAC;MAC9C,OAAO;QAAEC;MAAW,CAAE;IACvB;IAEO,eAAe1E,QAAQA,CAAA,EAAsD;MAAA,IAArD;QAAE4C,YAAY,GAAG;MAAE,IAAAxB,SAAA,CAAAC,MAAA,QAAAD,SAAA,QAAAE,SAAA,GAAAF,SAAA,MAAgC,EAAE;MACnF;MACA,MAAMyD,YAAY,GAAG,MAAM9D,aAAa,CAAC+D,eAAe,EAAE;MAC1D,MAAMrD,QAAQ,GAAG,MAAMD,YAAY,EAAE;MACrC,MAAMuD,WAAW,GAAG,MAAMpC,eAAe,CAACC,YAAY,CAAC;MACvD,MAAMoC,KAAK,MAAAC,MAAA,CAAMtE,MAAM,CAACuE,WAAW,EAAE,qBAAkB;MACvD,MAAMC,MAAM,GAAG,MAAM7E,WAAW,CAAC8E,IAAI,EAAE,CAACzD,OAAO,EAAE;MACjD,OAAO;QACN0D,OAAO,EAAER,YAAY,CAACS,gBAAgB;QACtCtF,QAAQ,EAAE;UACTuF,gBAAgB,EAAEV,YAAY,CAACW,0BAA0B;UACzDC,yBAAyB,EAAEZ,YAAY,CAACa,oCAAoC;UAC5EC,yBAAyB,EAAEd,YAAY,CAACe,qCAAqC;UAC7EC,0BAA0B,EAAEhB,YAAY,CAACiB,sCAAsC;UAC/EC,kBAAkB,EAAElB,YAAY,CAACmB,6BAA6B;UAC9DC,SAAS,EAAEpB,YAAY,CAACqB,yBAAyB,KAAK,kBAAkB;UACxEC,UAAU,EAAEtB,YAAY,CAACuB,2BAA2B,IAAIvB,YAAY,CAACwB,kBAAkB;UACvFC,QAAQ,EAAEzB,YAAY,CAAC0B,QAAQ;UAC/BC,UAAU,EAAE3B,YAAY,CAAC4B,0BAA0B;UACnDC,kBAAkB,EAAE7B,YAAY,CAAC8B,6BAA6B;UAC9DC,gCAAgC,EAAE/B,YAAY,CAACgC,6CAA6C;UAC5FC,cAAc,EAAEjC,YAAY,CAACkC,wBAAwB;UACrDC,eAAe,EAAEnC,YAAY,CAACoC,wBAAwB,KAAK,KAAK;UAChEC,8BAA8B,EAAErC,YAAY,CAACsC,4CAA4C;UACzFC,eAAe,EACdvC,YAAY,CAACwC,uCAAuC,KACnDxC,YAAY,CAACyC,gCAAgC,IAAIzC,YAAY,CAAC0C,sBAAsB,CAAC;UACvFC,oBAAoB,EAAE3C,YAAY,CAAC4C,6BAA6B;UAChEC,YAAY,EAAE7C,YAAY,CAAC8C,2BAA2B;UACtDC,aAAa,EAAE/C,YAAY,CAACgD,uBAAuB,IAAI,KAAK;UAC5DC,oBAAoB,EAAEjD,YAAY,CAACkD;SACnC;QACDC,KAAK,EAAE;UACNC,KAAK,EAAEpD,YAAY,CAACqD,cAAc;UAClCC,KAAK,EAAEtD,YAAY,CAACuD,oBAAoB;UACxCC,YAAY,EAAExD,YAAY,CAACyD,sBAAsB;UACjDC,YAAY,EAAE1D,YAAY,CAAC2D,4BAA4B;UACvDC,QAAQ,EAAE5D,YAAY,CAAC6D,wBAAwB,IAAI,OAAO;UAC1DC,UAAU,EAAE9D,YAAY,CAAC+D,mBAAmB;UAC5CC,WAAW,EAAE;YACZC,MAAM,EAAE,CACP;cACCC,oBAAoB,EAAE,YAAY;cAClCC,SAAS,EAAE,WAAW;cACtBC,KAAK,EAAEpI,IAAI,CAAC6C,CAAC,CAAC,WAAW,CAAC;cAC1BwF,SAAS,EAAE;aACX,EACD;cACCF,SAAS,EAAE,UAAU;cACrBC,KAAK,EAAEpI,IAAI,CAAC6C,CAAC,CAAC,UAAU,CAAC;cACzBwF,SAAS,EAAE,uBAAuB;cAClCC,MAAM,EAAE;aACR,CACD;YACDC,KAAK,EAAE,CACN;cAAEC,IAAI,EAAE,eAAe;cAAEL,SAAS,EAAE;YAAQ,CAAE,EAC9C;cAAEK,IAAI,EAAE,aAAa;cAAEL,SAAS,EAAE;YAAS,CAAE;;SAG/C;QACDM,QAAQ,EAAE;UACTC,cAAc,EAAE1E,YAAY,CAAC2E,wBAAwB;UACrDC,qBAAqB,EAAE5E,YAAY,CAAC6E,gCAAgC;UACpEC,yBAAyB,EAAE9E,YAAY,CAAC+E,iCAAiC;UACzEC,2BAA2B,EAAEhF,YAAY,CAACiF,sCAAsC;UAChFC,wBAAwB,EAAElF,YAAY,CAACmF,mCAAmC;UAC1EC,iBAAiB,EAAEpF,YAAY,CAACqF,2BAA2B;UAC3DC,uBAAuB,EAAEtF,YAAY,CAACuF,kCAAkC;UACxEC,yBAAyB,EAAExF,YAAY,CAACyF;SACxC;QACDC,MAAM,EAAE;UACPC,KAAK,EAAE,CAAC,cAAc,EAAE,gBAAgB,EAAE,oBAAoB,EAAE,mBAAmB,CAAC;UACpFC,MAAM,EAAE,CAAC,GAAG,EAAE,GAAG,EAAE,GAAG,EAAE,GAAG,EAAE,GAAG;SAChC;QACDhJ,QAAQ;QACRsD,WAAW;QACX2F,SAAS,EAAE;UACV1F,KAAK;UACLG;;OAED;IACF;IAEO,eAAelF,kBAAkBA,CAAC0K,IAAuB;MAC/D,OAAO/J,SAAS,CAACwD,GAAG,CAAC,0BAA0B,EAAE;QAAEuG;MAAI,CAAE,CAAC;IAC3D;IAGM,SAAUzK,iBAAiBA,CAAC0K,MAAW;MAC5C,OAAOhK,SAAS,CAACwD,GAAG,CAAC,+BAA+B,EAAEwG,MAAM,CAAC;IAC9D;IAACC,sBAAA;EAAA,SAAAC,WAAA;IAAA,OAAAD,sBAAA,CAAAC,WAAA;EAAA;EAAAD,sBAAA;AAAA;EAAAE,IAAA;EAAAC,KAAA;AAAA","ignoreList":[]},"sourceType":"module","externalDependencies":{},"hash":"02fb99ae911348a6c51322e9f9cb542f94e7cae4"}
