{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/app/livechat/server/hooks/offlineMessageToChannel.ts","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","topLevelAwait","objectRestSpread","objectRestSpread","asyncGenerators","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"os.osx.arm64"},"sourceFileName":"app/livechat/server/hooks/offlineMessageToChannel.ts","filename":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/app/livechat/server/hooks/offlineMessageToChannel.ts","inputSourceMap":{"version":3,"file":"app/livechat/server/hooks/offlineMessageToChannel.ts","sourceRoot":"","sources":["app/livechat/server/hooks/offlineMessageToChannel.ts"],"names":[],"mappings":"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","sourcesContent":["import type { ILivechatDepartment } from '@rocket.chat/core-typings';\nimport { isOmnichannelRoom } from '@rocket.chat/core-typings';\nimport { LivechatDepartment, Users, Rooms } from '@rocket.chat/models';\n\nimport { callbacks } from '../../../../lib/callbacks';\nimport { i18n } from '../../../../server/lib/i18n';\nimport { sendMessage } from '../../../lib/server/functions/sendMessage';\nimport { settings } from '../../../settings/server';\n\ncallbacks.add(\n\t'livechat.offlineMessage',\n\tasync (data) => {\n\t\tif (!settings.get('Livechat_OfflineMessageToChannel_enabled')) {\n\t\t\treturn data;\n\t\t}\n\n\t\tlet channelName = settings.get<string>('Livechat_OfflineMessageToChannel_channel_name');\n\t\tlet departmentName;\n\t\tconst { name, email, department, message: text, host } = data;\n\t\tif (department && department !== '') {\n\t\t\tconst dept = await LivechatDepartment.findOneById<Pick<ILivechatDepartment, '_id' | 'name' | 'offlineMessageChannelName'>>(\n\t\t\t\tdepartment,\n\t\t\t\t{\n\t\t\t\t\tprojection: { name: 1, offlineMessageChannelName: 1 },\n\t\t\t\t},\n\t\t\t);\n\t\t\tdepartmentName = dept?.name;\n\t\t\tif (dept?.offlineMessageChannelName) {\n\t\t\t\tchannelName = dept.offlineMessageChannelName;\n\t\t\t}\n\t\t}\n\n\t\tif (!channelName || channelName === '') {\n\t\t\treturn data;\n\t\t}\n\n\t\tconst room = await Rooms.findOneByName(channelName, { projection: { t: 1, archived: 1 } });\n\t\tif (!room || room.archived || (isOmnichannelRoom(room) && room.closedAt)) {\n\t\t\treturn data;\n\t\t}\n\n\t\tconst user = await Users.findOneById('rocket.cat', { projection: { username: 1 } });\n\t\tif (!user) {\n\t\t\treturn data;\n\t\t}\n\n\t\tconst lng = settings.get<string>('Language') || 'en';\n\n\t\tlet msg = `${i18n.t('New_Livechat_offline_message_has_been_sent', { lng })}: \\n`;\n\t\tif (host && host !== '') {\n\t\t\tmsg = msg.concat(`${i18n.t('Sent_from', { lng })}: ${host} \\n`);\n\t\t}\n\t\tmsg = msg.concat(`${i18n.t('Visitor_Name', { lng })}: ${name} \\n`);\n\t\tmsg = msg.concat(`${i18n.t('Visitor_Email', { lng })}: ${email} \\n`);\n\t\tif (departmentName) {\n\t\t\tmsg = msg.concat(`${i18n.t('Department', { lng })}: ${departmentName} \\n`);\n\t\t}\n\t\tmsg = msg.concat(`${i18n.t('Message', { lng })}: ${text} \\n`);\n\n\t\tconst message = {\n\t\t\trid: room._id,\n\t\t\tmsg,\n\t\t\tgroupable: false,\n\t\t};\n\n\t\tawait sendMessage(user, message, room, true);\n\t},\n\tcallbacks.priority.MEDIUM,\n\t'livechat-send-email-offline-message-to-channel',\n);\n"]},"targets":{"android":"125.0.0","chrome":"125.0.0","edge":"125.0.0","firefox":"115.0.0","ie":"10.0.0","ios":"17.4.0","opera":"110.0.0","opera_mobile":"80.0.0","safari":"17.4.0","samsung":"24.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor","root":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":false,"enforceStrictMode":false,"dynamicImport":true,"generateLetDeclarations":true,"topLevelAwait":true},"externalDependencies":[]},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"version":"7.17.2","helpers":true,"useESModules":false,"corejs":false},"externalDependencies":[]},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-async-generator-functions","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-class-properties","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true},"externalDependencies":[]},{"key":"transform-react-jsx","visitor":{"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXFragment":{"exit":[null]},"JSXElement":{"exit":[null]},"JSXAttribute":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false},"externalDependencies":[]},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-nullish-coalescing-operator","visitor":{"LogicalExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-optional-chaining","visitor":{"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-optional-catch-binding","visitor":{"CatchClause":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-class-properties","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-async-generator-functions","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-logical-assignment-operators","visitor":{"AssignmentExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]}],"presets":[],"generatorOpts":{"filename":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/app/livechat/server/hooks/offlineMessageToChannel.ts","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"app/livechat/server/hooks/offlineMessageToChannel.ts","inputSourceMap":{"version":3,"file":"app/livechat/server/hooks/offlineMessageToChannel.ts","sourceRoot":"","sources":["app/livechat/server/hooks/offlineMessageToChannel.ts"],"names":[],"mappings":"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","sourcesContent":["import type { ILivechatDepartment } from '@rocket.chat/core-typings';\nimport { isOmnichannelRoom } from '@rocket.chat/core-typings';\nimport { LivechatDepartment, Users, Rooms } from '@rocket.chat/models';\n\nimport { callbacks } from '../../../../lib/callbacks';\nimport { i18n } from '../../../../server/lib/i18n';\nimport { sendMessage } from '../../../lib/server/functions/sendMessage';\nimport { settings } from '../../../settings/server';\n\ncallbacks.add(\n\t'livechat.offlineMessage',\n\tasync (data) => {\n\t\tif (!settings.get('Livechat_OfflineMessageToChannel_enabled')) {\n\t\t\treturn data;\n\t\t}\n\n\t\tlet channelName = settings.get<string>('Livechat_OfflineMessageToChannel_channel_name');\n\t\tlet departmentName;\n\t\tconst { name, email, department, message: text, host } = data;\n\t\tif (department && department !== '') {\n\t\t\tconst dept = await LivechatDepartment.findOneById<Pick<ILivechatDepartment, '_id' | 'name' | 'offlineMessageChannelName'>>(\n\t\t\t\tdepartment,\n\t\t\t\t{\n\t\t\t\t\tprojection: { name: 1, offlineMessageChannelName: 1 },\n\t\t\t\t},\n\t\t\t);\n\t\t\tdepartmentName = dept?.name;\n\t\t\tif (dept?.offlineMessageChannelName) {\n\t\t\t\tchannelName = dept.offlineMessageChannelName;\n\t\t\t}\n\t\t}\n\n\t\tif (!channelName || channelName === '') {\n\t\t\treturn data;\n\t\t}\n\n\t\tconst room = await Rooms.findOneByName(channelName, { projection: { t: 1, archived: 1 } });\n\t\tif (!room || room.archived || (isOmnichannelRoom(room) && room.closedAt)) {\n\t\t\treturn data;\n\t\t}\n\n\t\tconst user = await Users.findOneById('rocket.cat', { projection: { username: 1 } });\n\t\tif (!user) {\n\t\t\treturn data;\n\t\t}\n\n\t\tconst lng = settings.get<string>('Language') || 'en';\n\n\t\tlet msg = `${i18n.t('New_Livechat_offline_message_has_been_sent', { lng })}: \\n`;\n\t\tif (host && host !== '') {\n\t\t\tmsg = msg.concat(`${i18n.t('Sent_from', { lng })}: ${host} \\n`);\n\t\t}\n\t\tmsg = msg.concat(`${i18n.t('Visitor_Name', { lng })}: ${name} \\n`);\n\t\tmsg = msg.concat(`${i18n.t('Visitor_Email', { lng })}: ${email} \\n`);\n\t\tif (departmentName) {\n\t\t\tmsg = msg.concat(`${i18n.t('Department', { lng })}: ${departmentName} \\n`);\n\t\t}\n\t\tmsg = msg.concat(`${i18n.t('Message', { lng })}: ${text} \\n`);\n\n\t\tconst message = {\n\t\t\trid: room._id,\n\t\t\tmsg,\n\t\t\tgroupable: false,\n\t\t};\n\n\t\tawait sendMessage(user, message, room, true);\n\t},\n\tcallbacks.priority.MEDIUM,\n\t'livechat-send-email-offline-message-to-channel',\n);\n"]}}},"code":"!module.wrapAsync(async function (module, __reifyWaitForDeps__, __reify_async_result__) {\n  \"use strict\";\n  try {\n    let isOmnichannelRoom;\n    module.link(\"@rocket.chat/core-typings\", {\n      isOmnichannelRoom(v) {\n        isOmnichannelRoom = v;\n      }\n    }, 0);\n    let LivechatDepartment, Users, Rooms;\n    module.link(\"@rocket.chat/models\", {\n      LivechatDepartment(v) {\n        LivechatDepartment = v;\n      },\n      Users(v) {\n        Users = v;\n      },\n      Rooms(v) {\n        Rooms = v;\n      }\n    }, 1);\n    let callbacks;\n    module.link(\"../../../../lib/callbacks\", {\n      callbacks(v) {\n        callbacks = v;\n      }\n    }, 2);\n    let i18n;\n    module.link(\"../../../../server/lib/i18n\", {\n      i18n(v) {\n        i18n = v;\n      }\n    }, 3);\n    let sendMessage;\n    module.link(\"../../../lib/server/functions/sendMessage\", {\n      sendMessage(v) {\n        sendMessage = v;\n      }\n    }, 4);\n    let settings;\n    module.link(\"../../../settings/server\", {\n      settings(v) {\n        settings = v;\n      }\n    }, 5);\n    if (__reifyWaitForDeps__()) (await __reifyWaitForDeps__())();\n    callbacks.add('livechat.offlineMessage', async data => {\n      if (!settings.get('Livechat_OfflineMessageToChannel_enabled')) {\n        return data;\n      }\n      let channelName = settings.get('Livechat_OfflineMessageToChannel_channel_name');\n      let departmentName;\n      const {\n        name,\n        email,\n        department,\n        message: text,\n        host\n      } = data;\n      if (department && department !== '') {\n        const dept = await LivechatDepartment.findOneById(department, {\n          projection: {\n            name: 1,\n            offlineMessageChannelName: 1\n          }\n        });\n        departmentName = dept === null || dept === void 0 ? void 0 : dept.name;\n        if (dept !== null && dept !== void 0 && dept.offlineMessageChannelName) {\n          channelName = dept.offlineMessageChannelName;\n        }\n      }\n      if (!channelName || channelName === '') {\n        return data;\n      }\n      const room = await Rooms.findOneByName(channelName, {\n        projection: {\n          t: 1,\n          archived: 1\n        }\n      });\n      if (!room || room.archived || isOmnichannelRoom(room) && room.closedAt) {\n        return data;\n      }\n      const user = await Users.findOneById('rocket.cat', {\n        projection: {\n          username: 1\n        }\n      });\n      if (!user) {\n        return data;\n      }\n      const lng = settings.get('Language') || 'en';\n      let msg = \"\".concat(i18n.t('New_Livechat_offline_message_has_been_sent', {\n        lng\n      }), \": \\n\");\n      if (host && host !== '') {\n        msg = msg.concat(\"\".concat(i18n.t('Sent_from', {\n          lng\n        }), \": \").concat(host, \" \\n\"));\n      }\n      msg = msg.concat(\"\".concat(i18n.t('Visitor_Name', {\n        lng\n      }), \": \").concat(name, \" \\n\"));\n      msg = msg.concat(\"\".concat(i18n.t('Visitor_Email', {\n        lng\n      }), \": \").concat(email, \" \\n\"));\n      if (departmentName) {\n        msg = msg.concat(\"\".concat(i18n.t('Department', {\n          lng\n        }), \": \").concat(departmentName, \" \\n\"));\n      }\n      msg = msg.concat(\"\".concat(i18n.t('Message', {\n        lng\n      }), \": \").concat(text, \" \\n\"));\n      const message = {\n        rid: room._id,\n        msg,\n        groupable: false\n      };\n      await sendMessage(user, message, room, true);\n    }, callbacks.priority.MEDIUM, 'livechat-send-email-offline-message-to-channel');\n    __reify_async_result__();\n  } catch (_reifyError) {\n    return __reify_async_result__(_reifyError);\n  }\n  __reify_async_result__()\n}, {\n  self: this,\n  async: false\n});","map":{"version":3,"names":["isOmnichannelRoom","module","link","v","LivechatDepartment","Users","Rooms","callbacks","i18n","sendMessage","settings","__reifyWaitForDeps__","add","data","get","channelName","departmentName","name","email","department","message","text","host","dept","findOneById","projection","offlineMessageChannelName","room","findOneByName","t","archived","closedAt","user","username","lng","msg","concat","rid","_id","groupable","priority","MEDIUM","__reify_async_result__","_reifyError","self","async"],"sources":["app/livechat/server/hooks/offlineMessageToChannel.ts"],"sourcesContent":["import type { ILivechatDepartment } from '@rocket.chat/core-typings';\nimport { isOmnichannelRoom } from '@rocket.chat/core-typings';\nimport { LivechatDepartment, Users, Rooms } from '@rocket.chat/models';\n\nimport { callbacks } from '../../../../lib/callbacks';\nimport { i18n } from '../../../../server/lib/i18n';\nimport { sendMessage } from '../../../lib/server/functions/sendMessage';\nimport { settings } from '../../../settings/server';\n\ncallbacks.add(\n\t'livechat.offlineMessage',\n\tasync (data) => {\n\t\tif (!settings.get('Livechat_OfflineMessageToChannel_enabled')) {\n\t\t\treturn data;\n\t\t}\n\n\t\tlet channelName = settings.get<string>('Livechat_OfflineMessageToChannel_channel_name');\n\t\tlet departmentName;\n\t\tconst { name, email, department, message: text, host } = data;\n\t\tif (department && department !== '') {\n\t\t\tconst dept = await LivechatDepartment.findOneById<Pick<ILivechatDepartment, '_id' | 'name' | 'offlineMessageChannelName'>>(\n\t\t\t\tdepartment,\n\t\t\t\t{\n\t\t\t\t\tprojection: { name: 1, offlineMessageChannelName: 1 },\n\t\t\t\t},\n\t\t\t);\n\t\t\tdepartmentName = dept?.name;\n\t\t\tif (dept?.offlineMessageChannelName) {\n\t\t\t\tchannelName = dept.offlineMessageChannelName;\n\t\t\t}\n\t\t}\n\n\t\tif (!channelName || channelName === '') {\n\t\t\treturn data;\n\t\t}\n\n\t\tconst room = await Rooms.findOneByName(channelName, { projection: { t: 1, archived: 1 } });\n\t\tif (!room || room.archived || (isOmnichannelRoom(room) && room.closedAt)) {\n\t\t\treturn data;\n\t\t}\n\n\t\tconst user = await Users.findOneById('rocket.cat', { projection: { username: 1 } });\n\t\tif (!user) {\n\t\t\treturn data;\n\t\t}\n\n\t\tconst lng = settings.get<string>('Language') || 'en';\n\n\t\tlet msg = `${i18n.t('New_Livechat_offline_message_has_been_sent', { lng })}: \\n`;\n\t\tif (host && host !== '') {\n\t\t\tmsg = msg.concat(`${i18n.t('Sent_from', { lng })}: ${host} \\n`);\n\t\t}\n\t\tmsg = msg.concat(`${i18n.t('Visitor_Name', { lng })}: ${name} \\n`);\n\t\tmsg = msg.concat(`${i18n.t('Visitor_Email', { lng })}: ${email} \\n`);\n\t\tif (departmentName) {\n\t\t\tmsg = msg.concat(`${i18n.t('Department', { lng })}: ${departmentName} \\n`);\n\t\t}\n\t\tmsg = msg.concat(`${i18n.t('Message', { lng })}: ${text} \\n`);\n\n\t\tconst message = {\n\t\t\trid: room._id,\n\t\t\tmsg,\n\t\t\tgroupable: false,\n\t\t};\n\n\t\tawait sendMessage(user, message, room, true);\n\t},\n\tcallbacks.priority.MEDIUM,\n\t'livechat-send-email-offline-message-to-channel',\n);\n"],"mappings":"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","ignoreList":[]},"sourceType":"module","externalDependencies":{},"hash":"d246ee85c31fbd1a41b25645ce71998bf5b0388c"}
