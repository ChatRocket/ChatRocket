{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/app/autotranslate/client/lib/autotranslate.ts","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","topLevelAwait","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"web.browser.legacy"},"sourceFileName":"app/autotranslate/client/lib/autotranslate.ts","filename":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/app/autotranslate/client/lib/autotranslate.ts","inputSourceMap":{"version":3,"file":"app/autotranslate/client/lib/autotranslate.ts","sourceRoot":"","sources":["app/autotranslate/client/lib/autotranslate.ts"],"names":[],"mappings":"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","sourcesContent":["import type {\n\tIRoom,\n\tISubscription,\n\tISupportedLanguage,\n\tITranslatedMessage,\n\tIUser,\n\tMessageAttachmentDefault,\n} from '@rocket.chat/core-typings';\nimport { isTranslatedMessageAttachment } from '@rocket.chat/core-typings';\nimport mem from 'mem';\nimport { Meteor } from 'meteor/meteor';\nimport { Tracker } from 'meteor/tracker';\n\nimport {\n\thasTranslationLanguageInAttachments,\n\thasTranslationLanguageInMessage,\n} from '../../../../client/views/room/MessageList/lib/autoTranslate';\nimport { hasPermission } from '../../../authorization/client';\nimport { Subscriptions, Messages } from '../../../models/client';\nimport { settings } from '../../../settings/client';\nimport { sdk } from '../../../utils/client/lib/SDKClient';\n\nlet userLanguage = 'en';\nlet username = '';\n\nMeteor.startup(() => {\n\tTracker.autorun(() => {\n\t\tconst user: Pick<IUser, 'language' | 'username'> | null = Meteor.user();\n\t\tif (!user) {\n\t\t\treturn;\n\t\t}\n\t\tuserLanguage = user.language || 'en';\n\t\tusername = user.username || '';\n\t});\n});\n\nexport const AutoTranslate = {\n\tinitialized: false,\n\tprovidersMetadata: {} as { [providerNamer: string]: { name: string; displayName: string } },\n\tmessageIdsToWait: {} as { [messageId: string]: string },\n\tsupportedLanguages: [] as ISupportedLanguage[] | undefined,\n\n\tfindSubscriptionByRid: mem((rid) => Subscriptions.findOne({ rid })),\n\n\tgetLanguage(rid: IRoom['_id']): string {\n\t\tlet subscription: ISubscription | undefined;\n\t\tif (rid) {\n\t\t\tsubscription = this.findSubscriptionByRid(rid);\n\t\t}\n\t\tconst language = (subscription?.autoTranslateLanguage || userLanguage || window.defaultUserLanguage?.()) as string;\n\t\tif (language.indexOf('-') !== -1) {\n\t\t\tif (!(this.supportedLanguages || []).some((supportedLanguage) => supportedLanguage.language === language)) {\n\t\t\t\treturn language.slice(0, 2);\n\t\t\t}\n\t\t}\n\t\treturn language;\n\t},\n\n\ttranslateAttachments(\n\t\tattachments: MessageAttachmentDefault[],\n\t\tlanguage: string,\n\t\tautoTranslateShowInverse: boolean,\n\t): MessageAttachmentDefault[] {\n\t\tif (!isTranslatedMessageAttachment(attachments)) {\n\t\t\treturn attachments;\n\t\t}\n\t\tfor (const attachment of attachments) {\n\t\t\tif (attachment.author_name !== username) {\n\t\t\t\tif (attachment.text && attachment.translations && attachment.translations[language]) {\n\t\t\t\t\tattachment.translations.original = attachment.text;\n\n\t\t\t\t\tif (autoTranslateShowInverse) {\n\t\t\t\t\t\tattachment.text = attachment.translations.original;\n\t\t\t\t\t} else {\n\t\t\t\t\t\tattachment.text = attachment.translations[language];\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tif (attachment.description && attachment.translations && attachment.translations[language]) {\n\t\t\t\t\tattachment.translations.original = attachment.description;\n\n\t\t\t\t\tif (autoTranslateShowInverse) {\n\t\t\t\t\t\tattachment.description = attachment.translations.original;\n\t\t\t\t\t} else {\n\t\t\t\t\t\tattachment.description = attachment.translations[language];\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\t// @ts-expect-error - not sure what to do with this\n\t\t\t\tif (attachment.attachments && attachment.attachments.length > 0) {\n\t\t\t\t\t// @ts-expect-error - not sure what to do with this\n\t\t\t\t\tattachment.attachments = this.translateAttachments(attachment.attachments, language);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\treturn attachments;\n\t},\n\n\tinit(): void {\n\t\tif (this.initialized) {\n\t\t\treturn;\n\t\t}\n\n\t\tTracker.autorun(async (c) => {\n\t\t\tconst uid = Meteor.userId();\n\t\t\tif (!settings.get('AutoTranslate_Enabled') || !uid || !hasPermission('auto-translate')) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tc.stop();\n\n\t\t\ttry {\n\t\t\t\t[this.providersMetadata, this.supportedLanguages] = await Promise.all([\n\t\t\t\t\tsdk.call('autoTranslate.getProviderUiMetadata'),\n\t\t\t\t\tsdk.call('autoTranslate.getSupportedLanguages', 'en'),\n\t\t\t\t]);\n\t\t\t} catch (e: unknown) {\n\t\t\t\t// Avoid unwanted error message on UI when autotranslate is disabled while fetching data\n\t\t\t\tconsole.error((e as Error).message);\n\t\t\t}\n\t\t});\n\n\t\tSubscriptions.find().observeChanges({\n\t\t\tchanged: (_id: string, fields: ISubscription) => {\n\t\t\t\tif (fields.hasOwnProperty('autoTranslate') || fields.hasOwnProperty('autoTranslateLanguage')) {\n\t\t\t\t\tmem.clear(this.findSubscriptionByRid);\n\t\t\t\t}\n\t\t\t},\n\t\t});\n\n\t\tthis.initialized = true;\n\t},\n};\n\nexport const createAutoTranslateMessageStreamHandler = (): ((message: ITranslatedMessage) => void) => {\n\tAutoTranslate.init();\n\n\treturn (message: ITranslatedMessage): void => {\n\t\tif (message.u && message.u._id !== Meteor.userId()) {\n\t\t\tconst subscription = AutoTranslate.findSubscriptionByRid(message.rid);\n\t\t\tconst language = AutoTranslate.getLanguage(message.rid);\n\t\t\tif (\n\t\t\t\tsubscription &&\n\t\t\t\tsubscription.autoTranslate === true &&\n\t\t\t\tmessage.msg &&\n\t\t\t\t(!message.translations ||\n\t\t\t\t\t(!hasTranslationLanguageInMessage(message, language) && !hasTranslationLanguageInAttachments(message.attachments, language)))\n\t\t\t) {\n\t\t\t\t// || (message.attachments && !_.find(message.attachments, attachment => { return attachment.translations && attachment.translations[language]; }))\n\t\t\t\tMessages.update({ _id: message._id }, { $set: { autoTranslateFetching: true } });\n\t\t\t} else if (AutoTranslate.messageIdsToWait[message._id] !== undefined && subscription && subscription.autoTranslate !== true) {\n\t\t\t\tMessages.update({ _id: message._id }, { $set: { autoTranslateShowInverse: true }, $unset: { autoTranslateFetching: true } });\n\t\t\t\tdelete AutoTranslate.messageIdsToWait[message._id];\n\t\t\t} else if (message.autoTranslateFetching === true) {\n\t\t\t\tMessages.update({ _id: message._id }, { $unset: { autoTranslateFetching: true } });\n\t\t\t}\n\t\t}\n\t};\n};\n"]},"targets":{"android":"125.0.0","chrome":"125.0.0","edge":"125.0.0","firefox":"115.0.0","ie":"10.0.0","ios":"17.4.0","opera":"110.0.0","opera_mobile":"80.0.0","safari":"17.4.0","samsung":"24.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor","root":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":true,"enforceStrictMode":false,"dynamicImport":true},"externalDependencies":[]},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"version":"7.17.2","helpers":true,"useESModules":false,"corejs":false},"externalDependencies":[]},{"key":"proposal-class-properties","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true},"externalDependencies":[]},{"key":"base$0$3","visitor":{"FunctionExpression":{"exit":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"base$0$4","visitor":{"ForInStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-react-jsx","visitor":{"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXFragment":{"exit":[null]},"JSXElement":{"exit":[null]},"JSXAttribute":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false},"externalDependencies":[]},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-nullish-coalescing-operator","visitor":{"LogicalExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-optional-chaining","visitor":{"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-optional-catch-binding","visitor":{"CatchClause":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-class-properties","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-async-generator-functions","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-logical-assignment-operators","visitor":{"AssignmentExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-arrow-functions","visitor":{"ArrowFunctionExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-block-scoped-functions","visitor":{"BlockStatement":{"enter":[null]},"SwitchCase":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-block-scoping","visitor":{"VariableDeclaration":{"enter":[null,null]},"BlockStatement":{"enter":[null]},"SwitchCase":{"enter":[null]},"ClassDeclaration":{"enter":[null]},"DoWhileStatement":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForStatement":{"enter":[null]},"WhileStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-classes","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"ClassDeclaration":{"enter":[null]},"ClassExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"loose":true},"externalDependencies":[]},{"key":"transform-computed-properties","visitor":{"ObjectExpression":{"exit":[null]},"_exploded":true,"_verified":true},"options":{"loose":true},"externalDependencies":[]},{"key":"transform-destructuring","visitor":{"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"VariableDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"transform-for-of","visitor":{"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"loose":true},"externalDependencies":[]},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-object-super","visitor":{"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true,"DoWhileStatement":{"exit":[null]},"ForInStatement":{"exit":[null]},"ForStatement":{"exit":[null]},"WhileStatement":{"exit":[null]},"ForOfStatement":{"exit":[null]}},"options":{},"externalDependencies":[]},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"transform-shorthand-properties","visitor":{"ObjectMethod":{"enter":[null]},"ObjectProperty":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-spread","visitor":{"ArrayExpression":{"enter":[null]},"CallExpression":{"enter":[null]},"NewExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-sticky-regex","visitor":{"RegExpLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"loose":true},"externalDependencies":[]},{"key":"transform-typeof-symbol","visitor":{"UnaryExpression":{"enter":[null]},"_exploded":true,"_verified":true,"BlockStatement":{"enter":[null]},"CatchClause":{"enter":[null]},"DoWhileStatement":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForStatement":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"Program":{"enter":[null]},"ObjectMethod":{"enter":[null]},"SwitchStatement":{"enter":[null]},"WhileStatement":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]},"ForOfStatement":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"StaticBlock":{"enter":[null]},"TSModuleBlock":{"enter":[null]},"AssignmentPattern":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectPattern":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"transform-unicode-regex","visitor":{"RegExpLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-property-literals","visitor":{"ObjectProperty":{"exit":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-regenerator","visitor":{"ObjectMethod":{"enter":[null],"exit":[null]},"ClassMethod":{"enter":[null],"exit":[null]},"ClassPrivateMethod":{"enter":[null],"exit":[null]},"FunctionDeclaration":{"exit":[null]},"FunctionExpression":{"exit":[null]},"ArrowFunctionExpression":{"exit":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]}],"presets":[],"generatorOpts":{"filename":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/app/autotranslate/client/lib/autotranslate.ts","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"app/autotranslate/client/lib/autotranslate.ts","inputSourceMap":{"version":3,"file":"app/autotranslate/client/lib/autotranslate.ts","sourceRoot":"","sources":["app/autotranslate/client/lib/autotranslate.ts"],"names":[],"mappings":"AAQA,OAAO,EAAE,6BAA6B,EAAE,MAAM,2BAA2B,CAAC;AAC1E,OAAO,GAAG,MAAM,KAAK,CAAC;AACtB,OAAO,EAAE,MAAM,EAAE,MAAM,eAAe,CAAC;AACvC,OAAO,EAAE,OAAO,EAAE,MAAM,gBAAgB,CAAC;AAEzC,OAAO,EACN,mCAAmC,EACnC,+BAA+B,GAC/B,MAAM,6DAA6D,CAAC;AACrE,OAAO,EAAE,aAAa,EAAE,MAAM,+BAA+B,CAAC;AAC9D,OAAO,EAAE,aAAa,EAAE,QAAQ,EAAE,MAAM,wBAAwB,CAAC;AACjE,OAAO,EAAE,QAAQ,EAAE,MAAM,0BAA0B,CAAC;AACpD,OAAO,EAAE,GAAG,EAAE,MAAM,qCAAqC,CAAC;AAE1D,IAAI,YAAY,GAAG,IAAI,CAAC;AACxB,IAAI,QAAQ,GAAG,EAAE,CAAC;AAElB,MAAM,CAAC,OAAO,CAAC,GAAG,EAAE;IACnB,OAAO,CAAC,OAAO,CAAC,GAAG,EAAE;QACpB,MAAM,IAAI,GAAgD,MAAM,CAAC,IAAI,EAAE,CAAC;QACxE,IAAI,CAAC,IAAI,EAAE,CAAC;YACX,OAAO;QACR,CAAC;QACD,YAAY,GAAG,IAAI,CAAC,QAAQ,IAAI,IAAI,CAAC;QACrC,QAAQ,GAAG,IAAI,CAAC,QAAQ,IAAI,EAAE,CAAC;IAChC,CAAC,CAAC,CAAC;AACJ,CAAC,CAAC,CAAC;AAEH,MAAM,CAAC,MAAM,aAAa,GAAG;IAC5B,WAAW,EAAE,KAAK;IAClB,iBAAiB,EAAE,EAAwE;IAC3F,gBAAgB,EAAE,EAAqC;IACvD,kBAAkB,EAAE,EAAsC;IAE1D,qBAAqB,EAAE,GAAG,CAAC,CAAC,GAAG,EAAE,EAAE,CAAC,aAAa,CAAC,OAAO,CAAC,EAAE,GAAG,EAAE,CAAC,CAAC;IAEnE,WAAW,CAAC,GAAiB;QAC5B,IAAI,YAAuC,CAAC;QAC5C,IAAI,GAAG,EAAE,CAAC;YACT,YAAY,GAAG,IAAI,CAAC,qBAAqB,CAAC,GAAG,CAAC,CAAC;QAChD,CAAC;QACD,MAAM,QAAQ,GAAG,CAAC,YAAY,EAAE,qBAAqB,IAAI,YAAY,IAAI,MAAM,CAAC,mBAAmB,EAAE,EAAE,CAAW,CAAC;QACnH,IAAI,QAAQ,CAAC,OAAO,CAAC,GAAG,CAAC,KAAK,CAAC,CAAC,EAAE,CAAC;YAClC,IAAI,CAAC,CAAC,IAAI,CAAC,kBAAkB,IAAI,EAAE,CAAC,CAAC,IAAI,CAAC,CAAC,iBAAiB,EAAE,EAAE,CAAC,iBAAiB,CAAC,QAAQ,KAAK,QAAQ,CAAC,EAAE,CAAC;gBAC3G,OAAO,QAAQ,CAAC,KAAK,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC;YAC7B,CAAC;QACF,CAAC;QACD,OAAO,QAAQ,CAAC;IACjB,CAAC;IAED,oBAAoB,CACnB,WAAuC,EACvC,QAAgB,EAChB,wBAAiC;QAEjC,IAAI,CAAC,6BAA6B,CAAC,WAAW,CAAC,EAAE,CAAC;YACjD,OAAO,WAAW,CAAC;QACpB,CAAC;QACD,KAAK,MAAM,UAAU,IAAI,WAAW,EAAE,CAAC;YACtC,IAAI,UAAU,CAAC,WAAW,KAAK,QAAQ,EAAE,CAAC;gBACzC,IAAI,UAAU,CAAC,IAAI,IAAI,UAAU,CAAC,YAAY,IAAI,UAAU,CAAC,YAAY,CAAC,QAAQ,CAAC,EAAE,CAAC;oBACrF,UAAU,CAAC,YAAY,CAAC,QAAQ,GAAG,UAAU,CAAC,IAAI,CAAC;oBAEnD,IAAI,wBAAwB,EAAE,CAAC;wBAC9B,UAAU,CAAC,IAAI,GAAG,UAAU,CAAC,YAAY,CAAC,QAAQ,CAAC;oBACpD,CAAC;yBAAM,CAAC;wBACP,UAAU,CAAC,IAAI,GAAG,UAAU,CAAC,YAAY,CAAC,QAAQ,CAAC,CAAC;oBACrD,CAAC;gBACF,CAAC;gBAED,IAAI,UAAU,CAAC,WAAW,IAAI,UAAU,CAAC,YAAY,IAAI,UAAU,CAAC,YAAY,CAAC,QAAQ,CAAC,EAAE,CAAC;oBAC5F,UAAU,CAAC,YAAY,CAAC,QAAQ,GAAG,UAAU,CAAC,WAAW,CAAC;oBAE1D,IAAI,wBAAwB,EAAE,CAAC;wBAC9B,UAAU,CAAC,WAAW,GAAG,UAAU,CAAC,YAAY,CAAC,QAAQ,CAAC;oBAC3D,CAAC;yBAAM,CAAC;wBACP,UAAU,CAAC,WAAW,GAAG,UAAU,CAAC,YAAY,CAAC,QAAQ,CAAC,CAAC;oBAC5D,CAAC;gBACF,CAAC;gBAED,mDAAmD;gBACnD,IAAI,UAAU,CAAC,WAAW,IAAI,UAAU,CAAC,WAAW,CAAC,MAAM,GAAG,CAAC,EAAE,CAAC;oBACjE,mDAAmD;oBACnD,UAAU,CAAC,WAAW,GAAG,IAAI,CAAC,oBAAoB,CAAC,UAAU,CAAC,WAAW,EAAE,QAAQ,CAAC,CAAC;gBACtF,CAAC;YACF,CAAC;QACF,CAAC;QACD,OAAO,WAAW,CAAC;IACpB,CAAC;IAED,IAAI;QACH,IAAI,IAAI,CAAC,WAAW,EAAE,CAAC;YACtB,OAAO;QACR,CAAC;QAED,OAAO,CAAC,OAAO,CAAC,KAAK,EAAE,CAAC,EAAE,EAAE;YAC3B,MAAM,GAAG,GAAG,MAAM,CAAC,MAAM,EAAE,CAAC;YAC5B,IAAI,CAAC,QAAQ,CAAC,GAAG,CAAC,uBAAuB,CAAC,IAAI,CAAC,GAAG,IAAI,CAAC,aAAa,CAAC,gBAAgB,CAAC,EAAE,CAAC;gBACxF,OAAO;YACR,CAAC;YAED,CAAC,CAAC,IAAI,EAAE,CAAC;YAET,IAAI,CAAC;gBACJ,CAAC,IAAI,CAAC,iBAAiB,EAAE,IAAI,CAAC,kBAAkB,CAAC,GAAG,MAAM,OAAO,CAAC,GAAG,CAAC;oBACrE,GAAG,CAAC,IAAI,CAAC,qCAAqC,CAAC;oBAC/C,GAAG,CAAC,IAAI,CAAC,qCAAqC,EAAE,IAAI,CAAC;iBACrD,CAAC,CAAC;YACJ,CAAC;YAAC,OAAO,CAAU,EAAE,CAAC;gBACrB,wFAAwF;gBACxF,OAAO,CAAC,KAAK,CAAE,CAAW,CAAC,OAAO,CAAC,CAAC;YACrC,CAAC;QACF,CAAC,CAAC,CAAC;QAEH,aAAa,CAAC,IAAI,EAAE,CAAC,cAAc,CAAC;YACnC,OAAO,EAAE,CAAC,GAAW,EAAE,MAAqB,EAAE,EAAE;gBAC/C,IAAI,MAAM,CAAC,cAAc,CAAC,eAAe,CAAC,IAAI,MAAM,CAAC,cAAc,CAAC,uBAAuB,CAAC,EAAE,CAAC;oBAC9F,GAAG,CAAC,KAAK,CAAC,IAAI,CAAC,qBAAqB,CAAC,CAAC;gBACvC,CAAC;YACF,CAAC;SACD,CAAC,CAAC;QAEH,IAAI,CAAC,WAAW,GAAG,IAAI,CAAC;IACzB,CAAC;CACD,CAAC;AAEF,MAAM,CAAC,MAAM,uCAAuC,GAAG,GAA4C,EAAE;IACpG,aAAa,CAAC,IAAI,EAAE,CAAC;IAErB,OAAO,CAAC,OAA2B,EAAQ,EAAE;QAC5C,IAAI,OAAO,CAAC,CAAC,IAAI,OAAO,CAAC,CAAC,CAAC,GAAG,KAAK,MAAM,CAAC,MAAM,EAAE,EAAE,CAAC;YACpD,MAAM,YAAY,GAAG,aAAa,CAAC,qBAAqB,CAAC,OAAO,CAAC,GAAG,CAAC,CAAC;YACtE,MAAM,QAAQ,GAAG,aAAa,CAAC,WAAW,CAAC,OAAO,CAAC,GAAG,CAAC,CAAC;YACxD,IACC,YAAY;gBACZ,YAAY,CAAC,aAAa,KAAK,IAAI;gBACnC,OAAO,CAAC,GAAG;gBACX,CAAC,CAAC,OAAO,CAAC,YAAY;oBACrB,CAAC,CAAC,+BAA+B,CAAC,OAAO,EAAE,QAAQ,CAAC,IAAI,CAAC,mCAAmC,CAAC,OAAO,CAAC,WAAW,EAAE,QAAQ,CAAC,CAAC,CAAC,EAC7H,CAAC;gBACF,mJAAmJ;gBACnJ,QAAQ,CAAC,MAAM,CAAC,EAAE,GAAG,EAAE,OAAO,CAAC,GAAG,EAAE,EAAE,EAAE,IAAI,EAAE,EAAE,qBAAqB,EAAE,IAAI,EAAE,EAAE,CAAC,CAAC;YAClF,CAAC;iBAAM,IAAI,aAAa,CAAC,gBAAgB,CAAC,OAAO,CAAC,GAAG,CAAC,KAAK,SAAS,IAAI,YAAY,IAAI,YAAY,CAAC,aAAa,KAAK,IAAI,EAAE,CAAC;gBAC7H,QAAQ,CAAC,MAAM,CAAC,EAAE,GAAG,EAAE,OAAO,CAAC,GAAG,EAAE,EAAE,EAAE,IAAI,EAAE,EAAE,wBAAwB,EAAE,IAAI,EAAE,EAAE,MAAM,EAAE,EAAE,qBAAqB,EAAE,IAAI,EAAE,EAAE,CAAC,CAAC;gBAC7H,OAAO,aAAa,CAAC,gBAAgB,CAAC,OAAO,CAAC,GAAG,CAAC,CAAC;YACpD,CAAC;iBAAM,IAAI,OAAO,CAAC,qBAAqB,KAAK,IAAI,EAAE,CAAC;gBACnD,QAAQ,CAAC,MAAM,CAAC,EAAE,GAAG,EAAE,OAAO,CAAC,GAAG,EAAE,EAAE,EAAE,MAAM,EAAE,EAAE,qBAAqB,EAAE,IAAI,EAAE,EAAE,CAAC,CAAC;YACpF,CAAC;QACF,CAAC;IACF,CAAC,CAAC;AACH,CAAC,CAAC","sourcesContent":["import type {\n\tIRoom,\n\tISubscription,\n\tISupportedLanguage,\n\tITranslatedMessage,\n\tIUser,\n\tMessageAttachmentDefault,\n} from '@rocket.chat/core-typings';\nimport { isTranslatedMessageAttachment } from '@rocket.chat/core-typings';\nimport mem from 'mem';\nimport { Meteor } from 'meteor/meteor';\nimport { Tracker } from 'meteor/tracker';\n\nimport {\n\thasTranslationLanguageInAttachments,\n\thasTranslationLanguageInMessage,\n} from '../../../../client/views/room/MessageList/lib/autoTranslate';\nimport { hasPermission } from '../../../authorization/client';\nimport { Subscriptions, Messages } from '../../../models/client';\nimport { settings } from '../../../settings/client';\nimport { sdk } from '../../../utils/client/lib/SDKClient';\n\nlet userLanguage = 'en';\nlet username = '';\n\nMeteor.startup(() => {\n\tTracker.autorun(() => {\n\t\tconst user: Pick<IUser, 'language' | 'username'> | null = Meteor.user();\n\t\tif (!user) {\n\t\t\treturn;\n\t\t}\n\t\tuserLanguage = user.language || 'en';\n\t\tusername = user.username || '';\n\t});\n});\n\nexport const AutoTranslate = {\n\tinitialized: false,\n\tprovidersMetadata: {} as { [providerNamer: string]: { name: string; displayName: string } },\n\tmessageIdsToWait: {} as { [messageId: string]: string },\n\tsupportedLanguages: [] as ISupportedLanguage[] | undefined,\n\n\tfindSubscriptionByRid: mem((rid) => Subscriptions.findOne({ rid })),\n\n\tgetLanguage(rid: IRoom['_id']): string {\n\t\tlet subscription: ISubscription | undefined;\n\t\tif (rid) {\n\t\t\tsubscription = this.findSubscriptionByRid(rid);\n\t\t}\n\t\tconst language = (subscription?.autoTranslateLanguage || userLanguage || window.defaultUserLanguage?.()) as string;\n\t\tif (language.indexOf('-') !== -1) {\n\t\t\tif (!(this.supportedLanguages || []).some((supportedLanguage) => supportedLanguage.language === language)) {\n\t\t\t\treturn language.slice(0, 2);\n\t\t\t}\n\t\t}\n\t\treturn language;\n\t},\n\n\ttranslateAttachments(\n\t\tattachments: MessageAttachmentDefault[],\n\t\tlanguage: string,\n\t\tautoTranslateShowInverse: boolean,\n\t): MessageAttachmentDefault[] {\n\t\tif (!isTranslatedMessageAttachment(attachments)) {\n\t\t\treturn attachments;\n\t\t}\n\t\tfor (const attachment of attachments) {\n\t\t\tif (attachment.author_name !== username) {\n\t\t\t\tif (attachment.text && attachment.translations && attachment.translations[language]) {\n\t\t\t\t\tattachment.translations.original = attachment.text;\n\n\t\t\t\t\tif (autoTranslateShowInverse) {\n\t\t\t\t\t\tattachment.text = attachment.translations.original;\n\t\t\t\t\t} else {\n\t\t\t\t\t\tattachment.text = attachment.translations[language];\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tif (attachment.description && attachment.translations && attachment.translations[language]) {\n\t\t\t\t\tattachment.translations.original = attachment.description;\n\n\t\t\t\t\tif (autoTranslateShowInverse) {\n\t\t\t\t\t\tattachment.description = attachment.translations.original;\n\t\t\t\t\t} else {\n\t\t\t\t\t\tattachment.description = attachment.translations[language];\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\t// @ts-expect-error - not sure what to do with this\n\t\t\t\tif (attachment.attachments && attachment.attachments.length > 0) {\n\t\t\t\t\t// @ts-expect-error - not sure what to do with this\n\t\t\t\t\tattachment.attachments = this.translateAttachments(attachment.attachments, language);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\treturn attachments;\n\t},\n\n\tinit(): void {\n\t\tif (this.initialized) {\n\t\t\treturn;\n\t\t}\n\n\t\tTracker.autorun(async (c) => {\n\t\t\tconst uid = Meteor.userId();\n\t\t\tif (!settings.get('AutoTranslate_Enabled') || !uid || !hasPermission('auto-translate')) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tc.stop();\n\n\t\t\ttry {\n\t\t\t\t[this.providersMetadata, this.supportedLanguages] = await Promise.all([\n\t\t\t\t\tsdk.call('autoTranslate.getProviderUiMetadata'),\n\t\t\t\t\tsdk.call('autoTranslate.getSupportedLanguages', 'en'),\n\t\t\t\t]);\n\t\t\t} catch (e: unknown) {\n\t\t\t\t// Avoid unwanted error message on UI when autotranslate is disabled while fetching data\n\t\t\t\tconsole.error((e as Error).message);\n\t\t\t}\n\t\t});\n\n\t\tSubscriptions.find().observeChanges({\n\t\t\tchanged: (_id: string, fields: ISubscription) => {\n\t\t\t\tif (fields.hasOwnProperty('autoTranslate') || fields.hasOwnProperty('autoTranslateLanguage')) {\n\t\t\t\t\tmem.clear(this.findSubscriptionByRid);\n\t\t\t\t}\n\t\t\t},\n\t\t});\n\n\t\tthis.initialized = true;\n\t},\n};\n\nexport const createAutoTranslateMessageStreamHandler = (): ((message: ITranslatedMessage) => void) => {\n\tAutoTranslate.init();\n\n\treturn (message: ITranslatedMessage): void => {\n\t\tif (message.u && message.u._id !== Meteor.userId()) {\n\t\t\tconst subscription = AutoTranslate.findSubscriptionByRid(message.rid);\n\t\t\tconst language = AutoTranslate.getLanguage(message.rid);\n\t\t\tif (\n\t\t\t\tsubscription &&\n\t\t\t\tsubscription.autoTranslate === true &&\n\t\t\t\tmessage.msg &&\n\t\t\t\t(!message.translations ||\n\t\t\t\t\t(!hasTranslationLanguageInMessage(message, language) && !hasTranslationLanguageInAttachments(message.attachments, language)))\n\t\t\t) {\n\t\t\t\t// || (message.attachments && !_.find(message.attachments, attachment => { return attachment.translations && attachment.translations[language]; }))\n\t\t\t\tMessages.update({ _id: message._id }, { $set: { autoTranslateFetching: true } });\n\t\t\t} else if (AutoTranslate.messageIdsToWait[message._id] !== undefined && subscription && subscription.autoTranslate !== true) {\n\t\t\t\tMessages.update({ _id: message._id }, { $set: { autoTranslateShowInverse: true }, $unset: { autoTranslateFetching: true } });\n\t\t\t\tdelete AutoTranslate.messageIdsToWait[message._id];\n\t\t\t} else if (message.autoTranslateFetching === true) {\n\t\t\t\tMessages.update({ _id: message._id }, { $unset: { autoTranslateFetching: true } });\n\t\t\t}\n\t\t}\n\t};\n};\n"]}}},"code":"var _regeneratorRuntime;\nmodule.link(\"@babel/runtime/regenerator\", {\n  default: function (v) {\n    _regeneratorRuntime = v;\n  }\n}, 0);\nvar _slicedToArray;\nmodule.link(\"@babel/runtime/helpers/slicedToArray\", {\n  default: function (v) {\n    _slicedToArray = v;\n  }\n}, 1);\nvar _createForOfIteratorHelperLoose;\nmodule.link(\"@babel/runtime/helpers/createForOfIteratorHelperLoose\", {\n  default: function (v) {\n    _createForOfIteratorHelperLoose = v;\n  }\n}, 2);\nmodule.export({\n  AutoTranslate: function () {\n    return AutoTranslate;\n  },\n  createAutoTranslateMessageStreamHandler: function () {\n    return createAutoTranslateMessageStreamHandler;\n  }\n});\nvar isTranslatedMessageAttachment;\nmodule.link(\"@rocket.chat/core-typings\", {\n  isTranslatedMessageAttachment: function (v) {\n    isTranslatedMessageAttachment = v;\n  }\n}, 0);\nvar mem;\nmodule.link(\"mem\", {\n  \"default\": function (v) {\n    mem = v;\n  }\n}, 1);\nvar Meteor;\nmodule.link(\"meteor/meteor\", {\n  Meteor: function (v) {\n    Meteor = v;\n  }\n}, 2);\nvar Tracker;\nmodule.link(\"meteor/tracker\", {\n  Tracker: function (v) {\n    Tracker = v;\n  }\n}, 3);\nvar hasTranslationLanguageInAttachments, hasTranslationLanguageInMessage;\nmodule.link(\"../../../../client/views/room/MessageList/lib/autoTranslate\", {\n  hasTranslationLanguageInAttachments: function (v) {\n    hasTranslationLanguageInAttachments = v;\n  },\n  hasTranslationLanguageInMessage: function (v) {\n    hasTranslationLanguageInMessage = v;\n  }\n}, 4);\nvar hasPermission;\nmodule.link(\"../../../authorization/client\", {\n  hasPermission: function (v) {\n    hasPermission = v;\n  }\n}, 5);\nvar Subscriptions, Messages;\nmodule.link(\"../../../models/client\", {\n  Subscriptions: function (v) {\n    Subscriptions = v;\n  },\n  Messages: function (v) {\n    Messages = v;\n  }\n}, 6);\nvar settings;\nmodule.link(\"../../../settings/client\", {\n  settings: function (v) {\n    settings = v;\n  }\n}, 7);\nvar sdk;\nmodule.link(\"../../../utils/client/lib/SDKClient\", {\n  sdk: function (v) {\n    sdk = v;\n  }\n}, 8);\nvar userLanguage = 'en';\nvar username = '';\nMeteor.startup(function () {\n  Tracker.autorun(function () {\n    var user = Meteor.user();\n    if (!user) {\n      return;\n    }\n    userLanguage = user.language || 'en';\n    username = user.username || '';\n  });\n});\nvar AutoTranslate = {\n  initialized: false,\n  providersMetadata: {},\n  messageIdsToWait: {},\n  supportedLanguages: [],\n  findSubscriptionByRid: mem(function (rid) {\n    return Subscriptions.findOne({\n      rid: rid\n    });\n  }),\n  getLanguage: function (rid) {\n    var _subscription, _window$defaultUserLa, _window;\n    var subscription;\n    if (rid) {\n      subscription = this.findSubscriptionByRid(rid);\n    }\n    var language = ((_subscription = subscription) === null || _subscription === void 0 ? void 0 : _subscription.autoTranslateLanguage) || userLanguage || ((_window$defaultUserLa = (_window = window).defaultUserLanguage) === null || _window$defaultUserLa === void 0 ? void 0 : _window$defaultUserLa.call(_window));\n    if (language.indexOf('-') !== -1) {\n      if (!(this.supportedLanguages || []).some(function (supportedLanguage) {\n        return supportedLanguage.language === language;\n      })) {\n        return language.slice(0, 2);\n      }\n    }\n    return language;\n  },\n  translateAttachments: function (attachments, language, autoTranslateShowInverse) {\n    if (!isTranslatedMessageAttachment(attachments)) {\n      return attachments;\n    }\n    for (var _iterator = _createForOfIteratorHelperLoose(attachments), _step; !(_step = _iterator()).done;) {\n      var attachment = _step.value;\n      if (attachment.author_name !== username) {\n        if (attachment.text && attachment.translations && attachment.translations[language]) {\n          attachment.translations.original = attachment.text;\n          if (autoTranslateShowInverse) {\n            attachment.text = attachment.translations.original;\n          } else {\n            attachment.text = attachment.translations[language];\n          }\n        }\n        if (attachment.description && attachment.translations && attachment.translations[language]) {\n          attachment.translations.original = attachment.description;\n          if (autoTranslateShowInverse) {\n            attachment.description = attachment.translations.original;\n          } else {\n            attachment.description = attachment.translations[language];\n          }\n        }\n        // @ts-expect-error - not sure what to do with this\n        if (attachment.attachments && attachment.attachments.length > 0) {\n          // @ts-expect-error - not sure what to do with this\n          attachment.attachments = this.translateAttachments(attachment.attachments, language);\n        }\n      }\n    }\n    return attachments;\n  },\n  init: function () {\n    var _this = this;\n    if (this.initialized) {\n      return;\n    }\n    Tracker.autorun(function () {\n      function _callee(c) {\n        var uid, _await$Promise$all, _await$Promise$all2;\n        return _regeneratorRuntime.async(function () {\n          function _callee$(_context) {\n            while (1) switch (_context.prev = _context.next) {\n              case 0:\n                uid = Meteor.userId();\n                if (!(!settings.get('AutoTranslate_Enabled') || !uid || !hasPermission('auto-translate'))) {\n                  _context.next = 3;\n                  break;\n                }\n                return _context.abrupt(\"return\");\n              case 3:\n                c.stop();\n                _context.prev = 4;\n                _context.next = 7;\n                return _regeneratorRuntime.awrap(Promise.all([sdk.call('autoTranslate.getProviderUiMetadata'), sdk.call('autoTranslate.getSupportedLanguages', 'en')]));\n              case 7:\n                _await$Promise$all = _context.sent;\n                _await$Promise$all2 = _slicedToArray(_await$Promise$all, 2);\n                _this.providersMetadata = _await$Promise$all2[0];\n                _this.supportedLanguages = _await$Promise$all2[1];\n                _context.next = 16;\n                break;\n              case 13:\n                _context.prev = 13;\n                _context.t0 = _context[\"catch\"](4);\n                // Avoid unwanted error message on UI when autotranslate is disabled while fetching data\n                console.error(_context.t0.message);\n              case 16:\n              case \"end\":\n                return _context.stop();\n            }\n          }\n          return _callee$;\n        }(), null, null, [[4, 13]], Promise);\n      }\n      return _callee;\n    }());\n    Subscriptions.find().observeChanges({\n      changed: function (_id, fields) {\n        if (fields.hasOwnProperty('autoTranslate') || fields.hasOwnProperty('autoTranslateLanguage')) {\n          mem.clear(_this.findSubscriptionByRid);\n        }\n      }\n    });\n    this.initialized = true;\n  }\n};\nvar createAutoTranslateMessageStreamHandler = function () {\n  AutoTranslate.init();\n  return function (message) {\n    if (message.u && message.u._id !== Meteor.userId()) {\n      var subscription = AutoTranslate.findSubscriptionByRid(message.rid);\n      var language = AutoTranslate.getLanguage(message.rid);\n      if (subscription && subscription.autoTranslate === true && message.msg && (!message.translations || !hasTranslationLanguageInMessage(message, language) && !hasTranslationLanguageInAttachments(message.attachments, language))) {\n        // || (message.attachments && !_.find(message.attachments, attachment => { return attachment.translations && attachment.translations[language]; }))\n        Messages.update({\n          _id: message._id\n        }, {\n          $set: {\n            autoTranslateFetching: true\n          }\n        });\n      } else if (AutoTranslate.messageIdsToWait[message._id] !== undefined && subscription && subscription.autoTranslate !== true) {\n        Messages.update({\n          _id: message._id\n        }, {\n          $set: {\n            autoTranslateShowInverse: true\n          },\n          $unset: {\n            autoTranslateFetching: true\n          }\n        });\n        delete AutoTranslate.messageIdsToWait[message._id];\n      } else if (message.autoTranslateFetching === true) {\n        Messages.update({\n          _id: message._id\n        }, {\n          $unset: {\n            autoTranslateFetching: true\n          }\n        });\n      }\n    }\n  };\n};","map":{"version":3,"names":["_regeneratorRuntime","module","link","default","v","_slicedToArray","_createForOfIteratorHelperLoose","export","AutoTranslate","createAutoTranslateMessageStreamHandler","isTranslatedMessageAttachment","mem","Meteor","Tracker","hasTranslationLanguageInAttachments","hasTranslationLanguageInMessage","hasPermission","Subscriptions","Messages","settings","sdk","userLanguage","username","startup","autorun","user","language","initialized","providersMetadata","messageIdsToWait","supportedLanguages","findSubscriptionByRid","rid","findOne","getLanguage","_subscription","_window$defaultUserLa","_window","subscription","autoTranslateLanguage","window","defaultUserLanguage","call","indexOf","some","supportedLanguage","slice","translateAttachments","attachments","autoTranslateShowInverse","_iterator","_step","done","attachment","value","author_name","text","translations","original","description","length","init","_this","_callee","c","uid","_await$Promise$all","_await$Promise$all2","async","_callee$","_context","prev","next","userId","get","abrupt","stop","awrap","Promise","all","sent","t0","console","error","message","find","observeChanges","changed","_id","fields","hasOwnProperty","clear","u","autoTranslate","msg","update","$set","autoTranslateFetching","undefined","$unset"],"sources":["app/autotranslate/client/lib/autotranslate.ts"],"sourcesContent":["import type {\n\tIRoom,\n\tISubscription,\n\tISupportedLanguage,\n\tITranslatedMessage,\n\tIUser,\n\tMessageAttachmentDefault,\n} from '@rocket.chat/core-typings';\nimport { isTranslatedMessageAttachment } from '@rocket.chat/core-typings';\nimport mem from 'mem';\nimport { Meteor } from 'meteor/meteor';\nimport { Tracker } from 'meteor/tracker';\n\nimport {\n\thasTranslationLanguageInAttachments,\n\thasTranslationLanguageInMessage,\n} from '../../../../client/views/room/MessageList/lib/autoTranslate';\nimport { hasPermission } from '../../../authorization/client';\nimport { Subscriptions, Messages } from '../../../models/client';\nimport { settings } from '../../../settings/client';\nimport { sdk } from '../../../utils/client/lib/SDKClient';\n\nlet userLanguage = 'en';\nlet username = '';\n\nMeteor.startup(() => {\n\tTracker.autorun(() => {\n\t\tconst user: Pick<IUser, 'language' | 'username'> | null = Meteor.user();\n\t\tif (!user) {\n\t\t\treturn;\n\t\t}\n\t\tuserLanguage = user.language || 'en';\n\t\tusername = user.username || '';\n\t});\n});\n\nexport const AutoTranslate = {\n\tinitialized: false,\n\tprovidersMetadata: {} as { [providerNamer: string]: { name: string; displayName: string } },\n\tmessageIdsToWait: {} as { [messageId: string]: string },\n\tsupportedLanguages: [] as ISupportedLanguage[] | undefined,\n\n\tfindSubscriptionByRid: mem((rid) => Subscriptions.findOne({ rid })),\n\n\tgetLanguage(rid: IRoom['_id']): string {\n\t\tlet subscription: ISubscription | undefined;\n\t\tif (rid) {\n\t\t\tsubscription = this.findSubscriptionByRid(rid);\n\t\t}\n\t\tconst language = (subscription?.autoTranslateLanguage || userLanguage || window.defaultUserLanguage?.()) as string;\n\t\tif (language.indexOf('-') !== -1) {\n\t\t\tif (!(this.supportedLanguages || []).some((supportedLanguage) => supportedLanguage.language === language)) {\n\t\t\t\treturn language.slice(0, 2);\n\t\t\t}\n\t\t}\n\t\treturn language;\n\t},\n\n\ttranslateAttachments(\n\t\tattachments: MessageAttachmentDefault[],\n\t\tlanguage: string,\n\t\tautoTranslateShowInverse: boolean,\n\t): MessageAttachmentDefault[] {\n\t\tif (!isTranslatedMessageAttachment(attachments)) {\n\t\t\treturn attachments;\n\t\t}\n\t\tfor (const attachment of attachments) {\n\t\t\tif (attachment.author_name !== username) {\n\t\t\t\tif (attachment.text && attachment.translations && attachment.translations[language]) {\n\t\t\t\t\tattachment.translations.original = attachment.text;\n\n\t\t\t\t\tif (autoTranslateShowInverse) {\n\t\t\t\t\t\tattachment.text = attachment.translations.original;\n\t\t\t\t\t} else {\n\t\t\t\t\t\tattachment.text = attachment.translations[language];\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tif (attachment.description && attachment.translations && attachment.translations[language]) {\n\t\t\t\t\tattachment.translations.original = attachment.description;\n\n\t\t\t\t\tif (autoTranslateShowInverse) {\n\t\t\t\t\t\tattachment.description = attachment.translations.original;\n\t\t\t\t\t} else {\n\t\t\t\t\t\tattachment.description = attachment.translations[language];\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\t// @ts-expect-error - not sure what to do with this\n\t\t\t\tif (attachment.attachments && attachment.attachments.length > 0) {\n\t\t\t\t\t// @ts-expect-error - not sure what to do with this\n\t\t\t\t\tattachment.attachments = this.translateAttachments(attachment.attachments, language);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\treturn attachments;\n\t},\n\n\tinit(): void {\n\t\tif (this.initialized) {\n\t\t\treturn;\n\t\t}\n\n\t\tTracker.autorun(async (c) => {\n\t\t\tconst uid = Meteor.userId();\n\t\t\tif (!settings.get('AutoTranslate_Enabled') || !uid || !hasPermission('auto-translate')) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tc.stop();\n\n\t\t\ttry {\n\t\t\t\t[this.providersMetadata, this.supportedLanguages] = await Promise.all([\n\t\t\t\t\tsdk.call('autoTranslate.getProviderUiMetadata'),\n\t\t\t\t\tsdk.call('autoTranslate.getSupportedLanguages', 'en'),\n\t\t\t\t]);\n\t\t\t} catch (e: unknown) {\n\t\t\t\t// Avoid unwanted error message on UI when autotranslate is disabled while fetching data\n\t\t\t\tconsole.error((e as Error).message);\n\t\t\t}\n\t\t});\n\n\t\tSubscriptions.find().observeChanges({\n\t\t\tchanged: (_id: string, fields: ISubscription) => {\n\t\t\t\tif (fields.hasOwnProperty('autoTranslate') || fields.hasOwnProperty('autoTranslateLanguage')) {\n\t\t\t\t\tmem.clear(this.findSubscriptionByRid);\n\t\t\t\t}\n\t\t\t},\n\t\t});\n\n\t\tthis.initialized = true;\n\t},\n};\n\nexport const createAutoTranslateMessageStreamHandler = (): ((message: ITranslatedMessage) => void) => {\n\tAutoTranslate.init();\n\n\treturn (message: ITranslatedMessage): void => {\n\t\tif (message.u && message.u._id !== Meteor.userId()) {\n\t\t\tconst subscription = AutoTranslate.findSubscriptionByRid(message.rid);\n\t\t\tconst language = AutoTranslate.getLanguage(message.rid);\n\t\t\tif (\n\t\t\t\tsubscription &&\n\t\t\t\tsubscription.autoTranslate === true &&\n\t\t\t\tmessage.msg &&\n\t\t\t\t(!message.translations ||\n\t\t\t\t\t(!hasTranslationLanguageInMessage(message, language) && !hasTranslationLanguageInAttachments(message.attachments, language)))\n\t\t\t) {\n\t\t\t\t// || (message.attachments && !_.find(message.attachments, attachment => { return attachment.translations && attachment.translations[language]; }))\n\t\t\t\tMessages.update({ _id: message._id }, { $set: { autoTranslateFetching: true } });\n\t\t\t} else if (AutoTranslate.messageIdsToWait[message._id] !== undefined && subscription && subscription.autoTranslate !== true) {\n\t\t\t\tMessages.update({ _id: message._id }, { $set: { autoTranslateShowInverse: true }, $unset: { autoTranslateFetching: true } });\n\t\t\t\tdelete AutoTranslate.messageIdsToWait[message._id];\n\t\t\t} else if (message.autoTranslateFetching === true) {\n\t\t\t\tMessages.update({ _id: message._id }, { $unset: { autoTranslateFetching: true } });\n\t\t\t}\n\t\t}\n\t};\n};\n"],"mappings":"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","ignoreList":[]},"sourceType":"module","externalDependencies":{},"hash":"7d22d8114b03cd8c1ca9178be7209cc43f667a2c"}
