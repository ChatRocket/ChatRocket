{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/server/lib/parseMessageSearchQuery.ts","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","topLevelAwait","objectRestSpread","objectRestSpread","asyncGenerators","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"os.osx.arm64"},"sourceFileName":"server/lib/parseMessageSearchQuery.ts","filename":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/server/lib/parseMessageSearchQuery.ts","inputSourceMap":{"version":3,"file":"server/lib/parseMessageSearchQuery.ts","sourceRoot":"","sources":["server/lib/parseMessageSearchQuery.ts"],"names":[],"mappings":"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","sourcesContent":["import type { IMessage, IUser } from '@rocket.chat/core-typings';\nimport { escapeRegExp } from '@rocket.chat/string-helpers';\nimport type { Filter, FindOptions } from 'mongodb';\n\nclass MessageSearchQueryParser {\n\tprivate query: Exclude<Filter<IMessage>, Partial<IMessage>> = {};\n\n\tprivate options: FindOptions<IMessage> = {\n\t\tprojection: {},\n\t\tsort: {\n\t\t\tts: -1,\n\t\t},\n\t\tskip: 0,\n\t\tlimit: 20,\n\t};\n\n\tprivate user: IUser | undefined;\n\n\tprivate forceRegex = false;\n\n\tconstructor({\n\t\tuser,\n\t\toffset = 0,\n\t\tlimit = 20,\n\t\tforceRegex = false,\n\t}: {\n\t\tuser?: IUser;\n\t\toffset?: number;\n\t\tlimit?: number;\n\t\tforceRegex?: boolean;\n\t}) {\n\t\tthis.user = user;\n\t\tthis.options.skip = offset;\n\t\tthis.options.limit = limit;\n\t\tthis.forceRegex = forceRegex;\n\t}\n\n\tprivate consumeFrom(text: string) {\n\t\tconst from: string[] = [];\n\n\t\treturn text.replace(/from:([a-z0-9.\\-_]+)/gi, (_, username) => {\n\t\t\tif (username === 'me' && this.user?.username && !from.includes(this.user.username)) {\n\t\t\t\tusername = this.user.username;\n\t\t\t}\n\t\t\tfrom.push(username);\n\n\t\t\tthis.query['u.username'] = {\n\t\t\t\t$regex: from.join('|'),\n\t\t\t\t$options: 'i',\n\t\t\t};\n\n\t\t\treturn '';\n\t\t});\n\t}\n\n\tprivate consumeMention(text: string) {\n\t\tconst mentions: string[] = [];\n\n\t\treturn text.replace(/mention:([a-z0-9.\\-_]+)/gi, (_: string, username: string) => {\n\t\t\tmentions.push(username);\n\n\t\t\tthis.query['mentions.username'] = {\n\t\t\t\t$regex: mentions.join('|'),\n\t\t\t\t$options: 'i',\n\t\t\t};\n\n\t\t\treturn '';\n\t\t});\n\t}\n\n\t/**\n\t * Filter on messages that are starred by the current user.\n\t */\n\tprivate consumeHasStar(text: string) {\n\t\treturn text.replace(/has:star/g, () => {\n\t\t\tif (this.user?._id) {\n\t\t\t\tthis.query['starred._id'] = this.user._id;\n\t\t\t}\n\t\t\treturn '';\n\t\t});\n\t}\n\n\t/**\n\t * Filter on messages that have an url.\n\t */\n\tprivate consumeHasUrl(text: string) {\n\t\treturn text.replace(/has:url|has:link/g, () => {\n\t\t\tthis.query['urls.0'] = {\n\t\t\t\t$exists: true,\n\t\t\t};\n\t\t\treturn '';\n\t\t});\n\t}\n\n\t/**\n\t * Filter on pinned messages.\n\t */\n\tprivate consumeIsPinned(text: string) {\n\t\treturn text.replace(/is:pinned|has:pin/g, () => {\n\t\t\tthis.query.pinned = true;\n\t\t\treturn '';\n\t\t});\n\t}\n\n\t/**\n\t * Filter on messages which have a location attached.\n\t */\n\tprivate consumeHasLocation(text: string) {\n\t\treturn text.replace(/has:location|has:map/g, () => {\n\t\t\tthis.query.location = {\n\t\t\t\t$exists: true,\n\t\t\t};\n\t\t\treturn '';\n\t\t});\n\t}\n\n\t/**\n\t * Filter image tags\n\t */\n\tprivate consumeLabel(text: string) {\n\t\treturn text.replace(/label:(\\w+)/g, (_: string, tag: string) => {\n\t\t\tthis.query['attachments.0.labels'] = {\n\t\t\t\t$regex: escapeRegExp(tag),\n\t\t\t\t$options: 'i',\n\t\t\t};\n\t\t\treturn '';\n\t\t});\n\t}\n\n\t/**\n\t * Filter on description of messages.\n\t */\n\tprivate consumeFileDescription(text: string) {\n\t\treturn text.replace(/file-desc:(\\w+)/g, (_: string, tag: string) => {\n\t\t\tthis.query['attachments.description'] = {\n\t\t\t\t$regex: escapeRegExp(tag),\n\t\t\t\t$options: 'i',\n\t\t\t};\n\t\t\treturn '';\n\t\t});\n\t}\n\n\t/**\n\t * Filter on title of messages.\n\t */\n\tprivate consumeFileTitle(text: string) {\n\t\treturn text.replace(/file-title:(\\w+)/g, (_: string, tag: string) => {\n\t\t\tthis.query['attachments.title'] = {\n\t\t\t\t$regex: escapeRegExp(tag),\n\t\t\t\t$options: 'i',\n\t\t\t};\n\n\t\t\treturn '';\n\t\t});\n\t}\n\n\t/**\n\t * Filter on messages that have been sent before a date.\n\t */\n\tprivate consumeBefore(text: string) {\n\t\treturn text.replace(/before:(\\d{1,2})[\\/\\.-](\\d{1,2})[\\/\\.-](\\d{4})/g, (_: string, day: string, month: string, year: string) => {\n\t\t\tconst beforeDate = new Date(parseInt(year, 10), parseInt(month, 10) - 1, parseInt(day, 10));\n\t\t\tbeforeDate.setUTCHours(beforeDate.getUTCHours() + beforeDate.getTimezoneOffset() / 60 + (this.user?.utcOffset ?? 0));\n\n\t\t\tthis.query.ts = {\n\t\t\t\t...this.query.ts,\n\t\t\t\t$lte: beforeDate,\n\t\t\t};\n\n\t\t\treturn '';\n\t\t});\n\t}\n\n\t/**\n\t * Filter on messages that have been sent after a date.\n\t */\n\tprivate consumeAfter(text: string) {\n\t\treturn text.replace(/after:(\\d{1,2})[\\/\\.-](\\d{1,2})[\\/\\.-](\\d{4})/g, (_: string, day: string, month: string, year: string) => {\n\t\t\tconst afterDate = new Date(parseInt(year, 10), parseInt(month, 10) - 1, parseInt(day, 10) + 1);\n\t\t\tafterDate.setUTCHours(afterDate.getUTCHours() + afterDate.getTimezoneOffset() / 60 + (this.user?.utcOffset ?? 0));\n\n\t\t\tthis.query.ts = {\n\t\t\t\t...this.query.ts,\n\t\t\t\t$gte: afterDate,\n\t\t\t};\n\n\t\t\treturn '';\n\t\t});\n\t}\n\n\t/**\n\t * Filter on messages that have been sent on a date.\n\t */\n\tprivate consumeOn(text: string) {\n\t\treturn text.replace(/on:(\\d{1,2})[\\/\\.-](\\d{1,2})[\\/\\.-](\\d{4})/g, (_: string, day: string, month: string, year: string) => {\n\t\t\tconst date = new Date(parseInt(year, 10), parseInt(month, 10) - 1, parseInt(day, 10));\n\t\t\tdate.setUTCHours(date.getUTCHours() + date.getTimezoneOffset() / 60 + (this.user?.utcOffset ?? 0));\n\t\t\tconst dayAfter = new Date(date);\n\t\t\tdayAfter.setDate(dayAfter.getDate() + 1);\n\n\t\t\tthis.query.ts = {\n\t\t\t\t$gte: date,\n\t\t\t\t$lt: dayAfter,\n\t\t\t};\n\n\t\t\treturn '';\n\t\t});\n\t}\n\n\t/**\n\t * Sort by timestamp.\n\t */\n\tconsumeOrder(text: string) {\n\t\treturn text.replace(/(?:order|sort):(asc|ascend|ascending|desc|descend|descending)/g, (_: string, direction: string) => {\n\t\t\tif (direction.startsWith('asc')) {\n\t\t\t\tthis.options.sort = {\n\t\t\t\t\t...(typeof this.options.sort === 'object' && !Array.isArray(this.options.sort) ? this.options.sort : {}),\n\t\t\t\t\tts: 1,\n\t\t\t\t};\n\t\t\t} else if (direction.startsWith('desc')) {\n\t\t\t\tthis.options.sort = {\n\t\t\t\t\t...(typeof this.options.sort === 'object' && !Array.isArray(this.options.sort) ? this.options.sort : {}),\n\t\t\t\t\tts: -1,\n\t\t\t\t};\n\t\t\t}\n\t\t\treturn '';\n\t\t});\n\t}\n\n\t/**\n\t * Query in message text\n\t */\n\tprivate consumeMessageText(text: string) {\n\t\ttext = text.trim().replace(/\\s\\s/g, ' ');\n\n\t\tif (text === '') {\n\t\t\treturn text;\n\t\t}\n\n\t\tif (/^\\/.+\\/[imxs]*$/.test(text)) {\n\t\t\tconst r = text.split('/');\n\t\t\tthis.query.msg = {\n\t\t\t\t$regex: r[1],\n\t\t\t\t$options: r[2],\n\t\t\t};\n\t\t} else if (this.forceRegex) {\n\t\t\tthis.query.msg = {\n\t\t\t\t$regex: text,\n\t\t\t\t$options: 'i',\n\t\t\t};\n\t\t} else {\n\t\t\tthis.query.$text = {\n\t\t\t\t$search: text,\n\t\t\t};\n\t\t\tthis.options.projection = {\n\t\t\t\tscore: {\n\t\t\t\t\t$meta: 'textScore',\n\t\t\t\t},\n\t\t\t};\n\t\t}\n\n\t\treturn text;\n\t}\n\n\tparse(text: string) {\n\t\t[\n\t\t\t(input: string) => this.consumeFrom(input),\n\t\t\t(input: string) => this.consumeMention(input),\n\t\t\t(input: string) => this.consumeHasStar(input),\n\t\t\t(input: string) => this.consumeHasUrl(input),\n\t\t\t(input: string) => this.consumeIsPinned(input),\n\t\t\t(input: string) => this.consumeHasLocation(input),\n\t\t\t(input: string) => this.consumeLabel(input),\n\t\t\t(input: string) => this.consumeFileDescription(input),\n\t\t\t(input: string) => this.consumeFileTitle(input),\n\t\t\t(input: string) => this.consumeBefore(input),\n\t\t\t(input: string) => this.consumeAfter(input),\n\t\t\t(input: string) => this.consumeOn(input),\n\t\t\t(input: string) => this.consumeOrder(input),\n\t\t\t(input: string) => this.consumeMessageText(input),\n\t\t].reduce((text, fn) => fn(text), text);\n\n\t\treturn {\n\t\t\tquery: this.query,\n\t\t\toptions: this.options,\n\t\t};\n\t}\n}\n\n/**\n * Parses a message search query and returns a MongoDB query and options\n * @param text The query text\n * @param options The options\n * @param options.user The user object\n * @param options.offset The offset\n * @param options.limit The limit\n * @param options.forceRegex Whether to force the use of regex\n * @returns The MongoDB query and options\n * @private\n * @example\n * const { query, options } = parseMessageSearchQuery('from:rocket.cat', {\n * \tuser: await Meteor.userAsync(),\n * \toffset: 0,\n * \tlimit: 20,\n * \tforceRegex: false,\n * });\n */\nexport function parseMessageSearchQuery(\n\ttext: string,\n\t{\n\t\tuser,\n\t\toffset = 0,\n\t\tlimit = 20,\n\t\tforceRegex = false,\n\t}: {\n\t\tuser?: IUser;\n\t\toffset?: number;\n\t\tlimit?: number;\n\t\tforceRegex?: boolean;\n\t},\n) {\n\tconst parser = new MessageSearchQueryParser({ user, offset, limit, forceRegex });\n\treturn parser.parse(text);\n}\n"]},"targets":{"android":"125.0.0","chrome":"125.0.0","edge":"125.0.0","firefox":"115.0.0","ie":"10.0.0","ios":"17.4.0","opera":"110.0.0","opera_mobile":"80.0.0","safari":"17.4.0","samsung":"24.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor","root":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":false,"enforceStrictMode":false,"dynamicImport":true,"generateLetDeclarations":true,"topLevelAwait":true},"externalDependencies":[]},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"version":"7.17.2","helpers":true,"useESModules":false,"corejs":false},"externalDependencies":[]},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-async-generator-functions","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-class-properties","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true},"externalDependencies":[]},{"key":"transform-react-jsx","visitor":{"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXFragment":{"exit":[null]},"JSXElement":{"exit":[null]},"JSXAttribute":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false},"externalDependencies":[]},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-nullish-coalescing-operator","visitor":{"LogicalExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-optional-chaining","visitor":{"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-optional-catch-binding","visitor":{"CatchClause":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-class-properties","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-async-generator-functions","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-logical-assignment-operators","visitor":{"AssignmentExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]}],"presets":[],"generatorOpts":{"filename":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/server/lib/parseMessageSearchQuery.ts","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"server/lib/parseMessageSearchQuery.ts","inputSourceMap":{"version":3,"file":"server/lib/parseMessageSearchQuery.ts","sourceRoot":"","sources":["server/lib/parseMessageSearchQuery.ts"],"names":[],"mappings":"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","sourcesContent":["import type { IMessage, IUser } from '@rocket.chat/core-typings';\nimport { escapeRegExp } from '@rocket.chat/string-helpers';\nimport type { Filter, FindOptions } from 'mongodb';\n\nclass MessageSearchQueryParser {\n\tprivate query: Exclude<Filter<IMessage>, Partial<IMessage>> = {};\n\n\tprivate options: FindOptions<IMessage> = {\n\t\tprojection: {},\n\t\tsort: {\n\t\t\tts: -1,\n\t\t},\n\t\tskip: 0,\n\t\tlimit: 20,\n\t};\n\n\tprivate user: IUser | undefined;\n\n\tprivate forceRegex = false;\n\n\tconstructor({\n\t\tuser,\n\t\toffset = 0,\n\t\tlimit = 20,\n\t\tforceRegex = false,\n\t}: {\n\t\tuser?: IUser;\n\t\toffset?: number;\n\t\tlimit?: number;\n\t\tforceRegex?: boolean;\n\t}) {\n\t\tthis.user = user;\n\t\tthis.options.skip = offset;\n\t\tthis.options.limit = limit;\n\t\tthis.forceRegex = forceRegex;\n\t}\n\n\tprivate consumeFrom(text: string) {\n\t\tconst from: string[] = [];\n\n\t\treturn text.replace(/from:([a-z0-9.\\-_]+)/gi, (_, username) => {\n\t\t\tif (username === 'me' && this.user?.username && !from.includes(this.user.username)) {\n\t\t\t\tusername = this.user.username;\n\t\t\t}\n\t\t\tfrom.push(username);\n\n\t\t\tthis.query['u.username'] = {\n\t\t\t\t$regex: from.join('|'),\n\t\t\t\t$options: 'i',\n\t\t\t};\n\n\t\t\treturn '';\n\t\t});\n\t}\n\n\tprivate consumeMention(text: string) {\n\t\tconst mentions: string[] = [];\n\n\t\treturn text.replace(/mention:([a-z0-9.\\-_]+)/gi, (_: string, username: string) => {\n\t\t\tmentions.push(username);\n\n\t\t\tthis.query['mentions.username'] = {\n\t\t\t\t$regex: mentions.join('|'),\n\t\t\t\t$options: 'i',\n\t\t\t};\n\n\t\t\treturn '';\n\t\t});\n\t}\n\n\t/**\n\t * Filter on messages that are starred by the current user.\n\t */\n\tprivate consumeHasStar(text: string) {\n\t\treturn text.replace(/has:star/g, () => {\n\t\t\tif (this.user?._id) {\n\t\t\t\tthis.query['starred._id'] = this.user._id;\n\t\t\t}\n\t\t\treturn '';\n\t\t});\n\t}\n\n\t/**\n\t * Filter on messages that have an url.\n\t */\n\tprivate consumeHasUrl(text: string) {\n\t\treturn text.replace(/has:url|has:link/g, () => {\n\t\t\tthis.query['urls.0'] = {\n\t\t\t\t$exists: true,\n\t\t\t};\n\t\t\treturn '';\n\t\t});\n\t}\n\n\t/**\n\t * Filter on pinned messages.\n\t */\n\tprivate consumeIsPinned(text: string) {\n\t\treturn text.replace(/is:pinned|has:pin/g, () => {\n\t\t\tthis.query.pinned = true;\n\t\t\treturn '';\n\t\t});\n\t}\n\n\t/**\n\t * Filter on messages which have a location attached.\n\t */\n\tprivate consumeHasLocation(text: string) {\n\t\treturn text.replace(/has:location|has:map/g, () => {\n\t\t\tthis.query.location = {\n\t\t\t\t$exists: true,\n\t\t\t};\n\t\t\treturn '';\n\t\t});\n\t}\n\n\t/**\n\t * Filter image tags\n\t */\n\tprivate consumeLabel(text: string) {\n\t\treturn text.replace(/label:(\\w+)/g, (_: string, tag: string) => {\n\t\t\tthis.query['attachments.0.labels'] = {\n\t\t\t\t$regex: escapeRegExp(tag),\n\t\t\t\t$options: 'i',\n\t\t\t};\n\t\t\treturn '';\n\t\t});\n\t}\n\n\t/**\n\t * Filter on description of messages.\n\t */\n\tprivate consumeFileDescription(text: string) {\n\t\treturn text.replace(/file-desc:(\\w+)/g, (_: string, tag: string) => {\n\t\t\tthis.query['attachments.description'] = {\n\t\t\t\t$regex: escapeRegExp(tag),\n\t\t\t\t$options: 'i',\n\t\t\t};\n\t\t\treturn '';\n\t\t});\n\t}\n\n\t/**\n\t * Filter on title of messages.\n\t */\n\tprivate consumeFileTitle(text: string) {\n\t\treturn text.replace(/file-title:(\\w+)/g, (_: string, tag: string) => {\n\t\t\tthis.query['attachments.title'] = {\n\t\t\t\t$regex: escapeRegExp(tag),\n\t\t\t\t$options: 'i',\n\t\t\t};\n\n\t\t\treturn '';\n\t\t});\n\t}\n\n\t/**\n\t * Filter on messages that have been sent before a date.\n\t */\n\tprivate consumeBefore(text: string) {\n\t\treturn text.replace(/before:(\\d{1,2})[\\/\\.-](\\d{1,2})[\\/\\.-](\\d{4})/g, (_: string, day: string, month: string, year: string) => {\n\t\t\tconst beforeDate = new Date(parseInt(year, 10), parseInt(month, 10) - 1, parseInt(day, 10));\n\t\t\tbeforeDate.setUTCHours(beforeDate.getUTCHours() + beforeDate.getTimezoneOffset() / 60 + (this.user?.utcOffset ?? 0));\n\n\t\t\tthis.query.ts = {\n\t\t\t\t...this.query.ts,\n\t\t\t\t$lte: beforeDate,\n\t\t\t};\n\n\t\t\treturn '';\n\t\t});\n\t}\n\n\t/**\n\t * Filter on messages that have been sent after a date.\n\t */\n\tprivate consumeAfter(text: string) {\n\t\treturn text.replace(/after:(\\d{1,2})[\\/\\.-](\\d{1,2})[\\/\\.-](\\d{4})/g, (_: string, day: string, month: string, year: string) => {\n\t\t\tconst afterDate = new Date(parseInt(year, 10), parseInt(month, 10) - 1, parseInt(day, 10) + 1);\n\t\t\tafterDate.setUTCHours(afterDate.getUTCHours() + afterDate.getTimezoneOffset() / 60 + (this.user?.utcOffset ?? 0));\n\n\t\t\tthis.query.ts = {\n\t\t\t\t...this.query.ts,\n\t\t\t\t$gte: afterDate,\n\t\t\t};\n\n\t\t\treturn '';\n\t\t});\n\t}\n\n\t/**\n\t * Filter on messages that have been sent on a date.\n\t */\n\tprivate consumeOn(text: string) {\n\t\treturn text.replace(/on:(\\d{1,2})[\\/\\.-](\\d{1,2})[\\/\\.-](\\d{4})/g, (_: string, day: string, month: string, year: string) => {\n\t\t\tconst date = new Date(parseInt(year, 10), parseInt(month, 10) - 1, parseInt(day, 10));\n\t\t\tdate.setUTCHours(date.getUTCHours() + date.getTimezoneOffset() / 60 + (this.user?.utcOffset ?? 0));\n\t\t\tconst dayAfter = new Date(date);\n\t\t\tdayAfter.setDate(dayAfter.getDate() + 1);\n\n\t\t\tthis.query.ts = {\n\t\t\t\t$gte: date,\n\t\t\t\t$lt: dayAfter,\n\t\t\t};\n\n\t\t\treturn '';\n\t\t});\n\t}\n\n\t/**\n\t * Sort by timestamp.\n\t */\n\tconsumeOrder(text: string) {\n\t\treturn text.replace(/(?:order|sort):(asc|ascend|ascending|desc|descend|descending)/g, (_: string, direction: string) => {\n\t\t\tif (direction.startsWith('asc')) {\n\t\t\t\tthis.options.sort = {\n\t\t\t\t\t...(typeof this.options.sort === 'object' && !Array.isArray(this.options.sort) ? this.options.sort : {}),\n\t\t\t\t\tts: 1,\n\t\t\t\t};\n\t\t\t} else if (direction.startsWith('desc')) {\n\t\t\t\tthis.options.sort = {\n\t\t\t\t\t...(typeof this.options.sort === 'object' && !Array.isArray(this.options.sort) ? this.options.sort : {}),\n\t\t\t\t\tts: -1,\n\t\t\t\t};\n\t\t\t}\n\t\t\treturn '';\n\t\t});\n\t}\n\n\t/**\n\t * Query in message text\n\t */\n\tprivate consumeMessageText(text: string) {\n\t\ttext = text.trim().replace(/\\s\\s/g, ' ');\n\n\t\tif (text === '') {\n\t\t\treturn text;\n\t\t}\n\n\t\tif (/^\\/.+\\/[imxs]*$/.test(text)) {\n\t\t\tconst r = text.split('/');\n\t\t\tthis.query.msg = {\n\t\t\t\t$regex: r[1],\n\t\t\t\t$options: r[2],\n\t\t\t};\n\t\t} else if (this.forceRegex) {\n\t\t\tthis.query.msg = {\n\t\t\t\t$regex: text,\n\t\t\t\t$options: 'i',\n\t\t\t};\n\t\t} else {\n\t\t\tthis.query.$text = {\n\t\t\t\t$search: text,\n\t\t\t};\n\t\t\tthis.options.projection = {\n\t\t\t\tscore: {\n\t\t\t\t\t$meta: 'textScore',\n\t\t\t\t},\n\t\t\t};\n\t\t}\n\n\t\treturn text;\n\t}\n\n\tparse(text: string) {\n\t\t[\n\t\t\t(input: string) => this.consumeFrom(input),\n\t\t\t(input: string) => this.consumeMention(input),\n\t\t\t(input: string) => this.consumeHasStar(input),\n\t\t\t(input: string) => this.consumeHasUrl(input),\n\t\t\t(input: string) => this.consumeIsPinned(input),\n\t\t\t(input: string) => this.consumeHasLocation(input),\n\t\t\t(input: string) => this.consumeLabel(input),\n\t\t\t(input: string) => this.consumeFileDescription(input),\n\t\t\t(input: string) => this.consumeFileTitle(input),\n\t\t\t(input: string) => this.consumeBefore(input),\n\t\t\t(input: string) => this.consumeAfter(input),\n\t\t\t(input: string) => this.consumeOn(input),\n\t\t\t(input: string) => this.consumeOrder(input),\n\t\t\t(input: string) => this.consumeMessageText(input),\n\t\t].reduce((text, fn) => fn(text), text);\n\n\t\treturn {\n\t\t\tquery: this.query,\n\t\t\toptions: this.options,\n\t\t};\n\t}\n}\n\n/**\n * Parses a message search query and returns a MongoDB query and options\n * @param text The query text\n * @param options The options\n * @param options.user The user object\n * @param options.offset The offset\n * @param options.limit The limit\n * @param options.forceRegex Whether to force the use of regex\n * @returns The MongoDB query and options\n * @private\n * @example\n * const { query, options } = parseMessageSearchQuery('from:rocket.cat', {\n * \tuser: await Meteor.userAsync(),\n * \toffset: 0,\n * \tlimit: 20,\n * \tforceRegex: false,\n * });\n */\nexport function parseMessageSearchQuery(\n\ttext: string,\n\t{\n\t\tuser,\n\t\toffset = 0,\n\t\tlimit = 20,\n\t\tforceRegex = false,\n\t}: {\n\t\tuser?: IUser;\n\t\toffset?: number;\n\t\tlimit?: number;\n\t\tforceRegex?: boolean;\n\t},\n) {\n\tconst parser = new MessageSearchQueryParser({ user, offset, limit, forceRegex });\n\treturn parser.parse(text);\n}\n"]}}},"code":"!module.wrapAsync(async function (module, __reifyWaitForDeps__, __reify_async_result__) {\n  \"use strict\";\n  try {\n    let _objectSpread;\n    module.link(\"@babel/runtime/helpers/objectSpread2\", {\n      default(v) {\n        _objectSpread = v;\n      }\n    }, 0);\n    module.export({\n      parseMessageSearchQuery: () => parseMessageSearchQuery\n    });\n    let escapeRegExp;\n    module.link(\"@rocket.chat/string-helpers\", {\n      escapeRegExp(v) {\n        escapeRegExp = v;\n      }\n    }, 0);\n    if (__reifyWaitForDeps__()) (await __reifyWaitForDeps__())();\n    class MessageSearchQueryParser {\n      constructor(_ref) {\n        let {\n          user,\n          offset = 0,\n          limit = 20,\n          forceRegex = false\n        } = _ref;\n        this.query = {};\n        this.options = {\n          projection: {},\n          sort: {\n            ts: -1\n          },\n          skip: 0,\n          limit: 20\n        };\n        this.user = void 0;\n        this.forceRegex = false;\n        this.user = user;\n        this.options.skip = offset;\n        this.options.limit = limit;\n        this.forceRegex = forceRegex;\n      }\n      consumeFrom(text) {\n        const from = [];\n        return text.replace(/from:([a-z0-9.\\-_]+)/gi, (_, username) => {\n          var _this$user;\n          if (username === 'me' && (_this$user = this.user) !== null && _this$user !== void 0 && _this$user.username && !from.includes(this.user.username)) {\n            username = this.user.username;\n          }\n          from.push(username);\n          this.query['u.username'] = {\n            $regex: from.join('|'),\n            $options: 'i'\n          };\n          return '';\n        });\n      }\n      consumeMention(text) {\n        const mentions = [];\n        return text.replace(/mention:([a-z0-9.\\-_]+)/gi, (_, username) => {\n          mentions.push(username);\n          this.query['mentions.username'] = {\n            $regex: mentions.join('|'),\n            $options: 'i'\n          };\n          return '';\n        });\n      }\n      /**\n       * Filter on messages that are starred by the current user.\n       */\n      consumeHasStar(text) {\n        return text.replace(/has:star/g, () => {\n          var _this$user2;\n          if ((_this$user2 = this.user) !== null && _this$user2 !== void 0 && _this$user2._id) {\n            this.query['starred._id'] = this.user._id;\n          }\n          return '';\n        });\n      }\n      /**\n       * Filter on messages that have an url.\n       */\n      consumeHasUrl(text) {\n        return text.replace(/has:url|has:link/g, () => {\n          this.query['urls.0'] = {\n            $exists: true\n          };\n          return '';\n        });\n      }\n      /**\n       * Filter on pinned messages.\n       */\n      consumeIsPinned(text) {\n        return text.replace(/is:pinned|has:pin/g, () => {\n          this.query.pinned = true;\n          return '';\n        });\n      }\n      /**\n       * Filter on messages which have a location attached.\n       */\n      consumeHasLocation(text) {\n        return text.replace(/has:location|has:map/g, () => {\n          this.query.location = {\n            $exists: true\n          };\n          return '';\n        });\n      }\n      /**\n       * Filter image tags\n       */\n      consumeLabel(text) {\n        return text.replace(/label:(\\w+)/g, (_, tag) => {\n          this.query['attachments.0.labels'] = {\n            $regex: escapeRegExp(tag),\n            $options: 'i'\n          };\n          return '';\n        });\n      }\n      /**\n       * Filter on description of messages.\n       */\n      consumeFileDescription(text) {\n        return text.replace(/file-desc:(\\w+)/g, (_, tag) => {\n          this.query['attachments.description'] = {\n            $regex: escapeRegExp(tag),\n            $options: 'i'\n          };\n          return '';\n        });\n      }\n      /**\n       * Filter on title of messages.\n       */\n      consumeFileTitle(text) {\n        return text.replace(/file-title:(\\w+)/g, (_, tag) => {\n          this.query['attachments.title'] = {\n            $regex: escapeRegExp(tag),\n            $options: 'i'\n          };\n          return '';\n        });\n      }\n      /**\n       * Filter on messages that have been sent before a date.\n       */\n      consumeBefore(text) {\n        return text.replace(/before:(\\d{1,2})[\\/\\.-](\\d{1,2})[\\/\\.-](\\d{4})/g, (_, day, month, year) => {\n          var _this$user$utcOffset, _this$user3;\n          const beforeDate = new Date(parseInt(year, 10), parseInt(month, 10) - 1, parseInt(day, 10));\n          beforeDate.setUTCHours(beforeDate.getUTCHours() + beforeDate.getTimezoneOffset() / 60 + ((_this$user$utcOffset = (_this$user3 = this.user) === null || _this$user3 === void 0 ? void 0 : _this$user3.utcOffset) !== null && _this$user$utcOffset !== void 0 ? _this$user$utcOffset : 0));\n          this.query.ts = _objectSpread(_objectSpread({}, this.query.ts), {}, {\n            $lte: beforeDate\n          });\n          return '';\n        });\n      }\n      /**\n       * Filter on messages that have been sent after a date.\n       */\n      consumeAfter(text) {\n        return text.replace(/after:(\\d{1,2})[\\/\\.-](\\d{1,2})[\\/\\.-](\\d{4})/g, (_, day, month, year) => {\n          var _this$user$utcOffset2, _this$user4;\n          const afterDate = new Date(parseInt(year, 10), parseInt(month, 10) - 1, parseInt(day, 10) + 1);\n          afterDate.setUTCHours(afterDate.getUTCHours() + afterDate.getTimezoneOffset() / 60 + ((_this$user$utcOffset2 = (_this$user4 = this.user) === null || _this$user4 === void 0 ? void 0 : _this$user4.utcOffset) !== null && _this$user$utcOffset2 !== void 0 ? _this$user$utcOffset2 : 0));\n          this.query.ts = _objectSpread(_objectSpread({}, this.query.ts), {}, {\n            $gte: afterDate\n          });\n          return '';\n        });\n      }\n      /**\n       * Filter on messages that have been sent on a date.\n       */\n      consumeOn(text) {\n        return text.replace(/on:(\\d{1,2})[\\/\\.-](\\d{1,2})[\\/\\.-](\\d{4})/g, (_, day, month, year) => {\n          var _this$user$utcOffset3, _this$user5;\n          const date = new Date(parseInt(year, 10), parseInt(month, 10) - 1, parseInt(day, 10));\n          date.setUTCHours(date.getUTCHours() + date.getTimezoneOffset() / 60 + ((_this$user$utcOffset3 = (_this$user5 = this.user) === null || _this$user5 === void 0 ? void 0 : _this$user5.utcOffset) !== null && _this$user$utcOffset3 !== void 0 ? _this$user$utcOffset3 : 0));\n          const dayAfter = new Date(date);\n          dayAfter.setDate(dayAfter.getDate() + 1);\n          this.query.ts = {\n            $gte: date,\n            $lt: dayAfter\n          };\n          return '';\n        });\n      }\n      /**\n       * Sort by timestamp.\n       */\n      consumeOrder(text) {\n        return text.replace(/(?:order|sort):(asc|ascend|ascending|desc|descend|descending)/g, (_, direction) => {\n          if (direction.startsWith('asc')) {\n            this.options.sort = _objectSpread(_objectSpread({}, typeof this.options.sort === 'object' && !Array.isArray(this.options.sort) ? this.options.sort : {}), {}, {\n              ts: 1\n            });\n          } else if (direction.startsWith('desc')) {\n            this.options.sort = _objectSpread(_objectSpread({}, typeof this.options.sort === 'object' && !Array.isArray(this.options.sort) ? this.options.sort : {}), {}, {\n              ts: -1\n            });\n          }\n          return '';\n        });\n      }\n      /**\n       * Query in message text\n       */\n      consumeMessageText(text) {\n        text = text.trim().replace(/\\s\\s/g, ' ');\n        if (text === '') {\n          return text;\n        }\n        if (/^\\/.+\\/[imxs]*$/.test(text)) {\n          const r = text.split('/');\n          this.query.msg = {\n            $regex: r[1],\n            $options: r[2]\n          };\n        } else if (this.forceRegex) {\n          this.query.msg = {\n            $regex: text,\n            $options: 'i'\n          };\n        } else {\n          this.query.$text = {\n            $search: text\n          };\n          this.options.projection = {\n            score: {\n              $meta: 'textScore'\n            }\n          };\n        }\n        return text;\n      }\n      parse(text) {\n        [input => this.consumeFrom(input), input => this.consumeMention(input), input => this.consumeHasStar(input), input => this.consumeHasUrl(input), input => this.consumeIsPinned(input), input => this.consumeHasLocation(input), input => this.consumeLabel(input), input => this.consumeFileDescription(input), input => this.consumeFileTitle(input), input => this.consumeBefore(input), input => this.consumeAfter(input), input => this.consumeOn(input), input => this.consumeOrder(input), input => this.consumeMessageText(input)].reduce((text, fn) => fn(text), text);\n        return {\n          query: this.query,\n          options: this.options\n        };\n      }\n    }\n    /**\n     * Parses a message search query and returns a MongoDB query and options\n     * @param text The query text\n     * @param options The options\n     * @param options.user The user object\n     * @param options.offset The offset\n     * @param options.limit The limit\n     * @param options.forceRegex Whether to force the use of regex\n     * @returns The MongoDB query and options\n     * @private\n     * @example\n     * const { query, options } = parseMessageSearchQuery('from:rocket.cat', {\n     * \tuser: await Meteor.userAsync(),\n     * \toffset: 0,\n     * \tlimit: 20,\n     * \tforceRegex: false,\n     * });\n     */\n    function parseMessageSearchQuery(text, _ref2) {\n      let {\n        user,\n        offset = 0,\n        limit = 20,\n        forceRegex = false\n      } = _ref2;\n      const parser = new MessageSearchQueryParser({\n        user,\n        offset,\n        limit,\n        forceRegex\n      });\n      return parser.parse(text);\n    }\n    __reify_async_result__();\n  } catch (_reifyError) {\n    return __reify_async_result__(_reifyError);\n  }\n  __reify_async_result__()\n}, {\n  self: this,\n  async: false\n});","map":{"version":3,"names":["_objectSpread","module","link","default","v","export","parseMessageSearchQuery","escapeRegExp","__reifyWaitForDeps__","MessageSearchQueryParser","constructor","_ref","user","offset","limit","forceRegex","query","options","projection","sort","ts","skip","consumeFrom","text","from","replace","_","username","_this$user","includes","push","$regex","join","$options","consumeMention","mentions","consumeHasStar","_this$user2","_id","consumeHasUrl","$exists","consumeIsPinned","pinned","consumeHasLocation","location","consumeLabel","tag","consumeFileDescription","consumeFileTitle","consumeBefore","day","month","year","_this$user$utcOffset","_this$user3","beforeDate","Date","parseInt","setUTCHours","getUTCHours","getTimezoneOffset","utcOffset","$lte","consumeAfter","_this$user$utcOffset2","_this$user4","afterDate","$gte","consumeOn","_this$user$utcOffset3","_this$user5","date","dayAfter","setDate","getDate","$lt","consumeOrder","direction","startsWith","Array","isArray","consumeMessageText","trim","test","r","split","msg","$text","$search","score","$meta","parse","input","reduce","fn","_ref2","parser","__reify_async_result__","_reifyError","self","async"],"sources":["server/lib/parseMessageSearchQuery.ts"],"sourcesContent":["import type { IMessage, IUser } from '@rocket.chat/core-typings';\nimport { escapeRegExp } from '@rocket.chat/string-helpers';\nimport type { Filter, FindOptions } from 'mongodb';\n\nclass MessageSearchQueryParser {\n\tprivate query: Exclude<Filter<IMessage>, Partial<IMessage>> = {};\n\n\tprivate options: FindOptions<IMessage> = {\n\t\tprojection: {},\n\t\tsort: {\n\t\t\tts: -1,\n\t\t},\n\t\tskip: 0,\n\t\tlimit: 20,\n\t};\n\n\tprivate user: IUser | undefined;\n\n\tprivate forceRegex = false;\n\n\tconstructor({\n\t\tuser,\n\t\toffset = 0,\n\t\tlimit = 20,\n\t\tforceRegex = false,\n\t}: {\n\t\tuser?: IUser;\n\t\toffset?: number;\n\t\tlimit?: number;\n\t\tforceRegex?: boolean;\n\t}) {\n\t\tthis.user = user;\n\t\tthis.options.skip = offset;\n\t\tthis.options.limit = limit;\n\t\tthis.forceRegex = forceRegex;\n\t}\n\n\tprivate consumeFrom(text: string) {\n\t\tconst from: string[] = [];\n\n\t\treturn text.replace(/from:([a-z0-9.\\-_]+)/gi, (_, username) => {\n\t\t\tif (username === 'me' && this.user?.username && !from.includes(this.user.username)) {\n\t\t\t\tusername = this.user.username;\n\t\t\t}\n\t\t\tfrom.push(username);\n\n\t\t\tthis.query['u.username'] = {\n\t\t\t\t$regex: from.join('|'),\n\t\t\t\t$options: 'i',\n\t\t\t};\n\n\t\t\treturn '';\n\t\t});\n\t}\n\n\tprivate consumeMention(text: string) {\n\t\tconst mentions: string[] = [];\n\n\t\treturn text.replace(/mention:([a-z0-9.\\-_]+)/gi, (_: string, username: string) => {\n\t\t\tmentions.push(username);\n\n\t\t\tthis.query['mentions.username'] = {\n\t\t\t\t$regex: mentions.join('|'),\n\t\t\t\t$options: 'i',\n\t\t\t};\n\n\t\t\treturn '';\n\t\t});\n\t}\n\n\t/**\n\t * Filter on messages that are starred by the current user.\n\t */\n\tprivate consumeHasStar(text: string) {\n\t\treturn text.replace(/has:star/g, () => {\n\t\t\tif (this.user?._id) {\n\t\t\t\tthis.query['starred._id'] = this.user._id;\n\t\t\t}\n\t\t\treturn '';\n\t\t});\n\t}\n\n\t/**\n\t * Filter on messages that have an url.\n\t */\n\tprivate consumeHasUrl(text: string) {\n\t\treturn text.replace(/has:url|has:link/g, () => {\n\t\t\tthis.query['urls.0'] = {\n\t\t\t\t$exists: true,\n\t\t\t};\n\t\t\treturn '';\n\t\t});\n\t}\n\n\t/**\n\t * Filter on pinned messages.\n\t */\n\tprivate consumeIsPinned(text: string) {\n\t\treturn text.replace(/is:pinned|has:pin/g, () => {\n\t\t\tthis.query.pinned = true;\n\t\t\treturn '';\n\t\t});\n\t}\n\n\t/**\n\t * Filter on messages which have a location attached.\n\t */\n\tprivate consumeHasLocation(text: string) {\n\t\treturn text.replace(/has:location|has:map/g, () => {\n\t\t\tthis.query.location = {\n\t\t\t\t$exists: true,\n\t\t\t};\n\t\t\treturn '';\n\t\t});\n\t}\n\n\t/**\n\t * Filter image tags\n\t */\n\tprivate consumeLabel(text: string) {\n\t\treturn text.replace(/label:(\\w+)/g, (_: string, tag: string) => {\n\t\t\tthis.query['attachments.0.labels'] = {\n\t\t\t\t$regex: escapeRegExp(tag),\n\t\t\t\t$options: 'i',\n\t\t\t};\n\t\t\treturn '';\n\t\t});\n\t}\n\n\t/**\n\t * Filter on description of messages.\n\t */\n\tprivate consumeFileDescription(text: string) {\n\t\treturn text.replace(/file-desc:(\\w+)/g, (_: string, tag: string) => {\n\t\t\tthis.query['attachments.description'] = {\n\t\t\t\t$regex: escapeRegExp(tag),\n\t\t\t\t$options: 'i',\n\t\t\t};\n\t\t\treturn '';\n\t\t});\n\t}\n\n\t/**\n\t * Filter on title of messages.\n\t */\n\tprivate consumeFileTitle(text: string) {\n\t\treturn text.replace(/file-title:(\\w+)/g, (_: string, tag: string) => {\n\t\t\tthis.query['attachments.title'] = {\n\t\t\t\t$regex: escapeRegExp(tag),\n\t\t\t\t$options: 'i',\n\t\t\t};\n\n\t\t\treturn '';\n\t\t});\n\t}\n\n\t/**\n\t * Filter on messages that have been sent before a date.\n\t */\n\tprivate consumeBefore(text: string) {\n\t\treturn text.replace(/before:(\\d{1,2})[\\/\\.-](\\d{1,2})[\\/\\.-](\\d{4})/g, (_: string, day: string, month: string, year: string) => {\n\t\t\tconst beforeDate = new Date(parseInt(year, 10), parseInt(month, 10) - 1, parseInt(day, 10));\n\t\t\tbeforeDate.setUTCHours(beforeDate.getUTCHours() + beforeDate.getTimezoneOffset() / 60 + (this.user?.utcOffset ?? 0));\n\n\t\t\tthis.query.ts = {\n\t\t\t\t...this.query.ts,\n\t\t\t\t$lte: beforeDate,\n\t\t\t};\n\n\t\t\treturn '';\n\t\t});\n\t}\n\n\t/**\n\t * Filter on messages that have been sent after a date.\n\t */\n\tprivate consumeAfter(text: string) {\n\t\treturn text.replace(/after:(\\d{1,2})[\\/\\.-](\\d{1,2})[\\/\\.-](\\d{4})/g, (_: string, day: string, month: string, year: string) => {\n\t\t\tconst afterDate = new Date(parseInt(year, 10), parseInt(month, 10) - 1, parseInt(day, 10) + 1);\n\t\t\tafterDate.setUTCHours(afterDate.getUTCHours() + afterDate.getTimezoneOffset() / 60 + (this.user?.utcOffset ?? 0));\n\n\t\t\tthis.query.ts = {\n\t\t\t\t...this.query.ts,\n\t\t\t\t$gte: afterDate,\n\t\t\t};\n\n\t\t\treturn '';\n\t\t});\n\t}\n\n\t/**\n\t * Filter on messages that have been sent on a date.\n\t */\n\tprivate consumeOn(text: string) {\n\t\treturn text.replace(/on:(\\d{1,2})[\\/\\.-](\\d{1,2})[\\/\\.-](\\d{4})/g, (_: string, day: string, month: string, year: string) => {\n\t\t\tconst date = new Date(parseInt(year, 10), parseInt(month, 10) - 1, parseInt(day, 10));\n\t\t\tdate.setUTCHours(date.getUTCHours() + date.getTimezoneOffset() / 60 + (this.user?.utcOffset ?? 0));\n\t\t\tconst dayAfter = new Date(date);\n\t\t\tdayAfter.setDate(dayAfter.getDate() + 1);\n\n\t\t\tthis.query.ts = {\n\t\t\t\t$gte: date,\n\t\t\t\t$lt: dayAfter,\n\t\t\t};\n\n\t\t\treturn '';\n\t\t});\n\t}\n\n\t/**\n\t * Sort by timestamp.\n\t */\n\tconsumeOrder(text: string) {\n\t\treturn text.replace(/(?:order|sort):(asc|ascend|ascending|desc|descend|descending)/g, (_: string, direction: string) => {\n\t\t\tif (direction.startsWith('asc')) {\n\t\t\t\tthis.options.sort = {\n\t\t\t\t\t...(typeof this.options.sort === 'object' && !Array.isArray(this.options.sort) ? this.options.sort : {}),\n\t\t\t\t\tts: 1,\n\t\t\t\t};\n\t\t\t} else if (direction.startsWith('desc')) {\n\t\t\t\tthis.options.sort = {\n\t\t\t\t\t...(typeof this.options.sort === 'object' && !Array.isArray(this.options.sort) ? this.options.sort : {}),\n\t\t\t\t\tts: -1,\n\t\t\t\t};\n\t\t\t}\n\t\t\treturn '';\n\t\t});\n\t}\n\n\t/**\n\t * Query in message text\n\t */\n\tprivate consumeMessageText(text: string) {\n\t\ttext = text.trim().replace(/\\s\\s/g, ' ');\n\n\t\tif (text === '') {\n\t\t\treturn text;\n\t\t}\n\n\t\tif (/^\\/.+\\/[imxs]*$/.test(text)) {\n\t\t\tconst r = text.split('/');\n\t\t\tthis.query.msg = {\n\t\t\t\t$regex: r[1],\n\t\t\t\t$options: r[2],\n\t\t\t};\n\t\t} else if (this.forceRegex) {\n\t\t\tthis.query.msg = {\n\t\t\t\t$regex: text,\n\t\t\t\t$options: 'i',\n\t\t\t};\n\t\t} else {\n\t\t\tthis.query.$text = {\n\t\t\t\t$search: text,\n\t\t\t};\n\t\t\tthis.options.projection = {\n\t\t\t\tscore: {\n\t\t\t\t\t$meta: 'textScore',\n\t\t\t\t},\n\t\t\t};\n\t\t}\n\n\t\treturn text;\n\t}\n\n\tparse(text: string) {\n\t\t[\n\t\t\t(input: string) => this.consumeFrom(input),\n\t\t\t(input: string) => this.consumeMention(input),\n\t\t\t(input: string) => this.consumeHasStar(input),\n\t\t\t(input: string) => this.consumeHasUrl(input),\n\t\t\t(input: string) => this.consumeIsPinned(input),\n\t\t\t(input: string) => this.consumeHasLocation(input),\n\t\t\t(input: string) => this.consumeLabel(input),\n\t\t\t(input: string) => this.consumeFileDescription(input),\n\t\t\t(input: string) => this.consumeFileTitle(input),\n\t\t\t(input: string) => this.consumeBefore(input),\n\t\t\t(input: string) => this.consumeAfter(input),\n\t\t\t(input: string) => this.consumeOn(input),\n\t\t\t(input: string) => this.consumeOrder(input),\n\t\t\t(input: string) => this.consumeMessageText(input),\n\t\t].reduce((text, fn) => fn(text), text);\n\n\t\treturn {\n\t\t\tquery: this.query,\n\t\t\toptions: this.options,\n\t\t};\n\t}\n}\n\n/**\n * Parses a message search query and returns a MongoDB query and options\n * @param text The query text\n * @param options The options\n * @param options.user The user object\n * @param options.offset The offset\n * @param options.limit The limit\n * @param options.forceRegex Whether to force the use of regex\n * @returns The MongoDB query and options\n * @private\n * @example\n * const { query, options } = parseMessageSearchQuery('from:rocket.cat', {\n * \tuser: await Meteor.userAsync(),\n * \toffset: 0,\n * \tlimit: 20,\n * \tforceRegex: false,\n * });\n */\nexport function parseMessageSearchQuery(\n\ttext: string,\n\t{\n\t\tuser,\n\t\toffset = 0,\n\t\tlimit = 20,\n\t\tforceRegex = false,\n\t}: {\n\t\tuser?: IUser;\n\t\toffset?: number;\n\t\tlimit?: number;\n\t\tforceRegex?: boolean;\n\t},\n) {\n\tconst parser = new MessageSearchQueryParser({ user, offset, limit, forceRegex });\n\treturn parser.parse(text);\n}\n"],"mappings":";;;IACA,IAAAA,aAAS;IAAAC,MAAc,CAAAC,IAAM,uCAA8B;MAAAC,QAAAC,CAAA;QAAAJ,aAAA,GAAAI,CAAA;MAAA;IAAA;IAA3DH,MAAA,CAAOI,MAAE;MAAAC,uBAAoB,EAAAA,CAAA,KAAAA;IAA8B;IAAA,IAAAC,YAAA;IAAAN,MAAA,CAAAC,IAAA;MAAAK,aAAAH,CAAA;QAAAG,YAAA,GAAAH,CAAA;MAAA;IAAA;IAAA,IAAAI,oBAAA,WAAAA,oBAAA;IAG3D,MAAMC,wBAAwB;MAgB7BC,YAAAC,IAAA,EAUC;QAAA,IAVW;UACXC,IAAI;UACJC,MAAM,GAAG,CAAC;UACVC,KAAK,GAAG,EAAE;UACVC,UAAU,GAAG;QAAK,CAMlB,GAAAJ,IAAA;QAAA,KAzBOK,KAAK,GAAiD,EAAE;QAAA,KAExDC,OAAO,GAA0B;UACxCC,UAAU,EAAE,EAAE;UACdC,IAAI,EAAE;YACLC,EAAE,EAAE,CAAC;WACL;UACDC,IAAI,EAAE,CAAC;UACPP,KAAK,EAAE;SACP;QAAA,KAEOF,IAAI;QAAA,KAEJG,UAAU,GAAG,KAAK;QAazB,IAAI,CAACH,IAAI,GAAGA,IAAI;QAChB,IAAI,CAACK,OAAO,CAACI,IAAI,GAAGR,MAAM;QAC1B,IAAI,CAACI,OAAO,CAACH,KAAK,GAAGA,KAAK;QAC1B,IAAI,CAACC,UAAU,GAAGA,UAAU;MAC7B;MAEQO,WAAWA,CAACC,IAAY;QAC/B,MAAMC,IAAI,GAAa,EAAE;QAEzB,OAAOD,IAAI,CAACE,OAAO,CAAC,wBAAwB,EAAE,CAACC,CAAC,EAAEC,QAAQ,KAAI;UAAA,IAAAC,UAAA;UAC7D,IAAID,QAAQ,KAAK,IAAI,KAAAC,UAAA,GAAI,IAAI,CAAChB,IAAI,cAAAgB,UAAA,eAATA,UAAA,CAAWD,QAAQ,IAAI,CAACH,IAAI,CAACK,QAAQ,CAAC,IAAI,CAACjB,IAAI,CAACe,QAAQ,CAAC,EAAE;YACnFA,QAAQ,GAAG,IAAI,CAACf,IAAI,CAACe,QAAQ;UAC9B;UACAH,IAAI,CAACM,IAAI,CAACH,QAAQ,CAAC;UAEnB,IAAI,CAACX,KAAK,CAAC,YAAY,CAAC,GAAG;YAC1Be,MAAM,EAAEP,IAAI,CAACQ,IAAI,CAAC,GAAG,CAAC;YACtBC,QAAQ,EAAE;WACV;UAED,OAAO,EAAE;QACV,CAAC,CAAC;MACH;MAEQC,cAAcA,CAACX,IAAY;QAClC,MAAMY,QAAQ,GAAa,EAAE;QAE7B,OAAOZ,IAAI,CAACE,OAAO,CAAC,2BAA2B,EAAE,CAACC,CAAS,EAAEC,QAAgB,KAAI;UAChFQ,QAAQ,CAACL,IAAI,CAACH,QAAQ,CAAC;UAEvB,IAAI,CAACX,KAAK,CAAC,mBAAmB,CAAC,GAAG;YACjCe,MAAM,EAAEI,QAAQ,CAACH,IAAI,CAAC,GAAG,CAAC;YAC1BC,QAAQ,EAAE;WACV;UAED,OAAO,EAAE;QACV,CAAC,CAAC;MACH;MAEA;;;MAGQG,cAAcA,CAACb,IAAY;QAClC,OAAOA,IAAI,CAACE,OAAO,CAAC,WAAW,EAAE,MAAK;UAAA,IAAAY,WAAA;UACrC,KAAAA,WAAA,GAAI,IAAI,CAACzB,IAAI,cAAAyB,WAAA,eAATA,WAAA,CAAWC,GAAG,EAAE;YACnB,IAAI,CAACtB,KAAK,CAAC,aAAa,CAAC,GAAG,IAAI,CAACJ,IAAI,CAAC0B,GAAG;UAC1C;UACA,OAAO,EAAE;QACV,CAAC,CAAC;MACH;MAEA;;;MAGQC,aAAaA,CAAChB,IAAY;QACjC,OAAOA,IAAI,CAACE,OAAO,CAAC,mBAAmB,EAAE,MAAK;UAC7C,IAAI,CAACT,KAAK,CAAC,QAAQ,CAAC,GAAG;YACtBwB,OAAO,EAAE;WACT;UACD,OAAO,EAAE;QACV,CAAC,CAAC;MACH;MAEA;;;MAGQC,eAAeA,CAAClB,IAAY;QACnC,OAAOA,IAAI,CAACE,OAAO,CAAC,oBAAoB,EAAE,MAAK;UAC9C,IAAI,CAACT,KAAK,CAAC0B,MAAM,GAAG,IAAI;UACxB,OAAO,EAAE;QACV,CAAC,CAAC;MACH;MAEA;;;MAGQC,kBAAkBA,CAACpB,IAAY;QACtC,OAAOA,IAAI,CAACE,OAAO,CAAC,uBAAuB,EAAE,MAAK;UACjD,IAAI,CAACT,KAAK,CAAC4B,QAAQ,GAAG;YACrBJ,OAAO,EAAE;WACT;UACD,OAAO,EAAE;QACV,CAAC,CAAC;MACH;MAEA;;;MAGQK,YAAYA,CAACtB,IAAY;QAChC,OAAOA,IAAI,CAACE,OAAO,CAAC,cAAc,EAAE,CAACC,CAAS,EAAEoB,GAAW,KAAI;UAC9D,IAAI,CAAC9B,KAAK,CAAC,sBAAsB,CAAC,GAAG;YACpCe,MAAM,EAAExB,YAAY,CAACuC,GAAG,CAAC;YACzBb,QAAQ,EAAE;WACV;UACD,OAAO,EAAE;QACV,CAAC,CAAC;MACH;MAEA;;;MAGQc,sBAAsBA,CAACxB,IAAY;QAC1C,OAAOA,IAAI,CAACE,OAAO,CAAC,kBAAkB,EAAE,CAACC,CAAS,EAAEoB,GAAW,KAAI;UAClE,IAAI,CAAC9B,KAAK,CAAC,yBAAyB,CAAC,GAAG;YACvCe,MAAM,EAAExB,YAAY,CAACuC,GAAG,CAAC;YACzBb,QAAQ,EAAE;WACV;UACD,OAAO,EAAE;QACV,CAAC,CAAC;MACH;MAEA;;;MAGQe,gBAAgBA,CAACzB,IAAY;QACpC,OAAOA,IAAI,CAACE,OAAO,CAAC,mBAAmB,EAAE,CAACC,CAAS,EAAEoB,GAAW,KAAI;UACnE,IAAI,CAAC9B,KAAK,CAAC,mBAAmB,CAAC,GAAG;YACjCe,MAAM,EAAExB,YAAY,CAACuC,GAAG,CAAC;YACzBb,QAAQ,EAAE;WACV;UAED,OAAO,EAAE;QACV,CAAC,CAAC;MACH;MAEA;;;MAGQgB,aAAaA,CAAC1B,IAAY;QACjC,OAAOA,IAAI,CAACE,OAAO,CAAC,iDAAiD,EAAE,CAACC,CAAS,EAAEwB,GAAW,EAAEC,KAAa,EAAEC,IAAY,KAAI;UAAA,IAAAC,oBAAA,EAAAC,WAAA;UAC9H,MAAMC,UAAU,GAAG,IAAIC,IAAI,CAACC,QAAQ,CAACL,IAAI,EAAE,EAAE,CAAC,EAAEK,QAAQ,CAACN,KAAK,EAAE,EAAE,CAAC,GAAG,CAAC,EAAEM,QAAQ,CAACP,GAAG,EAAE,EAAE,CAAC,CAAC;UAC3FK,UAAU,CAACG,WAAW,CAACH,UAAU,CAACI,WAAW,EAAE,GAAGJ,UAAU,CAACK,iBAAiB,EAAE,GAAG,EAAE,KAAAP,oBAAA,IAAAC,WAAA,GAAI,IAAI,CAAC1C,IAAI,cAAA0C,WAAA,uBAATA,WAAA,CAAWO,SAAS,cAAAR,oBAAA,cAAAA,oBAAA,GAAI,CAAC,CAAC,CAAC;UAEpH,IAAI,CAACrC,KAAK,CAACI,EAAE,GAAApB,aAAA,CAAAA,aAAA,KACT,IAAI,CAACgB,KAAK,CAACI,EAAE;YAChB0C,IAAI,EAAEP;UAAU,EAChB;UAED,OAAO,EAAE;QACV,CAAC,CAAC;MACH;MAEA;;;MAGQQ,YAAYA,CAACxC,IAAY;QAChC,OAAOA,IAAI,CAACE,OAAO,CAAC,gDAAgD,EAAE,CAACC,CAAS,EAAEwB,GAAW,EAAEC,KAAa,EAAEC,IAAY,KAAI;UAAA,IAAAY,qBAAA,EAAAC,WAAA;UAC7H,MAAMC,SAAS,GAAG,IAAIV,IAAI,CAACC,QAAQ,CAACL,IAAI,EAAE,EAAE,CAAC,EAAEK,QAAQ,CAACN,KAAK,EAAE,EAAE,CAAC,GAAG,CAAC,EAAEM,QAAQ,CAACP,GAAG,EAAE,EAAE,CAAC,GAAG,CAAC,CAAC;UAC9FgB,SAAS,CAACR,WAAW,CAACQ,SAAS,CAACP,WAAW,EAAE,GAAGO,SAAS,CAACN,iBAAiB,EAAE,GAAG,EAAE,KAAAI,qBAAA,IAAAC,WAAA,GAAI,IAAI,CAACrD,IAAI,cAAAqD,WAAA,uBAATA,WAAA,CAAWJ,SAAS,cAAAG,qBAAA,cAAAA,qBAAA,GAAI,CAAC,CAAC,CAAC;UAEjH,IAAI,CAAChD,KAAK,CAACI,EAAE,GAAApB,aAAA,CAAAA,aAAA,KACT,IAAI,CAACgB,KAAK,CAACI,EAAE;YAChB+C,IAAI,EAAED;UAAS,EACf;UAED,OAAO,EAAE;QACV,CAAC,CAAC;MACH;MAEA;;;MAGQE,SAASA,CAAC7C,IAAY;QAC7B,OAAOA,IAAI,CAACE,OAAO,CAAC,6CAA6C,EAAE,CAACC,CAAS,EAAEwB,GAAW,EAAEC,KAAa,EAAEC,IAAY,KAAI;UAAA,IAAAiB,qBAAA,EAAAC,WAAA;UAC1H,MAAMC,IAAI,GAAG,IAAIf,IAAI,CAACC,QAAQ,CAACL,IAAI,EAAE,EAAE,CAAC,EAAEK,QAAQ,CAACN,KAAK,EAAE,EAAE,CAAC,GAAG,CAAC,EAAEM,QAAQ,CAACP,GAAG,EAAE,EAAE,CAAC,CAAC;UACrFqB,IAAI,CAACb,WAAW,CAACa,IAAI,CAACZ,WAAW,EAAE,GAAGY,IAAI,CAACX,iBAAiB,EAAE,GAAG,EAAE,KAAAS,qBAAA,IAAAC,WAAA,GAAI,IAAI,CAAC1D,IAAI,cAAA0D,WAAA,uBAATA,WAAA,CAAWT,SAAS,cAAAQ,qBAAA,cAAAA,qBAAA,GAAI,CAAC,CAAC,CAAC;UAClG,MAAMG,QAAQ,GAAG,IAAIhB,IAAI,CAACe,IAAI,CAAC;UAC/BC,QAAQ,CAACC,OAAO,CAACD,QAAQ,CAACE,OAAO,EAAE,GAAG,CAAC,CAAC;UAExC,IAAI,CAAC1D,KAAK,CAACI,EAAE,GAAG;YACf+C,IAAI,EAAEI,IAAI;YACVI,GAAG,EAAEH;WACL;UAED,OAAO,EAAE;QACV,CAAC,CAAC;MACH;MAEA;;;MAGAI,YAAYA,CAACrD,IAAY;QACxB,OAAOA,IAAI,CAACE,OAAO,CAAC,gEAAgE,EAAE,CAACC,CAAS,EAAEmD,SAAiB,KAAI;UACtH,IAAIA,SAAS,CAACC,UAAU,CAAC,KAAK,CAAC,EAAE;YAChC,IAAI,CAAC7D,OAAO,CAACE,IAAI,GAAAnB,aAAA,CAAAA,aAAA,KACZ,OAAO,IAAI,CAACiB,OAAO,CAACE,IAAI,KAAK,QAAQ,IAAI,CAAC4D,KAAK,CAACC,OAAO,CAAC,IAAI,CAAC/D,OAAO,CAACE,IAAI,CAAC,GAAG,IAAI,CAACF,OAAO,CAACE,IAAI,GAAG,EAAE;cACvGC,EAAE,EAAE;YAAC,EACL;UACF,CAAC,MAAM,IAAIyD,SAAS,CAACC,UAAU,CAAC,MAAM,CAAC,EAAE;YACxC,IAAI,CAAC7D,OAAO,CAACE,IAAI,GAAAnB,aAAA,CAAAA,aAAA,KACZ,OAAO,IAAI,CAACiB,OAAO,CAACE,IAAI,KAAK,QAAQ,IAAI,CAAC4D,KAAK,CAACC,OAAO,CAAC,IAAI,CAAC/D,OAAO,CAACE,IAAI,CAAC,GAAG,IAAI,CAACF,OAAO,CAACE,IAAI,GAAG,EAAE;cACvGC,EAAE,EAAE,CAAC;YAAC,EACN;UACF;UACA,OAAO,EAAE;QACV,CAAC,CAAC;MACH;MAEA;;;MAGQ6D,kBAAkBA,CAAC1D,IAAY;QACtCA,IAAI,GAAGA,IAAI,CAAC2D,IAAI,EAAE,CAACzD,OAAO,CAAC,OAAO,EAAE,GAAG,CAAC;QAExC,IAAIF,IAAI,KAAK,EAAE,EAAE;UAChB,OAAOA,IAAI;QACZ;QAEA,IAAI,iBAAiB,CAAC4D,IAAI,CAAC5D,IAAI,CAAC,EAAE;UACjC,MAAM6D,CAAC,GAAG7D,IAAI,CAAC8D,KAAK,CAAC,GAAG,CAAC;UACzB,IAAI,CAACrE,KAAK,CAACsE,GAAG,GAAG;YAChBvD,MAAM,EAAEqD,CAAC,CAAC,CAAC,CAAC;YACZnD,QAAQ,EAAEmD,CAAC,CAAC,CAAC;WACb;QACF,CAAC,MAAM,IAAI,IAAI,CAACrE,UAAU,EAAE;UAC3B,IAAI,CAACC,KAAK,CAACsE,GAAG,GAAG;YAChBvD,MAAM,EAAER,IAAI;YACZU,QAAQ,EAAE;WACV;QACF,CAAC,MAAM;UACN,IAAI,CAACjB,KAAK,CAACuE,KAAK,GAAG;YAClBC,OAAO,EAAEjE;WACT;UACD,IAAI,CAACN,OAAO,CAACC,UAAU,GAAG;YACzBuE,KAAK,EAAE;cACNC,KAAK,EAAE;;WAER;QACF;QAEA,OAAOnE,IAAI;MACZ;MAEAoE,KAAKA,CAACpE,IAAY;QACjB,CACEqE,KAAa,IAAK,IAAI,CAACtE,WAAW,CAACsE,KAAK,CAAC,EACzCA,KAAa,IAAK,IAAI,CAAC1D,cAAc,CAAC0D,KAAK,CAAC,EAC5CA,KAAa,IAAK,IAAI,CAACxD,cAAc,CAACwD,KAAK,CAAC,EAC5CA,KAAa,IAAK,IAAI,CAACrD,aAAa,CAACqD,KAAK,CAAC,EAC3CA,KAAa,IAAK,IAAI,CAACnD,eAAe,CAACmD,KAAK,CAAC,EAC7CA,KAAa,IAAK,IAAI,CAACjD,kBAAkB,CAACiD,KAAK,CAAC,EAChDA,KAAa,IAAK,IAAI,CAAC/C,YAAY,CAAC+C,KAAK,CAAC,EAC1CA,KAAa,IAAK,IAAI,CAAC7C,sBAAsB,CAAC6C,KAAK,CAAC,EACpDA,KAAa,IAAK,IAAI,CAAC5C,gBAAgB,CAAC4C,KAAK,CAAC,EAC9CA,KAAa,IAAK,IAAI,CAAC3C,aAAa,CAAC2C,KAAK,CAAC,EAC3CA,KAAa,IAAK,IAAI,CAAC7B,YAAY,CAAC6B,KAAK,CAAC,EAC1CA,KAAa,IAAK,IAAI,CAACxB,SAAS,CAACwB,KAAK,CAAC,EACvCA,KAAa,IAAK,IAAI,CAAChB,YAAY,CAACgB,KAAK,CAAC,EAC1CA,KAAa,IAAK,IAAI,CAACX,kBAAkB,CAACW,KAAK,CAAC,CACjD,CAACC,MAAM,CAAC,CAACtE,IAAI,EAAEuE,EAAE,KAAKA,EAAE,CAACvE,IAAI,CAAC,EAAEA,IAAI,CAAC;QAEtC,OAAO;UACNP,KAAK,EAAE,IAAI,CAACA,KAAK;UACjBC,OAAO,EAAE,IAAI,CAACA;SACd;MACF;;IAGD;;;;;;;;;;;;;;;;;;IAkBM,SAAUX,uBAAuBA,CACtCiB,IAAY,EAAAwE,KAAA,EAWX;MAAA,IAVD;QACCnF,IAAI;QACJC,MAAM,GAAG,CAAC;QACVC,KAAK,GAAG,EAAE;QACVC,UAAU,GAAG;MAAK,CAMlB,GAAAgF,KAAA;MAED,MAAMC,MAAM,GAAG,IAAIvF,wBAAwB,CAAC;QAAEG,IAAI;QAAEC,MAAM;QAAEC,KAAK;QAAEC;MAAU,CAAE,CAAC;MAChF,OAAOiF,MAAM,CAACL,KAAK,CAACpE,IAAI,CAAC;IAC1B;IAAC0E,sBAAA;EAAA,SAAAC,WAAA;IAAA,OAAAD,sBAAA,CAAAC,WAAA;EAAA;EAAAD,sBAAA;AAAA;EAAAE,IAAA;EAAAC,KAAA;AAAA","ignoreList":[]},"sourceType":"module","externalDependencies":{},"hash":"eced7a3e400cf11d82c49b726972c26feb03b24a"}
