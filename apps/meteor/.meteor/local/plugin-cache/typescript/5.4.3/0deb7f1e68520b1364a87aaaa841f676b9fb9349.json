{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/app/livechat/server/lib/LivechatTyped.ts","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","topLevelAwait","objectRestSpread","objectRestSpread","asyncGenerators","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"os.osx.arm64"},"sourceFileName":"app/livechat/server/lib/LivechatTyped.ts","filename":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/app/livechat/server/lib/LivechatTyped.ts","inputSourceMap":{"version":3,"file":"app/livechat/server/lib/LivechatTyped.ts","sourceRoot":"","sources":["app/livechat/server/lib/LivechatTyped.ts"],"names":[],"mappings":"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","sourcesContent":["import { Apps, AppEvents } from '@rocket.chat/apps';\nimport { Message, VideoConf, api, Omnichannel } from '@rocket.chat/core-services';\nimport type {\n\tIOmnichannelRoom,\n\tIOmnichannelRoomClosingInfo,\n\tIUser,\n\tILivechatVisitor,\n\tSelectedAgent,\n\tILivechatAgent,\n\tIMessage,\n\tILivechatDepartment,\n\tAtLeast,\n\tTransferData,\n\tIOmnichannelAgent,\n\tILivechatInquiryRecord,\n\tILivechatContact,\n\tILivechatContactChannel,\n\tIOmnichannelRoomInfo,\n\tIOmnichannelRoomExtraData,\n} from '@rocket.chat/core-typings';\nimport { OmnichannelSourceType, ILivechatAgentStatus, UserStatus, isOmnichannelRoom } from '@rocket.chat/core-typings';\nimport { Logger, type MainLogger } from '@rocket.chat/logger';\nimport {\n\tLivechatDepartment,\n\tLivechatInquiry,\n\tLivechatRooms,\n\tSubscriptions,\n\tLivechatVisitors,\n\tMessages,\n\tUsers,\n\tLivechatDepartmentAgents,\n\tReadReceipts,\n\tRooms,\n\tLivechatCustomField,\n\tLivechatContacts,\n} from '@rocket.chat/models';\nimport { serverFetch as fetch } from '@rocket.chat/server-fetch';\nimport { Match, check } from 'meteor/check';\nimport { Meteor } from 'meteor/meteor';\nimport type { Filter, ClientSession, MongoError } from 'mongodb';\nimport UAParser from 'ua-parser-js';\n\nimport { callbacks } from '../../../../lib/callbacks';\nimport { trim } from '../../../../lib/utils/stringUtils';\nimport { client } from '../../../../server/database/utils';\nimport { i18n } from '../../../../server/lib/i18n';\nimport { addUserRolesAsync } from '../../../../server/lib/roles/addUserRoles';\nimport { removeUserFromRolesAsync } from '../../../../server/lib/roles/removeUserFromRoles';\nimport { canAccessRoomAsync } from '../../../authorization/server';\nimport { hasPermissionAsync } from '../../../authorization/server/functions/hasPermission';\nimport { hasRoleAsync } from '../../../authorization/server/functions/hasRole';\nimport { FileUpload } from '../../../file-upload/server';\nimport { deleteMessage } from '../../../lib/server/functions/deleteMessage';\nimport { sendMessage } from '../../../lib/server/functions/sendMessage';\nimport { updateMessage } from '../../../lib/server/functions/updateMessage';\nimport {\n\tnotifyOnLivechatInquiryChanged,\n\tnotifyOnLivechatInquiryChangedByRoom,\n\tnotifyOnRoomChangedById,\n\tnotifyOnLivechatInquiryChangedByToken,\n\tnotifyOnUserChange,\n\tnotifyOnSubscriptionChangedByRoomId,\n\tnotifyOnSubscriptionChanged,\n} from '../../../lib/server/lib/notifyListener';\nimport { metrics } from '../../../metrics/server';\nimport { settings } from '../../../settings/server';\nimport { businessHourManager } from '../business-hour';\nimport { createContact, createContactFromVisitor, isSingleContactEnabled } from './Contacts';\nimport { parseAgentCustomFields, updateDepartmentAgents, validateEmail, normalizeTransferredByData } from './Helper';\nimport { QueueManager } from './QueueManager';\nimport { RoutingManager } from './RoutingManager';\nimport { getRequiredDepartment } from './departmentsLib';\nimport type { CloseRoomParams, CloseRoomParamsByUser, CloseRoomParamsByVisitor, ILivechatMessage } from './localTypes';\nimport { parseTranscriptRequest } from './parseTranscriptRequest';\n\ntype RegisterGuestType = Partial<Pick<ILivechatVisitor, 'token' | 'name' | 'department' | 'status' | 'username'>> & {\n\tid?: string;\n\tconnectionData?: any;\n\temail?: string;\n\tphone?: { number: string };\n};\n\ntype AKeyOf<T> = {\n\t[K in keyof T]?: T[K];\n};\n\ntype ICRMData = {\n\t_id: string;\n\tlabel?: string;\n\ttopic?: string;\n\tcreatedAt: Date;\n\tlastMessageAt?: Date;\n\ttags?: string[];\n\tcustomFields?: IOmnichannelRoom['livechatData'];\n\tvisitor: Pick<ILivechatVisitor, '_id' | 'token' | 'name' | 'username' | 'department' | 'phone' | 'ip'> & {\n\t\temail?: ILivechatVisitor['visitorEmails'];\n\t\tos?: string;\n\t\tbrowser?: string;\n\t\tcustomFields: ILivechatVisitor['livechatData'];\n\t};\n\tagent?: Pick<IOmnichannelAgent, '_id' | 'username' | 'name' | 'customFields'> & {\n\t\temail?: NonNullable<IOmnichannelAgent['emails']>[number]['address'];\n\t};\n\tcrmData?: IOmnichannelRoom['crmData'];\n};\n\ntype ChatCloser = { _id: string; username: string | undefined };\n\nconst isRoomClosedByUserParams = (params: CloseRoomParams): params is CloseRoomParamsByUser =>\n\t(params as CloseRoomParamsByUser).user !== undefined;\nconst isRoomClosedByVisitorParams = (params: CloseRoomParams): params is CloseRoomParamsByVisitor =>\n\t(params as CloseRoomParamsByVisitor).visitor !== undefined;\n\nclass LivechatClass {\n\tlogger: Logger;\n\n\twebhookLogger: MainLogger;\n\n\tconstructor() {\n\t\tthis.logger = new Logger('Livechat');\n\t\tthis.webhookLogger = this.logger.section('Webhook');\n\t}\n\n\tasync online(department?: string, skipNoAgentSetting = false, skipFallbackCheck = false): Promise<boolean> {\n\t\tLivechat.logger.debug(`Checking online agents ${department ? `for department ${department}` : ''}`);\n\t\tif (!skipNoAgentSetting && settings.get('Livechat_accept_chats_with_no_agents')) {\n\t\t\tLivechat.logger.debug('Can accept without online agents: true');\n\t\t\treturn true;\n\t\t}\n\n\t\tif (settings.get('Livechat_assign_new_conversation_to_bot')) {\n\t\t\tLivechat.logger.debug(`Fetching online bot agents for department ${department}`);\n\t\t\tconst botAgents = await Livechat.getBotAgents(department);\n\t\t\tif (botAgents) {\n\t\t\t\tconst onlineBots = await botAgents.count();\n\t\t\t\tthis.logger.debug(`Found ${onlineBots} online`);\n\t\t\t\tif (onlineBots > 0) {\n\t\t\t\t\treturn true;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tconst agentsOnline = await this.checkOnlineAgents(department, undefined, skipFallbackCheck);\n\t\tLivechat.logger.debug(`Are online agents ${department ? `for department ${department}` : ''}?: ${agentsOnline}`);\n\t\treturn agentsOnline;\n\t}\n\n\tasync closeRoom(params: CloseRoomParams, attempts = 2): Promise<void> {\n\t\tlet newRoom: IOmnichannelRoom;\n\t\tlet chatCloser: ChatCloser;\n\t\tlet removedInquiryObj: ILivechatInquiryRecord | null;\n\n\t\tconst session = client.startSession();\n\t\ttry {\n\t\t\tsession.startTransaction();\n\t\t\tconst { room, closedBy, removedInquiry } = await this.doCloseRoom(params, session);\n\t\t\tawait session.commitTransaction();\n\n\t\t\tnewRoom = room;\n\t\t\tchatCloser = closedBy;\n\t\t\tremovedInquiryObj = removedInquiry;\n\t\t} catch (e) {\n\t\t\tthis.logger.error({ err: e, msg: 'Failed to close room', afterAttempts: attempts });\n\t\t\tawait session.abortTransaction();\n\t\t\t// Dont propagate transaction errors\n\t\t\tif (\n\t\t\t\t(e as unknown as MongoError)?.errorLabels?.includes('UnknownTransactionCommitResult') ||\n\t\t\t\t(e as unknown as MongoError)?.errorLabels?.includes('TransientTransactionError')\n\t\t\t) {\n\t\t\t\tif (attempts > 0) {\n\t\t\t\t\tthis.logger.debug(`Retrying close room because of transient error. Attempts left: ${attempts}`);\n\t\t\t\t\treturn this.closeRoom(params, attempts - 1);\n\t\t\t\t}\n\n\t\t\t\tthrow new Error('error-room-cannot-be-closed-try-again');\n\t\t\t}\n\t\t\tthrow e;\n\t\t} finally {\n\t\t\tawait session.endSession();\n\t\t}\n\n\t\t// Note: when reaching this point, the room has been closed\n\t\t// Transaction is commited and so these messages can be sent here.\n\t\treturn this.afterRoomClosed(newRoom, chatCloser, removedInquiryObj, params);\n\t}\n\n\tasync afterRoomClosed(\n\t\tnewRoom: IOmnichannelRoom,\n\t\tchatCloser: ChatCloser,\n\t\tinquiry: ILivechatInquiryRecord | null,\n\t\tparams: CloseRoomParams,\n\t): Promise<void> {\n\t\tif (!chatCloser) {\n\t\t\t// this should never happen\n\t\t\treturn;\n\t\t}\n\t\t// Note: we are okay with these messages being sent outside of the transaction. The process of sending a message\n\t\t// is huge and involves multiple db calls. Making it transactionable this way would be really hard.\n\t\t// And passing just _some_ actions to the transaction creates some deadlocks since messages are updated in the afterSaveMessages callbacks.\n\t\tconst transcriptRequested =\n\t\t\t!!params.room.transcriptRequest || (!settings.get('Livechat_enable_transcript') && settings.get('Livechat_transcript_send_always'));\n\t\tthis.logger.debug(`Sending closing message to room ${newRoom._id}`);\n\t\tawait Message.saveSystemMessageAndNotifyUser('livechat-close', newRoom._id, params.comment ?? '', chatCloser, {\n\t\t\tgroupable: false,\n\t\t\ttranscriptRequested,\n\t\t\t...(isRoomClosedByVisitorParams(params) && { token: params.visitor.token }),\n\t\t});\n\n\t\tif (settings.get('Livechat_enable_transcript') && !settings.get('Livechat_transcript_send_always')) {\n\t\t\tawait Message.saveSystemMessage('command', newRoom._id, 'promptTranscript', chatCloser);\n\t\t}\n\n\t\tthis.logger.debug(`Running callbacks for room ${newRoom._id}`);\n\n\t\tprocess.nextTick(() => {\n\t\t\t/**\n\t\t\t * @deprecated the `AppEvents.ILivechatRoomClosedHandler` event will be removed\n\t\t\t * in the next major version of the Apps-Engine\n\t\t\t */\n\t\t\tvoid Apps.self?.getBridges()?.getListenerBridge().livechatEvent(AppEvents.ILivechatRoomClosedHandler, newRoom);\n\t\t\tvoid Apps.self?.getBridges()?.getListenerBridge().livechatEvent(AppEvents.IPostLivechatRoomClosed, newRoom);\n\t\t});\n\n\t\tconst visitor = isRoomClosedByVisitorParams(params) ? params.visitor : undefined;\n\t\tconst opts = await parseTranscriptRequest(params.room, params.options, visitor);\n\t\tif (process.env.TEST_MODE) {\n\t\t\tawait callbacks.run('livechat.closeRoom', {\n\t\t\t\troom: newRoom,\n\t\t\t\toptions: opts,\n\t\t\t});\n\t\t} else {\n\t\t\tcallbacks.runAsync('livechat.closeRoom', {\n\t\t\t\troom: newRoom,\n\t\t\t\toptions: opts,\n\t\t\t});\n\t\t}\n\n\t\tvoid notifyOnRoomChangedById(newRoom._id);\n\t\tif (inquiry) {\n\t\t\tvoid notifyOnLivechatInquiryChanged(inquiry, 'removed');\n\t\t}\n\n\t\tthis.logger.debug(`Room ${newRoom._id} was closed`);\n\t}\n\n\tasync doCloseRoom(\n\t\tparams: CloseRoomParams,\n\t\tsession: ClientSession,\n\t): Promise<{ room: IOmnichannelRoom; closedBy: ChatCloser; removedInquiry: ILivechatInquiryRecord | null }> {\n\t\tconst { comment } = params;\n\t\tconst { room } = params;\n\n\t\tthis.logger.debug(`Attempting to close room ${room._id}`);\n\t\tif (!room || !isOmnichannelRoom(room) || !room.open) {\n\t\t\tthis.logger.debug(`Room ${room._id} is not open`);\n\t\t\tthrow new Error('error-room-closed');\n\t\t}\n\n\t\tconst commentRequired = settings.get('Livechat_request_comment_when_closing_conversation');\n\t\tif (commentRequired && !comment?.trim()) {\n\t\t\tthrow new Error('error-comment-is-required');\n\t\t}\n\n\t\tconst { updatedOptions: options } = await this.resolveChatTags(room, params.options);\n\t\tthis.logger.debug(`Resolved chat tags for room ${room._id}`);\n\n\t\tconst now = new Date();\n\t\tconst { _id: rid, servedBy } = room;\n\t\tconst serviceTimeDuration = servedBy && (now.getTime() - new Date(servedBy.ts).getTime()) / 1000;\n\n\t\tconst closeData: IOmnichannelRoomClosingInfo = {\n\t\t\tclosedAt: now,\n\t\t\tchatDuration: (now.getTime() - new Date(room.ts).getTime()) / 1000,\n\t\t\t...(serviceTimeDuration && { serviceTimeDuration }),\n\t\t\t...options,\n\t\t};\n\t\tthis.logger.debug(`Room ${room._id} was closed at ${closeData.closedAt} (duration ${closeData.chatDuration})`);\n\n\t\tif (isRoomClosedByUserParams(params)) {\n\t\t\tconst { user } = params;\n\t\t\tthis.logger.debug(`Closing by user ${user?._id}`);\n\t\t\tcloseData.closer = 'user';\n\t\t\tcloseData.closedBy = {\n\t\t\t\t_id: user?._id || '',\n\t\t\t\tusername: user?.username,\n\t\t\t};\n\t\t} else if (isRoomClosedByVisitorParams(params)) {\n\t\t\tconst { visitor } = params;\n\t\t\tthis.logger.debug(`Closing by visitor ${params.visitor._id}`);\n\t\t\tcloseData.closer = 'visitor';\n\t\t\tcloseData.closedBy = {\n\t\t\t\t_id: visitor._id,\n\t\t\t\tusername: visitor.username,\n\t\t\t};\n\t\t} else {\n\t\t\tthrow new Error('Error: Please provide details of the user or visitor who closed the room');\n\t\t}\n\n\t\tthis.logger.debug(`Updating DB for room ${room._id} with close data`);\n\n\t\tconst inquiry = await LivechatInquiry.findOneByRoomId(rid, { session });\n\t\tconst removedInquiry = await LivechatInquiry.removeByRoomId(rid, { session });\n\t\tif (removedInquiry && removedInquiry.deletedCount !== 1) {\n\t\t\tthrow new Error('Error removing inquiry');\n\t\t}\n\n\t\tconst updatedRoom = await LivechatRooms.closeRoomById(rid, closeData, { session });\n\t\tif (!updatedRoom || updatedRoom.modifiedCount !== 1) {\n\t\t\tthrow new Error('Error closing room');\n\t\t}\n\n\t\tconst subs = await Subscriptions.countByRoomId(rid, { session });\n\t\tconst removedSubs = await Subscriptions.removeByRoomId(rid, {\n\t\t\tasync onTrash(doc) {\n\t\t\t\tvoid notifyOnSubscriptionChanged(doc, 'removed');\n\t\t\t},\n\t\t\tsession,\n\t\t});\n\n\t\tif (removedSubs.deletedCount !== subs) {\n\t\t\tthrow new Error('Error removing subscriptions');\n\t\t}\n\n\t\tthis.logger.debug(`DB updated for room ${room._id}`);\n\n\t\t// Retrieve the closed room\n\t\tconst newRoom = await LivechatRooms.findOneById(rid, { session });\n\t\tif (!newRoom) {\n\t\t\tthrow new Error('Error: Room not found');\n\t\t}\n\n\t\treturn { room: newRoom, closedBy: closeData.closedBy, removedInquiry: inquiry };\n\t}\n\n\tasync createRoom({\n\t\tvisitor,\n\t\tmessage,\n\t\trid,\n\t\troomInfo,\n\t\tagent,\n\t\textraData,\n\t}: {\n\t\tvisitor: ILivechatVisitor;\n\t\tmessage?: string;\n\t\trid?: string;\n\t\troomInfo: IOmnichannelRoomInfo;\n\t\tagent?: SelectedAgent;\n\t\textraData?: IOmnichannelRoomExtraData;\n\t}) {\n\t\tif (!settings.get('Livechat_enabled')) {\n\t\t\tthrow new Meteor.Error('error-omnichannel-is-disabled');\n\t\t}\n\n\t\tconst defaultAgent = await callbacks.run('livechat.checkDefaultAgentOnNewRoom', agent, visitor);\n\t\t// if no department selected verify if there is at least one active and pick the first\n\t\tif (!defaultAgent && !visitor.department) {\n\t\t\tconst department = await getRequiredDepartment();\n\t\t\tLivechat.logger.debug(`No department or default agent selected for ${visitor._id}`);\n\n\t\t\tif (department) {\n\t\t\t\tLivechat.logger.debug(`Assigning ${visitor._id} to department ${department._id}`);\n\t\t\t\tvisitor.department = department._id;\n\t\t\t}\n\t\t}\n\n\t\t// delegate room creation to QueueManager\n\t\tLivechat.logger.debug(`Calling QueueManager to request a room for visitor ${visitor._id}`);\n\n\t\tconst room = await QueueManager.requestRoom({\n\t\t\tguest: visitor,\n\t\t\tmessage,\n\t\t\trid,\n\t\t\troomInfo,\n\t\t\tagent: defaultAgent,\n\t\t\textraData,\n\t\t});\n\n\t\tif (isSingleContactEnabled()) {\n\t\t\tlet { contactId } = visitor;\n\n\t\t\tif (!contactId) {\n\t\t\t\tconst visitorContact = await LivechatVisitors.findOne<\n\t\t\t\t\tPick<ILivechatVisitor, 'name' | 'contactManager' | 'livechatData' | 'phone' | 'visitorEmails' | 'username' | 'contactId'>\n\t\t\t\t>(visitor._id, {\n\t\t\t\t\tprojection: {\n\t\t\t\t\t\tname: 1,\n\t\t\t\t\t\tcontactManager: 1,\n\t\t\t\t\t\tlivechatData: 1,\n\t\t\t\t\t\tphone: 1,\n\t\t\t\t\t\tvisitorEmails: 1,\n\t\t\t\t\t\tusername: 1,\n\t\t\t\t\t\tcontactId: 1,\n\t\t\t\t\t},\n\t\t\t\t});\n\n\t\t\t\tcontactId = visitorContact?.contactId;\n\t\t\t}\n\n\t\t\tif (!contactId) {\n\t\t\t\t// ensure that old visitors have a contact\n\t\t\t\tcontactId = await createContactFromVisitor(visitor);\n\t\t\t}\n\n\t\t\tconst contact = await LivechatContacts.findOneById<Pick<ILivechatContact, '_id' | 'channels'>>(contactId, {\n\t\t\t\tprojection: { _id: 1, channels: 1 },\n\t\t\t});\n\n\t\t\tif (contact) {\n\t\t\t\tconst channel = contact.channels?.find(\n\t\t\t\t\t(channel: ILivechatContactChannel) => channel.name === roomInfo.source?.type && channel.visitorId === visitor._id,\n\t\t\t\t);\n\n\t\t\t\tif (!channel) {\n\t\t\t\t\tLivechat.logger.debug(`Adding channel for contact ${contact._id}`);\n\n\t\t\t\t\tawait LivechatContacts.addChannel(contact._id, {\n\t\t\t\t\t\tname: roomInfo.source?.label || roomInfo.source?.type.toString() || OmnichannelSourceType.OTHER,\n\t\t\t\t\t\tvisitorId: visitor._id,\n\t\t\t\t\t\tblocked: false,\n\t\t\t\t\t\tverified: false,\n\t\t\t\t\t\tdetails: roomInfo.source,\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tLivechat.logger.debug(`Room obtained for visitor ${visitor._id} -> ${room._id}`);\n\n\t\tawait Messages.setRoomIdByToken(visitor.token, room._id);\n\n\t\treturn room;\n\t}\n\n\tasync getRoom(\n\t\tguest: ILivechatVisitor,\n\t\tmessage: Pick<IMessage, 'rid' | 'msg' | 'token'>,\n\t\troomInfo: IOmnichannelRoomInfo,\n\t\tagent?: SelectedAgent,\n\t\textraData?: IOmnichannelRoomExtraData,\n\t) {\n\t\tif (!settings.get('Livechat_enabled')) {\n\t\t\tthrow new Meteor.Error('error-omnichannel-is-disabled');\n\t\t}\n\t\tLivechat.logger.debug(`Attempting to find or create a room for visitor ${guest._id}`);\n\t\tconst room = await LivechatRooms.findOneById(message.rid);\n\n\t\tif (room && !room.open) {\n\t\t\tLivechat.logger.debug(`Last room for visitor ${guest._id} closed. Creating new one`);\n\t\t}\n\n\t\tif (!room?.open) {\n\t\t\treturn {\n\t\t\t\troom: await this.createRoom({ visitor: guest, message: message.msg, roomInfo, agent, extraData }),\n\t\t\t\tnewRoom: true,\n\t\t\t};\n\t\t}\n\n\t\tif (room.v.token !== guest.token) {\n\t\t\tLivechat.logger.debug(`Visitor ${guest._id} trying to access another visitor's room`);\n\t\t\tthrow new Meteor.Error('cannot-access-room');\n\t\t}\n\n\t\treturn { room, newRoom: false };\n\t}\n\n\tasync checkOnlineAgents(department?: string, agent?: { agentId: string }, skipFallbackCheck = false): Promise<boolean> {\n\t\tif (agent?.agentId) {\n\t\t\treturn Users.checkOnlineAgents(agent.agentId);\n\t\t}\n\n\t\tif (department) {\n\t\t\tconst onlineForDep = await LivechatDepartmentAgents.checkOnlineForDepartment(department);\n\t\t\tif (onlineForDep || skipFallbackCheck) {\n\t\t\t\treturn onlineForDep;\n\t\t\t}\n\n\t\t\tconst dep = await LivechatDepartment.findOneById<Pick<ILivechatDepartment, '_id' | 'fallbackForwardDepartment'>>(department, {\n\t\t\t\tprojection: { fallbackForwardDepartment: 1 },\n\t\t\t});\n\t\t\tif (!dep?.fallbackForwardDepartment) {\n\t\t\t\treturn onlineForDep;\n\t\t\t}\n\n\t\t\treturn this.checkOnlineAgents(dep?.fallbackForwardDepartment);\n\t\t}\n\n\t\treturn Users.checkOnlineAgents();\n\t}\n\n\tasync removeRoom(rid: string) {\n\t\tLivechat.logger.debug(`Deleting room ${rid}`);\n\t\tcheck(rid, String);\n\t\tconst room = await LivechatRooms.findOneById(rid);\n\t\tif (!room) {\n\t\t\tthrow new Meteor.Error('error-invalid-room', 'Invalid room');\n\t\t}\n\n\t\tconst inquiry = await LivechatInquiry.findOneByRoomId(rid);\n\n\t\tconst result = await Promise.allSettled([\n\t\t\tMessages.removeByRoomId(rid),\n\t\t\tReadReceipts.removeByRoomId(rid),\n\t\t\tSubscriptions.removeByRoomId(rid, {\n\t\t\t\tasync onTrash(doc) {\n\t\t\t\t\tvoid notifyOnSubscriptionChanged(doc, 'removed');\n\t\t\t\t},\n\t\t\t}),\n\t\t\tLivechatInquiry.removeByRoomId(rid),\n\t\t\tLivechatRooms.removeById(rid),\n\t\t]);\n\n\t\tif (result[3]?.status === 'fulfilled' && result[3].value?.deletedCount && inquiry) {\n\t\t\tvoid notifyOnLivechatInquiryChanged(inquiry, 'removed');\n\t\t}\n\n\t\tfor (const r of result) {\n\t\t\tif (r.status === 'rejected') {\n\t\t\t\tthis.logger.error(`Error removing room ${rid}: ${r.reason}`);\n\t\t\t\tthrow new Meteor.Error('error-removing-room', 'Error removing room');\n\t\t\t}\n\t\t}\n\t}\n\n\tisValidObject(obj: unknown): obj is Record<string, any> {\n\t\treturn typeof obj === 'object' && obj !== null;\n\t}\n\n\tasync registerGuest({\n\t\tid,\n\t\ttoken,\n\t\tname,\n\t\tphone,\n\t\temail,\n\t\tdepartment,\n\t\tusername,\n\t\tconnectionData,\n\t\tstatus = UserStatus.ONLINE,\n\t}: RegisterGuestType): Promise<ILivechatVisitor | null> {\n\t\tcheck(token, String);\n\t\tcheck(id, Match.Maybe(String));\n\n\t\tLivechat.logger.debug(`New incoming conversation: id: ${id} | token: ${token}`);\n\n\t\tconst visitorDataToUpdate: Partial<ILivechatVisitor> & { userAgent?: string; ip?: string; host?: string } = {\n\t\t\ttoken,\n\t\t\tstatus,\n\t\t\t...(phone?.number ? { phone: [{ phoneNumber: phone.number }] } : {}),\n\t\t\t...(name ? { name } : {}),\n\t\t};\n\n\t\tif (email) {\n\t\t\tconst visitorEmail = email.trim().toLowerCase();\n\t\t\tvalidateEmail(visitorEmail);\n\t\t\tvisitorDataToUpdate.visitorEmails = [{ address: visitorEmail }];\n\t\t}\n\n\t\tconst livechatVisitor = await LivechatVisitors.getVisitorByToken(token, { projection: { _id: 1 } });\n\n\t\tif (livechatVisitor?.department !== department && department) {\n\t\t\tLivechat.logger.debug(`Attempt to find a department with id/name ${department}`);\n\t\t\tconst dep = await LivechatDepartment.findOneByIdOrName(department, { projection: { _id: 1 } });\n\t\t\tif (!dep) {\n\t\t\t\tLivechat.logger.debug(`Invalid department provided: ${department}`);\n\t\t\t\tthrow new Meteor.Error('error-invalid-department', 'The provided department is invalid');\n\t\t\t}\n\t\t\tLivechat.logger.debug(`Assigning visitor ${token} to department ${dep._id}`);\n\t\t\tvisitorDataToUpdate.department = dep._id;\n\t\t}\n\n\t\tvisitorDataToUpdate.token = livechatVisitor?.token || token;\n\n\t\tlet existingUser = null;\n\n\t\tif (livechatVisitor) {\n\t\t\tLivechat.logger.debug('Found matching user by token');\n\t\t\tvisitorDataToUpdate._id = livechatVisitor._id;\n\t\t} else if (phone?.number && (existingUser = await LivechatVisitors.findOneVisitorByPhone(phone.number))) {\n\t\t\tLivechat.logger.debug('Found matching user by phone number');\n\t\t\tvisitorDataToUpdate._id = existingUser._id;\n\t\t\t// Don't change token when matching by phone number, use current visitor token\n\t\t\tvisitorDataToUpdate.token = existingUser.token;\n\t\t} else if (email && (existingUser = await LivechatVisitors.findOneGuestByEmailAddress(email))) {\n\t\t\tLivechat.logger.debug('Found matching user by email');\n\t\t\tvisitorDataToUpdate._id = existingUser._id;\n\t\t} else if (!livechatVisitor) {\n\t\t\tLivechat.logger.debug(`No matches found. Attempting to create new user with token ${token}`);\n\n\t\t\tvisitorDataToUpdate._id = id || undefined;\n\t\t\tvisitorDataToUpdate.username = username || (await LivechatVisitors.getNextVisitorUsername());\n\t\t\tvisitorDataToUpdate.status = status;\n\t\t\tvisitorDataToUpdate.ts = new Date();\n\n\t\t\tif (settings.get('Livechat_Allow_collect_and_store_HTTP_header_informations') && Livechat.isValidObject(connectionData)) {\n\t\t\t\tLivechat.logger.debug(`Saving connection data for visitor ${token}`);\n\t\t\t\tconst { httpHeaders, clientAddress } = connectionData;\n\t\t\t\tif (Livechat.isValidObject(httpHeaders)) {\n\t\t\t\t\tvisitorDataToUpdate.userAgent = httpHeaders['user-agent'];\n\t\t\t\t\tvisitorDataToUpdate.ip = httpHeaders['x-real-ip'] || httpHeaders['x-forwarded-for'] || clientAddress;\n\t\t\t\t\tvisitorDataToUpdate.host = httpHeaders?.host;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tif (isSingleContactEnabled()) {\n\t\t\tconst contactId = await createContact({\n\t\t\t\tname: name ?? (visitorDataToUpdate.username as string),\n\t\t\t\temails: email ? [email] : [],\n\t\t\t\tphones: phone ? [phone.number] : [],\n\t\t\t\tunknown: true,\n\t\t\t});\n\t\t\tvisitorDataToUpdate.contactId = contactId;\n\t\t}\n\n\t\tconst upsertedLivechatVisitor = await LivechatVisitors.updateOneByIdOrToken(visitorDataToUpdate, {\n\t\t\tupsert: true,\n\t\t\treturnDocument: 'after',\n\t\t});\n\n\t\tif (!upsertedLivechatVisitor.value) {\n\t\t\tLivechat.logger.debug(`No visitor found after upsert`);\n\t\t\treturn null;\n\t\t}\n\n\t\treturn upsertedLivechatVisitor.value;\n\t}\n\n\tprivate async getBotAgents(department?: string) {\n\t\tif (department) {\n\t\t\treturn LivechatDepartmentAgents.getBotsForDepartment(department);\n\t\t}\n\n\t\treturn Users.findBotAgents();\n\t}\n\n\tprivate async resolveChatTags(\n\t\troom: IOmnichannelRoom,\n\t\toptions: CloseRoomParams['options'] = {},\n\t): Promise<{ updatedOptions: CloseRoomParams['options'] }> {\n\t\tthis.logger.debug(`Resolving chat tags for room ${room._id}`);\n\n\t\tconst concatUnique = (...arrays: (string[] | undefined)[]): string[] => [\n\t\t\t...new Set(([] as string[]).concat(...arrays.filter((a): a is string[] => !!a))),\n\t\t];\n\n\t\tconst { departmentId, tags: optionsTags } = room;\n\t\tconst { clientAction, tags: oldRoomTags } = options;\n\t\tconst roomTags = concatUnique(oldRoomTags, optionsTags);\n\n\t\tif (!departmentId) {\n\t\t\treturn {\n\t\t\t\tupdatedOptions: {\n\t\t\t\t\t...options,\n\t\t\t\t\t...(roomTags.length && { tags: roomTags }),\n\t\t\t\t},\n\t\t\t};\n\t\t}\n\n\t\tconst department = await LivechatDepartment.findOneById<Pick<ILivechatDepartment, 'requestTagBeforeClosingChat' | 'chatClosingTags'>>(\n\t\t\tdepartmentId,\n\t\t\t{\n\t\t\t\tprojection: { requestTagBeforeClosingChat: 1, chatClosingTags: 1 },\n\t\t\t},\n\t\t);\n\t\tif (!department) {\n\t\t\treturn {\n\t\t\t\tupdatedOptions: {\n\t\t\t\t\t...options,\n\t\t\t\t\t...(roomTags.length && { tags: roomTags }),\n\t\t\t\t},\n\t\t\t};\n\t\t}\n\n\t\tconst { requestTagBeforeClosingChat, chatClosingTags } = department;\n\t\tconst extraRoomTags = concatUnique(roomTags, chatClosingTags);\n\n\t\tif (!requestTagBeforeClosingChat) {\n\t\t\treturn {\n\t\t\t\tupdatedOptions: {\n\t\t\t\t\t...options,\n\t\t\t\t\t...(extraRoomTags.length && { tags: extraRoomTags }),\n\t\t\t\t},\n\t\t\t};\n\t\t}\n\n\t\tconst checkRoomTags = !clientAction || (roomTags && roomTags.length > 0);\n\t\tconst checkDepartmentTags = chatClosingTags && chatClosingTags.length > 0;\n\t\tif (!checkRoomTags || !checkDepartmentTags) {\n\t\t\tthrow new Error('error-tags-must-be-assigned-before-closing-chat');\n\t\t}\n\n\t\treturn {\n\t\t\tupdatedOptions: {\n\t\t\t\t...options,\n\t\t\t\t...(extraRoomTags.length && { tags: extraRoomTags }),\n\t\t\t},\n\t\t};\n\t}\n\n\tasync sendRequest(\n\t\tpostData: {\n\t\t\ttype: string;\n\t\t\t[key: string]: any;\n\t\t},\n\t\tattempts = 10,\n\t) {\n\t\tif (!attempts) {\n\t\t\tLivechat.logger.error({ msg: 'Omnichannel webhook call failed. Max attempts reached' });\n\t\t\treturn;\n\t\t}\n\t\tconst timeout = settings.get<number>('Livechat_http_timeout');\n\t\tconst secretToken = settings.get<string>('Livechat_secret_token');\n\t\tconst webhookUrl = settings.get<string>('Livechat_webhookUrl');\n\t\ttry {\n\t\t\tLivechat.webhookLogger.debug({ msg: 'Sending webhook request', postData });\n\t\t\tconst result = await fetch(webhookUrl, {\n\t\t\t\tmethod: 'POST',\n\t\t\t\theaders: {\n\t\t\t\t\t...(secretToken && { 'X-RocketChat-Livechat-Token': secretToken }),\n\t\t\t\t},\n\t\t\t\tbody: postData,\n\t\t\t\ttimeout,\n\t\t\t});\n\n\t\t\tif (result.status === 200) {\n\t\t\t\tmetrics.totalLivechatWebhooksSuccess.inc();\n\t\t\t\treturn result;\n\t\t\t}\n\n\t\t\tmetrics.totalLivechatWebhooksFailures.inc();\n\t\t\tthrow new Error(await result.text());\n\t\t} catch (err) {\n\t\t\tconst retryAfter = timeout * 4;\n\t\t\tLivechat.webhookLogger.error({ msg: `Error response on ${11 - attempts} try ->`, err });\n\t\t\t// try 10 times after 20 seconds each\n\t\t\tattempts - 1 &&\n\t\t\t\tLivechat.webhookLogger.warn({ msg: `Webhook call failed. Retrying`, newAttemptAfterSeconds: retryAfter / 1000, webhookUrl });\n\t\t\tsetTimeout(async () => {\n\t\t\t\tawait Livechat.sendRequest(postData, attempts - 1);\n\t\t\t}, retryAfter);\n\t\t}\n\t}\n\n\tasync saveAgentInfo(_id: string, agentData: any, agentDepartments: string[]) {\n\t\tcheck(_id, String);\n\t\tcheck(agentData, Object);\n\t\tcheck(agentDepartments, [String]);\n\n\t\tconst user = await Users.findOneById(_id);\n\t\tif (!user || !(await hasRoleAsync(_id, 'livechat-agent'))) {\n\t\t\tthrow new Meteor.Error('error-user-is-not-agent', 'User is not a livechat agent');\n\t\t}\n\n\t\tawait Users.setLivechatData(_id, agentData);\n\n\t\tconst currentDepartmentsForAgent = await LivechatDepartmentAgents.findByAgentId(_id).toArray();\n\n\t\tconst toRemoveIds = currentDepartmentsForAgent\n\t\t\t.filter((dept) => !agentDepartments.includes(dept.departmentId))\n\t\t\t.map((dept) => dept.departmentId);\n\t\tconst toAddIds = agentDepartments.filter((d) => !currentDepartmentsForAgent.some((c) => c.departmentId === d));\n\n\t\tawait Promise.all(\n\t\t\tawait LivechatDepartment.findInIds([...toRemoveIds, ...toAddIds], {\n\t\t\t\tprojection: {\n\t\t\t\t\t_id: 1,\n\t\t\t\t\tenabled: 1,\n\t\t\t\t},\n\t\t\t})\n\t\t\t\t.map((dep) => {\n\t\t\t\t\treturn updateDepartmentAgents(\n\t\t\t\t\t\tdep._id,\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t...(toRemoveIds.includes(dep._id) ? { remove: [{ agentId: _id }] } : { upsert: [{ agentId: _id, count: 0, order: 0 }] }),\n\t\t\t\t\t\t},\n\t\t\t\t\t\tdep.enabled,\n\t\t\t\t\t);\n\t\t\t\t})\n\t\t\t\t.toArray(),\n\t\t);\n\n\t\treturn true;\n\t}\n\n\tasync updateCallStatus(callId: string, rid: string, status: 'ended' | 'declined', user: IUser | ILivechatVisitor) {\n\t\tawait Rooms.setCallStatus(rid, status);\n\t\tif (status === 'ended' || status === 'declined') {\n\t\t\tif (await VideoConf.declineLivechatCall(callId)) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\treturn updateMessage({ _id: callId, msg: status, actionLinks: [], webRtcCallEndTs: new Date(), rid }, user as unknown as IUser);\n\t\t}\n\t}\n\n\tnotifyRoomVisitorChange(roomId: string, visitor: ILivechatVisitor) {\n\t\tvoid api.broadcast('omnichannel.room', roomId, {\n\t\t\ttype: 'visitorData',\n\t\t\tvisitor,\n\t\t});\n\t}\n\n\tasync changeRoomVisitor(userId: string, room: IOmnichannelRoom, visitor: ILivechatVisitor) {\n\t\tconst user = await Users.findOneById(userId, { projection: { _id: 1 } });\n\t\tif (!user) {\n\t\t\tthrow new Error('error-user-not-found');\n\t\t}\n\n\t\tif (!(await canAccessRoomAsync(room, user))) {\n\t\t\tthrow new Error('error-not-allowed');\n\t\t}\n\n\t\tawait LivechatRooms.changeVisitorByRoomId(room._id, visitor);\n\n\t\tthis.notifyRoomVisitorChange(room._id, visitor);\n\n\t\treturn LivechatRooms.findOneById(room._id);\n\t}\n\n\tasync notifyAgentStatusChanged(userId: string, status?: UserStatus) {\n\t\tif (!status) {\n\t\t\treturn;\n\t\t}\n\n\t\tvoid callbacks.runAsync('livechat.agentStatusChanged', { userId, status });\n\t\tif (!settings.get('Livechat_show_agent_info')) {\n\t\t\treturn;\n\t\t}\n\n\t\tawait LivechatRooms.findOpenByAgent(userId).forEach((room) => {\n\t\t\tvoid api.broadcast('omnichannel.room', room._id, {\n\t\t\t\ttype: 'agentStatus',\n\t\t\t\tstatus,\n\t\t\t});\n\t\t});\n\t}\n\n\tasync updateMessage({ guest, message }: { guest: ILivechatVisitor; message: AtLeast<IMessage, '_id' | 'msg' | 'rid'> }) {\n\t\tcheck(message, Match.ObjectIncluding({ _id: String }));\n\n\t\tconst originalMessage = await Messages.findOneById<Pick<IMessage, 'u' | '_id'>>(message._id, { projection: { u: 1 } });\n\t\tif (!originalMessage?._id) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst editAllowed = settings.get('Message_AllowEditing');\n\t\tconst editOwn = originalMessage.u && originalMessage.u._id === guest._id;\n\n\t\tif (!editAllowed || !editOwn) {\n\t\t\tthrow new Error('error-action-not-allowed');\n\t\t}\n\n\t\t// TODO: Apps sends an `any` object and apparently we just check for _id being present\n\t\t// while updateMessage expects AtLeast<id, msg, rid>\n\t\tawait updateMessage(message, guest as unknown as IUser);\n\n\t\treturn true;\n\t}\n\n\tasync closeOpenChats(userId: string, comment?: string) {\n\t\tthis.logger.debug(`Closing open chats for user ${userId}`);\n\t\tconst user = await Users.findOneById(userId);\n\n\t\tconst extraQuery = await callbacks.run('livechat.applyDepartmentRestrictions', {}, { userId });\n\t\tconst openChats = LivechatRooms.findOpenByAgent(userId, extraQuery);\n\t\tconst promises: Promise<void>[] = [];\n\t\tawait openChats.forEach((room) => {\n\t\t\tpromises.push(this.closeRoom({ user, room, comment }));\n\t\t});\n\n\t\tawait Promise.all(promises);\n\t}\n\n\tasync transfer(room: IOmnichannelRoom, guest: ILivechatVisitor, transferData: TransferData) {\n\t\tthis.logger.debug(`Transfering room ${room._id} [Transfered by: ${transferData?.transferredBy?._id}]`);\n\t\tif (room.onHold) {\n\t\t\tthrow new Error('error-room-onHold');\n\t\t}\n\n\t\tif (transferData.departmentId) {\n\t\t\tconst department = await LivechatDepartment.findOneById<Pick<ILivechatDepartment, 'name' | '_id'>>(transferData.departmentId, {\n\t\t\t\tprojection: { name: 1 },\n\t\t\t});\n\t\t\tif (!department) {\n\t\t\t\tthrow new Error('error-invalid-department');\n\t\t\t}\n\n\t\t\ttransferData.department = department;\n\t\t\tthis.logger.debug(`Transfering room ${room._id} to department ${transferData.department?._id}`);\n\t\t}\n\n\t\treturn RoutingManager.transferRoom(room, guest, transferData);\n\t}\n\n\tasync forwardOpenChats(userId: string) {\n\t\tthis.logger.debug(`Transferring open chats for user ${userId}`);\n\t\tconst user = await Users.findOneById(userId);\n\t\tif (!user) {\n\t\t\tthrow new Error('error-invalid-user');\n\t\t}\n\n\t\tconst { _id, username, name } = user;\n\t\tfor await (const room of LivechatRooms.findOpenByAgent(userId)) {\n\t\t\tconst guest = await LivechatVisitors.findOneEnabledById(room.v._id);\n\t\t\tif (!guest) {\n\t\t\t\tcontinue;\n\t\t\t}\n\n\t\t\tconst transferredBy = normalizeTransferredByData({ _id, username, name }, room);\n\t\t\tawait this.transfer(room, guest, {\n\t\t\t\ttransferredBy,\n\t\t\t\tdepartmentId: guest.department,\n\t\t\t});\n\t\t}\n\t}\n\n\tshowConnecting() {\n\t\treturn RoutingManager.getConfig()?.showConnecting || false;\n\t}\n\n\tasync getInitSettings() {\n\t\tconst validSettings = [\n\t\t\t'Livechat_title',\n\t\t\t'Livechat_title_color',\n\t\t\t'Livechat_enable_message_character_limit',\n\t\t\t'Livechat_message_character_limit',\n\t\t\t'Message_MaxAllowedSize',\n\t\t\t'Livechat_enabled',\n\t\t\t'Livechat_registration_form',\n\t\t\t'Livechat_allow_switching_departments',\n\t\t\t'Livechat_offline_title',\n\t\t\t'Livechat_offline_title_color',\n\t\t\t'Livechat_offline_message',\n\t\t\t'Livechat_offline_success_message',\n\t\t\t'Livechat_offline_form_unavailable',\n\t\t\t'Livechat_display_offline_form',\n\t\t\t'Omnichannel_call_provider',\n\t\t\t'Language',\n\t\t\t'Livechat_enable_transcript',\n\t\t\t'Livechat_transcript_message',\n\t\t\t'Livechat_fileupload_enabled',\n\t\t\t'FileUpload_Enabled',\n\t\t\t'Livechat_conversation_finished_message',\n\t\t\t'Livechat_conversation_finished_text',\n\t\t\t'Livechat_name_field_registration_form',\n\t\t\t'Livechat_email_field_registration_form',\n\t\t\t'Livechat_registration_form_message',\n\t\t\t'Livechat_force_accept_data_processing_consent',\n\t\t\t'Livechat_data_processing_consent_text',\n\t\t\t'Livechat_show_agent_info',\n\t\t\t'Livechat_clear_local_storage_when_chat_ended',\n\t\t\t'Livechat_history_monitor_type',\n\t\t\t'Livechat_hide_system_messages',\n\t\t\t'Livechat_widget_position',\n\t\t\t'Livechat_background',\n\t\t\t'Assets_livechat_widget_logo',\n\t\t\t'Livechat_hide_watermark',\n\t\t\t'Omnichannel_allow_visitors_to_close_conversation',\n\t\t] as const;\n\n\t\ttype SettingTypes = (typeof validSettings)[number] | 'Livechat_Show_Connecting';\n\n\t\tconst rcSettings = validSettings.reduce<Record<SettingTypes, string | boolean>>((acc, setting) => {\n\t\t\tacc[setting] = settings.get(setting);\n\t\t\treturn acc;\n\t\t}, {} as any);\n\n\t\trcSettings.Livechat_Show_Connecting = this.showConnecting();\n\n\t\treturn rcSettings;\n\t}\n\n\tasync sendMessage({\n\t\tguest,\n\t\tmessage,\n\t\troomInfo,\n\t\tagent,\n\t}: {\n\t\tguest: ILivechatVisitor;\n\t\tmessage: ILivechatMessage;\n\t\troomInfo: IOmnichannelRoomInfo;\n\t\tagent?: SelectedAgent;\n\t}) {\n\t\tconst { room, newRoom } = await this.getRoom(guest, message, roomInfo, agent);\n\t\tif (guest.name) {\n\t\t\tmessage.alias = guest.name;\n\t\t}\n\t\treturn Object.assign(await sendMessage(guest, { ...message, token: guest.token }, room), {\n\t\t\tnewRoom,\n\t\t\tshowConnecting: this.showConnecting(),\n\t\t});\n\t}\n\n\tasync removeGuest(_id: string) {\n\t\tconst guest = await LivechatVisitors.findOneEnabledById(_id, { projection: { _id: 1, token: 1 } });\n\t\tif (!guest) {\n\t\t\tthrow new Error('error-invalid-guest');\n\t\t}\n\n\t\tawait this.cleanGuestHistory(guest);\n\t\treturn LivechatVisitors.disableById(_id);\n\t}\n\n\tasync cleanGuestHistory(guest: ILivechatVisitor) {\n\t\tconst { token } = guest;\n\n\t\t// This shouldn't be possible, but just in case\n\t\tif (!token) {\n\t\t\tthrow new Error('error-invalid-guest');\n\t\t}\n\n\t\tconst cursor = LivechatRooms.findByVisitorToken(token);\n\t\tfor await (const room of cursor) {\n\t\t\tawait Promise.all([\n\t\t\t\tSubscriptions.removeByRoomId(room._id, {\n\t\t\t\t\tasync onTrash(doc) {\n\t\t\t\t\t\tvoid notifyOnSubscriptionChanged(doc, 'removed');\n\t\t\t\t\t},\n\t\t\t\t}),\n\t\t\t\tFileUpload.removeFilesByRoomId(room._id),\n\t\t\t\tMessages.removeByRoomId(room._id),\n\t\t\t\tReadReceipts.removeByRoomId(room._id),\n\t\t\t]);\n\t\t}\n\n\t\tawait LivechatRooms.removeByVisitorToken(token);\n\n\t\tconst livechatInquiries = await LivechatInquiry.findIdsByVisitorToken(token).toArray();\n\t\tawait LivechatInquiry.removeByIds(livechatInquiries.map(({ _id }) => _id));\n\t\tvoid notifyOnLivechatInquiryChanged(livechatInquiries, 'removed');\n\t}\n\n\tasync deleteMessage({ guest, message }: { guest: ILivechatVisitor; message: IMessage }) {\n\t\tconst deleteAllowed = settings.get<boolean>('Message_AllowDeleting');\n\t\tconst editOwn = message.u && message.u._id === guest._id;\n\n\t\tif (!deleteAllowed || !editOwn) {\n\t\t\tthrow new Error('error-action-not-allowed');\n\t\t}\n\n\t\tawait deleteMessage(message, guest as unknown as IUser);\n\n\t\treturn true;\n\t}\n\n\tasync setUserStatusLivechatIf(userId: string, status: ILivechatAgentStatus, condition?: Filter<IUser>, fields?: AKeyOf<ILivechatAgent>) {\n\t\tconst result = await Users.setLivechatStatusIf(userId, status, condition, fields);\n\n\t\tif (result.modifiedCount > 0) {\n\t\t\tvoid notifyOnUserChange({\n\t\t\t\tid: userId,\n\t\t\t\tclientAction: 'updated',\n\t\t\t\tdiff: { ...fields, statusLivechat: status },\n\t\t\t});\n\t\t}\n\n\t\tcallbacks.runAsync('livechat.setUserStatusLivechat', { userId, status });\n\t\treturn result;\n\t}\n\n\tasync returnRoomAsInquiry(room: IOmnichannelRoom, departmentId?: string, overrideTransferData: any = {}) {\n\t\tthis.logger.debug({ msg: `Transfering room to ${departmentId ? 'department' : ''} queue`, room });\n\t\tif (!room.open) {\n\t\t\tthrow new Meteor.Error('room-closed');\n\t\t}\n\n\t\tif (room.onHold) {\n\t\t\tthrow new Meteor.Error('error-room-onHold');\n\t\t}\n\n\t\tif (!room.servedBy) {\n\t\t\treturn false;\n\t\t}\n\n\t\tconst user = await Users.findOneById(room.servedBy._id);\n\t\tif (!user?._id) {\n\t\t\tthrow new Meteor.Error('error-invalid-user');\n\t\t}\n\n\t\t// find inquiry corresponding to room\n\t\tconst inquiry = await LivechatInquiry.findOne({ rid: room._id });\n\t\tif (!inquiry) {\n\t\t\treturn false;\n\t\t}\n\n\t\tconst transferredBy = normalizeTransferredByData(user, room);\n\t\tthis.logger.debug(`Transfering room ${room._id} by user ${transferredBy._id}`);\n\t\tconst transferData = { roomId: room._id, scope: 'queue', departmentId, transferredBy, ...overrideTransferData };\n\t\ttry {\n\t\t\tawait this.saveTransferHistory(room, transferData);\n\t\t\tawait RoutingManager.unassignAgent(inquiry, departmentId);\n\t\t} catch (e) {\n\t\t\tthis.logger.error(e);\n\t\t\tthrow new Meteor.Error('error-returning-inquiry');\n\t\t}\n\n\t\tcallbacks.runAsync('livechat:afterReturnRoomAsInquiry', { room });\n\n\t\treturn true;\n\t}\n\n\tasync saveTransferHistory(room: IOmnichannelRoom, transferData: TransferData) {\n\t\tconst { departmentId: previousDepartment } = room;\n\t\tconst { department: nextDepartment, transferredBy, transferredTo, scope, comment } = transferData;\n\n\t\tcheck(\n\t\t\ttransferredBy,\n\t\t\tMatch.ObjectIncluding({\n\t\t\t\t_id: String,\n\t\t\t\tusername: String,\n\t\t\t\tname: Match.Maybe(String),\n\t\t\t\tuserType: String,\n\t\t\t}),\n\t\t);\n\n\t\tconst { _id, username } = transferredBy;\n\t\tconst scopeData = scope || (nextDepartment ? 'department' : 'agent');\n\t\tthis.logger.info(`Storing new chat transfer of ${room._id} [Transfered by: ${_id} to ${scopeData}]`);\n\n\t\tconst transferMessage = {\n\t\t\t...(transferData.transferredBy.userType === 'visitor' && { token: room.v.token }),\n\t\t\ttransferData: {\n\t\t\t\ttransferredBy,\n\t\t\t\tts: new Date(),\n\t\t\t\tscope: scopeData,\n\t\t\t\tcomment,\n\t\t\t\t...(previousDepartment && { previousDepartment }),\n\t\t\t\t...(nextDepartment && { nextDepartment }),\n\t\t\t\t...(transferredTo && { transferredTo }),\n\t\t\t},\n\t\t};\n\n\t\tawait Message.saveSystemMessageAndNotifyUser('livechat_transfer_history', room._id, '', { _id, username }, transferMessage);\n\t}\n\n\tasync saveGuest(guestData: Pick<ILivechatVisitor, '_id' | 'name' | 'livechatData'> & { email?: string; phone?: string }, userId: string) {\n\t\tconst { _id, name, email, phone, livechatData = {} } = guestData;\n\n\t\tconst visitor = await LivechatVisitors.findOneById(_id, { projection: { _id: 1 } });\n\t\tif (!visitor) {\n\t\t\tthrow new Error('error-invalid-visitor');\n\t\t}\n\n\t\tthis.logger.debug({ msg: 'Saving guest', guestData });\n\t\tconst updateData: {\n\t\t\tname?: string | undefined;\n\t\t\tusername?: string | undefined;\n\t\t\temail?: string | undefined;\n\t\t\tphone?: string | undefined;\n\t\t\tlivechatData: {\n\t\t\t\t[k: string]: any;\n\t\t\t};\n\t\t} = { livechatData: {} };\n\n\t\tif (name) {\n\t\t\tupdateData.name = name;\n\t\t}\n\t\tif (email) {\n\t\t\tupdateData.email = email;\n\t\t}\n\t\tif (phone) {\n\t\t\tupdateData.phone = phone;\n\t\t}\n\n\t\tconst customFields: Record<string, any> = {};\n\n\t\tif ((!userId || (await hasPermissionAsync(userId, 'edit-livechat-room-customfields'))) && Object.keys(livechatData).length) {\n\t\t\tthis.logger.debug({ msg: `Saving custom fields for visitor ${_id}`, livechatData });\n\t\t\tfor await (const field of LivechatCustomField.findByScope('visitor')) {\n\t\t\t\tif (!livechatData.hasOwnProperty(field._id)) {\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\t\t\t\tconst value = trim(livechatData[field._id]);\n\t\t\t\tif (value !== '' && field.regexp !== undefined && field.regexp !== '') {\n\t\t\t\t\tconst regexp = new RegExp(field.regexp);\n\t\t\t\t\tif (!regexp.test(value)) {\n\t\t\t\t\t\tthrow new Error(i18n.t('error-invalid-custom-field-value'));\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tcustomFields[field._id] = value;\n\t\t\t}\n\t\t\tupdateData.livechatData = customFields;\n\t\t\tLivechat.logger.debug(`About to update ${Object.keys(customFields).length} custom fields for visitor ${_id}`);\n\t\t}\n\t\tconst ret = await LivechatVisitors.saveGuestById(_id, updateData);\n\n\t\tsetImmediate(() => {\n\t\t\tvoid Apps.self?.triggerEvent(AppEvents.IPostLivechatGuestSaved, _id);\n\t\t});\n\n\t\treturn ret;\n\t}\n\n\tasync setCustomFields({ token, key, value, overwrite }: { key: string; value: string; overwrite: boolean; token: string }) {\n\t\tLivechat.logger.debug(`Setting custom fields data for visitor with token ${token}`);\n\n\t\tconst customField = await LivechatCustomField.findOneById(key);\n\t\tif (!customField) {\n\t\t\tthrow new Error('invalid-custom-field');\n\t\t}\n\n\t\tif (customField.regexp !== undefined && customField.regexp !== '') {\n\t\t\tconst regexp = new RegExp(customField.regexp);\n\t\t\tif (!regexp.test(value)) {\n\t\t\t\tthrow new Error(i18n.t('error-invalid-custom-field-value', { field: key }));\n\t\t\t}\n\t\t}\n\n\t\tlet result;\n\t\tif (customField.scope === 'room') {\n\t\t\tresult = await LivechatRooms.updateDataByToken(token, key, value, overwrite);\n\t\t} else {\n\t\t\tresult = await LivechatVisitors.updateLivechatDataByToken(token, key, value, overwrite);\n\t\t}\n\n\t\tif (typeof result === 'boolean') {\n\t\t\t// Note: this only happens when !overwrite is passed, in this case we don't do any db update\n\t\t\treturn 0;\n\t\t}\n\n\t\treturn result.modifiedCount;\n\t}\n\n\tasync requestTranscript({\n\t\trid,\n\t\temail,\n\t\tsubject,\n\t\tuser,\n\t}: {\n\t\trid: string;\n\t\temail: string;\n\t\tsubject: string;\n\t\tuser: AtLeast<IUser, '_id' | 'username' | 'utcOffset' | 'name'>;\n\t}) {\n\t\tconst room = await LivechatRooms.findOneById(rid, { projection: { _id: 1, open: 1, transcriptRequest: 1 } });\n\n\t\tif (!room?.open) {\n\t\t\tthrow new Meteor.Error('error-invalid-room', 'Invalid room');\n\t\t}\n\n\t\tif (room.transcriptRequest) {\n\t\t\tthrow new Meteor.Error('error-transcript-already-requested', 'Transcript already requested');\n\t\t}\n\n\t\tif (!(await Omnichannel.isWithinMACLimit(room))) {\n\t\t\tthrow new Error('error-mac-limit-reached');\n\t\t}\n\n\t\tconst { _id, username, name, utcOffset } = user;\n\t\tconst transcriptRequest = {\n\t\t\trequestedAt: new Date(),\n\t\t\trequestedBy: {\n\t\t\t\t_id,\n\t\t\t\tusername,\n\t\t\t\tname,\n\t\t\t\tutcOffset,\n\t\t\t},\n\t\t\temail,\n\t\t\tsubject,\n\t\t};\n\n\t\tawait LivechatRooms.setEmailTranscriptRequestedByRoomId(rid, transcriptRequest);\n\t\treturn true;\n\t}\n\n\tasync afterRemoveAgent(user: AtLeast<IUser, '_id' | 'username'>) {\n\t\tawait callbacks.run('livechat.afterAgentRemoved', { agent: user });\n\t\treturn true;\n\t}\n\n\tasync removeAgent(username: string) {\n\t\tconst user = await Users.findOneByUsername(username, { projection: { _id: 1, username: 1 } });\n\n\t\tif (!user) {\n\t\t\tthrow new Error('error-invalid-user');\n\t\t}\n\n\t\tconst { _id } = user;\n\n\t\tif (await removeUserFromRolesAsync(_id, ['livechat-agent'])) {\n\t\t\treturn this.afterRemoveAgent(user);\n\t\t}\n\n\t\treturn false;\n\t}\n\n\tasync removeManager(username: string) {\n\t\tconst user = await Users.findOneByUsername(username, { projection: { _id: 1 } });\n\n\t\tif (!user) {\n\t\t\tthrow new Error('error-invalid-user');\n\t\t}\n\n\t\treturn removeUserFromRolesAsync(user._id, ['livechat-manager']);\n\t}\n\n\tasync getLivechatRoomGuestInfo(room: IOmnichannelRoom) {\n\t\tconst visitor = await LivechatVisitors.findOneEnabledById(room.v._id);\n\t\tif (!visitor) {\n\t\t\tthrow new Error('error-invalid-visitor');\n\t\t}\n\n\t\tconst agent = room.servedBy?._id ? await Users.findOneById(room.servedBy?._id) : null;\n\n\t\tconst ua = new UAParser();\n\t\tua.setUA(visitor.userAgent || '');\n\n\t\tconst postData: ICRMData = {\n\t\t\t_id: room._id,\n\t\t\tlabel: room.fname || room.label, // using same field for compatibility\n\t\t\ttopic: room.topic,\n\t\t\tcreatedAt: room.ts,\n\t\t\tlastMessageAt: room.lm,\n\t\t\ttags: room.tags,\n\t\t\tcustomFields: room.livechatData,\n\t\t\tvisitor: {\n\t\t\t\t_id: visitor._id,\n\t\t\t\ttoken: visitor.token,\n\t\t\t\tname: visitor.name,\n\t\t\t\tusername: visitor.username,\n\t\t\t\tdepartment: visitor.department,\n\t\t\t\tip: visitor.ip,\n\t\t\t\tos: ua.getOS().name && `${ua.getOS().name} ${ua.getOS().version}`,\n\t\t\t\tbrowser: ua.getBrowser().name && `${ua.getBrowser().name} ${ua.getBrowser().version}`,\n\t\t\t\tcustomFields: visitor.livechatData,\n\t\t\t},\n\t\t};\n\n\t\tif (agent) {\n\t\t\tconst customFields = parseAgentCustomFields(agent.customFields);\n\n\t\t\tpostData.agent = {\n\t\t\t\t_id: agent._id,\n\t\t\t\tusername: agent.username,\n\t\t\t\tname: agent.name,\n\t\t\t\t...(customFields && { customFields }),\n\t\t\t};\n\n\t\t\tif (agent.emails && agent.emails.length > 0) {\n\t\t\t\tpostData.agent.email = agent.emails[0].address;\n\t\t\t}\n\t\t}\n\n\t\tif (room.crmData) {\n\t\t\tpostData.crmData = room.crmData;\n\t\t}\n\n\t\tif (visitor.visitorEmails && visitor.visitorEmails.length > 0) {\n\t\t\tpostData.visitor.email = visitor.visitorEmails;\n\t\t}\n\t\tif (visitor.phone && visitor.phone.length > 0) {\n\t\t\tpostData.visitor.phone = visitor.phone;\n\t\t}\n\n\t\treturn postData;\n\t}\n\n\tasync allowAgentChangeServiceStatus(statusLivechat: ILivechatAgentStatus, agentId: string) {\n\t\tif (statusLivechat !== ILivechatAgentStatus.AVAILABLE) {\n\t\t\treturn true;\n\t\t}\n\n\t\treturn businessHourManager.allowAgentChangeServiceStatus(agentId);\n\t}\n\n\tasync notifyGuestStatusChanged(token: string, status: UserStatus) {\n\t\tawait LivechatRooms.updateVisitorStatus(token, status);\n\n\t\tconst inquiryVisitorStatus = await LivechatInquiry.updateVisitorStatus(token, status);\n\n\t\tif (inquiryVisitorStatus.modifiedCount) {\n\t\t\tvoid notifyOnLivechatInquiryChangedByToken(token, 'updated', { v: { status } });\n\t\t}\n\t}\n\n\tasync setUserStatusLivechat(userId: string, status: ILivechatAgentStatus) {\n\t\tconst user = await Users.setLivechatStatus(userId, status);\n\t\tcallbacks.runAsync('livechat.setUserStatusLivechat', { userId, status });\n\n\t\tif (user.modifiedCount > 0) {\n\t\t\tvoid notifyOnUserChange({\n\t\t\t\tid: userId,\n\t\t\t\tclientAction: 'updated',\n\t\t\t\tdiff: {\n\t\t\t\t\tstatusLivechat: status,\n\t\t\t\t\tlivechatStatusSystemModified: false,\n\t\t\t\t},\n\t\t\t});\n\t\t}\n\n\t\treturn user;\n\t}\n\n\tasync afterAgentAdded(user: IUser) {\n\t\tawait Promise.all([\n\t\t\tUsers.setOperator(user._id, true),\n\t\t\tthis.setUserStatusLivechat(user._id, user.status !== 'offline' ? ILivechatAgentStatus.AVAILABLE : ILivechatAgentStatus.NOT_AVAILABLE),\n\t\t]);\n\t\tcallbacks.runAsync('livechat.onNewAgentCreated', user._id);\n\n\t\treturn user;\n\t}\n\n\tasync addAgent(username: string) {\n\t\tcheck(username, String);\n\n\t\tconst user = await Users.findOneByUsername(username, { projection: { _id: 1, username: 1 } });\n\n\t\tif (!user) {\n\t\t\tthrow new Meteor.Error('error-invalid-user');\n\t\t}\n\n\t\tif (await addUserRolesAsync(user._id, ['livechat-agent'])) {\n\t\t\treturn this.afterAgentAdded(user);\n\t\t}\n\n\t\treturn false;\n\t}\n\n\tasync afterAgentUserActivated(user: IUser) {\n\t\tif (!user.roles.includes('livechat-agent')) {\n\t\t\tthrow new Error('invalid-user-role');\n\t\t}\n\t\tawait Users.setOperator(user._id, true);\n\t\tcallbacks.runAsync('livechat.onNewAgentCreated', user._id);\n\t}\n\n\tasync addManager(username: string) {\n\t\tcheck(username, String);\n\n\t\tconst user = await Users.findOneByUsername(username, { projection: { _id: 1, username: 1 } });\n\n\t\tif (!user) {\n\t\t\tthrow new Meteor.Error('error-invalid-user');\n\t\t}\n\n\t\tif (await addUserRolesAsync(user._id, ['livechat-manager'])) {\n\t\t\treturn user;\n\t\t}\n\n\t\treturn false;\n\t}\n\n\tasync saveRoomInfo(\n\t\troomData: {\n\t\t\t_id: string;\n\t\t\ttopic?: string;\n\t\t\ttags?: string[];\n\t\t\tlivechatData?: { [k: string]: string };\n\t\t\t// For priority and SLA, if the value is blank (ie \"\"), then system will remove the priority or SLA from the room\n\t\t\tpriorityId?: string;\n\t\t\tslaId?: string;\n\t\t},\n\t\tguestData?: {\n\t\t\t_id: string;\n\t\t\tname?: string;\n\t\t\temail?: string;\n\t\t\tphone?: string;\n\t\t\tlivechatData?: { [k: string]: string };\n\t\t},\n\t\tuserId?: string,\n\t) {\n\t\tthis.logger.debug(`Saving room information on room ${roomData._id}`);\n\t\tconst { livechatData = {} } = roomData;\n\t\tconst customFields: Record<string, string> = {};\n\n\t\tif ((!userId || (await hasPermissionAsync(userId, 'edit-livechat-room-customfields'))) && Object.keys(livechatData).length) {\n\t\t\tconst fields = LivechatCustomField.findByScope('room');\n\t\t\tfor await (const field of fields) {\n\t\t\t\tif (!livechatData.hasOwnProperty(field._id)) {\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\t\t\t\tconst value = trim(livechatData[field._id]);\n\t\t\t\tif (value !== '' && field.regexp !== undefined && field.regexp !== '') {\n\t\t\t\t\tconst regexp = new RegExp(field.regexp);\n\t\t\t\t\tif (!regexp.test(value)) {\n\t\t\t\t\t\tthrow new Meteor.Error(i18n.t('error-invalid-custom-field-value', { field: field.label }));\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tcustomFields[field._id] = value;\n\t\t\t}\n\t\t\troomData.livechatData = customFields;\n\t\t\tLivechat.logger.debug(`About to update ${Object.keys(customFields).length} custom fields on room ${roomData._id}`);\n\t\t}\n\n\t\tawait LivechatRooms.saveRoomById(roomData);\n\n\t\tsetImmediate(() => {\n\t\t\tvoid Apps.self?.triggerEvent(AppEvents.IPostLivechatRoomSaved, roomData._id);\n\t\t});\n\n\t\tif (guestData?.name?.trim().length) {\n\t\t\tconst { _id: rid } = roomData;\n\t\t\tconst { name } = guestData;\n\n\t\t\tconst responses = await Promise.all([\n\t\t\t\tRooms.setFnameById(rid, name),\n\t\t\t\tLivechatInquiry.setNameByRoomId(rid, name),\n\t\t\t\tSubscriptions.updateDisplayNameByRoomId(rid, name),\n\t\t\t]);\n\n\t\t\tif (responses[1]?.modifiedCount) {\n\t\t\t\tvoid notifyOnLivechatInquiryChangedByRoom(rid, 'updated', { name });\n\t\t\t}\n\n\t\t\tif (responses[2]?.modifiedCount) {\n\t\t\t\tawait notifyOnSubscriptionChangedByRoomId(rid);\n\t\t\t}\n\t\t}\n\n\t\tvoid notifyOnRoomChangedById(roomData._id);\n\n\t\treturn true;\n\t}\n}\n\nexport const Livechat = new LivechatClass();\n"]},"targets":{"android":"125.0.0","chrome":"125.0.0","edge":"125.0.0","firefox":"115.0.0","ie":"10.0.0","ios":"17.4.0","opera":"110.0.0","opera_mobile":"80.0.0","safari":"17.4.0","samsung":"24.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor","root":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":false,"enforceStrictMode":false,"dynamicImport":true,"generateLetDeclarations":true,"topLevelAwait":true},"externalDependencies":[]},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"version":"7.17.2","helpers":true,"useESModules":false,"corejs":false},"externalDependencies":[]},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-async-generator-functions","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-class-properties","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true},"externalDependencies":[]},{"key":"transform-react-jsx","visitor":{"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXFragment":{"exit":[null]},"JSXElement":{"exit":[null]},"JSXAttribute":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false},"externalDependencies":[]},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-nullish-coalescing-operator","visitor":{"LogicalExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-optional-chaining","visitor":{"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-optional-catch-binding","visitor":{"CatchClause":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-class-properties","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-async-generator-functions","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-logical-assignment-operators","visitor":{"AssignmentExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]}],"presets":[],"generatorOpts":{"filename":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/app/livechat/server/lib/LivechatTyped.ts","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"app/livechat/server/lib/LivechatTyped.ts","inputSourceMap":{"version":3,"file":"app/livechat/server/lib/LivechatTyped.ts","sourceRoot":"","sources":["app/livechat/server/lib/LivechatTyped.ts"],"names":[],"mappings":"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","sourcesContent":["import { Apps, AppEvents } from '@rocket.chat/apps';\nimport { Message, VideoConf, api, Omnichannel } from '@rocket.chat/core-services';\nimport type {\n\tIOmnichannelRoom,\n\tIOmnichannelRoomClosingInfo,\n\tIUser,\n\tILivechatVisitor,\n\tSelectedAgent,\n\tILivechatAgent,\n\tIMessage,\n\tILivechatDepartment,\n\tAtLeast,\n\tTransferData,\n\tIOmnichannelAgent,\n\tILivechatInquiryRecord,\n\tILivechatContact,\n\tILivechatContactChannel,\n\tIOmnichannelRoomInfo,\n\tIOmnichannelRoomExtraData,\n} from '@rocket.chat/core-typings';\nimport { OmnichannelSourceType, ILivechatAgentStatus, UserStatus, isOmnichannelRoom } from '@rocket.chat/core-typings';\nimport { Logger, type MainLogger } from '@rocket.chat/logger';\nimport {\n\tLivechatDepartment,\n\tLivechatInquiry,\n\tLivechatRooms,\n\tSubscriptions,\n\tLivechatVisitors,\n\tMessages,\n\tUsers,\n\tLivechatDepartmentAgents,\n\tReadReceipts,\n\tRooms,\n\tLivechatCustomField,\n\tLivechatContacts,\n} from '@rocket.chat/models';\nimport { serverFetch as fetch } from '@rocket.chat/server-fetch';\nimport { Match, check } from 'meteor/check';\nimport { Meteor } from 'meteor/meteor';\nimport type { Filter, ClientSession, MongoError } from 'mongodb';\nimport UAParser from 'ua-parser-js';\n\nimport { callbacks } from '../../../../lib/callbacks';\nimport { trim } from '../../../../lib/utils/stringUtils';\nimport { client } from '../../../../server/database/utils';\nimport { i18n } from '../../../../server/lib/i18n';\nimport { addUserRolesAsync } from '../../../../server/lib/roles/addUserRoles';\nimport { removeUserFromRolesAsync } from '../../../../server/lib/roles/removeUserFromRoles';\nimport { canAccessRoomAsync } from '../../../authorization/server';\nimport { hasPermissionAsync } from '../../../authorization/server/functions/hasPermission';\nimport { hasRoleAsync } from '../../../authorization/server/functions/hasRole';\nimport { FileUpload } from '../../../file-upload/server';\nimport { deleteMessage } from '../../../lib/server/functions/deleteMessage';\nimport { sendMessage } from '../../../lib/server/functions/sendMessage';\nimport { updateMessage } from '../../../lib/server/functions/updateMessage';\nimport {\n\tnotifyOnLivechatInquiryChanged,\n\tnotifyOnLivechatInquiryChangedByRoom,\n\tnotifyOnRoomChangedById,\n\tnotifyOnLivechatInquiryChangedByToken,\n\tnotifyOnUserChange,\n\tnotifyOnSubscriptionChangedByRoomId,\n\tnotifyOnSubscriptionChanged,\n} from '../../../lib/server/lib/notifyListener';\nimport { metrics } from '../../../metrics/server';\nimport { settings } from '../../../settings/server';\nimport { businessHourManager } from '../business-hour';\nimport { createContact, createContactFromVisitor, isSingleContactEnabled } from './Contacts';\nimport { parseAgentCustomFields, updateDepartmentAgents, validateEmail, normalizeTransferredByData } from './Helper';\nimport { QueueManager } from './QueueManager';\nimport { RoutingManager } from './RoutingManager';\nimport { getRequiredDepartment } from './departmentsLib';\nimport type { CloseRoomParams, CloseRoomParamsByUser, CloseRoomParamsByVisitor, ILivechatMessage } from './localTypes';\nimport { parseTranscriptRequest } from './parseTranscriptRequest';\n\ntype RegisterGuestType = Partial<Pick<ILivechatVisitor, 'token' | 'name' | 'department' | 'status' | 'username'>> & {\n\tid?: string;\n\tconnectionData?: any;\n\temail?: string;\n\tphone?: { number: string };\n};\n\ntype AKeyOf<T> = {\n\t[K in keyof T]?: T[K];\n};\n\ntype ICRMData = {\n\t_id: string;\n\tlabel?: string;\n\ttopic?: string;\n\tcreatedAt: Date;\n\tlastMessageAt?: Date;\n\ttags?: string[];\n\tcustomFields?: IOmnichannelRoom['livechatData'];\n\tvisitor: Pick<ILivechatVisitor, '_id' | 'token' | 'name' | 'username' | 'department' | 'phone' | 'ip'> & {\n\t\temail?: ILivechatVisitor['visitorEmails'];\n\t\tos?: string;\n\t\tbrowser?: string;\n\t\tcustomFields: ILivechatVisitor['livechatData'];\n\t};\n\tagent?: Pick<IOmnichannelAgent, '_id' | 'username' | 'name' | 'customFields'> & {\n\t\temail?: NonNullable<IOmnichannelAgent['emails']>[number]['address'];\n\t};\n\tcrmData?: IOmnichannelRoom['crmData'];\n};\n\ntype ChatCloser = { _id: string; username: string | undefined };\n\nconst isRoomClosedByUserParams = (params: CloseRoomParams): params is CloseRoomParamsByUser =>\n\t(params as CloseRoomParamsByUser).user !== undefined;\nconst isRoomClosedByVisitorParams = (params: CloseRoomParams): params is CloseRoomParamsByVisitor =>\n\t(params as CloseRoomParamsByVisitor).visitor !== undefined;\n\nclass LivechatClass {\n\tlogger: Logger;\n\n\twebhookLogger: MainLogger;\n\n\tconstructor() {\n\t\tthis.logger = new Logger('Livechat');\n\t\tthis.webhookLogger = this.logger.section('Webhook');\n\t}\n\n\tasync online(department?: string, skipNoAgentSetting = false, skipFallbackCheck = false): Promise<boolean> {\n\t\tLivechat.logger.debug(`Checking online agents ${department ? `for department ${department}` : ''}`);\n\t\tif (!skipNoAgentSetting && settings.get('Livechat_accept_chats_with_no_agents')) {\n\t\t\tLivechat.logger.debug('Can accept without online agents: true');\n\t\t\treturn true;\n\t\t}\n\n\t\tif (settings.get('Livechat_assign_new_conversation_to_bot')) {\n\t\t\tLivechat.logger.debug(`Fetching online bot agents for department ${department}`);\n\t\t\tconst botAgents = await Livechat.getBotAgents(department);\n\t\t\tif (botAgents) {\n\t\t\t\tconst onlineBots = await botAgents.count();\n\t\t\t\tthis.logger.debug(`Found ${onlineBots} online`);\n\t\t\t\tif (onlineBots > 0) {\n\t\t\t\t\treturn true;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tconst agentsOnline = await this.checkOnlineAgents(department, undefined, skipFallbackCheck);\n\t\tLivechat.logger.debug(`Are online agents ${department ? `for department ${department}` : ''}?: ${agentsOnline}`);\n\t\treturn agentsOnline;\n\t}\n\n\tasync closeRoom(params: CloseRoomParams, attempts = 2): Promise<void> {\n\t\tlet newRoom: IOmnichannelRoom;\n\t\tlet chatCloser: ChatCloser;\n\t\tlet removedInquiryObj: ILivechatInquiryRecord | null;\n\n\t\tconst session = client.startSession();\n\t\ttry {\n\t\t\tsession.startTransaction();\n\t\t\tconst { room, closedBy, removedInquiry } = await this.doCloseRoom(params, session);\n\t\t\tawait session.commitTransaction();\n\n\t\t\tnewRoom = room;\n\t\t\tchatCloser = closedBy;\n\t\t\tremovedInquiryObj = removedInquiry;\n\t\t} catch (e) {\n\t\t\tthis.logger.error({ err: e, msg: 'Failed to close room', afterAttempts: attempts });\n\t\t\tawait session.abortTransaction();\n\t\t\t// Dont propagate transaction errors\n\t\t\tif (\n\t\t\t\t(e as unknown as MongoError)?.errorLabels?.includes('UnknownTransactionCommitResult') ||\n\t\t\t\t(e as unknown as MongoError)?.errorLabels?.includes('TransientTransactionError')\n\t\t\t) {\n\t\t\t\tif (attempts > 0) {\n\t\t\t\t\tthis.logger.debug(`Retrying close room because of transient error. Attempts left: ${attempts}`);\n\t\t\t\t\treturn this.closeRoom(params, attempts - 1);\n\t\t\t\t}\n\n\t\t\t\tthrow new Error('error-room-cannot-be-closed-try-again');\n\t\t\t}\n\t\t\tthrow e;\n\t\t} finally {\n\t\t\tawait session.endSession();\n\t\t}\n\n\t\t// Note: when reaching this point, the room has been closed\n\t\t// Transaction is commited and so these messages can be sent here.\n\t\treturn this.afterRoomClosed(newRoom, chatCloser, removedInquiryObj, params);\n\t}\n\n\tasync afterRoomClosed(\n\t\tnewRoom: IOmnichannelRoom,\n\t\tchatCloser: ChatCloser,\n\t\tinquiry: ILivechatInquiryRecord | null,\n\t\tparams: CloseRoomParams,\n\t): Promise<void> {\n\t\tif (!chatCloser) {\n\t\t\t// this should never happen\n\t\t\treturn;\n\t\t}\n\t\t// Note: we are okay with these messages being sent outside of the transaction. The process of sending a message\n\t\t// is huge and involves multiple db calls. Making it transactionable this way would be really hard.\n\t\t// And passing just _some_ actions to the transaction creates some deadlocks since messages are updated in the afterSaveMessages callbacks.\n\t\tconst transcriptRequested =\n\t\t\t!!params.room.transcriptRequest || (!settings.get('Livechat_enable_transcript') && settings.get('Livechat_transcript_send_always'));\n\t\tthis.logger.debug(`Sending closing message to room ${newRoom._id}`);\n\t\tawait Message.saveSystemMessageAndNotifyUser('livechat-close', newRoom._id, params.comment ?? '', chatCloser, {\n\t\t\tgroupable: false,\n\t\t\ttranscriptRequested,\n\t\t\t...(isRoomClosedByVisitorParams(params) && { token: params.visitor.token }),\n\t\t});\n\n\t\tif (settings.get('Livechat_enable_transcript') && !settings.get('Livechat_transcript_send_always')) {\n\t\t\tawait Message.saveSystemMessage('command', newRoom._id, 'promptTranscript', chatCloser);\n\t\t}\n\n\t\tthis.logger.debug(`Running callbacks for room ${newRoom._id}`);\n\n\t\tprocess.nextTick(() => {\n\t\t\t/**\n\t\t\t * @deprecated the `AppEvents.ILivechatRoomClosedHandler` event will be removed\n\t\t\t * in the next major version of the Apps-Engine\n\t\t\t */\n\t\t\tvoid Apps.self?.getBridges()?.getListenerBridge().livechatEvent(AppEvents.ILivechatRoomClosedHandler, newRoom);\n\t\t\tvoid Apps.self?.getBridges()?.getListenerBridge().livechatEvent(AppEvents.IPostLivechatRoomClosed, newRoom);\n\t\t});\n\n\t\tconst visitor = isRoomClosedByVisitorParams(params) ? params.visitor : undefined;\n\t\tconst opts = await parseTranscriptRequest(params.room, params.options, visitor);\n\t\tif (process.env.TEST_MODE) {\n\t\t\tawait callbacks.run('livechat.closeRoom', {\n\t\t\t\troom: newRoom,\n\t\t\t\toptions: opts,\n\t\t\t});\n\t\t} else {\n\t\t\tcallbacks.runAsync('livechat.closeRoom', {\n\t\t\t\troom: newRoom,\n\t\t\t\toptions: opts,\n\t\t\t});\n\t\t}\n\n\t\tvoid notifyOnRoomChangedById(newRoom._id);\n\t\tif (inquiry) {\n\t\t\tvoid notifyOnLivechatInquiryChanged(inquiry, 'removed');\n\t\t}\n\n\t\tthis.logger.debug(`Room ${newRoom._id} was closed`);\n\t}\n\n\tasync doCloseRoom(\n\t\tparams: CloseRoomParams,\n\t\tsession: ClientSession,\n\t): Promise<{ room: IOmnichannelRoom; closedBy: ChatCloser; removedInquiry: ILivechatInquiryRecord | null }> {\n\t\tconst { comment } = params;\n\t\tconst { room } = params;\n\n\t\tthis.logger.debug(`Attempting to close room ${room._id}`);\n\t\tif (!room || !isOmnichannelRoom(room) || !room.open) {\n\t\t\tthis.logger.debug(`Room ${room._id} is not open`);\n\t\t\tthrow new Error('error-room-closed');\n\t\t}\n\n\t\tconst commentRequired = settings.get('Livechat_request_comment_when_closing_conversation');\n\t\tif (commentRequired && !comment?.trim()) {\n\t\t\tthrow new Error('error-comment-is-required');\n\t\t}\n\n\t\tconst { updatedOptions: options } = await this.resolveChatTags(room, params.options);\n\t\tthis.logger.debug(`Resolved chat tags for room ${room._id}`);\n\n\t\tconst now = new Date();\n\t\tconst { _id: rid, servedBy } = room;\n\t\tconst serviceTimeDuration = servedBy && (now.getTime() - new Date(servedBy.ts).getTime()) / 1000;\n\n\t\tconst closeData: IOmnichannelRoomClosingInfo = {\n\t\t\tclosedAt: now,\n\t\t\tchatDuration: (now.getTime() - new Date(room.ts).getTime()) / 1000,\n\t\t\t...(serviceTimeDuration && { serviceTimeDuration }),\n\t\t\t...options,\n\t\t};\n\t\tthis.logger.debug(`Room ${room._id} was closed at ${closeData.closedAt} (duration ${closeData.chatDuration})`);\n\n\t\tif (isRoomClosedByUserParams(params)) {\n\t\t\tconst { user } = params;\n\t\t\tthis.logger.debug(`Closing by user ${user?._id}`);\n\t\t\tcloseData.closer = 'user';\n\t\t\tcloseData.closedBy = {\n\t\t\t\t_id: user?._id || '',\n\t\t\t\tusername: user?.username,\n\t\t\t};\n\t\t} else if (isRoomClosedByVisitorParams(params)) {\n\t\t\tconst { visitor } = params;\n\t\t\tthis.logger.debug(`Closing by visitor ${params.visitor._id}`);\n\t\t\tcloseData.closer = 'visitor';\n\t\t\tcloseData.closedBy = {\n\t\t\t\t_id: visitor._id,\n\t\t\t\tusername: visitor.username,\n\t\t\t};\n\t\t} else {\n\t\t\tthrow new Error('Error: Please provide details of the user or visitor who closed the room');\n\t\t}\n\n\t\tthis.logger.debug(`Updating DB for room ${room._id} with close data`);\n\n\t\tconst inquiry = await LivechatInquiry.findOneByRoomId(rid, { session });\n\t\tconst removedInquiry = await LivechatInquiry.removeByRoomId(rid, { session });\n\t\tif (removedInquiry && removedInquiry.deletedCount !== 1) {\n\t\t\tthrow new Error('Error removing inquiry');\n\t\t}\n\n\t\tconst updatedRoom = await LivechatRooms.closeRoomById(rid, closeData, { session });\n\t\tif (!updatedRoom || updatedRoom.modifiedCount !== 1) {\n\t\t\tthrow new Error('Error closing room');\n\t\t}\n\n\t\tconst subs = await Subscriptions.countByRoomId(rid, { session });\n\t\tconst removedSubs = await Subscriptions.removeByRoomId(rid, {\n\t\t\tasync onTrash(doc) {\n\t\t\t\tvoid notifyOnSubscriptionChanged(doc, 'removed');\n\t\t\t},\n\t\t\tsession,\n\t\t});\n\n\t\tif (removedSubs.deletedCount !== subs) {\n\t\t\tthrow new Error('Error removing subscriptions');\n\t\t}\n\n\t\tthis.logger.debug(`DB updated for room ${room._id}`);\n\n\t\t// Retrieve the closed room\n\t\tconst newRoom = await LivechatRooms.findOneById(rid, { session });\n\t\tif (!newRoom) {\n\t\t\tthrow new Error('Error: Room not found');\n\t\t}\n\n\t\treturn { room: newRoom, closedBy: closeData.closedBy, removedInquiry: inquiry };\n\t}\n\n\tasync createRoom({\n\t\tvisitor,\n\t\tmessage,\n\t\trid,\n\t\troomInfo,\n\t\tagent,\n\t\textraData,\n\t}: {\n\t\tvisitor: ILivechatVisitor;\n\t\tmessage?: string;\n\t\trid?: string;\n\t\troomInfo: IOmnichannelRoomInfo;\n\t\tagent?: SelectedAgent;\n\t\textraData?: IOmnichannelRoomExtraData;\n\t}) {\n\t\tif (!settings.get('Livechat_enabled')) {\n\t\t\tthrow new Meteor.Error('error-omnichannel-is-disabled');\n\t\t}\n\n\t\tconst defaultAgent = await callbacks.run('livechat.checkDefaultAgentOnNewRoom', agent, visitor);\n\t\t// if no department selected verify if there is at least one active and pick the first\n\t\tif (!defaultAgent && !visitor.department) {\n\t\t\tconst department = await getRequiredDepartment();\n\t\t\tLivechat.logger.debug(`No department or default agent selected for ${visitor._id}`);\n\n\t\t\tif (department) {\n\t\t\t\tLivechat.logger.debug(`Assigning ${visitor._id} to department ${department._id}`);\n\t\t\t\tvisitor.department = department._id;\n\t\t\t}\n\t\t}\n\n\t\t// delegate room creation to QueueManager\n\t\tLivechat.logger.debug(`Calling QueueManager to request a room for visitor ${visitor._id}`);\n\n\t\tconst room = await QueueManager.requestRoom({\n\t\t\tguest: visitor,\n\t\t\tmessage,\n\t\t\trid,\n\t\t\troomInfo,\n\t\t\tagent: defaultAgent,\n\t\t\textraData,\n\t\t});\n\n\t\tif (isSingleContactEnabled()) {\n\t\t\tlet { contactId } = visitor;\n\n\t\t\tif (!contactId) {\n\t\t\t\tconst visitorContact = await LivechatVisitors.findOne<\n\t\t\t\t\tPick<ILivechatVisitor, 'name' | 'contactManager' | 'livechatData' | 'phone' | 'visitorEmails' | 'username' | 'contactId'>\n\t\t\t\t>(visitor._id, {\n\t\t\t\t\tprojection: {\n\t\t\t\t\t\tname: 1,\n\t\t\t\t\t\tcontactManager: 1,\n\t\t\t\t\t\tlivechatData: 1,\n\t\t\t\t\t\tphone: 1,\n\t\t\t\t\t\tvisitorEmails: 1,\n\t\t\t\t\t\tusername: 1,\n\t\t\t\t\t\tcontactId: 1,\n\t\t\t\t\t},\n\t\t\t\t});\n\n\t\t\t\tcontactId = visitorContact?.contactId;\n\t\t\t}\n\n\t\t\tif (!contactId) {\n\t\t\t\t// ensure that old visitors have a contact\n\t\t\t\tcontactId = await createContactFromVisitor(visitor);\n\t\t\t}\n\n\t\t\tconst contact = await LivechatContacts.findOneById<Pick<ILivechatContact, '_id' | 'channels'>>(contactId, {\n\t\t\t\tprojection: { _id: 1, channels: 1 },\n\t\t\t});\n\n\t\t\tif (contact) {\n\t\t\t\tconst channel = contact.channels?.find(\n\t\t\t\t\t(channel: ILivechatContactChannel) => channel.name === roomInfo.source?.type && channel.visitorId === visitor._id,\n\t\t\t\t);\n\n\t\t\t\tif (!channel) {\n\t\t\t\t\tLivechat.logger.debug(`Adding channel for contact ${contact._id}`);\n\n\t\t\t\t\tawait LivechatContacts.addChannel(contact._id, {\n\t\t\t\t\t\tname: roomInfo.source?.label || roomInfo.source?.type.toString() || OmnichannelSourceType.OTHER,\n\t\t\t\t\t\tvisitorId: visitor._id,\n\t\t\t\t\t\tblocked: false,\n\t\t\t\t\t\tverified: false,\n\t\t\t\t\t\tdetails: roomInfo.source,\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tLivechat.logger.debug(`Room obtained for visitor ${visitor._id} -> ${room._id}`);\n\n\t\tawait Messages.setRoomIdByToken(visitor.token, room._id);\n\n\t\treturn room;\n\t}\n\n\tasync getRoom(\n\t\tguest: ILivechatVisitor,\n\t\tmessage: Pick<IMessage, 'rid' | 'msg' | 'token'>,\n\t\troomInfo: IOmnichannelRoomInfo,\n\t\tagent?: SelectedAgent,\n\t\textraData?: IOmnichannelRoomExtraData,\n\t) {\n\t\tif (!settings.get('Livechat_enabled')) {\n\t\t\tthrow new Meteor.Error('error-omnichannel-is-disabled');\n\t\t}\n\t\tLivechat.logger.debug(`Attempting to find or create a room for visitor ${guest._id}`);\n\t\tconst room = await LivechatRooms.findOneById(message.rid);\n\n\t\tif (room && !room.open) {\n\t\t\tLivechat.logger.debug(`Last room for visitor ${guest._id} closed. Creating new one`);\n\t\t}\n\n\t\tif (!room?.open) {\n\t\t\treturn {\n\t\t\t\troom: await this.createRoom({ visitor: guest, message: message.msg, roomInfo, agent, extraData }),\n\t\t\t\tnewRoom: true,\n\t\t\t};\n\t\t}\n\n\t\tif (room.v.token !== guest.token) {\n\t\t\tLivechat.logger.debug(`Visitor ${guest._id} trying to access another visitor's room`);\n\t\t\tthrow new Meteor.Error('cannot-access-room');\n\t\t}\n\n\t\treturn { room, newRoom: false };\n\t}\n\n\tasync checkOnlineAgents(department?: string, agent?: { agentId: string }, skipFallbackCheck = false): Promise<boolean> {\n\t\tif (agent?.agentId) {\n\t\t\treturn Users.checkOnlineAgents(agent.agentId);\n\t\t}\n\n\t\tif (department) {\n\t\t\tconst onlineForDep = await LivechatDepartmentAgents.checkOnlineForDepartment(department);\n\t\t\tif (onlineForDep || skipFallbackCheck) {\n\t\t\t\treturn onlineForDep;\n\t\t\t}\n\n\t\t\tconst dep = await LivechatDepartment.findOneById<Pick<ILivechatDepartment, '_id' | 'fallbackForwardDepartment'>>(department, {\n\t\t\t\tprojection: { fallbackForwardDepartment: 1 },\n\t\t\t});\n\t\t\tif (!dep?.fallbackForwardDepartment) {\n\t\t\t\treturn onlineForDep;\n\t\t\t}\n\n\t\t\treturn this.checkOnlineAgents(dep?.fallbackForwardDepartment);\n\t\t}\n\n\t\treturn Users.checkOnlineAgents();\n\t}\n\n\tasync removeRoom(rid: string) {\n\t\tLivechat.logger.debug(`Deleting room ${rid}`);\n\t\tcheck(rid, String);\n\t\tconst room = await LivechatRooms.findOneById(rid);\n\t\tif (!room) {\n\t\t\tthrow new Meteor.Error('error-invalid-room', 'Invalid room');\n\t\t}\n\n\t\tconst inquiry = await LivechatInquiry.findOneByRoomId(rid);\n\n\t\tconst result = await Promise.allSettled([\n\t\t\tMessages.removeByRoomId(rid),\n\t\t\tReadReceipts.removeByRoomId(rid),\n\t\t\tSubscriptions.removeByRoomId(rid, {\n\t\t\t\tasync onTrash(doc) {\n\t\t\t\t\tvoid notifyOnSubscriptionChanged(doc, 'removed');\n\t\t\t\t},\n\t\t\t}),\n\t\t\tLivechatInquiry.removeByRoomId(rid),\n\t\t\tLivechatRooms.removeById(rid),\n\t\t]);\n\n\t\tif (result[3]?.status === 'fulfilled' && result[3].value?.deletedCount && inquiry) {\n\t\t\tvoid notifyOnLivechatInquiryChanged(inquiry, 'removed');\n\t\t}\n\n\t\tfor (const r of result) {\n\t\t\tif (r.status === 'rejected') {\n\t\t\t\tthis.logger.error(`Error removing room ${rid}: ${r.reason}`);\n\t\t\t\tthrow new Meteor.Error('error-removing-room', 'Error removing room');\n\t\t\t}\n\t\t}\n\t}\n\n\tisValidObject(obj: unknown): obj is Record<string, any> {\n\t\treturn typeof obj === 'object' && obj !== null;\n\t}\n\n\tasync registerGuest({\n\t\tid,\n\t\ttoken,\n\t\tname,\n\t\tphone,\n\t\temail,\n\t\tdepartment,\n\t\tusername,\n\t\tconnectionData,\n\t\tstatus = UserStatus.ONLINE,\n\t}: RegisterGuestType): Promise<ILivechatVisitor | null> {\n\t\tcheck(token, String);\n\t\tcheck(id, Match.Maybe(String));\n\n\t\tLivechat.logger.debug(`New incoming conversation: id: ${id} | token: ${token}`);\n\n\t\tconst visitorDataToUpdate: Partial<ILivechatVisitor> & { userAgent?: string; ip?: string; host?: string } = {\n\t\t\ttoken,\n\t\t\tstatus,\n\t\t\t...(phone?.number ? { phone: [{ phoneNumber: phone.number }] } : {}),\n\t\t\t...(name ? { name } : {}),\n\t\t};\n\n\t\tif (email) {\n\t\t\tconst visitorEmail = email.trim().toLowerCase();\n\t\t\tvalidateEmail(visitorEmail);\n\t\t\tvisitorDataToUpdate.visitorEmails = [{ address: visitorEmail }];\n\t\t}\n\n\t\tconst livechatVisitor = await LivechatVisitors.getVisitorByToken(token, { projection: { _id: 1 } });\n\n\t\tif (livechatVisitor?.department !== department && department) {\n\t\t\tLivechat.logger.debug(`Attempt to find a department with id/name ${department}`);\n\t\t\tconst dep = await LivechatDepartment.findOneByIdOrName(department, { projection: { _id: 1 } });\n\t\t\tif (!dep) {\n\t\t\t\tLivechat.logger.debug(`Invalid department provided: ${department}`);\n\t\t\t\tthrow new Meteor.Error('error-invalid-department', 'The provided department is invalid');\n\t\t\t}\n\t\t\tLivechat.logger.debug(`Assigning visitor ${token} to department ${dep._id}`);\n\t\t\tvisitorDataToUpdate.department = dep._id;\n\t\t}\n\n\t\tvisitorDataToUpdate.token = livechatVisitor?.token || token;\n\n\t\tlet existingUser = null;\n\n\t\tif (livechatVisitor) {\n\t\t\tLivechat.logger.debug('Found matching user by token');\n\t\t\tvisitorDataToUpdate._id = livechatVisitor._id;\n\t\t} else if (phone?.number && (existingUser = await LivechatVisitors.findOneVisitorByPhone(phone.number))) {\n\t\t\tLivechat.logger.debug('Found matching user by phone number');\n\t\t\tvisitorDataToUpdate._id = existingUser._id;\n\t\t\t// Don't change token when matching by phone number, use current visitor token\n\t\t\tvisitorDataToUpdate.token = existingUser.token;\n\t\t} else if (email && (existingUser = await LivechatVisitors.findOneGuestByEmailAddress(email))) {\n\t\t\tLivechat.logger.debug('Found matching user by email');\n\t\t\tvisitorDataToUpdate._id = existingUser._id;\n\t\t} else if (!livechatVisitor) {\n\t\t\tLivechat.logger.debug(`No matches found. Attempting to create new user with token ${token}`);\n\n\t\t\tvisitorDataToUpdate._id = id || undefined;\n\t\t\tvisitorDataToUpdate.username = username || (await LivechatVisitors.getNextVisitorUsername());\n\t\t\tvisitorDataToUpdate.status = status;\n\t\t\tvisitorDataToUpdate.ts = new Date();\n\n\t\t\tif (settings.get('Livechat_Allow_collect_and_store_HTTP_header_informations') && Livechat.isValidObject(connectionData)) {\n\t\t\t\tLivechat.logger.debug(`Saving connection data for visitor ${token}`);\n\t\t\t\tconst { httpHeaders, clientAddress } = connectionData;\n\t\t\t\tif (Livechat.isValidObject(httpHeaders)) {\n\t\t\t\t\tvisitorDataToUpdate.userAgent = httpHeaders['user-agent'];\n\t\t\t\t\tvisitorDataToUpdate.ip = httpHeaders['x-real-ip'] || httpHeaders['x-forwarded-for'] || clientAddress;\n\t\t\t\t\tvisitorDataToUpdate.host = httpHeaders?.host;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tif (isSingleContactEnabled()) {\n\t\t\tconst contactId = await createContact({\n\t\t\t\tname: name ?? (visitorDataToUpdate.username as string),\n\t\t\t\temails: email ? [email] : [],\n\t\t\t\tphones: phone ? [phone.number] : [],\n\t\t\t\tunknown: true,\n\t\t\t});\n\t\t\tvisitorDataToUpdate.contactId = contactId;\n\t\t}\n\n\t\tconst upsertedLivechatVisitor = await LivechatVisitors.updateOneByIdOrToken(visitorDataToUpdate, {\n\t\t\tupsert: true,\n\t\t\treturnDocument: 'after',\n\t\t});\n\n\t\tif (!upsertedLivechatVisitor.value) {\n\t\t\tLivechat.logger.debug(`No visitor found after upsert`);\n\t\t\treturn null;\n\t\t}\n\n\t\treturn upsertedLivechatVisitor.value;\n\t}\n\n\tprivate async getBotAgents(department?: string) {\n\t\tif (department) {\n\t\t\treturn LivechatDepartmentAgents.getBotsForDepartment(department);\n\t\t}\n\n\t\treturn Users.findBotAgents();\n\t}\n\n\tprivate async resolveChatTags(\n\t\troom: IOmnichannelRoom,\n\t\toptions: CloseRoomParams['options'] = {},\n\t): Promise<{ updatedOptions: CloseRoomParams['options'] }> {\n\t\tthis.logger.debug(`Resolving chat tags for room ${room._id}`);\n\n\t\tconst concatUnique = (...arrays: (string[] | undefined)[]): string[] => [\n\t\t\t...new Set(([] as string[]).concat(...arrays.filter((a): a is string[] => !!a))),\n\t\t];\n\n\t\tconst { departmentId, tags: optionsTags } = room;\n\t\tconst { clientAction, tags: oldRoomTags } = options;\n\t\tconst roomTags = concatUnique(oldRoomTags, optionsTags);\n\n\t\tif (!departmentId) {\n\t\t\treturn {\n\t\t\t\tupdatedOptions: {\n\t\t\t\t\t...options,\n\t\t\t\t\t...(roomTags.length && { tags: roomTags }),\n\t\t\t\t},\n\t\t\t};\n\t\t}\n\n\t\tconst department = await LivechatDepartment.findOneById<Pick<ILivechatDepartment, 'requestTagBeforeClosingChat' | 'chatClosingTags'>>(\n\t\t\tdepartmentId,\n\t\t\t{\n\t\t\t\tprojection: { requestTagBeforeClosingChat: 1, chatClosingTags: 1 },\n\t\t\t},\n\t\t);\n\t\tif (!department) {\n\t\t\treturn {\n\t\t\t\tupdatedOptions: {\n\t\t\t\t\t...options,\n\t\t\t\t\t...(roomTags.length && { tags: roomTags }),\n\t\t\t\t},\n\t\t\t};\n\t\t}\n\n\t\tconst { requestTagBeforeClosingChat, chatClosingTags } = department;\n\t\tconst extraRoomTags = concatUnique(roomTags, chatClosingTags);\n\n\t\tif (!requestTagBeforeClosingChat) {\n\t\t\treturn {\n\t\t\t\tupdatedOptions: {\n\t\t\t\t\t...options,\n\t\t\t\t\t...(extraRoomTags.length && { tags: extraRoomTags }),\n\t\t\t\t},\n\t\t\t};\n\t\t}\n\n\t\tconst checkRoomTags = !clientAction || (roomTags && roomTags.length > 0);\n\t\tconst checkDepartmentTags = chatClosingTags && chatClosingTags.length > 0;\n\t\tif (!checkRoomTags || !checkDepartmentTags) {\n\t\t\tthrow new Error('error-tags-must-be-assigned-before-closing-chat');\n\t\t}\n\n\t\treturn {\n\t\t\tupdatedOptions: {\n\t\t\t\t...options,\n\t\t\t\t...(extraRoomTags.length && { tags: extraRoomTags }),\n\t\t\t},\n\t\t};\n\t}\n\n\tasync sendRequest(\n\t\tpostData: {\n\t\t\ttype: string;\n\t\t\t[key: string]: any;\n\t\t},\n\t\tattempts = 10,\n\t) {\n\t\tif (!attempts) {\n\t\t\tLivechat.logger.error({ msg: 'Omnichannel webhook call failed. Max attempts reached' });\n\t\t\treturn;\n\t\t}\n\t\tconst timeout = settings.get<number>('Livechat_http_timeout');\n\t\tconst secretToken = settings.get<string>('Livechat_secret_token');\n\t\tconst webhookUrl = settings.get<string>('Livechat_webhookUrl');\n\t\ttry {\n\t\t\tLivechat.webhookLogger.debug({ msg: 'Sending webhook request', postData });\n\t\t\tconst result = await fetch(webhookUrl, {\n\t\t\t\tmethod: 'POST',\n\t\t\t\theaders: {\n\t\t\t\t\t...(secretToken && { 'X-RocketChat-Livechat-Token': secretToken }),\n\t\t\t\t},\n\t\t\t\tbody: postData,\n\t\t\t\ttimeout,\n\t\t\t});\n\n\t\t\tif (result.status === 200) {\n\t\t\t\tmetrics.totalLivechatWebhooksSuccess.inc();\n\t\t\t\treturn result;\n\t\t\t}\n\n\t\t\tmetrics.totalLivechatWebhooksFailures.inc();\n\t\t\tthrow new Error(await result.text());\n\t\t} catch (err) {\n\t\t\tconst retryAfter = timeout * 4;\n\t\t\tLivechat.webhookLogger.error({ msg: `Error response on ${11 - attempts} try ->`, err });\n\t\t\t// try 10 times after 20 seconds each\n\t\t\tattempts - 1 &&\n\t\t\t\tLivechat.webhookLogger.warn({ msg: `Webhook call failed. Retrying`, newAttemptAfterSeconds: retryAfter / 1000, webhookUrl });\n\t\t\tsetTimeout(async () => {\n\t\t\t\tawait Livechat.sendRequest(postData, attempts - 1);\n\t\t\t}, retryAfter);\n\t\t}\n\t}\n\n\tasync saveAgentInfo(_id: string, agentData: any, agentDepartments: string[]) {\n\t\tcheck(_id, String);\n\t\tcheck(agentData, Object);\n\t\tcheck(agentDepartments, [String]);\n\n\t\tconst user = await Users.findOneById(_id);\n\t\tif (!user || !(await hasRoleAsync(_id, 'livechat-agent'))) {\n\t\t\tthrow new Meteor.Error('error-user-is-not-agent', 'User is not a livechat agent');\n\t\t}\n\n\t\tawait Users.setLivechatData(_id, agentData);\n\n\t\tconst currentDepartmentsForAgent = await LivechatDepartmentAgents.findByAgentId(_id).toArray();\n\n\t\tconst toRemoveIds = currentDepartmentsForAgent\n\t\t\t.filter((dept) => !agentDepartments.includes(dept.departmentId))\n\t\t\t.map((dept) => dept.departmentId);\n\t\tconst toAddIds = agentDepartments.filter((d) => !currentDepartmentsForAgent.some((c) => c.departmentId === d));\n\n\t\tawait Promise.all(\n\t\t\tawait LivechatDepartment.findInIds([...toRemoveIds, ...toAddIds], {\n\t\t\t\tprojection: {\n\t\t\t\t\t_id: 1,\n\t\t\t\t\tenabled: 1,\n\t\t\t\t},\n\t\t\t})\n\t\t\t\t.map((dep) => {\n\t\t\t\t\treturn updateDepartmentAgents(\n\t\t\t\t\t\tdep._id,\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t...(toRemoveIds.includes(dep._id) ? { remove: [{ agentId: _id }] } : { upsert: [{ agentId: _id, count: 0, order: 0 }] }),\n\t\t\t\t\t\t},\n\t\t\t\t\t\tdep.enabled,\n\t\t\t\t\t);\n\t\t\t\t})\n\t\t\t\t.toArray(),\n\t\t);\n\n\t\treturn true;\n\t}\n\n\tasync updateCallStatus(callId: string, rid: string, status: 'ended' | 'declined', user: IUser | ILivechatVisitor) {\n\t\tawait Rooms.setCallStatus(rid, status);\n\t\tif (status === 'ended' || status === 'declined') {\n\t\t\tif (await VideoConf.declineLivechatCall(callId)) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\treturn updateMessage({ _id: callId, msg: status, actionLinks: [], webRtcCallEndTs: new Date(), rid }, user as unknown as IUser);\n\t\t}\n\t}\n\n\tnotifyRoomVisitorChange(roomId: string, visitor: ILivechatVisitor) {\n\t\tvoid api.broadcast('omnichannel.room', roomId, {\n\t\t\ttype: 'visitorData',\n\t\t\tvisitor,\n\t\t});\n\t}\n\n\tasync changeRoomVisitor(userId: string, room: IOmnichannelRoom, visitor: ILivechatVisitor) {\n\t\tconst user = await Users.findOneById(userId, { projection: { _id: 1 } });\n\t\tif (!user) {\n\t\t\tthrow new Error('error-user-not-found');\n\t\t}\n\n\t\tif (!(await canAccessRoomAsync(room, user))) {\n\t\t\tthrow new Error('error-not-allowed');\n\t\t}\n\n\t\tawait LivechatRooms.changeVisitorByRoomId(room._id, visitor);\n\n\t\tthis.notifyRoomVisitorChange(room._id, visitor);\n\n\t\treturn LivechatRooms.findOneById(room._id);\n\t}\n\n\tasync notifyAgentStatusChanged(userId: string, status?: UserStatus) {\n\t\tif (!status) {\n\t\t\treturn;\n\t\t}\n\n\t\tvoid callbacks.runAsync('livechat.agentStatusChanged', { userId, status });\n\t\tif (!settings.get('Livechat_show_agent_info')) {\n\t\t\treturn;\n\t\t}\n\n\t\tawait LivechatRooms.findOpenByAgent(userId).forEach((room) => {\n\t\t\tvoid api.broadcast('omnichannel.room', room._id, {\n\t\t\t\ttype: 'agentStatus',\n\t\t\t\tstatus,\n\t\t\t});\n\t\t});\n\t}\n\n\tasync updateMessage({ guest, message }: { guest: ILivechatVisitor; message: AtLeast<IMessage, '_id' | 'msg' | 'rid'> }) {\n\t\tcheck(message, Match.ObjectIncluding({ _id: String }));\n\n\t\tconst originalMessage = await Messages.findOneById<Pick<IMessage, 'u' | '_id'>>(message._id, { projection: { u: 1 } });\n\t\tif (!originalMessage?._id) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst editAllowed = settings.get('Message_AllowEditing');\n\t\tconst editOwn = originalMessage.u && originalMessage.u._id === guest._id;\n\n\t\tif (!editAllowed || !editOwn) {\n\t\t\tthrow new Error('error-action-not-allowed');\n\t\t}\n\n\t\t// TODO: Apps sends an `any` object and apparently we just check for _id being present\n\t\t// while updateMessage expects AtLeast<id, msg, rid>\n\t\tawait updateMessage(message, guest as unknown as IUser);\n\n\t\treturn true;\n\t}\n\n\tasync closeOpenChats(userId: string, comment?: string) {\n\t\tthis.logger.debug(`Closing open chats for user ${userId}`);\n\t\tconst user = await Users.findOneById(userId);\n\n\t\tconst extraQuery = await callbacks.run('livechat.applyDepartmentRestrictions', {}, { userId });\n\t\tconst openChats = LivechatRooms.findOpenByAgent(userId, extraQuery);\n\t\tconst promises: Promise<void>[] = [];\n\t\tawait openChats.forEach((room) => {\n\t\t\tpromises.push(this.closeRoom({ user, room, comment }));\n\t\t});\n\n\t\tawait Promise.all(promises);\n\t}\n\n\tasync transfer(room: IOmnichannelRoom, guest: ILivechatVisitor, transferData: TransferData) {\n\t\tthis.logger.debug(`Transfering room ${room._id} [Transfered by: ${transferData?.transferredBy?._id}]`);\n\t\tif (room.onHold) {\n\t\t\tthrow new Error('error-room-onHold');\n\t\t}\n\n\t\tif (transferData.departmentId) {\n\t\t\tconst department = await LivechatDepartment.findOneById<Pick<ILivechatDepartment, 'name' | '_id'>>(transferData.departmentId, {\n\t\t\t\tprojection: { name: 1 },\n\t\t\t});\n\t\t\tif (!department) {\n\t\t\t\tthrow new Error('error-invalid-department');\n\t\t\t}\n\n\t\t\ttransferData.department = department;\n\t\t\tthis.logger.debug(`Transfering room ${room._id} to department ${transferData.department?._id}`);\n\t\t}\n\n\t\treturn RoutingManager.transferRoom(room, guest, transferData);\n\t}\n\n\tasync forwardOpenChats(userId: string) {\n\t\tthis.logger.debug(`Transferring open chats for user ${userId}`);\n\t\tconst user = await Users.findOneById(userId);\n\t\tif (!user) {\n\t\t\tthrow new Error('error-invalid-user');\n\t\t}\n\n\t\tconst { _id, username, name } = user;\n\t\tfor await (const room of LivechatRooms.findOpenByAgent(userId)) {\n\t\t\tconst guest = await LivechatVisitors.findOneEnabledById(room.v._id);\n\t\t\tif (!guest) {\n\t\t\t\tcontinue;\n\t\t\t}\n\n\t\t\tconst transferredBy = normalizeTransferredByData({ _id, username, name }, room);\n\t\t\tawait this.transfer(room, guest, {\n\t\t\t\ttransferredBy,\n\t\t\t\tdepartmentId: guest.department,\n\t\t\t});\n\t\t}\n\t}\n\n\tshowConnecting() {\n\t\treturn RoutingManager.getConfig()?.showConnecting || false;\n\t}\n\n\tasync getInitSettings() {\n\t\tconst validSettings = [\n\t\t\t'Livechat_title',\n\t\t\t'Livechat_title_color',\n\t\t\t'Livechat_enable_message_character_limit',\n\t\t\t'Livechat_message_character_limit',\n\t\t\t'Message_MaxAllowedSize',\n\t\t\t'Livechat_enabled',\n\t\t\t'Livechat_registration_form',\n\t\t\t'Livechat_allow_switching_departments',\n\t\t\t'Livechat_offline_title',\n\t\t\t'Livechat_offline_title_color',\n\t\t\t'Livechat_offline_message',\n\t\t\t'Livechat_offline_success_message',\n\t\t\t'Livechat_offline_form_unavailable',\n\t\t\t'Livechat_display_offline_form',\n\t\t\t'Omnichannel_call_provider',\n\t\t\t'Language',\n\t\t\t'Livechat_enable_transcript',\n\t\t\t'Livechat_transcript_message',\n\t\t\t'Livechat_fileupload_enabled',\n\t\t\t'FileUpload_Enabled',\n\t\t\t'Livechat_conversation_finished_message',\n\t\t\t'Livechat_conversation_finished_text',\n\t\t\t'Livechat_name_field_registration_form',\n\t\t\t'Livechat_email_field_registration_form',\n\t\t\t'Livechat_registration_form_message',\n\t\t\t'Livechat_force_accept_data_processing_consent',\n\t\t\t'Livechat_data_processing_consent_text',\n\t\t\t'Livechat_show_agent_info',\n\t\t\t'Livechat_clear_local_storage_when_chat_ended',\n\t\t\t'Livechat_history_monitor_type',\n\t\t\t'Livechat_hide_system_messages',\n\t\t\t'Livechat_widget_position',\n\t\t\t'Livechat_background',\n\t\t\t'Assets_livechat_widget_logo',\n\t\t\t'Livechat_hide_watermark',\n\t\t\t'Omnichannel_allow_visitors_to_close_conversation',\n\t\t] as const;\n\n\t\ttype SettingTypes = (typeof validSettings)[number] | 'Livechat_Show_Connecting';\n\n\t\tconst rcSettings = validSettings.reduce<Record<SettingTypes, string | boolean>>((acc, setting) => {\n\t\t\tacc[setting] = settings.get(setting);\n\t\t\treturn acc;\n\t\t}, {} as any);\n\n\t\trcSettings.Livechat_Show_Connecting = this.showConnecting();\n\n\t\treturn rcSettings;\n\t}\n\n\tasync sendMessage({\n\t\tguest,\n\t\tmessage,\n\t\troomInfo,\n\t\tagent,\n\t}: {\n\t\tguest: ILivechatVisitor;\n\t\tmessage: ILivechatMessage;\n\t\troomInfo: IOmnichannelRoomInfo;\n\t\tagent?: SelectedAgent;\n\t}) {\n\t\tconst { room, newRoom } = await this.getRoom(guest, message, roomInfo, agent);\n\t\tif (guest.name) {\n\t\t\tmessage.alias = guest.name;\n\t\t}\n\t\treturn Object.assign(await sendMessage(guest, { ...message, token: guest.token }, room), {\n\t\t\tnewRoom,\n\t\t\tshowConnecting: this.showConnecting(),\n\t\t});\n\t}\n\n\tasync removeGuest(_id: string) {\n\t\tconst guest = await LivechatVisitors.findOneEnabledById(_id, { projection: { _id: 1, token: 1 } });\n\t\tif (!guest) {\n\t\t\tthrow new Error('error-invalid-guest');\n\t\t}\n\n\t\tawait this.cleanGuestHistory(guest);\n\t\treturn LivechatVisitors.disableById(_id);\n\t}\n\n\tasync cleanGuestHistory(guest: ILivechatVisitor) {\n\t\tconst { token } = guest;\n\n\t\t// This shouldn't be possible, but just in case\n\t\tif (!token) {\n\t\t\tthrow new Error('error-invalid-guest');\n\t\t}\n\n\t\tconst cursor = LivechatRooms.findByVisitorToken(token);\n\t\tfor await (const room of cursor) {\n\t\t\tawait Promise.all([\n\t\t\t\tSubscriptions.removeByRoomId(room._id, {\n\t\t\t\t\tasync onTrash(doc) {\n\t\t\t\t\t\tvoid notifyOnSubscriptionChanged(doc, 'removed');\n\t\t\t\t\t},\n\t\t\t\t}),\n\t\t\t\tFileUpload.removeFilesByRoomId(room._id),\n\t\t\t\tMessages.removeByRoomId(room._id),\n\t\t\t\tReadReceipts.removeByRoomId(room._id),\n\t\t\t]);\n\t\t}\n\n\t\tawait LivechatRooms.removeByVisitorToken(token);\n\n\t\tconst livechatInquiries = await LivechatInquiry.findIdsByVisitorToken(token).toArray();\n\t\tawait LivechatInquiry.removeByIds(livechatInquiries.map(({ _id }) => _id));\n\t\tvoid notifyOnLivechatInquiryChanged(livechatInquiries, 'removed');\n\t}\n\n\tasync deleteMessage({ guest, message }: { guest: ILivechatVisitor; message: IMessage }) {\n\t\tconst deleteAllowed = settings.get<boolean>('Message_AllowDeleting');\n\t\tconst editOwn = message.u && message.u._id === guest._id;\n\n\t\tif (!deleteAllowed || !editOwn) {\n\t\t\tthrow new Error('error-action-not-allowed');\n\t\t}\n\n\t\tawait deleteMessage(message, guest as unknown as IUser);\n\n\t\treturn true;\n\t}\n\n\tasync setUserStatusLivechatIf(userId: string, status: ILivechatAgentStatus, condition?: Filter<IUser>, fields?: AKeyOf<ILivechatAgent>) {\n\t\tconst result = await Users.setLivechatStatusIf(userId, status, condition, fields);\n\n\t\tif (result.modifiedCount > 0) {\n\t\t\tvoid notifyOnUserChange({\n\t\t\t\tid: userId,\n\t\t\t\tclientAction: 'updated',\n\t\t\t\tdiff: { ...fields, statusLivechat: status },\n\t\t\t});\n\t\t}\n\n\t\tcallbacks.runAsync('livechat.setUserStatusLivechat', { userId, status });\n\t\treturn result;\n\t}\n\n\tasync returnRoomAsInquiry(room: IOmnichannelRoom, departmentId?: string, overrideTransferData: any = {}) {\n\t\tthis.logger.debug({ msg: `Transfering room to ${departmentId ? 'department' : ''} queue`, room });\n\t\tif (!room.open) {\n\t\t\tthrow new Meteor.Error('room-closed');\n\t\t}\n\n\t\tif (room.onHold) {\n\t\t\tthrow new Meteor.Error('error-room-onHold');\n\t\t}\n\n\t\tif (!room.servedBy) {\n\t\t\treturn false;\n\t\t}\n\n\t\tconst user = await Users.findOneById(room.servedBy._id);\n\t\tif (!user?._id) {\n\t\t\tthrow new Meteor.Error('error-invalid-user');\n\t\t}\n\n\t\t// find inquiry corresponding to room\n\t\tconst inquiry = await LivechatInquiry.findOne({ rid: room._id });\n\t\tif (!inquiry) {\n\t\t\treturn false;\n\t\t}\n\n\t\tconst transferredBy = normalizeTransferredByData(user, room);\n\t\tthis.logger.debug(`Transfering room ${room._id} by user ${transferredBy._id}`);\n\t\tconst transferData = { roomId: room._id, scope: 'queue', departmentId, transferredBy, ...overrideTransferData };\n\t\ttry {\n\t\t\tawait this.saveTransferHistory(room, transferData);\n\t\t\tawait RoutingManager.unassignAgent(inquiry, departmentId);\n\t\t} catch (e) {\n\t\t\tthis.logger.error(e);\n\t\t\tthrow new Meteor.Error('error-returning-inquiry');\n\t\t}\n\n\t\tcallbacks.runAsync('livechat:afterReturnRoomAsInquiry', { room });\n\n\t\treturn true;\n\t}\n\n\tasync saveTransferHistory(room: IOmnichannelRoom, transferData: TransferData) {\n\t\tconst { departmentId: previousDepartment } = room;\n\t\tconst { department: nextDepartment, transferredBy, transferredTo, scope, comment } = transferData;\n\n\t\tcheck(\n\t\t\ttransferredBy,\n\t\t\tMatch.ObjectIncluding({\n\t\t\t\t_id: String,\n\t\t\t\tusername: String,\n\t\t\t\tname: Match.Maybe(String),\n\t\t\t\tuserType: String,\n\t\t\t}),\n\t\t);\n\n\t\tconst { _id, username } = transferredBy;\n\t\tconst scopeData = scope || (nextDepartment ? 'department' : 'agent');\n\t\tthis.logger.info(`Storing new chat transfer of ${room._id} [Transfered by: ${_id} to ${scopeData}]`);\n\n\t\tconst transferMessage = {\n\t\t\t...(transferData.transferredBy.userType === 'visitor' && { token: room.v.token }),\n\t\t\ttransferData: {\n\t\t\t\ttransferredBy,\n\t\t\t\tts: new Date(),\n\t\t\t\tscope: scopeData,\n\t\t\t\tcomment,\n\t\t\t\t...(previousDepartment && { previousDepartment }),\n\t\t\t\t...(nextDepartment && { nextDepartment }),\n\t\t\t\t...(transferredTo && { transferredTo }),\n\t\t\t},\n\t\t};\n\n\t\tawait Message.saveSystemMessageAndNotifyUser('livechat_transfer_history', room._id, '', { _id, username }, transferMessage);\n\t}\n\n\tasync saveGuest(guestData: Pick<ILivechatVisitor, '_id' | 'name' | 'livechatData'> & { email?: string; phone?: string }, userId: string) {\n\t\tconst { _id, name, email, phone, livechatData = {} } = guestData;\n\n\t\tconst visitor = await LivechatVisitors.findOneById(_id, { projection: { _id: 1 } });\n\t\tif (!visitor) {\n\t\t\tthrow new Error('error-invalid-visitor');\n\t\t}\n\n\t\tthis.logger.debug({ msg: 'Saving guest', guestData });\n\t\tconst updateData: {\n\t\t\tname?: string | undefined;\n\t\t\tusername?: string | undefined;\n\t\t\temail?: string | undefined;\n\t\t\tphone?: string | undefined;\n\t\t\tlivechatData: {\n\t\t\t\t[k: string]: any;\n\t\t\t};\n\t\t} = { livechatData: {} };\n\n\t\tif (name) {\n\t\t\tupdateData.name = name;\n\t\t}\n\t\tif (email) {\n\t\t\tupdateData.email = email;\n\t\t}\n\t\tif (phone) {\n\t\t\tupdateData.phone = phone;\n\t\t}\n\n\t\tconst customFields: Record<string, any> = {};\n\n\t\tif ((!userId || (await hasPermissionAsync(userId, 'edit-livechat-room-customfields'))) && Object.keys(livechatData).length) {\n\t\t\tthis.logger.debug({ msg: `Saving custom fields for visitor ${_id}`, livechatData });\n\t\t\tfor await (const field of LivechatCustomField.findByScope('visitor')) {\n\t\t\t\tif (!livechatData.hasOwnProperty(field._id)) {\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\t\t\t\tconst value = trim(livechatData[field._id]);\n\t\t\t\tif (value !== '' && field.regexp !== undefined && field.regexp !== '') {\n\t\t\t\t\tconst regexp = new RegExp(field.regexp);\n\t\t\t\t\tif (!regexp.test(value)) {\n\t\t\t\t\t\tthrow new Error(i18n.t('error-invalid-custom-field-value'));\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tcustomFields[field._id] = value;\n\t\t\t}\n\t\t\tupdateData.livechatData = customFields;\n\t\t\tLivechat.logger.debug(`About to update ${Object.keys(customFields).length} custom fields for visitor ${_id}`);\n\t\t}\n\t\tconst ret = await LivechatVisitors.saveGuestById(_id, updateData);\n\n\t\tsetImmediate(() => {\n\t\t\tvoid Apps.self?.triggerEvent(AppEvents.IPostLivechatGuestSaved, _id);\n\t\t});\n\n\t\treturn ret;\n\t}\n\n\tasync setCustomFields({ token, key, value, overwrite }: { key: string; value: string; overwrite: boolean; token: string }) {\n\t\tLivechat.logger.debug(`Setting custom fields data for visitor with token ${token}`);\n\n\t\tconst customField = await LivechatCustomField.findOneById(key);\n\t\tif (!customField) {\n\t\t\tthrow new Error('invalid-custom-field');\n\t\t}\n\n\t\tif (customField.regexp !== undefined && customField.regexp !== '') {\n\t\t\tconst regexp = new RegExp(customField.regexp);\n\t\t\tif (!regexp.test(value)) {\n\t\t\t\tthrow new Error(i18n.t('error-invalid-custom-field-value', { field: key }));\n\t\t\t}\n\t\t}\n\n\t\tlet result;\n\t\tif (customField.scope === 'room') {\n\t\t\tresult = await LivechatRooms.updateDataByToken(token, key, value, overwrite);\n\t\t} else {\n\t\t\tresult = await LivechatVisitors.updateLivechatDataByToken(token, key, value, overwrite);\n\t\t}\n\n\t\tif (typeof result === 'boolean') {\n\t\t\t// Note: this only happens when !overwrite is passed, in this case we don't do any db update\n\t\t\treturn 0;\n\t\t}\n\n\t\treturn result.modifiedCount;\n\t}\n\n\tasync requestTranscript({\n\t\trid,\n\t\temail,\n\t\tsubject,\n\t\tuser,\n\t}: {\n\t\trid: string;\n\t\temail: string;\n\t\tsubject: string;\n\t\tuser: AtLeast<IUser, '_id' | 'username' | 'utcOffset' | 'name'>;\n\t}) {\n\t\tconst room = await LivechatRooms.findOneById(rid, { projection: { _id: 1, open: 1, transcriptRequest: 1 } });\n\n\t\tif (!room?.open) {\n\t\t\tthrow new Meteor.Error('error-invalid-room', 'Invalid room');\n\t\t}\n\n\t\tif (room.transcriptRequest) {\n\t\t\tthrow new Meteor.Error('error-transcript-already-requested', 'Transcript already requested');\n\t\t}\n\n\t\tif (!(await Omnichannel.isWithinMACLimit(room))) {\n\t\t\tthrow new Error('error-mac-limit-reached');\n\t\t}\n\n\t\tconst { _id, username, name, utcOffset } = user;\n\t\tconst transcriptRequest = {\n\t\t\trequestedAt: new Date(),\n\t\t\trequestedBy: {\n\t\t\t\t_id,\n\t\t\t\tusername,\n\t\t\t\tname,\n\t\t\t\tutcOffset,\n\t\t\t},\n\t\t\temail,\n\t\t\tsubject,\n\t\t};\n\n\t\tawait LivechatRooms.setEmailTranscriptRequestedByRoomId(rid, transcriptRequest);\n\t\treturn true;\n\t}\n\n\tasync afterRemoveAgent(user: AtLeast<IUser, '_id' | 'username'>) {\n\t\tawait callbacks.run('livechat.afterAgentRemoved', { agent: user });\n\t\treturn true;\n\t}\n\n\tasync removeAgent(username: string) {\n\t\tconst user = await Users.findOneByUsername(username, { projection: { _id: 1, username: 1 } });\n\n\t\tif (!user) {\n\t\t\tthrow new Error('error-invalid-user');\n\t\t}\n\n\t\tconst { _id } = user;\n\n\t\tif (await removeUserFromRolesAsync(_id, ['livechat-agent'])) {\n\t\t\treturn this.afterRemoveAgent(user);\n\t\t}\n\n\t\treturn false;\n\t}\n\n\tasync removeManager(username: string) {\n\t\tconst user = await Users.findOneByUsername(username, { projection: { _id: 1 } });\n\n\t\tif (!user) {\n\t\t\tthrow new Error('error-invalid-user');\n\t\t}\n\n\t\treturn removeUserFromRolesAsync(user._id, ['livechat-manager']);\n\t}\n\n\tasync getLivechatRoomGuestInfo(room: IOmnichannelRoom) {\n\t\tconst visitor = await LivechatVisitors.findOneEnabledById(room.v._id);\n\t\tif (!visitor) {\n\t\t\tthrow new Error('error-invalid-visitor');\n\t\t}\n\n\t\tconst agent = room.servedBy?._id ? await Users.findOneById(room.servedBy?._id) : null;\n\n\t\tconst ua = new UAParser();\n\t\tua.setUA(visitor.userAgent || '');\n\n\t\tconst postData: ICRMData = {\n\t\t\t_id: room._id,\n\t\t\tlabel: room.fname || room.label, // using same field for compatibility\n\t\t\ttopic: room.topic,\n\t\t\tcreatedAt: room.ts,\n\t\t\tlastMessageAt: room.lm,\n\t\t\ttags: room.tags,\n\t\t\tcustomFields: room.livechatData,\n\t\t\tvisitor: {\n\t\t\t\t_id: visitor._id,\n\t\t\t\ttoken: visitor.token,\n\t\t\t\tname: visitor.name,\n\t\t\t\tusername: visitor.username,\n\t\t\t\tdepartment: visitor.department,\n\t\t\t\tip: visitor.ip,\n\t\t\t\tos: ua.getOS().name && `${ua.getOS().name} ${ua.getOS().version}`,\n\t\t\t\tbrowser: ua.getBrowser().name && `${ua.getBrowser().name} ${ua.getBrowser().version}`,\n\t\t\t\tcustomFields: visitor.livechatData,\n\t\t\t},\n\t\t};\n\n\t\tif (agent) {\n\t\t\tconst customFields = parseAgentCustomFields(agent.customFields);\n\n\t\t\tpostData.agent = {\n\t\t\t\t_id: agent._id,\n\t\t\t\tusername: agent.username,\n\t\t\t\tname: agent.name,\n\t\t\t\t...(customFields && { customFields }),\n\t\t\t};\n\n\t\t\tif (agent.emails && agent.emails.length > 0) {\n\t\t\t\tpostData.agent.email = agent.emails[0].address;\n\t\t\t}\n\t\t}\n\n\t\tif (room.crmData) {\n\t\t\tpostData.crmData = room.crmData;\n\t\t}\n\n\t\tif (visitor.visitorEmails && visitor.visitorEmails.length > 0) {\n\t\t\tpostData.visitor.email = visitor.visitorEmails;\n\t\t}\n\t\tif (visitor.phone && visitor.phone.length > 0) {\n\t\t\tpostData.visitor.phone = visitor.phone;\n\t\t}\n\n\t\treturn postData;\n\t}\n\n\tasync allowAgentChangeServiceStatus(statusLivechat: ILivechatAgentStatus, agentId: string) {\n\t\tif (statusLivechat !== ILivechatAgentStatus.AVAILABLE) {\n\t\t\treturn true;\n\t\t}\n\n\t\treturn businessHourManager.allowAgentChangeServiceStatus(agentId);\n\t}\n\n\tasync notifyGuestStatusChanged(token: string, status: UserStatus) {\n\t\tawait LivechatRooms.updateVisitorStatus(token, status);\n\n\t\tconst inquiryVisitorStatus = await LivechatInquiry.updateVisitorStatus(token, status);\n\n\t\tif (inquiryVisitorStatus.modifiedCount) {\n\t\t\tvoid notifyOnLivechatInquiryChangedByToken(token, 'updated', { v: { status } });\n\t\t}\n\t}\n\n\tasync setUserStatusLivechat(userId: string, status: ILivechatAgentStatus) {\n\t\tconst user = await Users.setLivechatStatus(userId, status);\n\t\tcallbacks.runAsync('livechat.setUserStatusLivechat', { userId, status });\n\n\t\tif (user.modifiedCount > 0) {\n\t\t\tvoid notifyOnUserChange({\n\t\t\t\tid: userId,\n\t\t\t\tclientAction: 'updated',\n\t\t\t\tdiff: {\n\t\t\t\t\tstatusLivechat: status,\n\t\t\t\t\tlivechatStatusSystemModified: false,\n\t\t\t\t},\n\t\t\t});\n\t\t}\n\n\t\treturn user;\n\t}\n\n\tasync afterAgentAdded(user: IUser) {\n\t\tawait Promise.all([\n\t\t\tUsers.setOperator(user._id, true),\n\t\t\tthis.setUserStatusLivechat(user._id, user.status !== 'offline' ? ILivechatAgentStatus.AVAILABLE : ILivechatAgentStatus.NOT_AVAILABLE),\n\t\t]);\n\t\tcallbacks.runAsync('livechat.onNewAgentCreated', user._id);\n\n\t\treturn user;\n\t}\n\n\tasync addAgent(username: string) {\n\t\tcheck(username, String);\n\n\t\tconst user = await Users.findOneByUsername(username, { projection: { _id: 1, username: 1 } });\n\n\t\tif (!user) {\n\t\t\tthrow new Meteor.Error('error-invalid-user');\n\t\t}\n\n\t\tif (await addUserRolesAsync(user._id, ['livechat-agent'])) {\n\t\t\treturn this.afterAgentAdded(user);\n\t\t}\n\n\t\treturn false;\n\t}\n\n\tasync afterAgentUserActivated(user: IUser) {\n\t\tif (!user.roles.includes('livechat-agent')) {\n\t\t\tthrow new Error('invalid-user-role');\n\t\t}\n\t\tawait Users.setOperator(user._id, true);\n\t\tcallbacks.runAsync('livechat.onNewAgentCreated', user._id);\n\t}\n\n\tasync addManager(username: string) {\n\t\tcheck(username, String);\n\n\t\tconst user = await Users.findOneByUsername(username, { projection: { _id: 1, username: 1 } });\n\n\t\tif (!user) {\n\t\t\tthrow new Meteor.Error('error-invalid-user');\n\t\t}\n\n\t\tif (await addUserRolesAsync(user._id, ['livechat-manager'])) {\n\t\t\treturn user;\n\t\t}\n\n\t\treturn false;\n\t}\n\n\tasync saveRoomInfo(\n\t\troomData: {\n\t\t\t_id: string;\n\t\t\ttopic?: string;\n\t\t\ttags?: string[];\n\t\t\tlivechatData?: { [k: string]: string };\n\t\t\t// For priority and SLA, if the value is blank (ie \"\"), then system will remove the priority or SLA from the room\n\t\t\tpriorityId?: string;\n\t\t\tslaId?: string;\n\t\t},\n\t\tguestData?: {\n\t\t\t_id: string;\n\t\t\tname?: string;\n\t\t\temail?: string;\n\t\t\tphone?: string;\n\t\t\tlivechatData?: { [k: string]: string };\n\t\t},\n\t\tuserId?: string,\n\t) {\n\t\tthis.logger.debug(`Saving room information on room ${roomData._id}`);\n\t\tconst { livechatData = {} } = roomData;\n\t\tconst customFields: Record<string, string> = {};\n\n\t\tif ((!userId || (await hasPermissionAsync(userId, 'edit-livechat-room-customfields'))) && Object.keys(livechatData).length) {\n\t\t\tconst fields = LivechatCustomField.findByScope('room');\n\t\t\tfor await (const field of fields) {\n\t\t\t\tif (!livechatData.hasOwnProperty(field._id)) {\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\t\t\t\tconst value = trim(livechatData[field._id]);\n\t\t\t\tif (value !== '' && field.regexp !== undefined && field.regexp !== '') {\n\t\t\t\t\tconst regexp = new RegExp(field.regexp);\n\t\t\t\t\tif (!regexp.test(value)) {\n\t\t\t\t\t\tthrow new Meteor.Error(i18n.t('error-invalid-custom-field-value', { field: field.label }));\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tcustomFields[field._id] = value;\n\t\t\t}\n\t\t\troomData.livechatData = customFields;\n\t\t\tLivechat.logger.debug(`About to update ${Object.keys(customFields).length} custom fields on room ${roomData._id}`);\n\t\t}\n\n\t\tawait LivechatRooms.saveRoomById(roomData);\n\n\t\tsetImmediate(() => {\n\t\t\tvoid Apps.self?.triggerEvent(AppEvents.IPostLivechatRoomSaved, roomData._id);\n\t\t});\n\n\t\tif (guestData?.name?.trim().length) {\n\t\t\tconst { _id: rid } = roomData;\n\t\t\tconst { name } = guestData;\n\n\t\t\tconst responses = await Promise.all([\n\t\t\t\tRooms.setFnameById(rid, name),\n\t\t\t\tLivechatInquiry.setNameByRoomId(rid, name),\n\t\t\t\tSubscriptions.updateDisplayNameByRoomId(rid, name),\n\t\t\t]);\n\n\t\t\tif (responses[1]?.modifiedCount) {\n\t\t\t\tvoid notifyOnLivechatInquiryChangedByRoom(rid, 'updated', { name });\n\t\t\t}\n\n\t\t\tif (responses[2]?.modifiedCount) {\n\t\t\t\tawait notifyOnSubscriptionChangedByRoomId(rid);\n\t\t\t}\n\t\t}\n\n\t\tvoid notifyOnRoomChangedById(roomData._id);\n\n\t\treturn true;\n\t}\n}\n\nexport const Livechat = new LivechatClass();\n"]}}},"code":"!module.wrapAsync(async function (module, __reifyWaitForDeps__, __reify_async_result__) {\n  \"use strict\";\n  try {\n    let _objectSpread;\n    module.link(\"@babel/runtime/helpers/objectSpread2\", {\n      default(v) {\n        _objectSpread = v;\n      }\n    }, 0);\n    let _asyncIterator;\n    module.link(\"@babel/runtime/helpers/asyncIterator\", {\n      default(v) {\n        _asyncIterator = v;\n      }\n    }, 1);\n    module.export({\n      Livechat: () => Livechat\n    });\n    let Apps, AppEvents;\n    module.link(\"@rocket.chat/apps\", {\n      Apps(v) {\n        Apps = v;\n      },\n      AppEvents(v) {\n        AppEvents = v;\n      }\n    }, 0);\n    let Message, VideoConf, api, Omnichannel;\n    module.link(\"@rocket.chat/core-services\", {\n      Message(v) {\n        Message = v;\n      },\n      VideoConf(v) {\n        VideoConf = v;\n      },\n      api(v) {\n        api = v;\n      },\n      Omnichannel(v) {\n        Omnichannel = v;\n      }\n    }, 1);\n    let OmnichannelSourceType, ILivechatAgentStatus, UserStatus, isOmnichannelRoom;\n    module.link(\"@rocket.chat/core-typings\", {\n      OmnichannelSourceType(v) {\n        OmnichannelSourceType = v;\n      },\n      ILivechatAgentStatus(v) {\n        ILivechatAgentStatus = v;\n      },\n      UserStatus(v) {\n        UserStatus = v;\n      },\n      isOmnichannelRoom(v) {\n        isOmnichannelRoom = v;\n      }\n    }, 2);\n    let Logger;\n    module.link(\"@rocket.chat/logger\", {\n      Logger(v) {\n        Logger = v;\n      }\n    }, 3);\n    let LivechatDepartment, LivechatInquiry, LivechatRooms, Subscriptions, LivechatVisitors, Messages, Users, LivechatDepartmentAgents, ReadReceipts, Rooms, LivechatCustomField, LivechatContacts;\n    module.link(\"@rocket.chat/models\", {\n      LivechatDepartment(v) {\n        LivechatDepartment = v;\n      },\n      LivechatInquiry(v) {\n        LivechatInquiry = v;\n      },\n      LivechatRooms(v) {\n        LivechatRooms = v;\n      },\n      Subscriptions(v) {\n        Subscriptions = v;\n      },\n      LivechatVisitors(v) {\n        LivechatVisitors = v;\n      },\n      Messages(v) {\n        Messages = v;\n      },\n      Users(v) {\n        Users = v;\n      },\n      LivechatDepartmentAgents(v) {\n        LivechatDepartmentAgents = v;\n      },\n      ReadReceipts(v) {\n        ReadReceipts = v;\n      },\n      Rooms(v) {\n        Rooms = v;\n      },\n      LivechatCustomField(v) {\n        LivechatCustomField = v;\n      },\n      LivechatContacts(v) {\n        LivechatContacts = v;\n      }\n    }, 4);\n    let fetch;\n    module.link(\"@rocket.chat/server-fetch\", {\n      serverFetch(v) {\n        fetch = v;\n      }\n    }, 5);\n    let Match, check;\n    module.link(\"meteor/check\", {\n      Match(v) {\n        Match = v;\n      },\n      check(v) {\n        check = v;\n      }\n    }, 6);\n    let Meteor;\n    module.link(\"meteor/meteor\", {\n      Meteor(v) {\n        Meteor = v;\n      }\n    }, 7);\n    let UAParser;\n    module.link(\"ua-parser-js\", {\n      default(v) {\n        UAParser = v;\n      }\n    }, 8);\n    let callbacks;\n    module.link(\"../../../../lib/callbacks\", {\n      callbacks(v) {\n        callbacks = v;\n      }\n    }, 9);\n    let trim;\n    module.link(\"../../../../lib/utils/stringUtils\", {\n      trim(v) {\n        trim = v;\n      }\n    }, 10);\n    let client;\n    module.link(\"../../../../server/database/utils\", {\n      client(v) {\n        client = v;\n      }\n    }, 11);\n    let i18n;\n    module.link(\"../../../../server/lib/i18n\", {\n      i18n(v) {\n        i18n = v;\n      }\n    }, 12);\n    let addUserRolesAsync;\n    module.link(\"../../../../server/lib/roles/addUserRoles\", {\n      addUserRolesAsync(v) {\n        addUserRolesAsync = v;\n      }\n    }, 13);\n    let removeUserFromRolesAsync;\n    module.link(\"../../../../server/lib/roles/removeUserFromRoles\", {\n      removeUserFromRolesAsync(v) {\n        removeUserFromRolesAsync = v;\n      }\n    }, 14);\n    let canAccessRoomAsync;\n    module.link(\"../../../authorization/server\", {\n      canAccessRoomAsync(v) {\n        canAccessRoomAsync = v;\n      }\n    }, 15);\n    let hasPermissionAsync;\n    module.link(\"../../../authorization/server/functions/hasPermission\", {\n      hasPermissionAsync(v) {\n        hasPermissionAsync = v;\n      }\n    }, 16);\n    let hasRoleAsync;\n    module.link(\"../../../authorization/server/functions/hasRole\", {\n      hasRoleAsync(v) {\n        hasRoleAsync = v;\n      }\n    }, 17);\n    let FileUpload;\n    module.link(\"../../../file-upload/server\", {\n      FileUpload(v) {\n        FileUpload = v;\n      }\n    }, 18);\n    let deleteMessage;\n    module.link(\"../../../lib/server/functions/deleteMessage\", {\n      deleteMessage(v) {\n        deleteMessage = v;\n      }\n    }, 19);\n    let sendMessage;\n    module.link(\"../../../lib/server/functions/sendMessage\", {\n      sendMessage(v) {\n        sendMessage = v;\n      }\n    }, 20);\n    let updateMessage;\n    module.link(\"../../../lib/server/functions/updateMessage\", {\n      updateMessage(v) {\n        updateMessage = v;\n      }\n    }, 21);\n    let notifyOnLivechatInquiryChanged, notifyOnLivechatInquiryChangedByRoom, notifyOnRoomChangedById, notifyOnLivechatInquiryChangedByToken, notifyOnUserChange, notifyOnSubscriptionChangedByRoomId, notifyOnSubscriptionChanged;\n    module.link(\"../../../lib/server/lib/notifyListener\", {\n      notifyOnLivechatInquiryChanged(v) {\n        notifyOnLivechatInquiryChanged = v;\n      },\n      notifyOnLivechatInquiryChangedByRoom(v) {\n        notifyOnLivechatInquiryChangedByRoom = v;\n      },\n      notifyOnRoomChangedById(v) {\n        notifyOnRoomChangedById = v;\n      },\n      notifyOnLivechatInquiryChangedByToken(v) {\n        notifyOnLivechatInquiryChangedByToken = v;\n      },\n      notifyOnUserChange(v) {\n        notifyOnUserChange = v;\n      },\n      notifyOnSubscriptionChangedByRoomId(v) {\n        notifyOnSubscriptionChangedByRoomId = v;\n      },\n      notifyOnSubscriptionChanged(v) {\n        notifyOnSubscriptionChanged = v;\n      }\n    }, 22);\n    let metrics;\n    module.link(\"../../../metrics/server\", {\n      metrics(v) {\n        metrics = v;\n      }\n    }, 23);\n    let settings;\n    module.link(\"../../../settings/server\", {\n      settings(v) {\n        settings = v;\n      }\n    }, 24);\n    let businessHourManager;\n    module.link(\"../business-hour\", {\n      businessHourManager(v) {\n        businessHourManager = v;\n      }\n    }, 25);\n    let createContact, createContactFromVisitor, isSingleContactEnabled;\n    module.link(\"./Contacts\", {\n      createContact(v) {\n        createContact = v;\n      },\n      createContactFromVisitor(v) {\n        createContactFromVisitor = v;\n      },\n      isSingleContactEnabled(v) {\n        isSingleContactEnabled = v;\n      }\n    }, 26);\n    let parseAgentCustomFields, updateDepartmentAgents, validateEmail, normalizeTransferredByData;\n    module.link(\"./Helper\", {\n      parseAgentCustomFields(v) {\n        parseAgentCustomFields = v;\n      },\n      updateDepartmentAgents(v) {\n        updateDepartmentAgents = v;\n      },\n      validateEmail(v) {\n        validateEmail = v;\n      },\n      normalizeTransferredByData(v) {\n        normalizeTransferredByData = v;\n      }\n    }, 27);\n    let QueueManager;\n    module.link(\"./QueueManager\", {\n      QueueManager(v) {\n        QueueManager = v;\n      }\n    }, 28);\n    let RoutingManager;\n    module.link(\"./RoutingManager\", {\n      RoutingManager(v) {\n        RoutingManager = v;\n      }\n    }, 29);\n    let getRequiredDepartment;\n    module.link(\"./departmentsLib\", {\n      getRequiredDepartment(v) {\n        getRequiredDepartment = v;\n      }\n    }, 30);\n    let parseTranscriptRequest;\n    module.link(\"./parseTranscriptRequest\", {\n      parseTranscriptRequest(v) {\n        parseTranscriptRequest = v;\n      }\n    }, 31);\n    if (__reifyWaitForDeps__()) (await __reifyWaitForDeps__())();\n    const isRoomClosedByUserParams = params => params.user !== undefined;\n    const isRoomClosedByVisitorParams = params => params.visitor !== undefined;\n    class LivechatClass {\n      constructor() {\n        this.logger = void 0;\n        this.webhookLogger = void 0;\n        this.logger = new Logger('Livechat');\n        this.webhookLogger = this.logger.section('Webhook');\n      }\n      async online(department) {\n        let skipNoAgentSetting = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : false;\n        let skipFallbackCheck = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : false;\n        Livechat.logger.debug(\"Checking online agents \".concat(department ? \"for department \".concat(department) : ''));\n        if (!skipNoAgentSetting && settings.get('Livechat_accept_chats_with_no_agents')) {\n          Livechat.logger.debug('Can accept without online agents: true');\n          return true;\n        }\n        if (settings.get('Livechat_assign_new_conversation_to_bot')) {\n          Livechat.logger.debug(\"Fetching online bot agents for department \".concat(department));\n          const botAgents = await Livechat.getBotAgents(department);\n          if (botAgents) {\n            const onlineBots = await botAgents.count();\n            this.logger.debug(\"Found \".concat(onlineBots, \" online\"));\n            if (onlineBots > 0) {\n              return true;\n            }\n          }\n        }\n        const agentsOnline = await this.checkOnlineAgents(department, undefined, skipFallbackCheck);\n        Livechat.logger.debug(\"Are online agents \".concat(department ? \"for department \".concat(department) : '', \"?: \").concat(agentsOnline));\n        return agentsOnline;\n      }\n      async closeRoom(params) {\n        let attempts = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : 2;\n        let newRoom;\n        let chatCloser;\n        let removedInquiryObj;\n        const session = client.startSession();\n        try {\n          session.startTransaction();\n          const {\n            room,\n            closedBy,\n            removedInquiry\n          } = await this.doCloseRoom(params, session);\n          await session.commitTransaction();\n          newRoom = room;\n          chatCloser = closedBy;\n          removedInquiryObj = removedInquiry;\n        } catch (e) {\n          var _e$errorLabels, _e$errorLabels2;\n          this.logger.error({\n            err: e,\n            msg: 'Failed to close room',\n            afterAttempts: attempts\n          });\n          await session.abortTransaction();\n          // Dont propagate transaction errors\n          if (e !== null && e !== void 0 && (_e$errorLabels = e.errorLabels) !== null && _e$errorLabels !== void 0 && _e$errorLabels.includes('UnknownTransactionCommitResult') || e !== null && e !== void 0 && (_e$errorLabels2 = e.errorLabels) !== null && _e$errorLabels2 !== void 0 && _e$errorLabels2.includes('TransientTransactionError')) {\n            if (attempts > 0) {\n              this.logger.debug(\"Retrying close room because of transient error. Attempts left: \".concat(attempts));\n              return this.closeRoom(params, attempts - 1);\n            }\n            throw new Error('error-room-cannot-be-closed-try-again');\n          }\n          throw e;\n        } finally {\n          await session.endSession();\n        }\n        // Note: when reaching this point, the room has been closed\n        // Transaction is commited and so these messages can be sent here.\n        return this.afterRoomClosed(newRoom, chatCloser, removedInquiryObj, params);\n      }\n      async afterRoomClosed(newRoom, chatCloser, inquiry, params) {\n        var _params$comment;\n        if (!chatCloser) {\n          // this should never happen\n          return;\n        }\n        // Note: we are okay with these messages being sent outside of the transaction. The process of sending a message\n        // is huge and involves multiple db calls. Making it transactionable this way would be really hard.\n        // And passing just _some_ actions to the transaction creates some deadlocks since messages are updated in the afterSaveMessages callbacks.\n        const transcriptRequested = !!params.room.transcriptRequest || !settings.get('Livechat_enable_transcript') && settings.get('Livechat_transcript_send_always');\n        this.logger.debug(\"Sending closing message to room \".concat(newRoom._id));\n        await Message.saveSystemMessageAndNotifyUser('livechat-close', newRoom._id, (_params$comment = params.comment) !== null && _params$comment !== void 0 ? _params$comment : '', chatCloser, _objectSpread({\n          groupable: false,\n          transcriptRequested\n        }, isRoomClosedByVisitorParams(params) && {\n          token: params.visitor.token\n        }));\n        if (settings.get('Livechat_enable_transcript') && !settings.get('Livechat_transcript_send_always')) {\n          await Message.saveSystemMessage('command', newRoom._id, 'promptTranscript', chatCloser);\n        }\n        this.logger.debug(\"Running callbacks for room \".concat(newRoom._id));\n        process.nextTick(() => {\n          var _Apps$self, _Apps$self$getBridges, _Apps$self2, _Apps$self2$getBridge;\n          /**\n           * @deprecated the `AppEvents.ILivechatRoomClosedHandler` event will be removed\n           * in the next major version of the Apps-Engine\n           */\n          void ((_Apps$self = Apps.self) === null || _Apps$self === void 0 ? void 0 : (_Apps$self$getBridges = _Apps$self.getBridges()) === null || _Apps$self$getBridges === void 0 ? void 0 : _Apps$self$getBridges.getListenerBridge().livechatEvent(AppEvents.ILivechatRoomClosedHandler, newRoom));\n          void ((_Apps$self2 = Apps.self) === null || _Apps$self2 === void 0 ? void 0 : (_Apps$self2$getBridge = _Apps$self2.getBridges()) === null || _Apps$self2$getBridge === void 0 ? void 0 : _Apps$self2$getBridge.getListenerBridge().livechatEvent(AppEvents.IPostLivechatRoomClosed, newRoom));\n        });\n        const visitor = isRoomClosedByVisitorParams(params) ? params.visitor : undefined;\n        const opts = await parseTranscriptRequest(params.room, params.options, visitor);\n        if (process.env.TEST_MODE) {\n          await callbacks.run('livechat.closeRoom', {\n            room: newRoom,\n            options: opts\n          });\n        } else {\n          callbacks.runAsync('livechat.closeRoom', {\n            room: newRoom,\n            options: opts\n          });\n        }\n        void notifyOnRoomChangedById(newRoom._id);\n        if (inquiry) {\n          void notifyOnLivechatInquiryChanged(inquiry, 'removed');\n        }\n        this.logger.debug(\"Room \".concat(newRoom._id, \" was closed\"));\n      }\n      async doCloseRoom(params, session) {\n        const {\n          comment\n        } = params;\n        const {\n          room\n        } = params;\n        this.logger.debug(\"Attempting to close room \".concat(room._id));\n        if (!room || !isOmnichannelRoom(room) || !room.open) {\n          this.logger.debug(\"Room \".concat(room._id, \" is not open\"));\n          throw new Error('error-room-closed');\n        }\n        const commentRequired = settings.get('Livechat_request_comment_when_closing_conversation');\n        if (commentRequired && !(comment !== null && comment !== void 0 && comment.trim())) {\n          throw new Error('error-comment-is-required');\n        }\n        const {\n          updatedOptions: options\n        } = await this.resolveChatTags(room, params.options);\n        this.logger.debug(\"Resolved chat tags for room \".concat(room._id));\n        const now = new Date();\n        const {\n          _id: rid,\n          servedBy\n        } = room;\n        const serviceTimeDuration = servedBy && (now.getTime() - new Date(servedBy.ts).getTime()) / 1000;\n        const closeData = _objectSpread(_objectSpread({\n          closedAt: now,\n          chatDuration: (now.getTime() - new Date(room.ts).getTime()) / 1000\n        }, serviceTimeDuration && {\n          serviceTimeDuration\n        }), options);\n        this.logger.debug(\"Room \".concat(room._id, \" was closed at \").concat(closeData.closedAt, \" (duration \").concat(closeData.chatDuration, \")\"));\n        if (isRoomClosedByUserParams(params)) {\n          const {\n            user\n          } = params;\n          this.logger.debug(\"Closing by user \".concat(user === null || user === void 0 ? void 0 : user._id));\n          closeData.closer = 'user';\n          closeData.closedBy = {\n            _id: (user === null || user === void 0 ? void 0 : user._id) || '',\n            username: user === null || user === void 0 ? void 0 : user.username\n          };\n        } else if (isRoomClosedByVisitorParams(params)) {\n          const {\n            visitor\n          } = params;\n          this.logger.debug(\"Closing by visitor \".concat(params.visitor._id));\n          closeData.closer = 'visitor';\n          closeData.closedBy = {\n            _id: visitor._id,\n            username: visitor.username\n          };\n        } else {\n          throw new Error('Error: Please provide details of the user or visitor who closed the room');\n        }\n        this.logger.debug(\"Updating DB for room \".concat(room._id, \" with close data\"));\n        const inquiry = await LivechatInquiry.findOneByRoomId(rid, {\n          session\n        });\n        const removedInquiry = await LivechatInquiry.removeByRoomId(rid, {\n          session\n        });\n        if (removedInquiry && removedInquiry.deletedCount !== 1) {\n          throw new Error('Error removing inquiry');\n        }\n        const updatedRoom = await LivechatRooms.closeRoomById(rid, closeData, {\n          session\n        });\n        if (!updatedRoom || updatedRoom.modifiedCount !== 1) {\n          throw new Error('Error closing room');\n        }\n        const subs = await Subscriptions.countByRoomId(rid, {\n          session\n        });\n        const removedSubs = await Subscriptions.removeByRoomId(rid, {\n          async onTrash(doc) {\n            void notifyOnSubscriptionChanged(doc, 'removed');\n          },\n          session\n        });\n        if (removedSubs.deletedCount !== subs) {\n          throw new Error('Error removing subscriptions');\n        }\n        this.logger.debug(\"DB updated for room \".concat(room._id));\n        // Retrieve the closed room\n        const newRoom = await LivechatRooms.findOneById(rid, {\n          session\n        });\n        if (!newRoom) {\n          throw new Error('Error: Room not found');\n        }\n        return {\n          room: newRoom,\n          closedBy: closeData.closedBy,\n          removedInquiry: inquiry\n        };\n      }\n      async createRoom(_ref) {\n        let {\n          visitor,\n          message,\n          rid,\n          roomInfo,\n          agent,\n          extraData\n        } = _ref;\n        if (!settings.get('Livechat_enabled')) {\n          throw new Meteor.Error('error-omnichannel-is-disabled');\n        }\n        const defaultAgent = await callbacks.run('livechat.checkDefaultAgentOnNewRoom', agent, visitor);\n        // if no department selected verify if there is at least one active and pick the first\n        if (!defaultAgent && !visitor.department) {\n          const department = await getRequiredDepartment();\n          Livechat.logger.debug(\"No department or default agent selected for \".concat(visitor._id));\n          if (department) {\n            Livechat.logger.debug(\"Assigning \".concat(visitor._id, \" to department \").concat(department._id));\n            visitor.department = department._id;\n          }\n        }\n        // delegate room creation to QueueManager\n        Livechat.logger.debug(\"Calling QueueManager to request a room for visitor \".concat(visitor._id));\n        const room = await QueueManager.requestRoom({\n          guest: visitor,\n          message,\n          rid,\n          roomInfo,\n          agent: defaultAgent,\n          extraData\n        });\n        if (isSingleContactEnabled()) {\n          let {\n            contactId\n          } = visitor;\n          if (!contactId) {\n            const visitorContact = await LivechatVisitors.findOne(visitor._id, {\n              projection: {\n                name: 1,\n                contactManager: 1,\n                livechatData: 1,\n                phone: 1,\n                visitorEmails: 1,\n                username: 1,\n                contactId: 1\n              }\n            });\n            contactId = visitorContact === null || visitorContact === void 0 ? void 0 : visitorContact.contactId;\n          }\n          if (!contactId) {\n            // ensure that old visitors have a contact\n            contactId = await createContactFromVisitor(visitor);\n          }\n          const contact = await LivechatContacts.findOneById(contactId, {\n            projection: {\n              _id: 1,\n              channels: 1\n            }\n          });\n          if (contact) {\n            var _contact$channels;\n            const channel = (_contact$channels = contact.channels) === null || _contact$channels === void 0 ? void 0 : _contact$channels.find(channel => {\n              var _roomInfo$source;\n              return channel.name === ((_roomInfo$source = roomInfo.source) === null || _roomInfo$source === void 0 ? void 0 : _roomInfo$source.type) && channel.visitorId === visitor._id;\n            });\n            if (!channel) {\n              var _roomInfo$source2, _roomInfo$source3;\n              Livechat.logger.debug(\"Adding channel for contact \".concat(contact._id));\n              await LivechatContacts.addChannel(contact._id, {\n                name: ((_roomInfo$source2 = roomInfo.source) === null || _roomInfo$source2 === void 0 ? void 0 : _roomInfo$source2.label) || ((_roomInfo$source3 = roomInfo.source) === null || _roomInfo$source3 === void 0 ? void 0 : _roomInfo$source3.type.toString()) || OmnichannelSourceType.OTHER,\n                visitorId: visitor._id,\n                blocked: false,\n                verified: false,\n                details: roomInfo.source\n              });\n            }\n          }\n        }\n        Livechat.logger.debug(\"Room obtained for visitor \".concat(visitor._id, \" -> \").concat(room._id));\n        await Messages.setRoomIdByToken(visitor.token, room._id);\n        return room;\n      }\n      async getRoom(guest, message, roomInfo, agent, extraData) {\n        if (!settings.get('Livechat_enabled')) {\n          throw new Meteor.Error('error-omnichannel-is-disabled');\n        }\n        Livechat.logger.debug(\"Attempting to find or create a room for visitor \".concat(guest._id));\n        const room = await LivechatRooms.findOneById(message.rid);\n        if (room && !room.open) {\n          Livechat.logger.debug(\"Last room for visitor \".concat(guest._id, \" closed. Creating new one\"));\n        }\n        if (!(room !== null && room !== void 0 && room.open)) {\n          return {\n            room: await this.createRoom({\n              visitor: guest,\n              message: message.msg,\n              roomInfo,\n              agent,\n              extraData\n            }),\n            newRoom: true\n          };\n        }\n        if (room.v.token !== guest.token) {\n          Livechat.logger.debug(\"Visitor \".concat(guest._id, \" trying to access another visitor's room\"));\n          throw new Meteor.Error('cannot-access-room');\n        }\n        return {\n          room,\n          newRoom: false\n        };\n      }\n      async checkOnlineAgents(department, agent) {\n        let skipFallbackCheck = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : false;\n        if (agent !== null && agent !== void 0 && agent.agentId) {\n          return Users.checkOnlineAgents(agent.agentId);\n        }\n        if (department) {\n          const onlineForDep = await LivechatDepartmentAgents.checkOnlineForDepartment(department);\n          if (onlineForDep || skipFallbackCheck) {\n            return onlineForDep;\n          }\n          const dep = await LivechatDepartment.findOneById(department, {\n            projection: {\n              fallbackForwardDepartment: 1\n            }\n          });\n          if (!(dep !== null && dep !== void 0 && dep.fallbackForwardDepartment)) {\n            return onlineForDep;\n          }\n          return this.checkOnlineAgents(dep === null || dep === void 0 ? void 0 : dep.fallbackForwardDepartment);\n        }\n        return Users.checkOnlineAgents();\n      }\n      async removeRoom(rid) {\n        var _result$, _result$3$value;\n        Livechat.logger.debug(\"Deleting room \".concat(rid));\n        check(rid, String);\n        const room = await LivechatRooms.findOneById(rid);\n        if (!room) {\n          throw new Meteor.Error('error-invalid-room', 'Invalid room');\n        }\n        const inquiry = await LivechatInquiry.findOneByRoomId(rid);\n        const result = await Promise.allSettled([Messages.removeByRoomId(rid), ReadReceipts.removeByRoomId(rid), Subscriptions.removeByRoomId(rid, {\n          async onTrash(doc) {\n            void notifyOnSubscriptionChanged(doc, 'removed');\n          }\n        }), LivechatInquiry.removeByRoomId(rid), LivechatRooms.removeById(rid)]);\n        if (((_result$ = result[3]) === null || _result$ === void 0 ? void 0 : _result$.status) === 'fulfilled' && (_result$3$value = result[3].value) !== null && _result$3$value !== void 0 && _result$3$value.deletedCount && inquiry) {\n          void notifyOnLivechatInquiryChanged(inquiry, 'removed');\n        }\n        for (const r of result) {\n          if (r.status === 'rejected') {\n            this.logger.error(\"Error removing room \".concat(rid, \": \").concat(r.reason));\n            throw new Meteor.Error('error-removing-room', 'Error removing room');\n          }\n        }\n      }\n      isValidObject(obj) {\n        return typeof obj === 'object' && obj !== null;\n      }\n      async registerGuest(_ref2) {\n        let {\n          id,\n          token,\n          name,\n          phone,\n          email,\n          department,\n          username,\n          connectionData,\n          status = UserStatus.ONLINE\n        } = _ref2;\n        check(token, String);\n        check(id, Match.Maybe(String));\n        Livechat.logger.debug(\"New incoming conversation: id: \".concat(id, \" | token: \").concat(token));\n        const visitorDataToUpdate = _objectSpread(_objectSpread({\n          token,\n          status\n        }, phone !== null && phone !== void 0 && phone.number ? {\n          phone: [{\n            phoneNumber: phone.number\n          }]\n        } : {}), name ? {\n          name\n        } : {});\n        if (email) {\n          const visitorEmail = email.trim().toLowerCase();\n          validateEmail(visitorEmail);\n          visitorDataToUpdate.visitorEmails = [{\n            address: visitorEmail\n          }];\n        }\n        const livechatVisitor = await LivechatVisitors.getVisitorByToken(token, {\n          projection: {\n            _id: 1\n          }\n        });\n        if ((livechatVisitor === null || livechatVisitor === void 0 ? void 0 : livechatVisitor.department) !== department && department) {\n          Livechat.logger.debug(\"Attempt to find a department with id/name \".concat(department));\n          const dep = await LivechatDepartment.findOneByIdOrName(department, {\n            projection: {\n              _id: 1\n            }\n          });\n          if (!dep) {\n            Livechat.logger.debug(\"Invalid department provided: \".concat(department));\n            throw new Meteor.Error('error-invalid-department', 'The provided department is invalid');\n          }\n          Livechat.logger.debug(\"Assigning visitor \".concat(token, \" to department \").concat(dep._id));\n          visitorDataToUpdate.department = dep._id;\n        }\n        visitorDataToUpdate.token = (livechatVisitor === null || livechatVisitor === void 0 ? void 0 : livechatVisitor.token) || token;\n        let existingUser = null;\n        if (livechatVisitor) {\n          Livechat.logger.debug('Found matching user by token');\n          visitorDataToUpdate._id = livechatVisitor._id;\n        } else if (phone !== null && phone !== void 0 && phone.number && (existingUser = await LivechatVisitors.findOneVisitorByPhone(phone.number))) {\n          Livechat.logger.debug('Found matching user by phone number');\n          visitorDataToUpdate._id = existingUser._id;\n          // Don't change token when matching by phone number, use current visitor token\n          visitorDataToUpdate.token = existingUser.token;\n        } else if (email && (existingUser = await LivechatVisitors.findOneGuestByEmailAddress(email))) {\n          Livechat.logger.debug('Found matching user by email');\n          visitorDataToUpdate._id = existingUser._id;\n        } else if (!livechatVisitor) {\n          Livechat.logger.debug(\"No matches found. Attempting to create new user with token \".concat(token));\n          visitorDataToUpdate._id = id || undefined;\n          visitorDataToUpdate.username = username || (await LivechatVisitors.getNextVisitorUsername());\n          visitorDataToUpdate.status = status;\n          visitorDataToUpdate.ts = new Date();\n          if (settings.get('Livechat_Allow_collect_and_store_HTTP_header_informations') && Livechat.isValidObject(connectionData)) {\n            Livechat.logger.debug(\"Saving connection data for visitor \".concat(token));\n            const {\n              httpHeaders,\n              clientAddress\n            } = connectionData;\n            if (Livechat.isValidObject(httpHeaders)) {\n              visitorDataToUpdate.userAgent = httpHeaders['user-agent'];\n              visitorDataToUpdate.ip = httpHeaders['x-real-ip'] || httpHeaders['x-forwarded-for'] || clientAddress;\n              visitorDataToUpdate.host = httpHeaders === null || httpHeaders === void 0 ? void 0 : httpHeaders.host;\n            }\n          }\n        }\n        if (isSingleContactEnabled()) {\n          const contactId = await createContact({\n            name: name !== null && name !== void 0 ? name : visitorDataToUpdate.username,\n            emails: email ? [email] : [],\n            phones: phone ? [phone.number] : [],\n            unknown: true\n          });\n          visitorDataToUpdate.contactId = contactId;\n        }\n        const upsertedLivechatVisitor = await LivechatVisitors.updateOneByIdOrToken(visitorDataToUpdate, {\n          upsert: true,\n          returnDocument: 'after'\n        });\n        if (!upsertedLivechatVisitor.value) {\n          Livechat.logger.debug(\"No visitor found after upsert\");\n          return null;\n        }\n        return upsertedLivechatVisitor.value;\n      }\n      async getBotAgents(department) {\n        if (department) {\n          return LivechatDepartmentAgents.getBotsForDepartment(department);\n        }\n        return Users.findBotAgents();\n      }\n      async resolveChatTags(room) {\n        let options = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};\n        this.logger.debug(\"Resolving chat tags for room \".concat(room._id));\n        const concatUnique = function () {\n          for (var _len = arguments.length, arrays = new Array(_len), _key = 0; _key < _len; _key++) {\n            arrays[_key] = arguments[_key];\n          }\n          return [...new Set([].concat(...arrays.filter(a => !!a)))];\n        };\n        const {\n          departmentId,\n          tags: optionsTags\n        } = room;\n        const {\n          clientAction,\n          tags: oldRoomTags\n        } = options;\n        const roomTags = concatUnique(oldRoomTags, optionsTags);\n        if (!departmentId) {\n          return {\n            updatedOptions: _objectSpread(_objectSpread({}, options), roomTags.length && {\n              tags: roomTags\n            })\n          };\n        }\n        const department = await LivechatDepartment.findOneById(departmentId, {\n          projection: {\n            requestTagBeforeClosingChat: 1,\n            chatClosingTags: 1\n          }\n        });\n        if (!department) {\n          return {\n            updatedOptions: _objectSpread(_objectSpread({}, options), roomTags.length && {\n              tags: roomTags\n            })\n          };\n        }\n        const {\n          requestTagBeforeClosingChat,\n          chatClosingTags\n        } = department;\n        const extraRoomTags = concatUnique(roomTags, chatClosingTags);\n        if (!requestTagBeforeClosingChat) {\n          return {\n            updatedOptions: _objectSpread(_objectSpread({}, options), extraRoomTags.length && {\n              tags: extraRoomTags\n            })\n          };\n        }\n        const checkRoomTags = !clientAction || roomTags && roomTags.length > 0;\n        const checkDepartmentTags = chatClosingTags && chatClosingTags.length > 0;\n        if (!checkRoomTags || !checkDepartmentTags) {\n          throw new Error('error-tags-must-be-assigned-before-closing-chat');\n        }\n        return {\n          updatedOptions: _objectSpread(_objectSpread({}, options), extraRoomTags.length && {\n            tags: extraRoomTags\n          })\n        };\n      }\n      async sendRequest(postData) {\n        let attempts = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : 10;\n        if (!attempts) {\n          Livechat.logger.error({\n            msg: 'Omnichannel webhook call failed. Max attempts reached'\n          });\n          return;\n        }\n        const timeout = settings.get('Livechat_http_timeout');\n        const secretToken = settings.get('Livechat_secret_token');\n        const webhookUrl = settings.get('Livechat_webhookUrl');\n        try {\n          Livechat.webhookLogger.debug({\n            msg: 'Sending webhook request',\n            postData\n          });\n          const result = await fetch(webhookUrl, {\n            method: 'POST',\n            headers: _objectSpread({}, secretToken && {\n              'X-RocketChat-Livechat-Token': secretToken\n            }),\n            body: postData,\n            timeout\n          });\n          if (result.status === 200) {\n            metrics.totalLivechatWebhooksSuccess.inc();\n            return result;\n          }\n          metrics.totalLivechatWebhooksFailures.inc();\n          throw new Error(await result.text());\n        } catch (err) {\n          const retryAfter = timeout * 4;\n          Livechat.webhookLogger.error({\n            msg: \"Error response on \".concat(11 - attempts, \" try ->\"),\n            err\n          });\n          // try 10 times after 20 seconds each\n          attempts - 1 && Livechat.webhookLogger.warn({\n            msg: \"Webhook call failed. Retrying\",\n            newAttemptAfterSeconds: retryAfter / 1000,\n            webhookUrl\n          });\n          setTimeout(async () => {\n            await Livechat.sendRequest(postData, attempts - 1);\n          }, retryAfter);\n        }\n      }\n      async saveAgentInfo(_id, agentData, agentDepartments) {\n        check(_id, String);\n        check(agentData, Object);\n        check(agentDepartments, [String]);\n        const user = await Users.findOneById(_id);\n        if (!user || !(await hasRoleAsync(_id, 'livechat-agent'))) {\n          throw new Meteor.Error('error-user-is-not-agent', 'User is not a livechat agent');\n        }\n        await Users.setLivechatData(_id, agentData);\n        const currentDepartmentsForAgent = await LivechatDepartmentAgents.findByAgentId(_id).toArray();\n        const toRemoveIds = currentDepartmentsForAgent.filter(dept => !agentDepartments.includes(dept.departmentId)).map(dept => dept.departmentId);\n        const toAddIds = agentDepartments.filter(d => !currentDepartmentsForAgent.some(c => c.departmentId === d));\n        await Promise.all(await LivechatDepartment.findInIds([...toRemoveIds, ...toAddIds], {\n          projection: {\n            _id: 1,\n            enabled: 1\n          }\n        }).map(dep => {\n          return updateDepartmentAgents(dep._id, _objectSpread({}, toRemoveIds.includes(dep._id) ? {\n            remove: [{\n              agentId: _id\n            }]\n          } : {\n            upsert: [{\n              agentId: _id,\n              count: 0,\n              order: 0\n            }]\n          }), dep.enabled);\n        }).toArray());\n        return true;\n      }\n      async updateCallStatus(callId, rid, status, user) {\n        await Rooms.setCallStatus(rid, status);\n        if (status === 'ended' || status === 'declined') {\n          if (await VideoConf.declineLivechatCall(callId)) {\n            return;\n          }\n          return updateMessage({\n            _id: callId,\n            msg: status,\n            actionLinks: [],\n            webRtcCallEndTs: new Date(),\n            rid\n          }, user);\n        }\n      }\n      notifyRoomVisitorChange(roomId, visitor) {\n        void api.broadcast('omnichannel.room', roomId, {\n          type: 'visitorData',\n          visitor\n        });\n      }\n      async changeRoomVisitor(userId, room, visitor) {\n        const user = await Users.findOneById(userId, {\n          projection: {\n            _id: 1\n          }\n        });\n        if (!user) {\n          throw new Error('error-user-not-found');\n        }\n        if (!(await canAccessRoomAsync(room, user))) {\n          throw new Error('error-not-allowed');\n        }\n        await LivechatRooms.changeVisitorByRoomId(room._id, visitor);\n        this.notifyRoomVisitorChange(room._id, visitor);\n        return LivechatRooms.findOneById(room._id);\n      }\n      async notifyAgentStatusChanged(userId, status) {\n        if (!status) {\n          return;\n        }\n        void callbacks.runAsync('livechat.agentStatusChanged', {\n          userId,\n          status\n        });\n        if (!settings.get('Livechat_show_agent_info')) {\n          return;\n        }\n        await LivechatRooms.findOpenByAgent(userId).forEach(room => {\n          void api.broadcast('omnichannel.room', room._id, {\n            type: 'agentStatus',\n            status\n          });\n        });\n      }\n      async updateMessage(_ref3) {\n        let {\n          guest,\n          message\n        } = _ref3;\n        check(message, Match.ObjectIncluding({\n          _id: String\n        }));\n        const originalMessage = await Messages.findOneById(message._id, {\n          projection: {\n            u: 1\n          }\n        });\n        if (!(originalMessage !== null && originalMessage !== void 0 && originalMessage._id)) {\n          return;\n        }\n        const editAllowed = settings.get('Message_AllowEditing');\n        const editOwn = originalMessage.u && originalMessage.u._id === guest._id;\n        if (!editAllowed || !editOwn) {\n          throw new Error('error-action-not-allowed');\n        }\n        // TODO: Apps sends an `any` object and apparently we just check for _id being present\n        // while updateMessage expects AtLeast<id, msg, rid>\n        await updateMessage(message, guest);\n        return true;\n      }\n      async closeOpenChats(userId, comment) {\n        this.logger.debug(\"Closing open chats for user \".concat(userId));\n        const user = await Users.findOneById(userId);\n        const extraQuery = await callbacks.run('livechat.applyDepartmentRestrictions', {}, {\n          userId\n        });\n        const openChats = LivechatRooms.findOpenByAgent(userId, extraQuery);\n        const promises = [];\n        await openChats.forEach(room => {\n          promises.push(this.closeRoom({\n            user,\n            room,\n            comment\n          }));\n        });\n        await Promise.all(promises);\n      }\n      async transfer(room, guest, transferData) {\n        var _transferData$transfe;\n        this.logger.debug(\"Transfering room \".concat(room._id, \" [Transfered by: \").concat(transferData === null || transferData === void 0 ? void 0 : (_transferData$transfe = transferData.transferredBy) === null || _transferData$transfe === void 0 ? void 0 : _transferData$transfe._id, \"]\"));\n        if (room.onHold) {\n          throw new Error('error-room-onHold');\n        }\n        if (transferData.departmentId) {\n          var _transferData$departm;\n          const department = await LivechatDepartment.findOneById(transferData.departmentId, {\n            projection: {\n              name: 1\n            }\n          });\n          if (!department) {\n            throw new Error('error-invalid-department');\n          }\n          transferData.department = department;\n          this.logger.debug(\"Transfering room \".concat(room._id, \" to department \").concat((_transferData$departm = transferData.department) === null || _transferData$departm === void 0 ? void 0 : _transferData$departm._id));\n        }\n        return RoutingManager.transferRoom(room, guest, transferData);\n      }\n      async forwardOpenChats(userId) {\n        this.logger.debug(\"Transferring open chats for user \".concat(userId));\n        const user = await Users.findOneById(userId);\n        if (!user) {\n          throw new Error('error-invalid-user');\n        }\n        const {\n          _id,\n          username,\n          name\n        } = user;\n        var _iteratorAbruptCompletion = false;\n        var _didIteratorError = false;\n        var _iteratorError;\n        try {\n          for (var _iterator = _asyncIterator(LivechatRooms.findOpenByAgent(userId)), _step; _iteratorAbruptCompletion = !(_step = await _iterator.next()).done; _iteratorAbruptCompletion = false) {\n            const room = _step.value;\n            {\n              const guest = await LivechatVisitors.findOneEnabledById(room.v._id);\n              if (!guest) {\n                continue;\n              }\n              const transferredBy = normalizeTransferredByData({\n                _id,\n                username,\n                name\n              }, room);\n              await this.transfer(room, guest, {\n                transferredBy,\n                departmentId: guest.department\n              });\n            }\n          }\n        } catch (err) {\n          _didIteratorError = true;\n          _iteratorError = err;\n        } finally {\n          try {\n            if (_iteratorAbruptCompletion && _iterator.return != null) {\n              await _iterator.return();\n            }\n          } finally {\n            if (_didIteratorError) {\n              throw _iteratorError;\n            }\n          }\n        }\n      }\n      showConnecting() {\n        var _RoutingManager$getCo;\n        return ((_RoutingManager$getCo = RoutingManager.getConfig()) === null || _RoutingManager$getCo === void 0 ? void 0 : _RoutingManager$getCo.showConnecting) || false;\n      }\n      async getInitSettings() {\n        const validSettings = ['Livechat_title', 'Livechat_title_color', 'Livechat_enable_message_character_limit', 'Livechat_message_character_limit', 'Message_MaxAllowedSize', 'Livechat_enabled', 'Livechat_registration_form', 'Livechat_allow_switching_departments', 'Livechat_offline_title', 'Livechat_offline_title_color', 'Livechat_offline_message', 'Livechat_offline_success_message', 'Livechat_offline_form_unavailable', 'Livechat_display_offline_form', 'Omnichannel_call_provider', 'Language', 'Livechat_enable_transcript', 'Livechat_transcript_message', 'Livechat_fileupload_enabled', 'FileUpload_Enabled', 'Livechat_conversation_finished_message', 'Livechat_conversation_finished_text', 'Livechat_name_field_registration_form', 'Livechat_email_field_registration_form', 'Livechat_registration_form_message', 'Livechat_force_accept_data_processing_consent', 'Livechat_data_processing_consent_text', 'Livechat_show_agent_info', 'Livechat_clear_local_storage_when_chat_ended', 'Livechat_history_monitor_type', 'Livechat_hide_system_messages', 'Livechat_widget_position', 'Livechat_background', 'Assets_livechat_widget_logo', 'Livechat_hide_watermark', 'Omnichannel_allow_visitors_to_close_conversation'];\n        const rcSettings = validSettings.reduce((acc, setting) => {\n          acc[setting] = settings.get(setting);\n          return acc;\n        }, {});\n        rcSettings.Livechat_Show_Connecting = this.showConnecting();\n        return rcSettings;\n      }\n      async sendMessage(_ref4) {\n        let {\n          guest,\n          message,\n          roomInfo,\n          agent\n        } = _ref4;\n        const {\n          room,\n          newRoom\n        } = await this.getRoom(guest, message, roomInfo, agent);\n        if (guest.name) {\n          message.alias = guest.name;\n        }\n        return Object.assign(await sendMessage(guest, _objectSpread(_objectSpread({}, message), {}, {\n          token: guest.token\n        }), room), {\n          newRoom,\n          showConnecting: this.showConnecting()\n        });\n      }\n      async removeGuest(_id) {\n        const guest = await LivechatVisitors.findOneEnabledById(_id, {\n          projection: {\n            _id: 1,\n            token: 1\n          }\n        });\n        if (!guest) {\n          throw new Error('error-invalid-guest');\n        }\n        await this.cleanGuestHistory(guest);\n        return LivechatVisitors.disableById(_id);\n      }\n      async cleanGuestHistory(guest) {\n        const {\n          token\n        } = guest;\n        // This shouldn't be possible, but just in case\n        if (!token) {\n          throw new Error('error-invalid-guest');\n        }\n        const cursor = LivechatRooms.findByVisitorToken(token);\n        var _iteratorAbruptCompletion2 = false;\n        var _didIteratorError2 = false;\n        var _iteratorError2;\n        try {\n          for (var _iterator2 = _asyncIterator(cursor), _step2; _iteratorAbruptCompletion2 = !(_step2 = await _iterator2.next()).done; _iteratorAbruptCompletion2 = false) {\n            const room = _step2.value;\n            {\n              await Promise.all([Subscriptions.removeByRoomId(room._id, {\n                async onTrash(doc) {\n                  void notifyOnSubscriptionChanged(doc, 'removed');\n                }\n              }), FileUpload.removeFilesByRoomId(room._id), Messages.removeByRoomId(room._id), ReadReceipts.removeByRoomId(room._id)]);\n            }\n          }\n        } catch (err) {\n          _didIteratorError2 = true;\n          _iteratorError2 = err;\n        } finally {\n          try {\n            if (_iteratorAbruptCompletion2 && _iterator2.return != null) {\n              await _iterator2.return();\n            }\n          } finally {\n            if (_didIteratorError2) {\n              throw _iteratorError2;\n            }\n          }\n        }\n        await LivechatRooms.removeByVisitorToken(token);\n        const livechatInquiries = await LivechatInquiry.findIdsByVisitorToken(token).toArray();\n        await LivechatInquiry.removeByIds(livechatInquiries.map(_ref5 => {\n          let {\n            _id\n          } = _ref5;\n          return _id;\n        }));\n        void notifyOnLivechatInquiryChanged(livechatInquiries, 'removed');\n      }\n      async deleteMessage(_ref6) {\n        let {\n          guest,\n          message\n        } = _ref6;\n        const deleteAllowed = settings.get('Message_AllowDeleting');\n        const editOwn = message.u && message.u._id === guest._id;\n        if (!deleteAllowed || !editOwn) {\n          throw new Error('error-action-not-allowed');\n        }\n        await deleteMessage(message, guest);\n        return true;\n      }\n      async setUserStatusLivechatIf(userId, status, condition, fields) {\n        const result = await Users.setLivechatStatusIf(userId, status, condition, fields);\n        if (result.modifiedCount > 0) {\n          void notifyOnUserChange({\n            id: userId,\n            clientAction: 'updated',\n            diff: _objectSpread(_objectSpread({}, fields), {}, {\n              statusLivechat: status\n            })\n          });\n        }\n        callbacks.runAsync('livechat.setUserStatusLivechat', {\n          userId,\n          status\n        });\n        return result;\n      }\n      async returnRoomAsInquiry(room, departmentId) {\n        let overrideTransferData = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : {};\n        this.logger.debug({\n          msg: \"Transfering room to \".concat(departmentId ? 'department' : '', \" queue\"),\n          room\n        });\n        if (!room.open) {\n          throw new Meteor.Error('room-closed');\n        }\n        if (room.onHold) {\n          throw new Meteor.Error('error-room-onHold');\n        }\n        if (!room.servedBy) {\n          return false;\n        }\n        const user = await Users.findOneById(room.servedBy._id);\n        if (!(user !== null && user !== void 0 && user._id)) {\n          throw new Meteor.Error('error-invalid-user');\n        }\n        // find inquiry corresponding to room\n        const inquiry = await LivechatInquiry.findOne({\n          rid: room._id\n        });\n        if (!inquiry) {\n          return false;\n        }\n        const transferredBy = normalizeTransferredByData(user, room);\n        this.logger.debug(\"Transfering room \".concat(room._id, \" by user \").concat(transferredBy._id));\n        const transferData = _objectSpread({\n          roomId: room._id,\n          scope: 'queue',\n          departmentId,\n          transferredBy\n        }, overrideTransferData);\n        try {\n          await this.saveTransferHistory(room, transferData);\n          await RoutingManager.unassignAgent(inquiry, departmentId);\n        } catch (e) {\n          this.logger.error(e);\n          throw new Meteor.Error('error-returning-inquiry');\n        }\n        callbacks.runAsync('livechat:afterReturnRoomAsInquiry', {\n          room\n        });\n        return true;\n      }\n      async saveTransferHistory(room, transferData) {\n        const {\n          departmentId: previousDepartment\n        } = room;\n        const {\n          department: nextDepartment,\n          transferredBy,\n          transferredTo,\n          scope,\n          comment\n        } = transferData;\n        check(transferredBy, Match.ObjectIncluding({\n          _id: String,\n          username: String,\n          name: Match.Maybe(String),\n          userType: String\n        }));\n        const {\n          _id,\n          username\n        } = transferredBy;\n        const scopeData = scope || (nextDepartment ? 'department' : 'agent');\n        this.logger.info(\"Storing new chat transfer of \".concat(room._id, \" [Transfered by: \").concat(_id, \" to \").concat(scopeData, \"]\"));\n        const transferMessage = _objectSpread(_objectSpread({}, transferData.transferredBy.userType === 'visitor' && {\n          token: room.v.token\n        }), {}, {\n          transferData: _objectSpread(_objectSpread(_objectSpread({\n            transferredBy,\n            ts: new Date(),\n            scope: scopeData,\n            comment\n          }, previousDepartment && {\n            previousDepartment\n          }), nextDepartment && {\n            nextDepartment\n          }), transferredTo && {\n            transferredTo\n          })\n        });\n        await Message.saveSystemMessageAndNotifyUser('livechat_transfer_history', room._id, '', {\n          _id,\n          username\n        }, transferMessage);\n      }\n      async saveGuest(guestData, userId) {\n        const {\n          _id,\n          name,\n          email,\n          phone,\n          livechatData = {}\n        } = guestData;\n        const visitor = await LivechatVisitors.findOneById(_id, {\n          projection: {\n            _id: 1\n          }\n        });\n        if (!visitor) {\n          throw new Error('error-invalid-visitor');\n        }\n        this.logger.debug({\n          msg: 'Saving guest',\n          guestData\n        });\n        const updateData = {\n          livechatData: {}\n        };\n        if (name) {\n          updateData.name = name;\n        }\n        if (email) {\n          updateData.email = email;\n        }\n        if (phone) {\n          updateData.phone = phone;\n        }\n        const customFields = {};\n        if ((!userId || (await hasPermissionAsync(userId, 'edit-livechat-room-customfields'))) && Object.keys(livechatData).length) {\n          this.logger.debug({\n            msg: \"Saving custom fields for visitor \".concat(_id),\n            livechatData\n          });\n          var _iteratorAbruptCompletion3 = false;\n          var _didIteratorError3 = false;\n          var _iteratorError3;\n          try {\n            for (var _iterator3 = _asyncIterator(LivechatCustomField.findByScope('visitor')), _step3; _iteratorAbruptCompletion3 = !(_step3 = await _iterator3.next()).done; _iteratorAbruptCompletion3 = false) {\n              const field = _step3.value;\n              {\n                if (!livechatData.hasOwnProperty(field._id)) {\n                  continue;\n                }\n                const value = trim(livechatData[field._id]);\n                if (value !== '' && field.regexp !== undefined && field.regexp !== '') {\n                  const regexp = new RegExp(field.regexp);\n                  if (!regexp.test(value)) {\n                    throw new Error(i18n.t('error-invalid-custom-field-value'));\n                  }\n                }\n                customFields[field._id] = value;\n              }\n            }\n          } catch (err) {\n            _didIteratorError3 = true;\n            _iteratorError3 = err;\n          } finally {\n            try {\n              if (_iteratorAbruptCompletion3 && _iterator3.return != null) {\n                await _iterator3.return();\n              }\n            } finally {\n              if (_didIteratorError3) {\n                throw _iteratorError3;\n              }\n            }\n          }\n          updateData.livechatData = customFields;\n          Livechat.logger.debug(\"About to update \".concat(Object.keys(customFields).length, \" custom fields for visitor \").concat(_id));\n        }\n        const ret = await LivechatVisitors.saveGuestById(_id, updateData);\n        setImmediate(() => {\n          var _Apps$self3;\n          void ((_Apps$self3 = Apps.self) === null || _Apps$self3 === void 0 ? void 0 : _Apps$self3.triggerEvent(AppEvents.IPostLivechatGuestSaved, _id));\n        });\n        return ret;\n      }\n      async setCustomFields(_ref7) {\n        let {\n          token,\n          key,\n          value,\n          overwrite\n        } = _ref7;\n        Livechat.logger.debug(\"Setting custom fields data for visitor with token \".concat(token));\n        const customField = await LivechatCustomField.findOneById(key);\n        if (!customField) {\n          throw new Error('invalid-custom-field');\n        }\n        if (customField.regexp !== undefined && customField.regexp !== '') {\n          const regexp = new RegExp(customField.regexp);\n          if (!regexp.test(value)) {\n            throw new Error(i18n.t('error-invalid-custom-field-value', {\n              field: key\n            }));\n          }\n        }\n        let result;\n        if (customField.scope === 'room') {\n          result = await LivechatRooms.updateDataByToken(token, key, value, overwrite);\n        } else {\n          result = await LivechatVisitors.updateLivechatDataByToken(token, key, value, overwrite);\n        }\n        if (typeof result === 'boolean') {\n          // Note: this only happens when !overwrite is passed, in this case we don't do any db update\n          return 0;\n        }\n        return result.modifiedCount;\n      }\n      async requestTranscript(_ref8) {\n        let {\n          rid,\n          email,\n          subject,\n          user\n        } = _ref8;\n        const room = await LivechatRooms.findOneById(rid, {\n          projection: {\n            _id: 1,\n            open: 1,\n            transcriptRequest: 1\n          }\n        });\n        if (!(room !== null && room !== void 0 && room.open)) {\n          throw new Meteor.Error('error-invalid-room', 'Invalid room');\n        }\n        if (room.transcriptRequest) {\n          throw new Meteor.Error('error-transcript-already-requested', 'Transcript already requested');\n        }\n        if (!(await Omnichannel.isWithinMACLimit(room))) {\n          throw new Error('error-mac-limit-reached');\n        }\n        const {\n          _id,\n          username,\n          name,\n          utcOffset\n        } = user;\n        const transcriptRequest = {\n          requestedAt: new Date(),\n          requestedBy: {\n            _id,\n            username,\n            name,\n            utcOffset\n          },\n          email,\n          subject\n        };\n        await LivechatRooms.setEmailTranscriptRequestedByRoomId(rid, transcriptRequest);\n        return true;\n      }\n      async afterRemoveAgent(user) {\n        await callbacks.run('livechat.afterAgentRemoved', {\n          agent: user\n        });\n        return true;\n      }\n      async removeAgent(username) {\n        const user = await Users.findOneByUsername(username, {\n          projection: {\n            _id: 1,\n            username: 1\n          }\n        });\n        if (!user) {\n          throw new Error('error-invalid-user');\n        }\n        const {\n          _id\n        } = user;\n        if (await removeUserFromRolesAsync(_id, ['livechat-agent'])) {\n          return this.afterRemoveAgent(user);\n        }\n        return false;\n      }\n      async removeManager(username) {\n        const user = await Users.findOneByUsername(username, {\n          projection: {\n            _id: 1\n          }\n        });\n        if (!user) {\n          throw new Error('error-invalid-user');\n        }\n        return removeUserFromRolesAsync(user._id, ['livechat-manager']);\n      }\n      async getLivechatRoomGuestInfo(room) {\n        var _room$servedBy, _room$servedBy2;\n        const visitor = await LivechatVisitors.findOneEnabledById(room.v._id);\n        if (!visitor) {\n          throw new Error('error-invalid-visitor');\n        }\n        const agent = (_room$servedBy = room.servedBy) !== null && _room$servedBy !== void 0 && _room$servedBy._id ? await Users.findOneById((_room$servedBy2 = room.servedBy) === null || _room$servedBy2 === void 0 ? void 0 : _room$servedBy2._id) : null;\n        const ua = new UAParser();\n        ua.setUA(visitor.userAgent || '');\n        const postData = {\n          _id: room._id,\n          label: room.fname || room.label,\n          // using same field for compatibility\n          topic: room.topic,\n          createdAt: room.ts,\n          lastMessageAt: room.lm,\n          tags: room.tags,\n          customFields: room.livechatData,\n          visitor: {\n            _id: visitor._id,\n            token: visitor.token,\n            name: visitor.name,\n            username: visitor.username,\n            department: visitor.department,\n            ip: visitor.ip,\n            os: ua.getOS().name && \"\".concat(ua.getOS().name, \" \").concat(ua.getOS().version),\n            browser: ua.getBrowser().name && \"\".concat(ua.getBrowser().name, \" \").concat(ua.getBrowser().version),\n            customFields: visitor.livechatData\n          }\n        };\n        if (agent) {\n          const customFields = parseAgentCustomFields(agent.customFields);\n          postData.agent = _objectSpread({\n            _id: agent._id,\n            username: agent.username,\n            name: agent.name\n          }, customFields && {\n            customFields\n          });\n          if (agent.emails && agent.emails.length > 0) {\n            postData.agent.email = agent.emails[0].address;\n          }\n        }\n        if (room.crmData) {\n          postData.crmData = room.crmData;\n        }\n        if (visitor.visitorEmails && visitor.visitorEmails.length > 0) {\n          postData.visitor.email = visitor.visitorEmails;\n        }\n        if (visitor.phone && visitor.phone.length > 0) {\n          postData.visitor.phone = visitor.phone;\n        }\n        return postData;\n      }\n      async allowAgentChangeServiceStatus(statusLivechat, agentId) {\n        if (statusLivechat !== ILivechatAgentStatus.AVAILABLE) {\n          return true;\n        }\n        return businessHourManager.allowAgentChangeServiceStatus(agentId);\n      }\n      async notifyGuestStatusChanged(token, status) {\n        await LivechatRooms.updateVisitorStatus(token, status);\n        const inquiryVisitorStatus = await LivechatInquiry.updateVisitorStatus(token, status);\n        if (inquiryVisitorStatus.modifiedCount) {\n          void notifyOnLivechatInquiryChangedByToken(token, 'updated', {\n            v: {\n              status\n            }\n          });\n        }\n      }\n      async setUserStatusLivechat(userId, status) {\n        const user = await Users.setLivechatStatus(userId, status);\n        callbacks.runAsync('livechat.setUserStatusLivechat', {\n          userId,\n          status\n        });\n        if (user.modifiedCount > 0) {\n          void notifyOnUserChange({\n            id: userId,\n            clientAction: 'updated',\n            diff: {\n              statusLivechat: status,\n              livechatStatusSystemModified: false\n            }\n          });\n        }\n        return user;\n      }\n      async afterAgentAdded(user) {\n        await Promise.all([Users.setOperator(user._id, true), this.setUserStatusLivechat(user._id, user.status !== 'offline' ? ILivechatAgentStatus.AVAILABLE : ILivechatAgentStatus.NOT_AVAILABLE)]);\n        callbacks.runAsync('livechat.onNewAgentCreated', user._id);\n        return user;\n      }\n      async addAgent(username) {\n        check(username, String);\n        const user = await Users.findOneByUsername(username, {\n          projection: {\n            _id: 1,\n            username: 1\n          }\n        });\n        if (!user) {\n          throw new Meteor.Error('error-invalid-user');\n        }\n        if (await addUserRolesAsync(user._id, ['livechat-agent'])) {\n          return this.afterAgentAdded(user);\n        }\n        return false;\n      }\n      async afterAgentUserActivated(user) {\n        if (!user.roles.includes('livechat-agent')) {\n          throw new Error('invalid-user-role');\n        }\n        await Users.setOperator(user._id, true);\n        callbacks.runAsync('livechat.onNewAgentCreated', user._id);\n      }\n      async addManager(username) {\n        check(username, String);\n        const user = await Users.findOneByUsername(username, {\n          projection: {\n            _id: 1,\n            username: 1\n          }\n        });\n        if (!user) {\n          throw new Meteor.Error('error-invalid-user');\n        }\n        if (await addUserRolesAsync(user._id, ['livechat-manager'])) {\n          return user;\n        }\n        return false;\n      }\n      async saveRoomInfo(roomData, guestData, userId) {\n        var _guestData$name;\n        this.logger.debug(\"Saving room information on room \".concat(roomData._id));\n        const {\n          livechatData = {}\n        } = roomData;\n        const customFields = {};\n        if ((!userId || (await hasPermissionAsync(userId, 'edit-livechat-room-customfields'))) && Object.keys(livechatData).length) {\n          const fields = LivechatCustomField.findByScope('room');\n          var _iteratorAbruptCompletion4 = false;\n          var _didIteratorError4 = false;\n          var _iteratorError4;\n          try {\n            for (var _iterator4 = _asyncIterator(fields), _step4; _iteratorAbruptCompletion4 = !(_step4 = await _iterator4.next()).done; _iteratorAbruptCompletion4 = false) {\n              const field = _step4.value;\n              {\n                if (!livechatData.hasOwnProperty(field._id)) {\n                  continue;\n                }\n                const value = trim(livechatData[field._id]);\n                if (value !== '' && field.regexp !== undefined && field.regexp !== '') {\n                  const regexp = new RegExp(field.regexp);\n                  if (!regexp.test(value)) {\n                    throw new Meteor.Error(i18n.t('error-invalid-custom-field-value', {\n                      field: field.label\n                    }));\n                  }\n                }\n                customFields[field._id] = value;\n              }\n            }\n          } catch (err) {\n            _didIteratorError4 = true;\n            _iteratorError4 = err;\n          } finally {\n            try {\n              if (_iteratorAbruptCompletion4 && _iterator4.return != null) {\n                await _iterator4.return();\n              }\n            } finally {\n              if (_didIteratorError4) {\n                throw _iteratorError4;\n              }\n            }\n          }\n          roomData.livechatData = customFields;\n          Livechat.logger.debug(\"About to update \".concat(Object.keys(customFields).length, \" custom fields on room \").concat(roomData._id));\n        }\n        await LivechatRooms.saveRoomById(roomData);\n        setImmediate(() => {\n          var _Apps$self4;\n          void ((_Apps$self4 = Apps.self) === null || _Apps$self4 === void 0 ? void 0 : _Apps$self4.triggerEvent(AppEvents.IPostLivechatRoomSaved, roomData._id));\n        });\n        if (guestData !== null && guestData !== void 0 && (_guestData$name = guestData.name) !== null && _guestData$name !== void 0 && _guestData$name.trim().length) {\n          var _responses$, _responses$2;\n          const {\n            _id: rid\n          } = roomData;\n          const {\n            name\n          } = guestData;\n          const responses = await Promise.all([Rooms.setFnameById(rid, name), LivechatInquiry.setNameByRoomId(rid, name), Subscriptions.updateDisplayNameByRoomId(rid, name)]);\n          if ((_responses$ = responses[1]) !== null && _responses$ !== void 0 && _responses$.modifiedCount) {\n            void notifyOnLivechatInquiryChangedByRoom(rid, 'updated', {\n              name\n            });\n          }\n          if ((_responses$2 = responses[2]) !== null && _responses$2 !== void 0 && _responses$2.modifiedCount) {\n            await notifyOnSubscriptionChangedByRoomId(rid);\n          }\n        }\n        void notifyOnRoomChangedById(roomData._id);\n        return true;\n      }\n    }\n    const Livechat = new LivechatClass();\n    __reify_async_result__();\n  } catch (_reifyError) {\n    return __reify_async_result__(_reifyError);\n  }\n  __reify_async_result__()\n}, {\n  self: this,\n  async: false\n});","map":{"version":3,"names":["_objectSpread","module","link","default","v","_asyncIterator","export","Livechat","Apps","AppEvents","Message","VideoConf","api","Omnichannel","OmnichannelSourceType","ILivechatAgentStatus","UserStatus","isOmnichannelRoom","Logger","LivechatDepartment","LivechatInquiry","LivechatRooms","Subscriptions","LivechatVisitors","Messages","Users","LivechatDepartmentAgents","ReadReceipts","Rooms","LivechatCustomField","LivechatContacts","fetch","serverFetch","Match","check","Meteor","UAParser","callbacks","trim","client","i18n","addUserRolesAsync","removeUserFromRolesAsync","canAccessRoomAsync","hasPermissionAsync","hasRoleAsync","FileUpload","deleteMessage","sendMessage","updateMessage","notifyOnLivechatInquiryChanged","notifyOnLivechatInquiryChangedByRoom","notifyOnRoomChangedById","notifyOnLivechatInquiryChangedByToken","notifyOnUserChange","notifyOnSubscriptionChangedByRoomId","notifyOnSubscriptionChanged","metrics","settings","businessHourManager","createContact","createContactFromVisitor","isSingleContactEnabled","parseAgentCustomFields","updateDepartmentAgents","validateEmail","normalizeTransferredByData","QueueManager","RoutingManager","getRequiredDepartment","parseTranscriptRequest","__reifyWaitForDeps__","isRoomClosedByUserParams","params","user","undefined","isRoomClosedByVisitorParams","visitor","LivechatClass","constructor","logger","webhookLogger","section","online","department","skipNoAgentSetting","arguments","length","skipFallbackCheck","debug","concat","get","botAgents","getBotAgents","onlineBots","count","agentsOnline","checkOnlineAgents","closeRoom","attempts","newRoom","chatCloser","removedInquiryObj","session","startSession","startTransaction","room","closedBy","removedInquiry","doCloseRoom","commitTransaction","e","_e$errorLabels","_e$errorLabels2","error","err","msg","afterAttempts","abortTransaction","errorLabels","includes","Error","endSession","afterRoomClosed","inquiry","_params$comment","transcriptRequested","transcriptRequest","_id","saveSystemMessageAndNotifyUser","comment","groupable","token","saveSystemMessage","process","nextTick","_Apps$self","_Apps$self$getBridges","_Apps$self2","_Apps$self2$getBridge","self","getBridges","getListenerBridge","livechatEvent","ILivechatRoomClosedHandler","IPostLivechatRoomClosed","opts","options","env","TEST_MODE","run","runAsync","open","commentRequired","updatedOptions","resolveChatTags","now","Date","rid","servedBy","serviceTimeDuration","getTime","ts","closeData","closedAt","chatDuration","closer","username","findOneByRoomId","removeByRoomId","deletedCount","updatedRoom","closeRoomById","modifiedCount","subs","countByRoomId","removedSubs","onTrash","doc","findOneById","createRoom","_ref","message","roomInfo","agent","extraData","defaultAgent","requestRoom","guest","contactId","visitorContact","findOne","projection","name","contactManager","livechatData","phone","visitorEmails","contact","channels","_contact$channels","channel","find","_roomInfo$source","source","type","visitorId","_roomInfo$source2","_roomInfo$source3","addChannel","label","toString","OTHER","blocked","verified","details","setRoomIdByToken","getRoom","agentId","onlineForDep","checkOnlineForDepartment","dep","fallbackForwardDepartment","removeRoom","_result$","_result$3$value","String","result","Promise","allSettled","removeById","status","value","r","reason","isValidObject","obj","registerGuest","_ref2","id","email","connectionData","ONLINE","Maybe","visitorDataToUpdate","number","phoneNumber","visitorEmail","toLowerCase","address","livechatVisitor","getVisitorByToken","findOneByIdOrName","existingUser","findOneVisitorByPhone","findOneGuestByEmailAddress","getNextVisitorUsername","httpHeaders","clientAddress","userAgent","ip","host","emails","phones","unknown","upsertedLivechatVisitor","updateOneByIdOrToken","upsert","returnDocument","getBotsForDepartment","findBotAgents","concatUnique","_len","arrays","Array","_key","Set","filter","a","departmentId","tags","optionsTags","clientAction","oldRoomTags","roomTags","requestTagBeforeClosingChat","chatClosingTags","extraRoomTags","checkRoomTags","checkDepartmentTags","sendRequest","postData","timeout","secretToken","webhookUrl","method","headers","body","totalLivechatWebhooksSuccess","inc","totalLivechatWebhooksFailures","text","retryAfter","warn","newAttemptAfterSeconds","setTimeout","saveAgentInfo","agentData","agentDepartments","Object","setLivechatData","currentDepartmentsForAgent","findByAgentId","toArray","toRemoveIds","dept","map","toAddIds","d","some","c","all","findInIds","enabled","remove","order","updateCallStatus","callId","setCallStatus","declineLivechatCall","actionLinks","webRtcCallEndTs","notifyRoomVisitorChange","roomId","broadcast","changeRoomVisitor","userId","changeVisitorByRoomId","notifyAgentStatusChanged","findOpenByAgent","forEach","_ref3","ObjectIncluding","originalMessage","u","editAllowed","editOwn","closeOpenChats","extraQuery","openChats","promises","push","transfer","transferData","_transferData$transfe","transferredBy","onHold","_transferData$departm","transferRoom","forwardOpenChats","_iteratorAbruptCompletion","_didIteratorError","_iteratorError","_iterator","_step","next","done","findOneEnabledById","return","showConnecting","_RoutingManager$getCo","getConfig","getInitSettings","validSettings","rcSettings","reduce","acc","setting","Livechat_Show_Connecting","_ref4","alias","assign","removeGuest","cleanGuestHistory","disableById","cursor","findByVisitorToken","_iteratorAbruptCompletion2","_didIteratorError2","_iteratorError2","_iterator2","_step2","removeFilesByRoomId","removeByVisitorToken","livechatInquiries","findIdsByVisitorToken","removeByIds","_ref5","_ref6","deleteAllowed","setUserStatusLivechatIf","condition","fields","setLivechatStatusIf","diff","statusLivechat","returnRoomAsInquiry","overrideTransferData","scope","saveTransferHistory","unassignAgent","previousDepartment","nextDepartment","transferredTo","userType","scopeData","info","transferMessage","saveGuest","guestData","updateData","customFields","keys","_iteratorAbruptCompletion3","_didIteratorError3","_iteratorError3","_iterator3","findByScope","_step3","field","hasOwnProperty","regexp","RegExp","test","t","ret","saveGuestById","setImmediate","_Apps$self3","triggerEvent","IPostLivechatGuestSaved","setCustomFields","_ref7","key","overwrite","customField","updateDataByToken","updateLivechatDataByToken","requestTranscript","_ref8","subject","isWithinMACLimit","utcOffset","requestedAt","requestedBy","setEmailTranscriptRequestedByRoomId","afterRemoveAgent","removeAgent","findOneByUsername","removeManager","getLivechatRoomGuestInfo","_room$servedBy","_room$servedBy2","ua","setUA","fname","topic","createdAt","lastMessageAt","lm","os","getOS","version","browser","getBrowser","crmData","allowAgentChangeServiceStatus","AVAILABLE","notifyGuestStatusChanged","updateVisitorStatus","inquiryVisitorStatus","setUserStatusLivechat","setLivechatStatus","livechatStatusSystemModified","afterAgentAdded","setOperator","NOT_AVAILABLE","addAgent","afterAgentUserActivated","roles","addManager","saveRoomInfo","roomData","_guestData$name","_iteratorAbruptCompletion4","_didIteratorError4","_iteratorError4","_iterator4","_step4","saveRoomById","_Apps$self4","IPostLivechatRoomSaved","_responses$","_responses$2","responses","setFnameById","setNameByRoomId","updateDisplayNameByRoomId","__reify_async_result__","_reifyError","async"],"sources":["app/livechat/server/lib/LivechatTyped.ts"],"sourcesContent":["import { Apps, AppEvents } from '@rocket.chat/apps';\nimport { Message, VideoConf, api, Omnichannel } from '@rocket.chat/core-services';\nimport type {\n\tIOmnichannelRoom,\n\tIOmnichannelRoomClosingInfo,\n\tIUser,\n\tILivechatVisitor,\n\tSelectedAgent,\n\tILivechatAgent,\n\tIMessage,\n\tILivechatDepartment,\n\tAtLeast,\n\tTransferData,\n\tIOmnichannelAgent,\n\tILivechatInquiryRecord,\n\tILivechatContact,\n\tILivechatContactChannel,\n\tIOmnichannelRoomInfo,\n\tIOmnichannelRoomExtraData,\n} from '@rocket.chat/core-typings';\nimport { OmnichannelSourceType, ILivechatAgentStatus, UserStatus, isOmnichannelRoom } from '@rocket.chat/core-typings';\nimport { Logger, type MainLogger } from '@rocket.chat/logger';\nimport {\n\tLivechatDepartment,\n\tLivechatInquiry,\n\tLivechatRooms,\n\tSubscriptions,\n\tLivechatVisitors,\n\tMessages,\n\tUsers,\n\tLivechatDepartmentAgents,\n\tReadReceipts,\n\tRooms,\n\tLivechatCustomField,\n\tLivechatContacts,\n} from '@rocket.chat/models';\nimport { serverFetch as fetch } from '@rocket.chat/server-fetch';\nimport { Match, check } from 'meteor/check';\nimport { Meteor } from 'meteor/meteor';\nimport type { Filter, ClientSession, MongoError } from 'mongodb';\nimport UAParser from 'ua-parser-js';\n\nimport { callbacks } from '../../../../lib/callbacks';\nimport { trim } from '../../../../lib/utils/stringUtils';\nimport { client } from '../../../../server/database/utils';\nimport { i18n } from '../../../../server/lib/i18n';\nimport { addUserRolesAsync } from '../../../../server/lib/roles/addUserRoles';\nimport { removeUserFromRolesAsync } from '../../../../server/lib/roles/removeUserFromRoles';\nimport { canAccessRoomAsync } from '../../../authorization/server';\nimport { hasPermissionAsync } from '../../../authorization/server/functions/hasPermission';\nimport { hasRoleAsync } from '../../../authorization/server/functions/hasRole';\nimport { FileUpload } from '../../../file-upload/server';\nimport { deleteMessage } from '../../../lib/server/functions/deleteMessage';\nimport { sendMessage } from '../../../lib/server/functions/sendMessage';\nimport { updateMessage } from '../../../lib/server/functions/updateMessage';\nimport {\n\tnotifyOnLivechatInquiryChanged,\n\tnotifyOnLivechatInquiryChangedByRoom,\n\tnotifyOnRoomChangedById,\n\tnotifyOnLivechatInquiryChangedByToken,\n\tnotifyOnUserChange,\n\tnotifyOnSubscriptionChangedByRoomId,\n\tnotifyOnSubscriptionChanged,\n} from '../../../lib/server/lib/notifyListener';\nimport { metrics } from '../../../metrics/server';\nimport { settings } from '../../../settings/server';\nimport { businessHourManager } from '../business-hour';\nimport { createContact, createContactFromVisitor, isSingleContactEnabled } from './Contacts';\nimport { parseAgentCustomFields, updateDepartmentAgents, validateEmail, normalizeTransferredByData } from './Helper';\nimport { QueueManager } from './QueueManager';\nimport { RoutingManager } from './RoutingManager';\nimport { getRequiredDepartment } from './departmentsLib';\nimport type { CloseRoomParams, CloseRoomParamsByUser, CloseRoomParamsByVisitor, ILivechatMessage } from './localTypes';\nimport { parseTranscriptRequest } from './parseTranscriptRequest';\n\ntype RegisterGuestType = Partial<Pick<ILivechatVisitor, 'token' | 'name' | 'department' | 'status' | 'username'>> & {\n\tid?: string;\n\tconnectionData?: any;\n\temail?: string;\n\tphone?: { number: string };\n};\n\ntype AKeyOf<T> = {\n\t[K in keyof T]?: T[K];\n};\n\ntype ICRMData = {\n\t_id: string;\n\tlabel?: string;\n\ttopic?: string;\n\tcreatedAt: Date;\n\tlastMessageAt?: Date;\n\ttags?: string[];\n\tcustomFields?: IOmnichannelRoom['livechatData'];\n\tvisitor: Pick<ILivechatVisitor, '_id' | 'token' | 'name' | 'username' | 'department' | 'phone' | 'ip'> & {\n\t\temail?: ILivechatVisitor['visitorEmails'];\n\t\tos?: string;\n\t\tbrowser?: string;\n\t\tcustomFields: ILivechatVisitor['livechatData'];\n\t};\n\tagent?: Pick<IOmnichannelAgent, '_id' | 'username' | 'name' | 'customFields'> & {\n\t\temail?: NonNullable<IOmnichannelAgent['emails']>[number]['address'];\n\t};\n\tcrmData?: IOmnichannelRoom['crmData'];\n};\n\ntype ChatCloser = { _id: string; username: string | undefined };\n\nconst isRoomClosedByUserParams = (params: CloseRoomParams): params is CloseRoomParamsByUser =>\n\t(params as CloseRoomParamsByUser).user !== undefined;\nconst isRoomClosedByVisitorParams = (params: CloseRoomParams): params is CloseRoomParamsByVisitor =>\n\t(params as CloseRoomParamsByVisitor).visitor !== undefined;\n\nclass LivechatClass {\n\tlogger: Logger;\n\n\twebhookLogger: MainLogger;\n\n\tconstructor() {\n\t\tthis.logger = new Logger('Livechat');\n\t\tthis.webhookLogger = this.logger.section('Webhook');\n\t}\n\n\tasync online(department?: string, skipNoAgentSetting = false, skipFallbackCheck = false): Promise<boolean> {\n\t\tLivechat.logger.debug(`Checking online agents ${department ? `for department ${department}` : ''}`);\n\t\tif (!skipNoAgentSetting && settings.get('Livechat_accept_chats_with_no_agents')) {\n\t\t\tLivechat.logger.debug('Can accept without online agents: true');\n\t\t\treturn true;\n\t\t}\n\n\t\tif (settings.get('Livechat_assign_new_conversation_to_bot')) {\n\t\t\tLivechat.logger.debug(`Fetching online bot agents for department ${department}`);\n\t\t\tconst botAgents = await Livechat.getBotAgents(department);\n\t\t\tif (botAgents) {\n\t\t\t\tconst onlineBots = await botAgents.count();\n\t\t\t\tthis.logger.debug(`Found ${onlineBots} online`);\n\t\t\t\tif (onlineBots > 0) {\n\t\t\t\t\treturn true;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tconst agentsOnline = await this.checkOnlineAgents(department, undefined, skipFallbackCheck);\n\t\tLivechat.logger.debug(`Are online agents ${department ? `for department ${department}` : ''}?: ${agentsOnline}`);\n\t\treturn agentsOnline;\n\t}\n\n\tasync closeRoom(params: CloseRoomParams, attempts = 2): Promise<void> {\n\t\tlet newRoom: IOmnichannelRoom;\n\t\tlet chatCloser: ChatCloser;\n\t\tlet removedInquiryObj: ILivechatInquiryRecord | null;\n\n\t\tconst session = client.startSession();\n\t\ttry {\n\t\t\tsession.startTransaction();\n\t\t\tconst { room, closedBy, removedInquiry } = await this.doCloseRoom(params, session);\n\t\t\tawait session.commitTransaction();\n\n\t\t\tnewRoom = room;\n\t\t\tchatCloser = closedBy;\n\t\t\tremovedInquiryObj = removedInquiry;\n\t\t} catch (e) {\n\t\t\tthis.logger.error({ err: e, msg: 'Failed to close room', afterAttempts: attempts });\n\t\t\tawait session.abortTransaction();\n\t\t\t// Dont propagate transaction errors\n\t\t\tif (\n\t\t\t\t(e as unknown as MongoError)?.errorLabels?.includes('UnknownTransactionCommitResult') ||\n\t\t\t\t(e as unknown as MongoError)?.errorLabels?.includes('TransientTransactionError')\n\t\t\t) {\n\t\t\t\tif (attempts > 0) {\n\t\t\t\t\tthis.logger.debug(`Retrying close room because of transient error. Attempts left: ${attempts}`);\n\t\t\t\t\treturn this.closeRoom(params, attempts - 1);\n\t\t\t\t}\n\n\t\t\t\tthrow new Error('error-room-cannot-be-closed-try-again');\n\t\t\t}\n\t\t\tthrow e;\n\t\t} finally {\n\t\t\tawait session.endSession();\n\t\t}\n\n\t\t// Note: when reaching this point, the room has been closed\n\t\t// Transaction is commited and so these messages can be sent here.\n\t\treturn this.afterRoomClosed(newRoom, chatCloser, removedInquiryObj, params);\n\t}\n\n\tasync afterRoomClosed(\n\t\tnewRoom: IOmnichannelRoom,\n\t\tchatCloser: ChatCloser,\n\t\tinquiry: ILivechatInquiryRecord | null,\n\t\tparams: CloseRoomParams,\n\t): Promise<void> {\n\t\tif (!chatCloser) {\n\t\t\t// this should never happen\n\t\t\treturn;\n\t\t}\n\t\t// Note: we are okay with these messages being sent outside of the transaction. The process of sending a message\n\t\t// is huge and involves multiple db calls. Making it transactionable this way would be really hard.\n\t\t// And passing just _some_ actions to the transaction creates some deadlocks since messages are updated in the afterSaveMessages callbacks.\n\t\tconst transcriptRequested =\n\t\t\t!!params.room.transcriptRequest || (!settings.get('Livechat_enable_transcript') && settings.get('Livechat_transcript_send_always'));\n\t\tthis.logger.debug(`Sending closing message to room ${newRoom._id}`);\n\t\tawait Message.saveSystemMessageAndNotifyUser('livechat-close', newRoom._id, params.comment ?? '', chatCloser, {\n\t\t\tgroupable: false,\n\t\t\ttranscriptRequested,\n\t\t\t...(isRoomClosedByVisitorParams(params) && { token: params.visitor.token }),\n\t\t});\n\n\t\tif (settings.get('Livechat_enable_transcript') && !settings.get('Livechat_transcript_send_always')) {\n\t\t\tawait Message.saveSystemMessage('command', newRoom._id, 'promptTranscript', chatCloser);\n\t\t}\n\n\t\tthis.logger.debug(`Running callbacks for room ${newRoom._id}`);\n\n\t\tprocess.nextTick(() => {\n\t\t\t/**\n\t\t\t * @deprecated the `AppEvents.ILivechatRoomClosedHandler` event will be removed\n\t\t\t * in the next major version of the Apps-Engine\n\t\t\t */\n\t\t\tvoid Apps.self?.getBridges()?.getListenerBridge().livechatEvent(AppEvents.ILivechatRoomClosedHandler, newRoom);\n\t\t\tvoid Apps.self?.getBridges()?.getListenerBridge().livechatEvent(AppEvents.IPostLivechatRoomClosed, newRoom);\n\t\t});\n\n\t\tconst visitor = isRoomClosedByVisitorParams(params) ? params.visitor : undefined;\n\t\tconst opts = await parseTranscriptRequest(params.room, params.options, visitor);\n\t\tif (process.env.TEST_MODE) {\n\t\t\tawait callbacks.run('livechat.closeRoom', {\n\t\t\t\troom: newRoom,\n\t\t\t\toptions: opts,\n\t\t\t});\n\t\t} else {\n\t\t\tcallbacks.runAsync('livechat.closeRoom', {\n\t\t\t\troom: newRoom,\n\t\t\t\toptions: opts,\n\t\t\t});\n\t\t}\n\n\t\tvoid notifyOnRoomChangedById(newRoom._id);\n\t\tif (inquiry) {\n\t\t\tvoid notifyOnLivechatInquiryChanged(inquiry, 'removed');\n\t\t}\n\n\t\tthis.logger.debug(`Room ${newRoom._id} was closed`);\n\t}\n\n\tasync doCloseRoom(\n\t\tparams: CloseRoomParams,\n\t\tsession: ClientSession,\n\t): Promise<{ room: IOmnichannelRoom; closedBy: ChatCloser; removedInquiry: ILivechatInquiryRecord | null }> {\n\t\tconst { comment } = params;\n\t\tconst { room } = params;\n\n\t\tthis.logger.debug(`Attempting to close room ${room._id}`);\n\t\tif (!room || !isOmnichannelRoom(room) || !room.open) {\n\t\t\tthis.logger.debug(`Room ${room._id} is not open`);\n\t\t\tthrow new Error('error-room-closed');\n\t\t}\n\n\t\tconst commentRequired = settings.get('Livechat_request_comment_when_closing_conversation');\n\t\tif (commentRequired && !comment?.trim()) {\n\t\t\tthrow new Error('error-comment-is-required');\n\t\t}\n\n\t\tconst { updatedOptions: options } = await this.resolveChatTags(room, params.options);\n\t\tthis.logger.debug(`Resolved chat tags for room ${room._id}`);\n\n\t\tconst now = new Date();\n\t\tconst { _id: rid, servedBy } = room;\n\t\tconst serviceTimeDuration = servedBy && (now.getTime() - new Date(servedBy.ts).getTime()) / 1000;\n\n\t\tconst closeData: IOmnichannelRoomClosingInfo = {\n\t\t\tclosedAt: now,\n\t\t\tchatDuration: (now.getTime() - new Date(room.ts).getTime()) / 1000,\n\t\t\t...(serviceTimeDuration && { serviceTimeDuration }),\n\t\t\t...options,\n\t\t};\n\t\tthis.logger.debug(`Room ${room._id} was closed at ${closeData.closedAt} (duration ${closeData.chatDuration})`);\n\n\t\tif (isRoomClosedByUserParams(params)) {\n\t\t\tconst { user } = params;\n\t\t\tthis.logger.debug(`Closing by user ${user?._id}`);\n\t\t\tcloseData.closer = 'user';\n\t\t\tcloseData.closedBy = {\n\t\t\t\t_id: user?._id || '',\n\t\t\t\tusername: user?.username,\n\t\t\t};\n\t\t} else if (isRoomClosedByVisitorParams(params)) {\n\t\t\tconst { visitor } = params;\n\t\t\tthis.logger.debug(`Closing by visitor ${params.visitor._id}`);\n\t\t\tcloseData.closer = 'visitor';\n\t\t\tcloseData.closedBy = {\n\t\t\t\t_id: visitor._id,\n\t\t\t\tusername: visitor.username,\n\t\t\t};\n\t\t} else {\n\t\t\tthrow new Error('Error: Please provide details of the user or visitor who closed the room');\n\t\t}\n\n\t\tthis.logger.debug(`Updating DB for room ${room._id} with close data`);\n\n\t\tconst inquiry = await LivechatInquiry.findOneByRoomId(rid, { session });\n\t\tconst removedInquiry = await LivechatInquiry.removeByRoomId(rid, { session });\n\t\tif (removedInquiry && removedInquiry.deletedCount !== 1) {\n\t\t\tthrow new Error('Error removing inquiry');\n\t\t}\n\n\t\tconst updatedRoom = await LivechatRooms.closeRoomById(rid, closeData, { session });\n\t\tif (!updatedRoom || updatedRoom.modifiedCount !== 1) {\n\t\t\tthrow new Error('Error closing room');\n\t\t}\n\n\t\tconst subs = await Subscriptions.countByRoomId(rid, { session });\n\t\tconst removedSubs = await Subscriptions.removeByRoomId(rid, {\n\t\t\tasync onTrash(doc) {\n\t\t\t\tvoid notifyOnSubscriptionChanged(doc, 'removed');\n\t\t\t},\n\t\t\tsession,\n\t\t});\n\n\t\tif (removedSubs.deletedCount !== subs) {\n\t\t\tthrow new Error('Error removing subscriptions');\n\t\t}\n\n\t\tthis.logger.debug(`DB updated for room ${room._id}`);\n\n\t\t// Retrieve the closed room\n\t\tconst newRoom = await LivechatRooms.findOneById(rid, { session });\n\t\tif (!newRoom) {\n\t\t\tthrow new Error('Error: Room not found');\n\t\t}\n\n\t\treturn { room: newRoom, closedBy: closeData.closedBy, removedInquiry: inquiry };\n\t}\n\n\tasync createRoom({\n\t\tvisitor,\n\t\tmessage,\n\t\trid,\n\t\troomInfo,\n\t\tagent,\n\t\textraData,\n\t}: {\n\t\tvisitor: ILivechatVisitor;\n\t\tmessage?: string;\n\t\trid?: string;\n\t\troomInfo: IOmnichannelRoomInfo;\n\t\tagent?: SelectedAgent;\n\t\textraData?: IOmnichannelRoomExtraData;\n\t}) {\n\t\tif (!settings.get('Livechat_enabled')) {\n\t\t\tthrow new Meteor.Error('error-omnichannel-is-disabled');\n\t\t}\n\n\t\tconst defaultAgent = await callbacks.run('livechat.checkDefaultAgentOnNewRoom', agent, visitor);\n\t\t// if no department selected verify if there is at least one active and pick the first\n\t\tif (!defaultAgent && !visitor.department) {\n\t\t\tconst department = await getRequiredDepartment();\n\t\t\tLivechat.logger.debug(`No department or default agent selected for ${visitor._id}`);\n\n\t\t\tif (department) {\n\t\t\t\tLivechat.logger.debug(`Assigning ${visitor._id} to department ${department._id}`);\n\t\t\t\tvisitor.department = department._id;\n\t\t\t}\n\t\t}\n\n\t\t// delegate room creation to QueueManager\n\t\tLivechat.logger.debug(`Calling QueueManager to request a room for visitor ${visitor._id}`);\n\n\t\tconst room = await QueueManager.requestRoom({\n\t\t\tguest: visitor,\n\t\t\tmessage,\n\t\t\trid,\n\t\t\troomInfo,\n\t\t\tagent: defaultAgent,\n\t\t\textraData,\n\t\t});\n\n\t\tif (isSingleContactEnabled()) {\n\t\t\tlet { contactId } = visitor;\n\n\t\t\tif (!contactId) {\n\t\t\t\tconst visitorContact = await LivechatVisitors.findOne<\n\t\t\t\t\tPick<ILivechatVisitor, 'name' | 'contactManager' | 'livechatData' | 'phone' | 'visitorEmails' | 'username' | 'contactId'>\n\t\t\t\t>(visitor._id, {\n\t\t\t\t\tprojection: {\n\t\t\t\t\t\tname: 1,\n\t\t\t\t\t\tcontactManager: 1,\n\t\t\t\t\t\tlivechatData: 1,\n\t\t\t\t\t\tphone: 1,\n\t\t\t\t\t\tvisitorEmails: 1,\n\t\t\t\t\t\tusername: 1,\n\t\t\t\t\t\tcontactId: 1,\n\t\t\t\t\t},\n\t\t\t\t});\n\n\t\t\t\tcontactId = visitorContact?.contactId;\n\t\t\t}\n\n\t\t\tif (!contactId) {\n\t\t\t\t// ensure that old visitors have a contact\n\t\t\t\tcontactId = await createContactFromVisitor(visitor);\n\t\t\t}\n\n\t\t\tconst contact = await LivechatContacts.findOneById<Pick<ILivechatContact, '_id' | 'channels'>>(contactId, {\n\t\t\t\tprojection: { _id: 1, channels: 1 },\n\t\t\t});\n\n\t\t\tif (contact) {\n\t\t\t\tconst channel = contact.channels?.find(\n\t\t\t\t\t(channel: ILivechatContactChannel) => channel.name === roomInfo.source?.type && channel.visitorId === visitor._id,\n\t\t\t\t);\n\n\t\t\t\tif (!channel) {\n\t\t\t\t\tLivechat.logger.debug(`Adding channel for contact ${contact._id}`);\n\n\t\t\t\t\tawait LivechatContacts.addChannel(contact._id, {\n\t\t\t\t\t\tname: roomInfo.source?.label || roomInfo.source?.type.toString() || OmnichannelSourceType.OTHER,\n\t\t\t\t\t\tvisitorId: visitor._id,\n\t\t\t\t\t\tblocked: false,\n\t\t\t\t\t\tverified: false,\n\t\t\t\t\t\tdetails: roomInfo.source,\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tLivechat.logger.debug(`Room obtained for visitor ${visitor._id} -> ${room._id}`);\n\n\t\tawait Messages.setRoomIdByToken(visitor.token, room._id);\n\n\t\treturn room;\n\t}\n\n\tasync getRoom(\n\t\tguest: ILivechatVisitor,\n\t\tmessage: Pick<IMessage, 'rid' | 'msg' | 'token'>,\n\t\troomInfo: IOmnichannelRoomInfo,\n\t\tagent?: SelectedAgent,\n\t\textraData?: IOmnichannelRoomExtraData,\n\t) {\n\t\tif (!settings.get('Livechat_enabled')) {\n\t\t\tthrow new Meteor.Error('error-omnichannel-is-disabled');\n\t\t}\n\t\tLivechat.logger.debug(`Attempting to find or create a room for visitor ${guest._id}`);\n\t\tconst room = await LivechatRooms.findOneById(message.rid);\n\n\t\tif (room && !room.open) {\n\t\t\tLivechat.logger.debug(`Last room for visitor ${guest._id} closed. Creating new one`);\n\t\t}\n\n\t\tif (!room?.open) {\n\t\t\treturn {\n\t\t\t\troom: await this.createRoom({ visitor: guest, message: message.msg, roomInfo, agent, extraData }),\n\t\t\t\tnewRoom: true,\n\t\t\t};\n\t\t}\n\n\t\tif (room.v.token !== guest.token) {\n\t\t\tLivechat.logger.debug(`Visitor ${guest._id} trying to access another visitor's room`);\n\t\t\tthrow new Meteor.Error('cannot-access-room');\n\t\t}\n\n\t\treturn { room, newRoom: false };\n\t}\n\n\tasync checkOnlineAgents(department?: string, agent?: { agentId: string }, skipFallbackCheck = false): Promise<boolean> {\n\t\tif (agent?.agentId) {\n\t\t\treturn Users.checkOnlineAgents(agent.agentId);\n\t\t}\n\n\t\tif (department) {\n\t\t\tconst onlineForDep = await LivechatDepartmentAgents.checkOnlineForDepartment(department);\n\t\t\tif (onlineForDep || skipFallbackCheck) {\n\t\t\t\treturn onlineForDep;\n\t\t\t}\n\n\t\t\tconst dep = await LivechatDepartment.findOneById<Pick<ILivechatDepartment, '_id' | 'fallbackForwardDepartment'>>(department, {\n\t\t\t\tprojection: { fallbackForwardDepartment: 1 },\n\t\t\t});\n\t\t\tif (!dep?.fallbackForwardDepartment) {\n\t\t\t\treturn onlineForDep;\n\t\t\t}\n\n\t\t\treturn this.checkOnlineAgents(dep?.fallbackForwardDepartment);\n\t\t}\n\n\t\treturn Users.checkOnlineAgents();\n\t}\n\n\tasync removeRoom(rid: string) {\n\t\tLivechat.logger.debug(`Deleting room ${rid}`);\n\t\tcheck(rid, String);\n\t\tconst room = await LivechatRooms.findOneById(rid);\n\t\tif (!room) {\n\t\t\tthrow new Meteor.Error('error-invalid-room', 'Invalid room');\n\t\t}\n\n\t\tconst inquiry = await LivechatInquiry.findOneByRoomId(rid);\n\n\t\tconst result = await Promise.allSettled([\n\t\t\tMessages.removeByRoomId(rid),\n\t\t\tReadReceipts.removeByRoomId(rid),\n\t\t\tSubscriptions.removeByRoomId(rid, {\n\t\t\t\tasync onTrash(doc) {\n\t\t\t\t\tvoid notifyOnSubscriptionChanged(doc, 'removed');\n\t\t\t\t},\n\t\t\t}),\n\t\t\tLivechatInquiry.removeByRoomId(rid),\n\t\t\tLivechatRooms.removeById(rid),\n\t\t]);\n\n\t\tif (result[3]?.status === 'fulfilled' && result[3].value?.deletedCount && inquiry) {\n\t\t\tvoid notifyOnLivechatInquiryChanged(inquiry, 'removed');\n\t\t}\n\n\t\tfor (const r of result) {\n\t\t\tif (r.status === 'rejected') {\n\t\t\t\tthis.logger.error(`Error removing room ${rid}: ${r.reason}`);\n\t\t\t\tthrow new Meteor.Error('error-removing-room', 'Error removing room');\n\t\t\t}\n\t\t}\n\t}\n\n\tisValidObject(obj: unknown): obj is Record<string, any> {\n\t\treturn typeof obj === 'object' && obj !== null;\n\t}\n\n\tasync registerGuest({\n\t\tid,\n\t\ttoken,\n\t\tname,\n\t\tphone,\n\t\temail,\n\t\tdepartment,\n\t\tusername,\n\t\tconnectionData,\n\t\tstatus = UserStatus.ONLINE,\n\t}: RegisterGuestType): Promise<ILivechatVisitor | null> {\n\t\tcheck(token, String);\n\t\tcheck(id, Match.Maybe(String));\n\n\t\tLivechat.logger.debug(`New incoming conversation: id: ${id} | token: ${token}`);\n\n\t\tconst visitorDataToUpdate: Partial<ILivechatVisitor> & { userAgent?: string; ip?: string; host?: string } = {\n\t\t\ttoken,\n\t\t\tstatus,\n\t\t\t...(phone?.number ? { phone: [{ phoneNumber: phone.number }] } : {}),\n\t\t\t...(name ? { name } : {}),\n\t\t};\n\n\t\tif (email) {\n\t\t\tconst visitorEmail = email.trim().toLowerCase();\n\t\t\tvalidateEmail(visitorEmail);\n\t\t\tvisitorDataToUpdate.visitorEmails = [{ address: visitorEmail }];\n\t\t}\n\n\t\tconst livechatVisitor = await LivechatVisitors.getVisitorByToken(token, { projection: { _id: 1 } });\n\n\t\tif (livechatVisitor?.department !== department && department) {\n\t\t\tLivechat.logger.debug(`Attempt to find a department with id/name ${department}`);\n\t\t\tconst dep = await LivechatDepartment.findOneByIdOrName(department, { projection: { _id: 1 } });\n\t\t\tif (!dep) {\n\t\t\t\tLivechat.logger.debug(`Invalid department provided: ${department}`);\n\t\t\t\tthrow new Meteor.Error('error-invalid-department', 'The provided department is invalid');\n\t\t\t}\n\t\t\tLivechat.logger.debug(`Assigning visitor ${token} to department ${dep._id}`);\n\t\t\tvisitorDataToUpdate.department = dep._id;\n\t\t}\n\n\t\tvisitorDataToUpdate.token = livechatVisitor?.token || token;\n\n\t\tlet existingUser = null;\n\n\t\tif (livechatVisitor) {\n\t\t\tLivechat.logger.debug('Found matching user by token');\n\t\t\tvisitorDataToUpdate._id = livechatVisitor._id;\n\t\t} else if (phone?.number && (existingUser = await LivechatVisitors.findOneVisitorByPhone(phone.number))) {\n\t\t\tLivechat.logger.debug('Found matching user by phone number');\n\t\t\tvisitorDataToUpdate._id = existingUser._id;\n\t\t\t// Don't change token when matching by phone number, use current visitor token\n\t\t\tvisitorDataToUpdate.token = existingUser.token;\n\t\t} else if (email && (existingUser = await LivechatVisitors.findOneGuestByEmailAddress(email))) {\n\t\t\tLivechat.logger.debug('Found matching user by email');\n\t\t\tvisitorDataToUpdate._id = existingUser._id;\n\t\t} else if (!livechatVisitor) {\n\t\t\tLivechat.logger.debug(`No matches found. Attempting to create new user with token ${token}`);\n\n\t\t\tvisitorDataToUpdate._id = id || undefined;\n\t\t\tvisitorDataToUpdate.username = username || (await LivechatVisitors.getNextVisitorUsername());\n\t\t\tvisitorDataToUpdate.status = status;\n\t\t\tvisitorDataToUpdate.ts = new Date();\n\n\t\t\tif (settings.get('Livechat_Allow_collect_and_store_HTTP_header_informations') && Livechat.isValidObject(connectionData)) {\n\t\t\t\tLivechat.logger.debug(`Saving connection data for visitor ${token}`);\n\t\t\t\tconst { httpHeaders, clientAddress } = connectionData;\n\t\t\t\tif (Livechat.isValidObject(httpHeaders)) {\n\t\t\t\t\tvisitorDataToUpdate.userAgent = httpHeaders['user-agent'];\n\t\t\t\t\tvisitorDataToUpdate.ip = httpHeaders['x-real-ip'] || httpHeaders['x-forwarded-for'] || clientAddress;\n\t\t\t\t\tvisitorDataToUpdate.host = httpHeaders?.host;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tif (isSingleContactEnabled()) {\n\t\t\tconst contactId = await createContact({\n\t\t\t\tname: name ?? (visitorDataToUpdate.username as string),\n\t\t\t\temails: email ? [email] : [],\n\t\t\t\tphones: phone ? [phone.number] : [],\n\t\t\t\tunknown: true,\n\t\t\t});\n\t\t\tvisitorDataToUpdate.contactId = contactId;\n\t\t}\n\n\t\tconst upsertedLivechatVisitor = await LivechatVisitors.updateOneByIdOrToken(visitorDataToUpdate, {\n\t\t\tupsert: true,\n\t\t\treturnDocument: 'after',\n\t\t});\n\n\t\tif (!upsertedLivechatVisitor.value) {\n\t\t\tLivechat.logger.debug(`No visitor found after upsert`);\n\t\t\treturn null;\n\t\t}\n\n\t\treturn upsertedLivechatVisitor.value;\n\t}\n\n\tprivate async getBotAgents(department?: string) {\n\t\tif (department) {\n\t\t\treturn LivechatDepartmentAgents.getBotsForDepartment(department);\n\t\t}\n\n\t\treturn Users.findBotAgents();\n\t}\n\n\tprivate async resolveChatTags(\n\t\troom: IOmnichannelRoom,\n\t\toptions: CloseRoomParams['options'] = {},\n\t): Promise<{ updatedOptions: CloseRoomParams['options'] }> {\n\t\tthis.logger.debug(`Resolving chat tags for room ${room._id}`);\n\n\t\tconst concatUnique = (...arrays: (string[] | undefined)[]): string[] => [\n\t\t\t...new Set(([] as string[]).concat(...arrays.filter((a): a is string[] => !!a))),\n\t\t];\n\n\t\tconst { departmentId, tags: optionsTags } = room;\n\t\tconst { clientAction, tags: oldRoomTags } = options;\n\t\tconst roomTags = concatUnique(oldRoomTags, optionsTags);\n\n\t\tif (!departmentId) {\n\t\t\treturn {\n\t\t\t\tupdatedOptions: {\n\t\t\t\t\t...options,\n\t\t\t\t\t...(roomTags.length && { tags: roomTags }),\n\t\t\t\t},\n\t\t\t};\n\t\t}\n\n\t\tconst department = await LivechatDepartment.findOneById<Pick<ILivechatDepartment, 'requestTagBeforeClosingChat' | 'chatClosingTags'>>(\n\t\t\tdepartmentId,\n\t\t\t{\n\t\t\t\tprojection: { requestTagBeforeClosingChat: 1, chatClosingTags: 1 },\n\t\t\t},\n\t\t);\n\t\tif (!department) {\n\t\t\treturn {\n\t\t\t\tupdatedOptions: {\n\t\t\t\t\t...options,\n\t\t\t\t\t...(roomTags.length && { tags: roomTags }),\n\t\t\t\t},\n\t\t\t};\n\t\t}\n\n\t\tconst { requestTagBeforeClosingChat, chatClosingTags } = department;\n\t\tconst extraRoomTags = concatUnique(roomTags, chatClosingTags);\n\n\t\tif (!requestTagBeforeClosingChat) {\n\t\t\treturn {\n\t\t\t\tupdatedOptions: {\n\t\t\t\t\t...options,\n\t\t\t\t\t...(extraRoomTags.length && { tags: extraRoomTags }),\n\t\t\t\t},\n\t\t\t};\n\t\t}\n\n\t\tconst checkRoomTags = !clientAction || (roomTags && roomTags.length > 0);\n\t\tconst checkDepartmentTags = chatClosingTags && chatClosingTags.length > 0;\n\t\tif (!checkRoomTags || !checkDepartmentTags) {\n\t\t\tthrow new Error('error-tags-must-be-assigned-before-closing-chat');\n\t\t}\n\n\t\treturn {\n\t\t\tupdatedOptions: {\n\t\t\t\t...options,\n\t\t\t\t...(extraRoomTags.length && { tags: extraRoomTags }),\n\t\t\t},\n\t\t};\n\t}\n\n\tasync sendRequest(\n\t\tpostData: {\n\t\t\ttype: string;\n\t\t\t[key: string]: any;\n\t\t},\n\t\tattempts = 10,\n\t) {\n\t\tif (!attempts) {\n\t\t\tLivechat.logger.error({ msg: 'Omnichannel webhook call failed. Max attempts reached' });\n\t\t\treturn;\n\t\t}\n\t\tconst timeout = settings.get<number>('Livechat_http_timeout');\n\t\tconst secretToken = settings.get<string>('Livechat_secret_token');\n\t\tconst webhookUrl = settings.get<string>('Livechat_webhookUrl');\n\t\ttry {\n\t\t\tLivechat.webhookLogger.debug({ msg: 'Sending webhook request', postData });\n\t\t\tconst result = await fetch(webhookUrl, {\n\t\t\t\tmethod: 'POST',\n\t\t\t\theaders: {\n\t\t\t\t\t...(secretToken && { 'X-RocketChat-Livechat-Token': secretToken }),\n\t\t\t\t},\n\t\t\t\tbody: postData,\n\t\t\t\ttimeout,\n\t\t\t});\n\n\t\t\tif (result.status === 200) {\n\t\t\t\tmetrics.totalLivechatWebhooksSuccess.inc();\n\t\t\t\treturn result;\n\t\t\t}\n\n\t\t\tmetrics.totalLivechatWebhooksFailures.inc();\n\t\t\tthrow new Error(await result.text());\n\t\t} catch (err) {\n\t\t\tconst retryAfter = timeout * 4;\n\t\t\tLivechat.webhookLogger.error({ msg: `Error response on ${11 - attempts} try ->`, err });\n\t\t\t// try 10 times after 20 seconds each\n\t\t\tattempts - 1 &&\n\t\t\t\tLivechat.webhookLogger.warn({ msg: `Webhook call failed. Retrying`, newAttemptAfterSeconds: retryAfter / 1000, webhookUrl });\n\t\t\tsetTimeout(async () => {\n\t\t\t\tawait Livechat.sendRequest(postData, attempts - 1);\n\t\t\t}, retryAfter);\n\t\t}\n\t}\n\n\tasync saveAgentInfo(_id: string, agentData: any, agentDepartments: string[]) {\n\t\tcheck(_id, String);\n\t\tcheck(agentData, Object);\n\t\tcheck(agentDepartments, [String]);\n\n\t\tconst user = await Users.findOneById(_id);\n\t\tif (!user || !(await hasRoleAsync(_id, 'livechat-agent'))) {\n\t\t\tthrow new Meteor.Error('error-user-is-not-agent', 'User is not a livechat agent');\n\t\t}\n\n\t\tawait Users.setLivechatData(_id, agentData);\n\n\t\tconst currentDepartmentsForAgent = await LivechatDepartmentAgents.findByAgentId(_id).toArray();\n\n\t\tconst toRemoveIds = currentDepartmentsForAgent\n\t\t\t.filter((dept) => !agentDepartments.includes(dept.departmentId))\n\t\t\t.map((dept) => dept.departmentId);\n\t\tconst toAddIds = agentDepartments.filter((d) => !currentDepartmentsForAgent.some((c) => c.departmentId === d));\n\n\t\tawait Promise.all(\n\t\t\tawait LivechatDepartment.findInIds([...toRemoveIds, ...toAddIds], {\n\t\t\t\tprojection: {\n\t\t\t\t\t_id: 1,\n\t\t\t\t\tenabled: 1,\n\t\t\t\t},\n\t\t\t})\n\t\t\t\t.map((dep) => {\n\t\t\t\t\treturn updateDepartmentAgents(\n\t\t\t\t\t\tdep._id,\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t...(toRemoveIds.includes(dep._id) ? { remove: [{ agentId: _id }] } : { upsert: [{ agentId: _id, count: 0, order: 0 }] }),\n\t\t\t\t\t\t},\n\t\t\t\t\t\tdep.enabled,\n\t\t\t\t\t);\n\t\t\t\t})\n\t\t\t\t.toArray(),\n\t\t);\n\n\t\treturn true;\n\t}\n\n\tasync updateCallStatus(callId: string, rid: string, status: 'ended' | 'declined', user: IUser | ILivechatVisitor) {\n\t\tawait Rooms.setCallStatus(rid, status);\n\t\tif (status === 'ended' || status === 'declined') {\n\t\t\tif (await VideoConf.declineLivechatCall(callId)) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\treturn updateMessage({ _id: callId, msg: status, actionLinks: [], webRtcCallEndTs: new Date(), rid }, user as unknown as IUser);\n\t\t}\n\t}\n\n\tnotifyRoomVisitorChange(roomId: string, visitor: ILivechatVisitor) {\n\t\tvoid api.broadcast('omnichannel.room', roomId, {\n\t\t\ttype: 'visitorData',\n\t\t\tvisitor,\n\t\t});\n\t}\n\n\tasync changeRoomVisitor(userId: string, room: IOmnichannelRoom, visitor: ILivechatVisitor) {\n\t\tconst user = await Users.findOneById(userId, { projection: { _id: 1 } });\n\t\tif (!user) {\n\t\t\tthrow new Error('error-user-not-found');\n\t\t}\n\n\t\tif (!(await canAccessRoomAsync(room, user))) {\n\t\t\tthrow new Error('error-not-allowed');\n\t\t}\n\n\t\tawait LivechatRooms.changeVisitorByRoomId(room._id, visitor);\n\n\t\tthis.notifyRoomVisitorChange(room._id, visitor);\n\n\t\treturn LivechatRooms.findOneById(room._id);\n\t}\n\n\tasync notifyAgentStatusChanged(userId: string, status?: UserStatus) {\n\t\tif (!status) {\n\t\t\treturn;\n\t\t}\n\n\t\tvoid callbacks.runAsync('livechat.agentStatusChanged', { userId, status });\n\t\tif (!settings.get('Livechat_show_agent_info')) {\n\t\t\treturn;\n\t\t}\n\n\t\tawait LivechatRooms.findOpenByAgent(userId).forEach((room) => {\n\t\t\tvoid api.broadcast('omnichannel.room', room._id, {\n\t\t\t\ttype: 'agentStatus',\n\t\t\t\tstatus,\n\t\t\t});\n\t\t});\n\t}\n\n\tasync updateMessage({ guest, message }: { guest: ILivechatVisitor; message: AtLeast<IMessage, '_id' | 'msg' | 'rid'> }) {\n\t\tcheck(message, Match.ObjectIncluding({ _id: String }));\n\n\t\tconst originalMessage = await Messages.findOneById<Pick<IMessage, 'u' | '_id'>>(message._id, { projection: { u: 1 } });\n\t\tif (!originalMessage?._id) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst editAllowed = settings.get('Message_AllowEditing');\n\t\tconst editOwn = originalMessage.u && originalMessage.u._id === guest._id;\n\n\t\tif (!editAllowed || !editOwn) {\n\t\t\tthrow new Error('error-action-not-allowed');\n\t\t}\n\n\t\t// TODO: Apps sends an `any` object and apparently we just check for _id being present\n\t\t// while updateMessage expects AtLeast<id, msg, rid>\n\t\tawait updateMessage(message, guest as unknown as IUser);\n\n\t\treturn true;\n\t}\n\n\tasync closeOpenChats(userId: string, comment?: string) {\n\t\tthis.logger.debug(`Closing open chats for user ${userId}`);\n\t\tconst user = await Users.findOneById(userId);\n\n\t\tconst extraQuery = await callbacks.run('livechat.applyDepartmentRestrictions', {}, { userId });\n\t\tconst openChats = LivechatRooms.findOpenByAgent(userId, extraQuery);\n\t\tconst promises: Promise<void>[] = [];\n\t\tawait openChats.forEach((room) => {\n\t\t\tpromises.push(this.closeRoom({ user, room, comment }));\n\t\t});\n\n\t\tawait Promise.all(promises);\n\t}\n\n\tasync transfer(room: IOmnichannelRoom, guest: ILivechatVisitor, transferData: TransferData) {\n\t\tthis.logger.debug(`Transfering room ${room._id} [Transfered by: ${transferData?.transferredBy?._id}]`);\n\t\tif (room.onHold) {\n\t\t\tthrow new Error('error-room-onHold');\n\t\t}\n\n\t\tif (transferData.departmentId) {\n\t\t\tconst department = await LivechatDepartment.findOneById<Pick<ILivechatDepartment, 'name' | '_id'>>(transferData.departmentId, {\n\t\t\t\tprojection: { name: 1 },\n\t\t\t});\n\t\t\tif (!department) {\n\t\t\t\tthrow new Error('error-invalid-department');\n\t\t\t}\n\n\t\t\ttransferData.department = department;\n\t\t\tthis.logger.debug(`Transfering room ${room._id} to department ${transferData.department?._id}`);\n\t\t}\n\n\t\treturn RoutingManager.transferRoom(room, guest, transferData);\n\t}\n\n\tasync forwardOpenChats(userId: string) {\n\t\tthis.logger.debug(`Transferring open chats for user ${userId}`);\n\t\tconst user = await Users.findOneById(userId);\n\t\tif (!user) {\n\t\t\tthrow new Error('error-invalid-user');\n\t\t}\n\n\t\tconst { _id, username, name } = user;\n\t\tfor await (const room of LivechatRooms.findOpenByAgent(userId)) {\n\t\t\tconst guest = await LivechatVisitors.findOneEnabledById(room.v._id);\n\t\t\tif (!guest) {\n\t\t\t\tcontinue;\n\t\t\t}\n\n\t\t\tconst transferredBy = normalizeTransferredByData({ _id, username, name }, room);\n\t\t\tawait this.transfer(room, guest, {\n\t\t\t\ttransferredBy,\n\t\t\t\tdepartmentId: guest.department,\n\t\t\t});\n\t\t}\n\t}\n\n\tshowConnecting() {\n\t\treturn RoutingManager.getConfig()?.showConnecting || false;\n\t}\n\n\tasync getInitSettings() {\n\t\tconst validSettings = [\n\t\t\t'Livechat_title',\n\t\t\t'Livechat_title_color',\n\t\t\t'Livechat_enable_message_character_limit',\n\t\t\t'Livechat_message_character_limit',\n\t\t\t'Message_MaxAllowedSize',\n\t\t\t'Livechat_enabled',\n\t\t\t'Livechat_registration_form',\n\t\t\t'Livechat_allow_switching_departments',\n\t\t\t'Livechat_offline_title',\n\t\t\t'Livechat_offline_title_color',\n\t\t\t'Livechat_offline_message',\n\t\t\t'Livechat_offline_success_message',\n\t\t\t'Livechat_offline_form_unavailable',\n\t\t\t'Livechat_display_offline_form',\n\t\t\t'Omnichannel_call_provider',\n\t\t\t'Language',\n\t\t\t'Livechat_enable_transcript',\n\t\t\t'Livechat_transcript_message',\n\t\t\t'Livechat_fileupload_enabled',\n\t\t\t'FileUpload_Enabled',\n\t\t\t'Livechat_conversation_finished_message',\n\t\t\t'Livechat_conversation_finished_text',\n\t\t\t'Livechat_name_field_registration_form',\n\t\t\t'Livechat_email_field_registration_form',\n\t\t\t'Livechat_registration_form_message',\n\t\t\t'Livechat_force_accept_data_processing_consent',\n\t\t\t'Livechat_data_processing_consent_text',\n\t\t\t'Livechat_show_agent_info',\n\t\t\t'Livechat_clear_local_storage_when_chat_ended',\n\t\t\t'Livechat_history_monitor_type',\n\t\t\t'Livechat_hide_system_messages',\n\t\t\t'Livechat_widget_position',\n\t\t\t'Livechat_background',\n\t\t\t'Assets_livechat_widget_logo',\n\t\t\t'Livechat_hide_watermark',\n\t\t\t'Omnichannel_allow_visitors_to_close_conversation',\n\t\t] as const;\n\n\t\ttype SettingTypes = (typeof validSettings)[number] | 'Livechat_Show_Connecting';\n\n\t\tconst rcSettings = validSettings.reduce<Record<SettingTypes, string | boolean>>((acc, setting) => {\n\t\t\tacc[setting] = settings.get(setting);\n\t\t\treturn acc;\n\t\t}, {} as any);\n\n\t\trcSettings.Livechat_Show_Connecting = this.showConnecting();\n\n\t\treturn rcSettings;\n\t}\n\n\tasync sendMessage({\n\t\tguest,\n\t\tmessage,\n\t\troomInfo,\n\t\tagent,\n\t}: {\n\t\tguest: ILivechatVisitor;\n\t\tmessage: ILivechatMessage;\n\t\troomInfo: IOmnichannelRoomInfo;\n\t\tagent?: SelectedAgent;\n\t}) {\n\t\tconst { room, newRoom } = await this.getRoom(guest, message, roomInfo, agent);\n\t\tif (guest.name) {\n\t\t\tmessage.alias = guest.name;\n\t\t}\n\t\treturn Object.assign(await sendMessage(guest, { ...message, token: guest.token }, room), {\n\t\t\tnewRoom,\n\t\t\tshowConnecting: this.showConnecting(),\n\t\t});\n\t}\n\n\tasync removeGuest(_id: string) {\n\t\tconst guest = await LivechatVisitors.findOneEnabledById(_id, { projection: { _id: 1, token: 1 } });\n\t\tif (!guest) {\n\t\t\tthrow new Error('error-invalid-guest');\n\t\t}\n\n\t\tawait this.cleanGuestHistory(guest);\n\t\treturn LivechatVisitors.disableById(_id);\n\t}\n\n\tasync cleanGuestHistory(guest: ILivechatVisitor) {\n\t\tconst { token } = guest;\n\n\t\t// This shouldn't be possible, but just in case\n\t\tif (!token) {\n\t\t\tthrow new Error('error-invalid-guest');\n\t\t}\n\n\t\tconst cursor = LivechatRooms.findByVisitorToken(token);\n\t\tfor await (const room of cursor) {\n\t\t\tawait Promise.all([\n\t\t\t\tSubscriptions.removeByRoomId(room._id, {\n\t\t\t\t\tasync onTrash(doc) {\n\t\t\t\t\t\tvoid notifyOnSubscriptionChanged(doc, 'removed');\n\t\t\t\t\t},\n\t\t\t\t}),\n\t\t\t\tFileUpload.removeFilesByRoomId(room._id),\n\t\t\t\tMessages.removeByRoomId(room._id),\n\t\t\t\tReadReceipts.removeByRoomId(room._id),\n\t\t\t]);\n\t\t}\n\n\t\tawait LivechatRooms.removeByVisitorToken(token);\n\n\t\tconst livechatInquiries = await LivechatInquiry.findIdsByVisitorToken(token).toArray();\n\t\tawait LivechatInquiry.removeByIds(livechatInquiries.map(({ _id }) => _id));\n\t\tvoid notifyOnLivechatInquiryChanged(livechatInquiries, 'removed');\n\t}\n\n\tasync deleteMessage({ guest, message }: { guest: ILivechatVisitor; message: IMessage }) {\n\t\tconst deleteAllowed = settings.get<boolean>('Message_AllowDeleting');\n\t\tconst editOwn = message.u && message.u._id === guest._id;\n\n\t\tif (!deleteAllowed || !editOwn) {\n\t\t\tthrow new Error('error-action-not-allowed');\n\t\t}\n\n\t\tawait deleteMessage(message, guest as unknown as IUser);\n\n\t\treturn true;\n\t}\n\n\tasync setUserStatusLivechatIf(userId: string, status: ILivechatAgentStatus, condition?: Filter<IUser>, fields?: AKeyOf<ILivechatAgent>) {\n\t\tconst result = await Users.setLivechatStatusIf(userId, status, condition, fields);\n\n\t\tif (result.modifiedCount > 0) {\n\t\t\tvoid notifyOnUserChange({\n\t\t\t\tid: userId,\n\t\t\t\tclientAction: 'updated',\n\t\t\t\tdiff: { ...fields, statusLivechat: status },\n\t\t\t});\n\t\t}\n\n\t\tcallbacks.runAsync('livechat.setUserStatusLivechat', { userId, status });\n\t\treturn result;\n\t}\n\n\tasync returnRoomAsInquiry(room: IOmnichannelRoom, departmentId?: string, overrideTransferData: any = {}) {\n\t\tthis.logger.debug({ msg: `Transfering room to ${departmentId ? 'department' : ''} queue`, room });\n\t\tif (!room.open) {\n\t\t\tthrow new Meteor.Error('room-closed');\n\t\t}\n\n\t\tif (room.onHold) {\n\t\t\tthrow new Meteor.Error('error-room-onHold');\n\t\t}\n\n\t\tif (!room.servedBy) {\n\t\t\treturn false;\n\t\t}\n\n\t\tconst user = await Users.findOneById(room.servedBy._id);\n\t\tif (!user?._id) {\n\t\t\tthrow new Meteor.Error('error-invalid-user');\n\t\t}\n\n\t\t// find inquiry corresponding to room\n\t\tconst inquiry = await LivechatInquiry.findOne({ rid: room._id });\n\t\tif (!inquiry) {\n\t\t\treturn false;\n\t\t}\n\n\t\tconst transferredBy = normalizeTransferredByData(user, room);\n\t\tthis.logger.debug(`Transfering room ${room._id} by user ${transferredBy._id}`);\n\t\tconst transferData = { roomId: room._id, scope: 'queue', departmentId, transferredBy, ...overrideTransferData };\n\t\ttry {\n\t\t\tawait this.saveTransferHistory(room, transferData);\n\t\t\tawait RoutingManager.unassignAgent(inquiry, departmentId);\n\t\t} catch (e) {\n\t\t\tthis.logger.error(e);\n\t\t\tthrow new Meteor.Error('error-returning-inquiry');\n\t\t}\n\n\t\tcallbacks.runAsync('livechat:afterReturnRoomAsInquiry', { room });\n\n\t\treturn true;\n\t}\n\n\tasync saveTransferHistory(room: IOmnichannelRoom, transferData: TransferData) {\n\t\tconst { departmentId: previousDepartment } = room;\n\t\tconst { department: nextDepartment, transferredBy, transferredTo, scope, comment } = transferData;\n\n\t\tcheck(\n\t\t\ttransferredBy,\n\t\t\tMatch.ObjectIncluding({\n\t\t\t\t_id: String,\n\t\t\t\tusername: String,\n\t\t\t\tname: Match.Maybe(String),\n\t\t\t\tuserType: String,\n\t\t\t}),\n\t\t);\n\n\t\tconst { _id, username } = transferredBy;\n\t\tconst scopeData = scope || (nextDepartment ? 'department' : 'agent');\n\t\tthis.logger.info(`Storing new chat transfer of ${room._id} [Transfered by: ${_id} to ${scopeData}]`);\n\n\t\tconst transferMessage = {\n\t\t\t...(transferData.transferredBy.userType === 'visitor' && { token: room.v.token }),\n\t\t\ttransferData: {\n\t\t\t\ttransferredBy,\n\t\t\t\tts: new Date(),\n\t\t\t\tscope: scopeData,\n\t\t\t\tcomment,\n\t\t\t\t...(previousDepartment && { previousDepartment }),\n\t\t\t\t...(nextDepartment && { nextDepartment }),\n\t\t\t\t...(transferredTo && { transferredTo }),\n\t\t\t},\n\t\t};\n\n\t\tawait Message.saveSystemMessageAndNotifyUser('livechat_transfer_history', room._id, '', { _id, username }, transferMessage);\n\t}\n\n\tasync saveGuest(guestData: Pick<ILivechatVisitor, '_id' | 'name' | 'livechatData'> & { email?: string; phone?: string }, userId: string) {\n\t\tconst { _id, name, email, phone, livechatData = {} } = guestData;\n\n\t\tconst visitor = await LivechatVisitors.findOneById(_id, { projection: { _id: 1 } });\n\t\tif (!visitor) {\n\t\t\tthrow new Error('error-invalid-visitor');\n\t\t}\n\n\t\tthis.logger.debug({ msg: 'Saving guest', guestData });\n\t\tconst updateData: {\n\t\t\tname?: string | undefined;\n\t\t\tusername?: string | undefined;\n\t\t\temail?: string | undefined;\n\t\t\tphone?: string | undefined;\n\t\t\tlivechatData: {\n\t\t\t\t[k: string]: any;\n\t\t\t};\n\t\t} = { livechatData: {} };\n\n\t\tif (name) {\n\t\t\tupdateData.name = name;\n\t\t}\n\t\tif (email) {\n\t\t\tupdateData.email = email;\n\t\t}\n\t\tif (phone) {\n\t\t\tupdateData.phone = phone;\n\t\t}\n\n\t\tconst customFields: Record<string, any> = {};\n\n\t\tif ((!userId || (await hasPermissionAsync(userId, 'edit-livechat-room-customfields'))) && Object.keys(livechatData).length) {\n\t\t\tthis.logger.debug({ msg: `Saving custom fields for visitor ${_id}`, livechatData });\n\t\t\tfor await (const field of LivechatCustomField.findByScope('visitor')) {\n\t\t\t\tif (!livechatData.hasOwnProperty(field._id)) {\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\t\t\t\tconst value = trim(livechatData[field._id]);\n\t\t\t\tif (value !== '' && field.regexp !== undefined && field.regexp !== '') {\n\t\t\t\t\tconst regexp = new RegExp(field.regexp);\n\t\t\t\t\tif (!regexp.test(value)) {\n\t\t\t\t\t\tthrow new Error(i18n.t('error-invalid-custom-field-value'));\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tcustomFields[field._id] = value;\n\t\t\t}\n\t\t\tupdateData.livechatData = customFields;\n\t\t\tLivechat.logger.debug(`About to update ${Object.keys(customFields).length} custom fields for visitor ${_id}`);\n\t\t}\n\t\tconst ret = await LivechatVisitors.saveGuestById(_id, updateData);\n\n\t\tsetImmediate(() => {\n\t\t\tvoid Apps.self?.triggerEvent(AppEvents.IPostLivechatGuestSaved, _id);\n\t\t});\n\n\t\treturn ret;\n\t}\n\n\tasync setCustomFields({ token, key, value, overwrite }: { key: string; value: string; overwrite: boolean; token: string }) {\n\t\tLivechat.logger.debug(`Setting custom fields data for visitor with token ${token}`);\n\n\t\tconst customField = await LivechatCustomField.findOneById(key);\n\t\tif (!customField) {\n\t\t\tthrow new Error('invalid-custom-field');\n\t\t}\n\n\t\tif (customField.regexp !== undefined && customField.regexp !== '') {\n\t\t\tconst regexp = new RegExp(customField.regexp);\n\t\t\tif (!regexp.test(value)) {\n\t\t\t\tthrow new Error(i18n.t('error-invalid-custom-field-value', { field: key }));\n\t\t\t}\n\t\t}\n\n\t\tlet result;\n\t\tif (customField.scope === 'room') {\n\t\t\tresult = await LivechatRooms.updateDataByToken(token, key, value, overwrite);\n\t\t} else {\n\t\t\tresult = await LivechatVisitors.updateLivechatDataByToken(token, key, value, overwrite);\n\t\t}\n\n\t\tif (typeof result === 'boolean') {\n\t\t\t// Note: this only happens when !overwrite is passed, in this case we don't do any db update\n\t\t\treturn 0;\n\t\t}\n\n\t\treturn result.modifiedCount;\n\t}\n\n\tasync requestTranscript({\n\t\trid,\n\t\temail,\n\t\tsubject,\n\t\tuser,\n\t}: {\n\t\trid: string;\n\t\temail: string;\n\t\tsubject: string;\n\t\tuser: AtLeast<IUser, '_id' | 'username' | 'utcOffset' | 'name'>;\n\t}) {\n\t\tconst room = await LivechatRooms.findOneById(rid, { projection: { _id: 1, open: 1, transcriptRequest: 1 } });\n\n\t\tif (!room?.open) {\n\t\t\tthrow new Meteor.Error('error-invalid-room', 'Invalid room');\n\t\t}\n\n\t\tif (room.transcriptRequest) {\n\t\t\tthrow new Meteor.Error('error-transcript-already-requested', 'Transcript already requested');\n\t\t}\n\n\t\tif (!(await Omnichannel.isWithinMACLimit(room))) {\n\t\t\tthrow new Error('error-mac-limit-reached');\n\t\t}\n\n\t\tconst { _id, username, name, utcOffset } = user;\n\t\tconst transcriptRequest = {\n\t\t\trequestedAt: new Date(),\n\t\t\trequestedBy: {\n\t\t\t\t_id,\n\t\t\t\tusername,\n\t\t\t\tname,\n\t\t\t\tutcOffset,\n\t\t\t},\n\t\t\temail,\n\t\t\tsubject,\n\t\t};\n\n\t\tawait LivechatRooms.setEmailTranscriptRequestedByRoomId(rid, transcriptRequest);\n\t\treturn true;\n\t}\n\n\tasync afterRemoveAgent(user: AtLeast<IUser, '_id' | 'username'>) {\n\t\tawait callbacks.run('livechat.afterAgentRemoved', { agent: user });\n\t\treturn true;\n\t}\n\n\tasync removeAgent(username: string) {\n\t\tconst user = await Users.findOneByUsername(username, { projection: { _id: 1, username: 1 } });\n\n\t\tif (!user) {\n\t\t\tthrow new Error('error-invalid-user');\n\t\t}\n\n\t\tconst { _id } = user;\n\n\t\tif (await removeUserFromRolesAsync(_id, ['livechat-agent'])) {\n\t\t\treturn this.afterRemoveAgent(user);\n\t\t}\n\n\t\treturn false;\n\t}\n\n\tasync removeManager(username: string) {\n\t\tconst user = await Users.findOneByUsername(username, { projection: { _id: 1 } });\n\n\t\tif (!user) {\n\t\t\tthrow new Error('error-invalid-user');\n\t\t}\n\n\t\treturn removeUserFromRolesAsync(user._id, ['livechat-manager']);\n\t}\n\n\tasync getLivechatRoomGuestInfo(room: IOmnichannelRoom) {\n\t\tconst visitor = await LivechatVisitors.findOneEnabledById(room.v._id);\n\t\tif (!visitor) {\n\t\t\tthrow new Error('error-invalid-visitor');\n\t\t}\n\n\t\tconst agent = room.servedBy?._id ? await Users.findOneById(room.servedBy?._id) : null;\n\n\t\tconst ua = new UAParser();\n\t\tua.setUA(visitor.userAgent || '');\n\n\t\tconst postData: ICRMData = {\n\t\t\t_id: room._id,\n\t\t\tlabel: room.fname || room.label, // using same field for compatibility\n\t\t\ttopic: room.topic,\n\t\t\tcreatedAt: room.ts,\n\t\t\tlastMessageAt: room.lm,\n\t\t\ttags: room.tags,\n\t\t\tcustomFields: room.livechatData,\n\t\t\tvisitor: {\n\t\t\t\t_id: visitor._id,\n\t\t\t\ttoken: visitor.token,\n\t\t\t\tname: visitor.name,\n\t\t\t\tusername: visitor.username,\n\t\t\t\tdepartment: visitor.department,\n\t\t\t\tip: visitor.ip,\n\t\t\t\tos: ua.getOS().name && `${ua.getOS().name} ${ua.getOS().version}`,\n\t\t\t\tbrowser: ua.getBrowser().name && `${ua.getBrowser().name} ${ua.getBrowser().version}`,\n\t\t\t\tcustomFields: visitor.livechatData,\n\t\t\t},\n\t\t};\n\n\t\tif (agent) {\n\t\t\tconst customFields = parseAgentCustomFields(agent.customFields);\n\n\t\t\tpostData.agent = {\n\t\t\t\t_id: agent._id,\n\t\t\t\tusername: agent.username,\n\t\t\t\tname: agent.name,\n\t\t\t\t...(customFields && { customFields }),\n\t\t\t};\n\n\t\t\tif (agent.emails && agent.emails.length > 0) {\n\t\t\t\tpostData.agent.email = agent.emails[0].address;\n\t\t\t}\n\t\t}\n\n\t\tif (room.crmData) {\n\t\t\tpostData.crmData = room.crmData;\n\t\t}\n\n\t\tif (visitor.visitorEmails && visitor.visitorEmails.length > 0) {\n\t\t\tpostData.visitor.email = visitor.visitorEmails;\n\t\t}\n\t\tif (visitor.phone && visitor.phone.length > 0) {\n\t\t\tpostData.visitor.phone = visitor.phone;\n\t\t}\n\n\t\treturn postData;\n\t}\n\n\tasync allowAgentChangeServiceStatus(statusLivechat: ILivechatAgentStatus, agentId: string) {\n\t\tif (statusLivechat !== ILivechatAgentStatus.AVAILABLE) {\n\t\t\treturn true;\n\t\t}\n\n\t\treturn businessHourManager.allowAgentChangeServiceStatus(agentId);\n\t}\n\n\tasync notifyGuestStatusChanged(token: string, status: UserStatus) {\n\t\tawait LivechatRooms.updateVisitorStatus(token, status);\n\n\t\tconst inquiryVisitorStatus = await LivechatInquiry.updateVisitorStatus(token, status);\n\n\t\tif (inquiryVisitorStatus.modifiedCount) {\n\t\t\tvoid notifyOnLivechatInquiryChangedByToken(token, 'updated', { v: { status } });\n\t\t}\n\t}\n\n\tasync setUserStatusLivechat(userId: string, status: ILivechatAgentStatus) {\n\t\tconst user = await Users.setLivechatStatus(userId, status);\n\t\tcallbacks.runAsync('livechat.setUserStatusLivechat', { userId, status });\n\n\t\tif (user.modifiedCount > 0) {\n\t\t\tvoid notifyOnUserChange({\n\t\t\t\tid: userId,\n\t\t\t\tclientAction: 'updated',\n\t\t\t\tdiff: {\n\t\t\t\t\tstatusLivechat: status,\n\t\t\t\t\tlivechatStatusSystemModified: false,\n\t\t\t\t},\n\t\t\t});\n\t\t}\n\n\t\treturn user;\n\t}\n\n\tasync afterAgentAdded(user: IUser) {\n\t\tawait Promise.all([\n\t\t\tUsers.setOperator(user._id, true),\n\t\t\tthis.setUserStatusLivechat(user._id, user.status !== 'offline' ? ILivechatAgentStatus.AVAILABLE : ILivechatAgentStatus.NOT_AVAILABLE),\n\t\t]);\n\t\tcallbacks.runAsync('livechat.onNewAgentCreated', user._id);\n\n\t\treturn user;\n\t}\n\n\tasync addAgent(username: string) {\n\t\tcheck(username, String);\n\n\t\tconst user = await Users.findOneByUsername(username, { projection: { _id: 1, username: 1 } });\n\n\t\tif (!user) {\n\t\t\tthrow new Meteor.Error('error-invalid-user');\n\t\t}\n\n\t\tif (await addUserRolesAsync(user._id, ['livechat-agent'])) {\n\t\t\treturn this.afterAgentAdded(user);\n\t\t}\n\n\t\treturn false;\n\t}\n\n\tasync afterAgentUserActivated(user: IUser) {\n\t\tif (!user.roles.includes('livechat-agent')) {\n\t\t\tthrow new Error('invalid-user-role');\n\t\t}\n\t\tawait Users.setOperator(user._id, true);\n\t\tcallbacks.runAsync('livechat.onNewAgentCreated', user._id);\n\t}\n\n\tasync addManager(username: string) {\n\t\tcheck(username, String);\n\n\t\tconst user = await Users.findOneByUsername(username, { projection: { _id: 1, username: 1 } });\n\n\t\tif (!user) {\n\t\t\tthrow new Meteor.Error('error-invalid-user');\n\t\t}\n\n\t\tif (await addUserRolesAsync(user._id, ['livechat-manager'])) {\n\t\t\treturn user;\n\t\t}\n\n\t\treturn false;\n\t}\n\n\tasync saveRoomInfo(\n\t\troomData: {\n\t\t\t_id: string;\n\t\t\ttopic?: string;\n\t\t\ttags?: string[];\n\t\t\tlivechatData?: { [k: string]: string };\n\t\t\t// For priority and SLA, if the value is blank (ie \"\"), then system will remove the priority or SLA from the room\n\t\t\tpriorityId?: string;\n\t\t\tslaId?: string;\n\t\t},\n\t\tguestData?: {\n\t\t\t_id: string;\n\t\t\tname?: string;\n\t\t\temail?: string;\n\t\t\tphone?: string;\n\t\t\tlivechatData?: { [k: string]: string };\n\t\t},\n\t\tuserId?: string,\n\t) {\n\t\tthis.logger.debug(`Saving room information on room ${roomData._id}`);\n\t\tconst { livechatData = {} } = roomData;\n\t\tconst customFields: Record<string, string> = {};\n\n\t\tif ((!userId || (await hasPermissionAsync(userId, 'edit-livechat-room-customfields'))) && Object.keys(livechatData).length) {\n\t\t\tconst fields = LivechatCustomField.findByScope('room');\n\t\t\tfor await (const field of fields) {\n\t\t\t\tif (!livechatData.hasOwnProperty(field._id)) {\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\t\t\t\tconst value = trim(livechatData[field._id]);\n\t\t\t\tif (value !== '' && field.regexp !== undefined && field.regexp !== '') {\n\t\t\t\t\tconst regexp = new RegExp(field.regexp);\n\t\t\t\t\tif (!regexp.test(value)) {\n\t\t\t\t\t\tthrow new Meteor.Error(i18n.t('error-invalid-custom-field-value', { field: field.label }));\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tcustomFields[field._id] = value;\n\t\t\t}\n\t\t\troomData.livechatData = customFields;\n\t\t\tLivechat.logger.debug(`About to update ${Object.keys(customFields).length} custom fields on room ${roomData._id}`);\n\t\t}\n\n\t\tawait LivechatRooms.saveRoomById(roomData);\n\n\t\tsetImmediate(() => {\n\t\t\tvoid Apps.self?.triggerEvent(AppEvents.IPostLivechatRoomSaved, roomData._id);\n\t\t});\n\n\t\tif (guestData?.name?.trim().length) {\n\t\t\tconst { _id: rid } = roomData;\n\t\t\tconst { name } = guestData;\n\n\t\t\tconst responses = await Promise.all([\n\t\t\t\tRooms.setFnameById(rid, name),\n\t\t\t\tLivechatInquiry.setNameByRoomId(rid, name),\n\t\t\t\tSubscriptions.updateDisplayNameByRoomId(rid, name),\n\t\t\t]);\n\n\t\t\tif (responses[1]?.modifiedCount) {\n\t\t\t\tvoid notifyOnLivechatInquiryChangedByRoom(rid, 'updated', { name });\n\t\t\t}\n\n\t\t\tif (responses[2]?.modifiedCount) {\n\t\t\t\tawait notifyOnSubscriptionChangedByRoomId(rid);\n\t\t\t}\n\t\t}\n\n\t\tvoid notifyOnRoomChangedById(roomData._id);\n\n\t\treturn true;\n\t}\n}\n\nexport const Livechat = new LivechatClass();\n"],"mappings":"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","ignoreList":[]},"sourceType":"module","externalDependencies":{},"hash":"0deb7f1e68520b1364a87aaaa841f676b9fb9349"}
