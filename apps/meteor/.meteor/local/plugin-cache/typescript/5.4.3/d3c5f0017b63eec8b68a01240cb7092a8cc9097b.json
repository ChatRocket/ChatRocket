{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/app/cloud/server/functions/syncWorkspace/handleCommsSync.ts","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","topLevelAwait","objectRestSpread","objectRestSpread","asyncGenerators","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"os.osx.arm64"},"sourceFileName":"app/cloud/server/functions/syncWorkspace/handleCommsSync.ts","filename":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/app/cloud/server/functions/syncWorkspace/handleCommsSync.ts","inputSourceMap":{"version":3,"file":"app/cloud/server/functions/syncWorkspace/handleCommsSync.ts","sourceRoot":"","sources":["app/cloud/server/functions/syncWorkspace/handleCommsSync.ts"],"names":[],"mappings":"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","sourcesContent":["import { NPS, Banner } from '@rocket.chat/core-services';\nimport type { Cloud, Serialized } from '@rocket.chat/core-typings';\n\nimport { getAndCreateNpsSurvey } from '../../../../../server/services/nps/getAndCreateNpsSurvey';\n\nexport const handleNpsOnWorkspaceSync = async (nps: Exclude<Serialized<Cloud.WorkspaceSyncPayload>['nps'], undefined>) => {\n\tconst { id: npsId, expireAt } = nps;\n\n\tconst startAt = new Date(nps.startAt);\n\n\tawait NPS.create({\n\t\tnpsId,\n\t\tstartAt,\n\t\texpireAt: new Date(expireAt),\n\t\tcreatedBy: {\n\t\t\t_id: 'rocket.cat',\n\t\t\tusername: 'rocket.cat',\n\t\t},\n\t});\n\n\tconst now = new Date();\n\n\tif (startAt.getFullYear() === now.getFullYear() && startAt.getMonth() === now.getMonth() && startAt.getDate() === now.getDate()) {\n\t\tawait getAndCreateNpsSurvey(npsId);\n\t}\n};\n\nexport const handleBannerOnWorkspaceSync = async (banners: Exclude<Serialized<Cloud.WorkspaceSyncPayload>['banners'], undefined>) => {\n\tfor await (const banner of banners) {\n\t\tconst { createdAt, expireAt, startAt, inactivedAt, _updatedAt, ...rest } = banner;\n\n\t\tawait Banner.create({\n\t\t\t...rest,\n\t\t\tcreatedAt: new Date(createdAt),\n\t\t\texpireAt: new Date(expireAt),\n\t\t\tstartAt: new Date(startAt),\n\t\t\t...(inactivedAt && { inactivedAt: new Date(inactivedAt) }),\n\t\t});\n\t}\n};\n\nconst deserializeAnnouncement = (announcement: Serialized<Cloud.Announcement>): Cloud.Announcement => {\n\tconst { inactivedAt, _updatedAt, expireAt, startAt, createdAt } = announcement;\n\n\treturn {\n\t\t...announcement,\n\t\t_updatedAt: new Date(_updatedAt),\n\t\texpireAt: new Date(expireAt),\n\t\tstartAt: new Date(startAt),\n\t\tcreatedAt: new Date(createdAt),\n\t\tinactivedAt: inactivedAt ? new Date(inactivedAt) : undefined,\n\t};\n};\n\nexport const handleAnnouncementsOnWorkspaceSync = async (\n\tannouncements: Exclude<Serialized<Cloud.WorkspaceCommsResponsePayload>['announcements'], undefined>,\n) => {\n\tconst { create, delete: deleteIds } = announcements;\n\n\tif (deleteIds) {\n\t\tawait Promise.all(deleteIds.map((bannerId) => Banner.disable(bannerId)));\n\t}\n\n\tawait Promise.all(\n\t\tcreate.map(deserializeAnnouncement).map((announcement) => {\n\t\t\tconst { view, selector } = announcement;\n\n\t\t\treturn Banner.create({\n\t\t\t\t...announcement,\n\t\t\t\t...(selector?.roles ? { roles: selector.roles } : {}),\n\t\t\t\tview: {\n\t\t\t\t\t...view,\n\t\t\t\t\tappId: 'cloud-announcements-core',\n\t\t\t\t},\n\t\t\t});\n\t\t}),\n\t);\n};\n"]},"targets":{"android":"125.0.0","chrome":"125.0.0","edge":"125.0.0","firefox":"115.0.0","ie":"10.0.0","ios":"17.4.0","opera":"110.0.0","opera_mobile":"80.0.0","safari":"17.4.0","samsung":"24.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor","root":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":false,"enforceStrictMode":false,"dynamicImport":true,"generateLetDeclarations":true,"topLevelAwait":true},"externalDependencies":[]},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"version":"7.17.2","helpers":true,"useESModules":false,"corejs":false},"externalDependencies":[]},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-async-generator-functions","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-class-properties","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true},"externalDependencies":[]},{"key":"transform-react-jsx","visitor":{"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXFragment":{"exit":[null]},"JSXElement":{"exit":[null]},"JSXAttribute":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false},"externalDependencies":[]},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-nullish-coalescing-operator","visitor":{"LogicalExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-optional-chaining","visitor":{"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-optional-catch-binding","visitor":{"CatchClause":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-class-properties","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-async-generator-functions","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-logical-assignment-operators","visitor":{"AssignmentExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]}],"presets":[],"generatorOpts":{"filename":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/app/cloud/server/functions/syncWorkspace/handleCommsSync.ts","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"app/cloud/server/functions/syncWorkspace/handleCommsSync.ts","inputSourceMap":{"version":3,"file":"app/cloud/server/functions/syncWorkspace/handleCommsSync.ts","sourceRoot":"","sources":["app/cloud/server/functions/syncWorkspace/handleCommsSync.ts"],"names":[],"mappings":"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","sourcesContent":["import { NPS, Banner } from '@rocket.chat/core-services';\nimport type { Cloud, Serialized } from '@rocket.chat/core-typings';\n\nimport { getAndCreateNpsSurvey } from '../../../../../server/services/nps/getAndCreateNpsSurvey';\n\nexport const handleNpsOnWorkspaceSync = async (nps: Exclude<Serialized<Cloud.WorkspaceSyncPayload>['nps'], undefined>) => {\n\tconst { id: npsId, expireAt } = nps;\n\n\tconst startAt = new Date(nps.startAt);\n\n\tawait NPS.create({\n\t\tnpsId,\n\t\tstartAt,\n\t\texpireAt: new Date(expireAt),\n\t\tcreatedBy: {\n\t\t\t_id: 'rocket.cat',\n\t\t\tusername: 'rocket.cat',\n\t\t},\n\t});\n\n\tconst now = new Date();\n\n\tif (startAt.getFullYear() === now.getFullYear() && startAt.getMonth() === now.getMonth() && startAt.getDate() === now.getDate()) {\n\t\tawait getAndCreateNpsSurvey(npsId);\n\t}\n};\n\nexport const handleBannerOnWorkspaceSync = async (banners: Exclude<Serialized<Cloud.WorkspaceSyncPayload>['banners'], undefined>) => {\n\tfor await (const banner of banners) {\n\t\tconst { createdAt, expireAt, startAt, inactivedAt, _updatedAt, ...rest } = banner;\n\n\t\tawait Banner.create({\n\t\t\t...rest,\n\t\t\tcreatedAt: new Date(createdAt),\n\t\t\texpireAt: new Date(expireAt),\n\t\t\tstartAt: new Date(startAt),\n\t\t\t...(inactivedAt && { inactivedAt: new Date(inactivedAt) }),\n\t\t});\n\t}\n};\n\nconst deserializeAnnouncement = (announcement: Serialized<Cloud.Announcement>): Cloud.Announcement => {\n\tconst { inactivedAt, _updatedAt, expireAt, startAt, createdAt } = announcement;\n\n\treturn {\n\t\t...announcement,\n\t\t_updatedAt: new Date(_updatedAt),\n\t\texpireAt: new Date(expireAt),\n\t\tstartAt: new Date(startAt),\n\t\tcreatedAt: new Date(createdAt),\n\t\tinactivedAt: inactivedAt ? new Date(inactivedAt) : undefined,\n\t};\n};\n\nexport const handleAnnouncementsOnWorkspaceSync = async (\n\tannouncements: Exclude<Serialized<Cloud.WorkspaceCommsResponsePayload>['announcements'], undefined>,\n) => {\n\tconst { create, delete: deleteIds } = announcements;\n\n\tif (deleteIds) {\n\t\tawait Promise.all(deleteIds.map((bannerId) => Banner.disable(bannerId)));\n\t}\n\n\tawait Promise.all(\n\t\tcreate.map(deserializeAnnouncement).map((announcement) => {\n\t\t\tconst { view, selector } = announcement;\n\n\t\t\treturn Banner.create({\n\t\t\t\t...announcement,\n\t\t\t\t...(selector?.roles ? { roles: selector.roles } : {}),\n\t\t\t\tview: {\n\t\t\t\t\t...view,\n\t\t\t\t\tappId: 'cloud-announcements-core',\n\t\t\t\t},\n\t\t\t});\n\t\t}),\n\t);\n};\n"]}}},"code":"!module.wrapAsync(async function (module, __reifyWaitForDeps__, __reify_async_result__) {\n  \"use strict\";\n  try {\n    let _objectSpread;\n    module.link(\"@babel/runtime/helpers/objectSpread2\", {\n      default(v) {\n        _objectSpread = v;\n      }\n    }, 0);\n    let _objectWithoutProperties;\n    module.link(\"@babel/runtime/helpers/objectWithoutProperties\", {\n      default(v) {\n        _objectWithoutProperties = v;\n      }\n    }, 1);\n    let _asyncIterator;\n    module.link(\"@babel/runtime/helpers/asyncIterator\", {\n      default(v) {\n        _asyncIterator = v;\n      }\n    }, 2);\n    const _excluded = [\"createdAt\", \"expireAt\", \"startAt\", \"inactivedAt\", \"_updatedAt\"];\n    module.export({\n      handleNpsOnWorkspaceSync: () => handleNpsOnWorkspaceSync,\n      handleBannerOnWorkspaceSync: () => handleBannerOnWorkspaceSync,\n      handleAnnouncementsOnWorkspaceSync: () => handleAnnouncementsOnWorkspaceSync\n    });\n    let NPS, Banner;\n    module.link(\"@rocket.chat/core-services\", {\n      NPS(v) {\n        NPS = v;\n      },\n      Banner(v) {\n        Banner = v;\n      }\n    }, 0);\n    let getAndCreateNpsSurvey;\n    module.link(\"../../../../../server/services/nps/getAndCreateNpsSurvey\", {\n      getAndCreateNpsSurvey(v) {\n        getAndCreateNpsSurvey = v;\n      }\n    }, 1);\n    if (__reifyWaitForDeps__()) (await __reifyWaitForDeps__())();\n    const handleNpsOnWorkspaceSync = async nps => {\n      const {\n        id: npsId,\n        expireAt\n      } = nps;\n      const startAt = new Date(nps.startAt);\n      await NPS.create({\n        npsId,\n        startAt,\n        expireAt: new Date(expireAt),\n        createdBy: {\n          _id: 'rocket.cat',\n          username: 'rocket.cat'\n        }\n      });\n      const now = new Date();\n      if (startAt.getFullYear() === now.getFullYear() && startAt.getMonth() === now.getMonth() && startAt.getDate() === now.getDate()) {\n        await getAndCreateNpsSurvey(npsId);\n      }\n    };\n    const handleBannerOnWorkspaceSync = async banners => {\n      var _iteratorAbruptCompletion = false;\n      var _didIteratorError = false;\n      var _iteratorError;\n      try {\n        for (var _iterator = _asyncIterator(banners), _step; _iteratorAbruptCompletion = !(_step = await _iterator.next()).done; _iteratorAbruptCompletion = false) {\n          const banner = _step.value;\n          {\n            const {\n                createdAt,\n                expireAt,\n                startAt,\n                inactivedAt,\n                _updatedAt\n              } = banner,\n              rest = _objectWithoutProperties(banner, _excluded);\n            await Banner.create(_objectSpread(_objectSpread({}, rest), {}, {\n              createdAt: new Date(createdAt),\n              expireAt: new Date(expireAt),\n              startAt: new Date(startAt)\n            }, inactivedAt && {\n              inactivedAt: new Date(inactivedAt)\n            }));\n          }\n        }\n      } catch (err) {\n        _didIteratorError = true;\n        _iteratorError = err;\n      } finally {\n        try {\n          if (_iteratorAbruptCompletion && _iterator.return != null) {\n            await _iterator.return();\n          }\n        } finally {\n          if (_didIteratorError) {\n            throw _iteratorError;\n          }\n        }\n      }\n    };\n    const deserializeAnnouncement = announcement => {\n      const {\n        inactivedAt,\n        _updatedAt,\n        expireAt,\n        startAt,\n        createdAt\n      } = announcement;\n      return _objectSpread(_objectSpread({}, announcement), {}, {\n        _updatedAt: new Date(_updatedAt),\n        expireAt: new Date(expireAt),\n        startAt: new Date(startAt),\n        createdAt: new Date(createdAt),\n        inactivedAt: inactivedAt ? new Date(inactivedAt) : undefined\n      });\n    };\n    const handleAnnouncementsOnWorkspaceSync = async announcements => {\n      const {\n        create,\n        delete: deleteIds\n      } = announcements;\n      if (deleteIds) {\n        await Promise.all(deleteIds.map(bannerId => Banner.disable(bannerId)));\n      }\n      await Promise.all(create.map(deserializeAnnouncement).map(announcement => {\n        const {\n          view,\n          selector\n        } = announcement;\n        return Banner.create(_objectSpread(_objectSpread(_objectSpread({}, announcement), selector !== null && selector !== void 0 && selector.roles ? {\n          roles: selector.roles\n        } : {}), {}, {\n          view: _objectSpread(_objectSpread({}, view), {}, {\n            appId: 'cloud-announcements-core'\n          })\n        }));\n      }));\n    };\n    __reify_async_result__();\n  } catch (_reifyError) {\n    return __reify_async_result__(_reifyError);\n  }\n  __reify_async_result__()\n}, {\n  self: this,\n  async: false\n});","map":{"version":3,"names":["_objectSpread","module","link","default","v","_objectWithoutProperties","_asyncIterator","_excluded","export","handleNpsOnWorkspaceSync","handleBannerOnWorkspaceSync","handleAnnouncementsOnWorkspaceSync","NPS","Banner","getAndCreateNpsSurvey","__reifyWaitForDeps__","nps","id","npsId","expireAt","startAt","Date","create","createdBy","_id","username","now","getFullYear","getMonth","getDate","banners","_iteratorAbruptCompletion","_didIteratorError","_iteratorError","_iterator","_step","next","done","banner","value","createdAt","inactivedAt","_updatedAt","rest","err","return","deserializeAnnouncement","announcement","undefined","announcements","delete","deleteIds","Promise","all","map","bannerId","disable","view","selector","roles","appId","__reify_async_result__","_reifyError","self","async"],"sources":["app/cloud/server/functions/syncWorkspace/handleCommsSync.ts"],"sourcesContent":["import { NPS, Banner } from '@rocket.chat/core-services';\nimport type { Cloud, Serialized } from '@rocket.chat/core-typings';\n\nimport { getAndCreateNpsSurvey } from '../../../../../server/services/nps/getAndCreateNpsSurvey';\n\nexport const handleNpsOnWorkspaceSync = async (nps: Exclude<Serialized<Cloud.WorkspaceSyncPayload>['nps'], undefined>) => {\n\tconst { id: npsId, expireAt } = nps;\n\n\tconst startAt = new Date(nps.startAt);\n\n\tawait NPS.create({\n\t\tnpsId,\n\t\tstartAt,\n\t\texpireAt: new Date(expireAt),\n\t\tcreatedBy: {\n\t\t\t_id: 'rocket.cat',\n\t\t\tusername: 'rocket.cat',\n\t\t},\n\t});\n\n\tconst now = new Date();\n\n\tif (startAt.getFullYear() === now.getFullYear() && startAt.getMonth() === now.getMonth() && startAt.getDate() === now.getDate()) {\n\t\tawait getAndCreateNpsSurvey(npsId);\n\t}\n};\n\nexport const handleBannerOnWorkspaceSync = async (banners: Exclude<Serialized<Cloud.WorkspaceSyncPayload>['banners'], undefined>) => {\n\tfor await (const banner of banners) {\n\t\tconst { createdAt, expireAt, startAt, inactivedAt, _updatedAt, ...rest } = banner;\n\n\t\tawait Banner.create({\n\t\t\t...rest,\n\t\t\tcreatedAt: new Date(createdAt),\n\t\t\texpireAt: new Date(expireAt),\n\t\t\tstartAt: new Date(startAt),\n\t\t\t...(inactivedAt && { inactivedAt: new Date(inactivedAt) }),\n\t\t});\n\t}\n};\n\nconst deserializeAnnouncement = (announcement: Serialized<Cloud.Announcement>): Cloud.Announcement => {\n\tconst { inactivedAt, _updatedAt, expireAt, startAt, createdAt } = announcement;\n\n\treturn {\n\t\t...announcement,\n\t\t_updatedAt: new Date(_updatedAt),\n\t\texpireAt: new Date(expireAt),\n\t\tstartAt: new Date(startAt),\n\t\tcreatedAt: new Date(createdAt),\n\t\tinactivedAt: inactivedAt ? new Date(inactivedAt) : undefined,\n\t};\n};\n\nexport const handleAnnouncementsOnWorkspaceSync = async (\n\tannouncements: Exclude<Serialized<Cloud.WorkspaceCommsResponsePayload>['announcements'], undefined>,\n) => {\n\tconst { create, delete: deleteIds } = announcements;\n\n\tif (deleteIds) {\n\t\tawait Promise.all(deleteIds.map((bannerId) => Banner.disable(bannerId)));\n\t}\n\n\tawait Promise.all(\n\t\tcreate.map(deserializeAnnouncement).map((announcement) => {\n\t\t\tconst { view, selector } = announcement;\n\n\t\t\treturn Banner.create({\n\t\t\t\t...announcement,\n\t\t\t\t...(selector?.roles ? { roles: selector.roles } : {}),\n\t\t\t\tview: {\n\t\t\t\t\t...view,\n\t\t\t\t\tappId: 'cloud-announcements-core',\n\t\t\t\t},\n\t\t\t});\n\t\t}),\n\t);\n};\n"],"mappings":"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","ignoreList":[]},"sourceType":"module","externalDependencies":{},"hash":"d3c5f0017b63eec8b68a01240cb7092a8cc9097b"}
