{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/client/apps/orchestrator.ts","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","topLevelAwait","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"web.browser"},"sourceFileName":"client/apps/orchestrator.ts","filename":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/client/apps/orchestrator.ts","inputSourceMap":{"version":3,"file":"client/apps/orchestrator.ts","sourceRoot":"","sources":["client/apps/orchestrator.ts"],"names":[],"mappings":"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","sourcesContent":["import { AppClientManager } from '@rocket.chat/apps-engine/client/AppClientManager';\nimport type { AppsEngineUIHost } from '@rocket.chat/apps-engine/client/AppsEngineUIHost';\nimport type { IPermission } from '@rocket.chat/apps-engine/definition/permissions/IPermission';\nimport type { ISetting } from '@rocket.chat/apps-engine/definition/settings';\nimport type { Serialized } from '@rocket.chat/core-typings';\n\nimport type { IAppExternalURL, ICategory } from './@types/IOrchestrator';\nimport { RealAppsEngineUIHost } from './RealAppsEngineUIHost';\nimport { hasAtLeastOnePermission } from '../../app/authorization/client';\nimport { sdk } from '../../app/utils/client/lib/SDKClient';\nimport { dispatchToastMessage } from '../lib/toast';\nimport type { App } from '../views/marketplace/types';\n\nconst isErrorObject = (e: unknown): e is { error: string } =>\n\ttypeof e === 'object' && e !== null && 'error' in e && typeof e.error === 'string';\n\nclass AppClientOrchestrator {\n\tprivate _appClientUIHost: AppsEngineUIHost;\n\n\tprivate _manager: AppClientManager;\n\n\tprivate _isLoaded: boolean;\n\n\tconstructor() {\n\t\tthis._appClientUIHost = new RealAppsEngineUIHost();\n\t\tthis._manager = new AppClientManager(this._appClientUIHost);\n\t\tthis._isLoaded = false;\n\t}\n\n\tpublic async load(): Promise<void> {\n\t\tif (!this._isLoaded) {\n\t\t\tthis._isLoaded = true;\n\t\t}\n\t}\n\n\tpublic getAppClientManager(): AppClientManager {\n\t\treturn this._manager;\n\t}\n\n\tpublic handleError(error: unknown): void {\n\t\tif (hasAtLeastOnePermission(['manage-apps'])) {\n\t\t\tdispatchToastMessage({\n\t\t\t\ttype: 'error',\n\t\t\t\tmessage: error,\n\t\t\t});\n\t\t}\n\t}\n\n\tpublic async getInstalledApps(): Promise<App[]> {\n\t\tconst result = await sdk.rest.get<'/apps/installed'>('/apps/installed');\n\n\t\tif ('apps' in result) {\n\t\t\t// TODO: chapter day: multiple results are returned, but we only need one\n\t\t\treturn result.apps as App[];\n\t\t}\n\t\tthrow new Error('Invalid response from API');\n\t}\n\n\tpublic async getAppsFromMarketplace(isAdminUser?: boolean): Promise<{ apps: App[]; error?: unknown }> {\n\t\tlet result: App[] = [];\n\t\ttry {\n\t\t\tresult = await sdk.rest.get('/apps/marketplace', { isAdminUser: isAdminUser ? isAdminUser.toString() : 'false' });\n\t\t} catch (e) {\n\t\t\tif (isErrorObject(e)) {\n\t\t\t\treturn { apps: [], error: e.error };\n\t\t\t}\n\t\t\tif (typeof e === 'string') {\n\t\t\t\treturn { apps: [], error: e };\n\t\t\t}\n\t\t}\n\n\t\tif (!Array.isArray(result)) {\n\t\t\t// TODO: chapter day: multiple results are returned, but we only need one\n\t\t\treturn { apps: [], error: 'Invalid response from API' };\n\t\t}\n\n\t\tconst apps = (result as App[]).map((app: App) => {\n\t\t\tconst { latest, appRequestStats, price, pricingPlans, purchaseType, isEnterpriseOnly, modifiedAt, bundledIn, requestedEndUser } = app;\n\t\t\treturn {\n\t\t\t\t...latest,\n\t\t\t\tappRequestStats,\n\t\t\t\tprice,\n\t\t\t\tpricingPlans,\n\t\t\t\tpurchaseType,\n\t\t\t\tisEnterpriseOnly,\n\t\t\t\tmodifiedAt,\n\t\t\t\tbundledIn,\n\t\t\t\trequestedEndUser,\n\t\t\t};\n\t\t});\n\n\t\treturn { apps, error: undefined };\n\t}\n\n\tpublic async getAppsOnBundle(bundleId: string): Promise<App[]> {\n\t\tconst { apps } = await sdk.rest.get(`/apps/bundles/${bundleId}/apps`);\n\t\treturn apps;\n\t}\n\n\tpublic async getApp(appId: string): Promise<App> {\n\t\tconst { app } = await sdk.rest.get(`/apps/${appId}` as any);\n\t\treturn app;\n\t}\n\n\tpublic async setAppSettings(appId: string, settings: ISetting[]): Promise<void> {\n\t\tawait sdk.rest.post(`/apps/${appId}/settings`, { settings });\n\t}\n\n\tpublic async installApp(appId: string, version: string, permissionsGranted?: IPermission[]): Promise<App> {\n\t\tconst { app } = (await sdk.rest.post<'/apps'>('/apps', {\n\t\t\tappId,\n\t\t\tmarketplace: true,\n\t\t\tversion,\n\t\t\tpermissionsGranted,\n\t\t})) as { app: App };\n\t\treturn app;\n\t}\n\n\tpublic async updateApp(appId: string, version: string, permissionsGranted?: IPermission[]): Promise<App> {\n\t\tconst result = await sdk.rest.post<'/apps/:id'>(`/apps/${appId}`, {\n\t\t\tappId,\n\t\t\tmarketplace: true,\n\t\t\tversion,\n\t\t\tpermissionsGranted,\n\t\t});\n\n\t\tif ('app' in result) {\n\t\t\treturn result.app;\n\t\t}\n\t\tthrow new Error('App not found');\n\t}\n\n\tpublic async buildExternalUrl(appId: string, purchaseType: 'buy' | 'subscription' = 'buy', details = false): Promise<IAppExternalURL> {\n\t\tconst result = await sdk.rest.get('/apps/buildExternalUrl', {\n\t\t\tappId,\n\t\t\tpurchaseType,\n\t\t\tdetails: `${details}`,\n\t\t});\n\n\t\tif ('url' in result) {\n\t\t\treturn result;\n\t\t}\n\n\t\tthrow new Error('Failed to build external url');\n\t}\n\n\tpublic async buildExternalAppRequest(appId: string) {\n\t\tconst result = await sdk.rest.get('/apps/buildExternalAppRequest', {\n\t\t\tappId,\n\t\t});\n\n\t\tif ('url' in result) {\n\t\t\treturn result;\n\t\t}\n\t\tthrow new Error('Failed to build App Request external url');\n\t}\n\n\tpublic async buildIncompatibleExternalUrl(appId: string, appVersion: string, action: string): Promise<IAppExternalURL> {\n\t\tconst result = await sdk.rest.get('/apps/incompatibleModal', {\n\t\t\tappId,\n\t\t\tappVersion,\n\t\t\taction,\n\t\t});\n\n\t\tif ('url' in result) {\n\t\t\treturn result;\n\t\t}\n\n\t\tthrow new Error('Failed to build external url');\n\t}\n\n\tpublic async getCategories(): Promise<Serialized<ICategory[]>> {\n\t\tconst result = await sdk.rest.get('/apps/categories');\n\n\t\tif (Array.isArray(result)) {\n\t\t\t// TODO: chapter day: multiple results are returned, but we only need one\n\t\t\treturn result as Serialized<ICategory>[];\n\t\t}\n\t\tthrow new Error('Failed to get categories');\n\t}\n}\n\nexport const AppClientOrchestratorInstance = new AppClientOrchestrator();\n"]},"targets":{"android":"125.0.0","chrome":"125.0.0","edge":"125.0.0","firefox":"115.0.0","ie":"10.0.0","ios":"17.4.0","opera":"110.0.0","opera_mobile":"80.0.0","safari":"17.4.0","samsung":"24.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor","root":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":false,"enforceStrictMode":false,"dynamicImport":true,"generateLetDeclarations":true},"externalDependencies":[]},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"version":"7.17.2","helpers":true,"useESModules":false,"corejs":false},"externalDependencies":[]},{"key":"proposal-class-properties","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true},"externalDependencies":[]},{"key":"transform-react-jsx","visitor":{"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXFragment":{"exit":[null]},"JSXElement":{"exit":[null]},"JSXAttribute":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false},"externalDependencies":[]},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-nullish-coalescing-operator","visitor":{"LogicalExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-optional-chaining","visitor":{"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-optional-catch-binding","visitor":{"CatchClause":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-class-properties","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-async-generator-functions","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-logical-assignment-operators","visitor":{"AssignmentExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]}],"presets":[],"generatorOpts":{"filename":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/client/apps/orchestrator.ts","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"client/apps/orchestrator.ts","inputSourceMap":{"version":3,"file":"client/apps/orchestrator.ts","sourceRoot":"","sources":["client/apps/orchestrator.ts"],"names":[],"mappings":"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","sourcesContent":["import { AppClientManager } from '@rocket.chat/apps-engine/client/AppClientManager';\nimport type { AppsEngineUIHost } from '@rocket.chat/apps-engine/client/AppsEngineUIHost';\nimport type { IPermission } from '@rocket.chat/apps-engine/definition/permissions/IPermission';\nimport type { ISetting } from '@rocket.chat/apps-engine/definition/settings';\nimport type { Serialized } from '@rocket.chat/core-typings';\n\nimport type { IAppExternalURL, ICategory } from './@types/IOrchestrator';\nimport { RealAppsEngineUIHost } from './RealAppsEngineUIHost';\nimport { hasAtLeastOnePermission } from '../../app/authorization/client';\nimport { sdk } from '../../app/utils/client/lib/SDKClient';\nimport { dispatchToastMessage } from '../lib/toast';\nimport type { App } from '../views/marketplace/types';\n\nconst isErrorObject = (e: unknown): e is { error: string } =>\n\ttypeof e === 'object' && e !== null && 'error' in e && typeof e.error === 'string';\n\nclass AppClientOrchestrator {\n\tprivate _appClientUIHost: AppsEngineUIHost;\n\n\tprivate _manager: AppClientManager;\n\n\tprivate _isLoaded: boolean;\n\n\tconstructor() {\n\t\tthis._appClientUIHost = new RealAppsEngineUIHost();\n\t\tthis._manager = new AppClientManager(this._appClientUIHost);\n\t\tthis._isLoaded = false;\n\t}\n\n\tpublic async load(): Promise<void> {\n\t\tif (!this._isLoaded) {\n\t\t\tthis._isLoaded = true;\n\t\t}\n\t}\n\n\tpublic getAppClientManager(): AppClientManager {\n\t\treturn this._manager;\n\t}\n\n\tpublic handleError(error: unknown): void {\n\t\tif (hasAtLeastOnePermission(['manage-apps'])) {\n\t\t\tdispatchToastMessage({\n\t\t\t\ttype: 'error',\n\t\t\t\tmessage: error,\n\t\t\t});\n\t\t}\n\t}\n\n\tpublic async getInstalledApps(): Promise<App[]> {\n\t\tconst result = await sdk.rest.get<'/apps/installed'>('/apps/installed');\n\n\t\tif ('apps' in result) {\n\t\t\t// TODO: chapter day: multiple results are returned, but we only need one\n\t\t\treturn result.apps as App[];\n\t\t}\n\t\tthrow new Error('Invalid response from API');\n\t}\n\n\tpublic async getAppsFromMarketplace(isAdminUser?: boolean): Promise<{ apps: App[]; error?: unknown }> {\n\t\tlet result: App[] = [];\n\t\ttry {\n\t\t\tresult = await sdk.rest.get('/apps/marketplace', { isAdminUser: isAdminUser ? isAdminUser.toString() : 'false' });\n\t\t} catch (e) {\n\t\t\tif (isErrorObject(e)) {\n\t\t\t\treturn { apps: [], error: e.error };\n\t\t\t}\n\t\t\tif (typeof e === 'string') {\n\t\t\t\treturn { apps: [], error: e };\n\t\t\t}\n\t\t}\n\n\t\tif (!Array.isArray(result)) {\n\t\t\t// TODO: chapter day: multiple results are returned, but we only need one\n\t\t\treturn { apps: [], error: 'Invalid response from API' };\n\t\t}\n\n\t\tconst apps = (result as App[]).map((app: App) => {\n\t\t\tconst { latest, appRequestStats, price, pricingPlans, purchaseType, isEnterpriseOnly, modifiedAt, bundledIn, requestedEndUser } = app;\n\t\t\treturn {\n\t\t\t\t...latest,\n\t\t\t\tappRequestStats,\n\t\t\t\tprice,\n\t\t\t\tpricingPlans,\n\t\t\t\tpurchaseType,\n\t\t\t\tisEnterpriseOnly,\n\t\t\t\tmodifiedAt,\n\t\t\t\tbundledIn,\n\t\t\t\trequestedEndUser,\n\t\t\t};\n\t\t});\n\n\t\treturn { apps, error: undefined };\n\t}\n\n\tpublic async getAppsOnBundle(bundleId: string): Promise<App[]> {\n\t\tconst { apps } = await sdk.rest.get(`/apps/bundles/${bundleId}/apps`);\n\t\treturn apps;\n\t}\n\n\tpublic async getApp(appId: string): Promise<App> {\n\t\tconst { app } = await sdk.rest.get(`/apps/${appId}` as any);\n\t\treturn app;\n\t}\n\n\tpublic async setAppSettings(appId: string, settings: ISetting[]): Promise<void> {\n\t\tawait sdk.rest.post(`/apps/${appId}/settings`, { settings });\n\t}\n\n\tpublic async installApp(appId: string, version: string, permissionsGranted?: IPermission[]): Promise<App> {\n\t\tconst { app } = (await sdk.rest.post<'/apps'>('/apps', {\n\t\t\tappId,\n\t\t\tmarketplace: true,\n\t\t\tversion,\n\t\t\tpermissionsGranted,\n\t\t})) as { app: App };\n\t\treturn app;\n\t}\n\n\tpublic async updateApp(appId: string, version: string, permissionsGranted?: IPermission[]): Promise<App> {\n\t\tconst result = await sdk.rest.post<'/apps/:id'>(`/apps/${appId}`, {\n\t\t\tappId,\n\t\t\tmarketplace: true,\n\t\t\tversion,\n\t\t\tpermissionsGranted,\n\t\t});\n\n\t\tif ('app' in result) {\n\t\t\treturn result.app;\n\t\t}\n\t\tthrow new Error('App not found');\n\t}\n\n\tpublic async buildExternalUrl(appId: string, purchaseType: 'buy' | 'subscription' = 'buy', details = false): Promise<IAppExternalURL> {\n\t\tconst result = await sdk.rest.get('/apps/buildExternalUrl', {\n\t\t\tappId,\n\t\t\tpurchaseType,\n\t\t\tdetails: `${details}`,\n\t\t});\n\n\t\tif ('url' in result) {\n\t\t\treturn result;\n\t\t}\n\n\t\tthrow new Error('Failed to build external url');\n\t}\n\n\tpublic async buildExternalAppRequest(appId: string) {\n\t\tconst result = await sdk.rest.get('/apps/buildExternalAppRequest', {\n\t\t\tappId,\n\t\t});\n\n\t\tif ('url' in result) {\n\t\t\treturn result;\n\t\t}\n\t\tthrow new Error('Failed to build App Request external url');\n\t}\n\n\tpublic async buildIncompatibleExternalUrl(appId: string, appVersion: string, action: string): Promise<IAppExternalURL> {\n\t\tconst result = await sdk.rest.get('/apps/incompatibleModal', {\n\t\t\tappId,\n\t\t\tappVersion,\n\t\t\taction,\n\t\t});\n\n\t\tif ('url' in result) {\n\t\t\treturn result;\n\t\t}\n\n\t\tthrow new Error('Failed to build external url');\n\t}\n\n\tpublic async getCategories(): Promise<Serialized<ICategory[]>> {\n\t\tconst result = await sdk.rest.get('/apps/categories');\n\n\t\tif (Array.isArray(result)) {\n\t\t\t// TODO: chapter day: multiple results are returned, but we only need one\n\t\t\treturn result as Serialized<ICategory>[];\n\t\t}\n\t\tthrow new Error('Failed to get categories');\n\t}\n}\n\nexport const AppClientOrchestratorInstance = new AppClientOrchestrator();\n"]}}},"code":"let _objectSpread;\nmodule.link(\"@babel/runtime/helpers/objectSpread2\", {\n  default(v) {\n    _objectSpread = v;\n  }\n}, 0);\nmodule.export({\n  AppClientOrchestratorInstance: () => AppClientOrchestratorInstance\n});\nlet AppClientManager;\nmodule.link(\"@rocket.chat/apps-engine/client/AppClientManager\", {\n  AppClientManager(v) {\n    AppClientManager = v;\n  }\n}, 0);\nlet RealAppsEngineUIHost;\nmodule.link(\"./RealAppsEngineUIHost\", {\n  RealAppsEngineUIHost(v) {\n    RealAppsEngineUIHost = v;\n  }\n}, 1);\nlet hasAtLeastOnePermission;\nmodule.link(\"../../app/authorization/client\", {\n  hasAtLeastOnePermission(v) {\n    hasAtLeastOnePermission = v;\n  }\n}, 2);\nlet sdk;\nmodule.link(\"../../app/utils/client/lib/SDKClient\", {\n  sdk(v) {\n    sdk = v;\n  }\n}, 3);\nlet dispatchToastMessage;\nmodule.link(\"../lib/toast\", {\n  dispatchToastMessage(v) {\n    dispatchToastMessage = v;\n  }\n}, 4);\nconst isErrorObject = e => typeof e === 'object' && e !== null && 'error' in e && typeof e.error === 'string';\nclass AppClientOrchestrator {\n  constructor() {\n    this._appClientUIHost = void 0;\n    this._manager = void 0;\n    this._isLoaded = void 0;\n    this._appClientUIHost = new RealAppsEngineUIHost();\n    this._manager = new AppClientManager(this._appClientUIHost);\n    this._isLoaded = false;\n  }\n  async load() {\n    if (!this._isLoaded) {\n      this._isLoaded = true;\n    }\n  }\n  getAppClientManager() {\n    return this._manager;\n  }\n  handleError(error) {\n    if (hasAtLeastOnePermission(['manage-apps'])) {\n      dispatchToastMessage({\n        type: 'error',\n        message: error\n      });\n    }\n  }\n  async getInstalledApps() {\n    const result = await sdk.rest.get('/apps/installed');\n    if ('apps' in result) {\n      // TODO: chapter day: multiple results are returned, but we only need one\n      return result.apps;\n    }\n    throw new Error('Invalid response from API');\n  }\n  async getAppsFromMarketplace(isAdminUser) {\n    let result = [];\n    try {\n      result = await sdk.rest.get('/apps/marketplace', {\n        isAdminUser: isAdminUser ? isAdminUser.toString() : 'false'\n      });\n    } catch (e) {\n      if (isErrorObject(e)) {\n        return {\n          apps: [],\n          error: e.error\n        };\n      }\n      if (typeof e === 'string') {\n        return {\n          apps: [],\n          error: e\n        };\n      }\n    }\n    if (!Array.isArray(result)) {\n      // TODO: chapter day: multiple results are returned, but we only need one\n      return {\n        apps: [],\n        error: 'Invalid response from API'\n      };\n    }\n    const apps = result.map(app => {\n      const {\n        latest,\n        appRequestStats,\n        price,\n        pricingPlans,\n        purchaseType,\n        isEnterpriseOnly,\n        modifiedAt,\n        bundledIn,\n        requestedEndUser\n      } = app;\n      return _objectSpread(_objectSpread({}, latest), {}, {\n        appRequestStats,\n        price,\n        pricingPlans,\n        purchaseType,\n        isEnterpriseOnly,\n        modifiedAt,\n        bundledIn,\n        requestedEndUser\n      });\n    });\n    return {\n      apps,\n      error: undefined\n    };\n  }\n  async getAppsOnBundle(bundleId) {\n    const {\n      apps\n    } = await sdk.rest.get(\"/apps/bundles/\".concat(bundleId, \"/apps\"));\n    return apps;\n  }\n  async getApp(appId) {\n    const {\n      app\n    } = await sdk.rest.get(\"/apps/\".concat(appId));\n    return app;\n  }\n  async setAppSettings(appId, settings) {\n    await sdk.rest.post(\"/apps/\".concat(appId, \"/settings\"), {\n      settings\n    });\n  }\n  async installApp(appId, version, permissionsGranted) {\n    const {\n      app\n    } = await sdk.rest.post('/apps', {\n      appId,\n      marketplace: true,\n      version,\n      permissionsGranted\n    });\n    return app;\n  }\n  async updateApp(appId, version, permissionsGranted) {\n    const result = await sdk.rest.post(\"/apps/\".concat(appId), {\n      appId,\n      marketplace: true,\n      version,\n      permissionsGranted\n    });\n    if ('app' in result) {\n      return result.app;\n    }\n    throw new Error('App not found');\n  }\n  async buildExternalUrl(appId) {\n    let purchaseType = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : 'buy';\n    let details = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : false;\n    const result = await sdk.rest.get('/apps/buildExternalUrl', {\n      appId,\n      purchaseType,\n      details: \"\".concat(details)\n    });\n    if ('url' in result) {\n      return result;\n    }\n    throw new Error('Failed to build external url');\n  }\n  async buildExternalAppRequest(appId) {\n    const result = await sdk.rest.get('/apps/buildExternalAppRequest', {\n      appId\n    });\n    if ('url' in result) {\n      return result;\n    }\n    throw new Error('Failed to build App Request external url');\n  }\n  async buildIncompatibleExternalUrl(appId, appVersion, action) {\n    const result = await sdk.rest.get('/apps/incompatibleModal', {\n      appId,\n      appVersion,\n      action\n    });\n    if ('url' in result) {\n      return result;\n    }\n    throw new Error('Failed to build external url');\n  }\n  async getCategories() {\n    const result = await sdk.rest.get('/apps/categories');\n    if (Array.isArray(result)) {\n      // TODO: chapter day: multiple results are returned, but we only need one\n      return result;\n    }\n    throw new Error('Failed to get categories');\n  }\n}\nconst AppClientOrchestratorInstance = new AppClientOrchestrator();","map":{"version":3,"names":["_objectSpread","module","link","default","v","export","AppClientOrchestratorInstance","AppClientManager","RealAppsEngineUIHost","hasAtLeastOnePermission","sdk","dispatchToastMessage","isErrorObject","e","error","AppClientOrchestrator","constructor","_appClientUIHost","_manager","_isLoaded","load","getAppClientManager","handleError","type","message","getInstalledApps","result","rest","get","apps","Error","getAppsFromMarketplace","isAdminUser","toString","Array","isArray","map","app","latest","appRequestStats","price","pricingPlans","purchaseType","isEnterpriseOnly","modifiedAt","bundledIn","requestedEndUser","undefined","getAppsOnBundle","bundleId","concat","getApp","appId","setAppSettings","settings","post","installApp","version","permissionsGranted","marketplace","updateApp","buildExternalUrl","arguments","length","details","buildExternalAppRequest","buildIncompatibleExternalUrl","appVersion","action","getCategories"],"sources":["client/apps/orchestrator.ts"],"sourcesContent":["import { AppClientManager } from '@rocket.chat/apps-engine/client/AppClientManager';\nimport type { AppsEngineUIHost } from '@rocket.chat/apps-engine/client/AppsEngineUIHost';\nimport type { IPermission } from '@rocket.chat/apps-engine/definition/permissions/IPermission';\nimport type { ISetting } from '@rocket.chat/apps-engine/definition/settings';\nimport type { Serialized } from '@rocket.chat/core-typings';\n\nimport type { IAppExternalURL, ICategory } from './@types/IOrchestrator';\nimport { RealAppsEngineUIHost } from './RealAppsEngineUIHost';\nimport { hasAtLeastOnePermission } from '../../app/authorization/client';\nimport { sdk } from '../../app/utils/client/lib/SDKClient';\nimport { dispatchToastMessage } from '../lib/toast';\nimport type { App } from '../views/marketplace/types';\n\nconst isErrorObject = (e: unknown): e is { error: string } =>\n\ttypeof e === 'object' && e !== null && 'error' in e && typeof e.error === 'string';\n\nclass AppClientOrchestrator {\n\tprivate _appClientUIHost: AppsEngineUIHost;\n\n\tprivate _manager: AppClientManager;\n\n\tprivate _isLoaded: boolean;\n\n\tconstructor() {\n\t\tthis._appClientUIHost = new RealAppsEngineUIHost();\n\t\tthis._manager = new AppClientManager(this._appClientUIHost);\n\t\tthis._isLoaded = false;\n\t}\n\n\tpublic async load(): Promise<void> {\n\t\tif (!this._isLoaded) {\n\t\t\tthis._isLoaded = true;\n\t\t}\n\t}\n\n\tpublic getAppClientManager(): AppClientManager {\n\t\treturn this._manager;\n\t}\n\n\tpublic handleError(error: unknown): void {\n\t\tif (hasAtLeastOnePermission(['manage-apps'])) {\n\t\t\tdispatchToastMessage({\n\t\t\t\ttype: 'error',\n\t\t\t\tmessage: error,\n\t\t\t});\n\t\t}\n\t}\n\n\tpublic async getInstalledApps(): Promise<App[]> {\n\t\tconst result = await sdk.rest.get<'/apps/installed'>('/apps/installed');\n\n\t\tif ('apps' in result) {\n\t\t\t// TODO: chapter day: multiple results are returned, but we only need one\n\t\t\treturn result.apps as App[];\n\t\t}\n\t\tthrow new Error('Invalid response from API');\n\t}\n\n\tpublic async getAppsFromMarketplace(isAdminUser?: boolean): Promise<{ apps: App[]; error?: unknown }> {\n\t\tlet result: App[] = [];\n\t\ttry {\n\t\t\tresult = await sdk.rest.get('/apps/marketplace', { isAdminUser: isAdminUser ? isAdminUser.toString() : 'false' });\n\t\t} catch (e) {\n\t\t\tif (isErrorObject(e)) {\n\t\t\t\treturn { apps: [], error: e.error };\n\t\t\t}\n\t\t\tif (typeof e === 'string') {\n\t\t\t\treturn { apps: [], error: e };\n\t\t\t}\n\t\t}\n\n\t\tif (!Array.isArray(result)) {\n\t\t\t// TODO: chapter day: multiple results are returned, but we only need one\n\t\t\treturn { apps: [], error: 'Invalid response from API' };\n\t\t}\n\n\t\tconst apps = (result as App[]).map((app: App) => {\n\t\t\tconst { latest, appRequestStats, price, pricingPlans, purchaseType, isEnterpriseOnly, modifiedAt, bundledIn, requestedEndUser } = app;\n\t\t\treturn {\n\t\t\t\t...latest,\n\t\t\t\tappRequestStats,\n\t\t\t\tprice,\n\t\t\t\tpricingPlans,\n\t\t\t\tpurchaseType,\n\t\t\t\tisEnterpriseOnly,\n\t\t\t\tmodifiedAt,\n\t\t\t\tbundledIn,\n\t\t\t\trequestedEndUser,\n\t\t\t};\n\t\t});\n\n\t\treturn { apps, error: undefined };\n\t}\n\n\tpublic async getAppsOnBundle(bundleId: string): Promise<App[]> {\n\t\tconst { apps } = await sdk.rest.get(`/apps/bundles/${bundleId}/apps`);\n\t\treturn apps;\n\t}\n\n\tpublic async getApp(appId: string): Promise<App> {\n\t\tconst { app } = await sdk.rest.get(`/apps/${appId}` as any);\n\t\treturn app;\n\t}\n\n\tpublic async setAppSettings(appId: string, settings: ISetting[]): Promise<void> {\n\t\tawait sdk.rest.post(`/apps/${appId}/settings`, { settings });\n\t}\n\n\tpublic async installApp(appId: string, version: string, permissionsGranted?: IPermission[]): Promise<App> {\n\t\tconst { app } = (await sdk.rest.post<'/apps'>('/apps', {\n\t\t\tappId,\n\t\t\tmarketplace: true,\n\t\t\tversion,\n\t\t\tpermissionsGranted,\n\t\t})) as { app: App };\n\t\treturn app;\n\t}\n\n\tpublic async updateApp(appId: string, version: string, permissionsGranted?: IPermission[]): Promise<App> {\n\t\tconst result = await sdk.rest.post<'/apps/:id'>(`/apps/${appId}`, {\n\t\t\tappId,\n\t\t\tmarketplace: true,\n\t\t\tversion,\n\t\t\tpermissionsGranted,\n\t\t});\n\n\t\tif ('app' in result) {\n\t\t\treturn result.app;\n\t\t}\n\t\tthrow new Error('App not found');\n\t}\n\n\tpublic async buildExternalUrl(appId: string, purchaseType: 'buy' | 'subscription' = 'buy', details = false): Promise<IAppExternalURL> {\n\t\tconst result = await sdk.rest.get('/apps/buildExternalUrl', {\n\t\t\tappId,\n\t\t\tpurchaseType,\n\t\t\tdetails: `${details}`,\n\t\t});\n\n\t\tif ('url' in result) {\n\t\t\treturn result;\n\t\t}\n\n\t\tthrow new Error('Failed to build external url');\n\t}\n\n\tpublic async buildExternalAppRequest(appId: string) {\n\t\tconst result = await sdk.rest.get('/apps/buildExternalAppRequest', {\n\t\t\tappId,\n\t\t});\n\n\t\tif ('url' in result) {\n\t\t\treturn result;\n\t\t}\n\t\tthrow new Error('Failed to build App Request external url');\n\t}\n\n\tpublic async buildIncompatibleExternalUrl(appId: string, appVersion: string, action: string): Promise<IAppExternalURL> {\n\t\tconst result = await sdk.rest.get('/apps/incompatibleModal', {\n\t\t\tappId,\n\t\t\tappVersion,\n\t\t\taction,\n\t\t});\n\n\t\tif ('url' in result) {\n\t\t\treturn result;\n\t\t}\n\n\t\tthrow new Error('Failed to build external url');\n\t}\n\n\tpublic async getCategories(): Promise<Serialized<ICategory[]>> {\n\t\tconst result = await sdk.rest.get('/apps/categories');\n\n\t\tif (Array.isArray(result)) {\n\t\t\t// TODO: chapter day: multiple results are returned, but we only need one\n\t\t\treturn result as Serialized<ICategory>[];\n\t\t}\n\t\tthrow new Error('Failed to get categories');\n\t}\n}\n\nexport const AppClientOrchestratorInstance = new AppClientOrchestrator();\n"],"mappings":"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","ignoreList":[]},"sourceType":"module","externalDependencies":{},"hash":"f6d71c3026d0dae10666976f13849e17b6cc8efc"}
