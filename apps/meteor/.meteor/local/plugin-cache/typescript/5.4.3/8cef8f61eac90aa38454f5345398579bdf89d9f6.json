{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/client/views/room/body/hooks/useUnreadMessages.ts","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","topLevelAwait","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"web.browser.legacy"},"sourceFileName":"client/views/room/body/hooks/useUnreadMessages.ts","filename":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/client/views/room/body/hooks/useUnreadMessages.ts","inputSourceMap":{"version":3,"file":"client/views/room/body/hooks/useUnreadMessages.ts","sourceRoot":"","sources":["client/views/room/body/hooks/useUnreadMessages.ts"],"names":[],"mappings":"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","sourcesContent":["import type { IRoom, ISubscription } from '@rocket.chat/core-typings';\nimport { useRouter } from '@rocket.chat/ui-contexts';\nimport type { Dispatch, SetStateAction } from 'react';\nimport { useCallback, useEffect, useMemo, useRef, useState } from 'react';\n\nimport { ChatMessage } from '../../../../../app/models/client';\nimport { LegacyRoomManager, RoomHistoryManager } from '../../../../../app/ui-utils/client';\nimport { withDebouncing, withThrottling } from '../../../../../lib/utils/highOrderFunctions';\nimport { useReactiveValue } from '../../../../hooks/useReactiveValue';\nimport { roomCoordinator } from '../../../../lib/rooms/roomCoordinator';\nimport { setMessageJumpQueryStringParameter } from '../../../../lib/utils/setMessageJumpQueryStringParameter';\nimport { useChat } from '../../contexts/ChatContext';\n\ninterface IUnreadMessages {\n\tcount: number;\n\tsince: Date;\n}\n\nconst useUnreadMessages = (room: IRoom): readonly [data: IUnreadMessages | undefined, setUnreadCount: Dispatch<SetStateAction<number>>] => {\n\tconst notLoadedCount = useReactiveValue(useCallback(() => RoomHistoryManager.getRoom(room._id).unreadNotLoaded.get(), [room._id]));\n\tconst [loadedCount, setLoadedCount] = useState(0);\n\n\tconst count = useMemo(() => notLoadedCount + loadedCount, [notLoadedCount, loadedCount]);\n\n\tconst since = useReactiveValue(useCallback(() => LegacyRoomManager.getOpenedRoomByRid(room._id)?.unreadSince.get(), [room._id]));\n\n\treturn useMemo(() => {\n\t\tif (count && since) {\n\t\t\treturn [{ count, since }, setLoadedCount];\n\t\t}\n\n\t\treturn [undefined, setLoadedCount];\n\t}, [count, since]);\n};\n\nexport const useHandleUnread = (\n\troom: IRoom,\n\tsubscription?: ISubscription,\n): {\n\tinnerRef: (wrapper: HTMLDivElement | null) => void;\n\twrapperRef: React.MutableRefObject<HTMLDivElement | null>;\n\thandleUnreadBarJumpToButtonClick: () => void;\n\thandleMarkAsReadButtonClick: () => void;\n\tcounter: readonly [number, Date | undefined];\n} => {\n\tconst messagesBoxRef = useRef<HTMLDivElement>(null);\n\n\tconst subscribed = Boolean(subscription);\n\tconst [unread, setUnreadCount] = useUnreadMessages(room);\n\n\tconst [lastMessageDate, setLastMessageDate] = useState<Date | undefined>();\n\n\tconst chat = useChat();\n\n\tif (!chat) {\n\t\tthrow new Error('No ChatContext provided');\n\t}\n\tconst handleUnreadBarJumpToButtonClick = useCallback(() => {\n\t\tconst rid = room._id;\n\t\tconst { firstUnread } = RoomHistoryManager.getRoom(rid);\n\t\tlet message = firstUnread?.get();\n\t\tif (!message) {\n\t\t\tmessage = ChatMessage.findOne({ rid, ts: { $gt: unread?.since } }, { sort: { ts: 1 }, limit: 1 });\n\t\t}\n\t\tif (!message) {\n\t\t\treturn;\n\t\t}\n\t\tsetMessageJumpQueryStringParameter(message?._id);\n\t\tsetUnreadCount(0);\n\t}, [room._id, unread?.since, setUnreadCount]);\n\n\tconst handleMarkAsReadButtonClick = useCallback(() => {\n\t\tchat.readStateManager.markAsRead();\n\t\tsetUnreadCount(0);\n\t}, [chat.readStateManager, setUnreadCount]);\n\n\tuseEffect(() => {\n\t\tif (!subscribed) {\n\t\t\tsetUnreadCount(0);\n\t\t\treturn;\n\t\t}\n\n\t\tconst count = ChatMessage.find({\n\t\t\trid: room._id,\n\t\t\tts: { $lte: lastMessageDate, $gt: subscription?.ls },\n\t\t}).count();\n\n\t\tsetUnreadCount(count);\n\t}, [lastMessageDate, room._id, setUnreadCount, subscribed, subscription?.ls]);\n\n\tconst router = useRouter();\n\n\tconst debouncedReadMessageRead = useMemo(\n\t\t() =>\n\t\t\twithDebouncing({ wait: 500 })(() => {\n\t\t\t\tif (subscribed) {\n\t\t\t\t\tchat.readStateManager.attemptMarkAsRead();\n\t\t\t\t}\n\t\t\t}),\n\t\t[chat.readStateManager, subscribed],\n\t);\n\n\tuseEffect(\n\t\t() =>\n\t\t\trouter.subscribeToRouteChange(() => {\n\t\t\t\tconst routeName = router.getRouteName();\n\t\t\t\tif (!routeName || !roomCoordinator.isRouteNameKnown(routeName)) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tdebouncedReadMessageRead();\n\t\t\t}),\n\t\t[debouncedReadMessageRead, room._id, router, subscribed, subscription?.alert, subscription?.unread],\n\t);\n\n\tuseEffect(() => {\n\t\tif (!unread?.count) {\n\t\t\treturn debouncedReadMessageRead();\n\t\t}\n\t}, [debouncedReadMessageRead, room._id, unread?.count]);\n\n\tconst ref = useCallback(\n\t\t(wrapper: HTMLDivElement | null) => {\n\t\t\tif (!wrapper) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconst getElementFromPoint = (topOffset = 0): Element | undefined => {\n\t\t\t\tconst messagesBox = messagesBoxRef.current;\n\n\t\t\t\tif (!messagesBox) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tconst messagesBoxLeft = messagesBox.getBoundingClientRect().left + window.pageXOffset;\n\t\t\t\tconst messagesBoxTop = messagesBox.getBoundingClientRect().top + window.pageYOffset;\n\t\t\t\tconst messagesBoxWidth = parseFloat(getComputedStyle(messagesBox).width);\n\n\t\t\t\tlet element;\n\t\t\t\tif (document.dir === 'rtl') {\n\t\t\t\t\telement = document.elementFromPoint(messagesBoxLeft + messagesBoxWidth - 2, messagesBoxTop + topOffset + 2);\n\t\t\t\t} else {\n\t\t\t\t\telement = document.elementFromPoint(messagesBoxLeft + 2, messagesBoxTop + topOffset + 2);\n\t\t\t\t}\n\n\t\t\t\tif (element?.classList.contains('rcx-message') || element?.classList.contains('rcx-message--sequential')) {\n\t\t\t\t\treturn element;\n\t\t\t\t}\n\t\t\t};\n\t\t\twrapper.addEventListener(\n\t\t\t\t'scroll',\n\t\t\t\twithThrottling({ wait: 300 })(() => {\n\t\t\t\t\tTracker.afterFlush(() => {\n\t\t\t\t\t\tconst lastInvisibleMessageOnScreen = getElementFromPoint(0) || getElementFromPoint(20) || getElementFromPoint(40);\n\n\t\t\t\t\t\tif (!lastInvisibleMessageOnScreen) {\n\t\t\t\t\t\t\tsetUnreadCount(0);\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tconst lastMessage = ChatMessage.findOne(lastInvisibleMessageOnScreen.id);\n\t\t\t\t\t\tif (!lastMessage) {\n\t\t\t\t\t\t\tsetUnreadCount(0);\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tsetLastMessageDate(lastMessage.ts);\n\t\t\t\t\t});\n\t\t\t\t}),\n\t\t\t);\n\t\t},\n\t\t[setUnreadCount],\n\t);\n\n\treturn {\n\t\tinnerRef: ref,\n\t\twrapperRef: messagesBoxRef,\n\t\thandleUnreadBarJumpToButtonClick,\n\t\thandleMarkAsReadButtonClick,\n\t\tcounter: [unread?.count ?? 0, unread?.since] as const,\n\t};\n};\n"]},"targets":{"android":"125.0.0","chrome":"125.0.0","edge":"125.0.0","firefox":"115.0.0","ie":"10.0.0","ios":"17.4.0","opera":"110.0.0","opera_mobile":"80.0.0","safari":"17.4.0","samsung":"24.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor","root":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":true,"enforceStrictMode":false,"dynamicImport":true},"externalDependencies":[]},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"version":"7.17.2","helpers":true,"useESModules":false,"corejs":false},"externalDependencies":[]},{"key":"proposal-class-properties","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true},"externalDependencies":[]},{"key":"base$0$3","visitor":{"FunctionExpression":{"exit":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"base$0$4","visitor":{"ForInStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-react-jsx","visitor":{"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXFragment":{"exit":[null]},"JSXElement":{"exit":[null]},"JSXAttribute":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false},"externalDependencies":[]},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-nullish-coalescing-operator","visitor":{"LogicalExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-optional-chaining","visitor":{"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-optional-catch-binding","visitor":{"CatchClause":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-class-properties","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-async-generator-functions","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-logical-assignment-operators","visitor":{"AssignmentExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-arrow-functions","visitor":{"ArrowFunctionExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-block-scoped-functions","visitor":{"BlockStatement":{"enter":[null]},"SwitchCase":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-block-scoping","visitor":{"VariableDeclaration":{"enter":[null,null]},"BlockStatement":{"enter":[null]},"SwitchCase":{"enter":[null]},"ClassDeclaration":{"enter":[null]},"DoWhileStatement":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForStatement":{"enter":[null]},"WhileStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-classes","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"ClassDeclaration":{"enter":[null]},"ClassExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"loose":true},"externalDependencies":[]},{"key":"transform-computed-properties","visitor":{"ObjectExpression":{"exit":[null]},"_exploded":true,"_verified":true},"options":{"loose":true},"externalDependencies":[]},{"key":"transform-destructuring","visitor":{"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"VariableDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"transform-for-of","visitor":{"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"loose":true},"externalDependencies":[]},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-object-super","visitor":{"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true,"DoWhileStatement":{"exit":[null]},"ForInStatement":{"exit":[null]},"ForStatement":{"exit":[null]},"WhileStatement":{"exit":[null]},"ForOfStatement":{"exit":[null]}},"options":{},"externalDependencies":[]},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"transform-shorthand-properties","visitor":{"ObjectMethod":{"enter":[null]},"ObjectProperty":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-spread","visitor":{"ArrayExpression":{"enter":[null]},"CallExpression":{"enter":[null]},"NewExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-sticky-regex","visitor":{"RegExpLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"loose":true},"externalDependencies":[]},{"key":"transform-typeof-symbol","visitor":{"UnaryExpression":{"enter":[null]},"_exploded":true,"_verified":true,"BlockStatement":{"enter":[null]},"CatchClause":{"enter":[null]},"DoWhileStatement":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForStatement":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"Program":{"enter":[null]},"ObjectMethod":{"enter":[null]},"SwitchStatement":{"enter":[null]},"WhileStatement":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]},"ForOfStatement":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"StaticBlock":{"enter":[null]},"TSModuleBlock":{"enter":[null]},"AssignmentPattern":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectPattern":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"transform-unicode-regex","visitor":{"RegExpLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-property-literals","visitor":{"ObjectProperty":{"exit":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-regenerator","visitor":{"ObjectMethod":{"enter":[null],"exit":[null]},"ClassMethod":{"enter":[null],"exit":[null]},"ClassPrivateMethod":{"enter":[null],"exit":[null]},"FunctionDeclaration":{"exit":[null]},"FunctionExpression":{"exit":[null]},"ArrowFunctionExpression":{"exit":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]}],"presets":[],"generatorOpts":{"filename":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/client/views/room/body/hooks/useUnreadMessages.ts","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"client/views/room/body/hooks/useUnreadMessages.ts","inputSourceMap":{"version":3,"file":"client/views/room/body/hooks/useUnreadMessages.ts","sourceRoot":"","sources":["client/views/room/body/hooks/useUnreadMessages.ts"],"names":[],"mappings":"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","sourcesContent":["import type { IRoom, ISubscription } from '@rocket.chat/core-typings';\nimport { useRouter } from '@rocket.chat/ui-contexts';\nimport type { Dispatch, SetStateAction } from 'react';\nimport { useCallback, useEffect, useMemo, useRef, useState } from 'react';\n\nimport { ChatMessage } from '../../../../../app/models/client';\nimport { LegacyRoomManager, RoomHistoryManager } from '../../../../../app/ui-utils/client';\nimport { withDebouncing, withThrottling } from '../../../../../lib/utils/highOrderFunctions';\nimport { useReactiveValue } from '../../../../hooks/useReactiveValue';\nimport { roomCoordinator } from '../../../../lib/rooms/roomCoordinator';\nimport { setMessageJumpQueryStringParameter } from '../../../../lib/utils/setMessageJumpQueryStringParameter';\nimport { useChat } from '../../contexts/ChatContext';\n\ninterface IUnreadMessages {\n\tcount: number;\n\tsince: Date;\n}\n\nconst useUnreadMessages = (room: IRoom): readonly [data: IUnreadMessages | undefined, setUnreadCount: Dispatch<SetStateAction<number>>] => {\n\tconst notLoadedCount = useReactiveValue(useCallback(() => RoomHistoryManager.getRoom(room._id).unreadNotLoaded.get(), [room._id]));\n\tconst [loadedCount, setLoadedCount] = useState(0);\n\n\tconst count = useMemo(() => notLoadedCount + loadedCount, [notLoadedCount, loadedCount]);\n\n\tconst since = useReactiveValue(useCallback(() => LegacyRoomManager.getOpenedRoomByRid(room._id)?.unreadSince.get(), [room._id]));\n\n\treturn useMemo(() => {\n\t\tif (count && since) {\n\t\t\treturn [{ count, since }, setLoadedCount];\n\t\t}\n\n\t\treturn [undefined, setLoadedCount];\n\t}, [count, since]);\n};\n\nexport const useHandleUnread = (\n\troom: IRoom,\n\tsubscription?: ISubscription,\n): {\n\tinnerRef: (wrapper: HTMLDivElement | null) => void;\n\twrapperRef: React.MutableRefObject<HTMLDivElement | null>;\n\thandleUnreadBarJumpToButtonClick: () => void;\n\thandleMarkAsReadButtonClick: () => void;\n\tcounter: readonly [number, Date | undefined];\n} => {\n\tconst messagesBoxRef = useRef<HTMLDivElement>(null);\n\n\tconst subscribed = Boolean(subscription);\n\tconst [unread, setUnreadCount] = useUnreadMessages(room);\n\n\tconst [lastMessageDate, setLastMessageDate] = useState<Date | undefined>();\n\n\tconst chat = useChat();\n\n\tif (!chat) {\n\t\tthrow new Error('No ChatContext provided');\n\t}\n\tconst handleUnreadBarJumpToButtonClick = useCallback(() => {\n\t\tconst rid = room._id;\n\t\tconst { firstUnread } = RoomHistoryManager.getRoom(rid);\n\t\tlet message = firstUnread?.get();\n\t\tif (!message) {\n\t\t\tmessage = ChatMessage.findOne({ rid, ts: { $gt: unread?.since } }, { sort: { ts: 1 }, limit: 1 });\n\t\t}\n\t\tif (!message) {\n\t\t\treturn;\n\t\t}\n\t\tsetMessageJumpQueryStringParameter(message?._id);\n\t\tsetUnreadCount(0);\n\t}, [room._id, unread?.since, setUnreadCount]);\n\n\tconst handleMarkAsReadButtonClick = useCallback(() => {\n\t\tchat.readStateManager.markAsRead();\n\t\tsetUnreadCount(0);\n\t}, [chat.readStateManager, setUnreadCount]);\n\n\tuseEffect(() => {\n\t\tif (!subscribed) {\n\t\t\tsetUnreadCount(0);\n\t\t\treturn;\n\t\t}\n\n\t\tconst count = ChatMessage.find({\n\t\t\trid: room._id,\n\t\t\tts: { $lte: lastMessageDate, $gt: subscription?.ls },\n\t\t}).count();\n\n\t\tsetUnreadCount(count);\n\t}, [lastMessageDate, room._id, setUnreadCount, subscribed, subscription?.ls]);\n\n\tconst router = useRouter();\n\n\tconst debouncedReadMessageRead = useMemo(\n\t\t() =>\n\t\t\twithDebouncing({ wait: 500 })(() => {\n\t\t\t\tif (subscribed) {\n\t\t\t\t\tchat.readStateManager.attemptMarkAsRead();\n\t\t\t\t}\n\t\t\t}),\n\t\t[chat.readStateManager, subscribed],\n\t);\n\n\tuseEffect(\n\t\t() =>\n\t\t\trouter.subscribeToRouteChange(() => {\n\t\t\t\tconst routeName = router.getRouteName();\n\t\t\t\tif (!routeName || !roomCoordinator.isRouteNameKnown(routeName)) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tdebouncedReadMessageRead();\n\t\t\t}),\n\t\t[debouncedReadMessageRead, room._id, router, subscribed, subscription?.alert, subscription?.unread],\n\t);\n\n\tuseEffect(() => {\n\t\tif (!unread?.count) {\n\t\t\treturn debouncedReadMessageRead();\n\t\t}\n\t}, [debouncedReadMessageRead, room._id, unread?.count]);\n\n\tconst ref = useCallback(\n\t\t(wrapper: HTMLDivElement | null) => {\n\t\t\tif (!wrapper) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconst getElementFromPoint = (topOffset = 0): Element | undefined => {\n\t\t\t\tconst messagesBox = messagesBoxRef.current;\n\n\t\t\t\tif (!messagesBox) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tconst messagesBoxLeft = messagesBox.getBoundingClientRect().left + window.pageXOffset;\n\t\t\t\tconst messagesBoxTop = messagesBox.getBoundingClientRect().top + window.pageYOffset;\n\t\t\t\tconst messagesBoxWidth = parseFloat(getComputedStyle(messagesBox).width);\n\n\t\t\t\tlet element;\n\t\t\t\tif (document.dir === 'rtl') {\n\t\t\t\t\telement = document.elementFromPoint(messagesBoxLeft + messagesBoxWidth - 2, messagesBoxTop + topOffset + 2);\n\t\t\t\t} else {\n\t\t\t\t\telement = document.elementFromPoint(messagesBoxLeft + 2, messagesBoxTop + topOffset + 2);\n\t\t\t\t}\n\n\t\t\t\tif (element?.classList.contains('rcx-message') || element?.classList.contains('rcx-message--sequential')) {\n\t\t\t\t\treturn element;\n\t\t\t\t}\n\t\t\t};\n\t\t\twrapper.addEventListener(\n\t\t\t\t'scroll',\n\t\t\t\twithThrottling({ wait: 300 })(() => {\n\t\t\t\t\tTracker.afterFlush(() => {\n\t\t\t\t\t\tconst lastInvisibleMessageOnScreen = getElementFromPoint(0) || getElementFromPoint(20) || getElementFromPoint(40);\n\n\t\t\t\t\t\tif (!lastInvisibleMessageOnScreen) {\n\t\t\t\t\t\t\tsetUnreadCount(0);\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tconst lastMessage = ChatMessage.findOne(lastInvisibleMessageOnScreen.id);\n\t\t\t\t\t\tif (!lastMessage) {\n\t\t\t\t\t\t\tsetUnreadCount(0);\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tsetLastMessageDate(lastMessage.ts);\n\t\t\t\t\t});\n\t\t\t\t}),\n\t\t\t);\n\t\t},\n\t\t[setUnreadCount],\n\t);\n\n\treturn {\n\t\tinnerRef: ref,\n\t\twrapperRef: messagesBoxRef,\n\t\thandleUnreadBarJumpToButtonClick,\n\t\thandleMarkAsReadButtonClick,\n\t\tcounter: [unread?.count ?? 0, unread?.since] as const,\n\t};\n};\n"]}}},"code":"var _slicedToArray;\nmodule.link(\"@babel/runtime/helpers/slicedToArray\", {\n  default: function (v) {\n    _slicedToArray = v;\n  }\n}, 0);\nmodule.export({\n  useHandleUnread: function () {\n    return useHandleUnread;\n  }\n});\nvar useRouter;\nmodule.link(\"@rocket.chat/ui-contexts\", {\n  useRouter: function (v) {\n    useRouter = v;\n  }\n}, 0);\nvar useCallback, useEffect, useMemo, useRef, useState;\nmodule.link(\"react\", {\n  useCallback: function (v) {\n    useCallback = v;\n  },\n  useEffect: function (v) {\n    useEffect = v;\n  },\n  useMemo: function (v) {\n    useMemo = v;\n  },\n  useRef: function (v) {\n    useRef = v;\n  },\n  useState: function (v) {\n    useState = v;\n  }\n}, 1);\nvar ChatMessage;\nmodule.link(\"../../../../../app/models/client\", {\n  ChatMessage: function (v) {\n    ChatMessage = v;\n  }\n}, 2);\nvar LegacyRoomManager, RoomHistoryManager;\nmodule.link(\"../../../../../app/ui-utils/client\", {\n  LegacyRoomManager: function (v) {\n    LegacyRoomManager = v;\n  },\n  RoomHistoryManager: function (v) {\n    RoomHistoryManager = v;\n  }\n}, 3);\nvar withDebouncing, withThrottling;\nmodule.link(\"../../../../../lib/utils/highOrderFunctions\", {\n  withDebouncing: function (v) {\n    withDebouncing = v;\n  },\n  withThrottling: function (v) {\n    withThrottling = v;\n  }\n}, 4);\nvar useReactiveValue;\nmodule.link(\"../../../../hooks/useReactiveValue\", {\n  useReactiveValue: function (v) {\n    useReactiveValue = v;\n  }\n}, 5);\nvar roomCoordinator;\nmodule.link(\"../../../../lib/rooms/roomCoordinator\", {\n  roomCoordinator: function (v) {\n    roomCoordinator = v;\n  }\n}, 6);\nvar setMessageJumpQueryStringParameter;\nmodule.link(\"../../../../lib/utils/setMessageJumpQueryStringParameter\", {\n  setMessageJumpQueryStringParameter: function (v) {\n    setMessageJumpQueryStringParameter = v;\n  }\n}, 7);\nvar useChat;\nmodule.link(\"../../contexts/ChatContext\", {\n  useChat: function (v) {\n    useChat = v;\n  }\n}, 8);\nvar useUnreadMessages = function (room) {\n  var notLoadedCount = useReactiveValue(useCallback(function () {\n    return RoomHistoryManager.getRoom(room._id).unreadNotLoaded.get();\n  }, [room._id]));\n  var _useState = useState(0),\n    _useState2 = _slicedToArray(_useState, 2),\n    loadedCount = _useState2[0],\n    setLoadedCount = _useState2[1];\n  var count = useMemo(function () {\n    return notLoadedCount + loadedCount;\n  }, [notLoadedCount, loadedCount]);\n  var since = useReactiveValue(useCallback(function () {\n    var _LegacyRoomManager$ge;\n    return (_LegacyRoomManager$ge = LegacyRoomManager.getOpenedRoomByRid(room._id)) === null || _LegacyRoomManager$ge === void 0 ? void 0 : _LegacyRoomManager$ge.unreadSince.get();\n  }, [room._id]));\n  return useMemo(function () {\n    if (count && since) {\n      return [{\n        count: count,\n        since: since\n      }, setLoadedCount];\n    }\n    return [undefined, setLoadedCount];\n  }, [count, since]);\n};\nvar useHandleUnread = function (room, subscription) {\n  var _unread$count;\n  var messagesBoxRef = useRef(null);\n  var subscribed = Boolean(subscription);\n  var _useUnreadMessages = useUnreadMessages(room),\n    _useUnreadMessages2 = _slicedToArray(_useUnreadMessages, 2),\n    unread = _useUnreadMessages2[0],\n    setUnreadCount = _useUnreadMessages2[1];\n  var _useState3 = useState(),\n    _useState4 = _slicedToArray(_useState3, 2),\n    lastMessageDate = _useState4[0],\n    setLastMessageDate = _useState4[1];\n  var chat = useChat();\n  if (!chat) {\n    throw new Error('No ChatContext provided');\n  }\n  var handleUnreadBarJumpToButtonClick = useCallback(function () {\n    var _message;\n    var rid = room._id;\n    var _RoomHistoryManager$g = RoomHistoryManager.getRoom(rid),\n      firstUnread = _RoomHistoryManager$g.firstUnread;\n    var message = firstUnread === null || firstUnread === void 0 ? void 0 : firstUnread.get();\n    if (!message) {\n      message = ChatMessage.findOne({\n        rid: rid,\n        ts: {\n          $gt: unread === null || unread === void 0 ? void 0 : unread.since\n        }\n      }, {\n        sort: {\n          ts: 1\n        },\n        limit: 1\n      });\n    }\n    if (!message) {\n      return;\n    }\n    setMessageJumpQueryStringParameter((_message = message) === null || _message === void 0 ? void 0 : _message._id);\n    setUnreadCount(0);\n  }, [room._id, unread === null || unread === void 0 ? void 0 : unread.since, setUnreadCount]);\n  var handleMarkAsReadButtonClick = useCallback(function () {\n    chat.readStateManager.markAsRead();\n    setUnreadCount(0);\n  }, [chat.readStateManager, setUnreadCount]);\n  useEffect(function () {\n    if (!subscribed) {\n      setUnreadCount(0);\n      return;\n    }\n    var count = ChatMessage.find({\n      rid: room._id,\n      ts: {\n        $lte: lastMessageDate,\n        $gt: subscription === null || subscription === void 0 ? void 0 : subscription.ls\n      }\n    }).count();\n    setUnreadCount(count);\n  }, [lastMessageDate, room._id, setUnreadCount, subscribed, subscription === null || subscription === void 0 ? void 0 : subscription.ls]);\n  var router = useRouter();\n  var debouncedReadMessageRead = useMemo(function () {\n    return withDebouncing({\n      wait: 500\n    })(function () {\n      if (subscribed) {\n        chat.readStateManager.attemptMarkAsRead();\n      }\n    });\n  }, [chat.readStateManager, subscribed]);\n  useEffect(function () {\n    return router.subscribeToRouteChange(function () {\n      var routeName = router.getRouteName();\n      if (!routeName || !roomCoordinator.isRouteNameKnown(routeName)) {\n        return;\n      }\n      debouncedReadMessageRead();\n    });\n  }, [debouncedReadMessageRead, room._id, router, subscribed, subscription === null || subscription === void 0 ? void 0 : subscription.alert, subscription === null || subscription === void 0 ? void 0 : subscription.unread]);\n  useEffect(function () {\n    if (!(unread !== null && unread !== void 0 && unread.count)) {\n      return debouncedReadMessageRead();\n    }\n  }, [debouncedReadMessageRead, room._id, unread === null || unread === void 0 ? void 0 : unread.count]);\n  var ref = useCallback(function (wrapper) {\n    if (!wrapper) {\n      return;\n    }\n    var getElementFromPoint = function () {\n      var _element, _element2;\n      var topOffset = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : 0;\n      var messagesBox = messagesBoxRef.current;\n      if (!messagesBox) {\n        return;\n      }\n      var messagesBoxLeft = messagesBox.getBoundingClientRect().left + window.pageXOffset;\n      var messagesBoxTop = messagesBox.getBoundingClientRect().top + window.pageYOffset;\n      var messagesBoxWidth = parseFloat(getComputedStyle(messagesBox).width);\n      var element;\n      if (document.dir === 'rtl') {\n        element = document.elementFromPoint(messagesBoxLeft + messagesBoxWidth - 2, messagesBoxTop + topOffset + 2);\n      } else {\n        element = document.elementFromPoint(messagesBoxLeft + 2, messagesBoxTop + topOffset + 2);\n      }\n      if ((_element = element) !== null && _element !== void 0 && _element.classList.contains('rcx-message') || (_element2 = element) !== null && _element2 !== void 0 && _element2.classList.contains('rcx-message--sequential')) {\n        return element;\n      }\n    };\n    wrapper.addEventListener('scroll', withThrottling({\n      wait: 300\n    })(function () {\n      Tracker.afterFlush(function () {\n        var lastInvisibleMessageOnScreen = getElementFromPoint(0) || getElementFromPoint(20) || getElementFromPoint(40);\n        if (!lastInvisibleMessageOnScreen) {\n          setUnreadCount(0);\n          return;\n        }\n        var lastMessage = ChatMessage.findOne(lastInvisibleMessageOnScreen.id);\n        if (!lastMessage) {\n          setUnreadCount(0);\n          return;\n        }\n        setLastMessageDate(lastMessage.ts);\n      });\n    }));\n  }, [setUnreadCount]);\n  return {\n    innerRef: ref,\n    wrapperRef: messagesBoxRef,\n    handleUnreadBarJumpToButtonClick: handleUnreadBarJumpToButtonClick,\n    handleMarkAsReadButtonClick: handleMarkAsReadButtonClick,\n    counter: [(_unread$count = unread === null || unread === void 0 ? void 0 : unread.count) !== null && _unread$count !== void 0 ? _unread$count : 0, unread === null || unread === void 0 ? void 0 : unread.since]\n  };\n};","map":{"version":3,"names":["_slicedToArray","module","link","default","v","export","useHandleUnread","useRouter","useCallback","useEffect","useMemo","useRef","useState","ChatMessage","LegacyRoomManager","RoomHistoryManager","withDebouncing","withThrottling","useReactiveValue","roomCoordinator","setMessageJumpQueryStringParameter","useChat","useUnreadMessages","room","notLoadedCount","getRoom","_id","unreadNotLoaded","get","_useState","_useState2","loadedCount","setLoadedCount","count","since","_LegacyRoomManager$ge","getOpenedRoomByRid","unreadSince","undefined","subscription","_unread$count","messagesBoxRef","subscribed","Boolean","_useUnreadMessages","_useUnreadMessages2","unread","setUnreadCount","_useState3","_useState4","lastMessageDate","setLastMessageDate","chat","Error","handleUnreadBarJumpToButtonClick","_message","rid","_RoomHistoryManager$g","firstUnread","message","findOne","ts","$gt","sort","limit","handleMarkAsReadButtonClick","readStateManager","markAsRead","find","$lte","ls","router","debouncedReadMessageRead","wait","attemptMarkAsRead","subscribeToRouteChange","routeName","getRouteName","isRouteNameKnown","alert","ref","wrapper","getElementFromPoint","_element","_element2","topOffset","arguments","length","messagesBox","current","messagesBoxLeft","getBoundingClientRect","left","window","pageXOffset","messagesBoxTop","top","pageYOffset","messagesBoxWidth","parseFloat","getComputedStyle","width","element","document","dir","elementFromPoint","classList","contains","addEventListener","Tracker","afterFlush","lastInvisibleMessageOnScreen","lastMessage","id","innerRef","wrapperRef","counter"],"sources":["client/views/room/body/hooks/useUnreadMessages.ts"],"sourcesContent":["import type { IRoom, ISubscription } from '@rocket.chat/core-typings';\nimport { useRouter } from '@rocket.chat/ui-contexts';\nimport type { Dispatch, SetStateAction } from 'react';\nimport { useCallback, useEffect, useMemo, useRef, useState } from 'react';\n\nimport { ChatMessage } from '../../../../../app/models/client';\nimport { LegacyRoomManager, RoomHistoryManager } from '../../../../../app/ui-utils/client';\nimport { withDebouncing, withThrottling } from '../../../../../lib/utils/highOrderFunctions';\nimport { useReactiveValue } from '../../../../hooks/useReactiveValue';\nimport { roomCoordinator } from '../../../../lib/rooms/roomCoordinator';\nimport { setMessageJumpQueryStringParameter } from '../../../../lib/utils/setMessageJumpQueryStringParameter';\nimport { useChat } from '../../contexts/ChatContext';\n\ninterface IUnreadMessages {\n\tcount: number;\n\tsince: Date;\n}\n\nconst useUnreadMessages = (room: IRoom): readonly [data: IUnreadMessages | undefined, setUnreadCount: Dispatch<SetStateAction<number>>] => {\n\tconst notLoadedCount = useReactiveValue(useCallback(() => RoomHistoryManager.getRoom(room._id).unreadNotLoaded.get(), [room._id]));\n\tconst [loadedCount, setLoadedCount] = useState(0);\n\n\tconst count = useMemo(() => notLoadedCount + loadedCount, [notLoadedCount, loadedCount]);\n\n\tconst since = useReactiveValue(useCallback(() => LegacyRoomManager.getOpenedRoomByRid(room._id)?.unreadSince.get(), [room._id]));\n\n\treturn useMemo(() => {\n\t\tif (count && since) {\n\t\t\treturn [{ count, since }, setLoadedCount];\n\t\t}\n\n\t\treturn [undefined, setLoadedCount];\n\t}, [count, since]);\n};\n\nexport const useHandleUnread = (\n\troom: IRoom,\n\tsubscription?: ISubscription,\n): {\n\tinnerRef: (wrapper: HTMLDivElement | null) => void;\n\twrapperRef: React.MutableRefObject<HTMLDivElement | null>;\n\thandleUnreadBarJumpToButtonClick: () => void;\n\thandleMarkAsReadButtonClick: () => void;\n\tcounter: readonly [number, Date | undefined];\n} => {\n\tconst messagesBoxRef = useRef<HTMLDivElement>(null);\n\n\tconst subscribed = Boolean(subscription);\n\tconst [unread, setUnreadCount] = useUnreadMessages(room);\n\n\tconst [lastMessageDate, setLastMessageDate] = useState<Date | undefined>();\n\n\tconst chat = useChat();\n\n\tif (!chat) {\n\t\tthrow new Error('No ChatContext provided');\n\t}\n\tconst handleUnreadBarJumpToButtonClick = useCallback(() => {\n\t\tconst rid = room._id;\n\t\tconst { firstUnread } = RoomHistoryManager.getRoom(rid);\n\t\tlet message = firstUnread?.get();\n\t\tif (!message) {\n\t\t\tmessage = ChatMessage.findOne({ rid, ts: { $gt: unread?.since } }, { sort: { ts: 1 }, limit: 1 });\n\t\t}\n\t\tif (!message) {\n\t\t\treturn;\n\t\t}\n\t\tsetMessageJumpQueryStringParameter(message?._id);\n\t\tsetUnreadCount(0);\n\t}, [room._id, unread?.since, setUnreadCount]);\n\n\tconst handleMarkAsReadButtonClick = useCallback(() => {\n\t\tchat.readStateManager.markAsRead();\n\t\tsetUnreadCount(0);\n\t}, [chat.readStateManager, setUnreadCount]);\n\n\tuseEffect(() => {\n\t\tif (!subscribed) {\n\t\t\tsetUnreadCount(0);\n\t\t\treturn;\n\t\t}\n\n\t\tconst count = ChatMessage.find({\n\t\t\trid: room._id,\n\t\t\tts: { $lte: lastMessageDate, $gt: subscription?.ls },\n\t\t}).count();\n\n\t\tsetUnreadCount(count);\n\t}, [lastMessageDate, room._id, setUnreadCount, subscribed, subscription?.ls]);\n\n\tconst router = useRouter();\n\n\tconst debouncedReadMessageRead = useMemo(\n\t\t() =>\n\t\t\twithDebouncing({ wait: 500 })(() => {\n\t\t\t\tif (subscribed) {\n\t\t\t\t\tchat.readStateManager.attemptMarkAsRead();\n\t\t\t\t}\n\t\t\t}),\n\t\t[chat.readStateManager, subscribed],\n\t);\n\n\tuseEffect(\n\t\t() =>\n\t\t\trouter.subscribeToRouteChange(() => {\n\t\t\t\tconst routeName = router.getRouteName();\n\t\t\t\tif (!routeName || !roomCoordinator.isRouteNameKnown(routeName)) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tdebouncedReadMessageRead();\n\t\t\t}),\n\t\t[debouncedReadMessageRead, room._id, router, subscribed, subscription?.alert, subscription?.unread],\n\t);\n\n\tuseEffect(() => {\n\t\tif (!unread?.count) {\n\t\t\treturn debouncedReadMessageRead();\n\t\t}\n\t}, [debouncedReadMessageRead, room._id, unread?.count]);\n\n\tconst ref = useCallback(\n\t\t(wrapper: HTMLDivElement | null) => {\n\t\t\tif (!wrapper) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconst getElementFromPoint = (topOffset = 0): Element | undefined => {\n\t\t\t\tconst messagesBox = messagesBoxRef.current;\n\n\t\t\t\tif (!messagesBox) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tconst messagesBoxLeft = messagesBox.getBoundingClientRect().left + window.pageXOffset;\n\t\t\t\tconst messagesBoxTop = messagesBox.getBoundingClientRect().top + window.pageYOffset;\n\t\t\t\tconst messagesBoxWidth = parseFloat(getComputedStyle(messagesBox).width);\n\n\t\t\t\tlet element;\n\t\t\t\tif (document.dir === 'rtl') {\n\t\t\t\t\telement = document.elementFromPoint(messagesBoxLeft + messagesBoxWidth - 2, messagesBoxTop + topOffset + 2);\n\t\t\t\t} else {\n\t\t\t\t\telement = document.elementFromPoint(messagesBoxLeft + 2, messagesBoxTop + topOffset + 2);\n\t\t\t\t}\n\n\t\t\t\tif (element?.classList.contains('rcx-message') || element?.classList.contains('rcx-message--sequential')) {\n\t\t\t\t\treturn element;\n\t\t\t\t}\n\t\t\t};\n\t\t\twrapper.addEventListener(\n\t\t\t\t'scroll',\n\t\t\t\twithThrottling({ wait: 300 })(() => {\n\t\t\t\t\tTracker.afterFlush(() => {\n\t\t\t\t\t\tconst lastInvisibleMessageOnScreen = getElementFromPoint(0) || getElementFromPoint(20) || getElementFromPoint(40);\n\n\t\t\t\t\t\tif (!lastInvisibleMessageOnScreen) {\n\t\t\t\t\t\t\tsetUnreadCount(0);\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tconst lastMessage = ChatMessage.findOne(lastInvisibleMessageOnScreen.id);\n\t\t\t\t\t\tif (!lastMessage) {\n\t\t\t\t\t\t\tsetUnreadCount(0);\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tsetLastMessageDate(lastMessage.ts);\n\t\t\t\t\t});\n\t\t\t\t}),\n\t\t\t);\n\t\t},\n\t\t[setUnreadCount],\n\t);\n\n\treturn {\n\t\tinnerRef: ref,\n\t\twrapperRef: messagesBoxRef,\n\t\thandleUnreadBarJumpToButtonClick,\n\t\thandleMarkAsReadButtonClick,\n\t\tcounter: [unread?.count ?? 0, unread?.since] as const,\n\t};\n};\n"],"mappings":"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","ignoreList":[]},"sourceType":"module","externalDependencies":{},"hash":"8cef8f61eac90aa38454f5345398579bdf89d9f6"}
