{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/app/lib/server/methods/sendMessage.ts","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","topLevelAwait","objectRestSpread","objectRestSpread","asyncGenerators","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"os.osx.arm64"},"sourceFileName":"app/lib/server/methods/sendMessage.ts","filename":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/app/lib/server/methods/sendMessage.ts","inputSourceMap":{"version":3,"file":"app/lib/server/methods/sendMessage.ts","sourceRoot":"","sources":["app/lib/server/methods/sendMessage.ts"],"names":[],"mappings":"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","sourcesContent":["import { api } from '@rocket.chat/core-services';\nimport type { AtLeast, IMessage, IUser } from '@rocket.chat/core-typings';\nimport type { ServerMethods } from '@rocket.chat/ddp-client';\nimport type { RocketchatI18nKeys } from '@rocket.chat/i18n';\nimport { Messages, Users } from '@rocket.chat/models';\nimport type { TOptions } from 'i18next';\nimport { check } from 'meteor/check';\nimport { Meteor } from 'meteor/meteor';\nimport moment from 'moment';\n\nimport { i18n } from '../../../../server/lib/i18n';\nimport { SystemLogger } from '../../../../server/lib/logger/system';\nimport { canSendMessageAsync } from '../../../authorization/server/functions/canSendMessage';\nimport { hasPermissionAsync } from '../../../authorization/server/functions/hasPermission';\nimport { applyAirGappedRestrictionsValidation } from '../../../license/server/airGappedRestrictionsWrapper';\nimport { metrics } from '../../../metrics/server';\nimport { settings } from '../../../settings/server';\nimport { MessageTypes } from '../../../ui-utils/server';\nimport { sendMessage } from '../functions/sendMessage';\nimport { RateLimiter } from '../lib';\n\nexport async function executeSendMessage(uid: IUser['_id'], message: AtLeast<IMessage, 'rid'>, previewUrls?: string[]) {\n\tif (message.tshow && !message.tmid) {\n\t\tthrow new Meteor.Error('invalid-params', 'tshow provided but missing tmid', {\n\t\t\tmethod: 'sendMessage',\n\t\t});\n\t}\n\n\tif (message.tmid && !settings.get('Threads_enabled')) {\n\t\tthrow new Meteor.Error('error-not-allowed', 'not-allowed', {\n\t\t\tmethod: 'sendMessage',\n\t\t});\n\t}\n\n\tif (message.ts) {\n\t\tconst tsDiff = Math.abs(moment(message.ts).diff(Date.now()));\n\t\tif (tsDiff > 60000) {\n\t\t\tthrow new Meteor.Error('error-message-ts-out-of-sync', 'Message timestamp is out of sync', {\n\t\t\t\tmethod: 'sendMessage',\n\t\t\t\tmessage_ts: message.ts,\n\t\t\t\tserver_ts: new Date().getTime(),\n\t\t\t});\n\t\t} else if (tsDiff > 10000) {\n\t\t\tmessage.ts = new Date();\n\t\t}\n\t} else {\n\t\tmessage.ts = new Date();\n\t}\n\n\tif (message.msg) {\n\t\tif (message.msg.length > (settings.get<number>('Message_MaxAllowedSize') ?? 0)) {\n\t\t\tthrow new Meteor.Error('error-message-size-exceeded', 'Message size exceeds Message_MaxAllowedSize', {\n\t\t\t\tmethod: 'sendMessage',\n\t\t\t});\n\t\t}\n\t}\n\n\tconst user = await Users.findOneById(uid, {\n\t\tprojection: {\n\t\t\tusername: 1,\n\t\t\ttype: 1,\n\t\t\tname: 1,\n\t\t},\n\t});\n\tif (!user?.username) {\n\t\tthrow new Meteor.Error('error-invalid-user', 'Invalid user');\n\t}\n\n\tlet { rid } = message;\n\n\t// do not allow nested threads\n\tif (message.tmid) {\n\t\tconst parentMessage = await Messages.findOneById(message.tmid, { projection: { rid: 1, tmid: 1 } });\n\t\tmessage.tmid = parentMessage?.tmid || message.tmid;\n\n\t\tif (parentMessage?.rid) {\n\t\t\trid = parentMessage?.rid;\n\t\t}\n\t}\n\n\tif (!rid) {\n\t\tthrow new Error(\"The 'rid' property on the message object is missing.\");\n\t}\n\n\tcheck(rid, String);\n\n\ttry {\n\t\tconst room = await canSendMessageAsync(rid, { uid, username: user.username, type: user.type });\n\n\t\tif (room.encrypted && settings.get<boolean>('E2E_Enable') && !settings.get<boolean>('E2E_Allow_Unencrypted_Messages')) {\n\t\t\tif (message.t !== 'e2e') {\n\t\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed to send un-encrypted messages in an encrypted room', {\n\t\t\t\t\tmethod: 'sendMessage',\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\n\t\tmetrics.messagesSent.inc(); // TODO This line needs to be moved to it's proper place. See the comments on: https://github.com/RocketChat/Rocket.Chat/pull/5736\n\t\treturn await sendMessage(user, message, room, false, previewUrls);\n\t} catch (err: any) {\n\t\tSystemLogger.error({ msg: 'Error sending message:', err });\n\n\t\tconst errorMessage: RocketchatI18nKeys = typeof err === 'string' ? err : err.error || err.message;\n\t\tconst errorContext: TOptions = err.details ?? {};\n\t\tvoid api.broadcast('notify.ephemeralMessage', uid, message.rid, {\n\t\t\tmsg: i18n.t(errorMessage, { ...errorContext, lng: user.language }),\n\t\t});\n\n\t\tif (typeof err === 'string') {\n\t\t\tthrow new Error(err);\n\t\t}\n\n\t\tthrow err;\n\t}\n}\n\ndeclare module '@rocket.chat/ddp-client' {\n\t// eslint-disable-next-line @typescript-eslint/naming-convention\n\tinterface ServerMethods {\n\t\tsendMessage(message: AtLeast<IMessage, '_id' | 'rid' | 'msg'>, previewUrls?: string[]): any;\n\t}\n}\n\nMeteor.methods<ServerMethods>({\n\tasync sendMessage(message, previewUrls) {\n\t\tcheck(message, Object);\n\n\t\tconst uid = Meteor.userId();\n\t\tif (!uid) {\n\t\t\tthrow new Meteor.Error('error-invalid-user', 'Invalid user', {\n\t\t\t\tmethod: 'sendMessage',\n\t\t\t});\n\t\t}\n\n\t\tif (MessageTypes.isSystemMessage(message)) {\n\t\t\tthrow new Error(\"Cannot send system messages using 'sendMessage'\");\n\t\t}\n\n\t\ttry {\n\t\t\treturn await applyAirGappedRestrictionsValidation(() => executeSendMessage(uid, message, previewUrls));\n\t\t} catch (error: any) {\n\t\t\tif (['error-not-allowed', 'restricted-workspace'].includes(error.error || error.message)) {\n\t\t\t\tthrow new Meteor.Error(error.error || error.message, error.reason, {\n\t\t\t\t\tmethod: 'sendMessage',\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\t},\n});\n// Limit a user, who does not have the \"bot\" role, to sending 5 msgs/second\nRateLimiter.limitMethod('sendMessage', 5, 1000, {\n\tasync userId(userId: IUser['_id']) {\n\t\treturn !(await hasPermissionAsync(userId, 'send-many-messages'));\n\t},\n});\n"]},"targets":{"android":"125.0.0","chrome":"125.0.0","edge":"125.0.0","firefox":"115.0.0","ie":"10.0.0","ios":"17.4.0","opera":"110.0.0","opera_mobile":"80.0.0","safari":"17.4.0","samsung":"24.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor","root":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":false,"enforceStrictMode":false,"dynamicImport":true,"generateLetDeclarations":true,"topLevelAwait":true},"externalDependencies":[]},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"version":"7.17.2","helpers":true,"useESModules":false,"corejs":false},"externalDependencies":[]},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-async-generator-functions","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-class-properties","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true},"externalDependencies":[]},{"key":"transform-react-jsx","visitor":{"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXFragment":{"exit":[null]},"JSXElement":{"exit":[null]},"JSXAttribute":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false},"externalDependencies":[]},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-nullish-coalescing-operator","visitor":{"LogicalExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-optional-chaining","visitor":{"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-optional-catch-binding","visitor":{"CatchClause":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-class-properties","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-async-generator-functions","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-logical-assignment-operators","visitor":{"AssignmentExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]}],"presets":[],"generatorOpts":{"filename":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/app/lib/server/methods/sendMessage.ts","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"app/lib/server/methods/sendMessage.ts","inputSourceMap":{"version":3,"file":"app/lib/server/methods/sendMessage.ts","sourceRoot":"","sources":["app/lib/server/methods/sendMessage.ts"],"names":[],"mappings":"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","sourcesContent":["import { api } from '@rocket.chat/core-services';\nimport type { AtLeast, IMessage, IUser } from '@rocket.chat/core-typings';\nimport type { ServerMethods } from '@rocket.chat/ddp-client';\nimport type { RocketchatI18nKeys } from '@rocket.chat/i18n';\nimport { Messages, Users } from '@rocket.chat/models';\nimport type { TOptions } from 'i18next';\nimport { check } from 'meteor/check';\nimport { Meteor } from 'meteor/meteor';\nimport moment from 'moment';\n\nimport { i18n } from '../../../../server/lib/i18n';\nimport { SystemLogger } from '../../../../server/lib/logger/system';\nimport { canSendMessageAsync } from '../../../authorization/server/functions/canSendMessage';\nimport { hasPermissionAsync } from '../../../authorization/server/functions/hasPermission';\nimport { applyAirGappedRestrictionsValidation } from '../../../license/server/airGappedRestrictionsWrapper';\nimport { metrics } from '../../../metrics/server';\nimport { settings } from '../../../settings/server';\nimport { MessageTypes } from '../../../ui-utils/server';\nimport { sendMessage } from '../functions/sendMessage';\nimport { RateLimiter } from '../lib';\n\nexport async function executeSendMessage(uid: IUser['_id'], message: AtLeast<IMessage, 'rid'>, previewUrls?: string[]) {\n\tif (message.tshow && !message.tmid) {\n\t\tthrow new Meteor.Error('invalid-params', 'tshow provided but missing tmid', {\n\t\t\tmethod: 'sendMessage',\n\t\t});\n\t}\n\n\tif (message.tmid && !settings.get('Threads_enabled')) {\n\t\tthrow new Meteor.Error('error-not-allowed', 'not-allowed', {\n\t\t\tmethod: 'sendMessage',\n\t\t});\n\t}\n\n\tif (message.ts) {\n\t\tconst tsDiff = Math.abs(moment(message.ts).diff(Date.now()));\n\t\tif (tsDiff > 60000) {\n\t\t\tthrow new Meteor.Error('error-message-ts-out-of-sync', 'Message timestamp is out of sync', {\n\t\t\t\tmethod: 'sendMessage',\n\t\t\t\tmessage_ts: message.ts,\n\t\t\t\tserver_ts: new Date().getTime(),\n\t\t\t});\n\t\t} else if (tsDiff > 10000) {\n\t\t\tmessage.ts = new Date();\n\t\t}\n\t} else {\n\t\tmessage.ts = new Date();\n\t}\n\n\tif (message.msg) {\n\t\tif (message.msg.length > (settings.get<number>('Message_MaxAllowedSize') ?? 0)) {\n\t\t\tthrow new Meteor.Error('error-message-size-exceeded', 'Message size exceeds Message_MaxAllowedSize', {\n\t\t\t\tmethod: 'sendMessage',\n\t\t\t});\n\t\t}\n\t}\n\n\tconst user = await Users.findOneById(uid, {\n\t\tprojection: {\n\t\t\tusername: 1,\n\t\t\ttype: 1,\n\t\t\tname: 1,\n\t\t},\n\t});\n\tif (!user?.username) {\n\t\tthrow new Meteor.Error('error-invalid-user', 'Invalid user');\n\t}\n\n\tlet { rid } = message;\n\n\t// do not allow nested threads\n\tif (message.tmid) {\n\t\tconst parentMessage = await Messages.findOneById(message.tmid, { projection: { rid: 1, tmid: 1 } });\n\t\tmessage.tmid = parentMessage?.tmid || message.tmid;\n\n\t\tif (parentMessage?.rid) {\n\t\t\trid = parentMessage?.rid;\n\t\t}\n\t}\n\n\tif (!rid) {\n\t\tthrow new Error(\"The 'rid' property on the message object is missing.\");\n\t}\n\n\tcheck(rid, String);\n\n\ttry {\n\t\tconst room = await canSendMessageAsync(rid, { uid, username: user.username, type: user.type });\n\n\t\tif (room.encrypted && settings.get<boolean>('E2E_Enable') && !settings.get<boolean>('E2E_Allow_Unencrypted_Messages')) {\n\t\t\tif (message.t !== 'e2e') {\n\t\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed to send un-encrypted messages in an encrypted room', {\n\t\t\t\t\tmethod: 'sendMessage',\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\n\t\tmetrics.messagesSent.inc(); // TODO This line needs to be moved to it's proper place. See the comments on: https://github.com/RocketChat/Rocket.Chat/pull/5736\n\t\treturn await sendMessage(user, message, room, false, previewUrls);\n\t} catch (err: any) {\n\t\tSystemLogger.error({ msg: 'Error sending message:', err });\n\n\t\tconst errorMessage: RocketchatI18nKeys = typeof err === 'string' ? err : err.error || err.message;\n\t\tconst errorContext: TOptions = err.details ?? {};\n\t\tvoid api.broadcast('notify.ephemeralMessage', uid, message.rid, {\n\t\t\tmsg: i18n.t(errorMessage, { ...errorContext, lng: user.language }),\n\t\t});\n\n\t\tif (typeof err === 'string') {\n\t\t\tthrow new Error(err);\n\t\t}\n\n\t\tthrow err;\n\t}\n}\n\ndeclare module '@rocket.chat/ddp-client' {\n\t// eslint-disable-next-line @typescript-eslint/naming-convention\n\tinterface ServerMethods {\n\t\tsendMessage(message: AtLeast<IMessage, '_id' | 'rid' | 'msg'>, previewUrls?: string[]): any;\n\t}\n}\n\nMeteor.methods<ServerMethods>({\n\tasync sendMessage(message, previewUrls) {\n\t\tcheck(message, Object);\n\n\t\tconst uid = Meteor.userId();\n\t\tif (!uid) {\n\t\t\tthrow new Meteor.Error('error-invalid-user', 'Invalid user', {\n\t\t\t\tmethod: 'sendMessage',\n\t\t\t});\n\t\t}\n\n\t\tif (MessageTypes.isSystemMessage(message)) {\n\t\t\tthrow new Error(\"Cannot send system messages using 'sendMessage'\");\n\t\t}\n\n\t\ttry {\n\t\t\treturn await applyAirGappedRestrictionsValidation(() => executeSendMessage(uid, message, previewUrls));\n\t\t} catch (error: any) {\n\t\t\tif (['error-not-allowed', 'restricted-workspace'].includes(error.error || error.message)) {\n\t\t\t\tthrow new Meteor.Error(error.error || error.message, error.reason, {\n\t\t\t\t\tmethod: 'sendMessage',\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\t},\n});\n// Limit a user, who does not have the \"bot\" role, to sending 5 msgs/second\nRateLimiter.limitMethod('sendMessage', 5, 1000, {\n\tasync userId(userId: IUser['_id']) {\n\t\treturn !(await hasPermissionAsync(userId, 'send-many-messages'));\n\t},\n});\n"]}}},"code":"!module.wrapAsync(async function (module, __reifyWaitForDeps__, __reify_async_result__) {\n  \"use strict\";\n  try {\n    let _objectSpread;\n    module.link(\"@babel/runtime/helpers/objectSpread2\", {\n      default(v) {\n        _objectSpread = v;\n      }\n    }, 0);\n    module.export({\n      executeSendMessage: () => executeSendMessage\n    });\n    let api;\n    module.link(\"@rocket.chat/core-services\", {\n      api(v) {\n        api = v;\n      }\n    }, 0);\n    let Messages, Users;\n    module.link(\"@rocket.chat/models\", {\n      Messages(v) {\n        Messages = v;\n      },\n      Users(v) {\n        Users = v;\n      }\n    }, 1);\n    let check;\n    module.link(\"meteor/check\", {\n      check(v) {\n        check = v;\n      }\n    }, 2);\n    let Meteor;\n    module.link(\"meteor/meteor\", {\n      Meteor(v) {\n        Meteor = v;\n      }\n    }, 3);\n    let moment;\n    module.link(\"moment\", {\n      default(v) {\n        moment = v;\n      }\n    }, 4);\n    let i18n;\n    module.link(\"../../../../server/lib/i18n\", {\n      i18n(v) {\n        i18n = v;\n      }\n    }, 5);\n    let SystemLogger;\n    module.link(\"../../../../server/lib/logger/system\", {\n      SystemLogger(v) {\n        SystemLogger = v;\n      }\n    }, 6);\n    let canSendMessageAsync;\n    module.link(\"../../../authorization/server/functions/canSendMessage\", {\n      canSendMessageAsync(v) {\n        canSendMessageAsync = v;\n      }\n    }, 7);\n    let hasPermissionAsync;\n    module.link(\"../../../authorization/server/functions/hasPermission\", {\n      hasPermissionAsync(v) {\n        hasPermissionAsync = v;\n      }\n    }, 8);\n    let applyAirGappedRestrictionsValidation;\n    module.link(\"../../../license/server/airGappedRestrictionsWrapper\", {\n      applyAirGappedRestrictionsValidation(v) {\n        applyAirGappedRestrictionsValidation = v;\n      }\n    }, 9);\n    let metrics;\n    module.link(\"../../../metrics/server\", {\n      metrics(v) {\n        metrics = v;\n      }\n    }, 10);\n    let settings;\n    module.link(\"../../../settings/server\", {\n      settings(v) {\n        settings = v;\n      }\n    }, 11);\n    let MessageTypes;\n    module.link(\"../../../ui-utils/server\", {\n      MessageTypes(v) {\n        MessageTypes = v;\n      }\n    }, 12);\n    let sendMessage;\n    module.link(\"../functions/sendMessage\", {\n      sendMessage(v) {\n        sendMessage = v;\n      }\n    }, 13);\n    let RateLimiter;\n    module.link(\"../lib\", {\n      RateLimiter(v) {\n        RateLimiter = v;\n      }\n    }, 14);\n    if (__reifyWaitForDeps__()) (await __reifyWaitForDeps__())();\n    async function executeSendMessage(uid, message, previewUrls) {\n      if (message.tshow && !message.tmid) {\n        throw new Meteor.Error('invalid-params', 'tshow provided but missing tmid', {\n          method: 'sendMessage'\n        });\n      }\n      if (message.tmid && !settings.get('Threads_enabled')) {\n        throw new Meteor.Error('error-not-allowed', 'not-allowed', {\n          method: 'sendMessage'\n        });\n      }\n      if (message.ts) {\n        const tsDiff = Math.abs(moment(message.ts).diff(Date.now()));\n        if (tsDiff > 60000) {\n          throw new Meteor.Error('error-message-ts-out-of-sync', 'Message timestamp is out of sync', {\n            method: 'sendMessage',\n            message_ts: message.ts,\n            server_ts: new Date().getTime()\n          });\n        } else if (tsDiff > 10000) {\n          message.ts = new Date();\n        }\n      } else {\n        message.ts = new Date();\n      }\n      if (message.msg) {\n        var _settings$get;\n        if (message.msg.length > ((_settings$get = settings.get('Message_MaxAllowedSize')) !== null && _settings$get !== void 0 ? _settings$get : 0)) {\n          throw new Meteor.Error('error-message-size-exceeded', 'Message size exceeds Message_MaxAllowedSize', {\n            method: 'sendMessage'\n          });\n        }\n      }\n      const user = await Users.findOneById(uid, {\n        projection: {\n          username: 1,\n          type: 1,\n          name: 1\n        }\n      });\n      if (!(user !== null && user !== void 0 && user.username)) {\n        throw new Meteor.Error('error-invalid-user', 'Invalid user');\n      }\n      let {\n        rid\n      } = message;\n      // do not allow nested threads\n      if (message.tmid) {\n        const parentMessage = await Messages.findOneById(message.tmid, {\n          projection: {\n            rid: 1,\n            tmid: 1\n          }\n        });\n        message.tmid = (parentMessage === null || parentMessage === void 0 ? void 0 : parentMessage.tmid) || message.tmid;\n        if (parentMessage !== null && parentMessage !== void 0 && parentMessage.rid) {\n          rid = parentMessage === null || parentMessage === void 0 ? void 0 : parentMessage.rid;\n        }\n      }\n      if (!rid) {\n        throw new Error(\"The 'rid' property on the message object is missing.\");\n      }\n      check(rid, String);\n      try {\n        const room = await canSendMessageAsync(rid, {\n          uid,\n          username: user.username,\n          type: user.type\n        });\n        if (room.encrypted && settings.get('E2E_Enable') && !settings.get('E2E_Allow_Unencrypted_Messages')) {\n          if (message.t !== 'e2e') {\n            throw new Meteor.Error('error-not-allowed', 'Not allowed to send un-encrypted messages in an encrypted room', {\n              method: 'sendMessage'\n            });\n          }\n        }\n        metrics.messagesSent.inc(); // TODO This line needs to be moved to it's proper place. See the comments on: https://github.com/RocketChat/Rocket.Chat/pull/5736\n        return await sendMessage(user, message, room, false, previewUrls);\n      } catch (err) {\n        var _err$details;\n        SystemLogger.error({\n          msg: 'Error sending message:',\n          err\n        });\n        const errorMessage = typeof err === 'string' ? err : err.error || err.message;\n        const errorContext = (_err$details = err.details) !== null && _err$details !== void 0 ? _err$details : {};\n        void api.broadcast('notify.ephemeralMessage', uid, message.rid, {\n          msg: i18n.t(errorMessage, _objectSpread(_objectSpread({}, errorContext), {}, {\n            lng: user.language\n          }))\n        });\n        if (typeof err === 'string') {\n          throw new Error(err);\n        }\n        throw err;\n      }\n    }\n    Meteor.methods({\n      async sendMessage(message, previewUrls) {\n        check(message, Object);\n        const uid = Meteor.userId();\n        if (!uid) {\n          throw new Meteor.Error('error-invalid-user', 'Invalid user', {\n            method: 'sendMessage'\n          });\n        }\n        if (MessageTypes.isSystemMessage(message)) {\n          throw new Error(\"Cannot send system messages using 'sendMessage'\");\n        }\n        try {\n          return await applyAirGappedRestrictionsValidation(() => executeSendMessage(uid, message, previewUrls));\n        } catch (error) {\n          if (['error-not-allowed', 'restricted-workspace'].includes(error.error || error.message)) {\n            throw new Meteor.Error(error.error || error.message, error.reason, {\n              method: 'sendMessage'\n            });\n          }\n        }\n      }\n    });\n    // Limit a user, who does not have the \"bot\" role, to sending 5 msgs/second\n    RateLimiter.limitMethod('sendMessage', 5, 1000, {\n      async userId(userId) {\n        return !(await hasPermissionAsync(userId, 'send-many-messages'));\n      }\n    });\n    __reify_async_result__();\n  } catch (_reifyError) {\n    return __reify_async_result__(_reifyError);\n  }\n  __reify_async_result__()\n}, {\n  self: this,\n  async: false\n});","map":{"version":3,"names":["_objectSpread","module","link","default","v","export","executeSendMessage","api","Messages","Users","check","Meteor","moment","i18n","SystemLogger","canSendMessageAsync","hasPermissionAsync","applyAirGappedRestrictionsValidation","metrics","settings","MessageTypes","sendMessage","RateLimiter","__reifyWaitForDeps__","uid","message","previewUrls","tshow","tmid","Error","method","get","ts","tsDiff","Math","abs","diff","Date","now","message_ts","server_ts","getTime","msg","_settings$get","length","user","findOneById","projection","username","type","name","rid","parentMessage","String","room","encrypted","t","messagesSent","inc","err","_err$details","error","errorMessage","errorContext","details","broadcast","lng","language","methods","Object","userId","isSystemMessage","includes","reason","limitMethod","__reify_async_result__","_reifyError","self","async"],"sources":["app/lib/server/methods/sendMessage.ts"],"sourcesContent":["import { api } from '@rocket.chat/core-services';\nimport type { AtLeast, IMessage, IUser } from '@rocket.chat/core-typings';\nimport type { ServerMethods } from '@rocket.chat/ddp-client';\nimport type { RocketchatI18nKeys } from '@rocket.chat/i18n';\nimport { Messages, Users } from '@rocket.chat/models';\nimport type { TOptions } from 'i18next';\nimport { check } from 'meteor/check';\nimport { Meteor } from 'meteor/meteor';\nimport moment from 'moment';\n\nimport { i18n } from '../../../../server/lib/i18n';\nimport { SystemLogger } from '../../../../server/lib/logger/system';\nimport { canSendMessageAsync } from '../../../authorization/server/functions/canSendMessage';\nimport { hasPermissionAsync } from '../../../authorization/server/functions/hasPermission';\nimport { applyAirGappedRestrictionsValidation } from '../../../license/server/airGappedRestrictionsWrapper';\nimport { metrics } from '../../../metrics/server';\nimport { settings } from '../../../settings/server';\nimport { MessageTypes } from '../../../ui-utils/server';\nimport { sendMessage } from '../functions/sendMessage';\nimport { RateLimiter } from '../lib';\n\nexport async function executeSendMessage(uid: IUser['_id'], message: AtLeast<IMessage, 'rid'>, previewUrls?: string[]) {\n\tif (message.tshow && !message.tmid) {\n\t\tthrow new Meteor.Error('invalid-params', 'tshow provided but missing tmid', {\n\t\t\tmethod: 'sendMessage',\n\t\t});\n\t}\n\n\tif (message.tmid && !settings.get('Threads_enabled')) {\n\t\tthrow new Meteor.Error('error-not-allowed', 'not-allowed', {\n\t\t\tmethod: 'sendMessage',\n\t\t});\n\t}\n\n\tif (message.ts) {\n\t\tconst tsDiff = Math.abs(moment(message.ts).diff(Date.now()));\n\t\tif (tsDiff > 60000) {\n\t\t\tthrow new Meteor.Error('error-message-ts-out-of-sync', 'Message timestamp is out of sync', {\n\t\t\t\tmethod: 'sendMessage',\n\t\t\t\tmessage_ts: message.ts,\n\t\t\t\tserver_ts: new Date().getTime(),\n\t\t\t});\n\t\t} else if (tsDiff > 10000) {\n\t\t\tmessage.ts = new Date();\n\t\t}\n\t} else {\n\t\tmessage.ts = new Date();\n\t}\n\n\tif (message.msg) {\n\t\tif (message.msg.length > (settings.get<number>('Message_MaxAllowedSize') ?? 0)) {\n\t\t\tthrow new Meteor.Error('error-message-size-exceeded', 'Message size exceeds Message_MaxAllowedSize', {\n\t\t\t\tmethod: 'sendMessage',\n\t\t\t});\n\t\t}\n\t}\n\n\tconst user = await Users.findOneById(uid, {\n\t\tprojection: {\n\t\t\tusername: 1,\n\t\t\ttype: 1,\n\t\t\tname: 1,\n\t\t},\n\t});\n\tif (!user?.username) {\n\t\tthrow new Meteor.Error('error-invalid-user', 'Invalid user');\n\t}\n\n\tlet { rid } = message;\n\n\t// do not allow nested threads\n\tif (message.tmid) {\n\t\tconst parentMessage = await Messages.findOneById(message.tmid, { projection: { rid: 1, tmid: 1 } });\n\t\tmessage.tmid = parentMessage?.tmid || message.tmid;\n\n\t\tif (parentMessage?.rid) {\n\t\t\trid = parentMessage?.rid;\n\t\t}\n\t}\n\n\tif (!rid) {\n\t\tthrow new Error(\"The 'rid' property on the message object is missing.\");\n\t}\n\n\tcheck(rid, String);\n\n\ttry {\n\t\tconst room = await canSendMessageAsync(rid, { uid, username: user.username, type: user.type });\n\n\t\tif (room.encrypted && settings.get<boolean>('E2E_Enable') && !settings.get<boolean>('E2E_Allow_Unencrypted_Messages')) {\n\t\t\tif (message.t !== 'e2e') {\n\t\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed to send un-encrypted messages in an encrypted room', {\n\t\t\t\t\tmethod: 'sendMessage',\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\n\t\tmetrics.messagesSent.inc(); // TODO This line needs to be moved to it's proper place. See the comments on: https://github.com/RocketChat/Rocket.Chat/pull/5736\n\t\treturn await sendMessage(user, message, room, false, previewUrls);\n\t} catch (err: any) {\n\t\tSystemLogger.error({ msg: 'Error sending message:', err });\n\n\t\tconst errorMessage: RocketchatI18nKeys = typeof err === 'string' ? err : err.error || err.message;\n\t\tconst errorContext: TOptions = err.details ?? {};\n\t\tvoid api.broadcast('notify.ephemeralMessage', uid, message.rid, {\n\t\t\tmsg: i18n.t(errorMessage, { ...errorContext, lng: user.language }),\n\t\t});\n\n\t\tif (typeof err === 'string') {\n\t\t\tthrow new Error(err);\n\t\t}\n\n\t\tthrow err;\n\t}\n}\n\ndeclare module '@rocket.chat/ddp-client' {\n\t// eslint-disable-next-line @typescript-eslint/naming-convention\n\tinterface ServerMethods {\n\t\tsendMessage(message: AtLeast<IMessage, '_id' | 'rid' | 'msg'>, previewUrls?: string[]): any;\n\t}\n}\n\nMeteor.methods<ServerMethods>({\n\tasync sendMessage(message, previewUrls) {\n\t\tcheck(message, Object);\n\n\t\tconst uid = Meteor.userId();\n\t\tif (!uid) {\n\t\t\tthrow new Meteor.Error('error-invalid-user', 'Invalid user', {\n\t\t\t\tmethod: 'sendMessage',\n\t\t\t});\n\t\t}\n\n\t\tif (MessageTypes.isSystemMessage(message)) {\n\t\t\tthrow new Error(\"Cannot send system messages using 'sendMessage'\");\n\t\t}\n\n\t\ttry {\n\t\t\treturn await applyAirGappedRestrictionsValidation(() => executeSendMessage(uid, message, previewUrls));\n\t\t} catch (error: any) {\n\t\t\tif (['error-not-allowed', 'restricted-workspace'].includes(error.error || error.message)) {\n\t\t\t\tthrow new Meteor.Error(error.error || error.message, error.reason, {\n\t\t\t\t\tmethod: 'sendMessage',\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\t},\n});\n// Limit a user, who does not have the \"bot\" role, to sending 5 msgs/second\nRateLimiter.limitMethod('sendMessage', 5, 1000, {\n\tasync userId(userId: IUser['_id']) {\n\t\treturn !(await hasPermissionAsync(userId, 'send-many-messages'));\n\t},\n});\n"],"mappings":"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","ignoreList":[]},"sourceType":"module","externalDependencies":{},"hash":"1869773f670b9abb4dc47a88c5a4b6553a57fa26"}
