{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/ee/server/models/raw/Users.ts","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","topLevelAwait","objectRestSpread","objectRestSpread","asyncGenerators","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"os.osx.arm64"},"sourceFileName":"ee/server/models/raw/Users.ts","filename":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/ee/server/models/raw/Users.ts","inputSourceMap":{"version":3,"file":"ee/server/models/raw/Users.ts","sourceRoot":"","sources":["ee/server/models/raw/Users.ts"],"names":[],"mappings":"AAGA,OAAO,EAAE,sBAAsB,EAAE,MAAM,oDAAoD,CAAC;AAC5F,OAAO,EAAE,QAAQ,EAAE,MAAM,qCAAqC,CAAC;AAiB/D,MAAM,OAAO,OAAQ,SAAQ,QAAQ;IACpC,YAAY,EAAM,EAAE,KAAkD;QACrE,KAAK,CAAC,EAAE,EAAE,KAAK,CAAC,CAAC;IAClB,CAAC;IAED,6DAA6D;IAC7D,oBAAoB,CAAC,YAAoB,EAAE,YAAoC;QAC9E,yFAAyF;QACzF,MAAM,gBAAgB,GAAG,YAAY;YACpC,CAAC,CAAC;gBACA;oBACC,OAAO,EAAE;wBACR,IAAI,EAAE,uCAAuC;wBAC7C,GAAG,EAAE,EAAE,YAAY,EAAE,eAAe,EAAE,OAAO,EAAE,UAAU,EAAE;wBAC3D,QAAQ,EAAE;4BACT;gCACC,MAAM,EAAE,EAAE,KAAK,EAAE,EAAE,GAAG,EAAE,CAAC,WAAW,EAAE,MAAM,CAAC,EAAE,EAAE;6BACjD;4BACD;gCACC,MAAM,EAAE,EAAE,KAAK,EAAE,EAAE,GAAG,EAAE,CAAC,gBAAgB,EAAE,YAAY,CAAC,EAAE,EAAE;6BAC5D;yBACD;wBACD,EAAE,EAAE,YAAY;qBAChB;iBACD;gBACD;oBACC,MAAM,EAAE,EAAE,UAAU,EAAE,EAAE,KAAK,EAAE,CAAC,EAAE,EAAE;iBACpC;aACD;YACF,CAAC,CAAC,EAAE,CAAC;QAEN,OAAO,IAAI,CAAC,GAAG;aACb,SAAS,CACT;YACC;gBACC,MAAM,EAAE;oBACP,MAAM,EAAE,EAAE,OAAO,EAAE,IAAI,EAAE,GAAG,EAAE,SAAS,EAAE;oBACzC,cAAc,EAAE,WAAW;oBAC3B,KAAK,EAAE,gBAAgB;iBACvB;aACD;YACD,GAAG,gBAAgB;YACnB;gBACC,OAAO,EAAE;oBACR,IAAI,EAAE,yBAAyB;oBAC/B,UAAU,EAAE,KAAK;oBACjB,YAAY,EAAE,OAAO;oBACrB,EAAE,EAAE,MAAM;iBACV;aACD;YACD;gBACC,QAAQ,EAAE;oBACT,SAAS,EAAE,MAAM;oBACjB,oCAAoC,EAAE,CAAC;oBACvC,UAAU,EAAE,CAAC;oBACb,gBAAgB,EAAE,CAAC;oBACnB,iBAAiB,EAAE,CAAC;oBACpB,iBAAiB,EAAE;wBAClB,KAAK,EAAE;4BACN,OAAO,EAAE;gCACR,KAAK,EAAE,OAAO;gCACd,EAAE,EAAE,KAAK;gCACT,IAAI,EAAE;oCACL,IAAI,EAAE,CAAC,EAAE,GAAG,EAAE,CAAC,SAAS,EAAE,GAAG,CAAC,EAAE,EAAE,EAAE,GAAG,EAAE,CAAC,YAAY,EAAE,IAAI,CAAC,EAAE,EAAE,EAAE,GAAG,EAAE,CAAC,cAAc,EAAE,IAAI,CAAC,EAAE,CAAC;iCACjG;6BACD;yBACD;qBACD;iBACD;aACD;YACD,GAAG,CAAC,YAAY,CAAC,CAAC,CAAC,CAAC,YAAY,CAAC,CAAC,CAAC,CAAC,EAAE,CAAC;YACvC;gBACC,KAAK,EAAE;oBACN,iBAAiB,EAAE,CAAC;oBACpB,gBAAgB,EAAE,CAAC;oBACnB,iBAAiB,EAAE,CAAC;oBACpB,UAAU,EAAE,CAAC;iBACb;aACD;SACD,EACD,EAAE,YAAY,EAAE,IAAI,EAAE,cAAc,EAAE,sBAAsB,EAAE,EAAE,CAChE;aACA,OAAO,EAAE,CAAC;IACb,CAAC;CACD","sourcesContent":["import type { RocketChatRecordDeleted, IUser } from '@rocket.chat/core-typings';\nimport type { Db, Collection } from 'mongodb';\n\nimport { readSecondaryPreferred } from '../../../../server/database/readSecondaryPreferred';\nimport { UsersRaw } from '../../../../server/models/raw/Users';\n\ntype AgentMetadata = {\n\t'agentId'?: string;\n\t'username'?: string;\n\t'lastAssignTime'?: Date;\n\t'lastRoutingTime'?: Date;\n\t'queueInfo.chats'?: number;\n\t[x: string]: any;\n};\n\ndeclare module '@rocket.chat/model-typings' {\n\tinterface IUsersModel {\n\t\tgetUnavailableAgents(departmentId: string, customFilter: { [k: string]: any }[]): Promise<AgentMetadata[]>;\n\t}\n}\n\nexport class UsersEE extends UsersRaw {\n\tconstructor(db: Db, trash?: Collection<RocketChatRecordDeleted<IUser>>) {\n\t\tsuper(db, trash);\n\t}\n\n\t// @ts-expect-error - typings are good, but JS is not helping\n\tgetUnavailableAgents(departmentId: string, customFilter: { [k: string]: any }[]): Promise<AgentMetadata[]> {\n\t\t// if department is provided, remove the agents that are not from the selected department\n\t\tconst departmentFilter = departmentId\n\t\t\t? [\n\t\t\t\t\t{\n\t\t\t\t\t\t$lookup: {\n\t\t\t\t\t\t\tfrom: 'rocketchat_livechat_department_agents',\n\t\t\t\t\t\t\tlet: { departmentId: '$departmentId', agentId: '$agentId' },\n\t\t\t\t\t\t\tpipeline: [\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t$match: { $expr: { $eq: ['$$agentId', '$_id'] } },\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t$match: { $expr: { $eq: ['$$departmentId', departmentId] } },\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t],\n\t\t\t\t\t\t\tas: 'department',\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\t$match: { department: { $size: 1 } },\n\t\t\t\t\t},\n\t\t\t\t]\n\t\t\t: [];\n\n\t\treturn this.col\n\t\t\t.aggregate(\n\t\t\t\t[\n\t\t\t\t\t{\n\t\t\t\t\t\t$match: {\n\t\t\t\t\t\t\tstatus: { $exists: true, $ne: 'offline' },\n\t\t\t\t\t\t\tstatusLivechat: 'available',\n\t\t\t\t\t\t\troles: 'livechat-agent',\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t\t...departmentFilter,\n\t\t\t\t\t{\n\t\t\t\t\t\t$lookup: {\n\t\t\t\t\t\t\tfrom: 'rocketchat_subscription',\n\t\t\t\t\t\t\tlocalField: '_id',\n\t\t\t\t\t\t\tforeignField: 'u._id',\n\t\t\t\t\t\t\tas: 'subs',\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\t$project: {\n\t\t\t\t\t\t\t'agentId': '$_id',\n\t\t\t\t\t\t\t'livechat.maxNumberSimultaneousChat': 1,\n\t\t\t\t\t\t\t'username': 1,\n\t\t\t\t\t\t\t'lastAssignTime': 1,\n\t\t\t\t\t\t\t'lastRoutingTime': 1,\n\t\t\t\t\t\t\t'queueInfo.chats': {\n\t\t\t\t\t\t\t\t$size: {\n\t\t\t\t\t\t\t\t\t$filter: {\n\t\t\t\t\t\t\t\t\t\tinput: '$subs',\n\t\t\t\t\t\t\t\t\t\tas: 'sub',\n\t\t\t\t\t\t\t\t\t\tcond: {\n\t\t\t\t\t\t\t\t\t\t\t$and: [{ $eq: ['$$sub.t', 'l'] }, { $eq: ['$$sub.open', true] }, { $ne: ['$$sub.onHold', true] }],\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t\t...(customFilter ? [customFilter] : []),\n\t\t\t\t\t{\n\t\t\t\t\t\t$sort: {\n\t\t\t\t\t\t\t'queueInfo.chats': 1,\n\t\t\t\t\t\t\t'lastAssignTime': 1,\n\t\t\t\t\t\t\t'lastRoutingTime': 1,\n\t\t\t\t\t\t\t'username': 1,\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t],\n\t\t\t\t{ allowDiskUse: true, readPreference: readSecondaryPreferred() },\n\t\t\t)\n\t\t\t.toArray();\n\t}\n}\n"]},"targets":{"android":"125.0.0","chrome":"125.0.0","edge":"125.0.0","firefox":"115.0.0","ie":"10.0.0","ios":"17.4.0","opera":"110.0.0","opera_mobile":"80.0.0","safari":"17.4.0","samsung":"24.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor","root":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":false,"enforceStrictMode":false,"dynamicImport":true,"generateLetDeclarations":true,"topLevelAwait":true},"externalDependencies":[]},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"version":"7.17.2","helpers":true,"useESModules":false,"corejs":false},"externalDependencies":[]},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-async-generator-functions","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-class-properties","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true},"externalDependencies":[]},{"key":"transform-react-jsx","visitor":{"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXFragment":{"exit":[null]},"JSXElement":{"exit":[null]},"JSXAttribute":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false},"externalDependencies":[]},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-nullish-coalescing-operator","visitor":{"LogicalExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-optional-chaining","visitor":{"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-optional-catch-binding","visitor":{"CatchClause":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-class-properties","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-async-generator-functions","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-logical-assignment-operators","visitor":{"AssignmentExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]}],"presets":[],"generatorOpts":{"filename":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/ee/server/models/raw/Users.ts","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"ee/server/models/raw/Users.ts","inputSourceMap":{"version":3,"file":"ee/server/models/raw/Users.ts","sourceRoot":"","sources":["ee/server/models/raw/Users.ts"],"names":[],"mappings":"AAGA,OAAO,EAAE,sBAAsB,EAAE,MAAM,oDAAoD,CAAC;AAC5F,OAAO,EAAE,QAAQ,EAAE,MAAM,qCAAqC,CAAC;AAiB/D,MAAM,OAAO,OAAQ,SAAQ,QAAQ;IACpC,YAAY,EAAM,EAAE,KAAkD;QACrE,KAAK,CAAC,EAAE,EAAE,KAAK,CAAC,CAAC;IAClB,CAAC;IAED,6DAA6D;IAC7D,oBAAoB,CAAC,YAAoB,EAAE,YAAoC;QAC9E,yFAAyF;QACzF,MAAM,gBAAgB,GAAG,YAAY;YACpC,CAAC,CAAC;gBACA;oBACC,OAAO,EAAE;wBACR,IAAI,EAAE,uCAAuC;wBAC7C,GAAG,EAAE,EAAE,YAAY,EAAE,eAAe,EAAE,OAAO,EAAE,UAAU,EAAE;wBAC3D,QAAQ,EAAE;4BACT;gCACC,MAAM,EAAE,EAAE,KAAK,EAAE,EAAE,GAAG,EAAE,CAAC,WAAW,EAAE,MAAM,CAAC,EAAE,EAAE;6BACjD;4BACD;gCACC,MAAM,EAAE,EAAE,KAAK,EAAE,EAAE,GAAG,EAAE,CAAC,gBAAgB,EAAE,YAAY,CAAC,EAAE,EAAE;6BAC5D;yBACD;wBACD,EAAE,EAAE,YAAY;qBAChB;iBACD;gBACD;oBACC,MAAM,EAAE,EAAE,UAAU,EAAE,EAAE,KAAK,EAAE,CAAC,EAAE,EAAE;iBACpC;aACD;YACF,CAAC,CAAC,EAAE,CAAC;QAEN,OAAO,IAAI,CAAC,GAAG;aACb,SAAS,CACT;YACC;gBACC,MAAM,EAAE;oBACP,MAAM,EAAE,EAAE,OAAO,EAAE,IAAI,EAAE,GAAG,EAAE,SAAS,EAAE;oBACzC,cAAc,EAAE,WAAW;oBAC3B,KAAK,EAAE,gBAAgB;iBACvB;aACD;YACD,GAAG,gBAAgB;YACnB;gBACC,OAAO,EAAE;oBACR,IAAI,EAAE,yBAAyB;oBAC/B,UAAU,EAAE,KAAK;oBACjB,YAAY,EAAE,OAAO;oBACrB,EAAE,EAAE,MAAM;iBACV;aACD;YACD;gBACC,QAAQ,EAAE;oBACT,SAAS,EAAE,MAAM;oBACjB,oCAAoC,EAAE,CAAC;oBACvC,UAAU,EAAE,CAAC;oBACb,gBAAgB,EAAE,CAAC;oBACnB,iBAAiB,EAAE,CAAC;oBACpB,iBAAiB,EAAE;wBAClB,KAAK,EAAE;4BACN,OAAO,EAAE;gCACR,KAAK,EAAE,OAAO;gCACd,EAAE,EAAE,KAAK;gCACT,IAAI,EAAE;oCACL,IAAI,EAAE,CAAC,EAAE,GAAG,EAAE,CAAC,SAAS,EAAE,GAAG,CAAC,EAAE,EAAE,EAAE,GAAG,EAAE,CAAC,YAAY,EAAE,IAAI,CAAC,EAAE,EAAE,EAAE,GAAG,EAAE,CAAC,cAAc,EAAE,IAAI,CAAC,EAAE,CAAC;iCACjG;6BACD;yBACD;qBACD;iBACD;aACD;YACD,GAAG,CAAC,YAAY,CAAC,CAAC,CAAC,CAAC,YAAY,CAAC,CAAC,CAAC,CAAC,EAAE,CAAC;YACvC;gBACC,KAAK,EAAE;oBACN,iBAAiB,EAAE,CAAC;oBACpB,gBAAgB,EAAE,CAAC;oBACnB,iBAAiB,EAAE,CAAC;oBACpB,UAAU,EAAE,CAAC;iBACb;aACD;SACD,EACD,EAAE,YAAY,EAAE,IAAI,EAAE,cAAc,EAAE,sBAAsB,EAAE,EAAE,CAChE;aACA,OAAO,EAAE,CAAC;IACb,CAAC;CACD","sourcesContent":["import type { RocketChatRecordDeleted, IUser } from '@rocket.chat/core-typings';\nimport type { Db, Collection } from 'mongodb';\n\nimport { readSecondaryPreferred } from '../../../../server/database/readSecondaryPreferred';\nimport { UsersRaw } from '../../../../server/models/raw/Users';\n\ntype AgentMetadata = {\n\t'agentId'?: string;\n\t'username'?: string;\n\t'lastAssignTime'?: Date;\n\t'lastRoutingTime'?: Date;\n\t'queueInfo.chats'?: number;\n\t[x: string]: any;\n};\n\ndeclare module '@rocket.chat/model-typings' {\n\tinterface IUsersModel {\n\t\tgetUnavailableAgents(departmentId: string, customFilter: { [k: string]: any }[]): Promise<AgentMetadata[]>;\n\t}\n}\n\nexport class UsersEE extends UsersRaw {\n\tconstructor(db: Db, trash?: Collection<RocketChatRecordDeleted<IUser>>) {\n\t\tsuper(db, trash);\n\t}\n\n\t// @ts-expect-error - typings are good, but JS is not helping\n\tgetUnavailableAgents(departmentId: string, customFilter: { [k: string]: any }[]): Promise<AgentMetadata[]> {\n\t\t// if department is provided, remove the agents that are not from the selected department\n\t\tconst departmentFilter = departmentId\n\t\t\t? [\n\t\t\t\t\t{\n\t\t\t\t\t\t$lookup: {\n\t\t\t\t\t\t\tfrom: 'rocketchat_livechat_department_agents',\n\t\t\t\t\t\t\tlet: { departmentId: '$departmentId', agentId: '$agentId' },\n\t\t\t\t\t\t\tpipeline: [\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t$match: { $expr: { $eq: ['$$agentId', '$_id'] } },\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t$match: { $expr: { $eq: ['$$departmentId', departmentId] } },\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t],\n\t\t\t\t\t\t\tas: 'department',\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\t$match: { department: { $size: 1 } },\n\t\t\t\t\t},\n\t\t\t\t]\n\t\t\t: [];\n\n\t\treturn this.col\n\t\t\t.aggregate(\n\t\t\t\t[\n\t\t\t\t\t{\n\t\t\t\t\t\t$match: {\n\t\t\t\t\t\t\tstatus: { $exists: true, $ne: 'offline' },\n\t\t\t\t\t\t\tstatusLivechat: 'available',\n\t\t\t\t\t\t\troles: 'livechat-agent',\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t\t...departmentFilter,\n\t\t\t\t\t{\n\t\t\t\t\t\t$lookup: {\n\t\t\t\t\t\t\tfrom: 'rocketchat_subscription',\n\t\t\t\t\t\t\tlocalField: '_id',\n\t\t\t\t\t\t\tforeignField: 'u._id',\n\t\t\t\t\t\t\tas: 'subs',\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\t$project: {\n\t\t\t\t\t\t\t'agentId': '$_id',\n\t\t\t\t\t\t\t'livechat.maxNumberSimultaneousChat': 1,\n\t\t\t\t\t\t\t'username': 1,\n\t\t\t\t\t\t\t'lastAssignTime': 1,\n\t\t\t\t\t\t\t'lastRoutingTime': 1,\n\t\t\t\t\t\t\t'queueInfo.chats': {\n\t\t\t\t\t\t\t\t$size: {\n\t\t\t\t\t\t\t\t\t$filter: {\n\t\t\t\t\t\t\t\t\t\tinput: '$subs',\n\t\t\t\t\t\t\t\t\t\tas: 'sub',\n\t\t\t\t\t\t\t\t\t\tcond: {\n\t\t\t\t\t\t\t\t\t\t\t$and: [{ $eq: ['$$sub.t', 'l'] }, { $eq: ['$$sub.open', true] }, { $ne: ['$$sub.onHold', true] }],\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t\t...(customFilter ? [customFilter] : []),\n\t\t\t\t\t{\n\t\t\t\t\t\t$sort: {\n\t\t\t\t\t\t\t'queueInfo.chats': 1,\n\t\t\t\t\t\t\t'lastAssignTime': 1,\n\t\t\t\t\t\t\t'lastRoutingTime': 1,\n\t\t\t\t\t\t\t'username': 1,\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t],\n\t\t\t\t{ allowDiskUse: true, readPreference: readSecondaryPreferred() },\n\t\t\t)\n\t\t\t.toArray();\n\t}\n}\n"]}}},"code":"!module.wrapAsync(async function (module, __reifyWaitForDeps__, __reify_async_result__) {\n  \"use strict\";\n  try {\n    module.export({\n      UsersEE: () => UsersEE\n    });\n    let readSecondaryPreferred;\n    module.link(\"../../../../server/database/readSecondaryPreferred\", {\n      readSecondaryPreferred(v) {\n        readSecondaryPreferred = v;\n      }\n    }, 0);\n    let UsersRaw;\n    module.link(\"../../../../server/models/raw/Users\", {\n      UsersRaw(v) {\n        UsersRaw = v;\n      }\n    }, 1);\n    if (__reifyWaitForDeps__()) (await __reifyWaitForDeps__())();\n    class UsersEE extends UsersRaw {\n      constructor(db, trash) {\n        super(db, trash);\n      }\n      // @ts-expect-error - typings are good, but JS is not helping\n      getUnavailableAgents(departmentId, customFilter) {\n        // if department is provided, remove the agents that are not from the selected department\n        const departmentFilter = departmentId ? [{\n          $lookup: {\n            from: 'rocketchat_livechat_department_agents',\n            let: {\n              departmentId: '$departmentId',\n              agentId: '$agentId'\n            },\n            pipeline: [{\n              $match: {\n                $expr: {\n                  $eq: ['$$agentId', '$_id']\n                }\n              }\n            }, {\n              $match: {\n                $expr: {\n                  $eq: ['$$departmentId', departmentId]\n                }\n              }\n            }],\n            as: 'department'\n          }\n        }, {\n          $match: {\n            department: {\n              $size: 1\n            }\n          }\n        }] : [];\n        return this.col.aggregate([{\n          $match: {\n            status: {\n              $exists: true,\n              $ne: 'offline'\n            },\n            statusLivechat: 'available',\n            roles: 'livechat-agent'\n          }\n        }, ...departmentFilter, {\n          $lookup: {\n            from: 'rocketchat_subscription',\n            localField: '_id',\n            foreignField: 'u._id',\n            as: 'subs'\n          }\n        }, {\n          $project: {\n            'agentId': '$_id',\n            'livechat.maxNumberSimultaneousChat': 1,\n            'username': 1,\n            'lastAssignTime': 1,\n            'lastRoutingTime': 1,\n            'queueInfo.chats': {\n              $size: {\n                $filter: {\n                  input: '$subs',\n                  as: 'sub',\n                  cond: {\n                    $and: [{\n                      $eq: ['$$sub.t', 'l']\n                    }, {\n                      $eq: ['$$sub.open', true]\n                    }, {\n                      $ne: ['$$sub.onHold', true]\n                    }]\n                  }\n                }\n              }\n            }\n          }\n        }, ...(customFilter ? [customFilter] : []), {\n          $sort: {\n            'queueInfo.chats': 1,\n            'lastAssignTime': 1,\n            'lastRoutingTime': 1,\n            'username': 1\n          }\n        }], {\n          allowDiskUse: true,\n          readPreference: readSecondaryPreferred()\n        }).toArray();\n      }\n    }\n    __reify_async_result__();\n  } catch (_reifyError) {\n    return __reify_async_result__(_reifyError);\n  }\n  __reify_async_result__()\n}, {\n  self: this,\n  async: false\n});","map":{"version":3,"names":["module","export","UsersEE","readSecondaryPreferred","link","v","UsersRaw","__reifyWaitForDeps__","constructor","db","trash","getUnavailableAgents","departmentId","customFilter","departmentFilter","$lookup","from","let","agentId","pipeline","$match","$expr","$eq","as","department","$size","col","aggregate","status","$exists","$ne","statusLivechat","roles","localField","foreignField","$project","$filter","input","cond","$and","$sort","allowDiskUse","readPreference","toArray","__reify_async_result__","_reifyError","self","async"],"sources":["ee/server/models/raw/Users.ts"],"sourcesContent":["import type { RocketChatRecordDeleted, IUser } from '@rocket.chat/core-typings';\nimport type { Db, Collection } from 'mongodb';\n\nimport { readSecondaryPreferred } from '../../../../server/database/readSecondaryPreferred';\nimport { UsersRaw } from '../../../../server/models/raw/Users';\n\ntype AgentMetadata = {\n\t'agentId'?: string;\n\t'username'?: string;\n\t'lastAssignTime'?: Date;\n\t'lastRoutingTime'?: Date;\n\t'queueInfo.chats'?: number;\n\t[x: string]: any;\n};\n\ndeclare module '@rocket.chat/model-typings' {\n\tinterface IUsersModel {\n\t\tgetUnavailableAgents(departmentId: string, customFilter: { [k: string]: any }[]): Promise<AgentMetadata[]>;\n\t}\n}\n\nexport class UsersEE extends UsersRaw {\n\tconstructor(db: Db, trash?: Collection<RocketChatRecordDeleted<IUser>>) {\n\t\tsuper(db, trash);\n\t}\n\n\t// @ts-expect-error - typings are good, but JS is not helping\n\tgetUnavailableAgents(departmentId: string, customFilter: { [k: string]: any }[]): Promise<AgentMetadata[]> {\n\t\t// if department is provided, remove the agents that are not from the selected department\n\t\tconst departmentFilter = departmentId\n\t\t\t? [\n\t\t\t\t\t{\n\t\t\t\t\t\t$lookup: {\n\t\t\t\t\t\t\tfrom: 'rocketchat_livechat_department_agents',\n\t\t\t\t\t\t\tlet: { departmentId: '$departmentId', agentId: '$agentId' },\n\t\t\t\t\t\t\tpipeline: [\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t$match: { $expr: { $eq: ['$$agentId', '$_id'] } },\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t$match: { $expr: { $eq: ['$$departmentId', departmentId] } },\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t],\n\t\t\t\t\t\t\tas: 'department',\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\t$match: { department: { $size: 1 } },\n\t\t\t\t\t},\n\t\t\t\t]\n\t\t\t: [];\n\n\t\treturn this.col\n\t\t\t.aggregate(\n\t\t\t\t[\n\t\t\t\t\t{\n\t\t\t\t\t\t$match: {\n\t\t\t\t\t\t\tstatus: { $exists: true, $ne: 'offline' },\n\t\t\t\t\t\t\tstatusLivechat: 'available',\n\t\t\t\t\t\t\troles: 'livechat-agent',\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t\t...departmentFilter,\n\t\t\t\t\t{\n\t\t\t\t\t\t$lookup: {\n\t\t\t\t\t\t\tfrom: 'rocketchat_subscription',\n\t\t\t\t\t\t\tlocalField: '_id',\n\t\t\t\t\t\t\tforeignField: 'u._id',\n\t\t\t\t\t\t\tas: 'subs',\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\t$project: {\n\t\t\t\t\t\t\t'agentId': '$_id',\n\t\t\t\t\t\t\t'livechat.maxNumberSimultaneousChat': 1,\n\t\t\t\t\t\t\t'username': 1,\n\t\t\t\t\t\t\t'lastAssignTime': 1,\n\t\t\t\t\t\t\t'lastRoutingTime': 1,\n\t\t\t\t\t\t\t'queueInfo.chats': {\n\t\t\t\t\t\t\t\t$size: {\n\t\t\t\t\t\t\t\t\t$filter: {\n\t\t\t\t\t\t\t\t\t\tinput: '$subs',\n\t\t\t\t\t\t\t\t\t\tas: 'sub',\n\t\t\t\t\t\t\t\t\t\tcond: {\n\t\t\t\t\t\t\t\t\t\t\t$and: [{ $eq: ['$$sub.t', 'l'] }, { $eq: ['$$sub.open', true] }, { $ne: ['$$sub.onHold', true] }],\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t\t...(customFilter ? [customFilter] : []),\n\t\t\t\t\t{\n\t\t\t\t\t\t$sort: {\n\t\t\t\t\t\t\t'queueInfo.chats': 1,\n\t\t\t\t\t\t\t'lastAssignTime': 1,\n\t\t\t\t\t\t\t'lastRoutingTime': 1,\n\t\t\t\t\t\t\t'username': 1,\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t],\n\t\t\t\t{ allowDiskUse: true, readPreference: readSecondaryPreferred() },\n\t\t\t)\n\t\t\t.toArray();\n\t}\n}\n"],"mappings":";;;IAGAA,MAAA,CAAOC,MAAE;MAAAC,OAAA,EAAAA,CAAA,KAAAA;IAAwB;IAAA,IAAMC,sBAAA;IAAAH,MAAA,CAAAI,IAAA,qDAAqD;MAAAD,uBAAAE,CAAA;QAAAF,sBAAA,GAAAE,CAAA;MAAA;IAAA;IAAA,IAAAC,QAAA;IAAAN,MAAA,CAAAI,IAAA;MAAAE,SAAAD,CAAA;QAAAC,QAAA,GAAAD,CAAA;MAAA;IAAA;IAAA,IAAAE,oBAAA,WAAAA,oBAAA;IAkBtF,MAAOL,OAAQ,SAAQI,QAAQ;MACpCE,YAAYC,EAAM,EAAEC,KAAkD;QACrE,KAAK,CAACD,EAAE,EAAEC,KAAK,CAAC;MACjB;MAEA;MACAC,oBAAoBA,CAACC,YAAoB,EAAEC,YAAoC;QAC9E;QACA,MAAMC,gBAAgB,GAAGF,YAAY,GAClC,CACA;UACCG,OAAO,EAAE;YACRC,IAAI,EAAE,uCAAuC;YAC7CC,GAAG,EAAE;cAAEL,YAAY,EAAE,eAAe;cAAEM,OAAO,EAAE;YAAU,CAAE;YAC3DC,QAAQ,EAAE,CACT;cACCC,MAAM,EAAE;gBAAEC,KAAK,EAAE;kBAAEC,GAAG,EAAE,CAAC,WAAW,EAAE,MAAM;gBAAC;cAAE;aAC/C,EACD;cACCF,MAAM,EAAE;gBAAEC,KAAK,EAAE;kBAAEC,GAAG,EAAE,CAAC,gBAAgB,EAAEV,YAAY;gBAAC;cAAE;aAC1D,CACD;YACDW,EAAE,EAAE;;SAEL,EACD;UACCH,MAAM,EAAE;YAAEI,UAAU,EAAE;cAAEC,KAAK,EAAE;YAAC;UAAE;SAClC,CACD,GACA,EAAE;QAEL,OAAO,IAAI,CAACC,GAAG,CACbC,SAAS,CACT,CACC;UACCP,MAAM,EAAE;YACPQ,MAAM,EAAE;cAAEC,OAAO,EAAE,IAAI;cAAEC,GAAG,EAAE;YAAS,CAAE;YACzCC,cAAc,EAAE,WAAW;YAC3BC,KAAK,EAAE;;SAER,EACD,GAAGlB,gBAAgB,EACnB;UACCC,OAAO,EAAE;YACRC,IAAI,EAAE,yBAAyB;YAC/BiB,UAAU,EAAE,KAAK;YACjBC,YAAY,EAAE,OAAO;YACrBX,EAAE,EAAE;;SAEL,EACD;UACCY,QAAQ,EAAE;YACT,SAAS,EAAE,MAAM;YACjB,oCAAoC,EAAE,CAAC;YACvC,UAAU,EAAE,CAAC;YACb,gBAAgB,EAAE,CAAC;YACnB,iBAAiB,EAAE,CAAC;YACpB,iBAAiB,EAAE;cAClBV,KAAK,EAAE;gBACNW,OAAO,EAAE;kBACRC,KAAK,EAAE,OAAO;kBACdd,EAAE,EAAE,KAAK;kBACTe,IAAI,EAAE;oBACLC,IAAI,EAAE,CAAC;sBAAEjB,GAAG,EAAE,CAAC,SAAS,EAAE,GAAG;oBAAC,CAAE,EAAE;sBAAEA,GAAG,EAAE,CAAC,YAAY,EAAE,IAAI;oBAAC,CAAE,EAAE;sBAAEQ,GAAG,EAAE,CAAC,cAAc,EAAE,IAAI;oBAAC,CAAE;;;;;;SAMrG,EACD,IAAIjB,YAAY,GAAG,CAACA,YAAY,CAAC,GAAG,EAAE,CAAC,EACvC;UACC2B,KAAK,EAAE;YACN,iBAAiB,EAAE,CAAC;YACpB,gBAAgB,EAAE,CAAC;YACnB,iBAAiB,EAAE,CAAC;YACpB,UAAU,EAAE;;SAEb,CACD,EACD;UAAEC,YAAY,EAAE,IAAI;UAAEC,cAAc,EAAEvC,sBAAsB;QAAE,CAAE,CAChE,CACAwC,OAAO,EAAE;MACZ;;IACAC,sBAAA;EAAA,SAAAC,WAAA;IAAA,OAAAD,sBAAA,CAAAC,WAAA;EAAA;EAAAD,sBAAA;AAAA;EAAAE,IAAA;EAAAC,KAAA;AAAA","ignoreList":[]},"sourceType":"module","externalDependencies":{},"hash":"84a34ae99cd0f9622152aabcc0fd5d618069bc4e"}
