{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/client/hooks/useVoipClient.ts","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","topLevelAwait","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"web.browser.legacy"},"sourceFileName":"client/hooks/useVoipClient.ts","filename":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/client/hooks/useVoipClient.ts","inputSourceMap":{"version":3,"file":"client/hooks/useVoipClient.ts","sourceRoot":"","sources":["client/hooks/useVoipClient.ts"],"names":[],"mappings":"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","sourcesContent":["import type { IRegistrationInfo } from '@rocket.chat/core-typings';\nimport { WorkflowTypes } from '@rocket.chat/core-typings';\nimport { useSafely } from '@rocket.chat/fuselage-hooks';\nimport { useUser, useSetting, useEndpoint, useStream } from '@rocket.chat/ui-contexts';\nimport { KJUR } from 'jsrsasign';\nimport { useEffect, useState } from 'react';\n\nimport { EEVoipClient } from '../lib/voip/EEVoipClient';\nimport { VoIPUser } from '../lib/voip/VoIPUser';\nimport { useWebRtcServers } from '../providers/CallProvider/hooks/useWebRtcServers';\nimport { useHasLicenseModule } from './useHasLicenseModule';\n\ntype UseVoipClientResult = {\n\tvoipClient?: VoIPUser;\n\tregistrationInfo?: IRegistrationInfo;\n\terror?: Error | unknown;\n};\n\nconst empty = {};\n\nconst isSignedResponse = (data: any): data is { result: string } => typeof data?.result === 'string';\n\n// Currently we only support the websocket connection and the SIP proxy connection being from the same host,\n// we need to add a new setting for SIP proxy if we want to support different hosts for them.\nexport const useVoipClient = (): UseVoipClientResult => {\n\tconst settingVoipEnabled = Boolean(useSetting('VoIP_Enabled'));\n\n\tconst [voipConnectorEnabled, setVoipConnectorEnabled] = useSafely(useState(true));\n\n\tconst voipRetryCount = useSetting('VoIP_Retry_Count');\n\tconst enableKeepAlive = useSetting('VoIP_Enable_Keep_Alive_For_Unstable_Networks');\n\tconst registrationInfo = useEndpoint('GET', '/v1/connector.extension.getRegistrationInfoByUserId');\n\tconst membership = useEndpoint('GET', '/v1/voip/queues.getMembershipSubscription');\n\tconst user = useUser();\n\tconst subscribeToNotifyLoggedIn = useStream('notify-logged');\n\tconst iceServers = useWebRtcServers();\n\tconst [result, setResult] = useSafely(useState<UseVoipClientResult>({}));\n\n\tconst isEE = useHasLicenseModule('voip-enterprise');\n\tconst voipEnabled = settingVoipEnabled && voipConnectorEnabled;\n\n\tuseEffect(() => {\n\t\tif (user) {\n\t\t\treturn subscribeToNotifyLoggedIn(`voip.statuschanged`, (enabled: boolean): void => {\n\t\t\t\tsetVoipConnectorEnabled(enabled);\n\t\t\t});\n\t\t}\n\t}, [setResult, setVoipConnectorEnabled, subscribeToNotifyLoggedIn, user]);\n\n\tuseEffect(() => {\n\t\tconst uid = user?._id;\n\t\tconst userExtension = user?.extension;\n\n\t\tif (!uid || !userExtension || !voipEnabled) {\n\t\t\tsetResult(empty);\n\t\t\treturn;\n\t\t}\n\t\tlet client: VoIPUser;\n\t\tregistrationInfo({ id: uid }).then(\n\t\t\t(data) => {\n\t\t\t\tlet parsedData: IRegistrationInfo;\n\t\t\t\tif (isSignedResponse(data)) {\n\t\t\t\t\tconst result = KJUR.jws.JWS.parse(data.result);\n\t\t\t\t\tparsedData = (result.payloadObj as any)?.context as IRegistrationInfo;\n\t\t\t\t} else {\n\t\t\t\t\tparsedData = data;\n\t\t\t\t}\n\n\t\t\t\tconst {\n\t\t\t\t\textensionDetails: { extension, password },\n\t\t\t\t\tcallServerConfig: { websocketPath },\n\t\t\t\t} = parsedData;\n\n\t\t\t\t(async (): Promise<void> => {\n\t\t\t\t\ttry {\n\t\t\t\t\t\tconst wsURL = new URL(websocketPath);\n\t\t\t\t\t\tconst subscription = await membership({ extension });\n\n\t\t\t\t\t\tconst config = {\n\t\t\t\t\t\t\tauthUserName: extension,\n\t\t\t\t\t\t\tauthPassword: password,\n\t\t\t\t\t\t\tsipRegistrarHostnameOrIP: wsURL.host,\n\t\t\t\t\t\t\twebSocketURI: websocketPath,\n\t\t\t\t\t\t\tenableVideo: true,\n\t\t\t\t\t\t\ticeServers,\n\t\t\t\t\t\t\tconnectionRetryCount: Number(voipRetryCount),\n\t\t\t\t\t\t\tenableKeepAliveUsingOptionsForUnstableNetworks: Boolean(enableKeepAlive),\n\t\t\t\t\t\t};\n\n\t\t\t\t\t\tclient = await (isEE ? EEVoipClient.create(config) : VoIPUser.create(config));\n\n\t\t\t\t\t\t// Today we are hardcoding workflow mode.\n\t\t\t\t\t\t// In future, this should be ready from configuration\n\t\t\t\t\t\tclient.setWorkflowMode(WorkflowTypes.CONTACT_CENTER_USER);\n\t\t\t\t\t\tclient.setMembershipSubscription(subscription);\n\t\t\t\t\t\tsetResult({ voipClient: client, registrationInfo: parsedData });\n\t\t\t\t\t} catch (error) {\n\t\t\t\t\t\tsetResult({ error });\n\t\t\t\t\t}\n\t\t\t\t})();\n\t\t\t},\n\t\t\t(error: Error) => {\n\t\t\t\tsetResult({ error });\n\t\t\t},\n\t\t);\n\t\treturn (): void => {\n\t\t\tif (client) {\n\t\t\t\tclient.clear();\n\t\t\t}\n\t\t};\n\t}, [iceServers, registrationInfo, setResult, membership, voipEnabled, user?._id, user?.extension, voipRetryCount, enableKeepAlive, isEE]);\n\n\treturn result;\n};\n\nexport const isOutboundClient = (client: VoIPUser | undefined): client is EEVoipClient => client instanceof EEVoipClient;\n"]},"targets":{"android":"125.0.0","chrome":"125.0.0","edge":"125.0.0","firefox":"115.0.0","ie":"10.0.0","ios":"17.4.0","opera":"110.0.0","opera_mobile":"80.0.0","safari":"17.4.0","samsung":"24.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor","root":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":true,"enforceStrictMode":false,"dynamicImport":true},"externalDependencies":[]},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"version":"7.17.2","helpers":true,"useESModules":false,"corejs":false},"externalDependencies":[]},{"key":"proposal-class-properties","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true},"externalDependencies":[]},{"key":"base$0$3","visitor":{"FunctionExpression":{"exit":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"base$0$4","visitor":{"ForInStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-react-jsx","visitor":{"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXFragment":{"exit":[null]},"JSXElement":{"exit":[null]},"JSXAttribute":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false},"externalDependencies":[]},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-nullish-coalescing-operator","visitor":{"LogicalExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-optional-chaining","visitor":{"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-optional-catch-binding","visitor":{"CatchClause":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-class-properties","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-async-generator-functions","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-logical-assignment-operators","visitor":{"AssignmentExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-arrow-functions","visitor":{"ArrowFunctionExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-block-scoped-functions","visitor":{"BlockStatement":{"enter":[null]},"SwitchCase":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-block-scoping","visitor":{"VariableDeclaration":{"enter":[null,null]},"BlockStatement":{"enter":[null]},"SwitchCase":{"enter":[null]},"ClassDeclaration":{"enter":[null]},"DoWhileStatement":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForStatement":{"enter":[null]},"WhileStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-classes","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"ClassDeclaration":{"enter":[null]},"ClassExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"loose":true},"externalDependencies":[]},{"key":"transform-computed-properties","visitor":{"ObjectExpression":{"exit":[null]},"_exploded":true,"_verified":true},"options":{"loose":true},"externalDependencies":[]},{"key":"transform-destructuring","visitor":{"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"VariableDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"transform-for-of","visitor":{"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"loose":true},"externalDependencies":[]},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-object-super","visitor":{"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true,"DoWhileStatement":{"exit":[null]},"ForInStatement":{"exit":[null]},"ForStatement":{"exit":[null]},"WhileStatement":{"exit":[null]},"ForOfStatement":{"exit":[null]}},"options":{},"externalDependencies":[]},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"transform-shorthand-properties","visitor":{"ObjectMethod":{"enter":[null]},"ObjectProperty":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-spread","visitor":{"ArrayExpression":{"enter":[null]},"CallExpression":{"enter":[null]},"NewExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-sticky-regex","visitor":{"RegExpLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"loose":true},"externalDependencies":[]},{"key":"transform-typeof-symbol","visitor":{"UnaryExpression":{"enter":[null]},"_exploded":true,"_verified":true,"BlockStatement":{"enter":[null]},"CatchClause":{"enter":[null]},"DoWhileStatement":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForStatement":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"Program":{"enter":[null]},"ObjectMethod":{"enter":[null]},"SwitchStatement":{"enter":[null]},"WhileStatement":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]},"ForOfStatement":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"StaticBlock":{"enter":[null]},"TSModuleBlock":{"enter":[null]},"AssignmentPattern":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectPattern":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"transform-unicode-regex","visitor":{"RegExpLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-property-literals","visitor":{"ObjectProperty":{"exit":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-regenerator","visitor":{"ObjectMethod":{"enter":[null],"exit":[null]},"ClassMethod":{"enter":[null],"exit":[null]},"ClassPrivateMethod":{"enter":[null],"exit":[null]},"FunctionDeclaration":{"exit":[null]},"FunctionExpression":{"exit":[null]},"ArrowFunctionExpression":{"exit":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]}],"presets":[],"generatorOpts":{"filename":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/client/hooks/useVoipClient.ts","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"client/hooks/useVoipClient.ts","inputSourceMap":{"version":3,"file":"client/hooks/useVoipClient.ts","sourceRoot":"","sources":["client/hooks/useVoipClient.ts"],"names":[],"mappings":"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","sourcesContent":["import type { IRegistrationInfo } from '@rocket.chat/core-typings';\nimport { WorkflowTypes } from '@rocket.chat/core-typings';\nimport { useSafely } from '@rocket.chat/fuselage-hooks';\nimport { useUser, useSetting, useEndpoint, useStream } from '@rocket.chat/ui-contexts';\nimport { KJUR } from 'jsrsasign';\nimport { useEffect, useState } from 'react';\n\nimport { EEVoipClient } from '../lib/voip/EEVoipClient';\nimport { VoIPUser } from '../lib/voip/VoIPUser';\nimport { useWebRtcServers } from '../providers/CallProvider/hooks/useWebRtcServers';\nimport { useHasLicenseModule } from './useHasLicenseModule';\n\ntype UseVoipClientResult = {\n\tvoipClient?: VoIPUser;\n\tregistrationInfo?: IRegistrationInfo;\n\terror?: Error | unknown;\n};\n\nconst empty = {};\n\nconst isSignedResponse = (data: any): data is { result: string } => typeof data?.result === 'string';\n\n// Currently we only support the websocket connection and the SIP proxy connection being from the same host,\n// we need to add a new setting for SIP proxy if we want to support different hosts for them.\nexport const useVoipClient = (): UseVoipClientResult => {\n\tconst settingVoipEnabled = Boolean(useSetting('VoIP_Enabled'));\n\n\tconst [voipConnectorEnabled, setVoipConnectorEnabled] = useSafely(useState(true));\n\n\tconst voipRetryCount = useSetting('VoIP_Retry_Count');\n\tconst enableKeepAlive = useSetting('VoIP_Enable_Keep_Alive_For_Unstable_Networks');\n\tconst registrationInfo = useEndpoint('GET', '/v1/connector.extension.getRegistrationInfoByUserId');\n\tconst membership = useEndpoint('GET', '/v1/voip/queues.getMembershipSubscription');\n\tconst user = useUser();\n\tconst subscribeToNotifyLoggedIn = useStream('notify-logged');\n\tconst iceServers = useWebRtcServers();\n\tconst [result, setResult] = useSafely(useState<UseVoipClientResult>({}));\n\n\tconst isEE = useHasLicenseModule('voip-enterprise');\n\tconst voipEnabled = settingVoipEnabled && voipConnectorEnabled;\n\n\tuseEffect(() => {\n\t\tif (user) {\n\t\t\treturn subscribeToNotifyLoggedIn(`voip.statuschanged`, (enabled: boolean): void => {\n\t\t\t\tsetVoipConnectorEnabled(enabled);\n\t\t\t});\n\t\t}\n\t}, [setResult, setVoipConnectorEnabled, subscribeToNotifyLoggedIn, user]);\n\n\tuseEffect(() => {\n\t\tconst uid = user?._id;\n\t\tconst userExtension = user?.extension;\n\n\t\tif (!uid || !userExtension || !voipEnabled) {\n\t\t\tsetResult(empty);\n\t\t\treturn;\n\t\t}\n\t\tlet client: VoIPUser;\n\t\tregistrationInfo({ id: uid }).then(\n\t\t\t(data) => {\n\t\t\t\tlet parsedData: IRegistrationInfo;\n\t\t\t\tif (isSignedResponse(data)) {\n\t\t\t\t\tconst result = KJUR.jws.JWS.parse(data.result);\n\t\t\t\t\tparsedData = (result.payloadObj as any)?.context as IRegistrationInfo;\n\t\t\t\t} else {\n\t\t\t\t\tparsedData = data;\n\t\t\t\t}\n\n\t\t\t\tconst {\n\t\t\t\t\textensionDetails: { extension, password },\n\t\t\t\t\tcallServerConfig: { websocketPath },\n\t\t\t\t} = parsedData;\n\n\t\t\t\t(async (): Promise<void> => {\n\t\t\t\t\ttry {\n\t\t\t\t\t\tconst wsURL = new URL(websocketPath);\n\t\t\t\t\t\tconst subscription = await membership({ extension });\n\n\t\t\t\t\t\tconst config = {\n\t\t\t\t\t\t\tauthUserName: extension,\n\t\t\t\t\t\t\tauthPassword: password,\n\t\t\t\t\t\t\tsipRegistrarHostnameOrIP: wsURL.host,\n\t\t\t\t\t\t\twebSocketURI: websocketPath,\n\t\t\t\t\t\t\tenableVideo: true,\n\t\t\t\t\t\t\ticeServers,\n\t\t\t\t\t\t\tconnectionRetryCount: Number(voipRetryCount),\n\t\t\t\t\t\t\tenableKeepAliveUsingOptionsForUnstableNetworks: Boolean(enableKeepAlive),\n\t\t\t\t\t\t};\n\n\t\t\t\t\t\tclient = await (isEE ? EEVoipClient.create(config) : VoIPUser.create(config));\n\n\t\t\t\t\t\t// Today we are hardcoding workflow mode.\n\t\t\t\t\t\t// In future, this should be ready from configuration\n\t\t\t\t\t\tclient.setWorkflowMode(WorkflowTypes.CONTACT_CENTER_USER);\n\t\t\t\t\t\tclient.setMembershipSubscription(subscription);\n\t\t\t\t\t\tsetResult({ voipClient: client, registrationInfo: parsedData });\n\t\t\t\t\t} catch (error) {\n\t\t\t\t\t\tsetResult({ error });\n\t\t\t\t\t}\n\t\t\t\t})();\n\t\t\t},\n\t\t\t(error: Error) => {\n\t\t\t\tsetResult({ error });\n\t\t\t},\n\t\t);\n\t\treturn (): void => {\n\t\t\tif (client) {\n\t\t\t\tclient.clear();\n\t\t\t}\n\t\t};\n\t}, [iceServers, registrationInfo, setResult, membership, voipEnabled, user?._id, user?.extension, voipRetryCount, enableKeepAlive, isEE]);\n\n\treturn result;\n};\n\nexport const isOutboundClient = (client: VoIPUser | undefined): client is EEVoipClient => client instanceof EEVoipClient;\n"]}}},"code":"var _regeneratorRuntime;\nmodule.link(\"@babel/runtime/regenerator\", {\n  default: function (v) {\n    _regeneratorRuntime = v;\n  }\n}, 0);\nvar _slicedToArray;\nmodule.link(\"@babel/runtime/helpers/slicedToArray\", {\n  default: function (v) {\n    _slicedToArray = v;\n  }\n}, 1);\nmodule.export({\n  useVoipClient: function () {\n    return useVoipClient;\n  },\n  isOutboundClient: function () {\n    return isOutboundClient;\n  }\n});\nvar WorkflowTypes;\nmodule.link(\"@rocket.chat/core-typings\", {\n  WorkflowTypes: function (v) {\n    WorkflowTypes = v;\n  }\n}, 0);\nvar useSafely;\nmodule.link(\"@rocket.chat/fuselage-hooks\", {\n  useSafely: function (v) {\n    useSafely = v;\n  }\n}, 1);\nvar useUser, useSetting, useEndpoint, useStream;\nmodule.link(\"@rocket.chat/ui-contexts\", {\n  useUser: function (v) {\n    useUser = v;\n  },\n  useSetting: function (v) {\n    useSetting = v;\n  },\n  useEndpoint: function (v) {\n    useEndpoint = v;\n  },\n  useStream: function (v) {\n    useStream = v;\n  }\n}, 2);\nvar KJUR;\nmodule.link(\"jsrsasign\", {\n  KJUR: function (v) {\n    KJUR = v;\n  }\n}, 3);\nvar useEffect, useState;\nmodule.link(\"react\", {\n  useEffect: function (v) {\n    useEffect = v;\n  },\n  useState: function (v) {\n    useState = v;\n  }\n}, 4);\nvar EEVoipClient;\nmodule.link(\"../lib/voip/EEVoipClient\", {\n  EEVoipClient: function (v) {\n    EEVoipClient = v;\n  }\n}, 5);\nvar VoIPUser;\nmodule.link(\"../lib/voip/VoIPUser\", {\n  VoIPUser: function (v) {\n    VoIPUser = v;\n  }\n}, 6);\nvar useWebRtcServers;\nmodule.link(\"../providers/CallProvider/hooks/useWebRtcServers\", {\n  useWebRtcServers: function (v) {\n    useWebRtcServers = v;\n  }\n}, 7);\nvar useHasLicenseModule;\nmodule.link(\"./useHasLicenseModule\", {\n  useHasLicenseModule: function (v) {\n    useHasLicenseModule = v;\n  }\n}, 8);\nvar empty = {};\nvar isSignedResponse = function (data) {\n  return typeof (data === null || data === void 0 ? void 0 : data.result) === 'string';\n};\n// Currently we only support the websocket connection and the SIP proxy connection being from the same host,\n// we need to add a new setting for SIP proxy if we want to support different hosts for them.\nvar useVoipClient = function () {\n  var settingVoipEnabled = Boolean(useSetting('VoIP_Enabled'));\n  var _useSafely = useSafely(useState(true)),\n    _useSafely2 = _slicedToArray(_useSafely, 2),\n    voipConnectorEnabled = _useSafely2[0],\n    setVoipConnectorEnabled = _useSafely2[1];\n  var voipRetryCount = useSetting('VoIP_Retry_Count');\n  var enableKeepAlive = useSetting('VoIP_Enable_Keep_Alive_For_Unstable_Networks');\n  var registrationInfo = useEndpoint('GET', '/v1/connector.extension.getRegistrationInfoByUserId');\n  var membership = useEndpoint('GET', '/v1/voip/queues.getMembershipSubscription');\n  var user = useUser();\n  var subscribeToNotifyLoggedIn = useStream('notify-logged');\n  var iceServers = useWebRtcServers();\n  var _useSafely3 = useSafely(useState({})),\n    _useSafely4 = _slicedToArray(_useSafely3, 2),\n    result = _useSafely4[0],\n    setResult = _useSafely4[1];\n  var isEE = useHasLicenseModule('voip-enterprise');\n  var voipEnabled = settingVoipEnabled && voipConnectorEnabled;\n  useEffect(function () {\n    if (user) {\n      return subscribeToNotifyLoggedIn(\"voip.statuschanged\", function (enabled) {\n        setVoipConnectorEnabled(enabled);\n      });\n    }\n  }, [setResult, setVoipConnectorEnabled, subscribeToNotifyLoggedIn, user]);\n  useEffect(function () {\n    var uid = user === null || user === void 0 ? void 0 : user._id;\n    var userExtension = user === null || user === void 0 ? void 0 : user.extension;\n    if (!uid || !userExtension || !voipEnabled) {\n      setResult(empty);\n      return;\n    }\n    var client;\n    registrationInfo({\n      id: uid\n    }).then(function (data) {\n      var parsedData;\n      if (isSignedResponse(data)) {\n        var _result$payloadObj;\n        var _result = KJUR.jws.JWS.parse(data.result);\n        parsedData = (_result$payloadObj = _result.payloadObj) === null || _result$payloadObj === void 0 ? void 0 : _result$payloadObj.context;\n      } else {\n        parsedData = data;\n      }\n      var _parsedData = parsedData,\n        _parsedData$extension = _parsedData.extensionDetails,\n        extension = _parsedData$extension.extension,\n        password = _parsedData$extension.password,\n        websocketPath = _parsedData.callServerConfig.websocketPath;\n      (function () {\n        function _callee() {\n          var wsURL, subscription, config;\n          return _regeneratorRuntime.async(function () {\n            function _callee$(_context) {\n              while (1) switch (_context.prev = _context.next) {\n                case 0:\n                  _context.prev = 0;\n                  wsURL = new URL(websocketPath);\n                  _context.next = 4;\n                  return _regeneratorRuntime.awrap(membership({\n                    extension: extension\n                  }));\n                case 4:\n                  subscription = _context.sent;\n                  config = {\n                    authUserName: extension,\n                    authPassword: password,\n                    sipRegistrarHostnameOrIP: wsURL.host,\n                    webSocketURI: websocketPath,\n                    enableVideo: true,\n                    iceServers: iceServers,\n                    connectionRetryCount: Number(voipRetryCount),\n                    enableKeepAliveUsingOptionsForUnstableNetworks: Boolean(enableKeepAlive)\n                  };\n                  _context.next = 8;\n                  return _regeneratorRuntime.awrap(isEE ? EEVoipClient.create(config) : VoIPUser.create(config));\n                case 8:\n                  client = _context.sent;\n                  // Today we are hardcoding workflow mode.\n                  // In future, this should be ready from configuration\n                  client.setWorkflowMode(WorkflowTypes.CONTACT_CENTER_USER);\n                  client.setMembershipSubscription(subscription);\n                  setResult({\n                    voipClient: client,\n                    registrationInfo: parsedData\n                  });\n                  _context.next = 17;\n                  break;\n                case 14:\n                  _context.prev = 14;\n                  _context.t0 = _context[\"catch\"](0);\n                  setResult({\n                    error: _context.t0\n                  });\n                case 17:\n                case \"end\":\n                  return _context.stop();\n              }\n            }\n            return _callee$;\n          }(), null, null, [[0, 14]], Promise);\n        }\n        return _callee;\n      })()();\n    }, function (error) {\n      setResult({\n        error: error\n      });\n    });\n    return function () {\n      if (client) {\n        client.clear();\n      }\n    };\n  }, [iceServers, registrationInfo, setResult, membership, voipEnabled, user === null || user === void 0 ? void 0 : user._id, user === null || user === void 0 ? void 0 : user.extension, voipRetryCount, enableKeepAlive, isEE]);\n  return result;\n};\nvar isOutboundClient = function (client) {\n  return client instanceof EEVoipClient;\n};","map":{"version":3,"names":["_regeneratorRuntime","module","link","default","v","_slicedToArray","export","useVoipClient","isOutboundClient","WorkflowTypes","useSafely","useUser","useSetting","useEndpoint","useStream","KJUR","useEffect","useState","EEVoipClient","VoIPUser","useWebRtcServers","useHasLicenseModule","empty","isSignedResponse","data","result","settingVoipEnabled","Boolean","_useSafely","_useSafely2","voipConnectorEnabled","setVoipConnectorEnabled","voipRetryCount","enableKeepAlive","registrationInfo","membership","user","subscribeToNotifyLoggedIn","iceServers","_useSafely3","_useSafely4","setResult","isEE","voipEnabled","enabled","uid","_id","userExtension","extension","client","id","then","parsedData","_result$payloadObj","jws","JWS","parse","payloadObj","context","_parsedData","_parsedData$extension","extensionDetails","password","websocketPath","callServerConfig","_callee","wsURL","subscription","config","async","_callee$","_context","prev","next","URL","awrap","sent","authUserName","authPassword","sipRegistrarHostnameOrIP","host","webSocketURI","enableVideo","connectionRetryCount","Number","enableKeepAliveUsingOptionsForUnstableNetworks","create","setWorkflowMode","CONTACT_CENTER_USER","setMembershipSubscription","voipClient","t0","error","stop","Promise","clear"],"sources":["client/hooks/useVoipClient.ts"],"sourcesContent":["import type { IRegistrationInfo } from '@rocket.chat/core-typings';\nimport { WorkflowTypes } from '@rocket.chat/core-typings';\nimport { useSafely } from '@rocket.chat/fuselage-hooks';\nimport { useUser, useSetting, useEndpoint, useStream } from '@rocket.chat/ui-contexts';\nimport { KJUR } from 'jsrsasign';\nimport { useEffect, useState } from 'react';\n\nimport { EEVoipClient } from '../lib/voip/EEVoipClient';\nimport { VoIPUser } from '../lib/voip/VoIPUser';\nimport { useWebRtcServers } from '../providers/CallProvider/hooks/useWebRtcServers';\nimport { useHasLicenseModule } from './useHasLicenseModule';\n\ntype UseVoipClientResult = {\n\tvoipClient?: VoIPUser;\n\tregistrationInfo?: IRegistrationInfo;\n\terror?: Error | unknown;\n};\n\nconst empty = {};\n\nconst isSignedResponse = (data: any): data is { result: string } => typeof data?.result === 'string';\n\n// Currently we only support the websocket connection and the SIP proxy connection being from the same host,\n// we need to add a new setting for SIP proxy if we want to support different hosts for them.\nexport const useVoipClient = (): UseVoipClientResult => {\n\tconst settingVoipEnabled = Boolean(useSetting('VoIP_Enabled'));\n\n\tconst [voipConnectorEnabled, setVoipConnectorEnabled] = useSafely(useState(true));\n\n\tconst voipRetryCount = useSetting('VoIP_Retry_Count');\n\tconst enableKeepAlive = useSetting('VoIP_Enable_Keep_Alive_For_Unstable_Networks');\n\tconst registrationInfo = useEndpoint('GET', '/v1/connector.extension.getRegistrationInfoByUserId');\n\tconst membership = useEndpoint('GET', '/v1/voip/queues.getMembershipSubscription');\n\tconst user = useUser();\n\tconst subscribeToNotifyLoggedIn = useStream('notify-logged');\n\tconst iceServers = useWebRtcServers();\n\tconst [result, setResult] = useSafely(useState<UseVoipClientResult>({}));\n\n\tconst isEE = useHasLicenseModule('voip-enterprise');\n\tconst voipEnabled = settingVoipEnabled && voipConnectorEnabled;\n\n\tuseEffect(() => {\n\t\tif (user) {\n\t\t\treturn subscribeToNotifyLoggedIn(`voip.statuschanged`, (enabled: boolean): void => {\n\t\t\t\tsetVoipConnectorEnabled(enabled);\n\t\t\t});\n\t\t}\n\t}, [setResult, setVoipConnectorEnabled, subscribeToNotifyLoggedIn, user]);\n\n\tuseEffect(() => {\n\t\tconst uid = user?._id;\n\t\tconst userExtension = user?.extension;\n\n\t\tif (!uid || !userExtension || !voipEnabled) {\n\t\t\tsetResult(empty);\n\t\t\treturn;\n\t\t}\n\t\tlet client: VoIPUser;\n\t\tregistrationInfo({ id: uid }).then(\n\t\t\t(data) => {\n\t\t\t\tlet parsedData: IRegistrationInfo;\n\t\t\t\tif (isSignedResponse(data)) {\n\t\t\t\t\tconst result = KJUR.jws.JWS.parse(data.result);\n\t\t\t\t\tparsedData = (result.payloadObj as any)?.context as IRegistrationInfo;\n\t\t\t\t} else {\n\t\t\t\t\tparsedData = data;\n\t\t\t\t}\n\n\t\t\t\tconst {\n\t\t\t\t\textensionDetails: { extension, password },\n\t\t\t\t\tcallServerConfig: { websocketPath },\n\t\t\t\t} = parsedData;\n\n\t\t\t\t(async (): Promise<void> => {\n\t\t\t\t\ttry {\n\t\t\t\t\t\tconst wsURL = new URL(websocketPath);\n\t\t\t\t\t\tconst subscription = await membership({ extension });\n\n\t\t\t\t\t\tconst config = {\n\t\t\t\t\t\t\tauthUserName: extension,\n\t\t\t\t\t\t\tauthPassword: password,\n\t\t\t\t\t\t\tsipRegistrarHostnameOrIP: wsURL.host,\n\t\t\t\t\t\t\twebSocketURI: websocketPath,\n\t\t\t\t\t\t\tenableVideo: true,\n\t\t\t\t\t\t\ticeServers,\n\t\t\t\t\t\t\tconnectionRetryCount: Number(voipRetryCount),\n\t\t\t\t\t\t\tenableKeepAliveUsingOptionsForUnstableNetworks: Boolean(enableKeepAlive),\n\t\t\t\t\t\t};\n\n\t\t\t\t\t\tclient = await (isEE ? EEVoipClient.create(config) : VoIPUser.create(config));\n\n\t\t\t\t\t\t// Today we are hardcoding workflow mode.\n\t\t\t\t\t\t// In future, this should be ready from configuration\n\t\t\t\t\t\tclient.setWorkflowMode(WorkflowTypes.CONTACT_CENTER_USER);\n\t\t\t\t\t\tclient.setMembershipSubscription(subscription);\n\t\t\t\t\t\tsetResult({ voipClient: client, registrationInfo: parsedData });\n\t\t\t\t\t} catch (error) {\n\t\t\t\t\t\tsetResult({ error });\n\t\t\t\t\t}\n\t\t\t\t})();\n\t\t\t},\n\t\t\t(error: Error) => {\n\t\t\t\tsetResult({ error });\n\t\t\t},\n\t\t);\n\t\treturn (): void => {\n\t\t\tif (client) {\n\t\t\t\tclient.clear();\n\t\t\t}\n\t\t};\n\t}, [iceServers, registrationInfo, setResult, membership, voipEnabled, user?._id, user?.extension, voipRetryCount, enableKeepAlive, isEE]);\n\n\treturn result;\n};\n\nexport const isOutboundClient = (client: VoIPUser | undefined): client is EEVoipClient => client instanceof EEVoipClient;\n"],"mappings":"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","ignoreList":[]},"sourceType":"module","externalDependencies":{},"hash":"6b13ef7e8be1d048ad0cbce2c8b49129a94f7cff"}
