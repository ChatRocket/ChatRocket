{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/client/startup/notifications/konchatNotifications.ts","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","topLevelAwait","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"web.browser.legacy"},"sourceFileName":"client/startup/notifications/konchatNotifications.ts","filename":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/client/startup/notifications/konchatNotifications.ts","inputSourceMap":{"version":3,"file":"client/startup/notifications/konchatNotifications.ts","sourceRoot":"","sources":["client/startup/notifications/konchatNotifications.ts"],"names":[],"mappings":"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","sourcesContent":["import type { AtLeast, ISubscription, IUser, ICalendarNotification } from '@rocket.chat/core-typings';\nimport { Meteor } from 'meteor/meteor';\nimport { Tracker } from 'meteor/tracker';\nimport { lazy } from 'react';\n\nimport { CachedChatSubscription } from '../../../app/models/client';\nimport { settings } from '../../../app/settings/client';\nimport { KonchatNotification } from '../../../app/ui/client/lib/KonchatNotification';\nimport { getUserPreference } from '../../../app/utils/client';\nimport { sdk } from '../../../app/utils/client/lib/SDKClient';\nimport { RoomManager } from '../../lib/RoomManager';\nimport { imperativeModal } from '../../lib/imperativeModal';\nimport { fireGlobalEvent } from '../../lib/utils/fireGlobalEvent';\nimport { isLayoutEmbedded } from '../../lib/utils/isLayoutEmbedded';\nimport { router } from '../../providers/RouterProvider';\n\nconst OutlookCalendarEventModal = lazy(() => import('../../views/outlookCalendar/OutlookCalendarEventModal'));\n\nconst notifyNewRoom = async (sub: AtLeast<ISubscription, 'rid'>): Promise<void> => {\n\tconst user = Meteor.user() as IUser | null;\n\tif (!user || user.status === 'busy') {\n\t\treturn;\n\t}\n\n\tif ((!router.getRouteParameters().name || router.getRouteParameters().name !== sub.name) && !sub.ls && sub.alert === true) {\n\t\tKonchatNotification.newRoom(sub.rid);\n\t}\n};\n\nfunction notifyNewMessageAudio(rid?: string): void {\n\t// This logic is duplicated in /client/startup/unread.coffee.\n\tconst hasFocus = document.hasFocus();\n\tconst messageIsInOpenedRoom = RoomManager.opened === rid;\n\tconst muteFocusedConversations = getUserPreference(Meteor.userId(), 'muteFocusedConversations');\n\n\tif (isLayoutEmbedded()) {\n\t\tif (!hasFocus && messageIsInOpenedRoom) {\n\t\t\t// Play a notification sound\n\t\t\tvoid KonchatNotification.newMessage(rid);\n\t\t}\n\t} else if (!hasFocus || !messageIsInOpenedRoom || !muteFocusedConversations) {\n\t\t// Play a notification sound\n\t\tvoid KonchatNotification.newMessage(rid);\n\t}\n}\n\nMeteor.startup(() => {\n\tconst notifyUserCalendar = async function (notification: ICalendarNotification): Promise<void> {\n\t\tconst user = Meteor.user() as IUser | null;\n\t\tif (!user || user.status === 'busy') {\n\t\t\treturn;\n\t\t}\n\n\t\tconst requireInteraction = getUserPreference<boolean>(Meteor.userId(), 'desktopNotificationRequireInteraction');\n\n\t\tconst n = new Notification(notification.title, {\n\t\t\tbody: notification.text,\n\t\t\ttag: notification.payload._id,\n\t\t\tsilent: true,\n\t\t\trequireInteraction,\n\t\t} as NotificationOptions);\n\n\t\tn.onclick = function () {\n\t\t\tthis.close();\n\t\t\twindow.focus();\n\t\t\timperativeModal.open({\n\t\t\t\tcomponent: OutlookCalendarEventModal,\n\t\t\t\tprops: { id: notification.payload._id, onClose: imperativeModal.close, onCancel: imperativeModal.close },\n\t\t\t});\n\t\t};\n\t};\n\tTracker.autorun(() => {\n\t\tif (!Meteor.userId() || !settings.get('Outlook_Calendar_Enabled')) {\n\t\t\tsdk.stop('notify-user', `${Meteor.userId()}/calendar`);\n\t\t\treturn;\n\t\t}\n\n\t\tsdk.stream('notify-user', [`${Meteor.userId()}/calendar`], notifyUserCalendar);\n\t});\n\n\tTracker.autorun(() => {\n\t\tif (!Meteor.userId()) {\n\t\t\treturn;\n\t\t}\n\n\t\tsdk.stream('notify-user', [`${Meteor.userId()}/notification`], (notification) => {\n\t\t\tconst openedRoomId = ['channel', 'group', 'direct'].includes(router.getRouteName()!) ? RoomManager.opened : undefined;\n\n\t\t\t// This logic is duplicated in /client/startup/unread.coffee.\n\t\t\tconst hasFocus = document.hasFocus();\n\t\t\tconst messageIsInOpenedRoom = openedRoomId === notification.payload.rid;\n\n\t\t\tfireGlobalEvent('notification', {\n\t\t\t\tnotification,\n\t\t\t\tfromOpenedRoom: messageIsInOpenedRoom,\n\t\t\t\thasFocus,\n\t\t\t});\n\n\t\t\tif (isLayoutEmbedded()) {\n\t\t\t\tif (!hasFocus && messageIsInOpenedRoom) {\n\t\t\t\t\t// Show a notification.\n\t\t\t\t\tKonchatNotification.showDesktop(notification);\n\t\t\t\t}\n\t\t\t} else if (!hasFocus || !messageIsInOpenedRoom) {\n\t\t\t\t// Show a notification.\n\t\t\t\tKonchatNotification.showDesktop(notification);\n\t\t\t}\n\n\t\t\tnotifyNewMessageAudio(notification.payload.rid);\n\t\t});\n\n\t\tCachedChatSubscription.on('changed', (sub): void => {\n\t\t\tvoid notifyNewRoom(sub);\n\t\t});\n\n\t\tsdk.stream('notify-user', [`${Meteor.userId()}/subscriptions-changed`], (action, sub) => {\n\t\t\tif (action === 'removed') {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tvoid notifyNewRoom(sub);\n\t\t});\n\t});\n});\n"]},"targets":{"android":"125.0.0","chrome":"125.0.0","edge":"125.0.0","firefox":"115.0.0","ie":"10.0.0","ios":"17.4.0","opera":"110.0.0","opera_mobile":"80.0.0","safari":"17.4.0","samsung":"24.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor","root":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":true,"enforceStrictMode":false,"dynamicImport":true},"externalDependencies":[]},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"version":"7.17.2","helpers":true,"useESModules":false,"corejs":false},"externalDependencies":[]},{"key":"proposal-class-properties","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true},"externalDependencies":[]},{"key":"base$0$3","visitor":{"FunctionExpression":{"exit":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"base$0$4","visitor":{"ForInStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-react-jsx","visitor":{"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXFragment":{"exit":[null]},"JSXElement":{"exit":[null]},"JSXAttribute":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false},"externalDependencies":[]},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-nullish-coalescing-operator","visitor":{"LogicalExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-optional-chaining","visitor":{"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-optional-catch-binding","visitor":{"CatchClause":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-class-properties","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-async-generator-functions","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-logical-assignment-operators","visitor":{"AssignmentExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-arrow-functions","visitor":{"ArrowFunctionExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-block-scoped-functions","visitor":{"BlockStatement":{"enter":[null]},"SwitchCase":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-block-scoping","visitor":{"VariableDeclaration":{"enter":[null,null]},"BlockStatement":{"enter":[null]},"SwitchCase":{"enter":[null]},"ClassDeclaration":{"enter":[null]},"DoWhileStatement":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForStatement":{"enter":[null]},"WhileStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-classes","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"ClassDeclaration":{"enter":[null]},"ClassExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"loose":true},"externalDependencies":[]},{"key":"transform-computed-properties","visitor":{"ObjectExpression":{"exit":[null]},"_exploded":true,"_verified":true},"options":{"loose":true},"externalDependencies":[]},{"key":"transform-destructuring","visitor":{"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"VariableDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"transform-for-of","visitor":{"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"loose":true},"externalDependencies":[]},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-object-super","visitor":{"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true,"DoWhileStatement":{"exit":[null]},"ForInStatement":{"exit":[null]},"ForStatement":{"exit":[null]},"WhileStatement":{"exit":[null]},"ForOfStatement":{"exit":[null]}},"options":{},"externalDependencies":[]},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"transform-shorthand-properties","visitor":{"ObjectMethod":{"enter":[null]},"ObjectProperty":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-spread","visitor":{"ArrayExpression":{"enter":[null]},"CallExpression":{"enter":[null]},"NewExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-sticky-regex","visitor":{"RegExpLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"loose":true},"externalDependencies":[]},{"key":"transform-typeof-symbol","visitor":{"UnaryExpression":{"enter":[null]},"_exploded":true,"_verified":true,"BlockStatement":{"enter":[null]},"CatchClause":{"enter":[null]},"DoWhileStatement":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForStatement":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"Program":{"enter":[null]},"ObjectMethod":{"enter":[null]},"SwitchStatement":{"enter":[null]},"WhileStatement":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]},"ForOfStatement":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"StaticBlock":{"enter":[null]},"TSModuleBlock":{"enter":[null]},"AssignmentPattern":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectPattern":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"transform-unicode-regex","visitor":{"RegExpLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-property-literals","visitor":{"ObjectProperty":{"exit":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-regenerator","visitor":{"ObjectMethod":{"enter":[null],"exit":[null]},"ClassMethod":{"enter":[null],"exit":[null]},"ClassPrivateMethod":{"enter":[null],"exit":[null]},"FunctionDeclaration":{"exit":[null]},"FunctionExpression":{"exit":[null]},"ArrowFunctionExpression":{"exit":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]}],"presets":[],"generatorOpts":{"filename":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/client/startup/notifications/konchatNotifications.ts","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"client/startup/notifications/konchatNotifications.ts","inputSourceMap":{"version":3,"file":"client/startup/notifications/konchatNotifications.ts","sourceRoot":"","sources":["client/startup/notifications/konchatNotifications.ts"],"names":[],"mappings":"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","sourcesContent":["import type { AtLeast, ISubscription, IUser, ICalendarNotification } from '@rocket.chat/core-typings';\nimport { Meteor } from 'meteor/meteor';\nimport { Tracker } from 'meteor/tracker';\nimport { lazy } from 'react';\n\nimport { CachedChatSubscription } from '../../../app/models/client';\nimport { settings } from '../../../app/settings/client';\nimport { KonchatNotification } from '../../../app/ui/client/lib/KonchatNotification';\nimport { getUserPreference } from '../../../app/utils/client';\nimport { sdk } from '../../../app/utils/client/lib/SDKClient';\nimport { RoomManager } from '../../lib/RoomManager';\nimport { imperativeModal } from '../../lib/imperativeModal';\nimport { fireGlobalEvent } from '../../lib/utils/fireGlobalEvent';\nimport { isLayoutEmbedded } from '../../lib/utils/isLayoutEmbedded';\nimport { router } from '../../providers/RouterProvider';\n\nconst OutlookCalendarEventModal = lazy(() => import('../../views/outlookCalendar/OutlookCalendarEventModal'));\n\nconst notifyNewRoom = async (sub: AtLeast<ISubscription, 'rid'>): Promise<void> => {\n\tconst user = Meteor.user() as IUser | null;\n\tif (!user || user.status === 'busy') {\n\t\treturn;\n\t}\n\n\tif ((!router.getRouteParameters().name || router.getRouteParameters().name !== sub.name) && !sub.ls && sub.alert === true) {\n\t\tKonchatNotification.newRoom(sub.rid);\n\t}\n};\n\nfunction notifyNewMessageAudio(rid?: string): void {\n\t// This logic is duplicated in /client/startup/unread.coffee.\n\tconst hasFocus = document.hasFocus();\n\tconst messageIsInOpenedRoom = RoomManager.opened === rid;\n\tconst muteFocusedConversations = getUserPreference(Meteor.userId(), 'muteFocusedConversations');\n\n\tif (isLayoutEmbedded()) {\n\t\tif (!hasFocus && messageIsInOpenedRoom) {\n\t\t\t// Play a notification sound\n\t\t\tvoid KonchatNotification.newMessage(rid);\n\t\t}\n\t} else if (!hasFocus || !messageIsInOpenedRoom || !muteFocusedConversations) {\n\t\t// Play a notification sound\n\t\tvoid KonchatNotification.newMessage(rid);\n\t}\n}\n\nMeteor.startup(() => {\n\tconst notifyUserCalendar = async function (notification: ICalendarNotification): Promise<void> {\n\t\tconst user = Meteor.user() as IUser | null;\n\t\tif (!user || user.status === 'busy') {\n\t\t\treturn;\n\t\t}\n\n\t\tconst requireInteraction = getUserPreference<boolean>(Meteor.userId(), 'desktopNotificationRequireInteraction');\n\n\t\tconst n = new Notification(notification.title, {\n\t\t\tbody: notification.text,\n\t\t\ttag: notification.payload._id,\n\t\t\tsilent: true,\n\t\t\trequireInteraction,\n\t\t} as NotificationOptions);\n\n\t\tn.onclick = function () {\n\t\t\tthis.close();\n\t\t\twindow.focus();\n\t\t\timperativeModal.open({\n\t\t\t\tcomponent: OutlookCalendarEventModal,\n\t\t\t\tprops: { id: notification.payload._id, onClose: imperativeModal.close, onCancel: imperativeModal.close },\n\t\t\t});\n\t\t};\n\t};\n\tTracker.autorun(() => {\n\t\tif (!Meteor.userId() || !settings.get('Outlook_Calendar_Enabled')) {\n\t\t\tsdk.stop('notify-user', `${Meteor.userId()}/calendar`);\n\t\t\treturn;\n\t\t}\n\n\t\tsdk.stream('notify-user', [`${Meteor.userId()}/calendar`], notifyUserCalendar);\n\t});\n\n\tTracker.autorun(() => {\n\t\tif (!Meteor.userId()) {\n\t\t\treturn;\n\t\t}\n\n\t\tsdk.stream('notify-user', [`${Meteor.userId()}/notification`], (notification) => {\n\t\t\tconst openedRoomId = ['channel', 'group', 'direct'].includes(router.getRouteName()!) ? RoomManager.opened : undefined;\n\n\t\t\t// This logic is duplicated in /client/startup/unread.coffee.\n\t\t\tconst hasFocus = document.hasFocus();\n\t\t\tconst messageIsInOpenedRoom = openedRoomId === notification.payload.rid;\n\n\t\t\tfireGlobalEvent('notification', {\n\t\t\t\tnotification,\n\t\t\t\tfromOpenedRoom: messageIsInOpenedRoom,\n\t\t\t\thasFocus,\n\t\t\t});\n\n\t\t\tif (isLayoutEmbedded()) {\n\t\t\t\tif (!hasFocus && messageIsInOpenedRoom) {\n\t\t\t\t\t// Show a notification.\n\t\t\t\t\tKonchatNotification.showDesktop(notification);\n\t\t\t\t}\n\t\t\t} else if (!hasFocus || !messageIsInOpenedRoom) {\n\t\t\t\t// Show a notification.\n\t\t\t\tKonchatNotification.showDesktop(notification);\n\t\t\t}\n\n\t\t\tnotifyNewMessageAudio(notification.payload.rid);\n\t\t});\n\n\t\tCachedChatSubscription.on('changed', (sub): void => {\n\t\t\tvoid notifyNewRoom(sub);\n\t\t});\n\n\t\tsdk.stream('notify-user', [`${Meteor.userId()}/subscriptions-changed`], (action, sub) => {\n\t\t\tif (action === 'removed') {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tvoid notifyNewRoom(sub);\n\t\t});\n\t});\n});\n"]}}},"code":"var _regeneratorRuntime;\nmodule.link(\"@babel/runtime/regenerator\", {\n  default: function (v) {\n    _regeneratorRuntime = v;\n  }\n}, 0);\nvar Meteor;\nmodule.link(\"meteor/meteor\", {\n  Meteor: function (v) {\n    Meteor = v;\n  }\n}, 0);\nvar Tracker;\nmodule.link(\"meteor/tracker\", {\n  Tracker: function (v) {\n    Tracker = v;\n  }\n}, 1);\nvar lazy;\nmodule.link(\"react\", {\n  lazy: function (v) {\n    lazy = v;\n  }\n}, 2);\nvar CachedChatSubscription;\nmodule.link(\"../../../app/models/client\", {\n  CachedChatSubscription: function (v) {\n    CachedChatSubscription = v;\n  }\n}, 3);\nvar settings;\nmodule.link(\"../../../app/settings/client\", {\n  settings: function (v) {\n    settings = v;\n  }\n}, 4);\nvar KonchatNotification;\nmodule.link(\"../../../app/ui/client/lib/KonchatNotification\", {\n  KonchatNotification: function (v) {\n    KonchatNotification = v;\n  }\n}, 5);\nvar getUserPreference;\nmodule.link(\"../../../app/utils/client\", {\n  getUserPreference: function (v) {\n    getUserPreference = v;\n  }\n}, 6);\nvar sdk;\nmodule.link(\"../../../app/utils/client/lib/SDKClient\", {\n  sdk: function (v) {\n    sdk = v;\n  }\n}, 7);\nvar RoomManager;\nmodule.link(\"../../lib/RoomManager\", {\n  RoomManager: function (v) {\n    RoomManager = v;\n  }\n}, 8);\nvar imperativeModal;\nmodule.link(\"../../lib/imperativeModal\", {\n  imperativeModal: function (v) {\n    imperativeModal = v;\n  }\n}, 9);\nvar fireGlobalEvent;\nmodule.link(\"../../lib/utils/fireGlobalEvent\", {\n  fireGlobalEvent: function (v) {\n    fireGlobalEvent = v;\n  }\n}, 10);\nvar isLayoutEmbedded;\nmodule.link(\"../../lib/utils/isLayoutEmbedded\", {\n  isLayoutEmbedded: function (v) {\n    isLayoutEmbedded = v;\n  }\n}, 11);\nvar router;\nmodule.link(\"../../providers/RouterProvider\", {\n  router: function (v) {\n    router = v;\n  }\n}, 12);\nvar OutlookCalendarEventModal = /*#__PURE__*/lazy(function () {\n  return module.dynamicImport('../../views/outlookCalendar/OutlookCalendarEventModal');\n});\nvar notifyNewRoom = function () {\n  function _callee(sub) {\n    var user;\n    return _regeneratorRuntime.async(function () {\n      function _callee$(_context) {\n        while (1) switch (_context.prev = _context.next) {\n          case 0:\n            user = Meteor.user();\n            if (!(!user || user.status === 'busy')) {\n              _context.next = 3;\n              break;\n            }\n            return _context.abrupt(\"return\");\n          case 3:\n            if ((!router.getRouteParameters().name || router.getRouteParameters().name !== sub.name) && !sub.ls && sub.alert === true) {\n              KonchatNotification.newRoom(sub.rid);\n            }\n          case 4:\n          case \"end\":\n            return _context.stop();\n        }\n      }\n      return _callee$;\n    }(), null, null, null, Promise);\n  }\n  return _callee;\n}();\nfunction notifyNewMessageAudio(rid) {\n  // This logic is duplicated in /client/startup/unread.coffee.\n  var hasFocus = document.hasFocus();\n  var messageIsInOpenedRoom = RoomManager.opened === rid;\n  var muteFocusedConversations = getUserPreference(Meteor.userId(), 'muteFocusedConversations');\n  if (isLayoutEmbedded()) {\n    if (!hasFocus && messageIsInOpenedRoom) {\n      // Play a notification sound\n      void KonchatNotification.newMessage(rid);\n    }\n  } else if (!hasFocus || !messageIsInOpenedRoom || !muteFocusedConversations) {\n    // Play a notification sound\n    void KonchatNotification.newMessage(rid);\n  }\n}\nMeteor.startup(function () {\n  var notifyUserCalendar = function () {\n    function _callee2(notification) {\n      var user, requireInteraction, n;\n      return _regeneratorRuntime.async(function () {\n        function _callee2$(_context2) {\n          while (1) switch (_context2.prev = _context2.next) {\n            case 0:\n              user = Meteor.user();\n              if (!(!user || user.status === 'busy')) {\n                _context2.next = 3;\n                break;\n              }\n              return _context2.abrupt(\"return\");\n            case 3:\n              requireInteraction = getUserPreference(Meteor.userId(), 'desktopNotificationRequireInteraction');\n              n = new Notification(notification.title, {\n                body: notification.text,\n                tag: notification.payload._id,\n                silent: true,\n                requireInteraction: requireInteraction\n              });\n              n.onclick = function () {\n                this.close();\n                window.focus();\n                imperativeModal.open({\n                  component: OutlookCalendarEventModal,\n                  props: {\n                    id: notification.payload._id,\n                    onClose: imperativeModal.close,\n                    onCancel: imperativeModal.close\n                  }\n                });\n              };\n            case 6:\n            case \"end\":\n              return _context2.stop();\n          }\n        }\n        return _callee2$;\n      }(), null, null, null, Promise);\n    }\n    return _callee2;\n  }();\n  Tracker.autorun(function () {\n    if (!Meteor.userId() || !settings.get('Outlook_Calendar_Enabled')) {\n      sdk.stop('notify-user', Meteor.userId() + \"/calendar\");\n      return;\n    }\n    sdk.stream('notify-user', [Meteor.userId() + \"/calendar\"], notifyUserCalendar);\n  });\n  Tracker.autorun(function () {\n    if (!Meteor.userId()) {\n      return;\n    }\n    sdk.stream('notify-user', [Meteor.userId() + \"/notification\"], function (notification) {\n      var openedRoomId = ['channel', 'group', 'direct'].includes(router.getRouteName()) ? RoomManager.opened : undefined;\n      // This logic is duplicated in /client/startup/unread.coffee.\n      var hasFocus = document.hasFocus();\n      var messageIsInOpenedRoom = openedRoomId === notification.payload.rid;\n      fireGlobalEvent('notification', {\n        notification: notification,\n        fromOpenedRoom: messageIsInOpenedRoom,\n        hasFocus: hasFocus\n      });\n      if (isLayoutEmbedded()) {\n        if (!hasFocus && messageIsInOpenedRoom) {\n          // Show a notification.\n          KonchatNotification.showDesktop(notification);\n        }\n      } else if (!hasFocus || !messageIsInOpenedRoom) {\n        // Show a notification.\n        KonchatNotification.showDesktop(notification);\n      }\n      notifyNewMessageAudio(notification.payload.rid);\n    });\n    CachedChatSubscription.on('changed', function (sub) {\n      void notifyNewRoom(sub);\n    });\n    sdk.stream('notify-user', [Meteor.userId() + \"/subscriptions-changed\"], function (action, sub) {\n      if (action === 'removed') {\n        return;\n      }\n      void notifyNewRoom(sub);\n    });\n  });\n});","map":{"version":3,"names":["_regeneratorRuntime","module","link","default","v","Meteor","Tracker","lazy","CachedChatSubscription","settings","KonchatNotification","getUserPreference","sdk","RoomManager","imperativeModal","fireGlobalEvent","isLayoutEmbedded","router","OutlookCalendarEventModal","dynamicImport","notifyNewRoom","_callee","sub","user","async","_callee$","_context","prev","next","status","abrupt","getRouteParameters","name","ls","alert","newRoom","rid","stop","Promise","notifyNewMessageAudio","hasFocus","document","messageIsInOpenedRoom","opened","muteFocusedConversations","userId","newMessage","startup","notifyUserCalendar","_callee2","notification","requireInteraction","n","_callee2$","_context2","Notification","title","body","text","tag","payload","_id","silent","onclick","close","window","focus","open","component","props","id","onClose","onCancel","autorun","get","stream","openedRoomId","includes","getRouteName","undefined","fromOpenedRoom","showDesktop","on","action"],"sources":["client/startup/notifications/konchatNotifications.ts"],"sourcesContent":["import type { AtLeast, ISubscription, IUser, ICalendarNotification } from '@rocket.chat/core-typings';\nimport { Meteor } from 'meteor/meteor';\nimport { Tracker } from 'meteor/tracker';\nimport { lazy } from 'react';\n\nimport { CachedChatSubscription } from '../../../app/models/client';\nimport { settings } from '../../../app/settings/client';\nimport { KonchatNotification } from '../../../app/ui/client/lib/KonchatNotification';\nimport { getUserPreference } from '../../../app/utils/client';\nimport { sdk } from '../../../app/utils/client/lib/SDKClient';\nimport { RoomManager } from '../../lib/RoomManager';\nimport { imperativeModal } from '../../lib/imperativeModal';\nimport { fireGlobalEvent } from '../../lib/utils/fireGlobalEvent';\nimport { isLayoutEmbedded } from '../../lib/utils/isLayoutEmbedded';\nimport { router } from '../../providers/RouterProvider';\n\nconst OutlookCalendarEventModal = lazy(() => import('../../views/outlookCalendar/OutlookCalendarEventModal'));\n\nconst notifyNewRoom = async (sub: AtLeast<ISubscription, 'rid'>): Promise<void> => {\n\tconst user = Meteor.user() as IUser | null;\n\tif (!user || user.status === 'busy') {\n\t\treturn;\n\t}\n\n\tif ((!router.getRouteParameters().name || router.getRouteParameters().name !== sub.name) && !sub.ls && sub.alert === true) {\n\t\tKonchatNotification.newRoom(sub.rid);\n\t}\n};\n\nfunction notifyNewMessageAudio(rid?: string): void {\n\t// This logic is duplicated in /client/startup/unread.coffee.\n\tconst hasFocus = document.hasFocus();\n\tconst messageIsInOpenedRoom = RoomManager.opened === rid;\n\tconst muteFocusedConversations = getUserPreference(Meteor.userId(), 'muteFocusedConversations');\n\n\tif (isLayoutEmbedded()) {\n\t\tif (!hasFocus && messageIsInOpenedRoom) {\n\t\t\t// Play a notification sound\n\t\t\tvoid KonchatNotification.newMessage(rid);\n\t\t}\n\t} else if (!hasFocus || !messageIsInOpenedRoom || !muteFocusedConversations) {\n\t\t// Play a notification sound\n\t\tvoid KonchatNotification.newMessage(rid);\n\t}\n}\n\nMeteor.startup(() => {\n\tconst notifyUserCalendar = async function (notification: ICalendarNotification): Promise<void> {\n\t\tconst user = Meteor.user() as IUser | null;\n\t\tif (!user || user.status === 'busy') {\n\t\t\treturn;\n\t\t}\n\n\t\tconst requireInteraction = getUserPreference<boolean>(Meteor.userId(), 'desktopNotificationRequireInteraction');\n\n\t\tconst n = new Notification(notification.title, {\n\t\t\tbody: notification.text,\n\t\t\ttag: notification.payload._id,\n\t\t\tsilent: true,\n\t\t\trequireInteraction,\n\t\t} as NotificationOptions);\n\n\t\tn.onclick = function () {\n\t\t\tthis.close();\n\t\t\twindow.focus();\n\t\t\timperativeModal.open({\n\t\t\t\tcomponent: OutlookCalendarEventModal,\n\t\t\t\tprops: { id: notification.payload._id, onClose: imperativeModal.close, onCancel: imperativeModal.close },\n\t\t\t});\n\t\t};\n\t};\n\tTracker.autorun(() => {\n\t\tif (!Meteor.userId() || !settings.get('Outlook_Calendar_Enabled')) {\n\t\t\tsdk.stop('notify-user', `${Meteor.userId()}/calendar`);\n\t\t\treturn;\n\t\t}\n\n\t\tsdk.stream('notify-user', [`${Meteor.userId()}/calendar`], notifyUserCalendar);\n\t});\n\n\tTracker.autorun(() => {\n\t\tif (!Meteor.userId()) {\n\t\t\treturn;\n\t\t}\n\n\t\tsdk.stream('notify-user', [`${Meteor.userId()}/notification`], (notification) => {\n\t\t\tconst openedRoomId = ['channel', 'group', 'direct'].includes(router.getRouteName()!) ? RoomManager.opened : undefined;\n\n\t\t\t// This logic is duplicated in /client/startup/unread.coffee.\n\t\t\tconst hasFocus = document.hasFocus();\n\t\t\tconst messageIsInOpenedRoom = openedRoomId === notification.payload.rid;\n\n\t\t\tfireGlobalEvent('notification', {\n\t\t\t\tnotification,\n\t\t\t\tfromOpenedRoom: messageIsInOpenedRoom,\n\t\t\t\thasFocus,\n\t\t\t});\n\n\t\t\tif (isLayoutEmbedded()) {\n\t\t\t\tif (!hasFocus && messageIsInOpenedRoom) {\n\t\t\t\t\t// Show a notification.\n\t\t\t\t\tKonchatNotification.showDesktop(notification);\n\t\t\t\t}\n\t\t\t} else if (!hasFocus || !messageIsInOpenedRoom) {\n\t\t\t\t// Show a notification.\n\t\t\t\tKonchatNotification.showDesktop(notification);\n\t\t\t}\n\n\t\t\tnotifyNewMessageAudio(notification.payload.rid);\n\t\t});\n\n\t\tCachedChatSubscription.on('changed', (sub): void => {\n\t\t\tvoid notifyNewRoom(sub);\n\t\t});\n\n\t\tsdk.stream('notify-user', [`${Meteor.userId()}/subscriptions-changed`], (action, sub) => {\n\t\t\tif (action === 'removed') {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tvoid notifyNewRoom(sub);\n\t\t});\n\t});\n});\n"],"mappings":"AACA,IAAAA,mBAAuB;AAAAC,MAAA,CAAAC,IAAA,6BAAgB;EAAAC,OAAA,WAAAA,CAAAC,CAAA;IAAAJ,mBAAA,GAAAI,CAAA;EAAA;AAAA;AAAvC,IAAAC,MAAS;AAAAJ,MAAQ,CAAAC,IAAA,CAAM,eAAe,EAAC;EAAAG,MAAA,WAAAA,CAAAD,CAAA;IAAAC,MAAA,GAAAD,CAAA;EAAA;AAAA;AAAA,IAAAE,OAAA;AAAAL,MAAA,CAAAC,IAAA;EAAAI,OAAA,WAAAA,CAAAF,CAAA;IAAAE,OAAA,GAAAF,CAAA;EAAA;AAAA;AAAA,IAAAG,IAAA;AAAAN,MAAA,CAAAC,IAAA;EAAAK,IAAA,WAAAA,CAAAH,CAAA;IAAAG,IAAA,GAAAH,CAAA;EAAA;AAAA;AAAA,IAAAI,sBAAA;AAAAP,MAAA,CAAAC,IAAA;EAAAM,sBAAA,WAAAA,CAAAJ,CAAA;IAAAI,sBAAA,GAAAJ,CAAA;EAAA;AAAA;AAAA,IAAAK,QAAA;AAAAR,MAAA,CAAAC,IAAA;EAAAO,QAAA,WAAAA,CAAAL,CAAA;IAAAK,QAAA,GAAAL,CAAA;EAAA;AAAA;AAAA,IAAAM,mBAAA;AAAAT,MAAA,CAAAC,IAAA;EAAAQ,mBAAA,WAAAA,CAAAN,CAAA;IAAAM,mBAAA,GAAAN,CAAA;EAAA;AAAA;AAAA,IAAAO,iBAAA;AAAAV,MAAA,CAAAC,IAAA;EAAAS,iBAAA,WAAAA,CAAAP,CAAA;IAAAO,iBAAA,GAAAP,CAAA;EAAA;AAAA;AAAA,IAAAQ,GAAA;AAAAX,MAAA,CAAAC,IAAA;EAAAU,GAAA,WAAAA,CAAAR,CAAA;IAAAQ,GAAA,GAAAR,CAAA;EAAA;AAAA;AAAA,IAAAS,WAAA;AAAAZ,MAAA,CAAAC,IAAA;EAAAW,WAAA,WAAAA,CAAAT,CAAA;IAAAS,WAAA,GAAAT,CAAA;EAAA;AAAA;AAAA,IAAAU,eAAA;AAAAb,MAAA,CAAAC,IAAA;EAAAY,eAAA,WAAAA,CAAAV,CAAA;IAAAU,eAAA,GAAAV,CAAA;EAAA;AAAA;AAAA,IAAAW,eAAA;AAAAd,MAAA,CAAAC,IAAA;EAAAa,eAAA,WAAAA,CAAAX,CAAA;IAAAW,eAAA,GAAAX,CAAA;EAAA;AAAA;AAAA,IAAAY,gBAAA;AAAAf,MAAA,CAAAC,IAAA;EAAAc,gBAAA,WAAAA,CAAAZ,CAAA;IAAAY,gBAAA,GAAAZ,CAAA;EAAA;AAAA;AAAA,IAAAa,MAAA;AAAAhB,MAAA,CAAAC,IAAA;EAAAe,MAAA,WAAAA,CAAAb,CAAA;IAAAa,MAAA,GAAAb,CAAA;EAAA;AAAA;AAevC,IAAMc,yBAAyB,gBAAGX,IAAI,CAAC;EAAA,OAAMN,MAAA,CAAAkB,aAAA,CAAO,uDAAuD,CAAC;AAAA,EAAC;AAE7G,IAAMC,aAAa;EAAG,SAAAC,QAAOC,GAAkC;IAAA,IAAAC,IAAA;IAAA,OAAAvB,mBAAA,CAAAwB,KAAA;MAAA,SAAAC,SAAAC,QAAA;QAAA,kBAAAA,QAAA,CAAAC,IAAA,GAAAD,QAAA,CAAAE,IAAA;UAAA;YACxDL,IAAI,GAAGlB,MAAM,CAACkB,IAAI,EAAkB;YAAA,MACtC,CAACA,IAAI,IAAIA,IAAI,CAACM,MAAM,KAAK,MAAM;cAAAH,QAAA,CAAAE,IAAA;cAAA;YAAA;YAAA,OAAAF,QAAA,CAAAI,MAAA;UAAA;YAInC,IAAI,CAAC,CAACb,MAAM,CAACc,kBAAkB,EAAE,CAACC,IAAI,IAAIf,MAAM,CAACc,kBAAkB,EAAE,CAACC,IAAI,KAAKV,GAAG,CAACU,IAAI,KAAK,CAACV,GAAG,CAACW,EAAE,IAAIX,GAAG,CAACY,KAAK,KAAK,IAAI,EAAE;cAC1HxB,mBAAmB,CAACyB,OAAO,CAACb,GAAG,CAACc,GAAG,CAAC;YACrC;UAAC;UAAA;YAAA,OAAAV,QAAA,CAAAW,IAAA;QAAA;MAAA;MAAA,OAAAZ,QAAA;IAAA,uBAAAa,OAAA;EAAA;EACD,OAAAjB,OAAA;AAAA;AAED,SAASkB,qBAAqBA,CAACH,GAAY;EAC1C;EACA,IAAMI,QAAQ,GAAGC,QAAQ,CAACD,QAAQ,EAAE;EACpC,IAAME,qBAAqB,GAAG7B,WAAW,CAAC8B,MAAM,KAAKP,GAAG;EACxD,IAAMQ,wBAAwB,GAAGjC,iBAAiB,CAACN,MAAM,CAACwC,MAAM,EAAE,EAAE,0BAA0B,CAAC;EAE/F,IAAI7B,gBAAgB,EAAE,EAAE;IACvB,IAAI,CAACwB,QAAQ,IAAIE,qBAAqB,EAAE;MACvC;MACA,KAAKhC,mBAAmB,CAACoC,UAAU,CAACV,GAAG,CAAC;IACzC;EACD,CAAC,MAAM,IAAI,CAACI,QAAQ,IAAI,CAACE,qBAAqB,IAAI,CAACE,wBAAwB,EAAE;IAC5E;IACA,KAAKlC,mBAAmB,CAACoC,UAAU,CAACV,GAAG,CAAC;EACzC;AACD;AAEA/B,MAAM,CAAC0C,OAAO,CAAC,YAAK;EACnB,IAAMC,kBAAkB;IAAG,SAAAC,SAAgBC,YAAmC;MAAA,IAAA3B,IAAA,EAAA4B,kBAAA,EAAAC,CAAA;MAAA,OAAApD,mBAAA,CAAAwB,KAAA;QAAA,SAAA6B,UAAAC,SAAA;UAAA,kBAAAA,SAAA,CAAA3B,IAAA,GAAA2B,SAAA,CAAA1B,IAAA;YAAA;cACvEL,IAAI,GAAGlB,MAAM,CAACkB,IAAI,EAAkB;cAAA,MACtC,CAACA,IAAI,IAAIA,IAAI,CAACM,MAAM,KAAK,MAAM;gBAAAyB,SAAA,CAAA1B,IAAA;gBAAA;cAAA;cAAA,OAAA0B,SAAA,CAAAxB,MAAA;YAAA;cAI7BqB,kBAAkB,GAAGxC,iBAAiB,CAAUN,MAAM,CAACwC,MAAM,EAAE,EAAE,uCAAuC,CAAC;cAEzGO,CAAC,GAAG,IAAIG,YAAY,CAACL,YAAY,CAACM,KAAK,EAAE;gBAC9CC,IAAI,EAAEP,YAAY,CAACQ,IAAI;gBACvBC,GAAG,EAAET,YAAY,CAACU,OAAO,CAACC,GAAG;gBAC7BC,MAAM,EAAE,IAAI;gBACZX,kBAAkB,EAAlBA;eACuB,CAAC;cAEzBC,CAAC,CAACW,OAAO,GAAG;gBACX,IAAI,CAACC,KAAK,EAAE;gBACZC,MAAM,CAACC,KAAK,EAAE;gBACdpD,eAAe,CAACqD,IAAI,CAAC;kBACpBC,SAAS,EAAElD,yBAAyB;kBACpCmD,KAAK,EAAE;oBAAEC,EAAE,EAAEpB,YAAY,CAACU,OAAO,CAACC,GAAG;oBAAEU,OAAO,EAAEzD,eAAe,CAACkD,KAAK;oBAAEQ,QAAQ,EAAE1D,eAAe,CAACkD;kBAAK;iBACtG,CAAC;cACH,CAAC;YAAC;YAAA;cAAA,OAAAV,SAAA,CAAAjB,IAAA;UAAA;QAAA;QAAA,OAAAgB,SAAA;MAAA,uBAAAf,OAAA;IAAA;IACF,OAAAW,QAAA;EAAA;EACD3C,OAAO,CAACmE,OAAO,CAAC,YAAK;IACpB,IAAI,CAACpE,MAAM,CAACwC,MAAM,EAAE,IAAI,CAACpC,QAAQ,CAACiE,GAAG,CAAC,0BAA0B,CAAC,EAAE;MAClE9D,GAAG,CAACyB,IAAI,CAAC,aAAa,EAAKhC,MAAM,CAACwC,MAAM,EAAE,cAAW,CAAC;MACtD;IACD;IAEAjC,GAAG,CAAC+D,MAAM,CAAC,aAAa,EAAE,CAAItE,MAAM,CAACwC,MAAM,EAAE,eAAY,EAAEG,kBAAkB,CAAC;EAC/E,CAAC,CAAC;EAEF1C,OAAO,CAACmE,OAAO,CAAC,YAAK;IACpB,IAAI,CAACpE,MAAM,CAACwC,MAAM,EAAE,EAAE;MACrB;IACD;IAEAjC,GAAG,CAAC+D,MAAM,CAAC,aAAa,EAAE,CAAItE,MAAM,CAACwC,MAAM,EAAE,mBAAgB,EAAE,UAACK,YAAY,EAAI;MAC/E,IAAM0B,YAAY,GAAG,CAAC,SAAS,EAAE,OAAO,EAAE,QAAQ,CAAC,CAACC,QAAQ,CAAC5D,MAAM,CAAC6D,YAAY,EAAG,CAAC,GAAGjE,WAAW,CAAC8B,MAAM,GAAGoC,SAAS;MAErH;MACA,IAAMvC,QAAQ,GAAGC,QAAQ,CAACD,QAAQ,EAAE;MACpC,IAAME,qBAAqB,GAAGkC,YAAY,KAAK1B,YAAY,CAACU,OAAO,CAACxB,GAAG;MAEvErB,eAAe,CAAC,cAAc,EAAE;QAC/BmC,YAAY,EAAZA,YAAY;QACZ8B,cAAc,EAAEtC,qBAAqB;QACrCF,QAAQ,EAARA;OACA,CAAC;MAEF,IAAIxB,gBAAgB,EAAE,EAAE;QACvB,IAAI,CAACwB,QAAQ,IAAIE,qBAAqB,EAAE;UACvC;UACAhC,mBAAmB,CAACuE,WAAW,CAAC/B,YAAY,CAAC;QAC9C;MACD,CAAC,MAAM,IAAI,CAACV,QAAQ,IAAI,CAACE,qBAAqB,EAAE;QAC/C;QACAhC,mBAAmB,CAACuE,WAAW,CAAC/B,YAAY,CAAC;MAC9C;MAEAX,qBAAqB,CAACW,YAAY,CAACU,OAAO,CAACxB,GAAG,CAAC;IAChD,CAAC,CAAC;IAEF5B,sBAAsB,CAAC0E,EAAE,CAAC,SAAS,EAAE,UAAC5D,GAAG,EAAU;MAClD,KAAKF,aAAa,CAACE,GAAG,CAAC;IACxB,CAAC,CAAC;IAEFV,GAAG,CAAC+D,MAAM,CAAC,aAAa,EAAE,CAAItE,MAAM,CAACwC,MAAM,EAAE,4BAAyB,EAAE,UAACsC,MAAM,EAAE7D,GAAG,EAAI;MACvF,IAAI6D,MAAM,KAAK,SAAS,EAAE;QACzB;MACD;MACA,KAAK/D,aAAa,CAACE,GAAG,CAAC;IACxB,CAAC,CAAC;EACH,CAAC,CAAC;AACH,CAAC,CAAC","ignoreList":[]},"sourceType":"module","externalDependencies":{},"hash":"732d40e9a8a077e08512ad3eb7efcae3118c6b36"}
