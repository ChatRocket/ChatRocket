{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/server/lib/dataExport/exportRoomMessagesToFile.ts","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","topLevelAwait","objectRestSpread","objectRestSpread","asyncGenerators","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"os.osx.arm64"},"sourceFileName":"server/lib/dataExport/exportRoomMessagesToFile.ts","filename":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/server/lib/dataExport/exportRoomMessagesToFile.ts","inputSourceMap":{"version":3,"file":"server/lib/dataExport/exportRoomMessagesToFile.ts","sourceRoot":"","sources":["server/lib/dataExport/exportRoomMessagesToFile.ts"],"names":[],"mappings":"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","sourcesContent":["import { mkdir, writeFile } from 'fs/promises';\n\nimport type { IMessage, IRoom, IUser, MessageAttachment, FileProp, RoomType } from '@rocket.chat/core-typings';\nimport { Messages } from '@rocket.chat/models';\n\nimport { settings } from '../../../app/settings/server';\nimport { readSecondaryPreferred } from '../../database/readSecondaryPreferred';\nimport { joinPath } from '../fileUtils';\nimport { i18n } from '../i18n';\n\nconst hideUserName = (\n\tusername: string,\n\tuserData: Pick<IUser, 'username'> | undefined,\n\tusersMap: { userNameTable: Record<string, string> },\n) => {\n\tif (!usersMap.userNameTable) {\n\t\tusersMap.userNameTable = {};\n\t}\n\n\tif (!usersMap.userNameTable[username]) {\n\t\tif (userData && username === userData.username) {\n\t\t\tusersMap.userNameTable[username] = username;\n\t\t} else {\n\t\t\tusersMap.userNameTable[username] = `User_${Object.keys(usersMap.userNameTable).length + 1}`;\n\t\t}\n\t}\n\n\treturn usersMap.userNameTable[username];\n};\n\nconst getAttachmentData = (attachment: MessageAttachment, message: IMessage) => {\n\treturn {\n\t\ttype: 'type' in attachment ? attachment.type : undefined,\n\t\ttitle: attachment.title,\n\t\ttitle_link: attachment.title_link,\n\t\timage_url: 'image_url' in attachment ? attachment.image_url : undefined,\n\t\taudio_url: 'audio_url' in attachment ? attachment.audio_url : undefined,\n\t\tvideo_url: 'video_url' in attachment ? attachment.video_url : undefined,\n\t\tmessage_link: 'message_link' in attachment ? attachment.message_link : undefined,\n\t\timage_type: 'image_type' in attachment ? attachment.image_type : undefined,\n\t\timage_size: 'image_size' in attachment ? attachment.image_size : undefined,\n\t\tvideo_size: 'video_size' in attachment ? attachment.video_size : undefined,\n\t\tvideo_type: 'video_type' in attachment ? attachment.video_type : undefined,\n\t\taudio_size: 'audio_size' in attachment ? attachment.audio_size : undefined,\n\t\taudio_type: 'audio_type' in attachment ? attachment.audio_type : undefined,\n\t\turl:\n\t\t\tattachment.title_link ||\n\t\t\t('image_url' in attachment ? attachment.image_url : undefined) ||\n\t\t\t('audio_url' in attachment ? attachment.audio_url : undefined) ||\n\t\t\t('video_url' in attachment ? attachment.video_url : undefined) ||\n\t\t\t('message_link' in attachment ? attachment.message_link : undefined) ||\n\t\t\tnull,\n\t\tremote: !message.file?._id,\n\t\tfileId: message.file?._id,\n\t\tfileName: message.file?.name,\n\t};\n};\n\nexport type MessageData = Pick<IMessage, 'msg' | 'ts'> & {\n\tusername?: IUser['username'] | IUser['name'];\n\tattachments?: ReturnType<typeof getAttachmentData>[];\n\ttype?: IMessage['t'];\n};\n\nexport const getMessageData = (\n\tmsg: IMessage,\n\thideUsers: boolean,\n\tuserData: Pick<IUser, 'username'> | undefined,\n\tusersMap: { userNameTable: Record<string, string> },\n): MessageData => {\n\tconst username = hideUsers ? hideUserName(msg.u.username || msg.u.name || '', userData, usersMap) : msg.u.username;\n\n\tconst messageObject = {\n\t\tmsg: msg.msg,\n\t\tusername,\n\t\tts: msg.ts,\n\t\t...(msg.attachments && {\n\t\t\tattachments: msg.attachments.map((attachment) => getAttachmentData(attachment, msg)),\n\t\t}),\n\t\t...(msg.t && { type: msg.t }),\n\t};\n\n\tswitch (msg.t) {\n\t\tcase 'uj':\n\t\t\tmessageObject.msg = i18n.t('User_joined_the_channel');\n\t\t\tbreak;\n\t\tcase 'ul':\n\t\t\tmessageObject.msg = i18n.t('User_left_this_channel');\n\t\t\tbreak;\n\t\tcase 'ult':\n\t\t\tmessageObject.msg = i18n.t('User_left_this_team');\n\t\t\tbreak;\n\t\tcase 'user-added-room-to-team':\n\t\t\tmessageObject.msg = i18n.t('added__roomName__to_this_team', {\n\t\t\t\troomName: msg.msg,\n\t\t\t});\n\t\t\tbreak;\n\t\tcase 'user-converted-to-team':\n\t\t\tmessageObject.msg = i18n.t('Converted__roomName__to_a_team', {\n\t\t\t\troomName: msg.msg,\n\t\t\t});\n\t\t\tbreak;\n\t\tcase 'user-converted-to-channel':\n\t\t\tmessageObject.msg = i18n.t('Converted__roomName__to_a_channel', {\n\t\t\t\troomName: msg.msg,\n\t\t\t});\n\t\t\tbreak;\n\t\tcase 'user-deleted-room-from-team':\n\t\t\tmessageObject.msg = i18n.t('Deleted__roomName__room', {\n\t\t\t\troomName: msg.msg,\n\t\t\t});\n\t\t\tbreak;\n\t\tcase 'user-removed-room-from-team':\n\t\t\tmessageObject.msg = i18n.t('Removed__roomName__from_the_team', {\n\t\t\t\troomName: msg.msg,\n\t\t\t});\n\t\t\tbreak;\n\t\tcase 'ujt':\n\t\t\tmessageObject.msg = i18n.t('User_joined_the_team');\n\t\t\tbreak;\n\t\tcase 'au':\n\t\t\tmessageObject.msg = i18n.t('User_added_to', {\n\t\t\t\tuser_added: hideUserName(msg.msg, userData, usersMap),\n\t\t\t\tuser_by: username,\n\t\t\t});\n\t\t\tbreak;\n\t\tcase 'added-user-to-team':\n\t\t\tmessageObject.msg = i18n.t('Added__username__to_this_team', {\n\t\t\t\tuser_added: msg.msg,\n\t\t\t});\n\t\t\tbreak;\n\t\tcase 'r':\n\t\t\tmessageObject.msg = i18n.t('Room_name_changed_to', {\n\t\t\t\troom_name: msg.msg,\n\t\t\t\tuser_by: username,\n\t\t\t});\n\t\t\tbreak;\n\t\tcase 'ru':\n\t\t\tmessageObject.msg = i18n.t('User_has_been_removed', {\n\t\t\t\tuser_removed: hideUserName(msg.msg, userData, usersMap),\n\t\t\t\tuser_by: username,\n\t\t\t});\n\t\t\tbreak;\n\t\tcase 'removed-user-from-team':\n\t\t\tmessageObject.msg = i18n.t('Removed__username__from_the_team', {\n\t\t\t\tuser_removed: hideUserName(msg.msg, userData, usersMap),\n\t\t\t});\n\t\t\tbreak;\n\t\tcase 'wm':\n\t\t\tmessageObject.msg = i18n.t('Welcome', { user: username });\n\t\t\tbreak;\n\t\tcase 'livechat-close':\n\t\t\tmessageObject.msg = i18n.t('Conversation_finished');\n\t\t\tbreak;\n\t\tcase 'livechat-started':\n\t\t\tmessageObject.msg = i18n.t('Chat_started');\n\t\t\tbreak;\n\t}\n\n\treturn messageObject;\n};\n\nexport const exportMessageObject = (type: 'json' | 'html', messageObject: MessageData, messageFile?: FileProp): string => {\n\tif (type === 'json') {\n\t\treturn JSON.stringify(messageObject);\n\t}\n\n\tconst file = [];\n\n\tconst messageType = messageObject.type;\n\tconst timestamp = messageObject.ts ? new Date(messageObject.ts).toUTCString() : '';\n\n\tconst italicTypes: IMessage['t'][] = ['uj', 'ul', 'au', 'r', 'ru', 'wm', 'livechat-close'];\n\n\tconst message = italicTypes.includes(messageType) ? `<i>${messageObject.msg}</i>` : messageObject.msg;\n\n\tfile.push(`<p><strong>${messageObject.username}</strong> (${timestamp}):<br/>`);\n\tfile.push(message);\n\n\tif (messageFile?._id) {\n\t\tconst attachment = messageObject.attachments?.find((att) => att.type === 'file' && att.title_link?.includes(messageFile._id));\n\n\t\tconst description = attachment?.title || i18n.t('Message_Attachments');\n\n\t\tconst assetUrl = `./assets/${messageFile._id}-${messageFile.name}`;\n\t\tconst link = `<br/><a href=\"${assetUrl}\">${description}</a>`;\n\t\tfile.push(link);\n\t}\n\n\tfile.push('</p>');\n\n\treturn file.join('\\n');\n};\n\nexport const exportRoomMessages = async (\n\trid: IRoom['_id'],\n\texportType: 'json' | 'html',\n\tskip: number,\n\tlimit: number,\n\tuserData: any,\n\tfilter: any = {},\n\tusersMap: any = {},\n\thideUsers = true,\n) => {\n\tconst readPreference = readSecondaryPreferred();\n\n\tconst { cursor, totalCount } = Messages.findPaginated(\n\t\t{ ...filter, rid },\n\t\t{\n\t\t\tsort: { ts: 1 },\n\t\t\tskip,\n\t\t\tlimit,\n\t\t\treadPreference,\n\t\t},\n\t);\n\n\tconst [results, total] = await Promise.all([cursor.toArray(), totalCount]);\n\n\tconst result = {\n\t\ttotal,\n\t\texported: results.length,\n\t\tmessages: [] as string[],\n\t\tuploads: [] as FileProp[],\n\t};\n\n\tresults.forEach((msg) => {\n\t\tconst messageObject = getMessageData(msg, hideUsers, userData, usersMap);\n\n\t\tif (msg.file) {\n\t\t\tresult.uploads.push(msg.file);\n\t\t}\n\n\t\tresult.messages.push(exportMessageObject(exportType, messageObject, msg.file));\n\t});\n\n\treturn result;\n};\n\nexport const exportRoomMessagesToFile = async function (\n\texportPath: string,\n\tassetsPath: string,\n\texportType: 'json' | 'html',\n\troomList: (\n\t\t| {\n\t\t\t\troomId: string;\n\t\t\t\troomName: string;\n\t\t\t\tuserId: string | undefined;\n\t\t\t\texportedCount: number;\n\t\t\t\tstatus: string;\n\t\t\t\ttype: RoomType;\n\t\t\t\ttargetFile: string;\n\t\t  }\n\t\t| Record<string, never>\n\t)[],\n\tuserData: IUser,\n\tmessagesFilter = {},\n\tusersMap = {},\n\thideUsers = true,\n) {\n\tawait mkdir(exportPath, { recursive: true });\n\tawait mkdir(assetsPath, { recursive: true });\n\n\tconst result = {\n\t\tfileList: [] as FileProp[],\n\t};\n\n\tconst limit =\n\t\tsettings.get<number>('UserData_MessageLimitPerRequest') > 0 ? settings.get<number>('UserData_MessageLimitPerRequest') : 1000;\n\tfor await (const exportOpRoomData of roomList) {\n\t\tif (!('targetFile' in exportOpRoomData)) {\n\t\t\tcontinue;\n\t\t}\n\n\t\tconst filePath = joinPath(exportPath, exportOpRoomData.targetFile);\n\t\tif (exportOpRoomData.status === 'pending') {\n\t\t\texportOpRoomData.status = 'exporting';\n\t\t\tif (exportType === 'html') {\n\t\t\t\tawait writeFile(filePath, '<meta http-equiv=\"content-type\" content=\"text/html; charset=utf-8\">', { encoding: 'utf8' });\n\t\t\t}\n\t\t}\n\n\t\tconst skip = exportOpRoomData.exportedCount;\n\n\t\tconst { total, exported, uploads, messages } = await exportRoomMessages(\n\t\t\texportOpRoomData.roomId,\n\t\t\texportType,\n\t\t\tskip,\n\t\t\tlimit,\n\t\t\tuserData,\n\t\t\tmessagesFilter,\n\t\t\tusersMap,\n\t\t\thideUsers,\n\t\t);\n\n\t\tresult.fileList.push(...uploads);\n\n\t\texportOpRoomData.exportedCount += exported;\n\n\t\tif (total <= exportOpRoomData.exportedCount) {\n\t\t\texportOpRoomData.status = 'completed';\n\t\t}\n\n\t\tawait writeFile(filePath, `${messages.join('\\n')}\\n`, { encoding: 'utf8', flag: 'a' });\n\t}\n\n\treturn result;\n};\n"]},"targets":{"android":"125.0.0","chrome":"125.0.0","edge":"125.0.0","firefox":"115.0.0","ie":"10.0.0","ios":"17.4.0","opera":"110.0.0","opera_mobile":"80.0.0","safari":"17.4.0","samsung":"24.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor","root":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":false,"enforceStrictMode":false,"dynamicImport":true,"generateLetDeclarations":true,"topLevelAwait":true},"externalDependencies":[]},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"version":"7.17.2","helpers":true,"useESModules":false,"corejs":false},"externalDependencies":[]},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-async-generator-functions","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-class-properties","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true},"externalDependencies":[]},{"key":"transform-react-jsx","visitor":{"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXFragment":{"exit":[null]},"JSXElement":{"exit":[null]},"JSXAttribute":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false},"externalDependencies":[]},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-nullish-coalescing-operator","visitor":{"LogicalExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-optional-chaining","visitor":{"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-optional-catch-binding","visitor":{"CatchClause":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-class-properties","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-async-generator-functions","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-logical-assignment-operators","visitor":{"AssignmentExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]}],"presets":[],"generatorOpts":{"filename":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/server/lib/dataExport/exportRoomMessagesToFile.ts","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"server/lib/dataExport/exportRoomMessagesToFile.ts","inputSourceMap":{"version":3,"file":"server/lib/dataExport/exportRoomMessagesToFile.ts","sourceRoot":"","sources":["server/lib/dataExport/exportRoomMessagesToFile.ts"],"names":[],"mappings":"AAAA,OAAO,EAAE,KAAK,EAAE,SAAS,EAAE,MAAM,aAAa,CAAC;AAG/C,OAAO,EAAE,QAAQ,EAAE,MAAM,qBAAqB,CAAC;AAE/C,OAAO,EAAE,QAAQ,EAAE,MAAM,8BAA8B,CAAC;AACxD,OAAO,EAAE,sBAAsB,EAAE,MAAM,uCAAuC,CAAC;AAC/E,OAAO,EAAE,QAAQ,EAAE,MAAM,cAAc,CAAC;AACxC,OAAO,EAAE,IAAI,EAAE,MAAM,SAAS,CAAC;AAE/B,MAAM,YAAY,GAAG,CACpB,QAAgB,EAChB,QAA6C,EAC7C,QAAmD,EAClD,EAAE;IACH,IAAI,CAAC,QAAQ,CAAC,aAAa,EAAE,CAAC;QAC7B,QAAQ,CAAC,aAAa,GAAG,EAAE,CAAC;IAC7B,CAAC;IAED,IAAI,CAAC,QAAQ,CAAC,aAAa,CAAC,QAAQ,CAAC,EAAE,CAAC;QACvC,IAAI,QAAQ,IAAI,QAAQ,KAAK,QAAQ,CAAC,QAAQ,EAAE,CAAC;YAChD,QAAQ,CAAC,aAAa,CAAC,QAAQ,CAAC,GAAG,QAAQ,CAAC;QAC7C,CAAC;aAAM,CAAC;YACP,QAAQ,CAAC,aAAa,CAAC,QAAQ,CAAC,GAAG,QAAQ,MAAM,CAAC,IAAI,CAAC,QAAQ,CAAC,aAAa,CAAC,CAAC,MAAM,GAAG,CAAC,EAAE,CAAC;QAC7F,CAAC;IACF,CAAC;IAED,OAAO,QAAQ,CAAC,aAAa,CAAC,QAAQ,CAAC,CAAC;AACzC,CAAC,CAAC;AAEF,MAAM,iBAAiB,GAAG,CAAC,UAA6B,EAAE,OAAiB,EAAE,EAAE;IAC9E,OAAO;QACN,IAAI,EAAE,MAAM,IAAI,UAAU,CAAC,CAAC,CAAC,UAAU,CAAC,IAAI,CAAC,CAAC,CAAC,SAAS;QACxD,KAAK,EAAE,UAAU,CAAC,KAAK;QACvB,UAAU,EAAE,UAAU,CAAC,UAAU;QACjC,SAAS,EAAE,WAAW,IAAI,UAAU,CAAC,CAAC,CAAC,UAAU,CAAC,SAAS,CAAC,CAAC,CAAC,SAAS;QACvE,SAAS,EAAE,WAAW,IAAI,UAAU,CAAC,CAAC,CAAC,UAAU,CAAC,SAAS,CAAC,CAAC,CAAC,SAAS;QACvE,SAAS,EAAE,WAAW,IAAI,UAAU,CAAC,CAAC,CAAC,UAAU,CAAC,SAAS,CAAC,CAAC,CAAC,SAAS;QACvE,YAAY,EAAE,cAAc,IAAI,UAAU,CAAC,CAAC,CAAC,UAAU,CAAC,YAAY,CAAC,CAAC,CAAC,SAAS;QAChF,UAAU,EAAE,YAAY,IAAI,UAAU,CAAC,CAAC,CAAC,UAAU,CAAC,UAAU,CAAC,CAAC,CAAC,SAAS;QAC1E,UAAU,EAAE,YAAY,IAAI,UAAU,CAAC,CAAC,CAAC,UAAU,CAAC,UAAU,CAAC,CAAC,CAAC,SAAS;QAC1E,UAAU,EAAE,YAAY,IAAI,UAAU,CAAC,CAAC,CAAC,UAAU,CAAC,UAAU,CAAC,CAAC,CAAC,SAAS;QAC1E,UAAU,EAAE,YAAY,IAAI,UAAU,CAAC,CAAC,CAAC,UAAU,CAAC,UAAU,CAAC,CAAC,CAAC,SAAS;QAC1E,UAAU,EAAE,YAAY,IAAI,UAAU,CAAC,CAAC,CAAC,UAAU,CAAC,UAAU,CAAC,CAAC,CAAC,SAAS;QAC1E,UAAU,EAAE,YAAY,IAAI,UAAU,CAAC,CAAC,CAAC,UAAU,CAAC,UAAU,CAAC,CAAC,CAAC,SAAS;QAC1E,GAAG,EACF,UAAU,CAAC,UAAU;YACrB,CAAC,WAAW,IAAI,UAAU,CAAC,CAAC,CAAC,UAAU,CAAC,SAAS,CAAC,CAAC,CAAC,SAAS,CAAC;YAC9D,CAAC,WAAW,IAAI,UAAU,CAAC,CAAC,CAAC,UAAU,CAAC,SAAS,CAAC,CAAC,CAAC,SAAS,CAAC;YAC9D,CAAC,WAAW,IAAI,UAAU,CAAC,CAAC,CAAC,UAAU,CAAC,SAAS,CAAC,CAAC,CAAC,SAAS,CAAC;YAC9D,CAAC,cAAc,IAAI,UAAU,CAAC,CAAC,CAAC,UAAU,CAAC,YAAY,CAAC,CAAC,CAAC,SAAS,CAAC;YACpE,IAAI;QACL,MAAM,EAAE,CAAC,OAAO,CAAC,IAAI,EAAE,GAAG;QAC1B,MAAM,EAAE,OAAO,CAAC,IAAI,EAAE,GAAG;QACzB,QAAQ,EAAE,OAAO,CAAC,IAAI,EAAE,IAAI;KAC5B,CAAC;AACH,CAAC,CAAC;AAQF,MAAM,CAAC,MAAM,cAAc,GAAG,CAC7B,GAAa,EACb,SAAkB,EAClB,QAA6C,EAC7C,QAAmD,EACrC,EAAE;IAChB,MAAM,QAAQ,GAAG,SAAS,CAAC,CAAC,CAAC,YAAY,CAAC,GAAG,CAAC,CAAC,CAAC,QAAQ,IAAI,GAAG,CAAC,CAAC,CAAC,IAAI,IAAI,EAAE,EAAE,QAAQ,EAAE,QAAQ,CAAC,CAAC,CAAC,CAAC,GAAG,CAAC,CAAC,CAAC,QAAQ,CAAC;IAEnH,MAAM,aAAa,GAAG;QACrB,GAAG,EAAE,GAAG,CAAC,GAAG;QACZ,QAAQ;QACR,EAAE,EAAE,GAAG,CAAC,EAAE;QACV,GAAG,CAAC,GAAG,CAAC,WAAW,IAAI;YACtB,WAAW,EAAE,GAAG,CAAC,WAAW,CAAC,GAAG,CAAC,CAAC,UAAU,EAAE,EAAE,CAAC,iBAAiB,CAAC,UAAU,EAAE,GAAG,CAAC,CAAC;SACpF,CAAC;QACF,GAAG,CAAC,GAAG,CAAC,CAAC,IAAI,EAAE,IAAI,EAAE,GAAG,CAAC,CAAC,EAAE,CAAC;KAC7B,CAAC;IAEF,QAAQ,GAAG,CAAC,CAAC,EAAE,CAAC;QACf,KAAK,IAAI;YACR,aAAa,CAAC,GAAG,GAAG,IAAI,CAAC,CAAC,CAAC,yBAAyB,CAAC,CAAC;YACtD,MAAM;QACP,KAAK,IAAI;YACR,aAAa,CAAC,GAAG,GAAG,IAAI,CAAC,CAAC,CAAC,wBAAwB,CAAC,CAAC;YACrD,MAAM;QACP,KAAK,KAAK;YACT,aAAa,CAAC,GAAG,GAAG,IAAI,CAAC,CAAC,CAAC,qBAAqB,CAAC,CAAC;YAClD,MAAM;QACP,KAAK,yBAAyB;YAC7B,aAAa,CAAC,GAAG,GAAG,IAAI,CAAC,CAAC,CAAC,+BAA+B,EAAE;gBAC3D,QAAQ,EAAE,GAAG,CAAC,GAAG;aACjB,CAAC,CAAC;YACH,MAAM;QACP,KAAK,wBAAwB;YAC5B,aAAa,CAAC,GAAG,GAAG,IAAI,CAAC,CAAC,CAAC,gCAAgC,EAAE;gBAC5D,QAAQ,EAAE,GAAG,CAAC,GAAG;aACjB,CAAC,CAAC;YACH,MAAM;QACP,KAAK,2BAA2B;YAC/B,aAAa,CAAC,GAAG,GAAG,IAAI,CAAC,CAAC,CAAC,mCAAmC,EAAE;gBAC/D,QAAQ,EAAE,GAAG,CAAC,GAAG;aACjB,CAAC,CAAC;YACH,MAAM;QACP,KAAK,6BAA6B;YACjC,aAAa,CAAC,GAAG,GAAG,IAAI,CAAC,CAAC,CAAC,yBAAyB,EAAE;gBACrD,QAAQ,EAAE,GAAG,CAAC,GAAG;aACjB,CAAC,CAAC;YACH,MAAM;QACP,KAAK,6BAA6B;YACjC,aAAa,CAAC,GAAG,GAAG,IAAI,CAAC,CAAC,CAAC,kCAAkC,EAAE;gBAC9D,QAAQ,EAAE,GAAG,CAAC,GAAG;aACjB,CAAC,CAAC;YACH,MAAM;QACP,KAAK,KAAK;YACT,aAAa,CAAC,GAAG,GAAG,IAAI,CAAC,CAAC,CAAC,sBAAsB,CAAC,CAAC;YACnD,MAAM;QACP,KAAK,IAAI;YACR,aAAa,CAAC,GAAG,GAAG,IAAI,CAAC,CAAC,CAAC,eAAe,EAAE;gBAC3C,UAAU,EAAE,YAAY,CAAC,GAAG,CAAC,GAAG,EAAE,QAAQ,EAAE,QAAQ,CAAC;gBACrD,OAAO,EAAE,QAAQ;aACjB,CAAC,CAAC;YACH,MAAM;QACP,KAAK,oBAAoB;YACxB,aAAa,CAAC,GAAG,GAAG,IAAI,CAAC,CAAC,CAAC,+BAA+B,EAAE;gBAC3D,UAAU,EAAE,GAAG,CAAC,GAAG;aACnB,CAAC,CAAC;YACH,MAAM;QACP,KAAK,GAAG;YACP,aAAa,CAAC,GAAG,GAAG,IAAI,CAAC,CAAC,CAAC,sBAAsB,EAAE;gBAClD,SAAS,EAAE,GAAG,CAAC,GAAG;gBAClB,OAAO,EAAE,QAAQ;aACjB,CAAC,CAAC;YACH,MAAM;QACP,KAAK,IAAI;YACR,aAAa,CAAC,GAAG,GAAG,IAAI,CAAC,CAAC,CAAC,uBAAuB,EAAE;gBACnD,YAAY,EAAE,YAAY,CAAC,GAAG,CAAC,GAAG,EAAE,QAAQ,EAAE,QAAQ,CAAC;gBACvD,OAAO,EAAE,QAAQ;aACjB,CAAC,CAAC;YACH,MAAM;QACP,KAAK,wBAAwB;YAC5B,aAAa,CAAC,GAAG,GAAG,IAAI,CAAC,CAAC,CAAC,kCAAkC,EAAE;gBAC9D,YAAY,EAAE,YAAY,CAAC,GAAG,CAAC,GAAG,EAAE,QAAQ,EAAE,QAAQ,CAAC;aACvD,CAAC,CAAC;YACH,MAAM;QACP,KAAK,IAAI;YACR,aAAa,CAAC,GAAG,GAAG,IAAI,CAAC,CAAC,CAAC,SAAS,EAAE,EAAE,IAAI,EAAE,QAAQ,EAAE,CAAC,CAAC;YAC1D,MAAM;QACP,KAAK,gBAAgB;YACpB,aAAa,CAAC,GAAG,GAAG,IAAI,CAAC,CAAC,CAAC,uBAAuB,CAAC,CAAC;YACpD,MAAM;QACP,KAAK,kBAAkB;YACtB,aAAa,CAAC,GAAG,GAAG,IAAI,CAAC,CAAC,CAAC,cAAc,CAAC,CAAC;YAC3C,MAAM;IACR,CAAC;IAED,OAAO,aAAa,CAAC;AACtB,CAAC,CAAC;AAEF,MAAM,CAAC,MAAM,mBAAmB,GAAG,CAAC,IAAqB,EAAE,aAA0B,EAAE,WAAsB,EAAU,EAAE;IACxH,IAAI,IAAI,KAAK,MAAM,EAAE,CAAC;QACrB,OAAO,IAAI,CAAC,SAAS,CAAC,aAAa,CAAC,CAAC;IACtC,CAAC;IAED,MAAM,IAAI,GAAG,EAAE,CAAC;IAEhB,MAAM,WAAW,GAAG,aAAa,CAAC,IAAI,CAAC;IACvC,MAAM,SAAS,GAAG,aAAa,CAAC,EAAE,CAAC,CAAC,CAAC,IAAI,IAAI,CAAC,aAAa,CAAC,EAAE,CAAC,CAAC,WAAW,EAAE,CAAC,CAAC,CAAC,EAAE,CAAC;IAEnF,MAAM,WAAW,GAAoB,CAAC,IAAI,EAAE,IAAI,EAAE,IAAI,EAAE,GAAG,EAAE,IAAI,EAAE,IAAI,EAAE,gBAAgB,CAAC,CAAC;IAE3F,MAAM,OAAO,GAAG,WAAW,CAAC,QAAQ,CAAC,WAAW,CAAC,CAAC,CAAC,CAAC,MAAM,aAAa,CAAC,GAAG,MAAM,CAAC,CAAC,CAAC,aAAa,CAAC,GAAG,CAAC;IAEtG,IAAI,CAAC,IAAI,CAAC,cAAc,aAAa,CAAC,QAAQ,cAAc,SAAS,SAAS,CAAC,CAAC;IAChF,IAAI,CAAC,IAAI,CAAC,OAAO,CAAC,CAAC;IAEnB,IAAI,WAAW,EAAE,GAAG,EAAE,CAAC;QACtB,MAAM,UAAU,GAAG,aAAa,CAAC,WAAW,EAAE,IAAI,CAAC,CAAC,GAAG,EAAE,EAAE,CAAC,GAAG,CAAC,IAAI,KAAK,MAAM,IAAI,GAAG,CAAC,UAAU,EAAE,QAAQ,CAAC,WAAW,CAAC,GAAG,CAAC,CAAC,CAAC;QAE9H,MAAM,WAAW,GAAG,UAAU,EAAE,KAAK,IAAI,IAAI,CAAC,CAAC,CAAC,qBAAqB,CAAC,CAAC;QAEvE,MAAM,QAAQ,GAAG,YAAY,WAAW,CAAC,GAAG,IAAI,WAAW,CAAC,IAAI,EAAE,CAAC;QACnE,MAAM,IAAI,GAAG,iBAAiB,QAAQ,KAAK,WAAW,MAAM,CAAC;QAC7D,IAAI,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;IACjB,CAAC;IAED,IAAI,CAAC,IAAI,CAAC,MAAM,CAAC,CAAC;IAElB,OAAO,IAAI,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;AACxB,CAAC,CAAC;AAEF,MAAM,CAAC,MAAM,kBAAkB,GAAG,KAAK,EACtC,GAAiB,EACjB,UAA2B,EAC3B,IAAY,EACZ,KAAa,EACb,QAAa,EACb,SAAc,EAAE,EAChB,WAAgB,EAAE,EAClB,SAAS,GAAG,IAAI,EACf,EAAE;IACH,MAAM,cAAc,GAAG,sBAAsB,EAAE,CAAC;IAEhD,MAAM,EAAE,MAAM,EAAE,UAAU,EAAE,GAAG,QAAQ,CAAC,aAAa,CACpD,EAAE,GAAG,MAAM,EAAE,GAAG,EAAE,EAClB;QACC,IAAI,EAAE,EAAE,EAAE,EAAE,CAAC,EAAE;QACf,IAAI;QACJ,KAAK;QACL,cAAc;KACd,CACD,CAAC;IAEF,MAAM,CAAC,OAAO,EAAE,KAAK,CAAC,GAAG,MAAM,OAAO,CAAC,GAAG,CAAC,CAAC,MAAM,CAAC,OAAO,EAAE,EAAE,UAAU,CAAC,CAAC,CAAC;IAE3E,MAAM,MAAM,GAAG;QACd,KAAK;QACL,QAAQ,EAAE,OAAO,CAAC,MAAM;QACxB,QAAQ,EAAE,EAAc;QACxB,OAAO,EAAE,EAAgB;KACzB,CAAC;IAEF,OAAO,CAAC,OAAO,CAAC,CAAC,GAAG,EAAE,EAAE;QACvB,MAAM,aAAa,GAAG,cAAc,CAAC,GAAG,EAAE,SAAS,EAAE,QAAQ,EAAE,QAAQ,CAAC,CAAC;QAEzE,IAAI,GAAG,CAAC,IAAI,EAAE,CAAC;YACd,MAAM,CAAC,OAAO,CAAC,IAAI,CAAC,GAAG,CAAC,IAAI,CAAC,CAAC;QAC/B,CAAC;QAED,MAAM,CAAC,QAAQ,CAAC,IAAI,CAAC,mBAAmB,CAAC,UAAU,EAAE,aAAa,EAAE,GAAG,CAAC,IAAI,CAAC,CAAC,CAAC;IAChF,CAAC,CAAC,CAAC;IAEH,OAAO,MAAM,CAAC;AACf,CAAC,CAAC;AAEF,MAAM,CAAC,MAAM,wBAAwB,GAAG,KAAK,WAC5C,UAAkB,EAClB,UAAkB,EAClB,UAA2B,EAC3B,QAWG,EACH,QAAe,EACf,cAAc,GAAG,EAAE,EACnB,QAAQ,GAAG,EAAE,EACb,SAAS,GAAG,IAAI;IAEhB,MAAM,KAAK,CAAC,UAAU,EAAE,EAAE,SAAS,EAAE,IAAI,EAAE,CAAC,CAAC;IAC7C,MAAM,KAAK,CAAC,UAAU,EAAE,EAAE,SAAS,EAAE,IAAI,EAAE,CAAC,CAAC;IAE7C,MAAM,MAAM,GAAG;QACd,QAAQ,EAAE,EAAgB;KAC1B,CAAC;IAEF,MAAM,KAAK,GACV,QAAQ,CAAC,GAAG,CAAS,iCAAiC,CAAC,GAAG,CAAC,CAAC,CAAC,CAAC,QAAQ,CAAC,GAAG,CAAS,iCAAiC,CAAC,CAAC,CAAC,CAAC,IAAI,CAAC;IAC9H,IAAI,KAAK,EAAE,MAAM,gBAAgB,IAAI,QAAQ,EAAE,CAAC;QAC/C,IAAI,CAAC,CAAC,YAAY,IAAI,gBAAgB,CAAC,EAAE,CAAC;YACzC,SAAS;QACV,CAAC;QAED,MAAM,QAAQ,GAAG,QAAQ,CAAC,UAAU,EAAE,gBAAgB,CAAC,UAAU,CAAC,CAAC;QACnE,IAAI,gBAAgB,CAAC,MAAM,KAAK,SAAS,EAAE,CAAC;YAC3C,gBAAgB,CAAC,MAAM,GAAG,WAAW,CAAC;YACtC,IAAI,UAAU,KAAK,MAAM,EAAE,CAAC;gBAC3B,MAAM,SAAS,CAAC,QAAQ,EAAE,qEAAqE,EAAE,EAAE,QAAQ,EAAE,MAAM,EAAE,CAAC,CAAC;YACxH,CAAC;QACF,CAAC;QAED,MAAM,IAAI,GAAG,gBAAgB,CAAC,aAAa,CAAC;QAE5C,MAAM,EAAE,KAAK,EAAE,QAAQ,EAAE,OAAO,EAAE,QAAQ,EAAE,GAAG,MAAM,kBAAkB,CACtE,gBAAgB,CAAC,MAAM,EACvB,UAAU,EACV,IAAI,EACJ,KAAK,EACL,QAAQ,EACR,cAAc,EACd,QAAQ,EACR,SAAS,CACT,CAAC;QAEF,MAAM,CAAC,QAAQ,CAAC,IAAI,CAAC,GAAG,OAAO,CAAC,CAAC;QAEjC,gBAAgB,CAAC,aAAa,IAAI,QAAQ,CAAC;QAE3C,IAAI,KAAK,IAAI,gBAAgB,CAAC,aAAa,EAAE,CAAC;YAC7C,gBAAgB,CAAC,MAAM,GAAG,WAAW,CAAC;QACvC,CAAC;QAED,MAAM,SAAS,CAAC,QAAQ,EAAE,GAAG,QAAQ,CAAC,IAAI,CAAC,IAAI,CAAC,IAAI,EAAE,EAAE,QAAQ,EAAE,MAAM,EAAE,IAAI,EAAE,GAAG,EAAE,CAAC,CAAC;IACxF,CAAC;IAED,OAAO,MAAM,CAAC;AACf,CAAC,CAAC","sourcesContent":["import { mkdir, writeFile } from 'fs/promises';\n\nimport type { IMessage, IRoom, IUser, MessageAttachment, FileProp, RoomType } from '@rocket.chat/core-typings';\nimport { Messages } from '@rocket.chat/models';\n\nimport { settings } from '../../../app/settings/server';\nimport { readSecondaryPreferred } from '../../database/readSecondaryPreferred';\nimport { joinPath } from '../fileUtils';\nimport { i18n } from '../i18n';\n\nconst hideUserName = (\n\tusername: string,\n\tuserData: Pick<IUser, 'username'> | undefined,\n\tusersMap: { userNameTable: Record<string, string> },\n) => {\n\tif (!usersMap.userNameTable) {\n\t\tusersMap.userNameTable = {};\n\t}\n\n\tif (!usersMap.userNameTable[username]) {\n\t\tif (userData && username === userData.username) {\n\t\t\tusersMap.userNameTable[username] = username;\n\t\t} else {\n\t\t\tusersMap.userNameTable[username] = `User_${Object.keys(usersMap.userNameTable).length + 1}`;\n\t\t}\n\t}\n\n\treturn usersMap.userNameTable[username];\n};\n\nconst getAttachmentData = (attachment: MessageAttachment, message: IMessage) => {\n\treturn {\n\t\ttype: 'type' in attachment ? attachment.type : undefined,\n\t\ttitle: attachment.title,\n\t\ttitle_link: attachment.title_link,\n\t\timage_url: 'image_url' in attachment ? attachment.image_url : undefined,\n\t\taudio_url: 'audio_url' in attachment ? attachment.audio_url : undefined,\n\t\tvideo_url: 'video_url' in attachment ? attachment.video_url : undefined,\n\t\tmessage_link: 'message_link' in attachment ? attachment.message_link : undefined,\n\t\timage_type: 'image_type' in attachment ? attachment.image_type : undefined,\n\t\timage_size: 'image_size' in attachment ? attachment.image_size : undefined,\n\t\tvideo_size: 'video_size' in attachment ? attachment.video_size : undefined,\n\t\tvideo_type: 'video_type' in attachment ? attachment.video_type : undefined,\n\t\taudio_size: 'audio_size' in attachment ? attachment.audio_size : undefined,\n\t\taudio_type: 'audio_type' in attachment ? attachment.audio_type : undefined,\n\t\turl:\n\t\t\tattachment.title_link ||\n\t\t\t('image_url' in attachment ? attachment.image_url : undefined) ||\n\t\t\t('audio_url' in attachment ? attachment.audio_url : undefined) ||\n\t\t\t('video_url' in attachment ? attachment.video_url : undefined) ||\n\t\t\t('message_link' in attachment ? attachment.message_link : undefined) ||\n\t\t\tnull,\n\t\tremote: !message.file?._id,\n\t\tfileId: message.file?._id,\n\t\tfileName: message.file?.name,\n\t};\n};\n\nexport type MessageData = Pick<IMessage, 'msg' | 'ts'> & {\n\tusername?: IUser['username'] | IUser['name'];\n\tattachments?: ReturnType<typeof getAttachmentData>[];\n\ttype?: IMessage['t'];\n};\n\nexport const getMessageData = (\n\tmsg: IMessage,\n\thideUsers: boolean,\n\tuserData: Pick<IUser, 'username'> | undefined,\n\tusersMap: { userNameTable: Record<string, string> },\n): MessageData => {\n\tconst username = hideUsers ? hideUserName(msg.u.username || msg.u.name || '', userData, usersMap) : msg.u.username;\n\n\tconst messageObject = {\n\t\tmsg: msg.msg,\n\t\tusername,\n\t\tts: msg.ts,\n\t\t...(msg.attachments && {\n\t\t\tattachments: msg.attachments.map((attachment) => getAttachmentData(attachment, msg)),\n\t\t}),\n\t\t...(msg.t && { type: msg.t }),\n\t};\n\n\tswitch (msg.t) {\n\t\tcase 'uj':\n\t\t\tmessageObject.msg = i18n.t('User_joined_the_channel');\n\t\t\tbreak;\n\t\tcase 'ul':\n\t\t\tmessageObject.msg = i18n.t('User_left_this_channel');\n\t\t\tbreak;\n\t\tcase 'ult':\n\t\t\tmessageObject.msg = i18n.t('User_left_this_team');\n\t\t\tbreak;\n\t\tcase 'user-added-room-to-team':\n\t\t\tmessageObject.msg = i18n.t('added__roomName__to_this_team', {\n\t\t\t\troomName: msg.msg,\n\t\t\t});\n\t\t\tbreak;\n\t\tcase 'user-converted-to-team':\n\t\t\tmessageObject.msg = i18n.t('Converted__roomName__to_a_team', {\n\t\t\t\troomName: msg.msg,\n\t\t\t});\n\t\t\tbreak;\n\t\tcase 'user-converted-to-channel':\n\t\t\tmessageObject.msg = i18n.t('Converted__roomName__to_a_channel', {\n\t\t\t\troomName: msg.msg,\n\t\t\t});\n\t\t\tbreak;\n\t\tcase 'user-deleted-room-from-team':\n\t\t\tmessageObject.msg = i18n.t('Deleted__roomName__room', {\n\t\t\t\troomName: msg.msg,\n\t\t\t});\n\t\t\tbreak;\n\t\tcase 'user-removed-room-from-team':\n\t\t\tmessageObject.msg = i18n.t('Removed__roomName__from_the_team', {\n\t\t\t\troomName: msg.msg,\n\t\t\t});\n\t\t\tbreak;\n\t\tcase 'ujt':\n\t\t\tmessageObject.msg = i18n.t('User_joined_the_team');\n\t\t\tbreak;\n\t\tcase 'au':\n\t\t\tmessageObject.msg = i18n.t('User_added_to', {\n\t\t\t\tuser_added: hideUserName(msg.msg, userData, usersMap),\n\t\t\t\tuser_by: username,\n\t\t\t});\n\t\t\tbreak;\n\t\tcase 'added-user-to-team':\n\t\t\tmessageObject.msg = i18n.t('Added__username__to_this_team', {\n\t\t\t\tuser_added: msg.msg,\n\t\t\t});\n\t\t\tbreak;\n\t\tcase 'r':\n\t\t\tmessageObject.msg = i18n.t('Room_name_changed_to', {\n\t\t\t\troom_name: msg.msg,\n\t\t\t\tuser_by: username,\n\t\t\t});\n\t\t\tbreak;\n\t\tcase 'ru':\n\t\t\tmessageObject.msg = i18n.t('User_has_been_removed', {\n\t\t\t\tuser_removed: hideUserName(msg.msg, userData, usersMap),\n\t\t\t\tuser_by: username,\n\t\t\t});\n\t\t\tbreak;\n\t\tcase 'removed-user-from-team':\n\t\t\tmessageObject.msg = i18n.t('Removed__username__from_the_team', {\n\t\t\t\tuser_removed: hideUserName(msg.msg, userData, usersMap),\n\t\t\t});\n\t\t\tbreak;\n\t\tcase 'wm':\n\t\t\tmessageObject.msg = i18n.t('Welcome', { user: username });\n\t\t\tbreak;\n\t\tcase 'livechat-close':\n\t\t\tmessageObject.msg = i18n.t('Conversation_finished');\n\t\t\tbreak;\n\t\tcase 'livechat-started':\n\t\t\tmessageObject.msg = i18n.t('Chat_started');\n\t\t\tbreak;\n\t}\n\n\treturn messageObject;\n};\n\nexport const exportMessageObject = (type: 'json' | 'html', messageObject: MessageData, messageFile?: FileProp): string => {\n\tif (type === 'json') {\n\t\treturn JSON.stringify(messageObject);\n\t}\n\n\tconst file = [];\n\n\tconst messageType = messageObject.type;\n\tconst timestamp = messageObject.ts ? new Date(messageObject.ts).toUTCString() : '';\n\n\tconst italicTypes: IMessage['t'][] = ['uj', 'ul', 'au', 'r', 'ru', 'wm', 'livechat-close'];\n\n\tconst message = italicTypes.includes(messageType) ? `<i>${messageObject.msg}</i>` : messageObject.msg;\n\n\tfile.push(`<p><strong>${messageObject.username}</strong> (${timestamp}):<br/>`);\n\tfile.push(message);\n\n\tif (messageFile?._id) {\n\t\tconst attachment = messageObject.attachments?.find((att) => att.type === 'file' && att.title_link?.includes(messageFile._id));\n\n\t\tconst description = attachment?.title || i18n.t('Message_Attachments');\n\n\t\tconst assetUrl = `./assets/${messageFile._id}-${messageFile.name}`;\n\t\tconst link = `<br/><a href=\"${assetUrl}\">${description}</a>`;\n\t\tfile.push(link);\n\t}\n\n\tfile.push('</p>');\n\n\treturn file.join('\\n');\n};\n\nexport const exportRoomMessages = async (\n\trid: IRoom['_id'],\n\texportType: 'json' | 'html',\n\tskip: number,\n\tlimit: number,\n\tuserData: any,\n\tfilter: any = {},\n\tusersMap: any = {},\n\thideUsers = true,\n) => {\n\tconst readPreference = readSecondaryPreferred();\n\n\tconst { cursor, totalCount } = Messages.findPaginated(\n\t\t{ ...filter, rid },\n\t\t{\n\t\t\tsort: { ts: 1 },\n\t\t\tskip,\n\t\t\tlimit,\n\t\t\treadPreference,\n\t\t},\n\t);\n\n\tconst [results, total] = await Promise.all([cursor.toArray(), totalCount]);\n\n\tconst result = {\n\t\ttotal,\n\t\texported: results.length,\n\t\tmessages: [] as string[],\n\t\tuploads: [] as FileProp[],\n\t};\n\n\tresults.forEach((msg) => {\n\t\tconst messageObject = getMessageData(msg, hideUsers, userData, usersMap);\n\n\t\tif (msg.file) {\n\t\t\tresult.uploads.push(msg.file);\n\t\t}\n\n\t\tresult.messages.push(exportMessageObject(exportType, messageObject, msg.file));\n\t});\n\n\treturn result;\n};\n\nexport const exportRoomMessagesToFile = async function (\n\texportPath: string,\n\tassetsPath: string,\n\texportType: 'json' | 'html',\n\troomList: (\n\t\t| {\n\t\t\t\troomId: string;\n\t\t\t\troomName: string;\n\t\t\t\tuserId: string | undefined;\n\t\t\t\texportedCount: number;\n\t\t\t\tstatus: string;\n\t\t\t\ttype: RoomType;\n\t\t\t\ttargetFile: string;\n\t\t  }\n\t\t| Record<string, never>\n\t)[],\n\tuserData: IUser,\n\tmessagesFilter = {},\n\tusersMap = {},\n\thideUsers = true,\n) {\n\tawait mkdir(exportPath, { recursive: true });\n\tawait mkdir(assetsPath, { recursive: true });\n\n\tconst result = {\n\t\tfileList: [] as FileProp[],\n\t};\n\n\tconst limit =\n\t\tsettings.get<number>('UserData_MessageLimitPerRequest') > 0 ? settings.get<number>('UserData_MessageLimitPerRequest') : 1000;\n\tfor await (const exportOpRoomData of roomList) {\n\t\tif (!('targetFile' in exportOpRoomData)) {\n\t\t\tcontinue;\n\t\t}\n\n\t\tconst filePath = joinPath(exportPath, exportOpRoomData.targetFile);\n\t\tif (exportOpRoomData.status === 'pending') {\n\t\t\texportOpRoomData.status = 'exporting';\n\t\t\tif (exportType === 'html') {\n\t\t\t\tawait writeFile(filePath, '<meta http-equiv=\"content-type\" content=\"text/html; charset=utf-8\">', { encoding: 'utf8' });\n\t\t\t}\n\t\t}\n\n\t\tconst skip = exportOpRoomData.exportedCount;\n\n\t\tconst { total, exported, uploads, messages } = await exportRoomMessages(\n\t\t\texportOpRoomData.roomId,\n\t\t\texportType,\n\t\t\tskip,\n\t\t\tlimit,\n\t\t\tuserData,\n\t\t\tmessagesFilter,\n\t\t\tusersMap,\n\t\t\thideUsers,\n\t\t);\n\n\t\tresult.fileList.push(...uploads);\n\n\t\texportOpRoomData.exportedCount += exported;\n\n\t\tif (total <= exportOpRoomData.exportedCount) {\n\t\t\texportOpRoomData.status = 'completed';\n\t\t}\n\n\t\tawait writeFile(filePath, `${messages.join('\\n')}\\n`, { encoding: 'utf8', flag: 'a' });\n\t}\n\n\treturn result;\n};\n"]}}},"code":"!module.wrapAsync(async function (module, __reifyWaitForDeps__, __reify_async_result__) {\n  \"use strict\";\n  try {\n    let _objectSpread;\n    module.link(\"@babel/runtime/helpers/objectSpread2\", {\n      default(v) {\n        _objectSpread = v;\n      }\n    }, 0);\n    let _asyncIterator;\n    module.link(\"@babel/runtime/helpers/asyncIterator\", {\n      default(v) {\n        _asyncIterator = v;\n      }\n    }, 1);\n    module.export({\n      getMessageData: () => getMessageData,\n      exportMessageObject: () => exportMessageObject,\n      exportRoomMessages: () => exportRoomMessages,\n      exportRoomMessagesToFile: () => exportRoomMessagesToFile\n    });\n    let mkdir, writeFile;\n    module.link(\"fs/promises\", {\n      mkdir(v) {\n        mkdir = v;\n      },\n      writeFile(v) {\n        writeFile = v;\n      }\n    }, 0);\n    let Messages;\n    module.link(\"@rocket.chat/models\", {\n      Messages(v) {\n        Messages = v;\n      }\n    }, 1);\n    let settings;\n    module.link(\"../../../app/settings/server\", {\n      settings(v) {\n        settings = v;\n      }\n    }, 2);\n    let readSecondaryPreferred;\n    module.link(\"../../database/readSecondaryPreferred\", {\n      readSecondaryPreferred(v) {\n        readSecondaryPreferred = v;\n      }\n    }, 3);\n    let joinPath;\n    module.link(\"../fileUtils\", {\n      joinPath(v) {\n        joinPath = v;\n      }\n    }, 4);\n    let i18n;\n    module.link(\"../i18n\", {\n      i18n(v) {\n        i18n = v;\n      }\n    }, 5);\n    if (__reifyWaitForDeps__()) (await __reifyWaitForDeps__())();\n    const hideUserName = (username, userData, usersMap) => {\n      if (!usersMap.userNameTable) {\n        usersMap.userNameTable = {};\n      }\n      if (!usersMap.userNameTable[username]) {\n        if (userData && username === userData.username) {\n          usersMap.userNameTable[username] = username;\n        } else {\n          usersMap.userNameTable[username] = \"User_\".concat(Object.keys(usersMap.userNameTable).length + 1);\n        }\n      }\n      return usersMap.userNameTable[username];\n    };\n    const getAttachmentData = (attachment, message) => {\n      var _message$file, _message$file2, _message$file3;\n      return {\n        type: 'type' in attachment ? attachment.type : undefined,\n        title: attachment.title,\n        title_link: attachment.title_link,\n        image_url: 'image_url' in attachment ? attachment.image_url : undefined,\n        audio_url: 'audio_url' in attachment ? attachment.audio_url : undefined,\n        video_url: 'video_url' in attachment ? attachment.video_url : undefined,\n        message_link: 'message_link' in attachment ? attachment.message_link : undefined,\n        image_type: 'image_type' in attachment ? attachment.image_type : undefined,\n        image_size: 'image_size' in attachment ? attachment.image_size : undefined,\n        video_size: 'video_size' in attachment ? attachment.video_size : undefined,\n        video_type: 'video_type' in attachment ? attachment.video_type : undefined,\n        audio_size: 'audio_size' in attachment ? attachment.audio_size : undefined,\n        audio_type: 'audio_type' in attachment ? attachment.audio_type : undefined,\n        url: attachment.title_link || ('image_url' in attachment ? attachment.image_url : undefined) || ('audio_url' in attachment ? attachment.audio_url : undefined) || ('video_url' in attachment ? attachment.video_url : undefined) || ('message_link' in attachment ? attachment.message_link : undefined) || null,\n        remote: !((_message$file = message.file) !== null && _message$file !== void 0 && _message$file._id),\n        fileId: (_message$file2 = message.file) === null || _message$file2 === void 0 ? void 0 : _message$file2._id,\n        fileName: (_message$file3 = message.file) === null || _message$file3 === void 0 ? void 0 : _message$file3.name\n      };\n    };\n    const getMessageData = (msg, hideUsers, userData, usersMap) => {\n      const username = hideUsers ? hideUserName(msg.u.username || msg.u.name || '', userData, usersMap) : msg.u.username;\n      const messageObject = _objectSpread(_objectSpread({\n        msg: msg.msg,\n        username,\n        ts: msg.ts\n      }, msg.attachments && {\n        attachments: msg.attachments.map(attachment => getAttachmentData(attachment, msg))\n      }), msg.t && {\n        type: msg.t\n      });\n      switch (msg.t) {\n        case 'uj':\n          messageObject.msg = i18n.t('User_joined_the_channel');\n          break;\n        case 'ul':\n          messageObject.msg = i18n.t('User_left_this_channel');\n          break;\n        case 'ult':\n          messageObject.msg = i18n.t('User_left_this_team');\n          break;\n        case 'user-added-room-to-team':\n          messageObject.msg = i18n.t('added__roomName__to_this_team', {\n            roomName: msg.msg\n          });\n          break;\n        case 'user-converted-to-team':\n          messageObject.msg = i18n.t('Converted__roomName__to_a_team', {\n            roomName: msg.msg\n          });\n          break;\n        case 'user-converted-to-channel':\n          messageObject.msg = i18n.t('Converted__roomName__to_a_channel', {\n            roomName: msg.msg\n          });\n          break;\n        case 'user-deleted-room-from-team':\n          messageObject.msg = i18n.t('Deleted__roomName__room', {\n            roomName: msg.msg\n          });\n          break;\n        case 'user-removed-room-from-team':\n          messageObject.msg = i18n.t('Removed__roomName__from_the_team', {\n            roomName: msg.msg\n          });\n          break;\n        case 'ujt':\n          messageObject.msg = i18n.t('User_joined_the_team');\n          break;\n        case 'au':\n          messageObject.msg = i18n.t('User_added_to', {\n            user_added: hideUserName(msg.msg, userData, usersMap),\n            user_by: username\n          });\n          break;\n        case 'added-user-to-team':\n          messageObject.msg = i18n.t('Added__username__to_this_team', {\n            user_added: msg.msg\n          });\n          break;\n        case 'r':\n          messageObject.msg = i18n.t('Room_name_changed_to', {\n            room_name: msg.msg,\n            user_by: username\n          });\n          break;\n        case 'ru':\n          messageObject.msg = i18n.t('User_has_been_removed', {\n            user_removed: hideUserName(msg.msg, userData, usersMap),\n            user_by: username\n          });\n          break;\n        case 'removed-user-from-team':\n          messageObject.msg = i18n.t('Removed__username__from_the_team', {\n            user_removed: hideUserName(msg.msg, userData, usersMap)\n          });\n          break;\n        case 'wm':\n          messageObject.msg = i18n.t('Welcome', {\n            user: username\n          });\n          break;\n        case 'livechat-close':\n          messageObject.msg = i18n.t('Conversation_finished');\n          break;\n        case 'livechat-started':\n          messageObject.msg = i18n.t('Chat_started');\n          break;\n      }\n      return messageObject;\n    };\n    const exportMessageObject = (type, messageObject, messageFile) => {\n      if (type === 'json') {\n        return JSON.stringify(messageObject);\n      }\n      const file = [];\n      const messageType = messageObject.type;\n      const timestamp = messageObject.ts ? new Date(messageObject.ts).toUTCString() : '';\n      const italicTypes = ['uj', 'ul', 'au', 'r', 'ru', 'wm', 'livechat-close'];\n      const message = italicTypes.includes(messageType) ? \"<i>\".concat(messageObject.msg, \"</i>\") : messageObject.msg;\n      file.push(\"<p><strong>\".concat(messageObject.username, \"</strong> (\").concat(timestamp, \"):<br/>\"));\n      file.push(message);\n      if (messageFile !== null && messageFile !== void 0 && messageFile._id) {\n        var _messageObject$attach;\n        const attachment = (_messageObject$attach = messageObject.attachments) === null || _messageObject$attach === void 0 ? void 0 : _messageObject$attach.find(att => {\n          var _att$title_link;\n          return att.type === 'file' && ((_att$title_link = att.title_link) === null || _att$title_link === void 0 ? void 0 : _att$title_link.includes(messageFile._id));\n        });\n        const description = (attachment === null || attachment === void 0 ? void 0 : attachment.title) || i18n.t('Message_Attachments');\n        const assetUrl = \"./assets/\".concat(messageFile._id, \"-\").concat(messageFile.name);\n        const link = \"<br/><a href=\\\"\".concat(assetUrl, \"\\\">\").concat(description, \"</a>\");\n        file.push(link);\n      }\n      file.push('</p>');\n      return file.join('\\n');\n    };\n    const exportRoomMessages = async function (rid, exportType, skip, limit, userData) {\n      let filter = arguments.length > 5 && arguments[5] !== undefined ? arguments[5] : {};\n      let usersMap = arguments.length > 6 && arguments[6] !== undefined ? arguments[6] : {};\n      let hideUsers = arguments.length > 7 && arguments[7] !== undefined ? arguments[7] : true;\n      const readPreference = readSecondaryPreferred();\n      const {\n        cursor,\n        totalCount\n      } = Messages.findPaginated(_objectSpread(_objectSpread({}, filter), {}, {\n        rid\n      }), {\n        sort: {\n          ts: 1\n        },\n        skip,\n        limit,\n        readPreference\n      });\n      const [results, total] = await Promise.all([cursor.toArray(), totalCount]);\n      const result = {\n        total,\n        exported: results.length,\n        messages: [],\n        uploads: []\n      };\n      results.forEach(msg => {\n        const messageObject = getMessageData(msg, hideUsers, userData, usersMap);\n        if (msg.file) {\n          result.uploads.push(msg.file);\n        }\n        result.messages.push(exportMessageObject(exportType, messageObject, msg.file));\n      });\n      return result;\n    };\n    const exportRoomMessagesToFile = async function (exportPath, assetsPath, exportType, roomList, userData) {\n      let messagesFilter = arguments.length > 5 && arguments[5] !== undefined ? arguments[5] : {};\n      let usersMap = arguments.length > 6 && arguments[6] !== undefined ? arguments[6] : {};\n      let hideUsers = arguments.length > 7 && arguments[7] !== undefined ? arguments[7] : true;\n      await mkdir(exportPath, {\n        recursive: true\n      });\n      await mkdir(assetsPath, {\n        recursive: true\n      });\n      const result = {\n        fileList: []\n      };\n      const limit = settings.get('UserData_MessageLimitPerRequest') > 0 ? settings.get('UserData_MessageLimitPerRequest') : 1000;\n      var _iteratorAbruptCompletion = false;\n      var _didIteratorError = false;\n      var _iteratorError;\n      try {\n        for (var _iterator = _asyncIterator(roomList), _step; _iteratorAbruptCompletion = !(_step = await _iterator.next()).done; _iteratorAbruptCompletion = false) {\n          const exportOpRoomData = _step.value;\n          {\n            if (!('targetFile' in exportOpRoomData)) {\n              continue;\n            }\n            const filePath = joinPath(exportPath, exportOpRoomData.targetFile);\n            if (exportOpRoomData.status === 'pending') {\n              exportOpRoomData.status = 'exporting';\n              if (exportType === 'html') {\n                await writeFile(filePath, '<meta http-equiv=\"content-type\" content=\"text/html; charset=utf-8\">', {\n                  encoding: 'utf8'\n                });\n              }\n            }\n            const skip = exportOpRoomData.exportedCount;\n            const {\n              total,\n              exported,\n              uploads,\n              messages\n            } = await exportRoomMessages(exportOpRoomData.roomId, exportType, skip, limit, userData, messagesFilter, usersMap, hideUsers);\n            result.fileList.push(...uploads);\n            exportOpRoomData.exportedCount += exported;\n            if (total <= exportOpRoomData.exportedCount) {\n              exportOpRoomData.status = 'completed';\n            }\n            await writeFile(filePath, \"\".concat(messages.join('\\n'), \"\\n\"), {\n              encoding: 'utf8',\n              flag: 'a'\n            });\n          }\n        }\n      } catch (err) {\n        _didIteratorError = true;\n        _iteratorError = err;\n      } finally {\n        try {\n          if (_iteratorAbruptCompletion && _iterator.return != null) {\n            await _iterator.return();\n          }\n        } finally {\n          if (_didIteratorError) {\n            throw _iteratorError;\n          }\n        }\n      }\n      return result;\n    };\n    __reify_async_result__();\n  } catch (_reifyError) {\n    return __reify_async_result__(_reifyError);\n  }\n  __reify_async_result__()\n}, {\n  self: this,\n  async: false\n});","map":{"version":3,"names":["_objectSpread","module","link","default","v","_asyncIterator","export","getMessageData","exportMessageObject","exportRoomMessages","exportRoomMessagesToFile","mkdir","writeFile","Messages","settings","readSecondaryPreferred","joinPath","i18n","__reifyWaitForDeps__","hideUserName","username","userData","usersMap","userNameTable","concat","Object","keys","length","getAttachmentData","attachment","message","_message$file","_message$file2","_message$file3","type","undefined","title","title_link","image_url","audio_url","video_url","message_link","image_type","image_size","video_size","video_type","audio_size","audio_type","url","remote","file","_id","fileId","fileName","name","msg","hideUsers","u","messageObject","ts","attachments","map","t","roomName","user_added","user_by","room_name","user_removed","user","messageFile","JSON","stringify","messageType","timestamp","Date","toUTCString","italicTypes","includes","push","_messageObject$attach","find","att","_att$title_link","description","assetUrl","join","rid","exportType","skip","limit","filter","arguments","readPreference","cursor","totalCount","findPaginated","sort","results","total","Promise","all","toArray","result","exported","messages","uploads","forEach","exportPath","assetsPath","roomList","messagesFilter","recursive","fileList","get","_iteratorAbruptCompletion","_didIteratorError","_iteratorError","_iterator","_step","next","done","exportOpRoomData","value","filePath","targetFile","status","encoding","exportedCount","roomId","flag","err","return","__reify_async_result__","_reifyError","self","async"],"sources":["server/lib/dataExport/exportRoomMessagesToFile.ts"],"sourcesContent":["import { mkdir, writeFile } from 'fs/promises';\n\nimport type { IMessage, IRoom, IUser, MessageAttachment, FileProp, RoomType } from '@rocket.chat/core-typings';\nimport { Messages } from '@rocket.chat/models';\n\nimport { settings } from '../../../app/settings/server';\nimport { readSecondaryPreferred } from '../../database/readSecondaryPreferred';\nimport { joinPath } from '../fileUtils';\nimport { i18n } from '../i18n';\n\nconst hideUserName = (\n\tusername: string,\n\tuserData: Pick<IUser, 'username'> | undefined,\n\tusersMap: { userNameTable: Record<string, string> },\n) => {\n\tif (!usersMap.userNameTable) {\n\t\tusersMap.userNameTable = {};\n\t}\n\n\tif (!usersMap.userNameTable[username]) {\n\t\tif (userData && username === userData.username) {\n\t\t\tusersMap.userNameTable[username] = username;\n\t\t} else {\n\t\t\tusersMap.userNameTable[username] = `User_${Object.keys(usersMap.userNameTable).length + 1}`;\n\t\t}\n\t}\n\n\treturn usersMap.userNameTable[username];\n};\n\nconst getAttachmentData = (attachment: MessageAttachment, message: IMessage) => {\n\treturn {\n\t\ttype: 'type' in attachment ? attachment.type : undefined,\n\t\ttitle: attachment.title,\n\t\ttitle_link: attachment.title_link,\n\t\timage_url: 'image_url' in attachment ? attachment.image_url : undefined,\n\t\taudio_url: 'audio_url' in attachment ? attachment.audio_url : undefined,\n\t\tvideo_url: 'video_url' in attachment ? attachment.video_url : undefined,\n\t\tmessage_link: 'message_link' in attachment ? attachment.message_link : undefined,\n\t\timage_type: 'image_type' in attachment ? attachment.image_type : undefined,\n\t\timage_size: 'image_size' in attachment ? attachment.image_size : undefined,\n\t\tvideo_size: 'video_size' in attachment ? attachment.video_size : undefined,\n\t\tvideo_type: 'video_type' in attachment ? attachment.video_type : undefined,\n\t\taudio_size: 'audio_size' in attachment ? attachment.audio_size : undefined,\n\t\taudio_type: 'audio_type' in attachment ? attachment.audio_type : undefined,\n\t\turl:\n\t\t\tattachment.title_link ||\n\t\t\t('image_url' in attachment ? attachment.image_url : undefined) ||\n\t\t\t('audio_url' in attachment ? attachment.audio_url : undefined) ||\n\t\t\t('video_url' in attachment ? attachment.video_url : undefined) ||\n\t\t\t('message_link' in attachment ? attachment.message_link : undefined) ||\n\t\t\tnull,\n\t\tremote: !message.file?._id,\n\t\tfileId: message.file?._id,\n\t\tfileName: message.file?.name,\n\t};\n};\n\nexport type MessageData = Pick<IMessage, 'msg' | 'ts'> & {\n\tusername?: IUser['username'] | IUser['name'];\n\tattachments?: ReturnType<typeof getAttachmentData>[];\n\ttype?: IMessage['t'];\n};\n\nexport const getMessageData = (\n\tmsg: IMessage,\n\thideUsers: boolean,\n\tuserData: Pick<IUser, 'username'> | undefined,\n\tusersMap: { userNameTable: Record<string, string> },\n): MessageData => {\n\tconst username = hideUsers ? hideUserName(msg.u.username || msg.u.name || '', userData, usersMap) : msg.u.username;\n\n\tconst messageObject = {\n\t\tmsg: msg.msg,\n\t\tusername,\n\t\tts: msg.ts,\n\t\t...(msg.attachments && {\n\t\t\tattachments: msg.attachments.map((attachment) => getAttachmentData(attachment, msg)),\n\t\t}),\n\t\t...(msg.t && { type: msg.t }),\n\t};\n\n\tswitch (msg.t) {\n\t\tcase 'uj':\n\t\t\tmessageObject.msg = i18n.t('User_joined_the_channel');\n\t\t\tbreak;\n\t\tcase 'ul':\n\t\t\tmessageObject.msg = i18n.t('User_left_this_channel');\n\t\t\tbreak;\n\t\tcase 'ult':\n\t\t\tmessageObject.msg = i18n.t('User_left_this_team');\n\t\t\tbreak;\n\t\tcase 'user-added-room-to-team':\n\t\t\tmessageObject.msg = i18n.t('added__roomName__to_this_team', {\n\t\t\t\troomName: msg.msg,\n\t\t\t});\n\t\t\tbreak;\n\t\tcase 'user-converted-to-team':\n\t\t\tmessageObject.msg = i18n.t('Converted__roomName__to_a_team', {\n\t\t\t\troomName: msg.msg,\n\t\t\t});\n\t\t\tbreak;\n\t\tcase 'user-converted-to-channel':\n\t\t\tmessageObject.msg = i18n.t('Converted__roomName__to_a_channel', {\n\t\t\t\troomName: msg.msg,\n\t\t\t});\n\t\t\tbreak;\n\t\tcase 'user-deleted-room-from-team':\n\t\t\tmessageObject.msg = i18n.t('Deleted__roomName__room', {\n\t\t\t\troomName: msg.msg,\n\t\t\t});\n\t\t\tbreak;\n\t\tcase 'user-removed-room-from-team':\n\t\t\tmessageObject.msg = i18n.t('Removed__roomName__from_the_team', {\n\t\t\t\troomName: msg.msg,\n\t\t\t});\n\t\t\tbreak;\n\t\tcase 'ujt':\n\t\t\tmessageObject.msg = i18n.t('User_joined_the_team');\n\t\t\tbreak;\n\t\tcase 'au':\n\t\t\tmessageObject.msg = i18n.t('User_added_to', {\n\t\t\t\tuser_added: hideUserName(msg.msg, userData, usersMap),\n\t\t\t\tuser_by: username,\n\t\t\t});\n\t\t\tbreak;\n\t\tcase 'added-user-to-team':\n\t\t\tmessageObject.msg = i18n.t('Added__username__to_this_team', {\n\t\t\t\tuser_added: msg.msg,\n\t\t\t});\n\t\t\tbreak;\n\t\tcase 'r':\n\t\t\tmessageObject.msg = i18n.t('Room_name_changed_to', {\n\t\t\t\troom_name: msg.msg,\n\t\t\t\tuser_by: username,\n\t\t\t});\n\t\t\tbreak;\n\t\tcase 'ru':\n\t\t\tmessageObject.msg = i18n.t('User_has_been_removed', {\n\t\t\t\tuser_removed: hideUserName(msg.msg, userData, usersMap),\n\t\t\t\tuser_by: username,\n\t\t\t});\n\t\t\tbreak;\n\t\tcase 'removed-user-from-team':\n\t\t\tmessageObject.msg = i18n.t('Removed__username__from_the_team', {\n\t\t\t\tuser_removed: hideUserName(msg.msg, userData, usersMap),\n\t\t\t});\n\t\t\tbreak;\n\t\tcase 'wm':\n\t\t\tmessageObject.msg = i18n.t('Welcome', { user: username });\n\t\t\tbreak;\n\t\tcase 'livechat-close':\n\t\t\tmessageObject.msg = i18n.t('Conversation_finished');\n\t\t\tbreak;\n\t\tcase 'livechat-started':\n\t\t\tmessageObject.msg = i18n.t('Chat_started');\n\t\t\tbreak;\n\t}\n\n\treturn messageObject;\n};\n\nexport const exportMessageObject = (type: 'json' | 'html', messageObject: MessageData, messageFile?: FileProp): string => {\n\tif (type === 'json') {\n\t\treturn JSON.stringify(messageObject);\n\t}\n\n\tconst file = [];\n\n\tconst messageType = messageObject.type;\n\tconst timestamp = messageObject.ts ? new Date(messageObject.ts).toUTCString() : '';\n\n\tconst italicTypes: IMessage['t'][] = ['uj', 'ul', 'au', 'r', 'ru', 'wm', 'livechat-close'];\n\n\tconst message = italicTypes.includes(messageType) ? `<i>${messageObject.msg}</i>` : messageObject.msg;\n\n\tfile.push(`<p><strong>${messageObject.username}</strong> (${timestamp}):<br/>`);\n\tfile.push(message);\n\n\tif (messageFile?._id) {\n\t\tconst attachment = messageObject.attachments?.find((att) => att.type === 'file' && att.title_link?.includes(messageFile._id));\n\n\t\tconst description = attachment?.title || i18n.t('Message_Attachments');\n\n\t\tconst assetUrl = `./assets/${messageFile._id}-${messageFile.name}`;\n\t\tconst link = `<br/><a href=\"${assetUrl}\">${description}</a>`;\n\t\tfile.push(link);\n\t}\n\n\tfile.push('</p>');\n\n\treturn file.join('\\n');\n};\n\nexport const exportRoomMessages = async (\n\trid: IRoom['_id'],\n\texportType: 'json' | 'html',\n\tskip: number,\n\tlimit: number,\n\tuserData: any,\n\tfilter: any = {},\n\tusersMap: any = {},\n\thideUsers = true,\n) => {\n\tconst readPreference = readSecondaryPreferred();\n\n\tconst { cursor, totalCount } = Messages.findPaginated(\n\t\t{ ...filter, rid },\n\t\t{\n\t\t\tsort: { ts: 1 },\n\t\t\tskip,\n\t\t\tlimit,\n\t\t\treadPreference,\n\t\t},\n\t);\n\n\tconst [results, total] = await Promise.all([cursor.toArray(), totalCount]);\n\n\tconst result = {\n\t\ttotal,\n\t\texported: results.length,\n\t\tmessages: [] as string[],\n\t\tuploads: [] as FileProp[],\n\t};\n\n\tresults.forEach((msg) => {\n\t\tconst messageObject = getMessageData(msg, hideUsers, userData, usersMap);\n\n\t\tif (msg.file) {\n\t\t\tresult.uploads.push(msg.file);\n\t\t}\n\n\t\tresult.messages.push(exportMessageObject(exportType, messageObject, msg.file));\n\t});\n\n\treturn result;\n};\n\nexport const exportRoomMessagesToFile = async function (\n\texportPath: string,\n\tassetsPath: string,\n\texportType: 'json' | 'html',\n\troomList: (\n\t\t| {\n\t\t\t\troomId: string;\n\t\t\t\troomName: string;\n\t\t\t\tuserId: string | undefined;\n\t\t\t\texportedCount: number;\n\t\t\t\tstatus: string;\n\t\t\t\ttype: RoomType;\n\t\t\t\ttargetFile: string;\n\t\t  }\n\t\t| Record<string, never>\n\t)[],\n\tuserData: IUser,\n\tmessagesFilter = {},\n\tusersMap = {},\n\thideUsers = true,\n) {\n\tawait mkdir(exportPath, { recursive: true });\n\tawait mkdir(assetsPath, { recursive: true });\n\n\tconst result = {\n\t\tfileList: [] as FileProp[],\n\t};\n\n\tconst limit =\n\t\tsettings.get<number>('UserData_MessageLimitPerRequest') > 0 ? settings.get<number>('UserData_MessageLimitPerRequest') : 1000;\n\tfor await (const exportOpRoomData of roomList) {\n\t\tif (!('targetFile' in exportOpRoomData)) {\n\t\t\tcontinue;\n\t\t}\n\n\t\tconst filePath = joinPath(exportPath, exportOpRoomData.targetFile);\n\t\tif (exportOpRoomData.status === 'pending') {\n\t\t\texportOpRoomData.status = 'exporting';\n\t\t\tif (exportType === 'html') {\n\t\t\t\tawait writeFile(filePath, '<meta http-equiv=\"content-type\" content=\"text/html; charset=utf-8\">', { encoding: 'utf8' });\n\t\t\t}\n\t\t}\n\n\t\tconst skip = exportOpRoomData.exportedCount;\n\n\t\tconst { total, exported, uploads, messages } = await exportRoomMessages(\n\t\t\texportOpRoomData.roomId,\n\t\t\texportType,\n\t\t\tskip,\n\t\t\tlimit,\n\t\t\tuserData,\n\t\t\tmessagesFilter,\n\t\t\tusersMap,\n\t\t\thideUsers,\n\t\t);\n\n\t\tresult.fileList.push(...uploads);\n\n\t\texportOpRoomData.exportedCount += exported;\n\n\t\tif (total <= exportOpRoomData.exportedCount) {\n\t\t\texportOpRoomData.status = 'completed';\n\t\t}\n\n\t\tawait writeFile(filePath, `${messages.join('\\n')}\\n`, { encoding: 'utf8', flag: 'a' });\n\t}\n\n\treturn result;\n};\n"],"mappings":"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","ignoreList":[]},"sourceType":"module","externalDependencies":{},"hash":"14df7151c28ffddba3d63df91666643821d7d53b"}
