{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/app/livechat/server/livechat.ts","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","topLevelAwait","objectRestSpread","objectRestSpread","asyncGenerators","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"os.osx.arm64"},"sourceFileName":"app/livechat/server/livechat.ts","filename":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/app/livechat/server/livechat.ts","inputSourceMap":{"version":3,"file":"app/livechat/server/livechat.ts","sourceRoot":"","sources":["app/livechat/server/livechat.ts"],"names":[],"mappings":"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","sourcesContent":["import url from 'url';\n\nimport jsdom from 'jsdom';\nimport mem from 'mem';\nimport { WebApp } from 'meteor/webapp';\n\nimport { settings } from '../../settings/server';\nimport { addServerUrlToIndex } from '../lib/Assets';\n\nconst indexHtmlWithServerURL = addServerUrlToIndex((await Assets.getTextAsync('livechat/index.html')) || '');\n\nfunction parseExtraAttributes(widgetData: string): string {\n\tconst liveChatAdditionalScripts = settings.get<string>('Livechat_AdditionalWidgetScripts');\n\tconst additionalClass = settings.get<string>('Livechat_WidgetLayoutClasses');\n\n\tif (liveChatAdditionalScripts == null || additionalClass == null) {\n\t\treturn widgetData;\n\t}\n\n\tconst domParser = new jsdom.JSDOM(widgetData);\n\tconst doc = domParser.window.document;\n\tconst head = doc.querySelector('head');\n\tconst body = doc.querySelector('body');\n\n\tliveChatAdditionalScripts.split(',').forEach((script) => {\n\t\tconst scriptElement = doc.createElement('script');\n\t\tscriptElement.src = script;\n\t\tbody?.appendChild(scriptElement);\n\t});\n\n\tadditionalClass.split(',').forEach((css) => {\n\t\tconst linkElement = doc.createElement('link');\n\t\tlinkElement.rel = 'stylesheet';\n\t\tlinkElement.href = css;\n\t\thead?.appendChild(linkElement);\n\t});\n\n\treturn doc.documentElement.innerHTML;\n}\n\nconst memoizedParseExtraAttributes = mem(parseExtraAttributes, { maxAge: process.env.TEST_MODE === 'true' ? 1 : 60000 });\n\nWebApp.connectHandlers.use('/livechat', (req, res, next) => {\n\tif (!req.url) {\n\t\treturn next();\n\t}\n\n\tconst reqUrl = url.parse(req.url);\n\tif (reqUrl.pathname !== '/') {\n\t\treturn next();\n\t}\n\n\tres.setHeader('content-type', 'text/html; charset=utf-8');\n\tconst domainWhiteListSetting = settings.get<string>('Livechat_AllowedDomainsList');\n\tlet domainWhiteList = [];\n\tif (req.headers.referer && domainWhiteListSetting.trim()) {\n\t\tdomainWhiteList = domainWhiteListSetting.split(',').map((domain) => domain.trim());\n\t\tconst referer = url.parse(req.headers.referer);\n\t\tif (referer.host && !domainWhiteList.includes(referer.host)) {\n\t\t\tres.setHeader('Content-Security-Policy', \"frame-ancestors 'none'\");\n\t\t\treturn next();\n\t\t}\n\t\tres.setHeader('Content-Security-Policy', `frame-ancestors ${referer.protocol}//${referer.host}`);\n\t} else {\n\t\t// TODO need to remove inline scripts from this route to be able to enable CSP here as well\n\t\tres.removeHeader('Content-Security-Policy');\n\t}\n\n\tres.write(memoizedParseExtraAttributes(indexHtmlWithServerURL));\n\tres.end();\n});\n"]},"targets":{"android":"125.0.0","chrome":"125.0.0","edge":"125.0.0","firefox":"115.0.0","ie":"10.0.0","ios":"17.4.0","opera":"110.0.0","opera_mobile":"80.0.0","safari":"17.4.0","samsung":"24.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor","root":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":false,"enforceStrictMode":false,"dynamicImport":true,"generateLetDeclarations":true,"topLevelAwait":true},"externalDependencies":[]},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"version":"7.17.2","helpers":true,"useESModules":false,"corejs":false},"externalDependencies":[]},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-async-generator-functions","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-class-properties","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true},"externalDependencies":[]},{"key":"transform-react-jsx","visitor":{"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXFragment":{"exit":[null]},"JSXElement":{"exit":[null]},"JSXAttribute":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false},"externalDependencies":[]},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-nullish-coalescing-operator","visitor":{"LogicalExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-optional-chaining","visitor":{"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-optional-catch-binding","visitor":{"CatchClause":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-class-properties","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-async-generator-functions","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-logical-assignment-operators","visitor":{"AssignmentExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]}],"presets":[],"generatorOpts":{"filename":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/app/livechat/server/livechat.ts","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"app/livechat/server/livechat.ts","inputSourceMap":{"version":3,"file":"app/livechat/server/livechat.ts","sourceRoot":"","sources":["app/livechat/server/livechat.ts"],"names":[],"mappings":"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","sourcesContent":["import url from 'url';\n\nimport jsdom from 'jsdom';\nimport mem from 'mem';\nimport { WebApp } from 'meteor/webapp';\n\nimport { settings } from '../../settings/server';\nimport { addServerUrlToIndex } from '../lib/Assets';\n\nconst indexHtmlWithServerURL = addServerUrlToIndex((await Assets.getTextAsync('livechat/index.html')) || '');\n\nfunction parseExtraAttributes(widgetData: string): string {\n\tconst liveChatAdditionalScripts = settings.get<string>('Livechat_AdditionalWidgetScripts');\n\tconst additionalClass = settings.get<string>('Livechat_WidgetLayoutClasses');\n\n\tif (liveChatAdditionalScripts == null || additionalClass == null) {\n\t\treturn widgetData;\n\t}\n\n\tconst domParser = new jsdom.JSDOM(widgetData);\n\tconst doc = domParser.window.document;\n\tconst head = doc.querySelector('head');\n\tconst body = doc.querySelector('body');\n\n\tliveChatAdditionalScripts.split(',').forEach((script) => {\n\t\tconst scriptElement = doc.createElement('script');\n\t\tscriptElement.src = script;\n\t\tbody?.appendChild(scriptElement);\n\t});\n\n\tadditionalClass.split(',').forEach((css) => {\n\t\tconst linkElement = doc.createElement('link');\n\t\tlinkElement.rel = 'stylesheet';\n\t\tlinkElement.href = css;\n\t\thead?.appendChild(linkElement);\n\t});\n\n\treturn doc.documentElement.innerHTML;\n}\n\nconst memoizedParseExtraAttributes = mem(parseExtraAttributes, { maxAge: process.env.TEST_MODE === 'true' ? 1 : 60000 });\n\nWebApp.connectHandlers.use('/livechat', (req, res, next) => {\n\tif (!req.url) {\n\t\treturn next();\n\t}\n\n\tconst reqUrl = url.parse(req.url);\n\tif (reqUrl.pathname !== '/') {\n\t\treturn next();\n\t}\n\n\tres.setHeader('content-type', 'text/html; charset=utf-8');\n\tconst domainWhiteListSetting = settings.get<string>('Livechat_AllowedDomainsList');\n\tlet domainWhiteList = [];\n\tif (req.headers.referer && domainWhiteListSetting.trim()) {\n\t\tdomainWhiteList = domainWhiteListSetting.split(',').map((domain) => domain.trim());\n\t\tconst referer = url.parse(req.headers.referer);\n\t\tif (referer.host && !domainWhiteList.includes(referer.host)) {\n\t\t\tres.setHeader('Content-Security-Policy', \"frame-ancestors 'none'\");\n\t\t\treturn next();\n\t\t}\n\t\tres.setHeader('Content-Security-Policy', `frame-ancestors ${referer.protocol}//${referer.host}`);\n\t} else {\n\t\t// TODO need to remove inline scripts from this route to be able to enable CSP here as well\n\t\tres.removeHeader('Content-Security-Policy');\n\t}\n\n\tres.write(memoizedParseExtraAttributes(indexHtmlWithServerURL));\n\tres.end();\n});\n"]}}},"code":"!module.wrapAsync(async function (module, __reifyWaitForDeps__, __reify_async_result__) {\n  \"use strict\";\n  try {\n    let url;\n    module.link(\"url\", {\n      default(v) {\n        url = v;\n      }\n    }, 0);\n    let jsdom;\n    module.link(\"jsdom\", {\n      default(v) {\n        jsdom = v;\n      }\n    }, 1);\n    let mem;\n    module.link(\"mem\", {\n      default(v) {\n        mem = v;\n      }\n    }, 2);\n    let WebApp;\n    module.link(\"meteor/webapp\", {\n      WebApp(v) {\n        WebApp = v;\n      }\n    }, 3);\n    let settings;\n    module.link(\"../../settings/server\", {\n      settings(v) {\n        settings = v;\n      }\n    }, 4);\n    let addServerUrlToIndex;\n    module.link(\"../lib/Assets\", {\n      addServerUrlToIndex(v) {\n        addServerUrlToIndex = v;\n      }\n    }, 5);\n    if (__reifyWaitForDeps__()) (await __reifyWaitForDeps__())();\n    const indexHtmlWithServerURL = addServerUrlToIndex((await Assets.getTextAsync('livechat/index.html')) || '');\n    function parseExtraAttributes(widgetData) {\n      const liveChatAdditionalScripts = settings.get('Livechat_AdditionalWidgetScripts');\n      const additionalClass = settings.get('Livechat_WidgetLayoutClasses');\n      if (liveChatAdditionalScripts == null || additionalClass == null) {\n        return widgetData;\n      }\n      const domParser = new jsdom.JSDOM(widgetData);\n      const doc = domParser.window.document;\n      const head = doc.querySelector('head');\n      const body = doc.querySelector('body');\n      liveChatAdditionalScripts.split(',').forEach(script => {\n        const scriptElement = doc.createElement('script');\n        scriptElement.src = script;\n        body === null || body === void 0 ? void 0 : body.appendChild(scriptElement);\n      });\n      additionalClass.split(',').forEach(css => {\n        const linkElement = doc.createElement('link');\n        linkElement.rel = 'stylesheet';\n        linkElement.href = css;\n        head === null || head === void 0 ? void 0 : head.appendChild(linkElement);\n      });\n      return doc.documentElement.innerHTML;\n    }\n    const memoizedParseExtraAttributes = mem(parseExtraAttributes, {\n      maxAge: process.env.TEST_MODE === 'true' ? 1 : 60000\n    });\n    WebApp.connectHandlers.use('/livechat', (req, res, next) => {\n      if (!req.url) {\n        return next();\n      }\n      const reqUrl = url.parse(req.url);\n      if (reqUrl.pathname !== '/') {\n        return next();\n      }\n      res.setHeader('content-type', 'text/html; charset=utf-8');\n      const domainWhiteListSetting = settings.get('Livechat_AllowedDomainsList');\n      let domainWhiteList = [];\n      if (req.headers.referer && domainWhiteListSetting.trim()) {\n        domainWhiteList = domainWhiteListSetting.split(',').map(domain => domain.trim());\n        const referer = url.parse(req.headers.referer);\n        if (referer.host && !domainWhiteList.includes(referer.host)) {\n          res.setHeader('Content-Security-Policy', \"frame-ancestors 'none'\");\n          return next();\n        }\n        res.setHeader('Content-Security-Policy', \"frame-ancestors \".concat(referer.protocol, \"//\").concat(referer.host));\n      } else {\n        // TODO need to remove inline scripts from this route to be able to enable CSP here as well\n        res.removeHeader('Content-Security-Policy');\n      }\n      res.write(memoizedParseExtraAttributes(indexHtmlWithServerURL));\n      res.end();\n    });\n    __reify_async_result__();\n  } catch (_reifyError) {\n    return __reify_async_result__(_reifyError);\n  }\n  __reify_async_result__()\n}, {\n  self: this,\n  async: false\n});","map":{"version":3,"names":["url","module","link","default","v","jsdom","mem","WebApp","settings","addServerUrlToIndex","__reifyWaitForDeps__","indexHtmlWithServerURL","Assets","getTextAsync","parseExtraAttributes","widgetData","liveChatAdditionalScripts","get","additionalClass","domParser","JSDOM","doc","window","document","head","querySelector","body","split","forEach","script","scriptElement","createElement","src","appendChild","css","linkElement","rel","href","documentElement","innerHTML","memoizedParseExtraAttributes","maxAge","process","env","TEST_MODE","connectHandlers","use","req","res","next","reqUrl","parse","pathname","setHeader","domainWhiteListSetting","domainWhiteList","headers","referer","trim","map","domain","host","includes","concat","protocol","removeHeader","write","end","__reify_async_result__","_reifyError","self","async"],"sources":["app/livechat/server/livechat.ts"],"sourcesContent":["import url from 'url';\n\nimport jsdom from 'jsdom';\nimport mem from 'mem';\nimport { WebApp } from 'meteor/webapp';\n\nimport { settings } from '../../settings/server';\nimport { addServerUrlToIndex } from '../lib/Assets';\n\nconst indexHtmlWithServerURL = addServerUrlToIndex((await Assets.getTextAsync('livechat/index.html')) || '');\n\nfunction parseExtraAttributes(widgetData: string): string {\n\tconst liveChatAdditionalScripts = settings.get<string>('Livechat_AdditionalWidgetScripts');\n\tconst additionalClass = settings.get<string>('Livechat_WidgetLayoutClasses');\n\n\tif (liveChatAdditionalScripts == null || additionalClass == null) {\n\t\treturn widgetData;\n\t}\n\n\tconst domParser = new jsdom.JSDOM(widgetData);\n\tconst doc = domParser.window.document;\n\tconst head = doc.querySelector('head');\n\tconst body = doc.querySelector('body');\n\n\tliveChatAdditionalScripts.split(',').forEach((script) => {\n\t\tconst scriptElement = doc.createElement('script');\n\t\tscriptElement.src = script;\n\t\tbody?.appendChild(scriptElement);\n\t});\n\n\tadditionalClass.split(',').forEach((css) => {\n\t\tconst linkElement = doc.createElement('link');\n\t\tlinkElement.rel = 'stylesheet';\n\t\tlinkElement.href = css;\n\t\thead?.appendChild(linkElement);\n\t});\n\n\treturn doc.documentElement.innerHTML;\n}\n\nconst memoizedParseExtraAttributes = mem(parseExtraAttributes, { maxAge: process.env.TEST_MODE === 'true' ? 1 : 60000 });\n\nWebApp.connectHandlers.use('/livechat', (req, res, next) => {\n\tif (!req.url) {\n\t\treturn next();\n\t}\n\n\tconst reqUrl = url.parse(req.url);\n\tif (reqUrl.pathname !== '/') {\n\t\treturn next();\n\t}\n\n\tres.setHeader('content-type', 'text/html; charset=utf-8');\n\tconst domainWhiteListSetting = settings.get<string>('Livechat_AllowedDomainsList');\n\tlet domainWhiteList = [];\n\tif (req.headers.referer && domainWhiteListSetting.trim()) {\n\t\tdomainWhiteList = domainWhiteListSetting.split(',').map((domain) => domain.trim());\n\t\tconst referer = url.parse(req.headers.referer);\n\t\tif (referer.host && !domainWhiteList.includes(referer.host)) {\n\t\t\tres.setHeader('Content-Security-Policy', \"frame-ancestors 'none'\");\n\t\t\treturn next();\n\t\t}\n\t\tres.setHeader('Content-Security-Policy', `frame-ancestors ${referer.protocol}//${referer.host}`);\n\t} else {\n\t\t// TODO need to remove inline scripts from this route to be able to enable CSP here as well\n\t\tres.removeHeader('Content-Security-Policy');\n\t}\n\n\tres.write(memoizedParseExtraAttributes(indexHtmlWithServerURL));\n\tres.end();\n});\n"],"mappings":"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","ignoreList":[]},"sourceType":"module","externalDependencies":{},"hash":"a111067341cdcce0612a4a9775d87cbc4a1cfb74"}
