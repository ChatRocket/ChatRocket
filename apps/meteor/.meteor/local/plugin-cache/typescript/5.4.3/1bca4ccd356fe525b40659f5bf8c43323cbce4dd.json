{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/app/api/server/v1/roles.ts","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","topLevelAwait","objectRestSpread","objectRestSpread","asyncGenerators","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"os.osx.arm64"},"sourceFileName":"app/api/server/v1/roles.ts","filename":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/app/api/server/v1/roles.ts","inputSourceMap":{"version":3,"file":"app/api/server/v1/roles.ts","sourceRoot":"","sources":["app/api/server/v1/roles.ts"],"names":[],"mappings":"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","sourcesContent":["import { api } from '@rocket.chat/core-services';\nimport type { IRole } from '@rocket.chat/core-typings';\nimport { Roles, Users } from '@rocket.chat/models';\nimport { isRoleAddUserToRoleProps, isRoleDeleteProps, isRoleRemoveUserFromRoleProps } from '@rocket.chat/rest-typings';\nimport { check, Match } from 'meteor/check';\nimport { Meteor } from 'meteor/meteor';\n\nimport { getUsersInRolePaginated } from '../../../authorization/server/functions/getUsersInRole';\nimport { hasPermissionAsync } from '../../../authorization/server/functions/hasPermission';\nimport { hasRoleAsync, hasAnyRoleAsync } from '../../../authorization/server/functions/hasRole';\nimport { apiDeprecationLogger } from '../../../lib/server/lib/deprecationWarningLogger';\nimport { notifyOnRoleChanged } from '../../../lib/server/lib/notifyListener';\nimport { settings } from '../../../settings/server/index';\nimport { API } from '../api';\nimport { getPaginationItems } from '../helpers/getPaginationItems';\nimport { getUserFromParams } from '../helpers/getUserFromParams';\n\nAPI.v1.addRoute(\n\t'roles.list',\n\t{ authRequired: true },\n\t{\n\t\tasync get() {\n\t\t\tconst roles = await Roles.find({}, { projection: { _updatedAt: 0 } }).toArray();\n\n\t\t\treturn API.v1.success({ roles });\n\t\t},\n\t},\n);\n\nAPI.v1.addRoute(\n\t'roles.sync',\n\t{ authRequired: true },\n\t{\n\t\tasync get() {\n\t\t\tcheck(\n\t\t\t\tthis.queryParams,\n\t\t\t\tMatch.ObjectIncluding({\n\t\t\t\t\tupdatedSince: Match.Where((value: unknown): value is string => typeof value === 'string' && !Number.isNaN(Date.parse(value))),\n\t\t\t\t}),\n\t\t\t);\n\n\t\t\tconst { updatedSince } = this.queryParams;\n\n\t\t\treturn API.v1.success({\n\t\t\t\troles: {\n\t\t\t\t\tupdate: await Roles.findByUpdatedDate(new Date(updatedSince)).toArray(),\n\t\t\t\t\tremove: await Roles.trashFindDeletedAfter(new Date(updatedSince)).toArray(),\n\t\t\t\t},\n\t\t\t});\n\t\t},\n\t},\n);\n\nAPI.v1.addRoute(\n\t'roles.addUserToRole',\n\t{ authRequired: true },\n\t{\n\t\tasync post() {\n\t\t\tif (!isRoleAddUserToRoleProps(this.bodyParams)) {\n\t\t\t\tthrow new Meteor.Error('error-invalid-role-properties', isRoleAddUserToRoleProps.errors?.map((error) => error.message).join('\\n'));\n\t\t\t}\n\n\t\t\tconst user = await getUserFromParams(this.bodyParams);\n\t\t\tconst { roleId, roleName, roomId } = this.bodyParams;\n\n\t\t\tif (!roleId) {\n\t\t\t\tif (!roleName) {\n\t\t\t\t\treturn API.v1.failure('error-invalid-role-properties');\n\t\t\t\t}\n\n\t\t\t\tapiDeprecationLogger.parameter(this.request.route, 'roleName', '7.0.0', this.response);\n\t\t\t}\n\n\t\t\tconst role = roleId ? await Roles.findOneById(roleId) : await Roles.findOneByIdOrName(roleName as string);\n\t\t\tif (!role) {\n\t\t\t\treturn API.v1.failure('error-role-not-found', 'Role not found');\n\t\t\t}\n\n\t\t\tif (await hasRoleAsync(user._id, role._id, roomId)) {\n\t\t\t\tthrow new Meteor.Error('error-user-already-in-role', 'User already in role');\n\t\t\t}\n\n\t\t\tawait Meteor.callAsync('authorization:addUserToRole', role._id, user.username, roomId);\n\n\t\t\treturn API.v1.success({\n\t\t\t\trole,\n\t\t\t});\n\t\t},\n\t},\n);\n\nAPI.v1.addRoute(\n\t'roles.getUsersInRole',\n\t{ authRequired: true, permissionsRequired: ['access-permissions'] },\n\t{\n\t\tasync get() {\n\t\t\tconst { roomId, role } = this.queryParams;\n\t\t\tconst { offset, count = 50 } = await getPaginationItems(this.queryParams);\n\n\t\t\tconst projection = {\n\t\t\t\tname: 1,\n\t\t\t\tusername: 1,\n\t\t\t\temails: 1,\n\t\t\t\tavatarETag: 1,\n\t\t\t\tcreatedAt: 1,\n\t\t\t\t_updatedAt: 1,\n\t\t\t};\n\n\t\t\tif (!role) {\n\t\t\t\tthrow new Meteor.Error('error-param-not-provided', 'Query param \"role\" is required');\n\t\t\t}\n\t\t\tif (roomId && !(await hasPermissionAsync(this.userId, 'view-other-user-channels'))) {\n\t\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed');\n\t\t\t}\n\n\t\t\tconst options = { projection: { _id: 1 } };\n\t\t\tlet roleData = await Roles.findOneById<Pick<IRole, '_id'>>(role, options);\n\t\t\tif (!roleData) {\n\t\t\t\troleData = await Roles.findOneByName<Pick<IRole, '_id'>>(role, options);\n\t\t\t\tif (!roleData) {\n\t\t\t\t\tthrow new Meteor.Error('error-invalid-roleId');\n\t\t\t\t}\n\n\t\t\t\tapiDeprecationLogger.deprecatedParameterUsage(\n\t\t\t\t\tthis.request.route,\n\t\t\t\t\t'role',\n\t\t\t\t\t'7.0.0',\n\t\t\t\t\tthis.response,\n\t\t\t\t\t({ parameter, endpoint, version }) =>\n\t\t\t\t\t\t`Querying \\`${parameter}\\` by name is deprecated in ${endpoint} and will be removed on the removed on version ${version}`,\n\t\t\t\t);\n\t\t\t}\n\n\t\t\tconst { cursor, totalCount } = await getUsersInRolePaginated(roleData._id, roomId, {\n\t\t\t\tlimit: count as number,\n\t\t\t\tsort: { username: 1 },\n\t\t\t\tskip: offset as number,\n\t\t\t\tprojection,\n\t\t\t});\n\n\t\t\tconst [users, total] = await Promise.all([cursor.toArray(), totalCount]);\n\n\t\t\treturn API.v1.success({ users, total });\n\t\t},\n\t},\n);\n\nAPI.v1.addRoute(\n\t'roles.delete',\n\t{ authRequired: true, permissionsRequired: ['access-permissions'] },\n\t{\n\t\tasync post() {\n\t\t\tconst { bodyParams } = this;\n\t\t\tif (!isRoleDeleteProps(bodyParams)) {\n\t\t\t\tthrow new Meteor.Error('error-invalid-role-properties', 'The role properties are invalid.');\n\t\t\t}\n\n\t\t\tconst role = await Roles.findOneByIdOrName(bodyParams.roleId);\n\n\t\t\tif (!role) {\n\t\t\t\tthrow new Meteor.Error('error-invalid-roleId', 'This role does not exist');\n\t\t\t}\n\n\t\t\tif (role.protected) {\n\t\t\t\tthrow new Meteor.Error('error-role-protected', 'Cannot delete a protected role');\n\t\t\t}\n\n\t\t\tconst existingUsers = await Roles.findUsersInRole(role._id);\n\n\t\t\tif (existingUsers && (await existingUsers.count()) > 0) {\n\t\t\t\tthrow new Meteor.Error('error-role-in-use', \"Cannot delete role because it's in use\");\n\t\t\t}\n\n\t\t\tawait Roles.removeById(role._id);\n\n\t\t\tvoid notifyOnRoleChanged(role, 'removed');\n\n\t\t\treturn API.v1.success();\n\t\t},\n\t},\n);\n\nAPI.v1.addRoute(\n\t'roles.removeUserFromRole',\n\t{ authRequired: true, permissionsRequired: ['access-permissions'] },\n\t{\n\t\tasync post() {\n\t\t\tconst { bodyParams } = this;\n\t\t\tif (!isRoleRemoveUserFromRoleProps(bodyParams)) {\n\t\t\t\tthrow new Meteor.Error('error-invalid-role-properties', 'The role properties are invalid.');\n\t\t\t}\n\n\t\t\tconst { roleId, roleName, username, scope } = bodyParams;\n\n\t\t\tif (!roleId) {\n\t\t\t\tif (!roleName) {\n\t\t\t\t\treturn API.v1.failure('error-invalid-role-properties');\n\t\t\t\t}\n\n\t\t\t\tapiDeprecationLogger.parameter(this.request.route, 'roleName', '7.0.0', this.response);\n\t\t\t}\n\n\t\t\tconst user = await Users.findOneByUsername(username);\n\n\t\t\tif (!user) {\n\t\t\t\tthrow new Meteor.Error('error-invalid-user', 'There is no user with this username');\n\t\t\t}\n\n\t\t\tconst role = roleId ? await Roles.findOneById(roleId) : await Roles.findOneByIdOrName(roleName as string);\n\n\t\t\tif (!role) {\n\t\t\t\tthrow new Meteor.Error('error-invalid-roleId', 'This role does not exist');\n\t\t\t}\n\n\t\t\tif (!(await hasAnyRoleAsync(user._id, [role._id], scope))) {\n\t\t\t\tthrow new Meteor.Error('error-user-not-in-role', 'User is not in this role');\n\t\t\t}\n\n\t\t\tif (role._id === 'admin') {\n\t\t\t\tconst adminCount = await (await Roles.findUsersInRole('admin')).count();\n\t\t\t\tif (adminCount === 1) {\n\t\t\t\t\tthrow new Meteor.Error('error-admin-required', 'You need to have at least one admin');\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tawait Roles.removeUserRoles(user._id, [role._id], scope);\n\n\t\t\tif (settings.get('UI_DisplayRoles')) {\n\t\t\t\tvoid api.broadcast('user.roleUpdate', {\n\t\t\t\t\ttype: 'removed',\n\t\t\t\t\t_id: role._id,\n\t\t\t\t\tu: {\n\t\t\t\t\t\t_id: user._id,\n\t\t\t\t\t\tusername: user.username,\n\t\t\t\t\t},\n\t\t\t\t\tscope,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\treturn API.v1.success({\n\t\t\t\trole,\n\t\t\t});\n\t\t},\n\t},\n);\n"]},"targets":{"android":"125.0.0","chrome":"125.0.0","edge":"125.0.0","firefox":"115.0.0","ie":"10.0.0","ios":"17.4.0","opera":"110.0.0","opera_mobile":"80.0.0","safari":"17.4.0","samsung":"24.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor","root":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":false,"enforceStrictMode":false,"dynamicImport":true,"generateLetDeclarations":true,"topLevelAwait":true},"externalDependencies":[]},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"version":"7.17.2","helpers":true,"useESModules":false,"corejs":false},"externalDependencies":[]},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-async-generator-functions","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-class-properties","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true},"externalDependencies":[]},{"key":"transform-react-jsx","visitor":{"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXFragment":{"exit":[null]},"JSXElement":{"exit":[null]},"JSXAttribute":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false},"externalDependencies":[]},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-nullish-coalescing-operator","visitor":{"LogicalExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-optional-chaining","visitor":{"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-optional-catch-binding","visitor":{"CatchClause":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-class-properties","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-async-generator-functions","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-logical-assignment-operators","visitor":{"AssignmentExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]}],"presets":[],"generatorOpts":{"filename":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/app/api/server/v1/roles.ts","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"app/api/server/v1/roles.ts","inputSourceMap":{"version":3,"file":"app/api/server/v1/roles.ts","sourceRoot":"","sources":["app/api/server/v1/roles.ts"],"names":[],"mappings":"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","sourcesContent":["import { api } from '@rocket.chat/core-services';\nimport type { IRole } from '@rocket.chat/core-typings';\nimport { Roles, Users } from '@rocket.chat/models';\nimport { isRoleAddUserToRoleProps, isRoleDeleteProps, isRoleRemoveUserFromRoleProps } from '@rocket.chat/rest-typings';\nimport { check, Match } from 'meteor/check';\nimport { Meteor } from 'meteor/meteor';\n\nimport { getUsersInRolePaginated } from '../../../authorization/server/functions/getUsersInRole';\nimport { hasPermissionAsync } from '../../../authorization/server/functions/hasPermission';\nimport { hasRoleAsync, hasAnyRoleAsync } from '../../../authorization/server/functions/hasRole';\nimport { apiDeprecationLogger } from '../../../lib/server/lib/deprecationWarningLogger';\nimport { notifyOnRoleChanged } from '../../../lib/server/lib/notifyListener';\nimport { settings } from '../../../settings/server/index';\nimport { API } from '../api';\nimport { getPaginationItems } from '../helpers/getPaginationItems';\nimport { getUserFromParams } from '../helpers/getUserFromParams';\n\nAPI.v1.addRoute(\n\t'roles.list',\n\t{ authRequired: true },\n\t{\n\t\tasync get() {\n\t\t\tconst roles = await Roles.find({}, { projection: { _updatedAt: 0 } }).toArray();\n\n\t\t\treturn API.v1.success({ roles });\n\t\t},\n\t},\n);\n\nAPI.v1.addRoute(\n\t'roles.sync',\n\t{ authRequired: true },\n\t{\n\t\tasync get() {\n\t\t\tcheck(\n\t\t\t\tthis.queryParams,\n\t\t\t\tMatch.ObjectIncluding({\n\t\t\t\t\tupdatedSince: Match.Where((value: unknown): value is string => typeof value === 'string' && !Number.isNaN(Date.parse(value))),\n\t\t\t\t}),\n\t\t\t);\n\n\t\t\tconst { updatedSince } = this.queryParams;\n\n\t\t\treturn API.v1.success({\n\t\t\t\troles: {\n\t\t\t\t\tupdate: await Roles.findByUpdatedDate(new Date(updatedSince)).toArray(),\n\t\t\t\t\tremove: await Roles.trashFindDeletedAfter(new Date(updatedSince)).toArray(),\n\t\t\t\t},\n\t\t\t});\n\t\t},\n\t},\n);\n\nAPI.v1.addRoute(\n\t'roles.addUserToRole',\n\t{ authRequired: true },\n\t{\n\t\tasync post() {\n\t\t\tif (!isRoleAddUserToRoleProps(this.bodyParams)) {\n\t\t\t\tthrow new Meteor.Error('error-invalid-role-properties', isRoleAddUserToRoleProps.errors?.map((error) => error.message).join('\\n'));\n\t\t\t}\n\n\t\t\tconst user = await getUserFromParams(this.bodyParams);\n\t\t\tconst { roleId, roleName, roomId } = this.bodyParams;\n\n\t\t\tif (!roleId) {\n\t\t\t\tif (!roleName) {\n\t\t\t\t\treturn API.v1.failure('error-invalid-role-properties');\n\t\t\t\t}\n\n\t\t\t\tapiDeprecationLogger.parameter(this.request.route, 'roleName', '7.0.0', this.response);\n\t\t\t}\n\n\t\t\tconst role = roleId ? await Roles.findOneById(roleId) : await Roles.findOneByIdOrName(roleName as string);\n\t\t\tif (!role) {\n\t\t\t\treturn API.v1.failure('error-role-not-found', 'Role not found');\n\t\t\t}\n\n\t\t\tif (await hasRoleAsync(user._id, role._id, roomId)) {\n\t\t\t\tthrow new Meteor.Error('error-user-already-in-role', 'User already in role');\n\t\t\t}\n\n\t\t\tawait Meteor.callAsync('authorization:addUserToRole', role._id, user.username, roomId);\n\n\t\t\treturn API.v1.success({\n\t\t\t\trole,\n\t\t\t});\n\t\t},\n\t},\n);\n\nAPI.v1.addRoute(\n\t'roles.getUsersInRole',\n\t{ authRequired: true, permissionsRequired: ['access-permissions'] },\n\t{\n\t\tasync get() {\n\t\t\tconst { roomId, role } = this.queryParams;\n\t\t\tconst { offset, count = 50 } = await getPaginationItems(this.queryParams);\n\n\t\t\tconst projection = {\n\t\t\t\tname: 1,\n\t\t\t\tusername: 1,\n\t\t\t\temails: 1,\n\t\t\t\tavatarETag: 1,\n\t\t\t\tcreatedAt: 1,\n\t\t\t\t_updatedAt: 1,\n\t\t\t};\n\n\t\t\tif (!role) {\n\t\t\t\tthrow new Meteor.Error('error-param-not-provided', 'Query param \"role\" is required');\n\t\t\t}\n\t\t\tif (roomId && !(await hasPermissionAsync(this.userId, 'view-other-user-channels'))) {\n\t\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed');\n\t\t\t}\n\n\t\t\tconst options = { projection: { _id: 1 } };\n\t\t\tlet roleData = await Roles.findOneById<Pick<IRole, '_id'>>(role, options);\n\t\t\tif (!roleData) {\n\t\t\t\troleData = await Roles.findOneByName<Pick<IRole, '_id'>>(role, options);\n\t\t\t\tif (!roleData) {\n\t\t\t\t\tthrow new Meteor.Error('error-invalid-roleId');\n\t\t\t\t}\n\n\t\t\t\tapiDeprecationLogger.deprecatedParameterUsage(\n\t\t\t\t\tthis.request.route,\n\t\t\t\t\t'role',\n\t\t\t\t\t'7.0.0',\n\t\t\t\t\tthis.response,\n\t\t\t\t\t({ parameter, endpoint, version }) =>\n\t\t\t\t\t\t`Querying \\`${parameter}\\` by name is deprecated in ${endpoint} and will be removed on the removed on version ${version}`,\n\t\t\t\t);\n\t\t\t}\n\n\t\t\tconst { cursor, totalCount } = await getUsersInRolePaginated(roleData._id, roomId, {\n\t\t\t\tlimit: count as number,\n\t\t\t\tsort: { username: 1 },\n\t\t\t\tskip: offset as number,\n\t\t\t\tprojection,\n\t\t\t});\n\n\t\t\tconst [users, total] = await Promise.all([cursor.toArray(), totalCount]);\n\n\t\t\treturn API.v1.success({ users, total });\n\t\t},\n\t},\n);\n\nAPI.v1.addRoute(\n\t'roles.delete',\n\t{ authRequired: true, permissionsRequired: ['access-permissions'] },\n\t{\n\t\tasync post() {\n\t\t\tconst { bodyParams } = this;\n\t\t\tif (!isRoleDeleteProps(bodyParams)) {\n\t\t\t\tthrow new Meteor.Error('error-invalid-role-properties', 'The role properties are invalid.');\n\t\t\t}\n\n\t\t\tconst role = await Roles.findOneByIdOrName(bodyParams.roleId);\n\n\t\t\tif (!role) {\n\t\t\t\tthrow new Meteor.Error('error-invalid-roleId', 'This role does not exist');\n\t\t\t}\n\n\t\t\tif (role.protected) {\n\t\t\t\tthrow new Meteor.Error('error-role-protected', 'Cannot delete a protected role');\n\t\t\t}\n\n\t\t\tconst existingUsers = await Roles.findUsersInRole(role._id);\n\n\t\t\tif (existingUsers && (await existingUsers.count()) > 0) {\n\t\t\t\tthrow new Meteor.Error('error-role-in-use', \"Cannot delete role because it's in use\");\n\t\t\t}\n\n\t\t\tawait Roles.removeById(role._id);\n\n\t\t\tvoid notifyOnRoleChanged(role, 'removed');\n\n\t\t\treturn API.v1.success();\n\t\t},\n\t},\n);\n\nAPI.v1.addRoute(\n\t'roles.removeUserFromRole',\n\t{ authRequired: true, permissionsRequired: ['access-permissions'] },\n\t{\n\t\tasync post() {\n\t\t\tconst { bodyParams } = this;\n\t\t\tif (!isRoleRemoveUserFromRoleProps(bodyParams)) {\n\t\t\t\tthrow new Meteor.Error('error-invalid-role-properties', 'The role properties are invalid.');\n\t\t\t}\n\n\t\t\tconst { roleId, roleName, username, scope } = bodyParams;\n\n\t\t\tif (!roleId) {\n\t\t\t\tif (!roleName) {\n\t\t\t\t\treturn API.v1.failure('error-invalid-role-properties');\n\t\t\t\t}\n\n\t\t\t\tapiDeprecationLogger.parameter(this.request.route, 'roleName', '7.0.0', this.response);\n\t\t\t}\n\n\t\t\tconst user = await Users.findOneByUsername(username);\n\n\t\t\tif (!user) {\n\t\t\t\tthrow new Meteor.Error('error-invalid-user', 'There is no user with this username');\n\t\t\t}\n\n\t\t\tconst role = roleId ? await Roles.findOneById(roleId) : await Roles.findOneByIdOrName(roleName as string);\n\n\t\t\tif (!role) {\n\t\t\t\tthrow new Meteor.Error('error-invalid-roleId', 'This role does not exist');\n\t\t\t}\n\n\t\t\tif (!(await hasAnyRoleAsync(user._id, [role._id], scope))) {\n\t\t\t\tthrow new Meteor.Error('error-user-not-in-role', 'User is not in this role');\n\t\t\t}\n\n\t\t\tif (role._id === 'admin') {\n\t\t\t\tconst adminCount = await (await Roles.findUsersInRole('admin')).count();\n\t\t\t\tif (adminCount === 1) {\n\t\t\t\t\tthrow new Meteor.Error('error-admin-required', 'You need to have at least one admin');\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tawait Roles.removeUserRoles(user._id, [role._id], scope);\n\n\t\t\tif (settings.get('UI_DisplayRoles')) {\n\t\t\t\tvoid api.broadcast('user.roleUpdate', {\n\t\t\t\t\ttype: 'removed',\n\t\t\t\t\t_id: role._id,\n\t\t\t\t\tu: {\n\t\t\t\t\t\t_id: user._id,\n\t\t\t\t\t\tusername: user.username,\n\t\t\t\t\t},\n\t\t\t\t\tscope,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\treturn API.v1.success({\n\t\t\t\trole,\n\t\t\t});\n\t\t},\n\t},\n);\n"]}}},"code":"!module.wrapAsync(async function (module, __reifyWaitForDeps__, __reify_async_result__) {\n  \"use strict\";\n  try {\n    let api;\n    module.link(\"@rocket.chat/core-services\", {\n      api(v) {\n        api = v;\n      }\n    }, 0);\n    let Roles, Users;\n    module.link(\"@rocket.chat/models\", {\n      Roles(v) {\n        Roles = v;\n      },\n      Users(v) {\n        Users = v;\n      }\n    }, 1);\n    let isRoleAddUserToRoleProps, isRoleDeleteProps, isRoleRemoveUserFromRoleProps;\n    module.link(\"@rocket.chat/rest-typings\", {\n      isRoleAddUserToRoleProps(v) {\n        isRoleAddUserToRoleProps = v;\n      },\n      isRoleDeleteProps(v) {\n        isRoleDeleteProps = v;\n      },\n      isRoleRemoveUserFromRoleProps(v) {\n        isRoleRemoveUserFromRoleProps = v;\n      }\n    }, 2);\n    let check, Match;\n    module.link(\"meteor/check\", {\n      check(v) {\n        check = v;\n      },\n      Match(v) {\n        Match = v;\n      }\n    }, 3);\n    let Meteor;\n    module.link(\"meteor/meteor\", {\n      Meteor(v) {\n        Meteor = v;\n      }\n    }, 4);\n    let getUsersInRolePaginated;\n    module.link(\"../../../authorization/server/functions/getUsersInRole\", {\n      getUsersInRolePaginated(v) {\n        getUsersInRolePaginated = v;\n      }\n    }, 5);\n    let hasPermissionAsync;\n    module.link(\"../../../authorization/server/functions/hasPermission\", {\n      hasPermissionAsync(v) {\n        hasPermissionAsync = v;\n      }\n    }, 6);\n    let hasRoleAsync, hasAnyRoleAsync;\n    module.link(\"../../../authorization/server/functions/hasRole\", {\n      hasRoleAsync(v) {\n        hasRoleAsync = v;\n      },\n      hasAnyRoleAsync(v) {\n        hasAnyRoleAsync = v;\n      }\n    }, 7);\n    let apiDeprecationLogger;\n    module.link(\"../../../lib/server/lib/deprecationWarningLogger\", {\n      apiDeprecationLogger(v) {\n        apiDeprecationLogger = v;\n      }\n    }, 8);\n    let notifyOnRoleChanged;\n    module.link(\"../../../lib/server/lib/notifyListener\", {\n      notifyOnRoleChanged(v) {\n        notifyOnRoleChanged = v;\n      }\n    }, 9);\n    let settings;\n    module.link(\"../../../settings/server/index\", {\n      settings(v) {\n        settings = v;\n      }\n    }, 10);\n    let API;\n    module.link(\"../api\", {\n      API(v) {\n        API = v;\n      }\n    }, 11);\n    let getPaginationItems;\n    module.link(\"../helpers/getPaginationItems\", {\n      getPaginationItems(v) {\n        getPaginationItems = v;\n      }\n    }, 12);\n    let getUserFromParams;\n    module.link(\"../helpers/getUserFromParams\", {\n      getUserFromParams(v) {\n        getUserFromParams = v;\n      }\n    }, 13);\n    if (__reifyWaitForDeps__()) (await __reifyWaitForDeps__())();\n    API.v1.addRoute('roles.list', {\n      authRequired: true\n    }, {\n      async get() {\n        const roles = await Roles.find({}, {\n          projection: {\n            _updatedAt: 0\n          }\n        }).toArray();\n        return API.v1.success({\n          roles\n        });\n      }\n    });\n    API.v1.addRoute('roles.sync', {\n      authRequired: true\n    }, {\n      async get() {\n        check(this.queryParams, Match.ObjectIncluding({\n          updatedSince: Match.Where(value => typeof value === 'string' && !Number.isNaN(Date.parse(value)))\n        }));\n        const {\n          updatedSince\n        } = this.queryParams;\n        return API.v1.success({\n          roles: {\n            update: await Roles.findByUpdatedDate(new Date(updatedSince)).toArray(),\n            remove: await Roles.trashFindDeletedAfter(new Date(updatedSince)).toArray()\n          }\n        });\n      }\n    });\n    API.v1.addRoute('roles.addUserToRole', {\n      authRequired: true\n    }, {\n      async post() {\n        if (!isRoleAddUserToRoleProps(this.bodyParams)) {\n          var _isRoleAddUserToRoleP;\n          throw new Meteor.Error('error-invalid-role-properties', (_isRoleAddUserToRoleP = isRoleAddUserToRoleProps.errors) === null || _isRoleAddUserToRoleP === void 0 ? void 0 : _isRoleAddUserToRoleP.map(error => error.message).join('\\n'));\n        }\n        const user = await getUserFromParams(this.bodyParams);\n        const {\n          roleId,\n          roleName,\n          roomId\n        } = this.bodyParams;\n        if (!roleId) {\n          if (!roleName) {\n            return API.v1.failure('error-invalid-role-properties');\n          }\n          apiDeprecationLogger.parameter(this.request.route, 'roleName', '7.0.0', this.response);\n        }\n        const role = roleId ? await Roles.findOneById(roleId) : await Roles.findOneByIdOrName(roleName);\n        if (!role) {\n          return API.v1.failure('error-role-not-found', 'Role not found');\n        }\n        if (await hasRoleAsync(user._id, role._id, roomId)) {\n          throw new Meteor.Error('error-user-already-in-role', 'User already in role');\n        }\n        await Meteor.callAsync('authorization:addUserToRole', role._id, user.username, roomId);\n        return API.v1.success({\n          role\n        });\n      }\n    });\n    API.v1.addRoute('roles.getUsersInRole', {\n      authRequired: true,\n      permissionsRequired: ['access-permissions']\n    }, {\n      async get() {\n        const {\n          roomId,\n          role\n        } = this.queryParams;\n        const {\n          offset,\n          count = 50\n        } = await getPaginationItems(this.queryParams);\n        const projection = {\n          name: 1,\n          username: 1,\n          emails: 1,\n          avatarETag: 1,\n          createdAt: 1,\n          _updatedAt: 1\n        };\n        if (!role) {\n          throw new Meteor.Error('error-param-not-provided', 'Query param \"role\" is required');\n        }\n        if (roomId && !(await hasPermissionAsync(this.userId, 'view-other-user-channels'))) {\n          throw new Meteor.Error('error-not-allowed', 'Not allowed');\n        }\n        const options = {\n          projection: {\n            _id: 1\n          }\n        };\n        let roleData = await Roles.findOneById(role, options);\n        if (!roleData) {\n          roleData = await Roles.findOneByName(role, options);\n          if (!roleData) {\n            throw new Meteor.Error('error-invalid-roleId');\n          }\n          apiDeprecationLogger.deprecatedParameterUsage(this.request.route, 'role', '7.0.0', this.response, _ref => {\n            let {\n              parameter,\n              endpoint,\n              version\n            } = _ref;\n            return \"Querying `\".concat(parameter, \"` by name is deprecated in \").concat(endpoint, \" and will be removed on the removed on version \").concat(version);\n          });\n        }\n        const {\n          cursor,\n          totalCount\n        } = await getUsersInRolePaginated(roleData._id, roomId, {\n          limit: count,\n          sort: {\n            username: 1\n          },\n          skip: offset,\n          projection\n        });\n        const [users, total] = await Promise.all([cursor.toArray(), totalCount]);\n        return API.v1.success({\n          users,\n          total\n        });\n      }\n    });\n    API.v1.addRoute('roles.delete', {\n      authRequired: true,\n      permissionsRequired: ['access-permissions']\n    }, {\n      async post() {\n        const {\n          bodyParams\n        } = this;\n        if (!isRoleDeleteProps(bodyParams)) {\n          throw new Meteor.Error('error-invalid-role-properties', 'The role properties are invalid.');\n        }\n        const role = await Roles.findOneByIdOrName(bodyParams.roleId);\n        if (!role) {\n          throw new Meteor.Error('error-invalid-roleId', 'This role does not exist');\n        }\n        if (role.protected) {\n          throw new Meteor.Error('error-role-protected', 'Cannot delete a protected role');\n        }\n        const existingUsers = await Roles.findUsersInRole(role._id);\n        if (existingUsers && (await existingUsers.count()) > 0) {\n          throw new Meteor.Error('error-role-in-use', \"Cannot delete role because it's in use\");\n        }\n        await Roles.removeById(role._id);\n        void notifyOnRoleChanged(role, 'removed');\n        return API.v1.success();\n      }\n    });\n    API.v1.addRoute('roles.removeUserFromRole', {\n      authRequired: true,\n      permissionsRequired: ['access-permissions']\n    }, {\n      async post() {\n        const {\n          bodyParams\n        } = this;\n        if (!isRoleRemoveUserFromRoleProps(bodyParams)) {\n          throw new Meteor.Error('error-invalid-role-properties', 'The role properties are invalid.');\n        }\n        const {\n          roleId,\n          roleName,\n          username,\n          scope\n        } = bodyParams;\n        if (!roleId) {\n          if (!roleName) {\n            return API.v1.failure('error-invalid-role-properties');\n          }\n          apiDeprecationLogger.parameter(this.request.route, 'roleName', '7.0.0', this.response);\n        }\n        const user = await Users.findOneByUsername(username);\n        if (!user) {\n          throw new Meteor.Error('error-invalid-user', 'There is no user with this username');\n        }\n        const role = roleId ? await Roles.findOneById(roleId) : await Roles.findOneByIdOrName(roleName);\n        if (!role) {\n          throw new Meteor.Error('error-invalid-roleId', 'This role does not exist');\n        }\n        if (!(await hasAnyRoleAsync(user._id, [role._id], scope))) {\n          throw new Meteor.Error('error-user-not-in-role', 'User is not in this role');\n        }\n        if (role._id === 'admin') {\n          const adminCount = await (await Roles.findUsersInRole('admin')).count();\n          if (adminCount === 1) {\n            throw new Meteor.Error('error-admin-required', 'You need to have at least one admin');\n          }\n        }\n        await Roles.removeUserRoles(user._id, [role._id], scope);\n        if (settings.get('UI_DisplayRoles')) {\n          void api.broadcast('user.roleUpdate', {\n            type: 'removed',\n            _id: role._id,\n            u: {\n              _id: user._id,\n              username: user.username\n            },\n            scope\n          });\n        }\n        return API.v1.success({\n          role\n        });\n      }\n    });\n    __reify_async_result__();\n  } catch (_reifyError) {\n    return __reify_async_result__(_reifyError);\n  }\n  __reify_async_result__()\n}, {\n  self: this,\n  async: false\n});","map":{"version":3,"names":["api","module","link","v","Roles","Users","isRoleAddUserToRoleProps","isRoleDeleteProps","isRoleRemoveUserFromRoleProps","check","Match","Meteor","getUsersInRolePaginated","hasPermissionAsync","hasRoleAsync","hasAnyRoleAsync","apiDeprecationLogger","notifyOnRoleChanged","settings","API","getPaginationItems","getUserFromParams","__reifyWaitForDeps__","v1","addRoute","authRequired","get","roles","find","projection","_updatedAt","toArray","success","queryParams","ObjectIncluding","updatedSince","Where","value","Number","isNaN","Date","parse","update","findByUpdatedDate","remove","trashFindDeletedAfter","post","bodyParams","_isRoleAddUserToRoleP","Error","errors","map","error","message","join","user","roleId","roleName","roomId","failure","parameter","request","route","response","role","findOneById","findOneByIdOrName","_id","callAsync","username","permissionsRequired","offset","count","name","emails","avatarETag","createdAt","userId","options","roleData","findOneByName","deprecatedParameterUsage","_ref","endpoint","version","concat","cursor","totalCount","limit","sort","skip","users","total","Promise","all","protected","existingUsers","findUsersInRole","removeById","scope","findOneByUsername","adminCount","removeUserRoles","broadcast","type","u","__reify_async_result__","_reifyError","self","async"],"sources":["app/api/server/v1/roles.ts"],"sourcesContent":["import { api } from '@rocket.chat/core-services';\nimport type { IRole } from '@rocket.chat/core-typings';\nimport { Roles, Users } from '@rocket.chat/models';\nimport { isRoleAddUserToRoleProps, isRoleDeleteProps, isRoleRemoveUserFromRoleProps } from '@rocket.chat/rest-typings';\nimport { check, Match } from 'meteor/check';\nimport { Meteor } from 'meteor/meteor';\n\nimport { getUsersInRolePaginated } from '../../../authorization/server/functions/getUsersInRole';\nimport { hasPermissionAsync } from '../../../authorization/server/functions/hasPermission';\nimport { hasRoleAsync, hasAnyRoleAsync } from '../../../authorization/server/functions/hasRole';\nimport { apiDeprecationLogger } from '../../../lib/server/lib/deprecationWarningLogger';\nimport { notifyOnRoleChanged } from '../../../lib/server/lib/notifyListener';\nimport { settings } from '../../../settings/server/index';\nimport { API } from '../api';\nimport { getPaginationItems } from '../helpers/getPaginationItems';\nimport { getUserFromParams } from '../helpers/getUserFromParams';\n\nAPI.v1.addRoute(\n\t'roles.list',\n\t{ authRequired: true },\n\t{\n\t\tasync get() {\n\t\t\tconst roles = await Roles.find({}, { projection: { _updatedAt: 0 } }).toArray();\n\n\t\t\treturn API.v1.success({ roles });\n\t\t},\n\t},\n);\n\nAPI.v1.addRoute(\n\t'roles.sync',\n\t{ authRequired: true },\n\t{\n\t\tasync get() {\n\t\t\tcheck(\n\t\t\t\tthis.queryParams,\n\t\t\t\tMatch.ObjectIncluding({\n\t\t\t\t\tupdatedSince: Match.Where((value: unknown): value is string => typeof value === 'string' && !Number.isNaN(Date.parse(value))),\n\t\t\t\t}),\n\t\t\t);\n\n\t\t\tconst { updatedSince } = this.queryParams;\n\n\t\t\treturn API.v1.success({\n\t\t\t\troles: {\n\t\t\t\t\tupdate: await Roles.findByUpdatedDate(new Date(updatedSince)).toArray(),\n\t\t\t\t\tremove: await Roles.trashFindDeletedAfter(new Date(updatedSince)).toArray(),\n\t\t\t\t},\n\t\t\t});\n\t\t},\n\t},\n);\n\nAPI.v1.addRoute(\n\t'roles.addUserToRole',\n\t{ authRequired: true },\n\t{\n\t\tasync post() {\n\t\t\tif (!isRoleAddUserToRoleProps(this.bodyParams)) {\n\t\t\t\tthrow new Meteor.Error('error-invalid-role-properties', isRoleAddUserToRoleProps.errors?.map((error) => error.message).join('\\n'));\n\t\t\t}\n\n\t\t\tconst user = await getUserFromParams(this.bodyParams);\n\t\t\tconst { roleId, roleName, roomId } = this.bodyParams;\n\n\t\t\tif (!roleId) {\n\t\t\t\tif (!roleName) {\n\t\t\t\t\treturn API.v1.failure('error-invalid-role-properties');\n\t\t\t\t}\n\n\t\t\t\tapiDeprecationLogger.parameter(this.request.route, 'roleName', '7.0.0', this.response);\n\t\t\t}\n\n\t\t\tconst role = roleId ? await Roles.findOneById(roleId) : await Roles.findOneByIdOrName(roleName as string);\n\t\t\tif (!role) {\n\t\t\t\treturn API.v1.failure('error-role-not-found', 'Role not found');\n\t\t\t}\n\n\t\t\tif (await hasRoleAsync(user._id, role._id, roomId)) {\n\t\t\t\tthrow new Meteor.Error('error-user-already-in-role', 'User already in role');\n\t\t\t}\n\n\t\t\tawait Meteor.callAsync('authorization:addUserToRole', role._id, user.username, roomId);\n\n\t\t\treturn API.v1.success({\n\t\t\t\trole,\n\t\t\t});\n\t\t},\n\t},\n);\n\nAPI.v1.addRoute(\n\t'roles.getUsersInRole',\n\t{ authRequired: true, permissionsRequired: ['access-permissions'] },\n\t{\n\t\tasync get() {\n\t\t\tconst { roomId, role } = this.queryParams;\n\t\t\tconst { offset, count = 50 } = await getPaginationItems(this.queryParams);\n\n\t\t\tconst projection = {\n\t\t\t\tname: 1,\n\t\t\t\tusername: 1,\n\t\t\t\temails: 1,\n\t\t\t\tavatarETag: 1,\n\t\t\t\tcreatedAt: 1,\n\t\t\t\t_updatedAt: 1,\n\t\t\t};\n\n\t\t\tif (!role) {\n\t\t\t\tthrow new Meteor.Error('error-param-not-provided', 'Query param \"role\" is required');\n\t\t\t}\n\t\t\tif (roomId && !(await hasPermissionAsync(this.userId, 'view-other-user-channels'))) {\n\t\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed');\n\t\t\t}\n\n\t\t\tconst options = { projection: { _id: 1 } };\n\t\t\tlet roleData = await Roles.findOneById<Pick<IRole, '_id'>>(role, options);\n\t\t\tif (!roleData) {\n\t\t\t\troleData = await Roles.findOneByName<Pick<IRole, '_id'>>(role, options);\n\t\t\t\tif (!roleData) {\n\t\t\t\t\tthrow new Meteor.Error('error-invalid-roleId');\n\t\t\t\t}\n\n\t\t\t\tapiDeprecationLogger.deprecatedParameterUsage(\n\t\t\t\t\tthis.request.route,\n\t\t\t\t\t'role',\n\t\t\t\t\t'7.0.0',\n\t\t\t\t\tthis.response,\n\t\t\t\t\t({ parameter, endpoint, version }) =>\n\t\t\t\t\t\t`Querying \\`${parameter}\\` by name is deprecated in ${endpoint} and will be removed on the removed on version ${version}`,\n\t\t\t\t);\n\t\t\t}\n\n\t\t\tconst { cursor, totalCount } = await getUsersInRolePaginated(roleData._id, roomId, {\n\t\t\t\tlimit: count as number,\n\t\t\t\tsort: { username: 1 },\n\t\t\t\tskip: offset as number,\n\t\t\t\tprojection,\n\t\t\t});\n\n\t\t\tconst [users, total] = await Promise.all([cursor.toArray(), totalCount]);\n\n\t\t\treturn API.v1.success({ users, total });\n\t\t},\n\t},\n);\n\nAPI.v1.addRoute(\n\t'roles.delete',\n\t{ authRequired: true, permissionsRequired: ['access-permissions'] },\n\t{\n\t\tasync post() {\n\t\t\tconst { bodyParams } = this;\n\t\t\tif (!isRoleDeleteProps(bodyParams)) {\n\t\t\t\tthrow new Meteor.Error('error-invalid-role-properties', 'The role properties are invalid.');\n\t\t\t}\n\n\t\t\tconst role = await Roles.findOneByIdOrName(bodyParams.roleId);\n\n\t\t\tif (!role) {\n\t\t\t\tthrow new Meteor.Error('error-invalid-roleId', 'This role does not exist');\n\t\t\t}\n\n\t\t\tif (role.protected) {\n\t\t\t\tthrow new Meteor.Error('error-role-protected', 'Cannot delete a protected role');\n\t\t\t}\n\n\t\t\tconst existingUsers = await Roles.findUsersInRole(role._id);\n\n\t\t\tif (existingUsers && (await existingUsers.count()) > 0) {\n\t\t\t\tthrow new Meteor.Error('error-role-in-use', \"Cannot delete role because it's in use\");\n\t\t\t}\n\n\t\t\tawait Roles.removeById(role._id);\n\n\t\t\tvoid notifyOnRoleChanged(role, 'removed');\n\n\t\t\treturn API.v1.success();\n\t\t},\n\t},\n);\n\nAPI.v1.addRoute(\n\t'roles.removeUserFromRole',\n\t{ authRequired: true, permissionsRequired: ['access-permissions'] },\n\t{\n\t\tasync post() {\n\t\t\tconst { bodyParams } = this;\n\t\t\tif (!isRoleRemoveUserFromRoleProps(bodyParams)) {\n\t\t\t\tthrow new Meteor.Error('error-invalid-role-properties', 'The role properties are invalid.');\n\t\t\t}\n\n\t\t\tconst { roleId, roleName, username, scope } = bodyParams;\n\n\t\t\tif (!roleId) {\n\t\t\t\tif (!roleName) {\n\t\t\t\t\treturn API.v1.failure('error-invalid-role-properties');\n\t\t\t\t}\n\n\t\t\t\tapiDeprecationLogger.parameter(this.request.route, 'roleName', '7.0.0', this.response);\n\t\t\t}\n\n\t\t\tconst user = await Users.findOneByUsername(username);\n\n\t\t\tif (!user) {\n\t\t\t\tthrow new Meteor.Error('error-invalid-user', 'There is no user with this username');\n\t\t\t}\n\n\t\t\tconst role = roleId ? await Roles.findOneById(roleId) : await Roles.findOneByIdOrName(roleName as string);\n\n\t\t\tif (!role) {\n\t\t\t\tthrow new Meteor.Error('error-invalid-roleId', 'This role does not exist');\n\t\t\t}\n\n\t\t\tif (!(await hasAnyRoleAsync(user._id, [role._id], scope))) {\n\t\t\t\tthrow new Meteor.Error('error-user-not-in-role', 'User is not in this role');\n\t\t\t}\n\n\t\t\tif (role._id === 'admin') {\n\t\t\t\tconst adminCount = await (await Roles.findUsersInRole('admin')).count();\n\t\t\t\tif (adminCount === 1) {\n\t\t\t\t\tthrow new Meteor.Error('error-admin-required', 'You need to have at least one admin');\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tawait Roles.removeUserRoles(user._id, [role._id], scope);\n\n\t\t\tif (settings.get('UI_DisplayRoles')) {\n\t\t\t\tvoid api.broadcast('user.roleUpdate', {\n\t\t\t\t\ttype: 'removed',\n\t\t\t\t\t_id: role._id,\n\t\t\t\t\tu: {\n\t\t\t\t\t\t_id: user._id,\n\t\t\t\t\t\tusername: user.username,\n\t\t\t\t\t},\n\t\t\t\t\tscope,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\treturn API.v1.success({\n\t\t\t\trole,\n\t\t\t});\n\t\t},\n\t},\n);\n"],"mappings":";;;IAAA,IAAAA,GAAO;IAAAC,MAAO,CAAAC,IAAA,CAAM,4BAA4B,EAAC;MAAAF,IAAAG,CAAA;QAAAH,GAAA,GAAAG,CAAA;MAAA;IAAA;IAAA,IAAAC,KAAA,EAAAC,KAAA;IAAAJ,MAAA,CAAAC,IAAA;MAAAE,MAAAD,CAAA;QAAAC,KAAA,GAAAD,CAAA;MAAA;MAAAE,MAAAF,CAAA;QAAAE,KAAA,GAAAF,CAAA;MAAA;IAAA;IAAA,IAAAG,wBAAA,EAAAC,iBAAA,EAAAC,6BAAA;IAAAP,MAAA,CAAAC,IAAA;MAAAI,yBAAAH,CAAA;QAAAG,wBAAA,GAAAH,CAAA;MAAA;MAAAI,kBAAAJ,CAAA;QAAAI,iBAAA,GAAAJ,CAAA;MAAA;MAAAK,8BAAAL,CAAA;QAAAK,6BAAA,GAAAL,CAAA;MAAA;IAAA;IAAA,IAAAM,KAAA,EAAAC,KAAA;IAAAT,MAAA,CAAAC,IAAA;MAAAO,MAAAN,CAAA;QAAAM,KAAA,GAAAN,CAAA;MAAA;MAAAO,MAAAP,CAAA;QAAAO,KAAA,GAAAP,CAAA;MAAA;IAAA;IAAA,IAAAQ,MAAA;IAAAV,MAAA,CAAAC,IAAA;MAAAS,OAAAR,CAAA;QAAAQ,MAAA,GAAAR,CAAA;MAAA;IAAA;IAAA,IAAAS,uBAAA;IAAAX,MAAA,CAAAC,IAAA;MAAAU,wBAAAT,CAAA;QAAAS,uBAAA,GAAAT,CAAA;MAAA;IAAA;IAAA,IAAAU,kBAAA;IAAAZ,MAAA,CAAAC,IAAA;MAAAW,mBAAAV,CAAA;QAAAU,kBAAA,GAAAV,CAAA;MAAA;IAAA;IAAA,IAAAW,YAAA,EAAAC,eAAA;IAAAd,MAAA,CAAAC,IAAA;MAAAY,aAAAX,CAAA;QAAAW,YAAA,GAAAX,CAAA;MAAA;MAAAY,gBAAAZ,CAAA;QAAAY,eAAA,GAAAZ,CAAA;MAAA;IAAA;IAAA,IAAAa,oBAAA;IAAAf,MAAA,CAAAC,IAAA;MAAAc,qBAAAb,CAAA;QAAAa,oBAAA,GAAAb,CAAA;MAAA;IAAA;IAAA,IAAAc,mBAAA;IAAAhB,MAAA,CAAAC,IAAA;MAAAe,oBAAAd,CAAA;QAAAc,mBAAA,GAAAd,CAAA;MAAA;IAAA;IAAA,IAAAe,QAAA;IAAAjB,MAAA,CAAAC,IAAA;MAAAgB,SAAAf,CAAA;QAAAe,QAAA,GAAAf,CAAA;MAAA;IAAA;IAAA,IAAAgB,GAAA;IAAAlB,MAAA,CAAAC,IAAA;MAAAiB,IAAAhB,CAAA;QAAAgB,GAAA,GAAAhB,CAAA;MAAA;IAAA;IAAA,IAAAiB,kBAAA;IAAAnB,MAAA,CAAAC,IAAA;MAAAkB,mBAAAjB,CAAA;QAAAiB,kBAAA,GAAAjB,CAAA;MAAA;IAAA;IAAA,IAAAkB,iBAAA;IAAApB,MAAA,CAAAC,IAAA;MAAAmB,kBAAAlB,CAAA;QAAAkB,iBAAA,GAAAlB,CAAA;MAAA;IAAA;IAAA,IAAAmB,oBAAA,WAAAA,oBAAA;IAiBjDH,GAAG,CAACI,EAAE,CAACC,QAAQ,CACd,YAAY,EACZ;MAAEC,YAAY,EAAE;IAAI,CAAE,EACtB;MACC,MAAMC,GAAGA,CAAA;QACR,MAAMC,KAAK,GAAG,MAAMvB,KAAK,CAACwB,IAAI,CAAC,EAAE,EAAE;UAAEC,UAAU,EAAE;YAAEC,UAAU,EAAE;UAAC;QAAE,CAAE,CAAC,CAACC,OAAO,EAAE;QAE/E,OAAOZ,GAAG,CAACI,EAAE,CAACS,OAAO,CAAC;UAAEL;QAAK,CAAE,CAAC;MACjC;KACA,CACD;IAEDR,GAAG,CAACI,EAAE,CAACC,QAAQ,CACd,YAAY,EACZ;MAAEC,YAAY,EAAE;IAAI,CAAE,EACtB;MACC,MAAMC,GAAGA,CAAA;QACRjB,KAAK,CACJ,IAAI,CAACwB,WAAW,EAChBvB,KAAK,CAACwB,eAAe,CAAC;UACrBC,YAAY,EAAEzB,KAAK,CAAC0B,KAAK,CAAEC,KAAc,IAAsB,OAAOA,KAAK,KAAK,QAAQ,IAAI,CAACC,MAAM,CAACC,KAAK,CAACC,IAAI,CAACC,KAAK,CAACJ,KAAK,CAAC,CAAC;SAC5H,CAAC,CACF;QAED,MAAM;UAAEF;QAAY,CAAE,GAAG,IAAI,CAACF,WAAW;QAEzC,OAAOd,GAAG,CAACI,EAAE,CAACS,OAAO,CAAC;UACrBL,KAAK,EAAE;YACNe,MAAM,EAAE,MAAMtC,KAAK,CAACuC,iBAAiB,CAAC,IAAIH,IAAI,CAACL,YAAY,CAAC,CAAC,CAACJ,OAAO,EAAE;YACvEa,MAAM,EAAE,MAAMxC,KAAK,CAACyC,qBAAqB,CAAC,IAAIL,IAAI,CAACL,YAAY,CAAC,CAAC,CAACJ,OAAO;;SAE1E,CAAC;MACH;KACA,CACD;IAEDZ,GAAG,CAACI,EAAE,CAACC,QAAQ,CACd,qBAAqB,EACrB;MAAEC,YAAY,EAAE;IAAI,CAAE,EACtB;MACC,MAAMqB,IAAIA,CAAA;QACT,IAAI,CAACxC,wBAAwB,CAAC,IAAI,CAACyC,UAAU,CAAC,EAAE;UAAA,IAAAC,qBAAA;UAC/C,MAAM,IAAIrC,MAAM,CAACsC,KAAK,CAAC,+BAA+B,GAAAD,qBAAA,GAAE1C,wBAAwB,CAAC4C,MAAM,cAAAF,qBAAA,uBAA/BA,qBAAA,CAAiCG,GAAG,CAAEC,KAAK,IAAKA,KAAK,CAACC,OAAO,CAAC,CAACC,IAAI,CAAC,IAAI,CAAC,CAAC;QACnI;QAEA,MAAMC,IAAI,GAAG,MAAMlC,iBAAiB,CAAC,IAAI,CAAC0B,UAAU,CAAC;QACrD,MAAM;UAAES,MAAM;UAAEC,QAAQ;UAAEC;QAAM,CAAE,GAAG,IAAI,CAACX,UAAU;QAEpD,IAAI,CAACS,MAAM,EAAE;UACZ,IAAI,CAACC,QAAQ,EAAE;YACd,OAAOtC,GAAG,CAACI,EAAE,CAACoC,OAAO,CAAC,+BAA+B,CAAC;UACvD;UAEA3C,oBAAoB,CAAC4C,SAAS,CAAC,IAAI,CAACC,OAAO,CAACC,KAAK,EAAE,UAAU,EAAE,OAAO,EAAE,IAAI,CAACC,QAAQ,CAAC;QACvF;QAEA,MAAMC,IAAI,GAAGR,MAAM,GAAG,MAAMpD,KAAK,CAAC6D,WAAW,CAACT,MAAM,CAAC,GAAG,MAAMpD,KAAK,CAAC8D,iBAAiB,CAACT,QAAkB,CAAC;QACzG,IAAI,CAACO,IAAI,EAAE;UACV,OAAO7C,GAAG,CAACI,EAAE,CAACoC,OAAO,CAAC,sBAAsB,EAAE,gBAAgB,CAAC;QAChE;QAEA,IAAI,MAAM7C,YAAY,CAACyC,IAAI,CAACY,GAAG,EAAEH,IAAI,CAACG,GAAG,EAAET,MAAM,CAAC,EAAE;UACnD,MAAM,IAAI/C,MAAM,CAACsC,KAAK,CAAC,4BAA4B,EAAE,sBAAsB,CAAC;QAC7E;QAEA,MAAMtC,MAAM,CAACyD,SAAS,CAAC,6BAA6B,EAAEJ,IAAI,CAACG,GAAG,EAAEZ,IAAI,CAACc,QAAQ,EAAEX,MAAM,CAAC;QAEtF,OAAOvC,GAAG,CAACI,EAAE,CAACS,OAAO,CAAC;UACrBgC;SACA,CAAC;MACH;KACA,CACD;IAED7C,GAAG,CAACI,EAAE,CAACC,QAAQ,CACd,sBAAsB,EACtB;MAAEC,YAAY,EAAE,IAAI;MAAE6C,mBAAmB,EAAE,CAAC,oBAAoB;IAAC,CAAE,EACnE;MACC,MAAM5C,GAAGA,CAAA;QACR,MAAM;UAAEgC,MAAM;UAAEM;QAAI,CAAE,GAAG,IAAI,CAAC/B,WAAW;QACzC,MAAM;UAAEsC,MAAM;UAAEC,KAAK,GAAG;QAAE,CAAE,GAAG,MAAMpD,kBAAkB,CAAC,IAAI,CAACa,WAAW,CAAC;QAEzE,MAAMJ,UAAU,GAAG;UAClB4C,IAAI,EAAE,CAAC;UACPJ,QAAQ,EAAE,CAAC;UACXK,MAAM,EAAE,CAAC;UACTC,UAAU,EAAE,CAAC;UACbC,SAAS,EAAE,CAAC;UACZ9C,UAAU,EAAE;SACZ;QAED,IAAI,CAACkC,IAAI,EAAE;UACV,MAAM,IAAIrD,MAAM,CAACsC,KAAK,CAAC,0BAA0B,EAAE,gCAAgC,CAAC;QACrF;QACA,IAAIS,MAAM,IAAI,EAAE,MAAM7C,kBAAkB,CAAC,IAAI,CAACgE,MAAM,EAAE,0BAA0B,CAAC,CAAC,EAAE;UACnF,MAAM,IAAIlE,MAAM,CAACsC,KAAK,CAAC,mBAAmB,EAAE,aAAa,CAAC;QAC3D;QAEA,MAAM6B,OAAO,GAAG;UAAEjD,UAAU,EAAE;YAAEsC,GAAG,EAAE;UAAC;QAAE,CAAE;QAC1C,IAAIY,QAAQ,GAAG,MAAM3E,KAAK,CAAC6D,WAAW,CAAqBD,IAAI,EAAEc,OAAO,CAAC;QACzE,IAAI,CAACC,QAAQ,EAAE;UACdA,QAAQ,GAAG,MAAM3E,KAAK,CAAC4E,aAAa,CAAqBhB,IAAI,EAAEc,OAAO,CAAC;UACvE,IAAI,CAACC,QAAQ,EAAE;YACd,MAAM,IAAIpE,MAAM,CAACsC,KAAK,CAAC,sBAAsB,CAAC;UAC/C;UAEAjC,oBAAoB,CAACiE,wBAAwB,CAC5C,IAAI,CAACpB,OAAO,CAACC,KAAK,EAClB,MAAM,EACN,OAAO,EACP,IAAI,CAACC,QAAQ,EACbmB,IAAA;YAAA,IAAC;cAAEtB,SAAS;cAAEuB,QAAQ;cAAEC;YAAO,CAAE,GAAAF,IAAA;YAAA,oBAAAG,MAAA,CAClBzB,SAAS,iCAAAyB,MAAA,CAA+BF,QAAQ,qDAAAE,MAAA,CAAkDD,OAAO;UAAA,CAAE,CAC1H;QACF;QAEA,MAAM;UAAEE,MAAM;UAAEC;QAAU,CAAE,GAAG,MAAM3E,uBAAuB,CAACmE,QAAQ,CAACZ,GAAG,EAAET,MAAM,EAAE;UAClF8B,KAAK,EAAEhB,KAAe;UACtBiB,IAAI,EAAE;YAAEpB,QAAQ,EAAE;UAAC,CAAE;UACrBqB,IAAI,EAAEnB,MAAgB;UACtB1C;SACA,CAAC;QAEF,MAAM,CAAC8D,KAAK,EAAEC,KAAK,CAAC,GAAG,MAAMC,OAAO,CAACC,GAAG,CAAC,CAACR,MAAM,CAACvD,OAAO,EAAE,EAAEwD,UAAU,CAAC,CAAC;QAExE,OAAOpE,GAAG,CAACI,EAAE,CAACS,OAAO,CAAC;UAAE2D,KAAK;UAAEC;QAAK,CAAE,CAAC;MACxC;KACA,CACD;IAEDzE,GAAG,CAACI,EAAE,CAACC,QAAQ,CACd,cAAc,EACd;MAAEC,YAAY,EAAE,IAAI;MAAE6C,mBAAmB,EAAE,CAAC,oBAAoB;IAAC,CAAE,EACnE;MACC,MAAMxB,IAAIA,CAAA;QACT,MAAM;UAAEC;QAAU,CAAE,GAAG,IAAI;QAC3B,IAAI,CAACxC,iBAAiB,CAACwC,UAAU,CAAC,EAAE;UACnC,MAAM,IAAIpC,MAAM,CAACsC,KAAK,CAAC,+BAA+B,EAAE,kCAAkC,CAAC;QAC5F;QAEA,MAAMe,IAAI,GAAG,MAAM5D,KAAK,CAAC8D,iBAAiB,CAACnB,UAAU,CAACS,MAAM,CAAC;QAE7D,IAAI,CAACQ,IAAI,EAAE;UACV,MAAM,IAAIrD,MAAM,CAACsC,KAAK,CAAC,sBAAsB,EAAE,0BAA0B,CAAC;QAC3E;QAEA,IAAIe,IAAI,CAAC+B,SAAS,EAAE;UACnB,MAAM,IAAIpF,MAAM,CAACsC,KAAK,CAAC,sBAAsB,EAAE,gCAAgC,CAAC;QACjF;QAEA,MAAM+C,aAAa,GAAG,MAAM5F,KAAK,CAAC6F,eAAe,CAACjC,IAAI,CAACG,GAAG,CAAC;QAE3D,IAAI6B,aAAa,IAAI,CAAC,MAAMA,aAAa,CAACxB,KAAK,EAAE,IAAI,CAAC,EAAE;UACvD,MAAM,IAAI7D,MAAM,CAACsC,KAAK,CAAC,mBAAmB,EAAE,wCAAwC,CAAC;QACtF;QAEA,MAAM7C,KAAK,CAAC8F,UAAU,CAAClC,IAAI,CAACG,GAAG,CAAC;QAEhC,KAAKlD,mBAAmB,CAAC+C,IAAI,EAAE,SAAS,CAAC;QAEzC,OAAO7C,GAAG,CAACI,EAAE,CAACS,OAAO,EAAE;MACxB;KACA,CACD;IAEDb,GAAG,CAACI,EAAE,CAACC,QAAQ,CACd,0BAA0B,EAC1B;MAAEC,YAAY,EAAE,IAAI;MAAE6C,mBAAmB,EAAE,CAAC,oBAAoB;IAAC,CAAE,EACnE;MACC,MAAMxB,IAAIA,CAAA;QACT,MAAM;UAAEC;QAAU,CAAE,GAAG,IAAI;QAC3B,IAAI,CAACvC,6BAA6B,CAACuC,UAAU,CAAC,EAAE;UAC/C,MAAM,IAAIpC,MAAM,CAACsC,KAAK,CAAC,+BAA+B,EAAE,kCAAkC,CAAC;QAC5F;QAEA,MAAM;UAAEO,MAAM;UAAEC,QAAQ;UAAEY,QAAQ;UAAE8B;QAAK,CAAE,GAAGpD,UAAU;QAExD,IAAI,CAACS,MAAM,EAAE;UACZ,IAAI,CAACC,QAAQ,EAAE;YACd,OAAOtC,GAAG,CAACI,EAAE,CAACoC,OAAO,CAAC,+BAA+B,CAAC;UACvD;UAEA3C,oBAAoB,CAAC4C,SAAS,CAAC,IAAI,CAACC,OAAO,CAACC,KAAK,EAAE,UAAU,EAAE,OAAO,EAAE,IAAI,CAACC,QAAQ,CAAC;QACvF;QAEA,MAAMR,IAAI,GAAG,MAAMlD,KAAK,CAAC+F,iBAAiB,CAAC/B,QAAQ,CAAC;QAEpD,IAAI,CAACd,IAAI,EAAE;UACV,MAAM,IAAI5C,MAAM,CAACsC,KAAK,CAAC,oBAAoB,EAAE,qCAAqC,CAAC;QACpF;QAEA,MAAMe,IAAI,GAAGR,MAAM,GAAG,MAAMpD,KAAK,CAAC6D,WAAW,CAACT,MAAM,CAAC,GAAG,MAAMpD,KAAK,CAAC8D,iBAAiB,CAACT,QAAkB,CAAC;QAEzG,IAAI,CAACO,IAAI,EAAE;UACV,MAAM,IAAIrD,MAAM,CAACsC,KAAK,CAAC,sBAAsB,EAAE,0BAA0B,CAAC;QAC3E;QAEA,IAAI,EAAE,MAAMlC,eAAe,CAACwC,IAAI,CAACY,GAAG,EAAE,CAACH,IAAI,CAACG,GAAG,CAAC,EAAEgC,KAAK,CAAC,CAAC,EAAE;UAC1D,MAAM,IAAIxF,MAAM,CAACsC,KAAK,CAAC,wBAAwB,EAAE,0BAA0B,CAAC;QAC7E;QAEA,IAAIe,IAAI,CAACG,GAAG,KAAK,OAAO,EAAE;UACzB,MAAMkC,UAAU,GAAG,MAAM,CAAC,MAAMjG,KAAK,CAAC6F,eAAe,CAAC,OAAO,CAAC,EAAEzB,KAAK,EAAE;UACvE,IAAI6B,UAAU,KAAK,CAAC,EAAE;YACrB,MAAM,IAAI1F,MAAM,CAACsC,KAAK,CAAC,sBAAsB,EAAE,qCAAqC,CAAC;UACtF;QACD;QAEA,MAAM7C,KAAK,CAACkG,eAAe,CAAC/C,IAAI,CAACY,GAAG,EAAE,CAACH,IAAI,CAACG,GAAG,CAAC,EAAEgC,KAAK,CAAC;QAExD,IAAIjF,QAAQ,CAACQ,GAAG,CAAC,iBAAiB,CAAC,EAAE;UACpC,KAAK1B,GAAG,CAACuG,SAAS,CAAC,iBAAiB,EAAE;YACrCC,IAAI,EAAE,SAAS;YACfrC,GAAG,EAAEH,IAAI,CAACG,GAAG;YACbsC,CAAC,EAAE;cACFtC,GAAG,EAAEZ,IAAI,CAACY,GAAG;cACbE,QAAQ,EAAEd,IAAI,CAACc;aACf;YACD8B;WACA,CAAC;QACH;QAEA,OAAOhF,GAAG,CAACI,EAAE,CAACS,OAAO,CAAC;UACrBgC;SACA,CAAC;MACH;KACA,CACD;IAAC0C,sBAAA;EAAA,SAAAC,WAAA;IAAA,OAAAD,sBAAA,CAAAC,WAAA;EAAA;EAAAD,sBAAA;AAAA;EAAAE,IAAA;EAAAC,KAAA;AAAA","ignoreList":[]},"sourceType":"module","externalDependencies":{},"hash":"1bca4ccd356fe525b40659f5bf8c43323cbce4dd"}
