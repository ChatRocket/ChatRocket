{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/app/livechat/imports/server/rest/users.ts","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","topLevelAwait","objectRestSpread","objectRestSpread","asyncGenerators","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"os.osx.arm64"},"sourceFileName":"app/livechat/imports/server/rest/users.ts","filename":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/app/livechat/imports/server/rest/users.ts","inputSourceMap":{"version":3,"file":"app/livechat/imports/server/rest/users.ts","sourceRoot":"","sources":["app/livechat/imports/server/rest/users.ts"],"names":[],"mappings":"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","sourcesContent":["import { Users } from '@rocket.chat/models';\nimport { isLivechatUsersManagerGETProps, isPOSTLivechatUsersTypeProps } from '@rocket.chat/rest-typings';\nimport { check } from 'meteor/check';\nimport _ from 'underscore';\n\nimport { API } from '../../../../api/server';\nimport { getPaginationItems } from '../../../../api/server/helpers/getPaginationItems';\nimport { hasAtLeastOnePermissionAsync } from '../../../../authorization/server/functions/hasPermission';\nimport { findAgents, findManagers } from '../../../server/api/lib/users';\nimport { Livechat } from '../../../server/lib/LivechatTyped';\n\nconst emptyStringArray: string[] = [];\n\nAPI.v1.addRoute(\n\t'livechat/users/:type',\n\t{\n\t\tauthRequired: true,\n\t\tpermissionsRequired: {\n\t\t\t'POST': ['view-livechat-manager'],\n\t\t\t'*': emptyStringArray,\n\t\t},\n\t\tvalidateParams: {\n\t\t\tGET: isLivechatUsersManagerGETProps,\n\t\t\tPOST: isPOSTLivechatUsersTypeProps,\n\t\t},\n\t},\n\t{\n\t\tasync get() {\n\t\t\tcheck(this.urlParams, {\n\t\t\t\ttype: String,\n\t\t\t});\n\t\t\tconst { offset, count } = await getPaginationItems(this.queryParams);\n\t\t\tconst { sort } = await this.parseJsonQuery();\n\t\t\tconst { text } = this.queryParams;\n\n\t\t\tif (this.urlParams.type === 'agent') {\n\t\t\t\tif (!(await hasAtLeastOnePermissionAsync(this.userId, ['transfer-livechat-guest', 'edit-omnichannel-contact']))) {\n\t\t\t\t\treturn API.v1.unauthorized();\n\t\t\t\t}\n\n\t\t\t\tconst { onlyAvailable, excludeId, showIdleAgents } = this.queryParams;\n\t\t\t\treturn API.v1.success(\n\t\t\t\t\tawait findAgents({\n\t\t\t\t\t\ttext,\n\t\t\t\t\t\tonlyAvailable,\n\t\t\t\t\t\texcludeId,\n\t\t\t\t\t\tshowIdleAgents,\n\t\t\t\t\t\tpagination: {\n\t\t\t\t\t\t\toffset,\n\t\t\t\t\t\t\tcount,\n\t\t\t\t\t\t\tsort,\n\t\t\t\t\t\t},\n\t\t\t\t\t}),\n\t\t\t\t);\n\t\t\t}\n\t\t\tif (this.urlParams.type === 'manager') {\n\t\t\t\tif (!(await hasAtLeastOnePermissionAsync(this.userId, ['view-livechat-manager']))) {\n\t\t\t\t\treturn API.v1.unauthorized();\n\t\t\t\t}\n\n\t\t\t\treturn API.v1.success(\n\t\t\t\t\tawait findManagers({\n\t\t\t\t\t\ttext,\n\t\t\t\t\t\tpagination: {\n\t\t\t\t\t\t\toffset,\n\t\t\t\t\t\t\tcount,\n\t\t\t\t\t\t\tsort,\n\t\t\t\t\t\t},\n\t\t\t\t\t}),\n\t\t\t\t);\n\t\t\t}\n\t\t\tthrow new Error('Invalid type');\n\t\t},\n\t\tasync post() {\n\t\t\tif (this.urlParams.type === 'agent') {\n\t\t\t\tconst user = await Livechat.addAgent(this.bodyParams.username);\n\t\t\t\tif (user) {\n\t\t\t\t\treturn API.v1.success({ user });\n\t\t\t\t}\n\t\t\t} else if (this.urlParams.type === 'manager') {\n\t\t\t\tconst user = await Livechat.addManager(this.bodyParams.username);\n\t\t\t\tif (user) {\n\t\t\t\t\treturn API.v1.success({ user });\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tthrow new Error('Invalid type');\n\t\t\t}\n\n\t\t\treturn API.v1.failure();\n\t\t},\n\t},\n);\n\nAPI.v1.addRoute(\n\t'livechat/users/:type/:_id',\n\t{ authRequired: true, permissionsRequired: ['view-livechat-manager'] },\n\t{\n\t\tasync get() {\n\t\t\tconst user = await Users.findOneById(this.urlParams._id);\n\n\t\t\tif (!user) {\n\t\t\t\treturn API.v1.failure('User not found');\n\t\t\t}\n\n\t\t\tlet role;\n\n\t\t\tif (this.urlParams.type === 'agent') {\n\t\t\t\trole = 'livechat-agent';\n\t\t\t} else if (this.urlParams.type === 'manager') {\n\t\t\t\trole = 'livechat-manager';\n\t\t\t} else {\n\t\t\t\tthrow new Error('Invalid type');\n\t\t\t}\n\n\t\t\tif (user.roles.indexOf(role) !== -1) {\n\t\t\t\treturn API.v1.success({\n\t\t\t\t\tuser: _.pick(user, '_id', 'username', 'name', 'status', 'statusLivechat', 'emails', 'livechat'),\n\t\t\t\t});\n\t\t\t}\n\n\t\t\treturn API.v1.success({\n\t\t\t\tuser: null,\n\t\t\t});\n\t\t},\n\t\tasync delete() {\n\t\t\tconst user = await Users.findOneById(this.urlParams._id);\n\n\t\t\tif (!user?.username) {\n\t\t\t\treturn API.v1.failure();\n\t\t\t}\n\n\t\t\tif (this.urlParams.type === 'agent') {\n\t\t\t\tif (await Livechat.removeAgent(user.username)) {\n\t\t\t\t\treturn API.v1.success();\n\t\t\t\t}\n\t\t\t} else if (this.urlParams.type === 'manager') {\n\t\t\t\tif (await Livechat.removeManager(user.username)) {\n\t\t\t\t\treturn API.v1.success();\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tthrow new Error('Invalid type');\n\t\t\t}\n\n\t\t\treturn API.v1.failure();\n\t\t},\n\t},\n);\n"]},"targets":{"android":"125.0.0","chrome":"125.0.0","edge":"125.0.0","firefox":"115.0.0","ie":"10.0.0","ios":"17.4.0","opera":"110.0.0","opera_mobile":"80.0.0","safari":"17.4.0","samsung":"24.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor","root":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":false,"enforceStrictMode":false,"dynamicImport":true,"generateLetDeclarations":true,"topLevelAwait":true},"externalDependencies":[]},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"version":"7.17.2","helpers":true,"useESModules":false,"corejs":false},"externalDependencies":[]},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-async-generator-functions","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-class-properties","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true},"externalDependencies":[]},{"key":"transform-react-jsx","visitor":{"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXFragment":{"exit":[null]},"JSXElement":{"exit":[null]},"JSXAttribute":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false},"externalDependencies":[]},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-nullish-coalescing-operator","visitor":{"LogicalExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-optional-chaining","visitor":{"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-optional-catch-binding","visitor":{"CatchClause":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-class-properties","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-async-generator-functions","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-logical-assignment-operators","visitor":{"AssignmentExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]}],"presets":[],"generatorOpts":{"filename":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/app/livechat/imports/server/rest/users.ts","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"app/livechat/imports/server/rest/users.ts","inputSourceMap":{"version":3,"file":"app/livechat/imports/server/rest/users.ts","sourceRoot":"","sources":["app/livechat/imports/server/rest/users.ts"],"names":[],"mappings":"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","sourcesContent":["import { Users } from '@rocket.chat/models';\nimport { isLivechatUsersManagerGETProps, isPOSTLivechatUsersTypeProps } from '@rocket.chat/rest-typings';\nimport { check } from 'meteor/check';\nimport _ from 'underscore';\n\nimport { API } from '../../../../api/server';\nimport { getPaginationItems } from '../../../../api/server/helpers/getPaginationItems';\nimport { hasAtLeastOnePermissionAsync } from '../../../../authorization/server/functions/hasPermission';\nimport { findAgents, findManagers } from '../../../server/api/lib/users';\nimport { Livechat } from '../../../server/lib/LivechatTyped';\n\nconst emptyStringArray: string[] = [];\n\nAPI.v1.addRoute(\n\t'livechat/users/:type',\n\t{\n\t\tauthRequired: true,\n\t\tpermissionsRequired: {\n\t\t\t'POST': ['view-livechat-manager'],\n\t\t\t'*': emptyStringArray,\n\t\t},\n\t\tvalidateParams: {\n\t\t\tGET: isLivechatUsersManagerGETProps,\n\t\t\tPOST: isPOSTLivechatUsersTypeProps,\n\t\t},\n\t},\n\t{\n\t\tasync get() {\n\t\t\tcheck(this.urlParams, {\n\t\t\t\ttype: String,\n\t\t\t});\n\t\t\tconst { offset, count } = await getPaginationItems(this.queryParams);\n\t\t\tconst { sort } = await this.parseJsonQuery();\n\t\t\tconst { text } = this.queryParams;\n\n\t\t\tif (this.urlParams.type === 'agent') {\n\t\t\t\tif (!(await hasAtLeastOnePermissionAsync(this.userId, ['transfer-livechat-guest', 'edit-omnichannel-contact']))) {\n\t\t\t\t\treturn API.v1.unauthorized();\n\t\t\t\t}\n\n\t\t\t\tconst { onlyAvailable, excludeId, showIdleAgents } = this.queryParams;\n\t\t\t\treturn API.v1.success(\n\t\t\t\t\tawait findAgents({\n\t\t\t\t\t\ttext,\n\t\t\t\t\t\tonlyAvailable,\n\t\t\t\t\t\texcludeId,\n\t\t\t\t\t\tshowIdleAgents,\n\t\t\t\t\t\tpagination: {\n\t\t\t\t\t\t\toffset,\n\t\t\t\t\t\t\tcount,\n\t\t\t\t\t\t\tsort,\n\t\t\t\t\t\t},\n\t\t\t\t\t}),\n\t\t\t\t);\n\t\t\t}\n\t\t\tif (this.urlParams.type === 'manager') {\n\t\t\t\tif (!(await hasAtLeastOnePermissionAsync(this.userId, ['view-livechat-manager']))) {\n\t\t\t\t\treturn API.v1.unauthorized();\n\t\t\t\t}\n\n\t\t\t\treturn API.v1.success(\n\t\t\t\t\tawait findManagers({\n\t\t\t\t\t\ttext,\n\t\t\t\t\t\tpagination: {\n\t\t\t\t\t\t\toffset,\n\t\t\t\t\t\t\tcount,\n\t\t\t\t\t\t\tsort,\n\t\t\t\t\t\t},\n\t\t\t\t\t}),\n\t\t\t\t);\n\t\t\t}\n\t\t\tthrow new Error('Invalid type');\n\t\t},\n\t\tasync post() {\n\t\t\tif (this.urlParams.type === 'agent') {\n\t\t\t\tconst user = await Livechat.addAgent(this.bodyParams.username);\n\t\t\t\tif (user) {\n\t\t\t\t\treturn API.v1.success({ user });\n\t\t\t\t}\n\t\t\t} else if (this.urlParams.type === 'manager') {\n\t\t\t\tconst user = await Livechat.addManager(this.bodyParams.username);\n\t\t\t\tif (user) {\n\t\t\t\t\treturn API.v1.success({ user });\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tthrow new Error('Invalid type');\n\t\t\t}\n\n\t\t\treturn API.v1.failure();\n\t\t},\n\t},\n);\n\nAPI.v1.addRoute(\n\t'livechat/users/:type/:_id',\n\t{ authRequired: true, permissionsRequired: ['view-livechat-manager'] },\n\t{\n\t\tasync get() {\n\t\t\tconst user = await Users.findOneById(this.urlParams._id);\n\n\t\t\tif (!user) {\n\t\t\t\treturn API.v1.failure('User not found');\n\t\t\t}\n\n\t\t\tlet role;\n\n\t\t\tif (this.urlParams.type === 'agent') {\n\t\t\t\trole = 'livechat-agent';\n\t\t\t} else if (this.urlParams.type === 'manager') {\n\t\t\t\trole = 'livechat-manager';\n\t\t\t} else {\n\t\t\t\tthrow new Error('Invalid type');\n\t\t\t}\n\n\t\t\tif (user.roles.indexOf(role) !== -1) {\n\t\t\t\treturn API.v1.success({\n\t\t\t\t\tuser: _.pick(user, '_id', 'username', 'name', 'status', 'statusLivechat', 'emails', 'livechat'),\n\t\t\t\t});\n\t\t\t}\n\n\t\t\treturn API.v1.success({\n\t\t\t\tuser: null,\n\t\t\t});\n\t\t},\n\t\tasync delete() {\n\t\t\tconst user = await Users.findOneById(this.urlParams._id);\n\n\t\t\tif (!user?.username) {\n\t\t\t\treturn API.v1.failure();\n\t\t\t}\n\n\t\t\tif (this.urlParams.type === 'agent') {\n\t\t\t\tif (await Livechat.removeAgent(user.username)) {\n\t\t\t\t\treturn API.v1.success();\n\t\t\t\t}\n\t\t\t} else if (this.urlParams.type === 'manager') {\n\t\t\t\tif (await Livechat.removeManager(user.username)) {\n\t\t\t\t\treturn API.v1.success();\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tthrow new Error('Invalid type');\n\t\t\t}\n\n\t\t\treturn API.v1.failure();\n\t\t},\n\t},\n);\n"]}}},"code":"!module.wrapAsync(async function (module, __reifyWaitForDeps__, __reify_async_result__) {\n  \"use strict\";\n  try {\n    let Users;\n    module.link(\"@rocket.chat/models\", {\n      Users(v) {\n        Users = v;\n      }\n    }, 0);\n    let isLivechatUsersManagerGETProps, isPOSTLivechatUsersTypeProps;\n    module.link(\"@rocket.chat/rest-typings\", {\n      isLivechatUsersManagerGETProps(v) {\n        isLivechatUsersManagerGETProps = v;\n      },\n      isPOSTLivechatUsersTypeProps(v) {\n        isPOSTLivechatUsersTypeProps = v;\n      }\n    }, 1);\n    let check;\n    module.link(\"meteor/check\", {\n      check(v) {\n        check = v;\n      }\n    }, 2);\n    let _;\n    module.link(\"underscore\", {\n      default(v) {\n        _ = v;\n      }\n    }, 3);\n    let API;\n    module.link(\"../../../../api/server\", {\n      API(v) {\n        API = v;\n      }\n    }, 4);\n    let getPaginationItems;\n    module.link(\"../../../../api/server/helpers/getPaginationItems\", {\n      getPaginationItems(v) {\n        getPaginationItems = v;\n      }\n    }, 5);\n    let hasAtLeastOnePermissionAsync;\n    module.link(\"../../../../authorization/server/functions/hasPermission\", {\n      hasAtLeastOnePermissionAsync(v) {\n        hasAtLeastOnePermissionAsync = v;\n      }\n    }, 6);\n    let findAgents, findManagers;\n    module.link(\"../../../server/api/lib/users\", {\n      findAgents(v) {\n        findAgents = v;\n      },\n      findManagers(v) {\n        findManagers = v;\n      }\n    }, 7);\n    let Livechat;\n    module.link(\"../../../server/lib/LivechatTyped\", {\n      Livechat(v) {\n        Livechat = v;\n      }\n    }, 8);\n    if (__reifyWaitForDeps__()) (await __reifyWaitForDeps__())();\n    const emptyStringArray = [];\n    API.v1.addRoute('livechat/users/:type', {\n      authRequired: true,\n      permissionsRequired: {\n        'POST': ['view-livechat-manager'],\n        '*': emptyStringArray\n      },\n      validateParams: {\n        GET: isLivechatUsersManagerGETProps,\n        POST: isPOSTLivechatUsersTypeProps\n      }\n    }, {\n      async get() {\n        check(this.urlParams, {\n          type: String\n        });\n        const {\n          offset,\n          count\n        } = await getPaginationItems(this.queryParams);\n        const {\n          sort\n        } = await this.parseJsonQuery();\n        const {\n          text\n        } = this.queryParams;\n        if (this.urlParams.type === 'agent') {\n          if (!(await hasAtLeastOnePermissionAsync(this.userId, ['transfer-livechat-guest', 'edit-omnichannel-contact']))) {\n            return API.v1.unauthorized();\n          }\n          const {\n            onlyAvailable,\n            excludeId,\n            showIdleAgents\n          } = this.queryParams;\n          return API.v1.success(await findAgents({\n            text,\n            onlyAvailable,\n            excludeId,\n            showIdleAgents,\n            pagination: {\n              offset,\n              count,\n              sort\n            }\n          }));\n        }\n        if (this.urlParams.type === 'manager') {\n          if (!(await hasAtLeastOnePermissionAsync(this.userId, ['view-livechat-manager']))) {\n            return API.v1.unauthorized();\n          }\n          return API.v1.success(await findManagers({\n            text,\n            pagination: {\n              offset,\n              count,\n              sort\n            }\n          }));\n        }\n        throw new Error('Invalid type');\n      },\n      async post() {\n        if (this.urlParams.type === 'agent') {\n          const user = await Livechat.addAgent(this.bodyParams.username);\n          if (user) {\n            return API.v1.success({\n              user\n            });\n          }\n        } else if (this.urlParams.type === 'manager') {\n          const user = await Livechat.addManager(this.bodyParams.username);\n          if (user) {\n            return API.v1.success({\n              user\n            });\n          }\n        } else {\n          throw new Error('Invalid type');\n        }\n        return API.v1.failure();\n      }\n    });\n    API.v1.addRoute('livechat/users/:type/:_id', {\n      authRequired: true,\n      permissionsRequired: ['view-livechat-manager']\n    }, {\n      async get() {\n        const user = await Users.findOneById(this.urlParams._id);\n        if (!user) {\n          return API.v1.failure('User not found');\n        }\n        let role;\n        if (this.urlParams.type === 'agent') {\n          role = 'livechat-agent';\n        } else if (this.urlParams.type === 'manager') {\n          role = 'livechat-manager';\n        } else {\n          throw new Error('Invalid type');\n        }\n        if (user.roles.indexOf(role) !== -1) {\n          return API.v1.success({\n            user: _.pick(user, '_id', 'username', 'name', 'status', 'statusLivechat', 'emails', 'livechat')\n          });\n        }\n        return API.v1.success({\n          user: null\n        });\n      },\n      async delete() {\n        const user = await Users.findOneById(this.urlParams._id);\n        if (!(user !== null && user !== void 0 && user.username)) {\n          return API.v1.failure();\n        }\n        if (this.urlParams.type === 'agent') {\n          if (await Livechat.removeAgent(user.username)) {\n            return API.v1.success();\n          }\n        } else if (this.urlParams.type === 'manager') {\n          if (await Livechat.removeManager(user.username)) {\n            return API.v1.success();\n          }\n        } else {\n          throw new Error('Invalid type');\n        }\n        return API.v1.failure();\n      }\n    });\n    __reify_async_result__();\n  } catch (_reifyError) {\n    return __reify_async_result__(_reifyError);\n  }\n  __reify_async_result__()\n}, {\n  self: this,\n  async: false\n});","map":{"version":3,"names":["Users","module","link","v","isLivechatUsersManagerGETProps","isPOSTLivechatUsersTypeProps","check","_","default","API","getPaginationItems","hasAtLeastOnePermissionAsync","findAgents","findManagers","Livechat","__reifyWaitForDeps__","emptyStringArray","v1","addRoute","authRequired","permissionsRequired","validateParams","GET","POST","get","urlParams","type","String","offset","count","queryParams","sort","parseJsonQuery","text","userId","unauthorized","onlyAvailable","excludeId","showIdleAgents","success","pagination","Error","post","user","addAgent","bodyParams","username","addManager","failure","findOneById","_id","role","roles","indexOf","pick","delete","removeAgent","removeManager","__reify_async_result__","_reifyError","self","async"],"sources":["app/livechat/imports/server/rest/users.ts"],"sourcesContent":["import { Users } from '@rocket.chat/models';\nimport { isLivechatUsersManagerGETProps, isPOSTLivechatUsersTypeProps } from '@rocket.chat/rest-typings';\nimport { check } from 'meteor/check';\nimport _ from 'underscore';\n\nimport { API } from '../../../../api/server';\nimport { getPaginationItems } from '../../../../api/server/helpers/getPaginationItems';\nimport { hasAtLeastOnePermissionAsync } from '../../../../authorization/server/functions/hasPermission';\nimport { findAgents, findManagers } from '../../../server/api/lib/users';\nimport { Livechat } from '../../../server/lib/LivechatTyped';\n\nconst emptyStringArray: string[] = [];\n\nAPI.v1.addRoute(\n\t'livechat/users/:type',\n\t{\n\t\tauthRequired: true,\n\t\tpermissionsRequired: {\n\t\t\t'POST': ['view-livechat-manager'],\n\t\t\t'*': emptyStringArray,\n\t\t},\n\t\tvalidateParams: {\n\t\t\tGET: isLivechatUsersManagerGETProps,\n\t\t\tPOST: isPOSTLivechatUsersTypeProps,\n\t\t},\n\t},\n\t{\n\t\tasync get() {\n\t\t\tcheck(this.urlParams, {\n\t\t\t\ttype: String,\n\t\t\t});\n\t\t\tconst { offset, count } = await getPaginationItems(this.queryParams);\n\t\t\tconst { sort } = await this.parseJsonQuery();\n\t\t\tconst { text } = this.queryParams;\n\n\t\t\tif (this.urlParams.type === 'agent') {\n\t\t\t\tif (!(await hasAtLeastOnePermissionAsync(this.userId, ['transfer-livechat-guest', 'edit-omnichannel-contact']))) {\n\t\t\t\t\treturn API.v1.unauthorized();\n\t\t\t\t}\n\n\t\t\t\tconst { onlyAvailable, excludeId, showIdleAgents } = this.queryParams;\n\t\t\t\treturn API.v1.success(\n\t\t\t\t\tawait findAgents({\n\t\t\t\t\t\ttext,\n\t\t\t\t\t\tonlyAvailable,\n\t\t\t\t\t\texcludeId,\n\t\t\t\t\t\tshowIdleAgents,\n\t\t\t\t\t\tpagination: {\n\t\t\t\t\t\t\toffset,\n\t\t\t\t\t\t\tcount,\n\t\t\t\t\t\t\tsort,\n\t\t\t\t\t\t},\n\t\t\t\t\t}),\n\t\t\t\t);\n\t\t\t}\n\t\t\tif (this.urlParams.type === 'manager') {\n\t\t\t\tif (!(await hasAtLeastOnePermissionAsync(this.userId, ['view-livechat-manager']))) {\n\t\t\t\t\treturn API.v1.unauthorized();\n\t\t\t\t}\n\n\t\t\t\treturn API.v1.success(\n\t\t\t\t\tawait findManagers({\n\t\t\t\t\t\ttext,\n\t\t\t\t\t\tpagination: {\n\t\t\t\t\t\t\toffset,\n\t\t\t\t\t\t\tcount,\n\t\t\t\t\t\t\tsort,\n\t\t\t\t\t\t},\n\t\t\t\t\t}),\n\t\t\t\t);\n\t\t\t}\n\t\t\tthrow new Error('Invalid type');\n\t\t},\n\t\tasync post() {\n\t\t\tif (this.urlParams.type === 'agent') {\n\t\t\t\tconst user = await Livechat.addAgent(this.bodyParams.username);\n\t\t\t\tif (user) {\n\t\t\t\t\treturn API.v1.success({ user });\n\t\t\t\t}\n\t\t\t} else if (this.urlParams.type === 'manager') {\n\t\t\t\tconst user = await Livechat.addManager(this.bodyParams.username);\n\t\t\t\tif (user) {\n\t\t\t\t\treturn API.v1.success({ user });\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tthrow new Error('Invalid type');\n\t\t\t}\n\n\t\t\treturn API.v1.failure();\n\t\t},\n\t},\n);\n\nAPI.v1.addRoute(\n\t'livechat/users/:type/:_id',\n\t{ authRequired: true, permissionsRequired: ['view-livechat-manager'] },\n\t{\n\t\tasync get() {\n\t\t\tconst user = await Users.findOneById(this.urlParams._id);\n\n\t\t\tif (!user) {\n\t\t\t\treturn API.v1.failure('User not found');\n\t\t\t}\n\n\t\t\tlet role;\n\n\t\t\tif (this.urlParams.type === 'agent') {\n\t\t\t\trole = 'livechat-agent';\n\t\t\t} else if (this.urlParams.type === 'manager') {\n\t\t\t\trole = 'livechat-manager';\n\t\t\t} else {\n\t\t\t\tthrow new Error('Invalid type');\n\t\t\t}\n\n\t\t\tif (user.roles.indexOf(role) !== -1) {\n\t\t\t\treturn API.v1.success({\n\t\t\t\t\tuser: _.pick(user, '_id', 'username', 'name', 'status', 'statusLivechat', 'emails', 'livechat'),\n\t\t\t\t});\n\t\t\t}\n\n\t\t\treturn API.v1.success({\n\t\t\t\tuser: null,\n\t\t\t});\n\t\t},\n\t\tasync delete() {\n\t\t\tconst user = await Users.findOneById(this.urlParams._id);\n\n\t\t\tif (!user?.username) {\n\t\t\t\treturn API.v1.failure();\n\t\t\t}\n\n\t\t\tif (this.urlParams.type === 'agent') {\n\t\t\t\tif (await Livechat.removeAgent(user.username)) {\n\t\t\t\t\treturn API.v1.success();\n\t\t\t\t}\n\t\t\t} else if (this.urlParams.type === 'manager') {\n\t\t\t\tif (await Livechat.removeManager(user.username)) {\n\t\t\t\t\treturn API.v1.success();\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tthrow new Error('Invalid type');\n\t\t\t}\n\n\t\t\treturn API.v1.failure();\n\t\t},\n\t},\n);\n"],"mappings":"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","ignoreList":[]},"sourceType":"module","externalDependencies":{},"hash":"2847bfda36ef8af51cc3f649cefb2aeeffffcba9"}
