{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/app/integrations/server/lib/isolated-vm/buildSandbox.ts","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","topLevelAwait","objectRestSpread","objectRestSpread","asyncGenerators","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"os.osx.arm64"},"sourceFileName":"app/integrations/server/lib/isolated-vm/buildSandbox.ts","filename":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/app/integrations/server/lib/isolated-vm/buildSandbox.ts","inputSourceMap":{"version":3,"file":"app/integrations/server/lib/isolated-vm/buildSandbox.ts","sourceRoot":"","sources":["app/integrations/server/lib/isolated-vm/buildSandbox.ts"],"names":[],"mappings":"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","sourcesContent":["import { EventEmitter } from 'events';\n\nimport { serverFetch as fetch, Response } from '@rocket.chat/server-fetch';\nimport ivm, { type Context } from 'isolated-vm';\n\nimport * as s from '../../../../../lib/utils/stringUtils';\n\nconst proxyObject = (obj: Record<string, any>, forbiddenKeys: string[] = []): Record<string, any> => {\n\treturn copyObject({\n\t\tisProxy: true,\n\t\tget: (key: string) => {\n\t\t\tif (forbiddenKeys.includes(key)) {\n\t\t\t\treturn undefined;\n\t\t\t}\n\n\t\t\tconst value = obj[key];\n\n\t\t\tif (typeof value === 'function') {\n\t\t\t\treturn new ivm.Reference(async (...args: any[]) => {\n\t\t\t\t\tconst result = (obj[key] as any)(...args);\n\n\t\t\t\t\tif (result && result instanceof Promise) {\n\t\t\t\t\t\treturn new Promise(async (resolve, reject) => {\n\t\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\t\tconst awaitedResult = await result;\n\t\t\t\t\t\t\t\tresolve(makeTransferable(awaitedResult));\n\t\t\t\t\t\t\t} catch (e) {\n\t\t\t\t\t\t\t\treject(e);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\n\t\t\t\t\treturn makeTransferable(result);\n\t\t\t\t});\n\t\t\t}\n\n\t\t\treturn makeTransferable(value);\n\t\t},\n\t});\n};\n\nconst copyObject = (obj: Record<string, any> | any[]): Record<string, any> | any[] => {\n\tif (Array.isArray(obj)) {\n\t\treturn obj.map((data) => copyData(data));\n\t}\n\n\tif (obj instanceof Response) {\n\t\treturn proxyObject(obj, ['clone']);\n\t}\n\n\tif (isSemiTransferable(obj)) {\n\t\treturn obj;\n\t}\n\n\tif (typeof obj[Symbol.iterator as any] === 'function') {\n\t\treturn copyObject(Array.from(obj as any));\n\t}\n\n\tif (obj instanceof EventEmitter) {\n\t\treturn {};\n\t}\n\n\tconst keys = Object.keys(obj);\n\n\treturn {\n\t\t...Object.fromEntries(\n\t\t\tkeys.map((key) => {\n\t\t\t\tconst data = obj[key];\n\n\t\t\t\tif (typeof data === 'function') {\n\t\t\t\t\treturn [key, new ivm.Callback((...args: any[]) => obj[key](...args))];\n\t\t\t\t}\n\n\t\t\t\treturn [key, copyData(data)];\n\t\t\t}),\n\t\t),\n\t};\n};\n\n// Transferable data can be passed to isolates directly\nconst isTransferable = (data: any): data is ivm.Transferable => {\n\tconst dataType = typeof data;\n\n\tif (data === ivm) {\n\t\treturn true;\n\t}\n\n\tif (['null', 'undefined', 'string', 'number', 'boolean', 'function'].includes(dataType)) {\n\t\treturn true;\n\t}\n\n\tif (dataType !== 'object') {\n\t\treturn false;\n\t}\n\n\treturn (\n\t\tdata instanceof ivm.Isolate ||\n\t\tdata instanceof ivm.Context ||\n\t\tdata instanceof ivm.Script ||\n\t\tdata instanceof ivm.ExternalCopy ||\n\t\tdata instanceof ivm.Callback ||\n\t\tdata instanceof ivm.Reference\n\t);\n};\n\n// Semi-transferable data can be copied with an ivm.ExternalCopy without needing any manipulation.\nconst isSemiTransferable = (data: any) => data instanceof ArrayBuffer;\n\nconst copyData = <T extends ivm.Transferable | Record<string, any> | any[]>(data: T) => (isTransferable(data) ? data : copyObject(data));\nconst makeTransferable = (data: any) => (isTransferable(data) ? data : new ivm.ExternalCopy(copyObject(data)).copyInto());\n\nexport const buildSandbox = (context: Context) => {\n\tconst { global: jail } = context;\n\tjail.setSync('global', jail.derefInto());\n\tjail.setSync('ivm', ivm);\n\n\tjail.setSync('s', makeTransferable(s));\n\tjail.setSync('console', makeTransferable(console));\n\n\tjail.setSync(\n\t\t'serverFetch',\n\t\tnew ivm.Reference(async (url: string, ...args: any[]) => {\n\t\t\tconst result = await fetch(url, ...args);\n\t\t\treturn makeTransferable(result);\n\t\t}),\n\t);\n};\n"]},"targets":{"android":"125.0.0","chrome":"125.0.0","edge":"125.0.0","firefox":"115.0.0","ie":"10.0.0","ios":"17.4.0","opera":"110.0.0","opera_mobile":"80.0.0","safari":"17.4.0","samsung":"24.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor","root":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":false,"enforceStrictMode":false,"dynamicImport":true,"generateLetDeclarations":true,"topLevelAwait":true},"externalDependencies":[]},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"version":"7.17.2","helpers":true,"useESModules":false,"corejs":false},"externalDependencies":[]},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-async-generator-functions","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-class-properties","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true},"externalDependencies":[]},{"key":"transform-react-jsx","visitor":{"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXFragment":{"exit":[null]},"JSXElement":{"exit":[null]},"JSXAttribute":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false},"externalDependencies":[]},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-nullish-coalescing-operator","visitor":{"LogicalExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-optional-chaining","visitor":{"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-optional-catch-binding","visitor":{"CatchClause":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-class-properties","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-async-generator-functions","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-logical-assignment-operators","visitor":{"AssignmentExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]}],"presets":[],"generatorOpts":{"filename":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/app/integrations/server/lib/isolated-vm/buildSandbox.ts","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"app/integrations/server/lib/isolated-vm/buildSandbox.ts","inputSourceMap":{"version":3,"file":"app/integrations/server/lib/isolated-vm/buildSandbox.ts","sourceRoot":"","sources":["app/integrations/server/lib/isolated-vm/buildSandbox.ts"],"names":[],"mappings":"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","sourcesContent":["import { EventEmitter } from 'events';\n\nimport { serverFetch as fetch, Response } from '@rocket.chat/server-fetch';\nimport ivm, { type Context } from 'isolated-vm';\n\nimport * as s from '../../../../../lib/utils/stringUtils';\n\nconst proxyObject = (obj: Record<string, any>, forbiddenKeys: string[] = []): Record<string, any> => {\n\treturn copyObject({\n\t\tisProxy: true,\n\t\tget: (key: string) => {\n\t\t\tif (forbiddenKeys.includes(key)) {\n\t\t\t\treturn undefined;\n\t\t\t}\n\n\t\t\tconst value = obj[key];\n\n\t\t\tif (typeof value === 'function') {\n\t\t\t\treturn new ivm.Reference(async (...args: any[]) => {\n\t\t\t\t\tconst result = (obj[key] as any)(...args);\n\n\t\t\t\t\tif (result && result instanceof Promise) {\n\t\t\t\t\t\treturn new Promise(async (resolve, reject) => {\n\t\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\t\tconst awaitedResult = await result;\n\t\t\t\t\t\t\t\tresolve(makeTransferable(awaitedResult));\n\t\t\t\t\t\t\t} catch (e) {\n\t\t\t\t\t\t\t\treject(e);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\n\t\t\t\t\treturn makeTransferable(result);\n\t\t\t\t});\n\t\t\t}\n\n\t\t\treturn makeTransferable(value);\n\t\t},\n\t});\n};\n\nconst copyObject = (obj: Record<string, any> | any[]): Record<string, any> | any[] => {\n\tif (Array.isArray(obj)) {\n\t\treturn obj.map((data) => copyData(data));\n\t}\n\n\tif (obj instanceof Response) {\n\t\treturn proxyObject(obj, ['clone']);\n\t}\n\n\tif (isSemiTransferable(obj)) {\n\t\treturn obj;\n\t}\n\n\tif (typeof obj[Symbol.iterator as any] === 'function') {\n\t\treturn copyObject(Array.from(obj as any));\n\t}\n\n\tif (obj instanceof EventEmitter) {\n\t\treturn {};\n\t}\n\n\tconst keys = Object.keys(obj);\n\n\treturn {\n\t\t...Object.fromEntries(\n\t\t\tkeys.map((key) => {\n\t\t\t\tconst data = obj[key];\n\n\t\t\t\tif (typeof data === 'function') {\n\t\t\t\t\treturn [key, new ivm.Callback((...args: any[]) => obj[key](...args))];\n\t\t\t\t}\n\n\t\t\t\treturn [key, copyData(data)];\n\t\t\t}),\n\t\t),\n\t};\n};\n\n// Transferable data can be passed to isolates directly\nconst isTransferable = (data: any): data is ivm.Transferable => {\n\tconst dataType = typeof data;\n\n\tif (data === ivm) {\n\t\treturn true;\n\t}\n\n\tif (['null', 'undefined', 'string', 'number', 'boolean', 'function'].includes(dataType)) {\n\t\treturn true;\n\t}\n\n\tif (dataType !== 'object') {\n\t\treturn false;\n\t}\n\n\treturn (\n\t\tdata instanceof ivm.Isolate ||\n\t\tdata instanceof ivm.Context ||\n\t\tdata instanceof ivm.Script ||\n\t\tdata instanceof ivm.ExternalCopy ||\n\t\tdata instanceof ivm.Callback ||\n\t\tdata instanceof ivm.Reference\n\t);\n};\n\n// Semi-transferable data can be copied with an ivm.ExternalCopy without needing any manipulation.\nconst isSemiTransferable = (data: any) => data instanceof ArrayBuffer;\n\nconst copyData = <T extends ivm.Transferable | Record<string, any> | any[]>(data: T) => (isTransferable(data) ? data : copyObject(data));\nconst makeTransferable = (data: any) => (isTransferable(data) ? data : new ivm.ExternalCopy(copyObject(data)).copyInto());\n\nexport const buildSandbox = (context: Context) => {\n\tconst { global: jail } = context;\n\tjail.setSync('global', jail.derefInto());\n\tjail.setSync('ivm', ivm);\n\n\tjail.setSync('s', makeTransferable(s));\n\tjail.setSync('console', makeTransferable(console));\n\n\tjail.setSync(\n\t\t'serverFetch',\n\t\tnew ivm.Reference(async (url: string, ...args: any[]) => {\n\t\t\tconst result = await fetch(url, ...args);\n\t\t\treturn makeTransferable(result);\n\t\t}),\n\t);\n};\n"]}}},"code":"!module.wrapAsync(async function (module, __reifyWaitForDeps__, __reify_async_result__) {\n  \"use strict\";\n  try {\n    let _objectSpread;\n    module.link(\"@babel/runtime/helpers/objectSpread2\", {\n      default(v) {\n        _objectSpread = v;\n      }\n    }, 0);\n    module.export({\n      buildSandbox: () => buildSandbox\n    });\n    let EventEmitter;\n    module.link(\"events\", {\n      EventEmitter(v) {\n        EventEmitter = v;\n      }\n    }, 0);\n    let fetch, Response;\n    module.link(\"@rocket.chat/server-fetch\", {\n      serverFetch(v) {\n        fetch = v;\n      },\n      Response(v) {\n        Response = v;\n      }\n    }, 1);\n    let ivm;\n    module.link(\"isolated-vm\", {\n      default(v) {\n        ivm = v;\n      }\n    }, 2);\n    let s;\n    module.link(\"../../../../../lib/utils/stringUtils\", {\n      \"*\"(v) {\n        s = v;\n      }\n    }, 3);\n    if (__reifyWaitForDeps__()) (await __reifyWaitForDeps__())();\n    const proxyObject = function (obj) {\n      let forbiddenKeys = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : [];\n      return copyObject({\n        isProxy: true,\n        get: key => {\n          if (forbiddenKeys.includes(key)) {\n            return undefined;\n          }\n          const value = obj[key];\n          if (typeof value === 'function') {\n            return new ivm.Reference(async function () {\n              const result = obj[key](...arguments);\n              if (result && result instanceof Promise) {\n                return new Promise(async (resolve, reject) => {\n                  try {\n                    const awaitedResult = await result;\n                    resolve(makeTransferable(awaitedResult));\n                  } catch (e) {\n                    reject(e);\n                  }\n                });\n              }\n              return makeTransferable(result);\n            });\n          }\n          return makeTransferable(value);\n        }\n      });\n    };\n    const copyObject = obj => {\n      if (Array.isArray(obj)) {\n        return obj.map(data => copyData(data));\n      }\n      if (obj instanceof Response) {\n        return proxyObject(obj, ['clone']);\n      }\n      if (isSemiTransferable(obj)) {\n        return obj;\n      }\n      if (typeof obj[Symbol.iterator] === 'function') {\n        return copyObject(Array.from(obj));\n      }\n      if (obj instanceof EventEmitter) {\n        return {};\n      }\n      const keys = Object.keys(obj);\n      return _objectSpread({}, Object.fromEntries(keys.map(key => {\n        const data = obj[key];\n        if (typeof data === 'function') {\n          return [key, new ivm.Callback(function () {\n            return obj[key](...arguments);\n          })];\n        }\n        return [key, copyData(data)];\n      })));\n    };\n    // Transferable data can be passed to isolates directly\n    const isTransferable = data => {\n      const dataType = typeof data;\n      if (data === ivm) {\n        return true;\n      }\n      if (['null', 'undefined', 'string', 'number', 'boolean', 'function'].includes(dataType)) {\n        return true;\n      }\n      if (dataType !== 'object') {\n        return false;\n      }\n      return data instanceof ivm.Isolate || data instanceof ivm.Context || data instanceof ivm.Script || data instanceof ivm.ExternalCopy || data instanceof ivm.Callback || data instanceof ivm.Reference;\n    };\n    // Semi-transferable data can be copied with an ivm.ExternalCopy without needing any manipulation.\n    const isSemiTransferable = data => data instanceof ArrayBuffer;\n    const copyData = data => isTransferable(data) ? data : copyObject(data);\n    const makeTransferable = data => isTransferable(data) ? data : new ivm.ExternalCopy(copyObject(data)).copyInto();\n    const buildSandbox = context => {\n      const {\n        global: jail\n      } = context;\n      jail.setSync('global', jail.derefInto());\n      jail.setSync('ivm', ivm);\n      jail.setSync('s', makeTransferable(s));\n      jail.setSync('console', makeTransferable(console));\n      jail.setSync('serverFetch', new ivm.Reference(async function (url) {\n        for (var _len = arguments.length, args = new Array(_len > 1 ? _len - 1 : 0), _key = 1; _key < _len; _key++) {\n          args[_key - 1] = arguments[_key];\n        }\n        const result = await fetch(url, ...args);\n        return makeTransferable(result);\n      }));\n    };\n    __reify_async_result__();\n  } catch (_reifyError) {\n    return __reify_async_result__(_reifyError);\n  }\n  __reify_async_result__()\n}, {\n  self: this,\n  async: false\n});","map":{"version":3,"names":["_objectSpread","module","link","default","v","export","buildSandbox","EventEmitter","fetch","Response","serverFetch","ivm","s","*","__reifyWaitForDeps__","proxyObject","obj","forbiddenKeys","arguments","length","undefined","copyObject","isProxy","get","key","includes","value","Reference","result","Promise","resolve","reject","awaitedResult","makeTransferable","e","Array","isArray","map","data","copyData","isSemiTransferable","Symbol","iterator","from","keys","Object","fromEntries","Callback","isTransferable","dataType","Isolate","Context","Script","ExternalCopy","ArrayBuffer","copyInto","context","global","jail","setSync","derefInto","console","url","_len","args","_key","__reify_async_result__","_reifyError","self","async"],"sources":["app/integrations/server/lib/isolated-vm/buildSandbox.ts"],"sourcesContent":["import { EventEmitter } from 'events';\n\nimport { serverFetch as fetch, Response } from '@rocket.chat/server-fetch';\nimport ivm, { type Context } from 'isolated-vm';\n\nimport * as s from '../../../../../lib/utils/stringUtils';\n\nconst proxyObject = (obj: Record<string, any>, forbiddenKeys: string[] = []): Record<string, any> => {\n\treturn copyObject({\n\t\tisProxy: true,\n\t\tget: (key: string) => {\n\t\t\tif (forbiddenKeys.includes(key)) {\n\t\t\t\treturn undefined;\n\t\t\t}\n\n\t\t\tconst value = obj[key];\n\n\t\t\tif (typeof value === 'function') {\n\t\t\t\treturn new ivm.Reference(async (...args: any[]) => {\n\t\t\t\t\tconst result = (obj[key] as any)(...args);\n\n\t\t\t\t\tif (result && result instanceof Promise) {\n\t\t\t\t\t\treturn new Promise(async (resolve, reject) => {\n\t\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\t\tconst awaitedResult = await result;\n\t\t\t\t\t\t\t\tresolve(makeTransferable(awaitedResult));\n\t\t\t\t\t\t\t} catch (e) {\n\t\t\t\t\t\t\t\treject(e);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\n\t\t\t\t\treturn makeTransferable(result);\n\t\t\t\t});\n\t\t\t}\n\n\t\t\treturn makeTransferable(value);\n\t\t},\n\t});\n};\n\nconst copyObject = (obj: Record<string, any> | any[]): Record<string, any> | any[] => {\n\tif (Array.isArray(obj)) {\n\t\treturn obj.map((data) => copyData(data));\n\t}\n\n\tif (obj instanceof Response) {\n\t\treturn proxyObject(obj, ['clone']);\n\t}\n\n\tif (isSemiTransferable(obj)) {\n\t\treturn obj;\n\t}\n\n\tif (typeof obj[Symbol.iterator as any] === 'function') {\n\t\treturn copyObject(Array.from(obj as any));\n\t}\n\n\tif (obj instanceof EventEmitter) {\n\t\treturn {};\n\t}\n\n\tconst keys = Object.keys(obj);\n\n\treturn {\n\t\t...Object.fromEntries(\n\t\t\tkeys.map((key) => {\n\t\t\t\tconst data = obj[key];\n\n\t\t\t\tif (typeof data === 'function') {\n\t\t\t\t\treturn [key, new ivm.Callback((...args: any[]) => obj[key](...args))];\n\t\t\t\t}\n\n\t\t\t\treturn [key, copyData(data)];\n\t\t\t}),\n\t\t),\n\t};\n};\n\n// Transferable data can be passed to isolates directly\nconst isTransferable = (data: any): data is ivm.Transferable => {\n\tconst dataType = typeof data;\n\n\tif (data === ivm) {\n\t\treturn true;\n\t}\n\n\tif (['null', 'undefined', 'string', 'number', 'boolean', 'function'].includes(dataType)) {\n\t\treturn true;\n\t}\n\n\tif (dataType !== 'object') {\n\t\treturn false;\n\t}\n\n\treturn (\n\t\tdata instanceof ivm.Isolate ||\n\t\tdata instanceof ivm.Context ||\n\t\tdata instanceof ivm.Script ||\n\t\tdata instanceof ivm.ExternalCopy ||\n\t\tdata instanceof ivm.Callback ||\n\t\tdata instanceof ivm.Reference\n\t);\n};\n\n// Semi-transferable data can be copied with an ivm.ExternalCopy without needing any manipulation.\nconst isSemiTransferable = (data: any) => data instanceof ArrayBuffer;\n\nconst copyData = <T extends ivm.Transferable | Record<string, any> | any[]>(data: T) => (isTransferable(data) ? data : copyObject(data));\nconst makeTransferable = (data: any) => (isTransferable(data) ? data : new ivm.ExternalCopy(copyObject(data)).copyInto());\n\nexport const buildSandbox = (context: Context) => {\n\tconst { global: jail } = context;\n\tjail.setSync('global', jail.derefInto());\n\tjail.setSync('ivm', ivm);\n\n\tjail.setSync('s', makeTransferable(s));\n\tjail.setSync('console', makeTransferable(console));\n\n\tjail.setSync(\n\t\t'serverFetch',\n\t\tnew ivm.Reference(async (url: string, ...args: any[]) => {\n\t\t\tconst result = await fetch(url, ...args);\n\t\t\treturn makeTransferable(result);\n\t\t}),\n\t);\n};\n"],"mappings":"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","ignoreList":[]},"sourceType":"module","externalDependencies":{},"hash":"b483c9020a7cb1b093328364c5736c1a0b36653a"}
