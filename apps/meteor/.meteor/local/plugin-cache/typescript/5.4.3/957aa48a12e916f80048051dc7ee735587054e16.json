{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/ee/app/livechat-enterprise/server/methods/getUnitsFromUserRoles.ts","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","topLevelAwait","objectRestSpread","objectRestSpread","asyncGenerators","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"os.osx.arm64"},"sourceFileName":"ee/app/livechat-enterprise/server/methods/getUnitsFromUserRoles.ts","filename":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/ee/app/livechat-enterprise/server/methods/getUnitsFromUserRoles.ts","inputSourceMap":{"version":3,"file":"ee/app/livechat-enterprise/server/methods/getUnitsFromUserRoles.ts","sourceRoot":"","sources":["ee/app/livechat-enterprise/server/methods/getUnitsFromUserRoles.ts"],"names":[],"mappings":"AACA,OAAO,EAAE,YAAY,EAAE,wBAAwB,EAAE,MAAM,qBAAqB,CAAC;AAC7E,OAAO,GAAG,MAAM,KAAK,CAAC;AACtB,OAAO,EAAE,MAAM,EAAE,MAAM,eAAe,CAAC;AAEvC,OAAO,EAAE,eAAe,EAAE,MAAM,2DAA2D,CAAC;AAC5F,OAAO,EAAE,MAAM,EAAE,MAAM,eAAe,CAAC;AAEvC,KAAK,UAAU,qBAAqB,CAAC,IAAY;IAChD,OAAO,YAAY,CAAC,eAAe,CAAC,IAAI,CAAC,CAAC;AAC3C,CAAC;AAED,KAAK,UAAU,2BAA2B,CAAC,IAAY;IACtD,OAAO,CAAC,MAAM,wBAAwB,CAAC,aAAa,CAAC,IAAI,CAAC,CAAC,OAAO,EAAE,CAAC,CAAC,GAAG,CAAC,CAAC,UAAU,EAAE,EAAE,CAAC,UAAU,CAAC,YAAY,CAAC,CAAC;AACpH,CAAC;AAED,MAAM,4BAA4B,GAAG,GAAG,CAAC,qBAAqB,EAAE,EAAE,MAAM,EAAE,OAAO,CAAC,GAAG,CAAC,SAAS,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,KAAK,EAAE,CAAC,CAAC;AAC/G,MAAM,mCAAmC,GAAG,GAAG,CAAC,2BAA2B,EAAE,EAAE,MAAM,EAAE,OAAO,CAAC,GAAG,CAAC,SAAS,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,KAAK,EAAE,CAAC,CAAC;AAE5H,MAAM,CAAC,MAAM,gBAAgB,GAAG,KAAK,EAAE,IAAY,EAAiC,EAAE;IACrF,IAAI,CAAC,IAAI,IAAI,CAAC,MAAM,eAAe,CAAC,IAAI,EAAE,CAAC,OAAO,EAAE,kBAAkB,CAAC,CAAC,CAAC,EAAE,CAAC;QAC3E,OAAO;IACR,CAAC;IAED,IAAI,CAAC,CAAC,MAAM,eAAe,CAAC,IAAI,EAAE,CAAC,kBAAkB,CAAC,CAAC,CAAC,EAAE,CAAC;QAC1D,OAAO;IACR,CAAC;IAED,MAAM,mBAAmB,GAAG,CAAC,GAAG,CAAC,MAAM,4BAA4B,CAAC,IAAI,CAAC,CAAC,EAAE,GAAG,CAAC,MAAM,mCAAmC,CAAC,IAAI,CAAC,CAAC,CAAC,CAAC;IAClI,MAAM,CAAC,KAAK,CAAC,EAAE,GAAG,EAAE,+BAA+B,EAAE,IAAI,EAAE,mBAAmB,EAAE,CAAC,CAAC;IAElF,OAAO,mBAAmB,CAAC;AAC5B,CAAC,CAAC;AASF,MAAM,CAAC,OAAO,CAAgB;IAC7B,KAAK,CAAC,2BAA2B;QAChC,MAAM,IAAI,GAAG,MAAM,CAAC,MAAM,EAAE,CAAC;QAC7B,IAAI,CAAC,IAAI,EAAE,CAAC;YACX,OAAO;QACR,CAAC;QACD,OAAO,gBAAgB,CAAC,IAAI,CAAC,CAAC;IAC/B,CAAC;CACD,CAAC,CAAC","sourcesContent":["import type { ServerMethods } from '@rocket.chat/ddp-client';\nimport { LivechatUnit, LivechatDepartmentAgents } from '@rocket.chat/models';\nimport mem from 'mem';\nimport { Meteor } from 'meteor/meteor';\n\nimport { hasAnyRoleAsync } from '../../../../../app/authorization/server/functions/hasRole';\nimport { logger } from '../lib/logger';\n\nasync function getUnitsFromUserRoles(user: string): Promise<string[]> {\n\treturn LivechatUnit.findByMonitorId(user);\n}\n\nasync function getDepartmentsFromUserRoles(user: string): Promise<string[]> {\n\treturn (await LivechatDepartmentAgents.findByAgentId(user).toArray()).map((department) => department.departmentId);\n}\n\nconst memoizedGetUnitFromUserRoles = mem(getUnitsFromUserRoles, { maxAge: process.env.TEST_MODE ? 1 : 10000 });\nconst memoizedGetDepartmentsFromUserRoles = mem(getDepartmentsFromUserRoles, { maxAge: process.env.TEST_MODE ? 1 : 10000 });\n\nexport const getUnitsFromUser = async (user: string): Promise<string[] | undefined> => {\n\tif (!user || (await hasAnyRoleAsync(user, ['admin', 'livechat-manager']))) {\n\t\treturn;\n\t}\n\n\tif (!(await hasAnyRoleAsync(user, ['livechat-monitor']))) {\n\t\treturn;\n\t}\n\n\tconst unitsAndDepartments = [...(await memoizedGetUnitFromUserRoles(user)), ...(await memoizedGetDepartmentsFromUserRoles(user))];\n\tlogger.debug({ msg: 'Calculating units for monitor', user, unitsAndDepartments });\n\n\treturn unitsAndDepartments;\n};\n\ndeclare module '@rocket.chat/ddp-client' {\n\t// eslint-disable-next-line @typescript-eslint/naming-convention\n\tinterface ServerMethods {\n\t\t'livechat:getUnitsFromUser'(): Promise<string[] | undefined>;\n\t}\n}\n\nMeteor.methods<ServerMethods>({\n\tasync 'livechat:getUnitsFromUser'(): Promise<string[] | undefined> {\n\t\tconst user = Meteor.userId();\n\t\tif (!user) {\n\t\t\treturn;\n\t\t}\n\t\treturn getUnitsFromUser(user);\n\t},\n});\n"]},"targets":{"android":"125.0.0","chrome":"125.0.0","edge":"125.0.0","firefox":"115.0.0","ie":"10.0.0","ios":"17.4.0","opera":"110.0.0","opera_mobile":"80.0.0","safari":"17.4.0","samsung":"24.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor","root":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":false,"enforceStrictMode":false,"dynamicImport":true,"generateLetDeclarations":true,"topLevelAwait":true},"externalDependencies":[]},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"version":"7.17.2","helpers":true,"useESModules":false,"corejs":false},"externalDependencies":[]},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-async-generator-functions","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-class-properties","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true},"externalDependencies":[]},{"key":"transform-react-jsx","visitor":{"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXFragment":{"exit":[null]},"JSXElement":{"exit":[null]},"JSXAttribute":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false},"externalDependencies":[]},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-nullish-coalescing-operator","visitor":{"LogicalExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-optional-chaining","visitor":{"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-optional-catch-binding","visitor":{"CatchClause":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-class-properties","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-async-generator-functions","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-logical-assignment-operators","visitor":{"AssignmentExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]}],"presets":[],"generatorOpts":{"filename":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/ee/app/livechat-enterprise/server/methods/getUnitsFromUserRoles.ts","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"ee/app/livechat-enterprise/server/methods/getUnitsFromUserRoles.ts","inputSourceMap":{"version":3,"file":"ee/app/livechat-enterprise/server/methods/getUnitsFromUserRoles.ts","sourceRoot":"","sources":["ee/app/livechat-enterprise/server/methods/getUnitsFromUserRoles.ts"],"names":[],"mappings":"AACA,OAAO,EAAE,YAAY,EAAE,wBAAwB,EAAE,MAAM,qBAAqB,CAAC;AAC7E,OAAO,GAAG,MAAM,KAAK,CAAC;AACtB,OAAO,EAAE,MAAM,EAAE,MAAM,eAAe,CAAC;AAEvC,OAAO,EAAE,eAAe,EAAE,MAAM,2DAA2D,CAAC;AAC5F,OAAO,EAAE,MAAM,EAAE,MAAM,eAAe,CAAC;AAEvC,KAAK,UAAU,qBAAqB,CAAC,IAAY;IAChD,OAAO,YAAY,CAAC,eAAe,CAAC,IAAI,CAAC,CAAC;AAC3C,CAAC;AAED,KAAK,UAAU,2BAA2B,CAAC,IAAY;IACtD,OAAO,CAAC,MAAM,wBAAwB,CAAC,aAAa,CAAC,IAAI,CAAC,CAAC,OAAO,EAAE,CAAC,CAAC,GAAG,CAAC,CAAC,UAAU,EAAE,EAAE,CAAC,UAAU,CAAC,YAAY,CAAC,CAAC;AACpH,CAAC;AAED,MAAM,4BAA4B,GAAG,GAAG,CAAC,qBAAqB,EAAE,EAAE,MAAM,EAAE,OAAO,CAAC,GAAG,CAAC,SAAS,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,KAAK,EAAE,CAAC,CAAC;AAC/G,MAAM,mCAAmC,GAAG,GAAG,CAAC,2BAA2B,EAAE,EAAE,MAAM,EAAE,OAAO,CAAC,GAAG,CAAC,SAAS,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,KAAK,EAAE,CAAC,CAAC;AAE5H,MAAM,CAAC,MAAM,gBAAgB,GAAG,KAAK,EAAE,IAAY,EAAiC,EAAE;IACrF,IAAI,CAAC,IAAI,IAAI,CAAC,MAAM,eAAe,CAAC,IAAI,EAAE,CAAC,OAAO,EAAE,kBAAkB,CAAC,CAAC,CAAC,EAAE,CAAC;QAC3E,OAAO;IACR,CAAC;IAED,IAAI,CAAC,CAAC,MAAM,eAAe,CAAC,IAAI,EAAE,CAAC,kBAAkB,CAAC,CAAC,CAAC,EAAE,CAAC;QAC1D,OAAO;IACR,CAAC;IAED,MAAM,mBAAmB,GAAG,CAAC,GAAG,CAAC,MAAM,4BAA4B,CAAC,IAAI,CAAC,CAAC,EAAE,GAAG,CAAC,MAAM,mCAAmC,CAAC,IAAI,CAAC,CAAC,CAAC,CAAC;IAClI,MAAM,CAAC,KAAK,CAAC,EAAE,GAAG,EAAE,+BAA+B,EAAE,IAAI,EAAE,mBAAmB,EAAE,CAAC,CAAC;IAElF,OAAO,mBAAmB,CAAC;AAC5B,CAAC,CAAC;AASF,MAAM,CAAC,OAAO,CAAgB;IAC7B,KAAK,CAAC,2BAA2B;QAChC,MAAM,IAAI,GAAG,MAAM,CAAC,MAAM,EAAE,CAAC;QAC7B,IAAI,CAAC,IAAI,EAAE,CAAC;YACX,OAAO;QACR,CAAC;QACD,OAAO,gBAAgB,CAAC,IAAI,CAAC,CAAC;IAC/B,CAAC;CACD,CAAC,CAAC","sourcesContent":["import type { ServerMethods } from '@rocket.chat/ddp-client';\nimport { LivechatUnit, LivechatDepartmentAgents } from '@rocket.chat/models';\nimport mem from 'mem';\nimport { Meteor } from 'meteor/meteor';\n\nimport { hasAnyRoleAsync } from '../../../../../app/authorization/server/functions/hasRole';\nimport { logger } from '../lib/logger';\n\nasync function getUnitsFromUserRoles(user: string): Promise<string[]> {\n\treturn LivechatUnit.findByMonitorId(user);\n}\n\nasync function getDepartmentsFromUserRoles(user: string): Promise<string[]> {\n\treturn (await LivechatDepartmentAgents.findByAgentId(user).toArray()).map((department) => department.departmentId);\n}\n\nconst memoizedGetUnitFromUserRoles = mem(getUnitsFromUserRoles, { maxAge: process.env.TEST_MODE ? 1 : 10000 });\nconst memoizedGetDepartmentsFromUserRoles = mem(getDepartmentsFromUserRoles, { maxAge: process.env.TEST_MODE ? 1 : 10000 });\n\nexport const getUnitsFromUser = async (user: string): Promise<string[] | undefined> => {\n\tif (!user || (await hasAnyRoleAsync(user, ['admin', 'livechat-manager']))) {\n\t\treturn;\n\t}\n\n\tif (!(await hasAnyRoleAsync(user, ['livechat-monitor']))) {\n\t\treturn;\n\t}\n\n\tconst unitsAndDepartments = [...(await memoizedGetUnitFromUserRoles(user)), ...(await memoizedGetDepartmentsFromUserRoles(user))];\n\tlogger.debug({ msg: 'Calculating units for monitor', user, unitsAndDepartments });\n\n\treturn unitsAndDepartments;\n};\n\ndeclare module '@rocket.chat/ddp-client' {\n\t// eslint-disable-next-line @typescript-eslint/naming-convention\n\tinterface ServerMethods {\n\t\t'livechat:getUnitsFromUser'(): Promise<string[] | undefined>;\n\t}\n}\n\nMeteor.methods<ServerMethods>({\n\tasync 'livechat:getUnitsFromUser'(): Promise<string[] | undefined> {\n\t\tconst user = Meteor.userId();\n\t\tif (!user) {\n\t\t\treturn;\n\t\t}\n\t\treturn getUnitsFromUser(user);\n\t},\n});\n"]}}},"code":"!module.wrapAsync(async function (module, __reifyWaitForDeps__, __reify_async_result__) {\n  \"use strict\";\n  try {\n    module.export({\n      getUnitsFromUser: () => getUnitsFromUser\n    });\n    let LivechatUnit, LivechatDepartmentAgents;\n    module.link(\"@rocket.chat/models\", {\n      LivechatUnit(v) {\n        LivechatUnit = v;\n      },\n      LivechatDepartmentAgents(v) {\n        LivechatDepartmentAgents = v;\n      }\n    }, 0);\n    let mem;\n    module.link(\"mem\", {\n      default(v) {\n        mem = v;\n      }\n    }, 1);\n    let Meteor;\n    module.link(\"meteor/meteor\", {\n      Meteor(v) {\n        Meteor = v;\n      }\n    }, 2);\n    let hasAnyRoleAsync;\n    module.link(\"../../../../../app/authorization/server/functions/hasRole\", {\n      hasAnyRoleAsync(v) {\n        hasAnyRoleAsync = v;\n      }\n    }, 3);\n    let logger;\n    module.link(\"../lib/logger\", {\n      logger(v) {\n        logger = v;\n      }\n    }, 4);\n    if (__reifyWaitForDeps__()) (await __reifyWaitForDeps__())();\n    async function getUnitsFromUserRoles(user) {\n      return LivechatUnit.findByMonitorId(user);\n    }\n    async function getDepartmentsFromUserRoles(user) {\n      return (await LivechatDepartmentAgents.findByAgentId(user).toArray()).map(department => department.departmentId);\n    }\n    const memoizedGetUnitFromUserRoles = mem(getUnitsFromUserRoles, {\n      maxAge: process.env.TEST_MODE ? 1 : 10000\n    });\n    const memoizedGetDepartmentsFromUserRoles = mem(getDepartmentsFromUserRoles, {\n      maxAge: process.env.TEST_MODE ? 1 : 10000\n    });\n    const getUnitsFromUser = async user => {\n      if (!user || (await hasAnyRoleAsync(user, ['admin', 'livechat-manager']))) {\n        return;\n      }\n      if (!(await hasAnyRoleAsync(user, ['livechat-monitor']))) {\n        return;\n      }\n      const unitsAndDepartments = [...(await memoizedGetUnitFromUserRoles(user)), ...(await memoizedGetDepartmentsFromUserRoles(user))];\n      logger.debug({\n        msg: 'Calculating units for monitor',\n        user,\n        unitsAndDepartments\n      });\n      return unitsAndDepartments;\n    };\n    Meteor.methods({\n      async 'livechat:getUnitsFromUser'() {\n        const user = Meteor.userId();\n        if (!user) {\n          return;\n        }\n        return getUnitsFromUser(user);\n      }\n    });\n    __reify_async_result__();\n  } catch (_reifyError) {\n    return __reify_async_result__(_reifyError);\n  }\n  __reify_async_result__()\n}, {\n  self: this,\n  async: false\n});","map":{"version":3,"names":["module","export","getUnitsFromUser","LivechatUnit","LivechatDepartmentAgents","link","v","mem","default","Meteor","hasAnyRoleAsync","logger","__reifyWaitForDeps__","getUnitsFromUserRoles","user","findByMonitorId","getDepartmentsFromUserRoles","findByAgentId","toArray","map","department","departmentId","memoizedGetUnitFromUserRoles","maxAge","process","env","TEST_MODE","memoizedGetDepartmentsFromUserRoles","unitsAndDepartments","debug","msg","methods","livechat:getUnitsFromUser","userId","__reify_async_result__","_reifyError","self","async"],"sources":["ee/app/livechat-enterprise/server/methods/getUnitsFromUserRoles.ts"],"sourcesContent":["import type { ServerMethods } from '@rocket.chat/ddp-client';\nimport { LivechatUnit, LivechatDepartmentAgents } from '@rocket.chat/models';\nimport mem from 'mem';\nimport { Meteor } from 'meteor/meteor';\n\nimport { hasAnyRoleAsync } from '../../../../../app/authorization/server/functions/hasRole';\nimport { logger } from '../lib/logger';\n\nasync function getUnitsFromUserRoles(user: string): Promise<string[]> {\n\treturn LivechatUnit.findByMonitorId(user);\n}\n\nasync function getDepartmentsFromUserRoles(user: string): Promise<string[]> {\n\treturn (await LivechatDepartmentAgents.findByAgentId(user).toArray()).map((department) => department.departmentId);\n}\n\nconst memoizedGetUnitFromUserRoles = mem(getUnitsFromUserRoles, { maxAge: process.env.TEST_MODE ? 1 : 10000 });\nconst memoizedGetDepartmentsFromUserRoles = mem(getDepartmentsFromUserRoles, { maxAge: process.env.TEST_MODE ? 1 : 10000 });\n\nexport const getUnitsFromUser = async (user: string): Promise<string[] | undefined> => {\n\tif (!user || (await hasAnyRoleAsync(user, ['admin', 'livechat-manager']))) {\n\t\treturn;\n\t}\n\n\tif (!(await hasAnyRoleAsync(user, ['livechat-monitor']))) {\n\t\treturn;\n\t}\n\n\tconst unitsAndDepartments = [...(await memoizedGetUnitFromUserRoles(user)), ...(await memoizedGetDepartmentsFromUserRoles(user))];\n\tlogger.debug({ msg: 'Calculating units for monitor', user, unitsAndDepartments });\n\n\treturn unitsAndDepartments;\n};\n\ndeclare module '@rocket.chat/ddp-client' {\n\t// eslint-disable-next-line @typescript-eslint/naming-convention\n\tinterface ServerMethods {\n\t\t'livechat:getUnitsFromUser'(): Promise<string[] | undefined>;\n\t}\n}\n\nMeteor.methods<ServerMethods>({\n\tasync 'livechat:getUnitsFromUser'(): Promise<string[] | undefined> {\n\t\tconst user = Meteor.userId();\n\t\tif (!user) {\n\t\t\treturn;\n\t\t}\n\t\treturn getUnitsFromUser(user);\n\t},\n});\n"],"mappings":";;;IACAA,MAAA,CAAOC,MAAE;MAAAC,gBAAc,EAAAA,CAAA,KAAAA;IAA0B;IAAM,IAAAC,YAAA,EAAAC,wBAAsB;IAAAJ,MAAA,CAAAK,IAAA;MAAAF,aAAAG,CAAA;QAAAH,YAAA,GAAAG,CAAA;MAAA;MAAAF,yBAAAE,CAAA;QAAAF,wBAAA,GAAAE,CAAA;MAAA;IAAA;IAAA,IAAAC,GAAA;IAAAP,MAAA,CAAAK,IAAA;MAAAG,QAAAF,CAAA;QAAAC,GAAA,GAAAD,CAAA;MAAA;IAAA;IAAA,IAAAG,MAAA;IAAAT,MAAA,CAAAK,IAAA;MAAAI,OAAAH,CAAA;QAAAG,MAAA,GAAAH,CAAA;MAAA;IAAA;IAAA,IAAAI,eAAA;IAAAV,MAAA,CAAAK,IAAA;MAAAK,gBAAAJ,CAAA;QAAAI,eAAA,GAAAJ,CAAA;MAAA;IAAA;IAAA,IAAAK,MAAA;IAAAX,MAAA,CAAAK,IAAA;MAAAM,OAAAL,CAAA;QAAAK,MAAA,GAAAL,CAAA;MAAA;IAAA;IAAA,IAAAM,oBAAA,WAAAA,oBAAA;IAO7E,eAAeC,qBAAqBA,CAACC,IAAY;MAChD,OAAOX,YAAY,CAACY,eAAe,CAACD,IAAI,CAAC;IAC1C;IAEA,eAAeE,2BAA2BA,CAACF,IAAY;MACtD,OAAO,CAAC,MAAMV,wBAAwB,CAACa,aAAa,CAACH,IAAI,CAAC,CAACI,OAAO,EAAE,EAAEC,GAAG,CAAEC,UAAU,IAAKA,UAAU,CAACC,YAAY,CAAC;IACnH;IAEA,MAAMC,4BAA4B,GAAGf,GAAG,CAACM,qBAAqB,EAAE;MAAEU,MAAM,EAAEC,OAAO,CAACC,GAAG,CAACC,SAAS,GAAG,CAAC,GAAG;IAAK,CAAE,CAAC;IAC9G,MAAMC,mCAAmC,GAAGpB,GAAG,CAACS,2BAA2B,EAAE;MAAEO,MAAM,EAAEC,OAAO,CAACC,GAAG,CAACC,SAAS,GAAG,CAAC,GAAG;IAAK,CAAE,CAAC;IAEpH,MAAMxB,gBAAgB,GAAG,MAAOY,IAAY,IAAmC;MACrF,IAAI,CAACA,IAAI,KAAK,MAAMJ,eAAe,CAACI,IAAI,EAAE,CAAC,OAAO,EAAE,kBAAkB,CAAC,CAAC,CAAC,EAAE;QAC1E;MACD;MAEA,IAAI,EAAE,MAAMJ,eAAe,CAACI,IAAI,EAAE,CAAC,kBAAkB,CAAC,CAAC,CAAC,EAAE;QACzD;MACD;MAEA,MAAMc,mBAAmB,GAAG,CAAC,IAAI,MAAMN,4BAA4B,CAACR,IAAI,CAAC,CAAC,EAAE,IAAI,MAAMa,mCAAmC,CAACb,IAAI,CAAC,CAAC,CAAC;MACjIH,MAAM,CAACkB,KAAK,CAAC;QAAEC,GAAG,EAAE,+BAA+B;QAAEhB,IAAI;QAAEc;MAAmB,CAAE,CAAC;MAEjF,OAAOA,mBAAmB;IAC3B,CAAC;IASDnB,MAAM,CAACsB,OAAO,CAAgB;MAC7B,MAAM,2BAA2BC,CAAA;QAChC,MAAMlB,IAAI,GAAGL,MAAM,CAACwB,MAAM,EAAE;QAC5B,IAAI,CAACnB,IAAI,EAAE;UACV;QACD;QACA,OAAOZ,gBAAgB,CAACY,IAAI,CAAC;MAC9B;KACA,CAAC;IAACoB,sBAAA;EAAA,SAAAC,WAAA;IAAA,OAAAD,sBAAA,CAAAC,WAAA;EAAA;EAAAD,sBAAA;AAAA;EAAAE,IAAA;EAAAC,KAAA;AAAA","ignoreList":[]},"sourceType":"module","externalDependencies":{},"hash":"957aa48a12e916f80048051dc7ee735587054e16"}
