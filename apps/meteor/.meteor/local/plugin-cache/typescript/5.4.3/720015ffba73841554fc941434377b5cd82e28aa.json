{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/app/utils/client/lib/SDKClient.ts","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","topLevelAwait","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"web.browser"},"sourceFileName":"app/utils/client/lib/SDKClient.ts","filename":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/app/utils/client/lib/SDKClient.ts","inputSourceMap":{"version":3,"file":"app/utils/client/lib/SDKClient.ts","sourceRoot":"","sources":["app/utils/client/lib/SDKClient.ts"],"names":[],"mappings":"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","sourcesContent":["import type { RestClientInterface } from '@rocket.chat/api-client';\nimport type { SDK, ClientStream, StreamKeys, StreamNames, StreamerCallbackArgs, ServerMethods } from '@rocket.chat/ddp-client';\nimport { Emitter } from '@rocket.chat/emitter';\nimport { Accounts } from 'meteor/accounts-base';\nimport { DDPCommon } from 'meteor/ddp-common';\nimport { Meteor } from 'meteor/meteor';\n\nimport { APIClient } from './RestApiClient';\n\ndeclare module '@rocket.chat/ddp-client' {\n\t// eslint-disable-next-line @typescript-eslint/naming-convention\n\tinterface SDK {\n\t\tstream<N extends StreamNames, K extends StreamKeys<N>>(\n\t\t\tstreamName: N,\n\t\t\targs: [key: K, ...args: unknown[]],\n\t\t\tcallback: (...args: StreamerCallbackArgs<N, K>) => void,\n\t\t): ReturnType<ClientStream['subscribe']>;\n\t\tcall<T extends keyof ServerMethods>(method: T, ...args: Parameters<ServerMethods[T]>): Promise<ReturnType<ServerMethods[T]>>;\n\t}\n}\n\nconst isChangedCollectionPayload = (\n\tmsg: any,\n): msg is { msg: 'changed'; collection: string; fields: { eventName: string; args: unknown[] } } => {\n\tif (typeof msg !== 'object' && (msg !== null || msg !== undefined)) {\n\t\treturn false;\n\t}\n\tif (msg.msg !== 'changed') {\n\t\treturn false;\n\t}\n\tif (typeof msg.collection !== 'string') {\n\t\treturn false;\n\t}\n\tif (typeof msg.fields !== 'object' && (msg.fields !== null || msg.fields !== undefined)) {\n\t\treturn false;\n\t}\n\tif (typeof msg.fields.eventName !== 'string') {\n\t\treturn false;\n\t}\n\tif (!Array.isArray(msg.fields.args)) {\n\t\treturn false;\n\t}\n\treturn true;\n};\n\ntype EventMap<N extends StreamNames = StreamNames, K extends StreamKeys<N> = StreamKeys<N>> = {\n\t[key in `stream-${N}/${K}`]: StreamerCallbackArgs<N, K>;\n};\n\ntype StreamMapValue = {\n\tstop: () => void;\n\terror: (cb: (...args: any[]) => void) => void;\n\tonChange: ReturnType<ClientStream['subscribe']>['onChange'];\n\tready: () => Promise<void>;\n\tisReady: boolean;\n\tunsubList: Set<() => void>;\n};\n\nconst createNewMeteorStream = (streamName: StreamNames, key: StreamKeys<StreamNames>, args: unknown[]): StreamMapValue => {\n\tconst ee = new Emitter();\n\tconst meta = {\n\t\tready: false,\n\t};\n\n\tconst sub = Meteor.connection.subscribe(\n\t\t`stream-${streamName}`,\n\t\tkey,\n\t\t{ useCollection: false, args },\n\t\t{\n\t\t\tonReady: (args: any) => {\n\t\t\t\tmeta.ready = true;\n\t\t\t\tee.emit('ready', [undefined, args]);\n\t\t\t},\n\t\t\tonError: (err: any) => {\n\t\t\t\tee.emit('ready', [err]);\n\t\t\t\tee.emit('error', err);\n\t\t\t},\n\t\t},\n\t);\n\n\tconst onChange: ReturnType<ClientStream['subscribe']>['onChange'] = (cb) => {\n\t\tif (meta.ready) {\n\t\t\tcb({\n\t\t\t\tmsg: 'ready',\n\n\t\t\t\tsubs: [],\n\t\t\t});\n\t\t\treturn;\n\t\t}\n\t\tee.once('ready', ([error, result]) => {\n\t\t\tif (error) {\n\t\t\t\tcb({\n\t\t\t\t\tmsg: 'nosub',\n\n\t\t\t\t\tid: '',\n\t\t\t\t\terror,\n\t\t\t\t});\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tcb(result);\n\t\t});\n\t};\n\n\tconst ready = () => {\n\t\tif (meta.ready) {\n\t\t\treturn Promise.resolve();\n\t\t}\n\t\treturn new Promise<void>((r) => {\n\t\t\tee.once('ready', r);\n\t\t});\n\t};\n\n\treturn {\n\t\tstop: sub.stop,\n\t\tonChange,\n\t\tready,\n\t\terror: (cb: (...args: any[]) => void) =>\n\t\t\tee.once('error', (error) => {\n\t\t\t\tcb(error);\n\t\t\t}),\n\n\t\tget isReady() {\n\t\t\treturn meta.ready;\n\t\t},\n\t\tunsubList: new Set(),\n\t};\n};\n\nconst createStreamManager = () => {\n\t// Emitter that replicates stream messages to registered callbacks\n\tconst streamProxy = new Emitter<EventMap>();\n\n\t// Collection of unsubscribe callbacks for each stream.\n\t// const proxyUnsubLists = new Map<string, Set<() => void>>();\n\n\tconst streams = new Map<string, StreamMapValue>();\n\n\tAccounts.onLogout(() => {\n\t\tstreams.forEach((stream) => {\n\t\t\tstream.unsubList.forEach((stop) => stop());\n\t\t});\n\t});\n\n\tMeteor.connection._stream.on('message', (rawMsg: string) => {\n\t\tconst msg = DDPCommon.parseDDP(rawMsg);\n\t\tif (!isChangedCollectionPayload(msg)) {\n\t\t\treturn;\n\t\t}\n\t\tstreamProxy.emit(`${msg.collection}/${msg.fields.eventName}` as any, msg.fields.args as any);\n\t});\n\n\tconst stream: SDK['stream'] = <N extends StreamNames, K extends StreamKeys<N>>(\n\t\tname: N,\n\t\tdata: [key: K, ...args: unknown[]],\n\t\tcallback: (...args: StreamerCallbackArgs<N, K>) => void,\n\t\t_options?: {\n\t\t\tretransmit?: boolean | undefined;\n\t\t\tretransmitToSelf?: boolean | undefined;\n\t\t},\n\t): ReturnType<ClientStream['subscribe']> => {\n\t\tconst [key, ...args] = data;\n\t\tconst eventLiteral = `stream-${name}/${key}` as const;\n\n\t\tconst proxyCallback = (args?: unknown): void => {\n\t\t\tif (!args || !Array.isArray(args)) {\n\t\t\t\tthrow new Error('Invalid streamer callback');\n\t\t\t}\n\t\t\tcallback(...(args as StreamerCallbackArgs<N, K>));\n\t\t};\n\n\t\tstreamProxy.on(eventLiteral, proxyCallback);\n\n\t\tconst stop = (): void => {\n\t\t\tstreamProxy.off(eventLiteral, proxyCallback);\n\t\t\t// If someone is still listening, don't unsubscribe\n\t\t\tif (streamProxy.has(eventLiteral)) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tif (stream) {\n\t\t\t\tstream.stop();\n\t\t\t\tstreams.delete(eventLiteral);\n\t\t\t}\n\t\t};\n\n\t\tconst stream = streams.get(eventLiteral) || createNewMeteorStream(name, key, args);\n\n\t\tstream.unsubList.add(stop);\n\t\tif (!streams.has(eventLiteral)) {\n\t\t\tstreams.set(eventLiteral, stream);\n\t\t}\n\n\t\tstream.error(() => {\n\t\t\tstream.unsubList.forEach((stop) => stop());\n\t\t});\n\n\t\treturn {\n\t\t\tid: '',\n\t\t\tname,\n\t\t\tparams: data as any,\n\t\t\tstop,\n\t\t\tready: stream.ready,\n\t\t\tonChange: stream.onChange,\n\t\t\tisReady: stream.isReady,\n\t\t};\n\t};\n\n\tconst stopAll = (streamName: string, key: string) => {\n\t\tconst stream = streams.get(`stream-${streamName}/${key}`);\n\n\t\tif (stream) {\n\t\t\tstream.unsubList.forEach((stop) => stop());\n\t\t}\n\t};\n\n\treturn { stream, stopAll };\n};\n\nexport const createSDK = (rest: RestClientInterface) => {\n\tconst { stream, stopAll } = createStreamManager();\n\n\tconst publish = (name: string, args: unknown[]) => {\n\t\tMeteor.call(`stream-${name}`, ...args);\n\t};\n\n\tconst call = <T extends keyof ServerMethods>(method: T, ...args: Parameters<ServerMethods[T]>): Promise<ReturnType<ServerMethods[T]>> => {\n\t\treturn Meteor.callAsync(method, ...args);\n\t};\n\n\treturn {\n\t\trest,\n\t\tstop: stopAll,\n\t\tstream,\n\t\tpublish,\n\t\tcall,\n\t};\n};\n\nexport const sdk = createSDK(APIClient);\n"]},"targets":{"android":"125.0.0","chrome":"125.0.0","edge":"125.0.0","firefox":"115.0.0","ie":"10.0.0","ios":"17.4.0","opera":"110.0.0","opera_mobile":"80.0.0","safari":"17.4.0","samsung":"24.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor","root":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":false,"enforceStrictMode":false,"dynamicImport":true,"generateLetDeclarations":true},"externalDependencies":[]},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"version":"7.17.2","helpers":true,"useESModules":false,"corejs":false},"externalDependencies":[]},{"key":"proposal-class-properties","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true},"externalDependencies":[]},{"key":"transform-react-jsx","visitor":{"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXFragment":{"exit":[null]},"JSXElement":{"exit":[null]},"JSXAttribute":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false},"externalDependencies":[]},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-nullish-coalescing-operator","visitor":{"LogicalExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-optional-chaining","visitor":{"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-optional-catch-binding","visitor":{"CatchClause":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-class-properties","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-async-generator-functions","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-logical-assignment-operators","visitor":{"AssignmentExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]}],"presets":[],"generatorOpts":{"filename":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/app/utils/client/lib/SDKClient.ts","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"app/utils/client/lib/SDKClient.ts","inputSourceMap":{"version":3,"file":"app/utils/client/lib/SDKClient.ts","sourceRoot":"","sources":["app/utils/client/lib/SDKClient.ts"],"names":[],"mappings":"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","sourcesContent":["import type { RestClientInterface } from '@rocket.chat/api-client';\nimport type { SDK, ClientStream, StreamKeys, StreamNames, StreamerCallbackArgs, ServerMethods } from '@rocket.chat/ddp-client';\nimport { Emitter } from '@rocket.chat/emitter';\nimport { Accounts } from 'meteor/accounts-base';\nimport { DDPCommon } from 'meteor/ddp-common';\nimport { Meteor } from 'meteor/meteor';\n\nimport { APIClient } from './RestApiClient';\n\ndeclare module '@rocket.chat/ddp-client' {\n\t// eslint-disable-next-line @typescript-eslint/naming-convention\n\tinterface SDK {\n\t\tstream<N extends StreamNames, K extends StreamKeys<N>>(\n\t\t\tstreamName: N,\n\t\t\targs: [key: K, ...args: unknown[]],\n\t\t\tcallback: (...args: StreamerCallbackArgs<N, K>) => void,\n\t\t): ReturnType<ClientStream['subscribe']>;\n\t\tcall<T extends keyof ServerMethods>(method: T, ...args: Parameters<ServerMethods[T]>): Promise<ReturnType<ServerMethods[T]>>;\n\t}\n}\n\nconst isChangedCollectionPayload = (\n\tmsg: any,\n): msg is { msg: 'changed'; collection: string; fields: { eventName: string; args: unknown[] } } => {\n\tif (typeof msg !== 'object' && (msg !== null || msg !== undefined)) {\n\t\treturn false;\n\t}\n\tif (msg.msg !== 'changed') {\n\t\treturn false;\n\t}\n\tif (typeof msg.collection !== 'string') {\n\t\treturn false;\n\t}\n\tif (typeof msg.fields !== 'object' && (msg.fields !== null || msg.fields !== undefined)) {\n\t\treturn false;\n\t}\n\tif (typeof msg.fields.eventName !== 'string') {\n\t\treturn false;\n\t}\n\tif (!Array.isArray(msg.fields.args)) {\n\t\treturn false;\n\t}\n\treturn true;\n};\n\ntype EventMap<N extends StreamNames = StreamNames, K extends StreamKeys<N> = StreamKeys<N>> = {\n\t[key in `stream-${N}/${K}`]: StreamerCallbackArgs<N, K>;\n};\n\ntype StreamMapValue = {\n\tstop: () => void;\n\terror: (cb: (...args: any[]) => void) => void;\n\tonChange: ReturnType<ClientStream['subscribe']>['onChange'];\n\tready: () => Promise<void>;\n\tisReady: boolean;\n\tunsubList: Set<() => void>;\n};\n\nconst createNewMeteorStream = (streamName: StreamNames, key: StreamKeys<StreamNames>, args: unknown[]): StreamMapValue => {\n\tconst ee = new Emitter();\n\tconst meta = {\n\t\tready: false,\n\t};\n\n\tconst sub = Meteor.connection.subscribe(\n\t\t`stream-${streamName}`,\n\t\tkey,\n\t\t{ useCollection: false, args },\n\t\t{\n\t\t\tonReady: (args: any) => {\n\t\t\t\tmeta.ready = true;\n\t\t\t\tee.emit('ready', [undefined, args]);\n\t\t\t},\n\t\t\tonError: (err: any) => {\n\t\t\t\tee.emit('ready', [err]);\n\t\t\t\tee.emit('error', err);\n\t\t\t},\n\t\t},\n\t);\n\n\tconst onChange: ReturnType<ClientStream['subscribe']>['onChange'] = (cb) => {\n\t\tif (meta.ready) {\n\t\t\tcb({\n\t\t\t\tmsg: 'ready',\n\n\t\t\t\tsubs: [],\n\t\t\t});\n\t\t\treturn;\n\t\t}\n\t\tee.once('ready', ([error, result]) => {\n\t\t\tif (error) {\n\t\t\t\tcb({\n\t\t\t\t\tmsg: 'nosub',\n\n\t\t\t\t\tid: '',\n\t\t\t\t\terror,\n\t\t\t\t});\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tcb(result);\n\t\t});\n\t};\n\n\tconst ready = () => {\n\t\tif (meta.ready) {\n\t\t\treturn Promise.resolve();\n\t\t}\n\t\treturn new Promise<void>((r) => {\n\t\t\tee.once('ready', r);\n\t\t});\n\t};\n\n\treturn {\n\t\tstop: sub.stop,\n\t\tonChange,\n\t\tready,\n\t\terror: (cb: (...args: any[]) => void) =>\n\t\t\tee.once('error', (error) => {\n\t\t\t\tcb(error);\n\t\t\t}),\n\n\t\tget isReady() {\n\t\t\treturn meta.ready;\n\t\t},\n\t\tunsubList: new Set(),\n\t};\n};\n\nconst createStreamManager = () => {\n\t// Emitter that replicates stream messages to registered callbacks\n\tconst streamProxy = new Emitter<EventMap>();\n\n\t// Collection of unsubscribe callbacks for each stream.\n\t// const proxyUnsubLists = new Map<string, Set<() => void>>();\n\n\tconst streams = new Map<string, StreamMapValue>();\n\n\tAccounts.onLogout(() => {\n\t\tstreams.forEach((stream) => {\n\t\t\tstream.unsubList.forEach((stop) => stop());\n\t\t});\n\t});\n\n\tMeteor.connection._stream.on('message', (rawMsg: string) => {\n\t\tconst msg = DDPCommon.parseDDP(rawMsg);\n\t\tif (!isChangedCollectionPayload(msg)) {\n\t\t\treturn;\n\t\t}\n\t\tstreamProxy.emit(`${msg.collection}/${msg.fields.eventName}` as any, msg.fields.args as any);\n\t});\n\n\tconst stream: SDK['stream'] = <N extends StreamNames, K extends StreamKeys<N>>(\n\t\tname: N,\n\t\tdata: [key: K, ...args: unknown[]],\n\t\tcallback: (...args: StreamerCallbackArgs<N, K>) => void,\n\t\t_options?: {\n\t\t\tretransmit?: boolean | undefined;\n\t\t\tretransmitToSelf?: boolean | undefined;\n\t\t},\n\t): ReturnType<ClientStream['subscribe']> => {\n\t\tconst [key, ...args] = data;\n\t\tconst eventLiteral = `stream-${name}/${key}` as const;\n\n\t\tconst proxyCallback = (args?: unknown): void => {\n\t\t\tif (!args || !Array.isArray(args)) {\n\t\t\t\tthrow new Error('Invalid streamer callback');\n\t\t\t}\n\t\t\tcallback(...(args as StreamerCallbackArgs<N, K>));\n\t\t};\n\n\t\tstreamProxy.on(eventLiteral, proxyCallback);\n\n\t\tconst stop = (): void => {\n\t\t\tstreamProxy.off(eventLiteral, proxyCallback);\n\t\t\t// If someone is still listening, don't unsubscribe\n\t\t\tif (streamProxy.has(eventLiteral)) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tif (stream) {\n\t\t\t\tstream.stop();\n\t\t\t\tstreams.delete(eventLiteral);\n\t\t\t}\n\t\t};\n\n\t\tconst stream = streams.get(eventLiteral) || createNewMeteorStream(name, key, args);\n\n\t\tstream.unsubList.add(stop);\n\t\tif (!streams.has(eventLiteral)) {\n\t\t\tstreams.set(eventLiteral, stream);\n\t\t}\n\n\t\tstream.error(() => {\n\t\t\tstream.unsubList.forEach((stop) => stop());\n\t\t});\n\n\t\treturn {\n\t\t\tid: '',\n\t\t\tname,\n\t\t\tparams: data as any,\n\t\t\tstop,\n\t\t\tready: stream.ready,\n\t\t\tonChange: stream.onChange,\n\t\t\tisReady: stream.isReady,\n\t\t};\n\t};\n\n\tconst stopAll = (streamName: string, key: string) => {\n\t\tconst stream = streams.get(`stream-${streamName}/${key}`);\n\n\t\tif (stream) {\n\t\t\tstream.unsubList.forEach((stop) => stop());\n\t\t}\n\t};\n\n\treturn { stream, stopAll };\n};\n\nexport const createSDK = (rest: RestClientInterface) => {\n\tconst { stream, stopAll } = createStreamManager();\n\n\tconst publish = (name: string, args: unknown[]) => {\n\t\tMeteor.call(`stream-${name}`, ...args);\n\t};\n\n\tconst call = <T extends keyof ServerMethods>(method: T, ...args: Parameters<ServerMethods[T]>): Promise<ReturnType<ServerMethods[T]>> => {\n\t\treturn Meteor.callAsync(method, ...args);\n\t};\n\n\treturn {\n\t\trest,\n\t\tstop: stopAll,\n\t\tstream,\n\t\tpublish,\n\t\tcall,\n\t};\n};\n\nexport const sdk = createSDK(APIClient);\n"]}}},"code":"module.export({\n  createSDK: () => createSDK,\n  sdk: () => sdk\n});\nlet Emitter;\nmodule.link(\"@rocket.chat/emitter\", {\n  Emitter(v) {\n    Emitter = v;\n  }\n}, 0);\nlet Accounts;\nmodule.link(\"meteor/accounts-base\", {\n  Accounts(v) {\n    Accounts = v;\n  }\n}, 1);\nlet DDPCommon;\nmodule.link(\"meteor/ddp-common\", {\n  DDPCommon(v) {\n    DDPCommon = v;\n  }\n}, 2);\nlet Meteor;\nmodule.link(\"meteor/meteor\", {\n  Meteor(v) {\n    Meteor = v;\n  }\n}, 3);\nlet APIClient;\nmodule.link(\"./RestApiClient\", {\n  APIClient(v) {\n    APIClient = v;\n  }\n}, 4);\nconst isChangedCollectionPayload = msg => {\n  if (typeof msg !== 'object' && (msg !== null || msg !== undefined)) {\n    return false;\n  }\n  if (msg.msg !== 'changed') {\n    return false;\n  }\n  if (typeof msg.collection !== 'string') {\n    return false;\n  }\n  if (typeof msg.fields !== 'object' && (msg.fields !== null || msg.fields !== undefined)) {\n    return false;\n  }\n  if (typeof msg.fields.eventName !== 'string') {\n    return false;\n  }\n  if (!Array.isArray(msg.fields.args)) {\n    return false;\n  }\n  return true;\n};\nconst createNewMeteorStream = (streamName, key, args) => {\n  const ee = new Emitter();\n  const meta = {\n    ready: false\n  };\n  const sub = Meteor.connection.subscribe(\"stream-\".concat(streamName), key, {\n    useCollection: false,\n    args\n  }, {\n    onReady: args => {\n      meta.ready = true;\n      ee.emit('ready', [undefined, args]);\n    },\n    onError: err => {\n      ee.emit('ready', [err]);\n      ee.emit('error', err);\n    }\n  });\n  const onChange = cb => {\n    if (meta.ready) {\n      cb({\n        msg: 'ready',\n        subs: []\n      });\n      return;\n    }\n    ee.once('ready', _ref => {\n      let [error, result] = _ref;\n      if (error) {\n        cb({\n          msg: 'nosub',\n          id: '',\n          error\n        });\n        return;\n      }\n      cb(result);\n    });\n  };\n  const ready = () => {\n    if (meta.ready) {\n      return Promise.resolve();\n    }\n    return new Promise(r => {\n      ee.once('ready', r);\n    });\n  };\n  return {\n    stop: sub.stop,\n    onChange,\n    ready,\n    error: cb => ee.once('error', error => {\n      cb(error);\n    }),\n    get isReady() {\n      return meta.ready;\n    },\n    unsubList: new Set()\n  };\n};\nconst createStreamManager = () => {\n  // Emitter that replicates stream messages to registered callbacks\n  const streamProxy = new Emitter();\n  // Collection of unsubscribe callbacks for each stream.\n  // const proxyUnsubLists = new Map<string, Set<() => void>>();\n  const streams = new Map();\n  Accounts.onLogout(() => {\n    streams.forEach(stream => {\n      stream.unsubList.forEach(stop => stop());\n    });\n  });\n  Meteor.connection._stream.on('message', rawMsg => {\n    const msg = DDPCommon.parseDDP(rawMsg);\n    if (!isChangedCollectionPayload(msg)) {\n      return;\n    }\n    streamProxy.emit(\"\".concat(msg.collection, \"/\").concat(msg.fields.eventName), msg.fields.args);\n  });\n  const stream = (name, data, callback, _options) => {\n    const [key, ...args] = data;\n    const eventLiteral = \"stream-\".concat(name, \"/\").concat(key);\n    const proxyCallback = args => {\n      if (!args || !Array.isArray(args)) {\n        throw new Error('Invalid streamer callback');\n      }\n      callback(...args);\n    };\n    streamProxy.on(eventLiteral, proxyCallback);\n    const stop = () => {\n      streamProxy.off(eventLiteral, proxyCallback);\n      // If someone is still listening, don't unsubscribe\n      if (streamProxy.has(eventLiteral)) {\n        return;\n      }\n      if (stream) {\n        stream.stop();\n        streams.delete(eventLiteral);\n      }\n    };\n    const stream = streams.get(eventLiteral) || createNewMeteorStream(name, key, args);\n    stream.unsubList.add(stop);\n    if (!streams.has(eventLiteral)) {\n      streams.set(eventLiteral, stream);\n    }\n    stream.error(() => {\n      stream.unsubList.forEach(stop => stop());\n    });\n    return {\n      id: '',\n      name,\n      params: data,\n      stop,\n      ready: stream.ready,\n      onChange: stream.onChange,\n      isReady: stream.isReady\n    };\n  };\n  const stopAll = (streamName, key) => {\n    const stream = streams.get(\"stream-\".concat(streamName, \"/\").concat(key));\n    if (stream) {\n      stream.unsubList.forEach(stop => stop());\n    }\n  };\n  return {\n    stream,\n    stopAll\n  };\n};\nconst createSDK = rest => {\n  const {\n    stream,\n    stopAll\n  } = createStreamManager();\n  const publish = (name, args) => {\n    Meteor.call(\"stream-\".concat(name), ...args);\n  };\n  const call = function (method) {\n    for (var _len = arguments.length, args = new Array(_len > 1 ? _len - 1 : 0), _key = 1; _key < _len; _key++) {\n      args[_key - 1] = arguments[_key];\n    }\n    return Meteor.callAsync(method, ...args);\n  };\n  return {\n    rest,\n    stop: stopAll,\n    stream,\n    publish,\n    call\n  };\n};\nconst sdk = createSDK(APIClient);","map":{"version":3,"names":["module","export","createSDK","sdk","Emitter","link","v","Accounts","DDPCommon","Meteor","APIClient","isChangedCollectionPayload","msg","undefined","collection","fields","eventName","Array","isArray","args","createNewMeteorStream","streamName","key","ee","meta","ready","sub","connection","subscribe","concat","useCollection","onReady","emit","onError","err","onChange","cb","subs","once","_ref","error","result","id","Promise","resolve","r","stop","isReady","unsubList","Set","createStreamManager","streamProxy","streams","Map","onLogout","forEach","stream","_stream","on","rawMsg","parseDDP","name","data","callback","_options","eventLiteral","proxyCallback","Error","off","has","delete","get","add","set","params","stopAll","rest","publish","call","method","_len","arguments","length","_key","callAsync"],"sources":["app/utils/client/lib/SDKClient.ts"],"sourcesContent":["import type { RestClientInterface } from '@rocket.chat/api-client';\nimport type { SDK, ClientStream, StreamKeys, StreamNames, StreamerCallbackArgs, ServerMethods } from '@rocket.chat/ddp-client';\nimport { Emitter } from '@rocket.chat/emitter';\nimport { Accounts } from 'meteor/accounts-base';\nimport { DDPCommon } from 'meteor/ddp-common';\nimport { Meteor } from 'meteor/meteor';\n\nimport { APIClient } from './RestApiClient';\n\ndeclare module '@rocket.chat/ddp-client' {\n\t// eslint-disable-next-line @typescript-eslint/naming-convention\n\tinterface SDK {\n\t\tstream<N extends StreamNames, K extends StreamKeys<N>>(\n\t\t\tstreamName: N,\n\t\t\targs: [key: K, ...args: unknown[]],\n\t\t\tcallback: (...args: StreamerCallbackArgs<N, K>) => void,\n\t\t): ReturnType<ClientStream['subscribe']>;\n\t\tcall<T extends keyof ServerMethods>(method: T, ...args: Parameters<ServerMethods[T]>): Promise<ReturnType<ServerMethods[T]>>;\n\t}\n}\n\nconst isChangedCollectionPayload = (\n\tmsg: any,\n): msg is { msg: 'changed'; collection: string; fields: { eventName: string; args: unknown[] } } => {\n\tif (typeof msg !== 'object' && (msg !== null || msg !== undefined)) {\n\t\treturn false;\n\t}\n\tif (msg.msg !== 'changed') {\n\t\treturn false;\n\t}\n\tif (typeof msg.collection !== 'string') {\n\t\treturn false;\n\t}\n\tif (typeof msg.fields !== 'object' && (msg.fields !== null || msg.fields !== undefined)) {\n\t\treturn false;\n\t}\n\tif (typeof msg.fields.eventName !== 'string') {\n\t\treturn false;\n\t}\n\tif (!Array.isArray(msg.fields.args)) {\n\t\treturn false;\n\t}\n\treturn true;\n};\n\ntype EventMap<N extends StreamNames = StreamNames, K extends StreamKeys<N> = StreamKeys<N>> = {\n\t[key in `stream-${N}/${K}`]: StreamerCallbackArgs<N, K>;\n};\n\ntype StreamMapValue = {\n\tstop: () => void;\n\terror: (cb: (...args: any[]) => void) => void;\n\tonChange: ReturnType<ClientStream['subscribe']>['onChange'];\n\tready: () => Promise<void>;\n\tisReady: boolean;\n\tunsubList: Set<() => void>;\n};\n\nconst createNewMeteorStream = (streamName: StreamNames, key: StreamKeys<StreamNames>, args: unknown[]): StreamMapValue => {\n\tconst ee = new Emitter();\n\tconst meta = {\n\t\tready: false,\n\t};\n\n\tconst sub = Meteor.connection.subscribe(\n\t\t`stream-${streamName}`,\n\t\tkey,\n\t\t{ useCollection: false, args },\n\t\t{\n\t\t\tonReady: (args: any) => {\n\t\t\t\tmeta.ready = true;\n\t\t\t\tee.emit('ready', [undefined, args]);\n\t\t\t},\n\t\t\tonError: (err: any) => {\n\t\t\t\tee.emit('ready', [err]);\n\t\t\t\tee.emit('error', err);\n\t\t\t},\n\t\t},\n\t);\n\n\tconst onChange: ReturnType<ClientStream['subscribe']>['onChange'] = (cb) => {\n\t\tif (meta.ready) {\n\t\t\tcb({\n\t\t\t\tmsg: 'ready',\n\n\t\t\t\tsubs: [],\n\t\t\t});\n\t\t\treturn;\n\t\t}\n\t\tee.once('ready', ([error, result]) => {\n\t\t\tif (error) {\n\t\t\t\tcb({\n\t\t\t\t\tmsg: 'nosub',\n\n\t\t\t\t\tid: '',\n\t\t\t\t\terror,\n\t\t\t\t});\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tcb(result);\n\t\t});\n\t};\n\n\tconst ready = () => {\n\t\tif (meta.ready) {\n\t\t\treturn Promise.resolve();\n\t\t}\n\t\treturn new Promise<void>((r) => {\n\t\t\tee.once('ready', r);\n\t\t});\n\t};\n\n\treturn {\n\t\tstop: sub.stop,\n\t\tonChange,\n\t\tready,\n\t\terror: (cb: (...args: any[]) => void) =>\n\t\t\tee.once('error', (error) => {\n\t\t\t\tcb(error);\n\t\t\t}),\n\n\t\tget isReady() {\n\t\t\treturn meta.ready;\n\t\t},\n\t\tunsubList: new Set(),\n\t};\n};\n\nconst createStreamManager = () => {\n\t// Emitter that replicates stream messages to registered callbacks\n\tconst streamProxy = new Emitter<EventMap>();\n\n\t// Collection of unsubscribe callbacks for each stream.\n\t// const proxyUnsubLists = new Map<string, Set<() => void>>();\n\n\tconst streams = new Map<string, StreamMapValue>();\n\n\tAccounts.onLogout(() => {\n\t\tstreams.forEach((stream) => {\n\t\t\tstream.unsubList.forEach((stop) => stop());\n\t\t});\n\t});\n\n\tMeteor.connection._stream.on('message', (rawMsg: string) => {\n\t\tconst msg = DDPCommon.parseDDP(rawMsg);\n\t\tif (!isChangedCollectionPayload(msg)) {\n\t\t\treturn;\n\t\t}\n\t\tstreamProxy.emit(`${msg.collection}/${msg.fields.eventName}` as any, msg.fields.args as any);\n\t});\n\n\tconst stream: SDK['stream'] = <N extends StreamNames, K extends StreamKeys<N>>(\n\t\tname: N,\n\t\tdata: [key: K, ...args: unknown[]],\n\t\tcallback: (...args: StreamerCallbackArgs<N, K>) => void,\n\t\t_options?: {\n\t\t\tretransmit?: boolean | undefined;\n\t\t\tretransmitToSelf?: boolean | undefined;\n\t\t},\n\t): ReturnType<ClientStream['subscribe']> => {\n\t\tconst [key, ...args] = data;\n\t\tconst eventLiteral = `stream-${name}/${key}` as const;\n\n\t\tconst proxyCallback = (args?: unknown): void => {\n\t\t\tif (!args || !Array.isArray(args)) {\n\t\t\t\tthrow new Error('Invalid streamer callback');\n\t\t\t}\n\t\t\tcallback(...(args as StreamerCallbackArgs<N, K>));\n\t\t};\n\n\t\tstreamProxy.on(eventLiteral, proxyCallback);\n\n\t\tconst stop = (): void => {\n\t\t\tstreamProxy.off(eventLiteral, proxyCallback);\n\t\t\t// If someone is still listening, don't unsubscribe\n\t\t\tif (streamProxy.has(eventLiteral)) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tif (stream) {\n\t\t\t\tstream.stop();\n\t\t\t\tstreams.delete(eventLiteral);\n\t\t\t}\n\t\t};\n\n\t\tconst stream = streams.get(eventLiteral) || createNewMeteorStream(name, key, args);\n\n\t\tstream.unsubList.add(stop);\n\t\tif (!streams.has(eventLiteral)) {\n\t\t\tstreams.set(eventLiteral, stream);\n\t\t}\n\n\t\tstream.error(() => {\n\t\t\tstream.unsubList.forEach((stop) => stop());\n\t\t});\n\n\t\treturn {\n\t\t\tid: '',\n\t\t\tname,\n\t\t\tparams: data as any,\n\t\t\tstop,\n\t\t\tready: stream.ready,\n\t\t\tonChange: stream.onChange,\n\t\t\tisReady: stream.isReady,\n\t\t};\n\t};\n\n\tconst stopAll = (streamName: string, key: string) => {\n\t\tconst stream = streams.get(`stream-${streamName}/${key}`);\n\n\t\tif (stream) {\n\t\t\tstream.unsubList.forEach((stop) => stop());\n\t\t}\n\t};\n\n\treturn { stream, stopAll };\n};\n\nexport const createSDK = (rest: RestClientInterface) => {\n\tconst { stream, stopAll } = createStreamManager();\n\n\tconst publish = (name: string, args: unknown[]) => {\n\t\tMeteor.call(`stream-${name}`, ...args);\n\t};\n\n\tconst call = <T extends keyof ServerMethods>(method: T, ...args: Parameters<ServerMethods[T]>): Promise<ReturnType<ServerMethods[T]>> => {\n\t\treturn Meteor.callAsync(method, ...args);\n\t};\n\n\treturn {\n\t\trest,\n\t\tstop: stopAll,\n\t\tstream,\n\t\tpublish,\n\t\tcall,\n\t};\n};\n\nexport const sdk = createSDK(APIClient);\n"],"mappings":"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","ignoreList":[]},"sourceType":"module","externalDependencies":{},"hash":"720015ffba73841554fc941434377b5cd82e28aa"}
