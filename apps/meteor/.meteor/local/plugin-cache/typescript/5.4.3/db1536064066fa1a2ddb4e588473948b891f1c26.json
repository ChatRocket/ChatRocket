{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/app/file-upload/server/config/FileSystem.ts","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","topLevelAwait","objectRestSpread","objectRestSpread","asyncGenerators","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"os.osx.arm64"},"sourceFileName":"app/file-upload/server/config/FileSystem.ts","filename":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/app/file-upload/server/config/FileSystem.ts","inputSourceMap":{"version":3,"file":"app/file-upload/server/config/FileSystem.ts","sourceRoot":"","sources":["app/file-upload/server/config/FileSystem.ts"],"names":[],"mappings":"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","sourcesContent":["import fsp from 'fs/promises';\n\nimport { UploadFS } from '../../../../server/ufs';\nimport { settings } from '../../../settings/server';\nimport { FileUploadClass, FileUpload } from '../lib/FileUpload';\nimport { getFileRange, setRangeHeaders } from '../lib/ranges';\nimport { getContentDisposition } from './helper';\n\nconst FileSystemUploads = new FileUploadClass({\n\tname: 'FileSystem:Uploads',\n\t// store setted bellow\n\n\tasync get(file, req, res) {\n\t\tif (!this.store || !file) {\n\t\t\treturn;\n\t\t}\n\t\tconst filePath = await this.store.getFilePath(file._id, file);\n\n\t\tconst options: { start?: number; end?: number } = {};\n\n\t\ttry {\n\t\t\tconst stat = await fsp.stat(filePath);\n\t\t\tif (!stat?.isFile()) {\n\t\t\t\tres.writeHead(404);\n\t\t\t\tres.end();\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tfile = FileUpload.addExtensionTo(file);\n\n\t\t\tres.setHeader('Content-Disposition', `${getContentDisposition(req)}; filename*=UTF-8''${encodeURIComponent(file.name || '')}`);\n\t\t\tfile.uploadedAt && res.setHeader('Last-Modified', file.uploadedAt.toUTCString());\n\t\t\tres.setHeader('Content-Type', file.type || 'application/octet-stream');\n\n\t\t\tif (req.headers.range) {\n\t\t\t\tconst range = getFileRange(file, req);\n\n\t\t\t\tif (range) {\n\t\t\t\t\tsetRangeHeaders(range, file, res);\n\t\t\t\t\tif (range.outOfRange) {\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\t\t\t\t\toptions.start = range.start;\n\t\t\t\t\toptions.end = range.stop;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// set content-length if range has not set\n\t\t\tif (!res.getHeader('Content-Length')) {\n\t\t\t\tres.setHeader('Content-Length', file.size || 0);\n\t\t\t}\n\n\t\t\t(await this.store.getReadStream(file._id, file, options)).pipe(res);\n\t\t} catch (e) {\n\t\t\tres.writeHead(404);\n\t\t\tres.end();\n\t\t}\n\t},\n\n\tasync copy(file, out) {\n\t\tif (!this.store) {\n\t\t\treturn;\n\t\t}\n\t\tconst filePath = await this.store.getFilePath(file._id, file);\n\t\ttry {\n\t\t\tconst stat = await fsp.stat(filePath);\n\n\t\t\tif (stat?.isFile()) {\n\t\t\t\tfile = FileUpload.addExtensionTo(file);\n\n\t\t\t\t(await this.store.getReadStream(file._id, file)).pipe(out);\n\t\t\t}\n\t\t} catch (e) {\n\t\t\tout.end();\n\t\t}\n\t},\n});\n\nconst FileSystemAvatars = new FileUploadClass({\n\tname: 'FileSystem:Avatars',\n\t// store setted bellow\n\n\tasync get(file, _req, res) {\n\t\tif (!this.store) {\n\t\t\treturn;\n\t\t}\n\t\tconst filePath = await this.store.getFilePath(file._id, file);\n\n\t\ttry {\n\t\t\tconst stat = await fsp.stat(filePath);\n\n\t\t\tif (stat?.isFile()) {\n\t\t\t\tfile = FileUpload.addExtensionTo(file);\n\n\t\t\t\t(await this.store.getReadStream(file._id, file)).pipe(res);\n\t\t\t}\n\t\t} catch (e) {\n\t\t\tres.writeHead(404);\n\t\t\tres.end();\n\t\t}\n\t},\n});\n\nconst FileSystemUserDataFiles = new FileUploadClass({\n\tname: 'FileSystem:UserDataFiles',\n\n\tasync get(file, _req, res) {\n\t\tif (!this.store) {\n\t\t\treturn;\n\t\t}\n\t\tconst filePath = await this.store.getFilePath(file._id, file);\n\n\t\ttry {\n\t\t\tconst stat = await fsp.stat(filePath);\n\n\t\t\tif (stat?.isFile()) {\n\t\t\t\tfile = FileUpload.addExtensionTo(file);\n\t\t\t\tres.setHeader('Content-Disposition', `attachment; filename*=UTF-8''${encodeURIComponent(file.name || '')}`);\n\t\t\t\tfile.uploadedAt && res.setHeader('Last-Modified', file.uploadedAt.toUTCString());\n\t\t\t\tres.setHeader('Content-Type', file.type || '');\n\t\t\t\tres.setHeader('Content-Length', file.size || 0);\n\n\t\t\t\t(await this.store.getReadStream(file._id, file)).pipe(res);\n\t\t\t}\n\t\t} catch (e) {\n\t\t\tres.writeHead(404);\n\t\t\tres.end();\n\t\t}\n\t},\n});\n\nsettings.watch('FileUpload_FileSystemPath', () => {\n\tconst options = {\n\t\tpath: settings.get('FileUpload_FileSystemPath'), // '/tmp/uploads/photos',\n\t};\n\n\tFileSystemUploads.store = FileUpload.configureUploadsStore('Local', FileSystemUploads.name, options);\n\tFileSystemAvatars.store = FileUpload.configureUploadsStore('Local', FileSystemAvatars.name, options);\n\tFileSystemUserDataFiles.store = FileUpload.configureUploadsStore('Local', FileSystemUserDataFiles.name, options);\n\n\t// DEPRECATED backwards compatibility (remove)\n\tUploadFS.getStores().fileSystem = UploadFS.getStores()[FileSystemUploads.name];\n});\n"]},"targets":{"android":"125.0.0","chrome":"125.0.0","edge":"125.0.0","firefox":"115.0.0","ie":"10.0.0","ios":"17.4.0","opera":"110.0.0","opera_mobile":"80.0.0","safari":"17.4.0","samsung":"24.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor","root":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":false,"enforceStrictMode":false,"dynamicImport":true,"generateLetDeclarations":true,"topLevelAwait":true},"externalDependencies":[]},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"version":"7.17.2","helpers":true,"useESModules":false,"corejs":false},"externalDependencies":[]},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-async-generator-functions","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-class-properties","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true},"externalDependencies":[]},{"key":"transform-react-jsx","visitor":{"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXFragment":{"exit":[null]},"JSXElement":{"exit":[null]},"JSXAttribute":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false},"externalDependencies":[]},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-nullish-coalescing-operator","visitor":{"LogicalExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-optional-chaining","visitor":{"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-optional-catch-binding","visitor":{"CatchClause":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-class-properties","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-async-generator-functions","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-logical-assignment-operators","visitor":{"AssignmentExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]}],"presets":[],"generatorOpts":{"filename":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/app/file-upload/server/config/FileSystem.ts","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"app/file-upload/server/config/FileSystem.ts","inputSourceMap":{"version":3,"file":"app/file-upload/server/config/FileSystem.ts","sourceRoot":"","sources":["app/file-upload/server/config/FileSystem.ts"],"names":[],"mappings":"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","sourcesContent":["import fsp from 'fs/promises';\n\nimport { UploadFS } from '../../../../server/ufs';\nimport { settings } from '../../../settings/server';\nimport { FileUploadClass, FileUpload } from '../lib/FileUpload';\nimport { getFileRange, setRangeHeaders } from '../lib/ranges';\nimport { getContentDisposition } from './helper';\n\nconst FileSystemUploads = new FileUploadClass({\n\tname: 'FileSystem:Uploads',\n\t// store setted bellow\n\n\tasync get(file, req, res) {\n\t\tif (!this.store || !file) {\n\t\t\treturn;\n\t\t}\n\t\tconst filePath = await this.store.getFilePath(file._id, file);\n\n\t\tconst options: { start?: number; end?: number } = {};\n\n\t\ttry {\n\t\t\tconst stat = await fsp.stat(filePath);\n\t\t\tif (!stat?.isFile()) {\n\t\t\t\tres.writeHead(404);\n\t\t\t\tres.end();\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tfile = FileUpload.addExtensionTo(file);\n\n\t\t\tres.setHeader('Content-Disposition', `${getContentDisposition(req)}; filename*=UTF-8''${encodeURIComponent(file.name || '')}`);\n\t\t\tfile.uploadedAt && res.setHeader('Last-Modified', file.uploadedAt.toUTCString());\n\t\t\tres.setHeader('Content-Type', file.type || 'application/octet-stream');\n\n\t\t\tif (req.headers.range) {\n\t\t\t\tconst range = getFileRange(file, req);\n\n\t\t\t\tif (range) {\n\t\t\t\t\tsetRangeHeaders(range, file, res);\n\t\t\t\t\tif (range.outOfRange) {\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\t\t\t\t\toptions.start = range.start;\n\t\t\t\t\toptions.end = range.stop;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// set content-length if range has not set\n\t\t\tif (!res.getHeader('Content-Length')) {\n\t\t\t\tres.setHeader('Content-Length', file.size || 0);\n\t\t\t}\n\n\t\t\t(await this.store.getReadStream(file._id, file, options)).pipe(res);\n\t\t} catch (e) {\n\t\t\tres.writeHead(404);\n\t\t\tres.end();\n\t\t}\n\t},\n\n\tasync copy(file, out) {\n\t\tif (!this.store) {\n\t\t\treturn;\n\t\t}\n\t\tconst filePath = await this.store.getFilePath(file._id, file);\n\t\ttry {\n\t\t\tconst stat = await fsp.stat(filePath);\n\n\t\t\tif (stat?.isFile()) {\n\t\t\t\tfile = FileUpload.addExtensionTo(file);\n\n\t\t\t\t(await this.store.getReadStream(file._id, file)).pipe(out);\n\t\t\t}\n\t\t} catch (e) {\n\t\t\tout.end();\n\t\t}\n\t},\n});\n\nconst FileSystemAvatars = new FileUploadClass({\n\tname: 'FileSystem:Avatars',\n\t// store setted bellow\n\n\tasync get(file, _req, res) {\n\t\tif (!this.store) {\n\t\t\treturn;\n\t\t}\n\t\tconst filePath = await this.store.getFilePath(file._id, file);\n\n\t\ttry {\n\t\t\tconst stat = await fsp.stat(filePath);\n\n\t\t\tif (stat?.isFile()) {\n\t\t\t\tfile = FileUpload.addExtensionTo(file);\n\n\t\t\t\t(await this.store.getReadStream(file._id, file)).pipe(res);\n\t\t\t}\n\t\t} catch (e) {\n\t\t\tres.writeHead(404);\n\t\t\tres.end();\n\t\t}\n\t},\n});\n\nconst FileSystemUserDataFiles = new FileUploadClass({\n\tname: 'FileSystem:UserDataFiles',\n\n\tasync get(file, _req, res) {\n\t\tif (!this.store) {\n\t\t\treturn;\n\t\t}\n\t\tconst filePath = await this.store.getFilePath(file._id, file);\n\n\t\ttry {\n\t\t\tconst stat = await fsp.stat(filePath);\n\n\t\t\tif (stat?.isFile()) {\n\t\t\t\tfile = FileUpload.addExtensionTo(file);\n\t\t\t\tres.setHeader('Content-Disposition', `attachment; filename*=UTF-8''${encodeURIComponent(file.name || '')}`);\n\t\t\t\tfile.uploadedAt && res.setHeader('Last-Modified', file.uploadedAt.toUTCString());\n\t\t\t\tres.setHeader('Content-Type', file.type || '');\n\t\t\t\tres.setHeader('Content-Length', file.size || 0);\n\n\t\t\t\t(await this.store.getReadStream(file._id, file)).pipe(res);\n\t\t\t}\n\t\t} catch (e) {\n\t\t\tres.writeHead(404);\n\t\t\tres.end();\n\t\t}\n\t},\n});\n\nsettings.watch('FileUpload_FileSystemPath', () => {\n\tconst options = {\n\t\tpath: settings.get('FileUpload_FileSystemPath'), // '/tmp/uploads/photos',\n\t};\n\n\tFileSystemUploads.store = FileUpload.configureUploadsStore('Local', FileSystemUploads.name, options);\n\tFileSystemAvatars.store = FileUpload.configureUploadsStore('Local', FileSystemAvatars.name, options);\n\tFileSystemUserDataFiles.store = FileUpload.configureUploadsStore('Local', FileSystemUserDataFiles.name, options);\n\n\t// DEPRECATED backwards compatibility (remove)\n\tUploadFS.getStores().fileSystem = UploadFS.getStores()[FileSystemUploads.name];\n});\n"]}}},"code":"!module.wrapAsync(async function (module, __reifyWaitForDeps__, __reify_async_result__) {\n  \"use strict\";\n  try {\n    let fsp;\n    module.link(\"fs/promises\", {\n      default(v) {\n        fsp = v;\n      }\n    }, 0);\n    let UploadFS;\n    module.link(\"../../../../server/ufs\", {\n      UploadFS(v) {\n        UploadFS = v;\n      }\n    }, 1);\n    let settings;\n    module.link(\"../../../settings/server\", {\n      settings(v) {\n        settings = v;\n      }\n    }, 2);\n    let FileUploadClass, FileUpload;\n    module.link(\"../lib/FileUpload\", {\n      FileUploadClass(v) {\n        FileUploadClass = v;\n      },\n      FileUpload(v) {\n        FileUpload = v;\n      }\n    }, 3);\n    let getFileRange, setRangeHeaders;\n    module.link(\"../lib/ranges\", {\n      getFileRange(v) {\n        getFileRange = v;\n      },\n      setRangeHeaders(v) {\n        setRangeHeaders = v;\n      }\n    }, 4);\n    let getContentDisposition;\n    module.link(\"./helper\", {\n      getContentDisposition(v) {\n        getContentDisposition = v;\n      }\n    }, 5);\n    if (__reifyWaitForDeps__()) (await __reifyWaitForDeps__())();\n    const FileSystemUploads = new FileUploadClass({\n      name: 'FileSystem:Uploads',\n      // store setted bellow\n      async get(file, req, res) {\n        if (!this.store || !file) {\n          return;\n        }\n        const filePath = await this.store.getFilePath(file._id, file);\n        const options = {};\n        try {\n          const stat = await fsp.stat(filePath);\n          if (!(stat !== null && stat !== void 0 && stat.isFile())) {\n            res.writeHead(404);\n            res.end();\n            return;\n          }\n          file = FileUpload.addExtensionTo(file);\n          res.setHeader('Content-Disposition', \"\".concat(getContentDisposition(req), \"; filename*=UTF-8''\").concat(encodeURIComponent(file.name || '')));\n          file.uploadedAt && res.setHeader('Last-Modified', file.uploadedAt.toUTCString());\n          res.setHeader('Content-Type', file.type || 'application/octet-stream');\n          if (req.headers.range) {\n            const range = getFileRange(file, req);\n            if (range) {\n              setRangeHeaders(range, file, res);\n              if (range.outOfRange) {\n                return;\n              }\n              options.start = range.start;\n              options.end = range.stop;\n            }\n          }\n          // set content-length if range has not set\n          if (!res.getHeader('Content-Length')) {\n            res.setHeader('Content-Length', file.size || 0);\n          }\n          (await this.store.getReadStream(file._id, file, options)).pipe(res);\n        } catch (e) {\n          res.writeHead(404);\n          res.end();\n        }\n      },\n      async copy(file, out) {\n        if (!this.store) {\n          return;\n        }\n        const filePath = await this.store.getFilePath(file._id, file);\n        try {\n          const stat = await fsp.stat(filePath);\n          if (stat !== null && stat !== void 0 && stat.isFile()) {\n            file = FileUpload.addExtensionTo(file);\n            (await this.store.getReadStream(file._id, file)).pipe(out);\n          }\n        } catch (e) {\n          out.end();\n        }\n      }\n    });\n    const FileSystemAvatars = new FileUploadClass({\n      name: 'FileSystem:Avatars',\n      // store setted bellow\n      async get(file, _req, res) {\n        if (!this.store) {\n          return;\n        }\n        const filePath = await this.store.getFilePath(file._id, file);\n        try {\n          const stat = await fsp.stat(filePath);\n          if (stat !== null && stat !== void 0 && stat.isFile()) {\n            file = FileUpload.addExtensionTo(file);\n            (await this.store.getReadStream(file._id, file)).pipe(res);\n          }\n        } catch (e) {\n          res.writeHead(404);\n          res.end();\n        }\n      }\n    });\n    const FileSystemUserDataFiles = new FileUploadClass({\n      name: 'FileSystem:UserDataFiles',\n      async get(file, _req, res) {\n        if (!this.store) {\n          return;\n        }\n        const filePath = await this.store.getFilePath(file._id, file);\n        try {\n          const stat = await fsp.stat(filePath);\n          if (stat !== null && stat !== void 0 && stat.isFile()) {\n            file = FileUpload.addExtensionTo(file);\n            res.setHeader('Content-Disposition', \"attachment; filename*=UTF-8''\".concat(encodeURIComponent(file.name || '')));\n            file.uploadedAt && res.setHeader('Last-Modified', file.uploadedAt.toUTCString());\n            res.setHeader('Content-Type', file.type || '');\n            res.setHeader('Content-Length', file.size || 0);\n            (await this.store.getReadStream(file._id, file)).pipe(res);\n          }\n        } catch (e) {\n          res.writeHead(404);\n          res.end();\n        }\n      }\n    });\n    settings.watch('FileUpload_FileSystemPath', () => {\n      const options = {\n        path: settings.get('FileUpload_FileSystemPath') // '/tmp/uploads/photos',\n      };\n      FileSystemUploads.store = FileUpload.configureUploadsStore('Local', FileSystemUploads.name, options);\n      FileSystemAvatars.store = FileUpload.configureUploadsStore('Local', FileSystemAvatars.name, options);\n      FileSystemUserDataFiles.store = FileUpload.configureUploadsStore('Local', FileSystemUserDataFiles.name, options);\n      // DEPRECATED backwards compatibility (remove)\n      UploadFS.getStores().fileSystem = UploadFS.getStores()[FileSystemUploads.name];\n    });\n    __reify_async_result__();\n  } catch (_reifyError) {\n    return __reify_async_result__(_reifyError);\n  }\n  __reify_async_result__()\n}, {\n  self: this,\n  async: false\n});","map":{"version":3,"names":["fsp","module","link","default","v","UploadFS","settings","FileUploadClass","FileUpload","getFileRange","setRangeHeaders","getContentDisposition","__reifyWaitForDeps__","FileSystemUploads","name","get","file","req","res","store","filePath","getFilePath","_id","options","stat","isFile","writeHead","end","addExtensionTo","setHeader","concat","encodeURIComponent","uploadedAt","toUTCString","type","headers","range","outOfRange","start","stop","getHeader","size","getReadStream","pipe","e","copy","out","FileSystemAvatars","_req","FileSystemUserDataFiles","watch","path","configureUploadsStore","getStores","fileSystem","__reify_async_result__","_reifyError","self","async"],"sources":["app/file-upload/server/config/FileSystem.ts"],"sourcesContent":["import fsp from 'fs/promises';\n\nimport { UploadFS } from '../../../../server/ufs';\nimport { settings } from '../../../settings/server';\nimport { FileUploadClass, FileUpload } from '../lib/FileUpload';\nimport { getFileRange, setRangeHeaders } from '../lib/ranges';\nimport { getContentDisposition } from './helper';\n\nconst FileSystemUploads = new FileUploadClass({\n\tname: 'FileSystem:Uploads',\n\t// store setted bellow\n\n\tasync get(file, req, res) {\n\t\tif (!this.store || !file) {\n\t\t\treturn;\n\t\t}\n\t\tconst filePath = await this.store.getFilePath(file._id, file);\n\n\t\tconst options: { start?: number; end?: number } = {};\n\n\t\ttry {\n\t\t\tconst stat = await fsp.stat(filePath);\n\t\t\tif (!stat?.isFile()) {\n\t\t\t\tres.writeHead(404);\n\t\t\t\tres.end();\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tfile = FileUpload.addExtensionTo(file);\n\n\t\t\tres.setHeader('Content-Disposition', `${getContentDisposition(req)}; filename*=UTF-8''${encodeURIComponent(file.name || '')}`);\n\t\t\tfile.uploadedAt && res.setHeader('Last-Modified', file.uploadedAt.toUTCString());\n\t\t\tres.setHeader('Content-Type', file.type || 'application/octet-stream');\n\n\t\t\tif (req.headers.range) {\n\t\t\t\tconst range = getFileRange(file, req);\n\n\t\t\t\tif (range) {\n\t\t\t\t\tsetRangeHeaders(range, file, res);\n\t\t\t\t\tif (range.outOfRange) {\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\t\t\t\t\toptions.start = range.start;\n\t\t\t\t\toptions.end = range.stop;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// set content-length if range has not set\n\t\t\tif (!res.getHeader('Content-Length')) {\n\t\t\t\tres.setHeader('Content-Length', file.size || 0);\n\t\t\t}\n\n\t\t\t(await this.store.getReadStream(file._id, file, options)).pipe(res);\n\t\t} catch (e) {\n\t\t\tres.writeHead(404);\n\t\t\tres.end();\n\t\t}\n\t},\n\n\tasync copy(file, out) {\n\t\tif (!this.store) {\n\t\t\treturn;\n\t\t}\n\t\tconst filePath = await this.store.getFilePath(file._id, file);\n\t\ttry {\n\t\t\tconst stat = await fsp.stat(filePath);\n\n\t\t\tif (stat?.isFile()) {\n\t\t\t\tfile = FileUpload.addExtensionTo(file);\n\n\t\t\t\t(await this.store.getReadStream(file._id, file)).pipe(out);\n\t\t\t}\n\t\t} catch (e) {\n\t\t\tout.end();\n\t\t}\n\t},\n});\n\nconst FileSystemAvatars = new FileUploadClass({\n\tname: 'FileSystem:Avatars',\n\t// store setted bellow\n\n\tasync get(file, _req, res) {\n\t\tif (!this.store) {\n\t\t\treturn;\n\t\t}\n\t\tconst filePath = await this.store.getFilePath(file._id, file);\n\n\t\ttry {\n\t\t\tconst stat = await fsp.stat(filePath);\n\n\t\t\tif (stat?.isFile()) {\n\t\t\t\tfile = FileUpload.addExtensionTo(file);\n\n\t\t\t\t(await this.store.getReadStream(file._id, file)).pipe(res);\n\t\t\t}\n\t\t} catch (e) {\n\t\t\tres.writeHead(404);\n\t\t\tres.end();\n\t\t}\n\t},\n});\n\nconst FileSystemUserDataFiles = new FileUploadClass({\n\tname: 'FileSystem:UserDataFiles',\n\n\tasync get(file, _req, res) {\n\t\tif (!this.store) {\n\t\t\treturn;\n\t\t}\n\t\tconst filePath = await this.store.getFilePath(file._id, file);\n\n\t\ttry {\n\t\t\tconst stat = await fsp.stat(filePath);\n\n\t\t\tif (stat?.isFile()) {\n\t\t\t\tfile = FileUpload.addExtensionTo(file);\n\t\t\t\tres.setHeader('Content-Disposition', `attachment; filename*=UTF-8''${encodeURIComponent(file.name || '')}`);\n\t\t\t\tfile.uploadedAt && res.setHeader('Last-Modified', file.uploadedAt.toUTCString());\n\t\t\t\tres.setHeader('Content-Type', file.type || '');\n\t\t\t\tres.setHeader('Content-Length', file.size || 0);\n\n\t\t\t\t(await this.store.getReadStream(file._id, file)).pipe(res);\n\t\t\t}\n\t\t} catch (e) {\n\t\t\tres.writeHead(404);\n\t\t\tres.end();\n\t\t}\n\t},\n});\n\nsettings.watch('FileUpload_FileSystemPath', () => {\n\tconst options = {\n\t\tpath: settings.get('FileUpload_FileSystemPath'), // '/tmp/uploads/photos',\n\t};\n\n\tFileSystemUploads.store = FileUpload.configureUploadsStore('Local', FileSystemUploads.name, options);\n\tFileSystemAvatars.store = FileUpload.configureUploadsStore('Local', FileSystemAvatars.name, options);\n\tFileSystemUserDataFiles.store = FileUpload.configureUploadsStore('Local', FileSystemUserDataFiles.name, options);\n\n\t// DEPRECATED backwards compatibility (remove)\n\tUploadFS.getStores().fileSystem = UploadFS.getStores()[FileSystemUploads.name];\n});\n"],"mappings":"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","ignoreList":[]},"sourceType":"module","externalDependencies":{},"hash":"db1536064066fa1a2ddb4e588473948b891f1c26"}
