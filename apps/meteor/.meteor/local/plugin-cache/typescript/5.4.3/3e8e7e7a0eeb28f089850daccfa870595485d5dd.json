{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/app/integrations/server/methods/outgoing/updateOutgoingIntegration.ts","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","topLevelAwait","objectRestSpread","objectRestSpread","asyncGenerators","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"os.osx.arm64"},"sourceFileName":"app/integrations/server/methods/outgoing/updateOutgoingIntegration.ts","filename":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/app/integrations/server/methods/outgoing/updateOutgoingIntegration.ts","inputSourceMap":{"version":3,"file":"app/integrations/server/methods/outgoing/updateOutgoingIntegration.ts","sourceRoot":"","sources":["app/integrations/server/methods/outgoing/updateOutgoingIntegration.ts"],"names":[],"mappings":"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","sourcesContent":["import type { IIntegration, INewOutgoingIntegration, IUpdateOutgoingIntegration } from '@rocket.chat/core-typings';\nimport type { ServerMethods } from '@rocket.chat/ddp-client';\nimport { Integrations, Users } from '@rocket.chat/models';\nimport { wrapExceptions } from '@rocket.chat/tools';\nimport { Meteor } from 'meteor/meteor';\n\nimport { hasPermissionAsync } from '../../../../authorization/server/functions/hasPermission';\nimport { notifyOnIntegrationChanged } from '../../../../lib/server/lib/notifyListener';\nimport { validateOutgoingIntegration } from '../../lib/validateOutgoingIntegration';\nimport { isScriptEngineFrozen, validateScriptEngine } from '../../lib/validateScriptEngine';\n\ndeclare module '@rocket.chat/ddp-client' {\n\t// eslint-disable-next-line @typescript-eslint/naming-convention\n\tinterface ServerMethods {\n\t\tupdateOutgoingIntegration(\n\t\t\tintegrationId: string,\n\t\t\tintegration: INewOutgoingIntegration | IUpdateOutgoingIntegration,\n\t\t): IIntegration | null;\n\t}\n}\n\nMeteor.methods<ServerMethods>({\n\tasync updateOutgoingIntegration(integrationId, _integration) {\n\t\tif (!this.userId) {\n\t\t\tthrow new Meteor.Error('error-invalid-user', 'Invalid user', {\n\t\t\t\tmethod: 'updateOutgoingIntegration',\n\t\t\t});\n\t\t}\n\n\t\tconst integration = await validateOutgoingIntegration(_integration, this.userId);\n\n\t\tif (!integration.token || integration.token.trim() === '') {\n\t\t\tthrow new Meteor.Error('error-invalid-token', 'Invalid token', {\n\t\t\t\tmethod: 'updateOutgoingIntegration',\n\t\t\t});\n\t\t}\n\n\t\tlet currentIntegration: IIntegration | null;\n\n\t\tif (await hasPermissionAsync(this.userId, 'manage-outgoing-integrations')) {\n\t\t\tcurrentIntegration = await Integrations.findOneById(integrationId);\n\t\t} else if (await hasPermissionAsync(this.userId, 'manage-own-outgoing-integrations')) {\n\t\t\tcurrentIntegration = await Integrations.findOne({\n\t\t\t\t'_id': integrationId,\n\t\t\t\t'_createdBy._id': this.userId,\n\t\t\t});\n\t\t} else {\n\t\t\tthrow new Meteor.Error('not_authorized', 'Unauthorized', {\n\t\t\t\tmethod: 'updateOutgoingIntegration',\n\t\t\t});\n\t\t}\n\n\t\tif (!currentIntegration) {\n\t\t\tthrow new Meteor.Error('invalid_integration', '[methods] updateOutgoingIntegration -> integration not found');\n\t\t}\n\n\t\tconst oldScriptEngine = currentIntegration.scriptEngine;\n\t\tconst scriptEngine = integration.scriptEngine ?? oldScriptEngine ?? 'isolated-vm';\n\t\tif (\n\t\t\tintegration.script?.trim() &&\n\t\t\t(scriptEngine !== oldScriptEngine || integration.script?.trim() !== currentIntegration.script?.trim())\n\t\t) {\n\t\t\twrapExceptions(() => validateScriptEngine(scriptEngine)).catch((e) => {\n\t\t\t\tthrow new Meteor.Error(e.message);\n\t\t\t});\n\t\t}\n\n\t\tconst isFrozen = isScriptEngineFrozen(scriptEngine);\n\n\t\tconst updatedIntegration = await Integrations.findOneAndUpdate(\n\t\t\t{ _id: integrationId },\n\t\t\t{\n\t\t\t\t$set: {\n\t\t\t\t\tevent: integration.event,\n\t\t\t\t\tenabled: integration.enabled,\n\t\t\t\t\tname: integration.name,\n\t\t\t\t\tavatar: integration.avatar,\n\t\t\t\t\temoji: integration.emoji,\n\t\t\t\t\talias: integration.alias,\n\t\t\t\t\tchannel: typeof integration.channel === 'string' ? [integration.channel] : integration.channel,\n\t\t\t\t\ttargetRoom: integration.targetRoom,\n\t\t\t\t\timpersonateUser: integration.impersonateUser,\n\t\t\t\t\tusername: integration.username,\n\t\t\t\t\tuserId: integration.userId,\n\t\t\t\t\turls: integration.urls,\n\t\t\t\t\ttoken: integration.token,\n\t\t\t\t\t...(isFrozen\n\t\t\t\t\t\t? {}\n\t\t\t\t\t\t: {\n\t\t\t\t\t\t\t\tscript: integration.script,\n\t\t\t\t\t\t\t\tscriptEnabled: integration.scriptEnabled,\n\t\t\t\t\t\t\t\tscriptEngine,\n\t\t\t\t\t\t\t\t...(integration.scriptCompiled ? { scriptCompiled: integration.scriptCompiled } : { scriptError: integration.scriptError }),\n\t\t\t\t\t\t\t}),\n\t\t\t\t\ttriggerWords: integration.triggerWords,\n\t\t\t\t\tretryFailedCalls: integration.retryFailedCalls,\n\t\t\t\t\tretryCount: integration.retryCount,\n\t\t\t\t\tretryDelay: integration.retryDelay,\n\t\t\t\t\ttriggerWordAnywhere: integration.triggerWordAnywhere,\n\t\t\t\t\trunOnEdits: integration.runOnEdits,\n\t\t\t\t\t_updatedAt: new Date(),\n\t\t\t\t\t_updatedBy: await Users.findOne({ _id: this.userId }, { projection: { username: 1 } }),\n\t\t\t\t},\n\t\t\t\t...(isFrozen\n\t\t\t\t\t? {}\n\t\t\t\t\t: {\n\t\t\t\t\t\t\t$unset: {\n\t\t\t\t\t\t\t\t...(integration.scriptCompiled ? { scriptError: 1 as const } : { scriptCompiled: 1 as const }),\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t}),\n\t\t\t},\n\t\t);\n\n\t\tif (updatedIntegration.value) {\n\t\t\tawait notifyOnIntegrationChanged(updatedIntegration.value);\n\t\t}\n\n\t\treturn updatedIntegration.value;\n\t},\n});\n"]},"targets":{"android":"125.0.0","chrome":"125.0.0","edge":"125.0.0","firefox":"115.0.0","ie":"10.0.0","ios":"17.4.0","opera":"110.0.0","opera_mobile":"80.0.0","safari":"17.4.0","samsung":"24.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor","root":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":false,"enforceStrictMode":false,"dynamicImport":true,"generateLetDeclarations":true,"topLevelAwait":true},"externalDependencies":[]},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"version":"7.17.2","helpers":true,"useESModules":false,"corejs":false},"externalDependencies":[]},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-async-generator-functions","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-class-properties","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true},"externalDependencies":[]},{"key":"transform-react-jsx","visitor":{"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXFragment":{"exit":[null]},"JSXElement":{"exit":[null]},"JSXAttribute":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false},"externalDependencies":[]},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-nullish-coalescing-operator","visitor":{"LogicalExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-optional-chaining","visitor":{"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-optional-catch-binding","visitor":{"CatchClause":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-class-properties","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-async-generator-functions","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-logical-assignment-operators","visitor":{"AssignmentExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]}],"presets":[],"generatorOpts":{"filename":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/app/integrations/server/methods/outgoing/updateOutgoingIntegration.ts","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"app/integrations/server/methods/outgoing/updateOutgoingIntegration.ts","inputSourceMap":{"version":3,"file":"app/integrations/server/methods/outgoing/updateOutgoingIntegration.ts","sourceRoot":"","sources":["app/integrations/server/methods/outgoing/updateOutgoingIntegration.ts"],"names":[],"mappings":"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","sourcesContent":["import type { IIntegration, INewOutgoingIntegration, IUpdateOutgoingIntegration } from '@rocket.chat/core-typings';\nimport type { ServerMethods } from '@rocket.chat/ddp-client';\nimport { Integrations, Users } from '@rocket.chat/models';\nimport { wrapExceptions } from '@rocket.chat/tools';\nimport { Meteor } from 'meteor/meteor';\n\nimport { hasPermissionAsync } from '../../../../authorization/server/functions/hasPermission';\nimport { notifyOnIntegrationChanged } from '../../../../lib/server/lib/notifyListener';\nimport { validateOutgoingIntegration } from '../../lib/validateOutgoingIntegration';\nimport { isScriptEngineFrozen, validateScriptEngine } from '../../lib/validateScriptEngine';\n\ndeclare module '@rocket.chat/ddp-client' {\n\t// eslint-disable-next-line @typescript-eslint/naming-convention\n\tinterface ServerMethods {\n\t\tupdateOutgoingIntegration(\n\t\t\tintegrationId: string,\n\t\t\tintegration: INewOutgoingIntegration | IUpdateOutgoingIntegration,\n\t\t): IIntegration | null;\n\t}\n}\n\nMeteor.methods<ServerMethods>({\n\tasync updateOutgoingIntegration(integrationId, _integration) {\n\t\tif (!this.userId) {\n\t\t\tthrow new Meteor.Error('error-invalid-user', 'Invalid user', {\n\t\t\t\tmethod: 'updateOutgoingIntegration',\n\t\t\t});\n\t\t}\n\n\t\tconst integration = await validateOutgoingIntegration(_integration, this.userId);\n\n\t\tif (!integration.token || integration.token.trim() === '') {\n\t\t\tthrow new Meteor.Error('error-invalid-token', 'Invalid token', {\n\t\t\t\tmethod: 'updateOutgoingIntegration',\n\t\t\t});\n\t\t}\n\n\t\tlet currentIntegration: IIntegration | null;\n\n\t\tif (await hasPermissionAsync(this.userId, 'manage-outgoing-integrations')) {\n\t\t\tcurrentIntegration = await Integrations.findOneById(integrationId);\n\t\t} else if (await hasPermissionAsync(this.userId, 'manage-own-outgoing-integrations')) {\n\t\t\tcurrentIntegration = await Integrations.findOne({\n\t\t\t\t'_id': integrationId,\n\t\t\t\t'_createdBy._id': this.userId,\n\t\t\t});\n\t\t} else {\n\t\t\tthrow new Meteor.Error('not_authorized', 'Unauthorized', {\n\t\t\t\tmethod: 'updateOutgoingIntegration',\n\t\t\t});\n\t\t}\n\n\t\tif (!currentIntegration) {\n\t\t\tthrow new Meteor.Error('invalid_integration', '[methods] updateOutgoingIntegration -> integration not found');\n\t\t}\n\n\t\tconst oldScriptEngine = currentIntegration.scriptEngine;\n\t\tconst scriptEngine = integration.scriptEngine ?? oldScriptEngine ?? 'isolated-vm';\n\t\tif (\n\t\t\tintegration.script?.trim() &&\n\t\t\t(scriptEngine !== oldScriptEngine || integration.script?.trim() !== currentIntegration.script?.trim())\n\t\t) {\n\t\t\twrapExceptions(() => validateScriptEngine(scriptEngine)).catch((e) => {\n\t\t\t\tthrow new Meteor.Error(e.message);\n\t\t\t});\n\t\t}\n\n\t\tconst isFrozen = isScriptEngineFrozen(scriptEngine);\n\n\t\tconst updatedIntegration = await Integrations.findOneAndUpdate(\n\t\t\t{ _id: integrationId },\n\t\t\t{\n\t\t\t\t$set: {\n\t\t\t\t\tevent: integration.event,\n\t\t\t\t\tenabled: integration.enabled,\n\t\t\t\t\tname: integration.name,\n\t\t\t\t\tavatar: integration.avatar,\n\t\t\t\t\temoji: integration.emoji,\n\t\t\t\t\talias: integration.alias,\n\t\t\t\t\tchannel: typeof integration.channel === 'string' ? [integration.channel] : integration.channel,\n\t\t\t\t\ttargetRoom: integration.targetRoom,\n\t\t\t\t\timpersonateUser: integration.impersonateUser,\n\t\t\t\t\tusername: integration.username,\n\t\t\t\t\tuserId: integration.userId,\n\t\t\t\t\turls: integration.urls,\n\t\t\t\t\ttoken: integration.token,\n\t\t\t\t\t...(isFrozen\n\t\t\t\t\t\t? {}\n\t\t\t\t\t\t: {\n\t\t\t\t\t\t\t\tscript: integration.script,\n\t\t\t\t\t\t\t\tscriptEnabled: integration.scriptEnabled,\n\t\t\t\t\t\t\t\tscriptEngine,\n\t\t\t\t\t\t\t\t...(integration.scriptCompiled ? { scriptCompiled: integration.scriptCompiled } : { scriptError: integration.scriptError }),\n\t\t\t\t\t\t\t}),\n\t\t\t\t\ttriggerWords: integration.triggerWords,\n\t\t\t\t\tretryFailedCalls: integration.retryFailedCalls,\n\t\t\t\t\tretryCount: integration.retryCount,\n\t\t\t\t\tretryDelay: integration.retryDelay,\n\t\t\t\t\ttriggerWordAnywhere: integration.triggerWordAnywhere,\n\t\t\t\t\trunOnEdits: integration.runOnEdits,\n\t\t\t\t\t_updatedAt: new Date(),\n\t\t\t\t\t_updatedBy: await Users.findOne({ _id: this.userId }, { projection: { username: 1 } }),\n\t\t\t\t},\n\t\t\t\t...(isFrozen\n\t\t\t\t\t? {}\n\t\t\t\t\t: {\n\t\t\t\t\t\t\t$unset: {\n\t\t\t\t\t\t\t\t...(integration.scriptCompiled ? { scriptError: 1 as const } : { scriptCompiled: 1 as const }),\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t}),\n\t\t\t},\n\t\t);\n\n\t\tif (updatedIntegration.value) {\n\t\t\tawait notifyOnIntegrationChanged(updatedIntegration.value);\n\t\t}\n\n\t\treturn updatedIntegration.value;\n\t},\n});\n"]}}},"code":"!module.wrapAsync(async function (module, __reifyWaitForDeps__, __reify_async_result__) {\n  \"use strict\";\n  try {\n    let _objectSpread;\n    module.link(\"@babel/runtime/helpers/objectSpread2\", {\n      default(v) {\n        _objectSpread = v;\n      }\n    }, 0);\n    let Integrations, Users;\n    module.link(\"@rocket.chat/models\", {\n      Integrations(v) {\n        Integrations = v;\n      },\n      Users(v) {\n        Users = v;\n      }\n    }, 0);\n    let wrapExceptions;\n    module.link(\"@rocket.chat/tools\", {\n      wrapExceptions(v) {\n        wrapExceptions = v;\n      }\n    }, 1);\n    let Meteor;\n    module.link(\"meteor/meteor\", {\n      Meteor(v) {\n        Meteor = v;\n      }\n    }, 2);\n    let hasPermissionAsync;\n    module.link(\"../../../../authorization/server/functions/hasPermission\", {\n      hasPermissionAsync(v) {\n        hasPermissionAsync = v;\n      }\n    }, 3);\n    let notifyOnIntegrationChanged;\n    module.link(\"../../../../lib/server/lib/notifyListener\", {\n      notifyOnIntegrationChanged(v) {\n        notifyOnIntegrationChanged = v;\n      }\n    }, 4);\n    let validateOutgoingIntegration;\n    module.link(\"../../lib/validateOutgoingIntegration\", {\n      validateOutgoingIntegration(v) {\n        validateOutgoingIntegration = v;\n      }\n    }, 5);\n    let isScriptEngineFrozen, validateScriptEngine;\n    module.link(\"../../lib/validateScriptEngine\", {\n      isScriptEngineFrozen(v) {\n        isScriptEngineFrozen = v;\n      },\n      validateScriptEngine(v) {\n        validateScriptEngine = v;\n      }\n    }, 6);\n    if (__reifyWaitForDeps__()) (await __reifyWaitForDeps__())();\n    Meteor.methods({\n      async updateOutgoingIntegration(integrationId, _integration) {\n        var _ref, _integration$scriptEn, _integration$script, _integration$script2, _currentIntegration$s;\n        if (!this.userId) {\n          throw new Meteor.Error('error-invalid-user', 'Invalid user', {\n            method: 'updateOutgoingIntegration'\n          });\n        }\n        const integration = await validateOutgoingIntegration(_integration, this.userId);\n        if (!integration.token || integration.token.trim() === '') {\n          throw new Meteor.Error('error-invalid-token', 'Invalid token', {\n            method: 'updateOutgoingIntegration'\n          });\n        }\n        let currentIntegration;\n        if (await hasPermissionAsync(this.userId, 'manage-outgoing-integrations')) {\n          currentIntegration = await Integrations.findOneById(integrationId);\n        } else if (await hasPermissionAsync(this.userId, 'manage-own-outgoing-integrations')) {\n          currentIntegration = await Integrations.findOne({\n            '_id': integrationId,\n            '_createdBy._id': this.userId\n          });\n        } else {\n          throw new Meteor.Error('not_authorized', 'Unauthorized', {\n            method: 'updateOutgoingIntegration'\n          });\n        }\n        if (!currentIntegration) {\n          throw new Meteor.Error('invalid_integration', '[methods] updateOutgoingIntegration -> integration not found');\n        }\n        const oldScriptEngine = currentIntegration.scriptEngine;\n        const scriptEngine = (_ref = (_integration$scriptEn = integration.scriptEngine) !== null && _integration$scriptEn !== void 0 ? _integration$scriptEn : oldScriptEngine) !== null && _ref !== void 0 ? _ref : 'isolated-vm';\n        if ((_integration$script = integration.script) !== null && _integration$script !== void 0 && _integration$script.trim() && (scriptEngine !== oldScriptEngine || ((_integration$script2 = integration.script) === null || _integration$script2 === void 0 ? void 0 : _integration$script2.trim()) !== ((_currentIntegration$s = currentIntegration.script) === null || _currentIntegration$s === void 0 ? void 0 : _currentIntegration$s.trim()))) {\n          wrapExceptions(() => validateScriptEngine(scriptEngine)).catch(e => {\n            throw new Meteor.Error(e.message);\n          });\n        }\n        const isFrozen = isScriptEngineFrozen(scriptEngine);\n        const updatedIntegration = await Integrations.findOneAndUpdate({\n          _id: integrationId\n        }, _objectSpread({\n          $set: _objectSpread(_objectSpread({\n            event: integration.event,\n            enabled: integration.enabled,\n            name: integration.name,\n            avatar: integration.avatar,\n            emoji: integration.emoji,\n            alias: integration.alias,\n            channel: typeof integration.channel === 'string' ? [integration.channel] : integration.channel,\n            targetRoom: integration.targetRoom,\n            impersonateUser: integration.impersonateUser,\n            username: integration.username,\n            userId: integration.userId,\n            urls: integration.urls,\n            token: integration.token\n          }, isFrozen ? {} : _objectSpread({\n            script: integration.script,\n            scriptEnabled: integration.scriptEnabled,\n            scriptEngine\n          }, integration.scriptCompiled ? {\n            scriptCompiled: integration.scriptCompiled\n          } : {\n            scriptError: integration.scriptError\n          })), {}, {\n            triggerWords: integration.triggerWords,\n            retryFailedCalls: integration.retryFailedCalls,\n            retryCount: integration.retryCount,\n            retryDelay: integration.retryDelay,\n            triggerWordAnywhere: integration.triggerWordAnywhere,\n            runOnEdits: integration.runOnEdits,\n            _updatedAt: new Date(),\n            _updatedBy: await Users.findOne({\n              _id: this.userId\n            }, {\n              projection: {\n                username: 1\n              }\n            })\n          })\n        }, isFrozen ? {} : {\n          $unset: _objectSpread({}, integration.scriptCompiled ? {\n            scriptError: 1\n          } : {\n            scriptCompiled: 1\n          })\n        }));\n        if (updatedIntegration.value) {\n          await notifyOnIntegrationChanged(updatedIntegration.value);\n        }\n        return updatedIntegration.value;\n      }\n    });\n    __reify_async_result__();\n  } catch (_reifyError) {\n    return __reify_async_result__(_reifyError);\n  }\n  __reify_async_result__()\n}, {\n  self: this,\n  async: false\n});","map":{"version":3,"names":["_objectSpread","module","link","default","v","Integrations","Users","wrapExceptions","Meteor","hasPermissionAsync","notifyOnIntegrationChanged","validateOutgoingIntegration","isScriptEngineFrozen","validateScriptEngine","__reifyWaitForDeps__","methods","updateOutgoingIntegration","integrationId","_integration","_ref","_integration$scriptEn","_integration$script","_integration$script2","_currentIntegration$s","userId","Error","method","integration","token","trim","currentIntegration","findOneById","findOne","oldScriptEngine","scriptEngine","script","catch","e","message","isFrozen","updatedIntegration","findOneAndUpdate","_id","$set","event","enabled","name","avatar","emoji","alias","channel","targetRoom","impersonateUser","username","urls","scriptEnabled","scriptCompiled","scriptError","triggerWords","retryFailedCalls","retryCount","retryDelay","triggerWordAnywhere","runOnEdits","_updatedAt","Date","_updatedBy","projection","$unset","value","__reify_async_result__","_reifyError","self","async"],"sources":["app/integrations/server/methods/outgoing/updateOutgoingIntegration.ts"],"sourcesContent":["import type { IIntegration, INewOutgoingIntegration, IUpdateOutgoingIntegration } from '@rocket.chat/core-typings';\nimport type { ServerMethods } from '@rocket.chat/ddp-client';\nimport { Integrations, Users } from '@rocket.chat/models';\nimport { wrapExceptions } from '@rocket.chat/tools';\nimport { Meteor } from 'meteor/meteor';\n\nimport { hasPermissionAsync } from '../../../../authorization/server/functions/hasPermission';\nimport { notifyOnIntegrationChanged } from '../../../../lib/server/lib/notifyListener';\nimport { validateOutgoingIntegration } from '../../lib/validateOutgoingIntegration';\nimport { isScriptEngineFrozen, validateScriptEngine } from '../../lib/validateScriptEngine';\n\ndeclare module '@rocket.chat/ddp-client' {\n\t// eslint-disable-next-line @typescript-eslint/naming-convention\n\tinterface ServerMethods {\n\t\tupdateOutgoingIntegration(\n\t\t\tintegrationId: string,\n\t\t\tintegration: INewOutgoingIntegration | IUpdateOutgoingIntegration,\n\t\t): IIntegration | null;\n\t}\n}\n\nMeteor.methods<ServerMethods>({\n\tasync updateOutgoingIntegration(integrationId, _integration) {\n\t\tif (!this.userId) {\n\t\t\tthrow new Meteor.Error('error-invalid-user', 'Invalid user', {\n\t\t\t\tmethod: 'updateOutgoingIntegration',\n\t\t\t});\n\t\t}\n\n\t\tconst integration = await validateOutgoingIntegration(_integration, this.userId);\n\n\t\tif (!integration.token || integration.token.trim() === '') {\n\t\t\tthrow new Meteor.Error('error-invalid-token', 'Invalid token', {\n\t\t\t\tmethod: 'updateOutgoingIntegration',\n\t\t\t});\n\t\t}\n\n\t\tlet currentIntegration: IIntegration | null;\n\n\t\tif (await hasPermissionAsync(this.userId, 'manage-outgoing-integrations')) {\n\t\t\tcurrentIntegration = await Integrations.findOneById(integrationId);\n\t\t} else if (await hasPermissionAsync(this.userId, 'manage-own-outgoing-integrations')) {\n\t\t\tcurrentIntegration = await Integrations.findOne({\n\t\t\t\t'_id': integrationId,\n\t\t\t\t'_createdBy._id': this.userId,\n\t\t\t});\n\t\t} else {\n\t\t\tthrow new Meteor.Error('not_authorized', 'Unauthorized', {\n\t\t\t\tmethod: 'updateOutgoingIntegration',\n\t\t\t});\n\t\t}\n\n\t\tif (!currentIntegration) {\n\t\t\tthrow new Meteor.Error('invalid_integration', '[methods] updateOutgoingIntegration -> integration not found');\n\t\t}\n\n\t\tconst oldScriptEngine = currentIntegration.scriptEngine;\n\t\tconst scriptEngine = integration.scriptEngine ?? oldScriptEngine ?? 'isolated-vm';\n\t\tif (\n\t\t\tintegration.script?.trim() &&\n\t\t\t(scriptEngine !== oldScriptEngine || integration.script?.trim() !== currentIntegration.script?.trim())\n\t\t) {\n\t\t\twrapExceptions(() => validateScriptEngine(scriptEngine)).catch((e) => {\n\t\t\t\tthrow new Meteor.Error(e.message);\n\t\t\t});\n\t\t}\n\n\t\tconst isFrozen = isScriptEngineFrozen(scriptEngine);\n\n\t\tconst updatedIntegration = await Integrations.findOneAndUpdate(\n\t\t\t{ _id: integrationId },\n\t\t\t{\n\t\t\t\t$set: {\n\t\t\t\t\tevent: integration.event,\n\t\t\t\t\tenabled: integration.enabled,\n\t\t\t\t\tname: integration.name,\n\t\t\t\t\tavatar: integration.avatar,\n\t\t\t\t\temoji: integration.emoji,\n\t\t\t\t\talias: integration.alias,\n\t\t\t\t\tchannel: typeof integration.channel === 'string' ? [integration.channel] : integration.channel,\n\t\t\t\t\ttargetRoom: integration.targetRoom,\n\t\t\t\t\timpersonateUser: integration.impersonateUser,\n\t\t\t\t\tusername: integration.username,\n\t\t\t\t\tuserId: integration.userId,\n\t\t\t\t\turls: integration.urls,\n\t\t\t\t\ttoken: integration.token,\n\t\t\t\t\t...(isFrozen\n\t\t\t\t\t\t? {}\n\t\t\t\t\t\t: {\n\t\t\t\t\t\t\t\tscript: integration.script,\n\t\t\t\t\t\t\t\tscriptEnabled: integration.scriptEnabled,\n\t\t\t\t\t\t\t\tscriptEngine,\n\t\t\t\t\t\t\t\t...(integration.scriptCompiled ? { scriptCompiled: integration.scriptCompiled } : { scriptError: integration.scriptError }),\n\t\t\t\t\t\t\t}),\n\t\t\t\t\ttriggerWords: integration.triggerWords,\n\t\t\t\t\tretryFailedCalls: integration.retryFailedCalls,\n\t\t\t\t\tretryCount: integration.retryCount,\n\t\t\t\t\tretryDelay: integration.retryDelay,\n\t\t\t\t\ttriggerWordAnywhere: integration.triggerWordAnywhere,\n\t\t\t\t\trunOnEdits: integration.runOnEdits,\n\t\t\t\t\t_updatedAt: new Date(),\n\t\t\t\t\t_updatedBy: await Users.findOne({ _id: this.userId }, { projection: { username: 1 } }),\n\t\t\t\t},\n\t\t\t\t...(isFrozen\n\t\t\t\t\t? {}\n\t\t\t\t\t: {\n\t\t\t\t\t\t\t$unset: {\n\t\t\t\t\t\t\t\t...(integration.scriptCompiled ? { scriptError: 1 as const } : { scriptCompiled: 1 as const }),\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t}),\n\t\t\t},\n\t\t);\n\n\t\tif (updatedIntegration.value) {\n\t\t\tawait notifyOnIntegrationChanged(updatedIntegration.value);\n\t\t}\n\n\t\treturn updatedIntegration.value;\n\t},\n});\n"],"mappings":"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","ignoreList":[]},"sourceType":"module","externalDependencies":{},"hash":"3e8e7e7a0eeb28f089850daccfa870595485d5dd"}
