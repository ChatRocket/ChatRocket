{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/client/providers/UserProvider/UserProvider.tsx","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","topLevelAwait","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"web.browser.legacy"},"sourceFileName":"client/providers/UserProvider/UserProvider.tsx","filename":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/client/providers/UserProvider/UserProvider.tsx","inputSourceMap":{"version":3,"file":"client/providers/UserProvider/UserProvider.tsx","sourceRoot":"","sources":["client/providers/UserProvider/UserProvider.tsx"],"names":[],"mappings":"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","sourcesContent":["import type { IRoom, ISubscription, IUser } from '@rocket.chat/core-typings';\nimport { useLocalStorage } from '@rocket.chat/fuselage-hooks';\nimport type { SubscriptionWithRoom } from '@rocket.chat/ui-contexts';\nimport { UserContext, useEndpoint } from '@rocket.chat/ui-contexts';\nimport { Meteor } from 'meteor/meteor';\nimport type { ContextType, ReactElement, ReactNode } from 'react';\nimport React, { useEffect, useMemo, useRef } from 'react';\n\nimport { Subscriptions, ChatRoom } from '../../../app/models/client';\nimport { getUserPreference } from '../../../app/utils/client';\nimport { sdk } from '../../../app/utils/client/lib/SDKClient';\nimport { afterLogoutCleanUpCallback } from '../../../lib/callbacks/afterLogoutCleanUpCallback';\nimport { useReactiveValue } from '../../hooks/useReactiveValue';\nimport { createReactiveSubscriptionFactory } from '../../lib/createReactiveSubscriptionFactory';\nimport { queryClient } from '../../lib/queryClient';\nimport { useCreateFontStyleElement } from '../../views/account/accessibility/hooks/useCreateFontStyleElement';\nimport { useClearRemovedRoomsHistory } from './hooks/useClearRemovedRoomsHistory';\nimport { useDeleteUser } from './hooks/useDeleteUser';\nimport { useEmailVerificationWarning } from './hooks/useEmailVerificationWarning';\nimport { useUpdateAvatar } from './hooks/useUpdateAvatar';\n\nconst getUser = (): IUser | null => Meteor.user() as IUser | null;\n\nconst getUserId = (): string | null => Meteor.userId();\n\nconst logout = (): Promise<void> =>\n\tnew Promise((resolve, reject) => {\n\t\tconst user = getUser();\n\n\t\tif (!user) {\n\t\t\treturn resolve();\n\t\t}\n\n\t\tMeteor.logout(async () => {\n\t\t\tawait afterLogoutCleanUpCallback.run(user);\n\t\t\tsdk.call('logoutCleanUp', user).then(resolve, reject);\n\t\t});\n\t});\n\ntype UserProviderProps = {\n\tchildren: ReactNode;\n};\n\nconst UserProvider = ({ children }: UserProviderProps): ReactElement => {\n\tconst user = useReactiveValue(getUser);\n\tconst userId = useReactiveValue(getUserId);\n\tconst previousUserId = useRef(userId);\n\tconst [userLanguage, setUserLanguage] = useLocalStorage('userLanguage', '');\n\tconst [preferedLanguage, setPreferedLanguage] = useLocalStorage('preferedLanguage', '');\n\n\tconst setUserPreferences = useEndpoint('POST', '/v1/users.setPreferences');\n\n\tconst createFontStyleElement = useCreateFontStyleElement();\n\tcreateFontStyleElement(user?.settings?.preferences?.fontSize);\n\n\tuseEmailVerificationWarning(user ?? undefined);\n\tuseClearRemovedRoomsHistory(userId);\n\n\tuseDeleteUser();\n\tuseUpdateAvatar();\n\n\tconst contextValue = useMemo(\n\t\t(): ContextType<typeof UserContext> => ({\n\t\t\tuserId,\n\t\t\tuser,\n\t\t\tqueryPreference: createReactiveSubscriptionFactory(\n\t\t\t\t<T,>(key: string, defaultValue?: T) => getUserPreference(userId, key, defaultValue) as T,\n\t\t\t),\n\t\t\tquerySubscription: createReactiveSubscriptionFactory<ISubscription | undefined>((query, fields, sort) =>\n\t\t\t\tSubscriptions.findOne(query, { fields, sort }),\n\t\t\t),\n\t\t\tqueryRoom: createReactiveSubscriptionFactory<IRoom | undefined>((query, fields) => ChatRoom.findOne(query, { fields })),\n\t\t\tquerySubscriptions: createReactiveSubscriptionFactory<SubscriptionWithRoom[]>((query, options) => {\n\t\t\t\tif (userId) {\n\t\t\t\t\treturn Subscriptions.find(query, options).fetch();\n\t\t\t\t}\n\n\t\t\t\treturn ChatRoom.find(query, options).fetch();\n\t\t\t}),\n\t\t\tlogout,\n\t\t}),\n\t\t[userId, user],\n\t);\n\n\tuseEffect(() => {\n\t\tif (!!userId && preferedLanguage !== userLanguage) {\n\t\t\tsetUserPreferences({ data: { language: preferedLanguage } });\n\t\t\tsetUserLanguage(preferedLanguage);\n\t\t}\n\n\t\tif (user?.language !== undefined && user.language !== userLanguage) {\n\t\t\tsetUserLanguage(user.language);\n\t\t\tsetPreferedLanguage(user.language);\n\t\t}\n\t}, [preferedLanguage, setPreferedLanguage, setUserLanguage, user?.language, userLanguage, userId, setUserPreferences]);\n\n\tuseEffect(() => {\n\t\tif (previousUserId.current && previousUserId.current !== userId) {\n\t\t\tqueryClient.clear();\n\t\t}\n\n\t\tpreviousUserId.current = userId;\n\t}, [userId]);\n\n\treturn <UserContext.Provider children={children} value={contextValue} />;\n};\n\nexport default UserProvider;\n"]},"targets":{"android":"125.0.0","chrome":"125.0.0","edge":"125.0.0","firefox":"115.0.0","ie":"10.0.0","ios":"17.4.0","opera":"110.0.0","opera_mobile":"80.0.0","safari":"17.4.0","samsung":"24.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor","root":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":true,"enforceStrictMode":false,"dynamicImport":true},"externalDependencies":[]},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"version":"7.17.2","helpers":true,"useESModules":false,"corejs":false},"externalDependencies":[]},{"key":"proposal-class-properties","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true},"externalDependencies":[]},{"key":"base$0$3","visitor":{"FunctionExpression":{"exit":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"base$0$4","visitor":{"ForInStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-react-jsx","visitor":{"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXFragment":{"exit":[null]},"JSXElement":{"exit":[null]},"JSXAttribute":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false},"externalDependencies":[]},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-nullish-coalescing-operator","visitor":{"LogicalExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-optional-chaining","visitor":{"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-optional-catch-binding","visitor":{"CatchClause":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-class-properties","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-async-generator-functions","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-logical-assignment-operators","visitor":{"AssignmentExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-arrow-functions","visitor":{"ArrowFunctionExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-block-scoped-functions","visitor":{"BlockStatement":{"enter":[null]},"SwitchCase":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-block-scoping","visitor":{"VariableDeclaration":{"enter":[null,null]},"BlockStatement":{"enter":[null]},"SwitchCase":{"enter":[null]},"ClassDeclaration":{"enter":[null]},"DoWhileStatement":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForStatement":{"enter":[null]},"WhileStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-classes","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"ClassDeclaration":{"enter":[null]},"ClassExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"loose":true},"externalDependencies":[]},{"key":"transform-computed-properties","visitor":{"ObjectExpression":{"exit":[null]},"_exploded":true,"_verified":true},"options":{"loose":true},"externalDependencies":[]},{"key":"transform-destructuring","visitor":{"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"VariableDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"transform-for-of","visitor":{"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"loose":true},"externalDependencies":[]},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-object-super","visitor":{"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true,"DoWhileStatement":{"exit":[null]},"ForInStatement":{"exit":[null]},"ForStatement":{"exit":[null]},"WhileStatement":{"exit":[null]},"ForOfStatement":{"exit":[null]}},"options":{},"externalDependencies":[]},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"transform-shorthand-properties","visitor":{"ObjectMethod":{"enter":[null]},"ObjectProperty":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-spread","visitor":{"ArrayExpression":{"enter":[null]},"CallExpression":{"enter":[null]},"NewExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-sticky-regex","visitor":{"RegExpLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"loose":true},"externalDependencies":[]},{"key":"transform-typeof-symbol","visitor":{"UnaryExpression":{"enter":[null]},"_exploded":true,"_verified":true,"BlockStatement":{"enter":[null]},"CatchClause":{"enter":[null]},"DoWhileStatement":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForStatement":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"Program":{"enter":[null]},"ObjectMethod":{"enter":[null]},"SwitchStatement":{"enter":[null]},"WhileStatement":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]},"ForOfStatement":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"StaticBlock":{"enter":[null]},"TSModuleBlock":{"enter":[null]},"AssignmentPattern":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectPattern":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"transform-unicode-regex","visitor":{"RegExpLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-property-literals","visitor":{"ObjectProperty":{"exit":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-regenerator","visitor":{"ObjectMethod":{"enter":[null],"exit":[null]},"ClassMethod":{"enter":[null],"exit":[null]},"ClassPrivateMethod":{"enter":[null],"exit":[null]},"FunctionDeclaration":{"exit":[null]},"FunctionExpression":{"exit":[null]},"ArrowFunctionExpression":{"exit":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]}],"presets":[],"generatorOpts":{"filename":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/client/providers/UserProvider/UserProvider.tsx","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"client/providers/UserProvider/UserProvider.tsx","inputSourceMap":{"version":3,"file":"client/providers/UserProvider/UserProvider.tsx","sourceRoot":"","sources":["client/providers/UserProvider/UserProvider.tsx"],"names":[],"mappings":"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","sourcesContent":["import type { IRoom, ISubscription, IUser } from '@rocket.chat/core-typings';\nimport { useLocalStorage } from '@rocket.chat/fuselage-hooks';\nimport type { SubscriptionWithRoom } from '@rocket.chat/ui-contexts';\nimport { UserContext, useEndpoint } from '@rocket.chat/ui-contexts';\nimport { Meteor } from 'meteor/meteor';\nimport type { ContextType, ReactElement, ReactNode } from 'react';\nimport React, { useEffect, useMemo, useRef } from 'react';\n\nimport { Subscriptions, ChatRoom } from '../../../app/models/client';\nimport { getUserPreference } from '../../../app/utils/client';\nimport { sdk } from '../../../app/utils/client/lib/SDKClient';\nimport { afterLogoutCleanUpCallback } from '../../../lib/callbacks/afterLogoutCleanUpCallback';\nimport { useReactiveValue } from '../../hooks/useReactiveValue';\nimport { createReactiveSubscriptionFactory } from '../../lib/createReactiveSubscriptionFactory';\nimport { queryClient } from '../../lib/queryClient';\nimport { useCreateFontStyleElement } from '../../views/account/accessibility/hooks/useCreateFontStyleElement';\nimport { useClearRemovedRoomsHistory } from './hooks/useClearRemovedRoomsHistory';\nimport { useDeleteUser } from './hooks/useDeleteUser';\nimport { useEmailVerificationWarning } from './hooks/useEmailVerificationWarning';\nimport { useUpdateAvatar } from './hooks/useUpdateAvatar';\n\nconst getUser = (): IUser | null => Meteor.user() as IUser | null;\n\nconst getUserId = (): string | null => Meteor.userId();\n\nconst logout = (): Promise<void> =>\n\tnew Promise((resolve, reject) => {\n\t\tconst user = getUser();\n\n\t\tif (!user) {\n\t\t\treturn resolve();\n\t\t}\n\n\t\tMeteor.logout(async () => {\n\t\t\tawait afterLogoutCleanUpCallback.run(user);\n\t\t\tsdk.call('logoutCleanUp', user).then(resolve, reject);\n\t\t});\n\t});\n\ntype UserProviderProps = {\n\tchildren: ReactNode;\n};\n\nconst UserProvider = ({ children }: UserProviderProps): ReactElement => {\n\tconst user = useReactiveValue(getUser);\n\tconst userId = useReactiveValue(getUserId);\n\tconst previousUserId = useRef(userId);\n\tconst [userLanguage, setUserLanguage] = useLocalStorage('userLanguage', '');\n\tconst [preferedLanguage, setPreferedLanguage] = useLocalStorage('preferedLanguage', '');\n\n\tconst setUserPreferences = useEndpoint('POST', '/v1/users.setPreferences');\n\n\tconst createFontStyleElement = useCreateFontStyleElement();\n\tcreateFontStyleElement(user?.settings?.preferences?.fontSize);\n\n\tuseEmailVerificationWarning(user ?? undefined);\n\tuseClearRemovedRoomsHistory(userId);\n\n\tuseDeleteUser();\n\tuseUpdateAvatar();\n\n\tconst contextValue = useMemo(\n\t\t(): ContextType<typeof UserContext> => ({\n\t\t\tuserId,\n\t\t\tuser,\n\t\t\tqueryPreference: createReactiveSubscriptionFactory(\n\t\t\t\t<T,>(key: string, defaultValue?: T) => getUserPreference(userId, key, defaultValue) as T,\n\t\t\t),\n\t\t\tquerySubscription: createReactiveSubscriptionFactory<ISubscription | undefined>((query, fields, sort) =>\n\t\t\t\tSubscriptions.findOne(query, { fields, sort }),\n\t\t\t),\n\t\t\tqueryRoom: createReactiveSubscriptionFactory<IRoom | undefined>((query, fields) => ChatRoom.findOne(query, { fields })),\n\t\t\tquerySubscriptions: createReactiveSubscriptionFactory<SubscriptionWithRoom[]>((query, options) => {\n\t\t\t\tif (userId) {\n\t\t\t\t\treturn Subscriptions.find(query, options).fetch();\n\t\t\t\t}\n\n\t\t\t\treturn ChatRoom.find(query, options).fetch();\n\t\t\t}),\n\t\t\tlogout,\n\t\t}),\n\t\t[userId, user],\n\t);\n\n\tuseEffect(() => {\n\t\tif (!!userId && preferedLanguage !== userLanguage) {\n\t\t\tsetUserPreferences({ data: { language: preferedLanguage } });\n\t\t\tsetUserLanguage(preferedLanguage);\n\t\t}\n\n\t\tif (user?.language !== undefined && user.language !== userLanguage) {\n\t\t\tsetUserLanguage(user.language);\n\t\t\tsetPreferedLanguage(user.language);\n\t\t}\n\t}, [preferedLanguage, setPreferedLanguage, setUserLanguage, user?.language, userLanguage, userId, setUserPreferences]);\n\n\tuseEffect(() => {\n\t\tif (previousUserId.current && previousUserId.current !== userId) {\n\t\t\tqueryClient.clear();\n\t\t}\n\n\t\tpreviousUserId.current = userId;\n\t}, [userId]);\n\n\treturn <UserContext.Provider children={children} value={contextValue} />;\n};\n\nexport default UserProvider;\n"]}}},"code":"var _slicedToArray;\nmodule.link(\"@babel/runtime/helpers/slicedToArray\", {\n  default: function (v) {\n    _slicedToArray = v;\n  }\n}, 0);\nvar _regeneratorRuntime;\nmodule.link(\"@babel/runtime/regenerator\", {\n  default: function (v) {\n    _regeneratorRuntime = v;\n  }\n}, 1);\nvar useLocalStorage;\nmodule.link(\"@rocket.chat/fuselage-hooks\", {\n  useLocalStorage: function (v) {\n    useLocalStorage = v;\n  }\n}, 0);\nvar UserContext, useEndpoint;\nmodule.link(\"@rocket.chat/ui-contexts\", {\n  UserContext: function (v) {\n    UserContext = v;\n  },\n  useEndpoint: function (v) {\n    useEndpoint = v;\n  }\n}, 1);\nvar Meteor;\nmodule.link(\"meteor/meteor\", {\n  Meteor: function (v) {\n    Meteor = v;\n  }\n}, 2);\nvar React, useEffect, useMemo, useRef;\nmodule.link(\"react\", {\n  \"default\": function (v) {\n    React = v;\n  },\n  useEffect: function (v) {\n    useEffect = v;\n  },\n  useMemo: function (v) {\n    useMemo = v;\n  },\n  useRef: function (v) {\n    useRef = v;\n  }\n}, 3);\nvar Subscriptions, ChatRoom;\nmodule.link(\"../../../app/models/client\", {\n  Subscriptions: function (v) {\n    Subscriptions = v;\n  },\n  ChatRoom: function (v) {\n    ChatRoom = v;\n  }\n}, 4);\nvar getUserPreference;\nmodule.link(\"../../../app/utils/client\", {\n  getUserPreference: function (v) {\n    getUserPreference = v;\n  }\n}, 5);\nvar sdk;\nmodule.link(\"../../../app/utils/client/lib/SDKClient\", {\n  sdk: function (v) {\n    sdk = v;\n  }\n}, 6);\nvar afterLogoutCleanUpCallback;\nmodule.link(\"../../../lib/callbacks/afterLogoutCleanUpCallback\", {\n  afterLogoutCleanUpCallback: function (v) {\n    afterLogoutCleanUpCallback = v;\n  }\n}, 7);\nvar useReactiveValue;\nmodule.link(\"../../hooks/useReactiveValue\", {\n  useReactiveValue: function (v) {\n    useReactiveValue = v;\n  }\n}, 8);\nvar createReactiveSubscriptionFactory;\nmodule.link(\"../../lib/createReactiveSubscriptionFactory\", {\n  createReactiveSubscriptionFactory: function (v) {\n    createReactiveSubscriptionFactory = v;\n  }\n}, 9);\nvar queryClient;\nmodule.link(\"../../lib/queryClient\", {\n  queryClient: function (v) {\n    queryClient = v;\n  }\n}, 10);\nvar useCreateFontStyleElement;\nmodule.link(\"../../views/account/accessibility/hooks/useCreateFontStyleElement\", {\n  useCreateFontStyleElement: function (v) {\n    useCreateFontStyleElement = v;\n  }\n}, 11);\nvar useClearRemovedRoomsHistory;\nmodule.link(\"./hooks/useClearRemovedRoomsHistory\", {\n  useClearRemovedRoomsHistory: function (v) {\n    useClearRemovedRoomsHistory = v;\n  }\n}, 12);\nvar useDeleteUser;\nmodule.link(\"./hooks/useDeleteUser\", {\n  useDeleteUser: function (v) {\n    useDeleteUser = v;\n  }\n}, 13);\nvar useEmailVerificationWarning;\nmodule.link(\"./hooks/useEmailVerificationWarning\", {\n  useEmailVerificationWarning: function (v) {\n    useEmailVerificationWarning = v;\n  }\n}, 14);\nvar useUpdateAvatar;\nmodule.link(\"./hooks/useUpdateAvatar\", {\n  useUpdateAvatar: function (v) {\n    useUpdateAvatar = v;\n  }\n}, 15);\nvar getUser = function () {\n  return Meteor.user();\n};\nvar getUserId = function () {\n  return Meteor.userId();\n};\nvar logout = function () {\n  return new Promise(function (resolve, reject) {\n    var user = getUser();\n    if (!user) {\n      return resolve();\n    }\n    Meteor.logout(function () {\n      function _callee() {\n        return _regeneratorRuntime.async(function () {\n          function _callee$(_context) {\n            while (1) switch (_context.prev = _context.next) {\n              case 0:\n                _context.next = 2;\n                return _regeneratorRuntime.awrap(afterLogoutCleanUpCallback.run(user));\n              case 2:\n                sdk.call('logoutCleanUp', user).then(resolve, reject);\n              case 3:\n              case \"end\":\n                return _context.stop();\n            }\n          }\n          return _callee$;\n        }(), null, null, null, Promise);\n      }\n      return _callee;\n    }());\n  });\n};\nvar UserProvider = function (_ref) {\n  var _user$settings, _user$settings$prefer;\n  var children = _ref.children;\n  var user = useReactiveValue(getUser);\n  var userId = useReactiveValue(getUserId);\n  var previousUserId = useRef(userId);\n  var _useLocalStorage = useLocalStorage('userLanguage', ''),\n    _useLocalStorage2 = _slicedToArray(_useLocalStorage, 2),\n    userLanguage = _useLocalStorage2[0],\n    setUserLanguage = _useLocalStorage2[1];\n  var _useLocalStorage3 = useLocalStorage('preferedLanguage', ''),\n    _useLocalStorage4 = _slicedToArray(_useLocalStorage3, 2),\n    preferedLanguage = _useLocalStorage4[0],\n    setPreferedLanguage = _useLocalStorage4[1];\n  var setUserPreferences = useEndpoint('POST', '/v1/users.setPreferences');\n  var createFontStyleElement = useCreateFontStyleElement();\n  createFontStyleElement(user === null || user === void 0 ? void 0 : (_user$settings = user.settings) === null || _user$settings === void 0 ? void 0 : (_user$settings$prefer = _user$settings.preferences) === null || _user$settings$prefer === void 0 ? void 0 : _user$settings$prefer.fontSize);\n  useEmailVerificationWarning(user !== null && user !== void 0 ? user : undefined);\n  useClearRemovedRoomsHistory(userId);\n  useDeleteUser();\n  useUpdateAvatar();\n  var contextValue = useMemo(function () {\n    return {\n      userId: userId,\n      user: user,\n      queryPreference: createReactiveSubscriptionFactory(function (key, defaultValue) {\n        return getUserPreference(userId, key, defaultValue);\n      }),\n      querySubscription: createReactiveSubscriptionFactory(function (query, fields, sort) {\n        return Subscriptions.findOne(query, {\n          fields: fields,\n          sort: sort\n        });\n      }),\n      queryRoom: createReactiveSubscriptionFactory(function (query, fields) {\n        return ChatRoom.findOne(query, {\n          fields: fields\n        });\n      }),\n      querySubscriptions: createReactiveSubscriptionFactory(function (query, options) {\n        if (userId) {\n          return Subscriptions.find(query, options).fetch();\n        }\n        return ChatRoom.find(query, options).fetch();\n      }),\n      logout: logout\n    };\n  }, [userId, user]);\n  useEffect(function () {\n    if (!!userId && preferedLanguage !== userLanguage) {\n      setUserPreferences({\n        data: {\n          language: preferedLanguage\n        }\n      });\n      setUserLanguage(preferedLanguage);\n    }\n    if ((user === null || user === void 0 ? void 0 : user.language) !== undefined && user.language !== userLanguage) {\n      setUserLanguage(user.language);\n      setPreferedLanguage(user.language);\n    }\n  }, [preferedLanguage, setPreferedLanguage, setUserLanguage, user === null || user === void 0 ? void 0 : user.language, userLanguage, userId, setUserPreferences]);\n  useEffect(function () {\n    if (previousUserId.current && previousUserId.current !== userId) {\n      queryClient.clear();\n    }\n    previousUserId.current = userId;\n  }, [userId]);\n  return /*#__PURE__*/React.createElement(UserContext.Provider, {\n    children: children,\n    value: contextValue\n  });\n};\nmodule.exportDefault(UserProvider);","map":{"version":3,"names":["_slicedToArray","module","link","default","v","_regeneratorRuntime","useLocalStorage","UserContext","useEndpoint","Meteor","React","useEffect","useMemo","useRef","Subscriptions","ChatRoom","getUserPreference","sdk","afterLogoutCleanUpCallback","useReactiveValue","createReactiveSubscriptionFactory","queryClient","useCreateFontStyleElement","useClearRemovedRoomsHistory","useDeleteUser","useEmailVerificationWarning","useUpdateAvatar","getUser","user","getUserId","userId","logout","Promise","resolve","reject","_callee","async","_callee$","_context","prev","next","awrap","run","call","then","stop","UserProvider","_ref","_user$settings","_user$settings$prefer","children","previousUserId","_useLocalStorage","_useLocalStorage2","userLanguage","setUserLanguage","_useLocalStorage3","_useLocalStorage4","preferedLanguage","setPreferedLanguage","setUserPreferences","createFontStyleElement","settings","preferences","fontSize","undefined","contextValue","queryPreference","key","defaultValue","querySubscription","query","fields","sort","findOne","queryRoom","querySubscriptions","options","find","fetch","data","language","current","clear","createElement","Provider","value","exportDefault"],"sources":["client/providers/UserProvider/UserProvider.tsx"],"sourcesContent":["import type { IRoom, ISubscription, IUser } from '@rocket.chat/core-typings';\nimport { useLocalStorage } from '@rocket.chat/fuselage-hooks';\nimport type { SubscriptionWithRoom } from '@rocket.chat/ui-contexts';\nimport { UserContext, useEndpoint } from '@rocket.chat/ui-contexts';\nimport { Meteor } from 'meteor/meteor';\nimport type { ContextType, ReactElement, ReactNode } from 'react';\nimport React, { useEffect, useMemo, useRef } from 'react';\n\nimport { Subscriptions, ChatRoom } from '../../../app/models/client';\nimport { getUserPreference } from '../../../app/utils/client';\nimport { sdk } from '../../../app/utils/client/lib/SDKClient';\nimport { afterLogoutCleanUpCallback } from '../../../lib/callbacks/afterLogoutCleanUpCallback';\nimport { useReactiveValue } from '../../hooks/useReactiveValue';\nimport { createReactiveSubscriptionFactory } from '../../lib/createReactiveSubscriptionFactory';\nimport { queryClient } from '../../lib/queryClient';\nimport { useCreateFontStyleElement } from '../../views/account/accessibility/hooks/useCreateFontStyleElement';\nimport { useClearRemovedRoomsHistory } from './hooks/useClearRemovedRoomsHistory';\nimport { useDeleteUser } from './hooks/useDeleteUser';\nimport { useEmailVerificationWarning } from './hooks/useEmailVerificationWarning';\nimport { useUpdateAvatar } from './hooks/useUpdateAvatar';\n\nconst getUser = (): IUser | null => Meteor.user() as IUser | null;\n\nconst getUserId = (): string | null => Meteor.userId();\n\nconst logout = (): Promise<void> =>\n\tnew Promise((resolve, reject) => {\n\t\tconst user = getUser();\n\n\t\tif (!user) {\n\t\t\treturn resolve();\n\t\t}\n\n\t\tMeteor.logout(async () => {\n\t\t\tawait afterLogoutCleanUpCallback.run(user);\n\t\t\tsdk.call('logoutCleanUp', user).then(resolve, reject);\n\t\t});\n\t});\n\ntype UserProviderProps = {\n\tchildren: ReactNode;\n};\n\nconst UserProvider = ({ children }: UserProviderProps): ReactElement => {\n\tconst user = useReactiveValue(getUser);\n\tconst userId = useReactiveValue(getUserId);\n\tconst previousUserId = useRef(userId);\n\tconst [userLanguage, setUserLanguage] = useLocalStorage('userLanguage', '');\n\tconst [preferedLanguage, setPreferedLanguage] = useLocalStorage('preferedLanguage', '');\n\n\tconst setUserPreferences = useEndpoint('POST', '/v1/users.setPreferences');\n\n\tconst createFontStyleElement = useCreateFontStyleElement();\n\tcreateFontStyleElement(user?.settings?.preferences?.fontSize);\n\n\tuseEmailVerificationWarning(user ?? undefined);\n\tuseClearRemovedRoomsHistory(userId);\n\n\tuseDeleteUser();\n\tuseUpdateAvatar();\n\n\tconst contextValue = useMemo(\n\t\t(): ContextType<typeof UserContext> => ({\n\t\t\tuserId,\n\t\t\tuser,\n\t\t\tqueryPreference: createReactiveSubscriptionFactory(\n\t\t\t\t<T,>(key: string, defaultValue?: T) => getUserPreference(userId, key, defaultValue) as T,\n\t\t\t),\n\t\t\tquerySubscription: createReactiveSubscriptionFactory<ISubscription | undefined>((query, fields, sort) =>\n\t\t\t\tSubscriptions.findOne(query, { fields, sort }),\n\t\t\t),\n\t\t\tqueryRoom: createReactiveSubscriptionFactory<IRoom | undefined>((query, fields) => ChatRoom.findOne(query, { fields })),\n\t\t\tquerySubscriptions: createReactiveSubscriptionFactory<SubscriptionWithRoom[]>((query, options) => {\n\t\t\t\tif (userId) {\n\t\t\t\t\treturn Subscriptions.find(query, options).fetch();\n\t\t\t\t}\n\n\t\t\t\treturn ChatRoom.find(query, options).fetch();\n\t\t\t}),\n\t\t\tlogout,\n\t\t}),\n\t\t[userId, user],\n\t);\n\n\tuseEffect(() => {\n\t\tif (!!userId && preferedLanguage !== userLanguage) {\n\t\t\tsetUserPreferences({ data: { language: preferedLanguage } });\n\t\t\tsetUserLanguage(preferedLanguage);\n\t\t}\n\n\t\tif (user?.language !== undefined && user.language !== userLanguage) {\n\t\t\tsetUserLanguage(user.language);\n\t\t\tsetPreferedLanguage(user.language);\n\t\t}\n\t}, [preferedLanguage, setPreferedLanguage, setUserLanguage, user?.language, userLanguage, userId, setUserPreferences]);\n\n\tuseEffect(() => {\n\t\tif (previousUserId.current && previousUserId.current !== userId) {\n\t\t\tqueryClient.clear();\n\t\t}\n\n\t\tpreviousUserId.current = userId;\n\t}, [userId]);\n\n\treturn <UserContext.Provider children={children} value={contextValue} />;\n};\n\nexport default UserProvider;\n"],"mappings":"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","ignoreList":[]},"sourceType":"module","externalDependencies":{},"hash":"48f4389e2d482614bcbecf9c05fff0809ad8d808"}
