{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/app/api/server/middlewares/authentication.ts","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","topLevelAwait","objectRestSpread","objectRestSpread","asyncGenerators","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"os.osx.arm64"},"sourceFileName":"app/api/server/middlewares/authentication.ts","filename":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/app/api/server/middlewares/authentication.ts","inputSourceMap":{"version":3,"file":"app/api/server/middlewares/authentication.ts","sourceRoot":"","sources":["app/api/server/middlewares/authentication.ts"],"names":[],"mappings":"AAAA,OAAO,EAAE,cAAc,EAAE,MAAM,4BAA4B,CAAC;AAC5D,OAAO,EAAE,aAAa,EAAE,MAAM,4BAA4B,CAAC;AAC3D,OAAO,EAAE,KAAK,EAAE,MAAM,qBAAqB,CAAC;AAG5C,OAAO,EAAE,gBAAgB,EAAE,MAAM,0DAA0D,CAAC;AAO5F,MAAM,UAAU,wBAAwB,CACvC,SAAyC;IACxC,kBAAkB,EAAE,IAAI;IACxB,OAAO,EAAE,KAAK;CACd;IAED,OAAO,KAAK,EAAE,GAAY,EAAE,GAAa,EAAE,IAAkB,EAAiB,EAAE;QAC/E,IAAI,MAAM,CAAC,OAAO,EAAE,CAAC;YACpB,GAAG,CAAC,OAAO,CAAC,cAAc,CAAC,GAAG,GAAG,CAAC,OAAO,CAAC,QAAQ,IAAI,GAAG,CAAC,OAAO,CAAC,cAAc,CAAC,CAAC;YAClF,GAAG,CAAC,OAAO,CAAC,WAAW,CAAC,GAAG,GAAG,CAAC,OAAO,CAAC,MAAM,IAAI,GAAG,CAAC,OAAO,CAAC,WAAW,CAAC,CAAC;QAC3E,CAAC;QAED,MAAM,EAAE,WAAW,EAAE,MAAM,EAAE,cAAc,EAAE,SAAS,EAAE,GAAG,GAAG,CAAC,OAAO,CAAC;QAEvE,IAAI,MAAM,IAAI,SAAS,EAAE,CAAC;YACzB,GAAG,CAAC,IAAI,GAAG,CAAC,MAAM,KAAK,CAAC,wBAAwB,CAAC,MAAgB,EAAE,cAAc,CAAC,SAAmB,CAAC,CAAC,CAAC,IAAI,SAAS,CAAC;QACvH,CAAC;aAAM,CAAC;YACP,GAAG,CAAC,IAAI,GAAG,CAAC,MAAM,gBAAgB,CAAC,GAAG,CAAC,CAAC,EAAE,IAAI,CAAC;QAChD,CAAC;QAED,IAAI,MAAM,CAAC,kBAAkB,IAAI,CAAC,GAAG,CAAC,IAAI,EAAE,CAAC;YAC5C,GAAG,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC,IAAI,CAAC,cAAc,CAAC,CAAC;YACrC,OAAO;QACR,CAAC;QAED,GAAG,CAAC,MAAM,GAAG,GAAG,EAAE,IAAI,EAAE,GAAG,CAAC;QAE5B,IAAI,EAAE,CAAC;IACR,CAAC,CAAC;AACH,CAAC;AAED,MAAM,UAAU,uBAAuB,CACtC,UAAkB,EAClB,EAAE,kBAAkB,EAAE,GAAG;IACxB,kBAAkB,EAAE,IAAI;CACxB;IAED,OAAO,KAAK,EAAE,GAAY,EAAE,GAAa,EAAE,IAAkB,EAAiB,EAAE;QAC/E,IAAI,CAAC,GAAG,CAAC,MAAM,EAAE,CAAC;YACjB,IAAI,kBAAkB,EAAE,CAAC;gBACxB,GAAG,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC,IAAI,CAAC,cAAc,CAAC,CAAC;gBACrC,OAAO;YACR,CAAC;YACD,GAAG,CAAC,YAAY,GAAG,IAAI,CAAC;YACxB,OAAO,IAAI,EAAE,CAAC;QACf,CAAC;QAED,IAAI,CAAC,CAAC,MAAM,aAAa,CAAC,aAAa,CAAC,GAAG,CAAC,MAAM,EAAE,UAAU,CAAC,CAAC,EAAE,CAAC;YAClE,IAAI,kBAAkB,EAAE,CAAC;gBACxB,GAAG,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC,IAAI,CAAC,WAAW,CAAC,CAAC;gBAClC,OAAO;YACR,CAAC;YACD,GAAG,CAAC,YAAY,GAAG,IAAI,CAAC;QACzB,CAAC;QACD,IAAI,EAAE,CAAC;IACR,CAAC,CAAC;AACH,CAAC","sourcesContent":["import { hashLoginToken } from '@rocket.chat/account-utils';\nimport { Authorization } from '@rocket.chat/core-services';\nimport { Users } from '@rocket.chat/models';\nimport type { Request, Response, NextFunction } from 'express';\n\nimport { oAuth2ServerAuth } from '../../../oauth2-server-config/server/oauth/oauth2-server';\n\ntype AuthenticationMiddlewareConfig = {\n\trejectUnauthorized?: boolean;\n\tcookies?: boolean;\n};\n\nexport function authenticationMiddleware(\n\tconfig: AuthenticationMiddlewareConfig = {\n\t\trejectUnauthorized: true,\n\t\tcookies: false,\n\t},\n) {\n\treturn async (req: Request, res: Response, next: NextFunction): Promise<void> => {\n\t\tif (config.cookies) {\n\t\t\treq.headers['x-auth-token'] = req.cookies.rc_token ?? req.headers['x-auth-token'];\n\t\t\treq.headers['x-user-id'] = req.cookies.rc_uid ?? req.headers['x-user-id'];\n\t\t}\n\n\t\tconst { 'x-user-id': userId, 'x-auth-token': authToken } = req.headers;\n\n\t\tif (userId && authToken) {\n\t\t\treq.user = (await Users.findOneByIdAndLoginToken(userId as string, hashLoginToken(authToken as string))) || undefined;\n\t\t} else {\n\t\t\treq.user = (await oAuth2ServerAuth(req))?.user;\n\t\t}\n\n\t\tif (config.rejectUnauthorized && !req.user) {\n\t\t\tres.status(401).send('Unauthorized');\n\t\t\treturn;\n\t\t}\n\n\t\treq.userId = req?.user?._id;\n\n\t\tnext();\n\t};\n}\n\nexport function hasPermissionMiddleware(\n\tpermission: string,\n\t{ rejectUnauthorized } = {\n\t\trejectUnauthorized: true,\n\t},\n) {\n\treturn async (req: Request, res: Response, next: NextFunction): Promise<void> => {\n\t\tif (!req.userId) {\n\t\t\tif (rejectUnauthorized) {\n\t\t\t\tres.status(401).send('Unauthorized');\n\t\t\t\treturn;\n\t\t\t}\n\t\t\treq.unauthorized = true;\n\t\t\treturn next();\n\t\t}\n\n\t\tif (!(await Authorization.hasPermission(req.userId, permission))) {\n\t\t\tif (rejectUnauthorized) {\n\t\t\t\tres.status(403).send('Forbidden');\n\t\t\t\treturn;\n\t\t\t}\n\t\t\treq.unauthorized = true;\n\t\t}\n\t\tnext();\n\t};\n}\n"]},"targets":{"android":"125.0.0","chrome":"125.0.0","edge":"125.0.0","firefox":"115.0.0","ie":"10.0.0","ios":"17.4.0","opera":"110.0.0","opera_mobile":"80.0.0","safari":"17.4.0","samsung":"24.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor","root":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":false,"enforceStrictMode":false,"dynamicImport":true,"generateLetDeclarations":true,"topLevelAwait":true},"externalDependencies":[]},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"version":"7.17.2","helpers":true,"useESModules":false,"corejs":false},"externalDependencies":[]},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-async-generator-functions","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-class-properties","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true},"externalDependencies":[]},{"key":"transform-react-jsx","visitor":{"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXFragment":{"exit":[null]},"JSXElement":{"exit":[null]},"JSXAttribute":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false},"externalDependencies":[]},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-nullish-coalescing-operator","visitor":{"LogicalExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-optional-chaining","visitor":{"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-optional-catch-binding","visitor":{"CatchClause":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-class-properties","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-async-generator-functions","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-logical-assignment-operators","visitor":{"AssignmentExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]}],"presets":[],"generatorOpts":{"filename":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/app/api/server/middlewares/authentication.ts","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"app/api/server/middlewares/authentication.ts","inputSourceMap":{"version":3,"file":"app/api/server/middlewares/authentication.ts","sourceRoot":"","sources":["app/api/server/middlewares/authentication.ts"],"names":[],"mappings":"AAAA,OAAO,EAAE,cAAc,EAAE,MAAM,4BAA4B,CAAC;AAC5D,OAAO,EAAE,aAAa,EAAE,MAAM,4BAA4B,CAAC;AAC3D,OAAO,EAAE,KAAK,EAAE,MAAM,qBAAqB,CAAC;AAG5C,OAAO,EAAE,gBAAgB,EAAE,MAAM,0DAA0D,CAAC;AAO5F,MAAM,UAAU,wBAAwB,CACvC,SAAyC;IACxC,kBAAkB,EAAE,IAAI;IACxB,OAAO,EAAE,KAAK;CACd;IAED,OAAO,KAAK,EAAE,GAAY,EAAE,GAAa,EAAE,IAAkB,EAAiB,EAAE;QAC/E,IAAI,MAAM,CAAC,OAAO,EAAE,CAAC;YACpB,GAAG,CAAC,OAAO,CAAC,cAAc,CAAC,GAAG,GAAG,CAAC,OAAO,CAAC,QAAQ,IAAI,GAAG,CAAC,OAAO,CAAC,cAAc,CAAC,CAAC;YAClF,GAAG,CAAC,OAAO,CAAC,WAAW,CAAC,GAAG,GAAG,CAAC,OAAO,CAAC,MAAM,IAAI,GAAG,CAAC,OAAO,CAAC,WAAW,CAAC,CAAC;QAC3E,CAAC;QAED,MAAM,EAAE,WAAW,EAAE,MAAM,EAAE,cAAc,EAAE,SAAS,EAAE,GAAG,GAAG,CAAC,OAAO,CAAC;QAEvE,IAAI,MAAM,IAAI,SAAS,EAAE,CAAC;YACzB,GAAG,CAAC,IAAI,GAAG,CAAC,MAAM,KAAK,CAAC,wBAAwB,CAAC,MAAgB,EAAE,cAAc,CAAC,SAAmB,CAAC,CAAC,CAAC,IAAI,SAAS,CAAC;QACvH,CAAC;aAAM,CAAC;YACP,GAAG,CAAC,IAAI,GAAG,CAAC,MAAM,gBAAgB,CAAC,GAAG,CAAC,CAAC,EAAE,IAAI,CAAC;QAChD,CAAC;QAED,IAAI,MAAM,CAAC,kBAAkB,IAAI,CAAC,GAAG,CAAC,IAAI,EAAE,CAAC;YAC5C,GAAG,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC,IAAI,CAAC,cAAc,CAAC,CAAC;YACrC,OAAO;QACR,CAAC;QAED,GAAG,CAAC,MAAM,GAAG,GAAG,EAAE,IAAI,EAAE,GAAG,CAAC;QAE5B,IAAI,EAAE,CAAC;IACR,CAAC,CAAC;AACH,CAAC;AAED,MAAM,UAAU,uBAAuB,CACtC,UAAkB,EAClB,EAAE,kBAAkB,EAAE,GAAG;IACxB,kBAAkB,EAAE,IAAI;CACxB;IAED,OAAO,KAAK,EAAE,GAAY,EAAE,GAAa,EAAE,IAAkB,EAAiB,EAAE;QAC/E,IAAI,CAAC,GAAG,CAAC,MAAM,EAAE,CAAC;YACjB,IAAI,kBAAkB,EAAE,CAAC;gBACxB,GAAG,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC,IAAI,CAAC,cAAc,CAAC,CAAC;gBACrC,OAAO;YACR,CAAC;YACD,GAAG,CAAC,YAAY,GAAG,IAAI,CAAC;YACxB,OAAO,IAAI,EAAE,CAAC;QACf,CAAC;QAED,IAAI,CAAC,CAAC,MAAM,aAAa,CAAC,aAAa,CAAC,GAAG,CAAC,MAAM,EAAE,UAAU,CAAC,CAAC,EAAE,CAAC;YAClE,IAAI,kBAAkB,EAAE,CAAC;gBACxB,GAAG,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC,IAAI,CAAC,WAAW,CAAC,CAAC;gBAClC,OAAO;YACR,CAAC;YACD,GAAG,CAAC,YAAY,GAAG,IAAI,CAAC;QACzB,CAAC;QACD,IAAI,EAAE,CAAC;IACR,CAAC,CAAC;AACH,CAAC","sourcesContent":["import { hashLoginToken } from '@rocket.chat/account-utils';\nimport { Authorization } from '@rocket.chat/core-services';\nimport { Users } from '@rocket.chat/models';\nimport type { Request, Response, NextFunction } from 'express';\n\nimport { oAuth2ServerAuth } from '../../../oauth2-server-config/server/oauth/oauth2-server';\n\ntype AuthenticationMiddlewareConfig = {\n\trejectUnauthorized?: boolean;\n\tcookies?: boolean;\n};\n\nexport function authenticationMiddleware(\n\tconfig: AuthenticationMiddlewareConfig = {\n\t\trejectUnauthorized: true,\n\t\tcookies: false,\n\t},\n) {\n\treturn async (req: Request, res: Response, next: NextFunction): Promise<void> => {\n\t\tif (config.cookies) {\n\t\t\treq.headers['x-auth-token'] = req.cookies.rc_token ?? req.headers['x-auth-token'];\n\t\t\treq.headers['x-user-id'] = req.cookies.rc_uid ?? req.headers['x-user-id'];\n\t\t}\n\n\t\tconst { 'x-user-id': userId, 'x-auth-token': authToken } = req.headers;\n\n\t\tif (userId && authToken) {\n\t\t\treq.user = (await Users.findOneByIdAndLoginToken(userId as string, hashLoginToken(authToken as string))) || undefined;\n\t\t} else {\n\t\t\treq.user = (await oAuth2ServerAuth(req))?.user;\n\t\t}\n\n\t\tif (config.rejectUnauthorized && !req.user) {\n\t\t\tres.status(401).send('Unauthorized');\n\t\t\treturn;\n\t\t}\n\n\t\treq.userId = req?.user?._id;\n\n\t\tnext();\n\t};\n}\n\nexport function hasPermissionMiddleware(\n\tpermission: string,\n\t{ rejectUnauthorized } = {\n\t\trejectUnauthorized: true,\n\t},\n) {\n\treturn async (req: Request, res: Response, next: NextFunction): Promise<void> => {\n\t\tif (!req.userId) {\n\t\t\tif (rejectUnauthorized) {\n\t\t\t\tres.status(401).send('Unauthorized');\n\t\t\t\treturn;\n\t\t\t}\n\t\t\treq.unauthorized = true;\n\t\t\treturn next();\n\t\t}\n\n\t\tif (!(await Authorization.hasPermission(req.userId, permission))) {\n\t\t\tif (rejectUnauthorized) {\n\t\t\t\tres.status(403).send('Forbidden');\n\t\t\t\treturn;\n\t\t\t}\n\t\t\treq.unauthorized = true;\n\t\t}\n\t\tnext();\n\t};\n}\n"]}}},"code":"!module.wrapAsync(async function (module, __reifyWaitForDeps__, __reify_async_result__) {\n  \"use strict\";\n  try {\n    module.export({\n      authenticationMiddleware: () => authenticationMiddleware,\n      hasPermissionMiddleware: () => hasPermissionMiddleware\n    });\n    let hashLoginToken;\n    module.link(\"@rocket.chat/account-utils\", {\n      hashLoginToken(v) {\n        hashLoginToken = v;\n      }\n    }, 0);\n    let Authorization;\n    module.link(\"@rocket.chat/core-services\", {\n      Authorization(v) {\n        Authorization = v;\n      }\n    }, 1);\n    let Users;\n    module.link(\"@rocket.chat/models\", {\n      Users(v) {\n        Users = v;\n      }\n    }, 2);\n    let oAuth2ServerAuth;\n    module.link(\"../../../oauth2-server-config/server/oauth/oauth2-server\", {\n      oAuth2ServerAuth(v) {\n        oAuth2ServerAuth = v;\n      }\n    }, 3);\n    if (__reifyWaitForDeps__()) (await __reifyWaitForDeps__())();\n    function authenticationMiddleware() {\n      let config = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {\n        rejectUnauthorized: true,\n        cookies: false\n      };\n      return async (req, res, next) => {\n        var _req$user;\n        if (config.cookies) {\n          var _req$cookies$rc_token, _req$cookies$rc_uid;\n          req.headers['x-auth-token'] = (_req$cookies$rc_token = req.cookies.rc_token) !== null && _req$cookies$rc_token !== void 0 ? _req$cookies$rc_token : req.headers['x-auth-token'];\n          req.headers['x-user-id'] = (_req$cookies$rc_uid = req.cookies.rc_uid) !== null && _req$cookies$rc_uid !== void 0 ? _req$cookies$rc_uid : req.headers['x-user-id'];\n        }\n        const {\n          'x-user-id': userId,\n          'x-auth-token': authToken\n        } = req.headers;\n        if (userId && authToken) {\n          req.user = (await Users.findOneByIdAndLoginToken(userId, hashLoginToken(authToken))) || undefined;\n        } else {\n          var _await$oAuth2ServerAu;\n          req.user = (_await$oAuth2ServerAu = await oAuth2ServerAuth(req)) === null || _await$oAuth2ServerAu === void 0 ? void 0 : _await$oAuth2ServerAu.user;\n        }\n        if (config.rejectUnauthorized && !req.user) {\n          res.status(401).send('Unauthorized');\n          return;\n        }\n        req.userId = req === null || req === void 0 ? void 0 : (_req$user = req.user) === null || _req$user === void 0 ? void 0 : _req$user._id;\n        next();\n      };\n    }\n    function hasPermissionMiddleware(permission) {\n      let {\n        rejectUnauthorized\n      } = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {\n        rejectUnauthorized: true\n      };\n      return async (req, res, next) => {\n        if (!req.userId) {\n          if (rejectUnauthorized) {\n            res.status(401).send('Unauthorized');\n            return;\n          }\n          req.unauthorized = true;\n          return next();\n        }\n        if (!(await Authorization.hasPermission(req.userId, permission))) {\n          if (rejectUnauthorized) {\n            res.status(403).send('Forbidden');\n            return;\n          }\n          req.unauthorized = true;\n        }\n        next();\n      };\n    }\n    __reify_async_result__();\n  } catch (_reifyError) {\n    return __reify_async_result__(_reifyError);\n  }\n  __reify_async_result__()\n}, {\n  self: this,\n  async: false\n});","map":{"version":3,"names":["module","export","authenticationMiddleware","hasPermissionMiddleware","hashLoginToken","link","v","Authorization","Users","oAuth2ServerAuth","__reifyWaitForDeps__","config","arguments","length","undefined","rejectUnauthorized","cookies","req","res","next","_req$user","_req$cookies$rc_token","_req$cookies$rc_uid","headers","rc_token","rc_uid","userId","authToken","user","findOneByIdAndLoginToken","_await$oAuth2ServerAu","status","send","_id","permission","unauthorized","hasPermission","__reify_async_result__","_reifyError","self","async"],"sources":["app/api/server/middlewares/authentication.ts"],"sourcesContent":["import { hashLoginToken } from '@rocket.chat/account-utils';\nimport { Authorization } from '@rocket.chat/core-services';\nimport { Users } from '@rocket.chat/models';\nimport type { Request, Response, NextFunction } from 'express';\n\nimport { oAuth2ServerAuth } from '../../../oauth2-server-config/server/oauth/oauth2-server';\n\ntype AuthenticationMiddlewareConfig = {\n\trejectUnauthorized?: boolean;\n\tcookies?: boolean;\n};\n\nexport function authenticationMiddleware(\n\tconfig: AuthenticationMiddlewareConfig = {\n\t\trejectUnauthorized: true,\n\t\tcookies: false,\n\t},\n) {\n\treturn async (req: Request, res: Response, next: NextFunction): Promise<void> => {\n\t\tif (config.cookies) {\n\t\t\treq.headers['x-auth-token'] = req.cookies.rc_token ?? req.headers['x-auth-token'];\n\t\t\treq.headers['x-user-id'] = req.cookies.rc_uid ?? req.headers['x-user-id'];\n\t\t}\n\n\t\tconst { 'x-user-id': userId, 'x-auth-token': authToken } = req.headers;\n\n\t\tif (userId && authToken) {\n\t\t\treq.user = (await Users.findOneByIdAndLoginToken(userId as string, hashLoginToken(authToken as string))) || undefined;\n\t\t} else {\n\t\t\treq.user = (await oAuth2ServerAuth(req))?.user;\n\t\t}\n\n\t\tif (config.rejectUnauthorized && !req.user) {\n\t\t\tres.status(401).send('Unauthorized');\n\t\t\treturn;\n\t\t}\n\n\t\treq.userId = req?.user?._id;\n\n\t\tnext();\n\t};\n}\n\nexport function hasPermissionMiddleware(\n\tpermission: string,\n\t{ rejectUnauthorized } = {\n\t\trejectUnauthorized: true,\n\t},\n) {\n\treturn async (req: Request, res: Response, next: NextFunction): Promise<void> => {\n\t\tif (!req.userId) {\n\t\t\tif (rejectUnauthorized) {\n\t\t\t\tres.status(401).send('Unauthorized');\n\t\t\t\treturn;\n\t\t\t}\n\t\t\treq.unauthorized = true;\n\t\t\treturn next();\n\t\t}\n\n\t\tif (!(await Authorization.hasPermission(req.userId, permission))) {\n\t\t\tif (rejectUnauthorized) {\n\t\t\t\tres.status(403).send('Forbidden');\n\t\t\t\treturn;\n\t\t\t}\n\t\t\treq.unauthorized = true;\n\t\t}\n\t\tnext();\n\t};\n}\n"],"mappings":"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","ignoreList":[]},"sourceType":"module","externalDependencies":{},"hash":"ff8e6e83e9b4de1f2a0c5882e629386b072ae818"}
