{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/server/ufs/ufs-server.ts","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","topLevelAwait","objectRestSpread","objectRestSpread","asyncGenerators","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"os.osx.arm64"},"sourceFileName":"server/ufs/ufs-server.ts","filename":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/server/ufs/ufs-server.ts","inputSourceMap":{"version":3,"file":"server/ufs/ufs-server.ts","sourceRoot":"","sources":["server/ufs/ufs-server.ts"],"names":[],"mappings":"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","sourcesContent":["import domain from 'domain';\nimport fs from 'fs';\nimport stream from 'stream';\nimport URL from 'url';\nimport zlib from 'zlib';\n\nimport { Meteor } from 'meteor/meteor';\nimport { WebApp } from 'meteor/webapp';\nimport mkdirp from 'mkdirp';\n\nimport { UploadFS } from './ufs';\n\nMeteor.startup(() => {\n\tconst path = UploadFS.config.tmpDir;\n\tconst mode = UploadFS.config.tmpDirPermissions;\n\n\tfs.stat(path, (err) => {\n\t\tif (err) {\n\t\t\t// Create the temp directory\n\t\t\tmkdirp(path, { mode })\n\t\t\t\t.then(() => {\n\t\t\t\t\tconsole.log(`ufs: temp directory created at \"${path}\"`);\n\t\t\t\t})\n\t\t\t\t.catch((err) => {\n\t\t\t\t\tconsole.error(`ufs: cannot create temp directory at \"${path}\" (${err.message})`);\n\t\t\t\t});\n\t\t} else {\n\t\t\t// Set directory permissions\n\t\t\tfs.chmod(path, mode, (err) => {\n\t\t\t\terr && console.error(`ufs: cannot set temp directory permissions ${mode} (${err.message})`);\n\t\t\t});\n\t\t}\n\t});\n});\n\n// Create domain to handle errors\n// and possibly avoid server crashes.\nconst d = domain.create();\n\nd.on('error', (err) => {\n\tconsole.error(`ufs: ${err.message}`);\n});\n\n// Listen HTTP requests to serve files\nWebApp.connectHandlers.use(async (req, res, next) => {\n\t// Quick check to see if request should be caught\n\tif (!req.url?.includes(`/${UploadFS.config.storesPath}/`)) {\n\t\tnext();\n\t\treturn;\n\t}\n\n\t// Remove store path\n\tconst parsedUrl = URL.parse(req.url, true);\n\tconst path = parsedUrl.pathname?.substr(UploadFS.config.storesPath.length + 1);\n\n\tif (!path) {\n\t\tnext();\n\t\treturn;\n\t}\n\n\tconst allowCORS = () => {\n\t\t// res.setHeader('Access-Control-Allow-Origin', req.headers.origin);\n\t\tres.setHeader('Access-Control-Allow-Methods', 'POST');\n\t\tres.setHeader('Access-Control-Allow-Origin', '*');\n\t\tres.setHeader('Access-Control-Allow-Headers', 'Content-Type');\n\t};\n\n\tif (req.method === 'OPTIONS') {\n\t\tconst regExp = new RegExp('^/([^/?]+)/([^/?]+)$');\n\t\tconst match = regExp.exec(path);\n\n\t\t// Request is not valid\n\t\tif (match === null) {\n\t\t\tres.writeHead(400);\n\t\t\tres.end();\n\t\t\treturn;\n\t\t}\n\n\t\t// Get store\n\t\tconst store = UploadFS.getStore(match[1]);\n\t\tif (!store) {\n\t\t\tres.writeHead(404);\n\t\t\tres.end();\n\t\t\treturn;\n\t\t}\n\n\t\t// If a store is found, go ahead and allow the origin\n\t\tallowCORS();\n\n\t\tnext();\n\t} else if (req.method === 'POST') {\n\t\tres.writeHead(404);\n\t\tres.end();\n\t} else if (req.method === 'GET') {\n\t\t// Get store, file Id and file name\n\t\tconst regExp = new RegExp('^/([^/?]+)/([^/?]+)(?:/([^/?]+))?$');\n\t\tconst match = regExp.exec(path);\n\n\t\t// Avoid 504 Gateway timeout error\n\t\t// if file is not handled by UploadFS.\n\t\tif (match === null) {\n\t\t\tnext();\n\t\t\treturn;\n\t\t}\n\n\t\t// Get store\n\t\tconst storeName = match[1];\n\t\tconst store = UploadFS.getStore(storeName);\n\n\t\tif (!store) {\n\t\t\tres.writeHead(404);\n\t\t\tres.end();\n\t\t\treturn;\n\t\t}\n\n\t\tif (store.onRead !== null && store.onRead !== undefined && typeof store.onRead !== 'function') {\n\t\t\tconsole.error(`ufs: Store.onRead is not a function in store \"${storeName}\"`);\n\t\t\tres.writeHead(500);\n\t\t\tres.end();\n\t\t\treturn;\n\t\t}\n\n\t\t// Remove file extension from file Id\n\t\tconst index = match[2].indexOf('.');\n\t\tconst fileId = index !== -1 ? match[2].substr(0, index) : match[2];\n\n\t\t// Get file from database\n\t\tconst file = await store.getCollection().findOne({ _id: fileId });\n\t\tif (!file) {\n\t\t\tres.writeHead(404);\n\t\t\tres.end();\n\t\t\treturn;\n\t\t}\n\n\t\tawait d.run(async () => {\n\t\t\t// Check if the file can be accessed\n\t\t\tif ((await store.onRead.call(store, fileId, file, req, res)) !== false) {\n\t\t\t\tconst options: {\n\t\t\t\t\tstart?: number;\n\t\t\t\t\tend?: number;\n\t\t\t\t} = {};\n\t\t\t\tlet status = 200;\n\n\t\t\t\t// Prepare response headers\n\t\t\t\tconst headers: Record<string, any> = {\n\t\t\t\t\t'Content-Type': file.type,\n\t\t\t\t\t'Content-Length': file.size,\n\t\t\t\t};\n\n\t\t\t\t// Add ETag header\n\t\t\t\tif (typeof file.etag === 'string') {\n\t\t\t\t\theaders.ETag = file.etag;\n\t\t\t\t}\n\n\t\t\t\t// Add Last-Modified header\n\t\t\t\tif (file.modifiedAt instanceof Date) {\n\t\t\t\t\theaders['Last-Modified'] = file.modifiedAt.toUTCString();\n\t\t\t\t} else if (file.uploadedAt instanceof Date) {\n\t\t\t\t\theaders['Last-Modified'] = file.uploadedAt.toUTCString();\n\t\t\t\t}\n\n\t\t\t\t// Parse request headers\n\t\t\t\tif (typeof req.headers === 'object') {\n\t\t\t\t\t// Compare ETag\n\t\t\t\t\tif (req.headers['if-none-match']) {\n\t\t\t\t\t\tif (file.etag === req.headers['if-none-match']) {\n\t\t\t\t\t\t\tres.writeHead(304); // Not Modified\n\t\t\t\t\t\t\tres.end();\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\t// Compare file modification date\n\t\t\t\t\tif (req.headers['if-modified-since']) {\n\t\t\t\t\t\tconst modifiedSince = new Date(req.headers['if-modified-since']);\n\n\t\t\t\t\t\tif (\n\t\t\t\t\t\t\t(file.modifiedAt instanceof Date && file.modifiedAt > modifiedSince) ||\n\t\t\t\t\t\t\t// eslint-disable-next-line no-mixed-operators\n\t\t\t\t\t\t\t(file.uploadedAt instanceof Date && file.uploadedAt > modifiedSince)\n\t\t\t\t\t\t) {\n\t\t\t\t\t\t\tres.writeHead(304); // Not Modified\n\t\t\t\t\t\t\tres.end();\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\t// Support range request\n\t\t\t\t\tif (typeof req.headers.range === 'string') {\n\t\t\t\t\t\tconst { range } = req.headers;\n\n\t\t\t\t\t\t// Range is not valid\n\t\t\t\t\t\tif (!range) {\n\t\t\t\t\t\t\tres.writeHead(416);\n\t\t\t\t\t\t\tres.end();\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tconst total = file.size || 0;\n\t\t\t\t\t\tconst unit = range.substr(0, range.indexOf('='));\n\n\t\t\t\t\t\tif (unit !== 'bytes') {\n\t\t\t\t\t\t\tres.writeHead(416);\n\t\t\t\t\t\t\tres.end();\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tconst ranges = range\n\t\t\t\t\t\t\t.substr(unit.length)\n\t\t\t\t\t\t\t.replace(/[^0-9\\-,]/, '')\n\t\t\t\t\t\t\t.split(',');\n\n\t\t\t\t\t\tif (ranges.length > 1) {\n\t\t\t\t\t\t\t// todo: support multipart ranges: https://developer.mozilla.org/en-US/docs/Web/HTTP/Range_requests\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tconst r = ranges[0].split('-');\n\t\t\t\t\t\t\tconst start = parseInt(r[0], 10);\n\t\t\t\t\t\t\tconst end = r[1] ? parseInt(r[1], 10) : total - 1;\n\n\t\t\t\t\t\t\t// Range is not valid\n\t\t\t\t\t\t\tif (start < 0 || end >= total || start > end) {\n\t\t\t\t\t\t\t\tres.writeHead(416);\n\t\t\t\t\t\t\t\tres.end();\n\t\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t// Update headers\n\t\t\t\t\t\t\theaders['Content-Range'] = `bytes ${start}-${end}/${total}`;\n\t\t\t\t\t\t\theaders['Content-Length'] = end - start + 1;\n\t\t\t\t\t\t\toptions.start = start;\n\t\t\t\t\t\t\toptions.end = end;\n\t\t\t\t\t\t}\n\t\t\t\t\t\tstatus = 206; // partial content\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\theaders['Accept-Ranges'] = 'bytes';\n\t\t\t\t}\n\n\t\t\t\t// Open the file stream\n\t\t\t\tconst rs = await store.getReadStream(fileId, file, options);\n\t\t\t\tconst ws = new stream.PassThrough();\n\n\t\t\t\trs.on('error', (err) => {\n\t\t\t\t\tstore.onReadError.call(store, err, fileId, file);\n\t\t\t\t\tres.end();\n\t\t\t\t});\n\t\t\t\tws.on('error', (err) => {\n\t\t\t\t\tstore.onReadError.call(store, err, fileId, file);\n\t\t\t\t\tres.end();\n\t\t\t\t});\n\t\t\t\tws.on('close', () => {\n\t\t\t\t\t// Close output stream at the end\n\t\t\t\t\tws.emit('end');\n\t\t\t\t});\n\n\t\t\t\t// Transform stream\n\t\t\t\tstore.transformRead(rs, ws, fileId, file, req, headers);\n\n\t\t\t\t// Parse request headers\n\t\t\t\tif (typeof req.headers === 'object') {\n\t\t\t\t\t// Compress data using if needed (ignore audio/video as they are already compressed)\n\t\t\t\t\tif (typeof req.headers['accept-encoding'] === 'string' && (!file.type || !/^(audio|video)/.test(file.type))) {\n\t\t\t\t\t\tconst accept = req.headers['accept-encoding'];\n\n\t\t\t\t\t\t// Compress with gzip\n\t\t\t\t\t\tif (accept.match(/\\bgzip\\b/)) {\n\t\t\t\t\t\t\theaders['Content-Encoding'] = 'gzip';\n\t\t\t\t\t\t\tdelete headers['Content-Length'];\n\t\t\t\t\t\t\tres.writeHead(status, headers);\n\t\t\t\t\t\t\tws.pipe(zlib.createGzip()).pipe(res);\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\t\t\t\t\t\t// Compress with deflate\n\t\t\t\t\t\tif (accept.match(/\\bdeflate\\b/)) {\n\t\t\t\t\t\t\theaders['Content-Encoding'] = 'deflate';\n\t\t\t\t\t\t\tdelete headers['Content-Length'];\n\t\t\t\t\t\t\tres.writeHead(status, headers);\n\t\t\t\t\t\t\tws.pipe(zlib.createDeflate()).pipe(res);\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\t// Send raw data\n\t\t\t\tif (!headers['Content-Encoding']) {\n\t\t\t\t\tres.writeHead(status, headers);\n\t\t\t\t\tws.pipe(res);\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tres.end();\n\t\t\t}\n\t\t});\n\t} else {\n\t\tnext();\n\t}\n});\n"]},"targets":{"android":"125.0.0","chrome":"125.0.0","edge":"125.0.0","firefox":"115.0.0","ie":"10.0.0","ios":"17.4.0","opera":"110.0.0","opera_mobile":"80.0.0","safari":"17.4.0","samsung":"24.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor","root":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":false,"enforceStrictMode":false,"dynamicImport":true,"generateLetDeclarations":true,"topLevelAwait":true},"externalDependencies":[]},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"version":"7.17.2","helpers":true,"useESModules":false,"corejs":false},"externalDependencies":[]},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-async-generator-functions","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-class-properties","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true},"externalDependencies":[]},{"key":"transform-react-jsx","visitor":{"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXFragment":{"exit":[null]},"JSXElement":{"exit":[null]},"JSXAttribute":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false},"externalDependencies":[]},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-nullish-coalescing-operator","visitor":{"LogicalExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-optional-chaining","visitor":{"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-optional-catch-binding","visitor":{"CatchClause":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-class-properties","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-async-generator-functions","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-logical-assignment-operators","visitor":{"AssignmentExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]}],"presets":[],"generatorOpts":{"filename":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/server/ufs/ufs-server.ts","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"server/ufs/ufs-server.ts","inputSourceMap":{"version":3,"file":"server/ufs/ufs-server.ts","sourceRoot":"","sources":["server/ufs/ufs-server.ts"],"names":[],"mappings":"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","sourcesContent":["import domain from 'domain';\nimport fs from 'fs';\nimport stream from 'stream';\nimport URL from 'url';\nimport zlib from 'zlib';\n\nimport { Meteor } from 'meteor/meteor';\nimport { WebApp } from 'meteor/webapp';\nimport mkdirp from 'mkdirp';\n\nimport { UploadFS } from './ufs';\n\nMeteor.startup(() => {\n\tconst path = UploadFS.config.tmpDir;\n\tconst mode = UploadFS.config.tmpDirPermissions;\n\n\tfs.stat(path, (err) => {\n\t\tif (err) {\n\t\t\t// Create the temp directory\n\t\t\tmkdirp(path, { mode })\n\t\t\t\t.then(() => {\n\t\t\t\t\tconsole.log(`ufs: temp directory created at \"${path}\"`);\n\t\t\t\t})\n\t\t\t\t.catch((err) => {\n\t\t\t\t\tconsole.error(`ufs: cannot create temp directory at \"${path}\" (${err.message})`);\n\t\t\t\t});\n\t\t} else {\n\t\t\t// Set directory permissions\n\t\t\tfs.chmod(path, mode, (err) => {\n\t\t\t\terr && console.error(`ufs: cannot set temp directory permissions ${mode} (${err.message})`);\n\t\t\t});\n\t\t}\n\t});\n});\n\n// Create domain to handle errors\n// and possibly avoid server crashes.\nconst d = domain.create();\n\nd.on('error', (err) => {\n\tconsole.error(`ufs: ${err.message}`);\n});\n\n// Listen HTTP requests to serve files\nWebApp.connectHandlers.use(async (req, res, next) => {\n\t// Quick check to see if request should be caught\n\tif (!req.url?.includes(`/${UploadFS.config.storesPath}/`)) {\n\t\tnext();\n\t\treturn;\n\t}\n\n\t// Remove store path\n\tconst parsedUrl = URL.parse(req.url, true);\n\tconst path = parsedUrl.pathname?.substr(UploadFS.config.storesPath.length + 1);\n\n\tif (!path) {\n\t\tnext();\n\t\treturn;\n\t}\n\n\tconst allowCORS = () => {\n\t\t// res.setHeader('Access-Control-Allow-Origin', req.headers.origin);\n\t\tres.setHeader('Access-Control-Allow-Methods', 'POST');\n\t\tres.setHeader('Access-Control-Allow-Origin', '*');\n\t\tres.setHeader('Access-Control-Allow-Headers', 'Content-Type');\n\t};\n\n\tif (req.method === 'OPTIONS') {\n\t\tconst regExp = new RegExp('^/([^/?]+)/([^/?]+)$');\n\t\tconst match = regExp.exec(path);\n\n\t\t// Request is not valid\n\t\tif (match === null) {\n\t\t\tres.writeHead(400);\n\t\t\tres.end();\n\t\t\treturn;\n\t\t}\n\n\t\t// Get store\n\t\tconst store = UploadFS.getStore(match[1]);\n\t\tif (!store) {\n\t\t\tres.writeHead(404);\n\t\t\tres.end();\n\t\t\treturn;\n\t\t}\n\n\t\t// If a store is found, go ahead and allow the origin\n\t\tallowCORS();\n\n\t\tnext();\n\t} else if (req.method === 'POST') {\n\t\tres.writeHead(404);\n\t\tres.end();\n\t} else if (req.method === 'GET') {\n\t\t// Get store, file Id and file name\n\t\tconst regExp = new RegExp('^/([^/?]+)/([^/?]+)(?:/([^/?]+))?$');\n\t\tconst match = regExp.exec(path);\n\n\t\t// Avoid 504 Gateway timeout error\n\t\t// if file is not handled by UploadFS.\n\t\tif (match === null) {\n\t\t\tnext();\n\t\t\treturn;\n\t\t}\n\n\t\t// Get store\n\t\tconst storeName = match[1];\n\t\tconst store = UploadFS.getStore(storeName);\n\n\t\tif (!store) {\n\t\t\tres.writeHead(404);\n\t\t\tres.end();\n\t\t\treturn;\n\t\t}\n\n\t\tif (store.onRead !== null && store.onRead !== undefined && typeof store.onRead !== 'function') {\n\t\t\tconsole.error(`ufs: Store.onRead is not a function in store \"${storeName}\"`);\n\t\t\tres.writeHead(500);\n\t\t\tres.end();\n\t\t\treturn;\n\t\t}\n\n\t\t// Remove file extension from file Id\n\t\tconst index = match[2].indexOf('.');\n\t\tconst fileId = index !== -1 ? match[2].substr(0, index) : match[2];\n\n\t\t// Get file from database\n\t\tconst file = await store.getCollection().findOne({ _id: fileId });\n\t\tif (!file) {\n\t\t\tres.writeHead(404);\n\t\t\tres.end();\n\t\t\treturn;\n\t\t}\n\n\t\tawait d.run(async () => {\n\t\t\t// Check if the file can be accessed\n\t\t\tif ((await store.onRead.call(store, fileId, file, req, res)) !== false) {\n\t\t\t\tconst options: {\n\t\t\t\t\tstart?: number;\n\t\t\t\t\tend?: number;\n\t\t\t\t} = {};\n\t\t\t\tlet status = 200;\n\n\t\t\t\t// Prepare response headers\n\t\t\t\tconst headers: Record<string, any> = {\n\t\t\t\t\t'Content-Type': file.type,\n\t\t\t\t\t'Content-Length': file.size,\n\t\t\t\t};\n\n\t\t\t\t// Add ETag header\n\t\t\t\tif (typeof file.etag === 'string') {\n\t\t\t\t\theaders.ETag = file.etag;\n\t\t\t\t}\n\n\t\t\t\t// Add Last-Modified header\n\t\t\t\tif (file.modifiedAt instanceof Date) {\n\t\t\t\t\theaders['Last-Modified'] = file.modifiedAt.toUTCString();\n\t\t\t\t} else if (file.uploadedAt instanceof Date) {\n\t\t\t\t\theaders['Last-Modified'] = file.uploadedAt.toUTCString();\n\t\t\t\t}\n\n\t\t\t\t// Parse request headers\n\t\t\t\tif (typeof req.headers === 'object') {\n\t\t\t\t\t// Compare ETag\n\t\t\t\t\tif (req.headers['if-none-match']) {\n\t\t\t\t\t\tif (file.etag === req.headers['if-none-match']) {\n\t\t\t\t\t\t\tres.writeHead(304); // Not Modified\n\t\t\t\t\t\t\tres.end();\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\t// Compare file modification date\n\t\t\t\t\tif (req.headers['if-modified-since']) {\n\t\t\t\t\t\tconst modifiedSince = new Date(req.headers['if-modified-since']);\n\n\t\t\t\t\t\tif (\n\t\t\t\t\t\t\t(file.modifiedAt instanceof Date && file.modifiedAt > modifiedSince) ||\n\t\t\t\t\t\t\t// eslint-disable-next-line no-mixed-operators\n\t\t\t\t\t\t\t(file.uploadedAt instanceof Date && file.uploadedAt > modifiedSince)\n\t\t\t\t\t\t) {\n\t\t\t\t\t\t\tres.writeHead(304); // Not Modified\n\t\t\t\t\t\t\tres.end();\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\t// Support range request\n\t\t\t\t\tif (typeof req.headers.range === 'string') {\n\t\t\t\t\t\tconst { range } = req.headers;\n\n\t\t\t\t\t\t// Range is not valid\n\t\t\t\t\t\tif (!range) {\n\t\t\t\t\t\t\tres.writeHead(416);\n\t\t\t\t\t\t\tres.end();\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tconst total = file.size || 0;\n\t\t\t\t\t\tconst unit = range.substr(0, range.indexOf('='));\n\n\t\t\t\t\t\tif (unit !== 'bytes') {\n\t\t\t\t\t\t\tres.writeHead(416);\n\t\t\t\t\t\t\tres.end();\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tconst ranges = range\n\t\t\t\t\t\t\t.substr(unit.length)\n\t\t\t\t\t\t\t.replace(/[^0-9\\-,]/, '')\n\t\t\t\t\t\t\t.split(',');\n\n\t\t\t\t\t\tif (ranges.length > 1) {\n\t\t\t\t\t\t\t// todo: support multipart ranges: https://developer.mozilla.org/en-US/docs/Web/HTTP/Range_requests\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tconst r = ranges[0].split('-');\n\t\t\t\t\t\t\tconst start = parseInt(r[0], 10);\n\t\t\t\t\t\t\tconst end = r[1] ? parseInt(r[1], 10) : total - 1;\n\n\t\t\t\t\t\t\t// Range is not valid\n\t\t\t\t\t\t\tif (start < 0 || end >= total || start > end) {\n\t\t\t\t\t\t\t\tres.writeHead(416);\n\t\t\t\t\t\t\t\tres.end();\n\t\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t// Update headers\n\t\t\t\t\t\t\theaders['Content-Range'] = `bytes ${start}-${end}/${total}`;\n\t\t\t\t\t\t\theaders['Content-Length'] = end - start + 1;\n\t\t\t\t\t\t\toptions.start = start;\n\t\t\t\t\t\t\toptions.end = end;\n\t\t\t\t\t\t}\n\t\t\t\t\t\tstatus = 206; // partial content\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\theaders['Accept-Ranges'] = 'bytes';\n\t\t\t\t}\n\n\t\t\t\t// Open the file stream\n\t\t\t\tconst rs = await store.getReadStream(fileId, file, options);\n\t\t\t\tconst ws = new stream.PassThrough();\n\n\t\t\t\trs.on('error', (err) => {\n\t\t\t\t\tstore.onReadError.call(store, err, fileId, file);\n\t\t\t\t\tres.end();\n\t\t\t\t});\n\t\t\t\tws.on('error', (err) => {\n\t\t\t\t\tstore.onReadError.call(store, err, fileId, file);\n\t\t\t\t\tres.end();\n\t\t\t\t});\n\t\t\t\tws.on('close', () => {\n\t\t\t\t\t// Close output stream at the end\n\t\t\t\t\tws.emit('end');\n\t\t\t\t});\n\n\t\t\t\t// Transform stream\n\t\t\t\tstore.transformRead(rs, ws, fileId, file, req, headers);\n\n\t\t\t\t// Parse request headers\n\t\t\t\tif (typeof req.headers === 'object') {\n\t\t\t\t\t// Compress data using if needed (ignore audio/video as they are already compressed)\n\t\t\t\t\tif (typeof req.headers['accept-encoding'] === 'string' && (!file.type || !/^(audio|video)/.test(file.type))) {\n\t\t\t\t\t\tconst accept = req.headers['accept-encoding'];\n\n\t\t\t\t\t\t// Compress with gzip\n\t\t\t\t\t\tif (accept.match(/\\bgzip\\b/)) {\n\t\t\t\t\t\t\theaders['Content-Encoding'] = 'gzip';\n\t\t\t\t\t\t\tdelete headers['Content-Length'];\n\t\t\t\t\t\t\tres.writeHead(status, headers);\n\t\t\t\t\t\t\tws.pipe(zlib.createGzip()).pipe(res);\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\t\t\t\t\t\t// Compress with deflate\n\t\t\t\t\t\tif (accept.match(/\\bdeflate\\b/)) {\n\t\t\t\t\t\t\theaders['Content-Encoding'] = 'deflate';\n\t\t\t\t\t\t\tdelete headers['Content-Length'];\n\t\t\t\t\t\t\tres.writeHead(status, headers);\n\t\t\t\t\t\t\tws.pipe(zlib.createDeflate()).pipe(res);\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\t// Send raw data\n\t\t\t\tif (!headers['Content-Encoding']) {\n\t\t\t\t\tres.writeHead(status, headers);\n\t\t\t\t\tws.pipe(res);\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tres.end();\n\t\t\t}\n\t\t});\n\t} else {\n\t\tnext();\n\t}\n});\n"]}}},"code":"!module.wrapAsync(async function (module, __reifyWaitForDeps__, __reify_async_result__) {\n  \"use strict\";\n  try {\n    let domain;\n    module.link(\"domain\", {\n      default(v) {\n        domain = v;\n      }\n    }, 0);\n    let fs;\n    module.link(\"fs\", {\n      default(v) {\n        fs = v;\n      }\n    }, 1);\n    let stream;\n    module.link(\"stream\", {\n      default(v) {\n        stream = v;\n      }\n    }, 2);\n    let URL;\n    module.link(\"url\", {\n      default(v) {\n        URL = v;\n      }\n    }, 3);\n    let zlib;\n    module.link(\"zlib\", {\n      default(v) {\n        zlib = v;\n      }\n    }, 4);\n    let Meteor;\n    module.link(\"meteor/meteor\", {\n      Meteor(v) {\n        Meteor = v;\n      }\n    }, 5);\n    let WebApp;\n    module.link(\"meteor/webapp\", {\n      WebApp(v) {\n        WebApp = v;\n      }\n    }, 6);\n    let mkdirp;\n    module.link(\"mkdirp\", {\n      default(v) {\n        mkdirp = v;\n      }\n    }, 7);\n    let UploadFS;\n    module.link(\"./ufs\", {\n      UploadFS(v) {\n        UploadFS = v;\n      }\n    }, 8);\n    if (__reifyWaitForDeps__()) (await __reifyWaitForDeps__())();\n    Meteor.startup(() => {\n      const path = UploadFS.config.tmpDir;\n      const mode = UploadFS.config.tmpDirPermissions;\n      fs.stat(path, err => {\n        if (err) {\n          // Create the temp directory\n          mkdirp(path, {\n            mode\n          }).then(() => {\n            console.log(\"ufs: temp directory created at \\\"\".concat(path, \"\\\"\"));\n          }).catch(err => {\n            console.error(\"ufs: cannot create temp directory at \\\"\".concat(path, \"\\\" (\").concat(err.message, \")\"));\n          });\n        } else {\n          // Set directory permissions\n          fs.chmod(path, mode, err => {\n            err && console.error(\"ufs: cannot set temp directory permissions \".concat(mode, \" (\").concat(err.message, \")\"));\n          });\n        }\n      });\n    });\n    // Create domain to handle errors\n    // and possibly avoid server crashes.\n    const d = domain.create();\n    d.on('error', err => {\n      console.error(\"ufs: \".concat(err.message));\n    });\n    // Listen HTTP requests to serve files\n    WebApp.connectHandlers.use(async (req, res, next) => {\n      var _req$url, _parsedUrl$pathname;\n      // Quick check to see if request should be caught\n      if (!((_req$url = req.url) !== null && _req$url !== void 0 && _req$url.includes(\"/\".concat(UploadFS.config.storesPath, \"/\")))) {\n        next();\n        return;\n      }\n      // Remove store path\n      const parsedUrl = URL.parse(req.url, true);\n      const path = (_parsedUrl$pathname = parsedUrl.pathname) === null || _parsedUrl$pathname === void 0 ? void 0 : _parsedUrl$pathname.substr(UploadFS.config.storesPath.length + 1);\n      if (!path) {\n        next();\n        return;\n      }\n      const allowCORS = () => {\n        // res.setHeader('Access-Control-Allow-Origin', req.headers.origin);\n        res.setHeader('Access-Control-Allow-Methods', 'POST');\n        res.setHeader('Access-Control-Allow-Origin', '*');\n        res.setHeader('Access-Control-Allow-Headers', 'Content-Type');\n      };\n      if (req.method === 'OPTIONS') {\n        const regExp = new RegExp('^/([^/?]+)/([^/?]+)$');\n        const match = regExp.exec(path);\n        // Request is not valid\n        if (match === null) {\n          res.writeHead(400);\n          res.end();\n          return;\n        }\n        // Get store\n        const store = UploadFS.getStore(match[1]);\n        if (!store) {\n          res.writeHead(404);\n          res.end();\n          return;\n        }\n        // If a store is found, go ahead and allow the origin\n        allowCORS();\n        next();\n      } else if (req.method === 'POST') {\n        res.writeHead(404);\n        res.end();\n      } else if (req.method === 'GET') {\n        // Get store, file Id and file name\n        const regExp = new RegExp('^/([^/?]+)/([^/?]+)(?:/([^/?]+))?$');\n        const match = regExp.exec(path);\n        // Avoid 504 Gateway timeout error\n        // if file is not handled by UploadFS.\n        if (match === null) {\n          next();\n          return;\n        }\n        // Get store\n        const storeName = match[1];\n        const store = UploadFS.getStore(storeName);\n        if (!store) {\n          res.writeHead(404);\n          res.end();\n          return;\n        }\n        if (store.onRead !== null && store.onRead !== undefined && typeof store.onRead !== 'function') {\n          console.error(\"ufs: Store.onRead is not a function in store \\\"\".concat(storeName, \"\\\"\"));\n          res.writeHead(500);\n          res.end();\n          return;\n        }\n        // Remove file extension from file Id\n        const index = match[2].indexOf('.');\n        const fileId = index !== -1 ? match[2].substr(0, index) : match[2];\n        // Get file from database\n        const file = await store.getCollection().findOne({\n          _id: fileId\n        });\n        if (!file) {\n          res.writeHead(404);\n          res.end();\n          return;\n        }\n        await d.run(async () => {\n          // Check if the file can be accessed\n          if ((await store.onRead.call(store, fileId, file, req, res)) !== false) {\n            const options = {};\n            let status = 200;\n            // Prepare response headers\n            const headers = {\n              'Content-Type': file.type,\n              'Content-Length': file.size\n            };\n            // Add ETag header\n            if (typeof file.etag === 'string') {\n              headers.ETag = file.etag;\n            }\n            // Add Last-Modified header\n            if (file.modifiedAt instanceof Date) {\n              headers['Last-Modified'] = file.modifiedAt.toUTCString();\n            } else if (file.uploadedAt instanceof Date) {\n              headers['Last-Modified'] = file.uploadedAt.toUTCString();\n            }\n            // Parse request headers\n            if (typeof req.headers === 'object') {\n              // Compare ETag\n              if (req.headers['if-none-match']) {\n                if (file.etag === req.headers['if-none-match']) {\n                  res.writeHead(304); // Not Modified\n                  res.end();\n                  return;\n                }\n              }\n              // Compare file modification date\n              if (req.headers['if-modified-since']) {\n                const modifiedSince = new Date(req.headers['if-modified-since']);\n                if (file.modifiedAt instanceof Date && file.modifiedAt > modifiedSince ||\n                // eslint-disable-next-line no-mixed-operators\n                file.uploadedAt instanceof Date && file.uploadedAt > modifiedSince) {\n                  res.writeHead(304); // Not Modified\n                  res.end();\n                  return;\n                }\n              }\n              // Support range request\n              if (typeof req.headers.range === 'string') {\n                const {\n                  range\n                } = req.headers;\n                // Range is not valid\n                if (!range) {\n                  res.writeHead(416);\n                  res.end();\n                  return;\n                }\n                const total = file.size || 0;\n                const unit = range.substr(0, range.indexOf('='));\n                if (unit !== 'bytes') {\n                  res.writeHead(416);\n                  res.end();\n                  return;\n                }\n                const ranges = range.substr(unit.length).replace(/[^0-9\\-,]/, '').split(',');\n                if (ranges.length > 1) {\n                  // todo: support multipart ranges: https://developer.mozilla.org/en-US/docs/Web/HTTP/Range_requests\n                } else {\n                  const r = ranges[0].split('-');\n                  const start = parseInt(r[0], 10);\n                  const end = r[1] ? parseInt(r[1], 10) : total - 1;\n                  // Range is not valid\n                  if (start < 0 || end >= total || start > end) {\n                    res.writeHead(416);\n                    res.end();\n                    return;\n                  }\n                  // Update headers\n                  headers['Content-Range'] = \"bytes \".concat(start, \"-\").concat(end, \"/\").concat(total);\n                  headers['Content-Length'] = end - start + 1;\n                  options.start = start;\n                  options.end = end;\n                }\n                status = 206; // partial content\n              }\n            } else {\n              headers['Accept-Ranges'] = 'bytes';\n            }\n            // Open the file stream\n            const rs = await store.getReadStream(fileId, file, options);\n            const ws = new stream.PassThrough();\n            rs.on('error', err => {\n              store.onReadError.call(store, err, fileId, file);\n              res.end();\n            });\n            ws.on('error', err => {\n              store.onReadError.call(store, err, fileId, file);\n              res.end();\n            });\n            ws.on('close', () => {\n              // Close output stream at the end\n              ws.emit('end');\n            });\n            // Transform stream\n            store.transformRead(rs, ws, fileId, file, req, headers);\n            // Parse request headers\n            if (typeof req.headers === 'object') {\n              // Compress data using if needed (ignore audio/video as they are already compressed)\n              if (typeof req.headers['accept-encoding'] === 'string' && (!file.type || !/^(audio|video)/.test(file.type))) {\n                const accept = req.headers['accept-encoding'];\n                // Compress with gzip\n                if (accept.match(/\\bgzip\\b/)) {\n                  headers['Content-Encoding'] = 'gzip';\n                  delete headers['Content-Length'];\n                  res.writeHead(status, headers);\n                  ws.pipe(zlib.createGzip()).pipe(res);\n                  return;\n                }\n                // Compress with deflate\n                if (accept.match(/\\bdeflate\\b/)) {\n                  headers['Content-Encoding'] = 'deflate';\n                  delete headers['Content-Length'];\n                  res.writeHead(status, headers);\n                  ws.pipe(zlib.createDeflate()).pipe(res);\n                  return;\n                }\n              }\n            }\n            // Send raw data\n            if (!headers['Content-Encoding']) {\n              res.writeHead(status, headers);\n              ws.pipe(res);\n            }\n          } else {\n            res.end();\n          }\n        });\n      } else {\n        next();\n      }\n    });\n    __reify_async_result__();\n  } catch (_reifyError) {\n    return __reify_async_result__(_reifyError);\n  }\n  __reify_async_result__()\n}, {\n  self: this,\n  async: false\n});","map":{"version":3,"names":["domain","module","link","default","v","fs","stream","URL","zlib","Meteor","WebApp","mkdirp","UploadFS","__reifyWaitForDeps__","startup","path","config","tmpDir","mode","tmpDirPermissions","stat","err","then","console","log","concat","catch","error","message","chmod","d","create","on","connectHandlers","use","req","res","next","_req$url","_parsedUrl$pathname","url","includes","storesPath","parsedUrl","parse","pathname","substr","length","allowCORS","setHeader","method","regExp","RegExp","match","exec","writeHead","end","store","getStore","storeName","onRead","undefined","index","indexOf","fileId","file","getCollection","findOne","_id","run","call","options","status","headers","type","size","etag","ETag","modifiedAt","Date","toUTCString","uploadedAt","modifiedSince","range","total","unit","ranges","replace","split","r","start","parseInt","rs","getReadStream","ws","PassThrough","onReadError","emit","transformRead","test","accept","pipe","createGzip","createDeflate","__reify_async_result__","_reifyError","self","async"],"sources":["server/ufs/ufs-server.ts"],"sourcesContent":["import domain from 'domain';\nimport fs from 'fs';\nimport stream from 'stream';\nimport URL from 'url';\nimport zlib from 'zlib';\n\nimport { Meteor } from 'meteor/meteor';\nimport { WebApp } from 'meteor/webapp';\nimport mkdirp from 'mkdirp';\n\nimport { UploadFS } from './ufs';\n\nMeteor.startup(() => {\n\tconst path = UploadFS.config.tmpDir;\n\tconst mode = UploadFS.config.tmpDirPermissions;\n\n\tfs.stat(path, (err) => {\n\t\tif (err) {\n\t\t\t// Create the temp directory\n\t\t\tmkdirp(path, { mode })\n\t\t\t\t.then(() => {\n\t\t\t\t\tconsole.log(`ufs: temp directory created at \"${path}\"`);\n\t\t\t\t})\n\t\t\t\t.catch((err) => {\n\t\t\t\t\tconsole.error(`ufs: cannot create temp directory at \"${path}\" (${err.message})`);\n\t\t\t\t});\n\t\t} else {\n\t\t\t// Set directory permissions\n\t\t\tfs.chmod(path, mode, (err) => {\n\t\t\t\terr && console.error(`ufs: cannot set temp directory permissions ${mode} (${err.message})`);\n\t\t\t});\n\t\t}\n\t});\n});\n\n// Create domain to handle errors\n// and possibly avoid server crashes.\nconst d = domain.create();\n\nd.on('error', (err) => {\n\tconsole.error(`ufs: ${err.message}`);\n});\n\n// Listen HTTP requests to serve files\nWebApp.connectHandlers.use(async (req, res, next) => {\n\t// Quick check to see if request should be caught\n\tif (!req.url?.includes(`/${UploadFS.config.storesPath}/`)) {\n\t\tnext();\n\t\treturn;\n\t}\n\n\t// Remove store path\n\tconst parsedUrl = URL.parse(req.url, true);\n\tconst path = parsedUrl.pathname?.substr(UploadFS.config.storesPath.length + 1);\n\n\tif (!path) {\n\t\tnext();\n\t\treturn;\n\t}\n\n\tconst allowCORS = () => {\n\t\t// res.setHeader('Access-Control-Allow-Origin', req.headers.origin);\n\t\tres.setHeader('Access-Control-Allow-Methods', 'POST');\n\t\tres.setHeader('Access-Control-Allow-Origin', '*');\n\t\tres.setHeader('Access-Control-Allow-Headers', 'Content-Type');\n\t};\n\n\tif (req.method === 'OPTIONS') {\n\t\tconst regExp = new RegExp('^/([^/?]+)/([^/?]+)$');\n\t\tconst match = regExp.exec(path);\n\n\t\t// Request is not valid\n\t\tif (match === null) {\n\t\t\tres.writeHead(400);\n\t\t\tres.end();\n\t\t\treturn;\n\t\t}\n\n\t\t// Get store\n\t\tconst store = UploadFS.getStore(match[1]);\n\t\tif (!store) {\n\t\t\tres.writeHead(404);\n\t\t\tres.end();\n\t\t\treturn;\n\t\t}\n\n\t\t// If a store is found, go ahead and allow the origin\n\t\tallowCORS();\n\n\t\tnext();\n\t} else if (req.method === 'POST') {\n\t\tres.writeHead(404);\n\t\tres.end();\n\t} else if (req.method === 'GET') {\n\t\t// Get store, file Id and file name\n\t\tconst regExp = new RegExp('^/([^/?]+)/([^/?]+)(?:/([^/?]+))?$');\n\t\tconst match = regExp.exec(path);\n\n\t\t// Avoid 504 Gateway timeout error\n\t\t// if file is not handled by UploadFS.\n\t\tif (match === null) {\n\t\t\tnext();\n\t\t\treturn;\n\t\t}\n\n\t\t// Get store\n\t\tconst storeName = match[1];\n\t\tconst store = UploadFS.getStore(storeName);\n\n\t\tif (!store) {\n\t\t\tres.writeHead(404);\n\t\t\tres.end();\n\t\t\treturn;\n\t\t}\n\n\t\tif (store.onRead !== null && store.onRead !== undefined && typeof store.onRead !== 'function') {\n\t\t\tconsole.error(`ufs: Store.onRead is not a function in store \"${storeName}\"`);\n\t\t\tres.writeHead(500);\n\t\t\tres.end();\n\t\t\treturn;\n\t\t}\n\n\t\t// Remove file extension from file Id\n\t\tconst index = match[2].indexOf('.');\n\t\tconst fileId = index !== -1 ? match[2].substr(0, index) : match[2];\n\n\t\t// Get file from database\n\t\tconst file = await store.getCollection().findOne({ _id: fileId });\n\t\tif (!file) {\n\t\t\tres.writeHead(404);\n\t\t\tres.end();\n\t\t\treturn;\n\t\t}\n\n\t\tawait d.run(async () => {\n\t\t\t// Check if the file can be accessed\n\t\t\tif ((await store.onRead.call(store, fileId, file, req, res)) !== false) {\n\t\t\t\tconst options: {\n\t\t\t\t\tstart?: number;\n\t\t\t\t\tend?: number;\n\t\t\t\t} = {};\n\t\t\t\tlet status = 200;\n\n\t\t\t\t// Prepare response headers\n\t\t\t\tconst headers: Record<string, any> = {\n\t\t\t\t\t'Content-Type': file.type,\n\t\t\t\t\t'Content-Length': file.size,\n\t\t\t\t};\n\n\t\t\t\t// Add ETag header\n\t\t\t\tif (typeof file.etag === 'string') {\n\t\t\t\t\theaders.ETag = file.etag;\n\t\t\t\t}\n\n\t\t\t\t// Add Last-Modified header\n\t\t\t\tif (file.modifiedAt instanceof Date) {\n\t\t\t\t\theaders['Last-Modified'] = file.modifiedAt.toUTCString();\n\t\t\t\t} else if (file.uploadedAt instanceof Date) {\n\t\t\t\t\theaders['Last-Modified'] = file.uploadedAt.toUTCString();\n\t\t\t\t}\n\n\t\t\t\t// Parse request headers\n\t\t\t\tif (typeof req.headers === 'object') {\n\t\t\t\t\t// Compare ETag\n\t\t\t\t\tif (req.headers['if-none-match']) {\n\t\t\t\t\t\tif (file.etag === req.headers['if-none-match']) {\n\t\t\t\t\t\t\tres.writeHead(304); // Not Modified\n\t\t\t\t\t\t\tres.end();\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\t// Compare file modification date\n\t\t\t\t\tif (req.headers['if-modified-since']) {\n\t\t\t\t\t\tconst modifiedSince = new Date(req.headers['if-modified-since']);\n\n\t\t\t\t\t\tif (\n\t\t\t\t\t\t\t(file.modifiedAt instanceof Date && file.modifiedAt > modifiedSince) ||\n\t\t\t\t\t\t\t// eslint-disable-next-line no-mixed-operators\n\t\t\t\t\t\t\t(file.uploadedAt instanceof Date && file.uploadedAt > modifiedSince)\n\t\t\t\t\t\t) {\n\t\t\t\t\t\t\tres.writeHead(304); // Not Modified\n\t\t\t\t\t\t\tres.end();\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\t// Support range request\n\t\t\t\t\tif (typeof req.headers.range === 'string') {\n\t\t\t\t\t\tconst { range } = req.headers;\n\n\t\t\t\t\t\t// Range is not valid\n\t\t\t\t\t\tif (!range) {\n\t\t\t\t\t\t\tres.writeHead(416);\n\t\t\t\t\t\t\tres.end();\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tconst total = file.size || 0;\n\t\t\t\t\t\tconst unit = range.substr(0, range.indexOf('='));\n\n\t\t\t\t\t\tif (unit !== 'bytes') {\n\t\t\t\t\t\t\tres.writeHead(416);\n\t\t\t\t\t\t\tres.end();\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tconst ranges = range\n\t\t\t\t\t\t\t.substr(unit.length)\n\t\t\t\t\t\t\t.replace(/[^0-9\\-,]/, '')\n\t\t\t\t\t\t\t.split(',');\n\n\t\t\t\t\t\tif (ranges.length > 1) {\n\t\t\t\t\t\t\t// todo: support multipart ranges: https://developer.mozilla.org/en-US/docs/Web/HTTP/Range_requests\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tconst r = ranges[0].split('-');\n\t\t\t\t\t\t\tconst start = parseInt(r[0], 10);\n\t\t\t\t\t\t\tconst end = r[1] ? parseInt(r[1], 10) : total - 1;\n\n\t\t\t\t\t\t\t// Range is not valid\n\t\t\t\t\t\t\tif (start < 0 || end >= total || start > end) {\n\t\t\t\t\t\t\t\tres.writeHead(416);\n\t\t\t\t\t\t\t\tres.end();\n\t\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t// Update headers\n\t\t\t\t\t\t\theaders['Content-Range'] = `bytes ${start}-${end}/${total}`;\n\t\t\t\t\t\t\theaders['Content-Length'] = end - start + 1;\n\t\t\t\t\t\t\toptions.start = start;\n\t\t\t\t\t\t\toptions.end = end;\n\t\t\t\t\t\t}\n\t\t\t\t\t\tstatus = 206; // partial content\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\theaders['Accept-Ranges'] = 'bytes';\n\t\t\t\t}\n\n\t\t\t\t// Open the file stream\n\t\t\t\tconst rs = await store.getReadStream(fileId, file, options);\n\t\t\t\tconst ws = new stream.PassThrough();\n\n\t\t\t\trs.on('error', (err) => {\n\t\t\t\t\tstore.onReadError.call(store, err, fileId, file);\n\t\t\t\t\tres.end();\n\t\t\t\t});\n\t\t\t\tws.on('error', (err) => {\n\t\t\t\t\tstore.onReadError.call(store, err, fileId, file);\n\t\t\t\t\tres.end();\n\t\t\t\t});\n\t\t\t\tws.on('close', () => {\n\t\t\t\t\t// Close output stream at the end\n\t\t\t\t\tws.emit('end');\n\t\t\t\t});\n\n\t\t\t\t// Transform stream\n\t\t\t\tstore.transformRead(rs, ws, fileId, file, req, headers);\n\n\t\t\t\t// Parse request headers\n\t\t\t\tif (typeof req.headers === 'object') {\n\t\t\t\t\t// Compress data using if needed (ignore audio/video as they are already compressed)\n\t\t\t\t\tif (typeof req.headers['accept-encoding'] === 'string' && (!file.type || !/^(audio|video)/.test(file.type))) {\n\t\t\t\t\t\tconst accept = req.headers['accept-encoding'];\n\n\t\t\t\t\t\t// Compress with gzip\n\t\t\t\t\t\tif (accept.match(/\\bgzip\\b/)) {\n\t\t\t\t\t\t\theaders['Content-Encoding'] = 'gzip';\n\t\t\t\t\t\t\tdelete headers['Content-Length'];\n\t\t\t\t\t\t\tres.writeHead(status, headers);\n\t\t\t\t\t\t\tws.pipe(zlib.createGzip()).pipe(res);\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\t\t\t\t\t\t// Compress with deflate\n\t\t\t\t\t\tif (accept.match(/\\bdeflate\\b/)) {\n\t\t\t\t\t\t\theaders['Content-Encoding'] = 'deflate';\n\t\t\t\t\t\t\tdelete headers['Content-Length'];\n\t\t\t\t\t\t\tres.writeHead(status, headers);\n\t\t\t\t\t\t\tws.pipe(zlib.createDeflate()).pipe(res);\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\t// Send raw data\n\t\t\t\tif (!headers['Content-Encoding']) {\n\t\t\t\t\tres.writeHead(status, headers);\n\t\t\t\t\tws.pipe(res);\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tres.end();\n\t\t\t}\n\t\t});\n\t} else {\n\t\tnext();\n\t}\n});\n"],"mappings":";;;IAAA,IAAAA,MAAO;IAAAC,MAAM,CAAAC,IAAM,SAAS;MAAAC,QAAAC,CAAA;QAAAJ,MAAA,GAAAI,CAAA;MAAA;IAAA;IAAA,IAAAC,EAAA;IAAAJ,MAAA,CAAAC,IAAA;MAAAC,QAAAC,CAAA;QAAAC,EAAA,GAAAD,CAAA;MAAA;IAAA;IAAA,IAAAE,MAAA;IAAAL,MAAA,CAAAC,IAAA;MAAAC,QAAAC,CAAA;QAAAE,MAAA,GAAAF,CAAA;MAAA;IAAA;IAAA,IAAAG,GAAA;IAAAN,MAAA,CAAAC,IAAA;MAAAC,QAAAC,CAAA;QAAAG,GAAA,GAAAH,CAAA;MAAA;IAAA;IAAA,IAAAI,IAAA;IAAAP,MAAA,CAAAC,IAAA;MAAAC,QAAAC,CAAA;QAAAI,IAAA,GAAAJ,CAAA;MAAA;IAAA;IAAA,IAAAK,MAAA;IAAAR,MAAA,CAAAC,IAAA;MAAAO,OAAAL,CAAA;QAAAK,MAAA,GAAAL,CAAA;MAAA;IAAA;IAAA,IAAAM,MAAA;IAAAT,MAAA,CAAAC,IAAA;MAAAQ,OAAAN,CAAA;QAAAM,MAAA,GAAAN,CAAA;MAAA;IAAA;IAAA,IAAAO,MAAA;IAAAV,MAAA,CAAAC,IAAA;MAAAC,QAAAC,CAAA;QAAAO,MAAA,GAAAP,CAAA;MAAA;IAAA;IAAA,IAAAQ,QAAA;IAAAX,MAAA,CAAAC,IAAA;MAAAU,SAAAR,CAAA;QAAAQ,QAAA,GAAAR,CAAA;MAAA;IAAA;IAAA,IAAAS,oBAAA,WAAAA,oBAAA;IAY5BJ,MAAM,CAACK,OAAO,CAAC,MAAK;MACnB,MAAMC,IAAI,GAAGH,QAAQ,CAACI,MAAM,CAACC,MAAM;MACnC,MAAMC,IAAI,GAAGN,QAAQ,CAACI,MAAM,CAACG,iBAAiB;MAE9Cd,EAAE,CAACe,IAAI,CAACL,IAAI,EAAGM,GAAG,IAAI;QACrB,IAAIA,GAAG,EAAE;UACR;UACAV,MAAM,CAACI,IAAI,EAAE;YAAEG;UAAI,CAAE,CAAC,CACpBI,IAAI,CAAC,MAAK;YACVC,OAAO,CAACC,GAAG,qCAAAC,MAAA,CAAoCV,IAAI,OAAG,CAAC;UACxD,CAAC,CAAC,CACDW,KAAK,CAAEL,GAAG,IAAI;YACdE,OAAO,CAACI,KAAK,2CAAAF,MAAA,CAA0CV,IAAI,UAAAU,MAAA,CAAMJ,GAAG,CAACO,OAAO,MAAG,CAAC;UACjF,CAAC,CAAC;QACJ,CAAC,MAAM;UACN;UACAvB,EAAE,CAACwB,KAAK,CAACd,IAAI,EAAEG,IAAI,EAAGG,GAAG,IAAI;YAC5BA,GAAG,IAAIE,OAAO,CAACI,KAAK,+CAAAF,MAAA,CAA+CP,IAAI,QAAAO,MAAA,CAAKJ,GAAG,CAACO,OAAO,MAAG,CAAC;UAC5F,CAAC,CAAC;QACH;MACD,CAAC,CAAC;IACH,CAAC,CAAC;IAEF;IACA;IACA,MAAME,CAAC,GAAG9B,MAAM,CAAC+B,MAAM,EAAE;IAEzBD,CAAC,CAACE,EAAE,CAAC,OAAO,EAAGX,GAAG,IAAI;MACrBE,OAAO,CAACI,KAAK,SAAAF,MAAA,CAASJ,GAAG,CAACO,OAAO,CAAE,CAAC;IACrC,CAAC,CAAC;IAEF;IACAlB,MAAM,CAACuB,eAAe,CAACC,GAAG,CAAC,OAAOC,GAAG,EAAEC,GAAG,EAAEC,IAAI,KAAI;MAAA,IAAAC,QAAA,EAAAC,mBAAA;MACnD;MACA,IAAI,GAAAD,QAAA,GAACH,GAAG,CAACK,GAAG,cAAAF,QAAA,eAAPA,QAAA,CAASG,QAAQ,KAAAhB,MAAA,CAAKb,QAAQ,CAACI,MAAM,CAAC0B,UAAU,MAAG,CAAC,GAAE;QAC1DL,IAAI,EAAE;QACN;MACD;MAEA;MACA,MAAMM,SAAS,GAAGpC,GAAG,CAACqC,KAAK,CAACT,GAAG,CAACK,GAAG,EAAE,IAAI,CAAC;MAC1C,MAAMzB,IAAI,IAAAwB,mBAAA,GAAGI,SAAS,CAACE,QAAQ,cAAAN,mBAAA,uBAAlBA,mBAAA,CAAoBO,MAAM,CAAClC,QAAQ,CAACI,MAAM,CAAC0B,UAAU,CAACK,MAAM,GAAG,CAAC,CAAC;MAE9E,IAAI,CAAChC,IAAI,EAAE;QACVsB,IAAI,EAAE;QACN;MACD;MAEA,MAAMW,SAAS,GAAGA,CAAA,KAAK;QACtB;QACAZ,GAAG,CAACa,SAAS,CAAC,8BAA8B,EAAE,MAAM,CAAC;QACrDb,GAAG,CAACa,SAAS,CAAC,6BAA6B,EAAE,GAAG,CAAC;QACjDb,GAAG,CAACa,SAAS,CAAC,8BAA8B,EAAE,cAAc,CAAC;MAC9D,CAAC;MAED,IAAId,GAAG,CAACe,MAAM,KAAK,SAAS,EAAE;QAC7B,MAAMC,MAAM,GAAG,IAAIC,MAAM,CAAC,sBAAsB,CAAC;QACjD,MAAMC,KAAK,GAAGF,MAAM,CAACG,IAAI,CAACvC,IAAI,CAAC;QAE/B;QACA,IAAIsC,KAAK,KAAK,IAAI,EAAE;UACnBjB,GAAG,CAACmB,SAAS,CAAC,GAAG,CAAC;UAClBnB,GAAG,CAACoB,GAAG,EAAE;UACT;QACD;QAEA;QACA,MAAMC,KAAK,GAAG7C,QAAQ,CAAC8C,QAAQ,CAACL,KAAK,CAAC,CAAC,CAAC,CAAC;QACzC,IAAI,CAACI,KAAK,EAAE;UACXrB,GAAG,CAACmB,SAAS,CAAC,GAAG,CAAC;UAClBnB,GAAG,CAACoB,GAAG,EAAE;UACT;QACD;QAEA;QACAR,SAAS,EAAE;QAEXX,IAAI,EAAE;MACP,CAAC,MAAM,IAAIF,GAAG,CAACe,MAAM,KAAK,MAAM,EAAE;QACjCd,GAAG,CAACmB,SAAS,CAAC,GAAG,CAAC;QAClBnB,GAAG,CAACoB,GAAG,EAAE;MACV,CAAC,MAAM,IAAIrB,GAAG,CAACe,MAAM,KAAK,KAAK,EAAE;QAChC;QACA,MAAMC,MAAM,GAAG,IAAIC,MAAM,CAAC,oCAAoC,CAAC;QAC/D,MAAMC,KAAK,GAAGF,MAAM,CAACG,IAAI,CAACvC,IAAI,CAAC;QAE/B;QACA;QACA,IAAIsC,KAAK,KAAK,IAAI,EAAE;UACnBhB,IAAI,EAAE;UACN;QACD;QAEA;QACA,MAAMsB,SAAS,GAAGN,KAAK,CAAC,CAAC,CAAC;QAC1B,MAAMI,KAAK,GAAG7C,QAAQ,CAAC8C,QAAQ,CAACC,SAAS,CAAC;QAE1C,IAAI,CAACF,KAAK,EAAE;UACXrB,GAAG,CAACmB,SAAS,CAAC,GAAG,CAAC;UAClBnB,GAAG,CAACoB,GAAG,EAAE;UACT;QACD;QAEA,IAAIC,KAAK,CAACG,MAAM,KAAK,IAAI,IAAIH,KAAK,CAACG,MAAM,KAAKC,SAAS,IAAI,OAAOJ,KAAK,CAACG,MAAM,KAAK,UAAU,EAAE;UAC9FrC,OAAO,CAACI,KAAK,mDAAAF,MAAA,CAAkDkC,SAAS,OAAG,CAAC;UAC5EvB,GAAG,CAACmB,SAAS,CAAC,GAAG,CAAC;UAClBnB,GAAG,CAACoB,GAAG,EAAE;UACT;QACD;QAEA;QACA,MAAMM,KAAK,GAAGT,KAAK,CAAC,CAAC,CAAC,CAACU,OAAO,CAAC,GAAG,CAAC;QACnC,MAAMC,MAAM,GAAGF,KAAK,KAAK,CAAC,CAAC,GAAGT,KAAK,CAAC,CAAC,CAAC,CAACP,MAAM,CAAC,CAAC,EAAEgB,KAAK,CAAC,GAAGT,KAAK,CAAC,CAAC,CAAC;QAElE;QACA,MAAMY,IAAI,GAAG,MAAMR,KAAK,CAACS,aAAa,EAAE,CAACC,OAAO,CAAC;UAAEC,GAAG,EAAEJ;QAAM,CAAE,CAAC;QACjE,IAAI,CAACC,IAAI,EAAE;UACV7B,GAAG,CAACmB,SAAS,CAAC,GAAG,CAAC;UAClBnB,GAAG,CAACoB,GAAG,EAAE;UACT;QACD;QAEA,MAAM1B,CAAC,CAACuC,GAAG,CAAC,YAAW;UACtB;UACA,IAAI,CAAC,MAAMZ,KAAK,CAACG,MAAM,CAACU,IAAI,CAACb,KAAK,EAAEO,MAAM,EAAEC,IAAI,EAAE9B,GAAG,EAAEC,GAAG,CAAC,MAAM,KAAK,EAAE;YACvE,MAAMmC,OAAO,GAGT,EAAE;YACN,IAAIC,MAAM,GAAG,GAAG;YAEhB;YACA,MAAMC,OAAO,GAAwB;cACpC,cAAc,EAAER,IAAI,CAACS,IAAI;cACzB,gBAAgB,EAAET,IAAI,CAACU;aACvB;YAED;YACA,IAAI,OAAOV,IAAI,CAACW,IAAI,KAAK,QAAQ,EAAE;cAClCH,OAAO,CAACI,IAAI,GAAGZ,IAAI,CAACW,IAAI;YACzB;YAEA;YACA,IAAIX,IAAI,CAACa,UAAU,YAAYC,IAAI,EAAE;cACpCN,OAAO,CAAC,eAAe,CAAC,GAAGR,IAAI,CAACa,UAAU,CAACE,WAAW,EAAE;YACzD,CAAC,MAAM,IAAIf,IAAI,CAACgB,UAAU,YAAYF,IAAI,EAAE;cAC3CN,OAAO,CAAC,eAAe,CAAC,GAAGR,IAAI,CAACgB,UAAU,CAACD,WAAW,EAAE;YACzD;YAEA;YACA,IAAI,OAAO7C,GAAG,CAACsC,OAAO,KAAK,QAAQ,EAAE;cACpC;cACA,IAAItC,GAAG,CAACsC,OAAO,CAAC,eAAe,CAAC,EAAE;gBACjC,IAAIR,IAAI,CAACW,IAAI,KAAKzC,GAAG,CAACsC,OAAO,CAAC,eAAe,CAAC,EAAE;kBAC/CrC,GAAG,CAACmB,SAAS,CAAC,GAAG,CAAC,CAAC,CAAC;kBACpBnB,GAAG,CAACoB,GAAG,EAAE;kBACT;gBACD;cACD;cAEA;cACA,IAAIrB,GAAG,CAACsC,OAAO,CAAC,mBAAmB,CAAC,EAAE;gBACrC,MAAMS,aAAa,GAAG,IAAIH,IAAI,CAAC5C,GAAG,CAACsC,OAAO,CAAC,mBAAmB,CAAC,CAAC;gBAEhE,IACER,IAAI,CAACa,UAAU,YAAYC,IAAI,IAAId,IAAI,CAACa,UAAU,GAAGI,aAAa;gBACnE;gBACCjB,IAAI,CAACgB,UAAU,YAAYF,IAAI,IAAId,IAAI,CAACgB,UAAU,GAAGC,aAAc,EACnE;kBACD9C,GAAG,CAACmB,SAAS,CAAC,GAAG,CAAC,CAAC,CAAC;kBACpBnB,GAAG,CAACoB,GAAG,EAAE;kBACT;gBACD;cACD;cAEA;cACA,IAAI,OAAOrB,GAAG,CAACsC,OAAO,CAACU,KAAK,KAAK,QAAQ,EAAE;gBAC1C,MAAM;kBAAEA;gBAAK,CAAE,GAAGhD,GAAG,CAACsC,OAAO;gBAE7B;gBACA,IAAI,CAACU,KAAK,EAAE;kBACX/C,GAAG,CAACmB,SAAS,CAAC,GAAG,CAAC;kBAClBnB,GAAG,CAACoB,GAAG,EAAE;kBACT;gBACD;gBAEA,MAAM4B,KAAK,GAAGnB,IAAI,CAACU,IAAI,IAAI,CAAC;gBAC5B,MAAMU,IAAI,GAAGF,KAAK,CAACrC,MAAM,CAAC,CAAC,EAAEqC,KAAK,CAACpB,OAAO,CAAC,GAAG,CAAC,CAAC;gBAEhD,IAAIsB,IAAI,KAAK,OAAO,EAAE;kBACrBjD,GAAG,CAACmB,SAAS,CAAC,GAAG,CAAC;kBAClBnB,GAAG,CAACoB,GAAG,EAAE;kBACT;gBACD;gBAEA,MAAM8B,MAAM,GAAGH,KAAK,CAClBrC,MAAM,CAACuC,IAAI,CAACtC,MAAM,CAAC,CACnBwC,OAAO,CAAC,WAAW,EAAE,EAAE,CAAC,CACxBC,KAAK,CAAC,GAAG,CAAC;gBAEZ,IAAIF,MAAM,CAACvC,MAAM,GAAG,CAAC,EAAE;kBACtB;gBAAA,CACA,MAAM;kBACN,MAAM0C,CAAC,GAAGH,MAAM,CAAC,CAAC,CAAC,CAACE,KAAK,CAAC,GAAG,CAAC;kBAC9B,MAAME,KAAK,GAAGC,QAAQ,CAACF,CAAC,CAAC,CAAC,CAAC,EAAE,EAAE,CAAC;kBAChC,MAAMjC,GAAG,GAAGiC,CAAC,CAAC,CAAC,CAAC,GAAGE,QAAQ,CAACF,CAAC,CAAC,CAAC,CAAC,EAAE,EAAE,CAAC,GAAGL,KAAK,GAAG,CAAC;kBAEjD;kBACA,IAAIM,KAAK,GAAG,CAAC,IAAIlC,GAAG,IAAI4B,KAAK,IAAIM,KAAK,GAAGlC,GAAG,EAAE;oBAC7CpB,GAAG,CAACmB,SAAS,CAAC,GAAG,CAAC;oBAClBnB,GAAG,CAACoB,GAAG,EAAE;oBACT;kBACD;kBAEA;kBACAiB,OAAO,CAAC,eAAe,CAAC,YAAAhD,MAAA,CAAYiE,KAAK,OAAAjE,MAAA,CAAI+B,GAAG,OAAA/B,MAAA,CAAI2D,KAAK,CAAE;kBAC3DX,OAAO,CAAC,gBAAgB,CAAC,GAAGjB,GAAG,GAAGkC,KAAK,GAAG,CAAC;kBAC3CnB,OAAO,CAACmB,KAAK,GAAGA,KAAK;kBACrBnB,OAAO,CAACf,GAAG,GAAGA,GAAG;gBAClB;gBACAgB,MAAM,GAAG,GAAG,CAAC,CAAC;cACf;YACD,CAAC,MAAM;cACNC,OAAO,CAAC,eAAe,CAAC,GAAG,OAAO;YACnC;YAEA;YACA,MAAMmB,EAAE,GAAG,MAAMnC,KAAK,CAACoC,aAAa,CAAC7B,MAAM,EAAEC,IAAI,EAAEM,OAAO,CAAC;YAC3D,MAAMuB,EAAE,GAAG,IAAIxF,MAAM,CAACyF,WAAW,EAAE;YAEnCH,EAAE,CAAC5D,EAAE,CAAC,OAAO,EAAGX,GAAG,IAAI;cACtBoC,KAAK,CAACuC,WAAW,CAAC1B,IAAI,CAACb,KAAK,EAAEpC,GAAG,EAAE2C,MAAM,EAAEC,IAAI,CAAC;cAChD7B,GAAG,CAACoB,GAAG,EAAE;YACV,CAAC,CAAC;YACFsC,EAAE,CAAC9D,EAAE,CAAC,OAAO,EAAGX,GAAG,IAAI;cACtBoC,KAAK,CAACuC,WAAW,CAAC1B,IAAI,CAACb,KAAK,EAAEpC,GAAG,EAAE2C,MAAM,EAAEC,IAAI,CAAC;cAChD7B,GAAG,CAACoB,GAAG,EAAE;YACV,CAAC,CAAC;YACFsC,EAAE,CAAC9D,EAAE,CAAC,OAAO,EAAE,MAAK;cACnB;cACA8D,EAAE,CAACG,IAAI,CAAC,KAAK,CAAC;YACf,CAAC,CAAC;YAEF;YACAxC,KAAK,CAACyC,aAAa,CAACN,EAAE,EAAEE,EAAE,EAAE9B,MAAM,EAAEC,IAAI,EAAE9B,GAAG,EAAEsC,OAAO,CAAC;YAEvD;YACA,IAAI,OAAOtC,GAAG,CAACsC,OAAO,KAAK,QAAQ,EAAE;cACpC;cACA,IAAI,OAAOtC,GAAG,CAACsC,OAAO,CAAC,iBAAiB,CAAC,KAAK,QAAQ,KAAK,CAACR,IAAI,CAACS,IAAI,IAAI,CAAC,gBAAgB,CAACyB,IAAI,CAAClC,IAAI,CAACS,IAAI,CAAC,CAAC,EAAE;gBAC5G,MAAM0B,MAAM,GAAGjE,GAAG,CAACsC,OAAO,CAAC,iBAAiB,CAAC;gBAE7C;gBACA,IAAI2B,MAAM,CAAC/C,KAAK,CAAC,UAAU,CAAC,EAAE;kBAC7BoB,OAAO,CAAC,kBAAkB,CAAC,GAAG,MAAM;kBACpC,OAAOA,OAAO,CAAC,gBAAgB,CAAC;kBAChCrC,GAAG,CAACmB,SAAS,CAACiB,MAAM,EAAEC,OAAO,CAAC;kBAC9BqB,EAAE,CAACO,IAAI,CAAC7F,IAAI,CAAC8F,UAAU,EAAE,CAAC,CAACD,IAAI,CAACjE,GAAG,CAAC;kBACpC;gBACD;gBACA;gBACA,IAAIgE,MAAM,CAAC/C,KAAK,CAAC,aAAa,CAAC,EAAE;kBAChCoB,OAAO,CAAC,kBAAkB,CAAC,GAAG,SAAS;kBACvC,OAAOA,OAAO,CAAC,gBAAgB,CAAC;kBAChCrC,GAAG,CAACmB,SAAS,CAACiB,MAAM,EAAEC,OAAO,CAAC;kBAC9BqB,EAAE,CAACO,IAAI,CAAC7F,IAAI,CAAC+F,aAAa,EAAE,CAAC,CAACF,IAAI,CAACjE,GAAG,CAAC;kBACvC;gBACD;cACD;YACD;YAEA;YACA,IAAI,CAACqC,OAAO,CAAC,kBAAkB,CAAC,EAAE;cACjCrC,GAAG,CAACmB,SAAS,CAACiB,MAAM,EAAEC,OAAO,CAAC;cAC9BqB,EAAE,CAACO,IAAI,CAACjE,GAAG,CAAC;YACb;UACD,CAAC,MAAM;YACNA,GAAG,CAACoB,GAAG,EAAE;UACV;QACD,CAAC,CAAC;MACH,CAAC,MAAM;QACNnB,IAAI,EAAE;MACP;IACD,CAAC,CAAC;IAACmE,sBAAA;EAAA,SAAAC,WAAA;IAAA,OAAAD,sBAAA,CAAAC,WAAA;EAAA;EAAAD,sBAAA;AAAA;EAAAE,IAAA;EAAAC,KAAA;AAAA","ignoreList":[]},"sourceType":"module","externalDependencies":{},"hash":"ae6bba0a695e88900d8c4842b478104df9ee2dd0"}
