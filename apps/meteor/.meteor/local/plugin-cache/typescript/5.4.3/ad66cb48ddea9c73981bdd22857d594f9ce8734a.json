{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/server/services/omnichannel-analytics/service.ts","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","topLevelAwait","objectRestSpread","objectRestSpread","asyncGenerators","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"os.osx.arm64"},"sourceFileName":"server/services/omnichannel-analytics/service.ts","filename":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/server/services/omnichannel-analytics/service.ts","inputSourceMap":{"version":3,"file":"server/services/omnichannel-analytics/service.ts","sourceRoot":"","sources":["server/services/omnichannel-analytics/service.ts"],"names":[],"mappings":"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","sourcesContent":["/* eslint-disable new-cap */\nimport { ServiceClassInternal } from '@rocket.chat/core-services';\nimport type {\n\tAgentOverviewDataOptions,\n\tAnalyticsOverviewDataOptions,\n\tChartDataOptions,\n\tIOmnichannelAnalyticsService,\n} from '@rocket.chat/core-services';\nimport { LivechatRooms } from '@rocket.chat/models';\nimport moment from 'moment-timezone';\n\nimport { AgentOverviewData } from './AgentData';\nimport { ChartData } from './ChartData';\nimport { OverviewData } from './OverviewData';\nimport { serviceLogger } from './logger';\nimport { dayIterator } from './utils';\nimport { getTimezone } from '../../../app/utils/server/lib/getTimezone';\nimport { callbacks } from '../../../lib/callbacks';\nimport { i18n } from '../../lib/i18n';\n\nconst HOURS_IN_DAY = 24;\n\n// TODO: move EE analytics to this service & remove callback usage\nexport class OmnichannelAnalyticsService extends ServiceClassInternal implements IOmnichannelAnalyticsService {\n\tprotected name = 'omnichannel-analytics';\n\n\treadonly overview: OverviewData;\n\n\treadonly chart: ChartData;\n\n\treadonly agentOverview: AgentOverviewData;\n\n\tconstructor() {\n\t\tsuper();\n\t\tthis.overview = new OverviewData(LivechatRooms);\n\t\tthis.chart = new ChartData(LivechatRooms);\n\t\tthis.agentOverview = new AgentOverviewData(LivechatRooms);\n\t}\n\n\tasync getAgentOverviewData(options: AgentOverviewDataOptions) {\n\t\tconst { departmentId, utcOffset, daterange: { from: fDate, to: tDate } = {}, chartOptions: { name } = {} } = options;\n\t\tconst timezone = getTimezone({ utcOffset });\n\t\tconst from = moment\n\t\t\t.tz(fDate || '', 'YYYY-MM-DD', timezone)\n\t\t\t.startOf('day')\n\t\t\t.utc();\n\t\tconst to = moment\n\t\t\t.tz(tDate || '', 'YYYY-MM-DD', timezone)\n\t\t\t.endOf('day')\n\t\t\t.utc();\n\n\t\tif (!moment(from).isValid() || !moment(to).isValid()) {\n\t\t\tserviceLogger.error('AgentOverview -> Invalid dates');\n\t\t\treturn;\n\t\t}\n\n\t\tif (!this.agentOverview.isActionAllowed(name)) {\n\t\t\tserviceLogger.error(`AgentOverview.${name} is not a valid action`);\n\t\t\treturn;\n\t\t}\n\n\t\tconst extraQuery = await callbacks.run('livechat.applyRoomRestrictions', {});\n\t\treturn this.agentOverview.callAction(name, from, to, departmentId, extraQuery);\n\t}\n\n\tasync getAnalyticsChartData(options: ChartDataOptions) {\n\t\tconst {\n\t\t\tutcOffset,\n\t\t\tdepartmentId,\n\t\t\tdaterange: { from: fDate, to: tDate } = {},\n\t\t\tchartOptions: { name: chartLabel },\n\t\t} = options;\n\n\t\t// Check if function exists, prevent server error in case property altered\n\t\tif (!this.chart.isActionAllowed(chartLabel)) {\n\t\t\tserviceLogger.error(`ChartData.${chartLabel} is not a valid action`);\n\t\t\treturn;\n\t\t}\n\n\t\tconst timezone = getTimezone({ utcOffset });\n\t\tconst from = moment\n\t\t\t.tz(fDate || '', 'YYYY-MM-DD', timezone)\n\t\t\t.startOf('day')\n\t\t\t.utc();\n\t\tconst to = moment\n\t\t\t.tz(tDate || '', 'YYYY-MM-DD', timezone)\n\t\t\t.endOf('day')\n\t\t\t.utc();\n\t\tconst isSameDay = from.diff(to, 'days') === 0;\n\n\t\tif (!moment(from).isValid() || !moment(to).isValid()) {\n\t\t\tserviceLogger.error('ChartData -> Invalid dates');\n\t\t\treturn;\n\t\t}\n\n\t\tconst data: {\n\t\t\tchartLabel: string;\n\t\t\tdataLabels: string[];\n\t\t\tdataPoints: number[];\n\t\t} = {\n\t\t\tchartLabel,\n\t\t\tdataLabels: [],\n\t\t\tdataPoints: [],\n\t\t};\n\n\t\tconst extraQuery = await callbacks.run('livechat.applyRoomRestrictions', {});\n\t\tif (isSameDay) {\n\t\t\t// data for single day\n\t\t\tconst m = moment(from);\n\t\t\tfor await (const currentHour of Array.from({ length: HOURS_IN_DAY }, (_, i) => i)) {\n\t\t\t\tconst hour = parseInt(m.add(currentHour ? 1 : 0, 'hour').format('H'));\n\t\t\t\tconst label = {\n\t\t\t\t\tfrom: moment.utc().set({ hour }).tz(timezone).format('hA'),\n\t\t\t\t\tto: moment.utc().set({ hour }).endOf('hour').tz(timezone).format('hA'),\n\t\t\t\t};\n\t\t\t\tdata.dataLabels.push(`${label.from}-${label.to}`);\n\n\t\t\t\tconst date = {\n\t\t\t\t\tgte: m.toDate(),\n\t\t\t\t\tlte: moment(m).endOf('hour').toDate(),\n\t\t\t\t};\n\n\t\t\t\tdata.dataPoints.push(await this.chart.callAction(chartLabel, date, departmentId, extraQuery));\n\t\t\t}\n\t\t} else {\n\t\t\tfor await (const m of dayIterator(from, to)) {\n\t\t\t\tdata.dataLabels.push(m.format('M/D'));\n\n\t\t\t\tconst date = {\n\t\t\t\t\tgte: m.toDate(),\n\t\t\t\t\tlte: moment(m).endOf('day').toDate(),\n\t\t\t\t};\n\n\t\t\t\tdata.dataPoints.push(await this.chart.callAction(chartLabel, date, departmentId, extraQuery));\n\t\t\t}\n\t\t}\n\n\t\treturn data;\n\t}\n\n\tasync getAnalyticsOverviewData(options: AnalyticsOverviewDataOptions) {\n\t\tconst { departmentId, utcOffset = 0, language, daterange: { from: fDate, to: tDate } = {}, analyticsOptions: { name } = {} } = options;\n\t\tconst timezone = getTimezone({ utcOffset });\n\t\tconst from = moment\n\t\t\t.tz(fDate || '', 'YYYY-MM-DD', timezone)\n\t\t\t.startOf('day')\n\t\t\t.utc();\n\t\tconst to = moment\n\t\t\t.tz(tDate || '', 'YYYY-MM-DD', timezone)\n\t\t\t.endOf('day')\n\t\t\t.utc();\n\n\t\tif (!moment(from).isValid() || !moment(to).isValid()) {\n\t\t\tserviceLogger.error('OverviewData -> Invalid dates');\n\t\t\treturn;\n\t\t}\n\n\t\tif (!this.overview.isActionAllowed(name)) {\n\t\t\tserviceLogger.error(`OverviewData.${name} is not a valid action`);\n\t\t\treturn;\n\t\t}\n\n\t\tconst t = i18n.getFixedT(language);\n\n\t\tconst extraQuery = await callbacks.run('livechat.applyRoomRestrictions', {});\n\t\treturn this.overview.callAction(name, from, to, departmentId, timezone, t, extraQuery);\n\t}\n}\n"]},"targets":{"android":"125.0.0","chrome":"125.0.0","edge":"125.0.0","firefox":"115.0.0","ie":"10.0.0","ios":"17.4.0","opera":"110.0.0","opera_mobile":"80.0.0","safari":"17.4.0","samsung":"24.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor","root":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":false,"enforceStrictMode":false,"dynamicImport":true,"generateLetDeclarations":true,"topLevelAwait":true},"externalDependencies":[]},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"version":"7.17.2","helpers":true,"useESModules":false,"corejs":false},"externalDependencies":[]},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-async-generator-functions","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-class-properties","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true},"externalDependencies":[]},{"key":"transform-react-jsx","visitor":{"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXFragment":{"exit":[null]},"JSXElement":{"exit":[null]},"JSXAttribute":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false},"externalDependencies":[]},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-nullish-coalescing-operator","visitor":{"LogicalExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-optional-chaining","visitor":{"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-optional-catch-binding","visitor":{"CatchClause":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-class-properties","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-async-generator-functions","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-logical-assignment-operators","visitor":{"AssignmentExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]}],"presets":[],"generatorOpts":{"filename":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/server/services/omnichannel-analytics/service.ts","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"server/services/omnichannel-analytics/service.ts","inputSourceMap":{"version":3,"file":"server/services/omnichannel-analytics/service.ts","sourceRoot":"","sources":["server/services/omnichannel-analytics/service.ts"],"names":[],"mappings":"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","sourcesContent":["/* eslint-disable new-cap */\nimport { ServiceClassInternal } from '@rocket.chat/core-services';\nimport type {\n\tAgentOverviewDataOptions,\n\tAnalyticsOverviewDataOptions,\n\tChartDataOptions,\n\tIOmnichannelAnalyticsService,\n} from '@rocket.chat/core-services';\nimport { LivechatRooms } from '@rocket.chat/models';\nimport moment from 'moment-timezone';\n\nimport { AgentOverviewData } from './AgentData';\nimport { ChartData } from './ChartData';\nimport { OverviewData } from './OverviewData';\nimport { serviceLogger } from './logger';\nimport { dayIterator } from './utils';\nimport { getTimezone } from '../../../app/utils/server/lib/getTimezone';\nimport { callbacks } from '../../../lib/callbacks';\nimport { i18n } from '../../lib/i18n';\n\nconst HOURS_IN_DAY = 24;\n\n// TODO: move EE analytics to this service & remove callback usage\nexport class OmnichannelAnalyticsService extends ServiceClassInternal implements IOmnichannelAnalyticsService {\n\tprotected name = 'omnichannel-analytics';\n\n\treadonly overview: OverviewData;\n\n\treadonly chart: ChartData;\n\n\treadonly agentOverview: AgentOverviewData;\n\n\tconstructor() {\n\t\tsuper();\n\t\tthis.overview = new OverviewData(LivechatRooms);\n\t\tthis.chart = new ChartData(LivechatRooms);\n\t\tthis.agentOverview = new AgentOverviewData(LivechatRooms);\n\t}\n\n\tasync getAgentOverviewData(options: AgentOverviewDataOptions) {\n\t\tconst { departmentId, utcOffset, daterange: { from: fDate, to: tDate } = {}, chartOptions: { name } = {} } = options;\n\t\tconst timezone = getTimezone({ utcOffset });\n\t\tconst from = moment\n\t\t\t.tz(fDate || '', 'YYYY-MM-DD', timezone)\n\t\t\t.startOf('day')\n\t\t\t.utc();\n\t\tconst to = moment\n\t\t\t.tz(tDate || '', 'YYYY-MM-DD', timezone)\n\t\t\t.endOf('day')\n\t\t\t.utc();\n\n\t\tif (!moment(from).isValid() || !moment(to).isValid()) {\n\t\t\tserviceLogger.error('AgentOverview -> Invalid dates');\n\t\t\treturn;\n\t\t}\n\n\t\tif (!this.agentOverview.isActionAllowed(name)) {\n\t\t\tserviceLogger.error(`AgentOverview.${name} is not a valid action`);\n\t\t\treturn;\n\t\t}\n\n\t\tconst extraQuery = await callbacks.run('livechat.applyRoomRestrictions', {});\n\t\treturn this.agentOverview.callAction(name, from, to, departmentId, extraQuery);\n\t}\n\n\tasync getAnalyticsChartData(options: ChartDataOptions) {\n\t\tconst {\n\t\t\tutcOffset,\n\t\t\tdepartmentId,\n\t\t\tdaterange: { from: fDate, to: tDate } = {},\n\t\t\tchartOptions: { name: chartLabel },\n\t\t} = options;\n\n\t\t// Check if function exists, prevent server error in case property altered\n\t\tif (!this.chart.isActionAllowed(chartLabel)) {\n\t\t\tserviceLogger.error(`ChartData.${chartLabel} is not a valid action`);\n\t\t\treturn;\n\t\t}\n\n\t\tconst timezone = getTimezone({ utcOffset });\n\t\tconst from = moment\n\t\t\t.tz(fDate || '', 'YYYY-MM-DD', timezone)\n\t\t\t.startOf('day')\n\t\t\t.utc();\n\t\tconst to = moment\n\t\t\t.tz(tDate || '', 'YYYY-MM-DD', timezone)\n\t\t\t.endOf('day')\n\t\t\t.utc();\n\t\tconst isSameDay = from.diff(to, 'days') === 0;\n\n\t\tif (!moment(from).isValid() || !moment(to).isValid()) {\n\t\t\tserviceLogger.error('ChartData -> Invalid dates');\n\t\t\treturn;\n\t\t}\n\n\t\tconst data: {\n\t\t\tchartLabel: string;\n\t\t\tdataLabels: string[];\n\t\t\tdataPoints: number[];\n\t\t} = {\n\t\t\tchartLabel,\n\t\t\tdataLabels: [],\n\t\t\tdataPoints: [],\n\t\t};\n\n\t\tconst extraQuery = await callbacks.run('livechat.applyRoomRestrictions', {});\n\t\tif (isSameDay) {\n\t\t\t// data for single day\n\t\t\tconst m = moment(from);\n\t\t\tfor await (const currentHour of Array.from({ length: HOURS_IN_DAY }, (_, i) => i)) {\n\t\t\t\tconst hour = parseInt(m.add(currentHour ? 1 : 0, 'hour').format('H'));\n\t\t\t\tconst label = {\n\t\t\t\t\tfrom: moment.utc().set({ hour }).tz(timezone).format('hA'),\n\t\t\t\t\tto: moment.utc().set({ hour }).endOf('hour').tz(timezone).format('hA'),\n\t\t\t\t};\n\t\t\t\tdata.dataLabels.push(`${label.from}-${label.to}`);\n\n\t\t\t\tconst date = {\n\t\t\t\t\tgte: m.toDate(),\n\t\t\t\t\tlte: moment(m).endOf('hour').toDate(),\n\t\t\t\t};\n\n\t\t\t\tdata.dataPoints.push(await this.chart.callAction(chartLabel, date, departmentId, extraQuery));\n\t\t\t}\n\t\t} else {\n\t\t\tfor await (const m of dayIterator(from, to)) {\n\t\t\t\tdata.dataLabels.push(m.format('M/D'));\n\n\t\t\t\tconst date = {\n\t\t\t\t\tgte: m.toDate(),\n\t\t\t\t\tlte: moment(m).endOf('day').toDate(),\n\t\t\t\t};\n\n\t\t\t\tdata.dataPoints.push(await this.chart.callAction(chartLabel, date, departmentId, extraQuery));\n\t\t\t}\n\t\t}\n\n\t\treturn data;\n\t}\n\n\tasync getAnalyticsOverviewData(options: AnalyticsOverviewDataOptions) {\n\t\tconst { departmentId, utcOffset = 0, language, daterange: { from: fDate, to: tDate } = {}, analyticsOptions: { name } = {} } = options;\n\t\tconst timezone = getTimezone({ utcOffset });\n\t\tconst from = moment\n\t\t\t.tz(fDate || '', 'YYYY-MM-DD', timezone)\n\t\t\t.startOf('day')\n\t\t\t.utc();\n\t\tconst to = moment\n\t\t\t.tz(tDate || '', 'YYYY-MM-DD', timezone)\n\t\t\t.endOf('day')\n\t\t\t.utc();\n\n\t\tif (!moment(from).isValid() || !moment(to).isValid()) {\n\t\t\tserviceLogger.error('OverviewData -> Invalid dates');\n\t\t\treturn;\n\t\t}\n\n\t\tif (!this.overview.isActionAllowed(name)) {\n\t\t\tserviceLogger.error(`OverviewData.${name} is not a valid action`);\n\t\t\treturn;\n\t\t}\n\n\t\tconst t = i18n.getFixedT(language);\n\n\t\tconst extraQuery = await callbacks.run('livechat.applyRoomRestrictions', {});\n\t\treturn this.overview.callAction(name, from, to, departmentId, timezone, t, extraQuery);\n\t}\n}\n"]}}},"code":"!module.wrapAsync(async function (module, __reifyWaitForDeps__, __reify_async_result__) {\n  \"use strict\";\n  try {\n    let _asyncIterator;\n    module.link(\"@babel/runtime/helpers/asyncIterator\", {\n      default(v) {\n        _asyncIterator = v;\n      }\n    }, 0);\n    module.export({\n      OmnichannelAnalyticsService: () => OmnichannelAnalyticsService\n    });\n    let ServiceClassInternal;\n    module.link(\"@rocket.chat/core-services\", {\n      ServiceClassInternal(v) {\n        ServiceClassInternal = v;\n      }\n    }, 0);\n    let LivechatRooms;\n    module.link(\"@rocket.chat/models\", {\n      LivechatRooms(v) {\n        LivechatRooms = v;\n      }\n    }, 1);\n    let moment;\n    module.link(\"moment-timezone\", {\n      default(v) {\n        moment = v;\n      }\n    }, 2);\n    let AgentOverviewData;\n    module.link(\"./AgentData\", {\n      AgentOverviewData(v) {\n        AgentOverviewData = v;\n      }\n    }, 3);\n    let ChartData;\n    module.link(\"./ChartData\", {\n      ChartData(v) {\n        ChartData = v;\n      }\n    }, 4);\n    let OverviewData;\n    module.link(\"./OverviewData\", {\n      OverviewData(v) {\n        OverviewData = v;\n      }\n    }, 5);\n    let serviceLogger;\n    module.link(\"./logger\", {\n      serviceLogger(v) {\n        serviceLogger = v;\n      }\n    }, 6);\n    let dayIterator;\n    module.link(\"./utils\", {\n      dayIterator(v) {\n        dayIterator = v;\n      }\n    }, 7);\n    let getTimezone;\n    module.link(\"../../../app/utils/server/lib/getTimezone\", {\n      getTimezone(v) {\n        getTimezone = v;\n      }\n    }, 8);\n    let callbacks;\n    module.link(\"../../../lib/callbacks\", {\n      callbacks(v) {\n        callbacks = v;\n      }\n    }, 9);\n    let i18n;\n    module.link(\"../../lib/i18n\", {\n      i18n(v) {\n        i18n = v;\n      }\n    }, 10);\n    if (__reifyWaitForDeps__()) (await __reifyWaitForDeps__())();\n    const HOURS_IN_DAY = 24;\n    // TODO: move EE analytics to this service & remove callback usage\n    class OmnichannelAnalyticsService extends ServiceClassInternal {\n      constructor() {\n        super();\n        this.name = 'omnichannel-analytics';\n        this.overview = void 0;\n        this.chart = void 0;\n        this.agentOverview = void 0;\n        this.overview = new OverviewData(LivechatRooms);\n        this.chart = new ChartData(LivechatRooms);\n        this.agentOverview = new AgentOverviewData(LivechatRooms);\n      }\n      async getAgentOverviewData(options) {\n        const {\n          departmentId,\n          utcOffset,\n          daterange: {\n            from: fDate,\n            to: tDate\n          } = {},\n          chartOptions: {\n            name\n          } = {}\n        } = options;\n        const timezone = getTimezone({\n          utcOffset\n        });\n        const from = moment.tz(fDate || '', 'YYYY-MM-DD', timezone).startOf('day').utc();\n        const to = moment.tz(tDate || '', 'YYYY-MM-DD', timezone).endOf('day').utc();\n        if (!moment(from).isValid() || !moment(to).isValid()) {\n          serviceLogger.error('AgentOverview -> Invalid dates');\n          return;\n        }\n        if (!this.agentOverview.isActionAllowed(name)) {\n          serviceLogger.error(\"AgentOverview.\".concat(name, \" is not a valid action\"));\n          return;\n        }\n        const extraQuery = await callbacks.run('livechat.applyRoomRestrictions', {});\n        return this.agentOverview.callAction(name, from, to, departmentId, extraQuery);\n      }\n      async getAnalyticsChartData(options) {\n        const {\n          utcOffset,\n          departmentId,\n          daterange: {\n            from: fDate,\n            to: tDate\n          } = {},\n          chartOptions: {\n            name: chartLabel\n          }\n        } = options;\n        // Check if function exists, prevent server error in case property altered\n        if (!this.chart.isActionAllowed(chartLabel)) {\n          serviceLogger.error(\"ChartData.\".concat(chartLabel, \" is not a valid action\"));\n          return;\n        }\n        const timezone = getTimezone({\n          utcOffset\n        });\n        const from = moment.tz(fDate || '', 'YYYY-MM-DD', timezone).startOf('day').utc();\n        const to = moment.tz(tDate || '', 'YYYY-MM-DD', timezone).endOf('day').utc();\n        const isSameDay = from.diff(to, 'days') === 0;\n        if (!moment(from).isValid() || !moment(to).isValid()) {\n          serviceLogger.error('ChartData -> Invalid dates');\n          return;\n        }\n        const data = {\n          chartLabel,\n          dataLabels: [],\n          dataPoints: []\n        };\n        const extraQuery = await callbacks.run('livechat.applyRoomRestrictions', {});\n        if (isSameDay) {\n          // data for single day\n          const m = moment(from);\n          var _iteratorAbruptCompletion = false;\n          var _didIteratorError = false;\n          var _iteratorError;\n          try {\n            for (var _iterator = _asyncIterator(Array.from({\n                length: HOURS_IN_DAY\n              }, (_, i) => i)), _step; _iteratorAbruptCompletion = !(_step = await _iterator.next()).done; _iteratorAbruptCompletion = false) {\n              const currentHour = _step.value;\n              {\n                const hour = parseInt(m.add(currentHour ? 1 : 0, 'hour').format('H'));\n                const label = {\n                  from: moment.utc().set({\n                    hour\n                  }).tz(timezone).format('hA'),\n                  to: moment.utc().set({\n                    hour\n                  }).endOf('hour').tz(timezone).format('hA')\n                };\n                data.dataLabels.push(\"\".concat(label.from, \"-\").concat(label.to));\n                const date = {\n                  gte: m.toDate(),\n                  lte: moment(m).endOf('hour').toDate()\n                };\n                data.dataPoints.push(await this.chart.callAction(chartLabel, date, departmentId, extraQuery));\n              }\n            }\n          } catch (err) {\n            _didIteratorError = true;\n            _iteratorError = err;\n          } finally {\n            try {\n              if (_iteratorAbruptCompletion && _iterator.return != null) {\n                await _iterator.return();\n              }\n            } finally {\n              if (_didIteratorError) {\n                throw _iteratorError;\n              }\n            }\n          }\n        } else {\n          var _iteratorAbruptCompletion2 = false;\n          var _didIteratorError2 = false;\n          var _iteratorError2;\n          try {\n            for (var _iterator2 = _asyncIterator(dayIterator(from, to)), _step2; _iteratorAbruptCompletion2 = !(_step2 = await _iterator2.next()).done; _iteratorAbruptCompletion2 = false) {\n              const m = _step2.value;\n              {\n                data.dataLabels.push(m.format('M/D'));\n                const date = {\n                  gte: m.toDate(),\n                  lte: moment(m).endOf('day').toDate()\n                };\n                data.dataPoints.push(await this.chart.callAction(chartLabel, date, departmentId, extraQuery));\n              }\n            }\n          } catch (err) {\n            _didIteratorError2 = true;\n            _iteratorError2 = err;\n          } finally {\n            try {\n              if (_iteratorAbruptCompletion2 && _iterator2.return != null) {\n                await _iterator2.return();\n              }\n            } finally {\n              if (_didIteratorError2) {\n                throw _iteratorError2;\n              }\n            }\n          }\n        }\n        return data;\n      }\n      async getAnalyticsOverviewData(options) {\n        const {\n          departmentId,\n          utcOffset = 0,\n          language,\n          daterange: {\n            from: fDate,\n            to: tDate\n          } = {},\n          analyticsOptions: {\n            name\n          } = {}\n        } = options;\n        const timezone = getTimezone({\n          utcOffset\n        });\n        const from = moment.tz(fDate || '', 'YYYY-MM-DD', timezone).startOf('day').utc();\n        const to = moment.tz(tDate || '', 'YYYY-MM-DD', timezone).endOf('day').utc();\n        if (!moment(from).isValid() || !moment(to).isValid()) {\n          serviceLogger.error('OverviewData -> Invalid dates');\n          return;\n        }\n        if (!this.overview.isActionAllowed(name)) {\n          serviceLogger.error(\"OverviewData.\".concat(name, \" is not a valid action\"));\n          return;\n        }\n        const t = i18n.getFixedT(language);\n        const extraQuery = await callbacks.run('livechat.applyRoomRestrictions', {});\n        return this.overview.callAction(name, from, to, departmentId, timezone, t, extraQuery);\n      }\n    }\n    __reify_async_result__();\n  } catch (_reifyError) {\n    return __reify_async_result__(_reifyError);\n  }\n  __reify_async_result__()\n}, {\n  self: this,\n  async: false\n});","map":{"version":3,"names":["_asyncIterator","module","link","default","v","export","OmnichannelAnalyticsService","ServiceClassInternal","LivechatRooms","moment","AgentOverviewData","ChartData","OverviewData","serviceLogger","dayIterator","getTimezone","callbacks","i18n","__reifyWaitForDeps__","HOURS_IN_DAY","constructor","name","overview","chart","agentOverview","getAgentOverviewData","options","departmentId","utcOffset","daterange","from","fDate","to","tDate","chartOptions","timezone","tz","startOf","utc","endOf","isValid","error","isActionAllowed","concat","extraQuery","run","callAction","getAnalyticsChartData","chartLabel","isSameDay","diff","data","dataLabels","dataPoints","m","_iteratorAbruptCompletion","_didIteratorError","_iteratorError","_iterator","Array","length","_","i","_step","next","done","currentHour","value","hour","parseInt","add","format","label","set","push","date","gte","toDate","lte","err","return","_iteratorAbruptCompletion2","_didIteratorError2","_iteratorError2","_iterator2","_step2","getAnalyticsOverviewData","language","analyticsOptions","t","getFixedT","__reify_async_result__","_reifyError","self","async"],"sources":["server/services/omnichannel-analytics/service.ts"],"sourcesContent":["/* eslint-disable new-cap */\nimport { ServiceClassInternal } from '@rocket.chat/core-services';\nimport type {\n\tAgentOverviewDataOptions,\n\tAnalyticsOverviewDataOptions,\n\tChartDataOptions,\n\tIOmnichannelAnalyticsService,\n} from '@rocket.chat/core-services';\nimport { LivechatRooms } from '@rocket.chat/models';\nimport moment from 'moment-timezone';\n\nimport { AgentOverviewData } from './AgentData';\nimport { ChartData } from './ChartData';\nimport { OverviewData } from './OverviewData';\nimport { serviceLogger } from './logger';\nimport { dayIterator } from './utils';\nimport { getTimezone } from '../../../app/utils/server/lib/getTimezone';\nimport { callbacks } from '../../../lib/callbacks';\nimport { i18n } from '../../lib/i18n';\n\nconst HOURS_IN_DAY = 24;\n\n// TODO: move EE analytics to this service & remove callback usage\nexport class OmnichannelAnalyticsService extends ServiceClassInternal implements IOmnichannelAnalyticsService {\n\tprotected name = 'omnichannel-analytics';\n\n\treadonly overview: OverviewData;\n\n\treadonly chart: ChartData;\n\n\treadonly agentOverview: AgentOverviewData;\n\n\tconstructor() {\n\t\tsuper();\n\t\tthis.overview = new OverviewData(LivechatRooms);\n\t\tthis.chart = new ChartData(LivechatRooms);\n\t\tthis.agentOverview = new AgentOverviewData(LivechatRooms);\n\t}\n\n\tasync getAgentOverviewData(options: AgentOverviewDataOptions) {\n\t\tconst { departmentId, utcOffset, daterange: { from: fDate, to: tDate } = {}, chartOptions: { name } = {} } = options;\n\t\tconst timezone = getTimezone({ utcOffset });\n\t\tconst from = moment\n\t\t\t.tz(fDate || '', 'YYYY-MM-DD', timezone)\n\t\t\t.startOf('day')\n\t\t\t.utc();\n\t\tconst to = moment\n\t\t\t.tz(tDate || '', 'YYYY-MM-DD', timezone)\n\t\t\t.endOf('day')\n\t\t\t.utc();\n\n\t\tif (!moment(from).isValid() || !moment(to).isValid()) {\n\t\t\tserviceLogger.error('AgentOverview -> Invalid dates');\n\t\t\treturn;\n\t\t}\n\n\t\tif (!this.agentOverview.isActionAllowed(name)) {\n\t\t\tserviceLogger.error(`AgentOverview.${name} is not a valid action`);\n\t\t\treturn;\n\t\t}\n\n\t\tconst extraQuery = await callbacks.run('livechat.applyRoomRestrictions', {});\n\t\treturn this.agentOverview.callAction(name, from, to, departmentId, extraQuery);\n\t}\n\n\tasync getAnalyticsChartData(options: ChartDataOptions) {\n\t\tconst {\n\t\t\tutcOffset,\n\t\t\tdepartmentId,\n\t\t\tdaterange: { from: fDate, to: tDate } = {},\n\t\t\tchartOptions: { name: chartLabel },\n\t\t} = options;\n\n\t\t// Check if function exists, prevent server error in case property altered\n\t\tif (!this.chart.isActionAllowed(chartLabel)) {\n\t\t\tserviceLogger.error(`ChartData.${chartLabel} is not a valid action`);\n\t\t\treturn;\n\t\t}\n\n\t\tconst timezone = getTimezone({ utcOffset });\n\t\tconst from = moment\n\t\t\t.tz(fDate || '', 'YYYY-MM-DD', timezone)\n\t\t\t.startOf('day')\n\t\t\t.utc();\n\t\tconst to = moment\n\t\t\t.tz(tDate || '', 'YYYY-MM-DD', timezone)\n\t\t\t.endOf('day')\n\t\t\t.utc();\n\t\tconst isSameDay = from.diff(to, 'days') === 0;\n\n\t\tif (!moment(from).isValid() || !moment(to).isValid()) {\n\t\t\tserviceLogger.error('ChartData -> Invalid dates');\n\t\t\treturn;\n\t\t}\n\n\t\tconst data: {\n\t\t\tchartLabel: string;\n\t\t\tdataLabels: string[];\n\t\t\tdataPoints: number[];\n\t\t} = {\n\t\t\tchartLabel,\n\t\t\tdataLabels: [],\n\t\t\tdataPoints: [],\n\t\t};\n\n\t\tconst extraQuery = await callbacks.run('livechat.applyRoomRestrictions', {});\n\t\tif (isSameDay) {\n\t\t\t// data for single day\n\t\t\tconst m = moment(from);\n\t\t\tfor await (const currentHour of Array.from({ length: HOURS_IN_DAY }, (_, i) => i)) {\n\t\t\t\tconst hour = parseInt(m.add(currentHour ? 1 : 0, 'hour').format('H'));\n\t\t\t\tconst label = {\n\t\t\t\t\tfrom: moment.utc().set({ hour }).tz(timezone).format('hA'),\n\t\t\t\t\tto: moment.utc().set({ hour }).endOf('hour').tz(timezone).format('hA'),\n\t\t\t\t};\n\t\t\t\tdata.dataLabels.push(`${label.from}-${label.to}`);\n\n\t\t\t\tconst date = {\n\t\t\t\t\tgte: m.toDate(),\n\t\t\t\t\tlte: moment(m).endOf('hour').toDate(),\n\t\t\t\t};\n\n\t\t\t\tdata.dataPoints.push(await this.chart.callAction(chartLabel, date, departmentId, extraQuery));\n\t\t\t}\n\t\t} else {\n\t\t\tfor await (const m of dayIterator(from, to)) {\n\t\t\t\tdata.dataLabels.push(m.format('M/D'));\n\n\t\t\t\tconst date = {\n\t\t\t\t\tgte: m.toDate(),\n\t\t\t\t\tlte: moment(m).endOf('day').toDate(),\n\t\t\t\t};\n\n\t\t\t\tdata.dataPoints.push(await this.chart.callAction(chartLabel, date, departmentId, extraQuery));\n\t\t\t}\n\t\t}\n\n\t\treturn data;\n\t}\n\n\tasync getAnalyticsOverviewData(options: AnalyticsOverviewDataOptions) {\n\t\tconst { departmentId, utcOffset = 0, language, daterange: { from: fDate, to: tDate } = {}, analyticsOptions: { name } = {} } = options;\n\t\tconst timezone = getTimezone({ utcOffset });\n\t\tconst from = moment\n\t\t\t.tz(fDate || '', 'YYYY-MM-DD', timezone)\n\t\t\t.startOf('day')\n\t\t\t.utc();\n\t\tconst to = moment\n\t\t\t.tz(tDate || '', 'YYYY-MM-DD', timezone)\n\t\t\t.endOf('day')\n\t\t\t.utc();\n\n\t\tif (!moment(from).isValid() || !moment(to).isValid()) {\n\t\t\tserviceLogger.error('OverviewData -> Invalid dates');\n\t\t\treturn;\n\t\t}\n\n\t\tif (!this.overview.isActionAllowed(name)) {\n\t\t\tserviceLogger.error(`OverviewData.${name} is not a valid action`);\n\t\t\treturn;\n\t\t}\n\n\t\tconst t = i18n.getFixedT(language);\n\n\t\tconst extraQuery = await callbacks.run('livechat.applyRoomRestrictions', {});\n\t\treturn this.overview.callAction(name, from, to, departmentId, timezone, t, extraQuery);\n\t}\n}\n"],"mappings":"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","ignoreList":[]},"sourceType":"module","externalDependencies":{},"hash":"ad66cb48ddea9c73981bdd22857d594f9ce8734a"}
