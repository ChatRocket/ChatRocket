{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/server/services/federation/infrastructure/rocket-chat/hooks/index.ts","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","topLevelAwait","objectRestSpread","objectRestSpread","asyncGenerators","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"os.osx.arm64"},"sourceFileName":"server/services/federation/infrastructure/rocket-chat/hooks/index.ts","filename":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/server/services/federation/infrastructure/rocket-chat/hooks/index.ts","inputSourceMap":{"version":3,"file":"server/services/federation/infrastructure/rocket-chat/hooks/index.ts","sourceRoot":"","sources":["server/services/federation/infrastructure/rocket-chat/hooks/index.ts"],"names":[],"mappings":"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","sourcesContent":["import type { IMessage, IRoom, IUser } from '@rocket.chat/core-typings';\nimport { isMessageFromMatrixFederation, isRoomFederated, isEditedMessage } from '@rocket.chat/core-typings';\n\nimport { callbacks } from '../../../../../../lib/callbacks';\nimport { afterLeaveRoomCallback } from '../../../../../../lib/callbacks/afterLeaveRoomCallback';\nimport { afterRemoveFromRoomCallback } from '../../../../../../lib/callbacks/afterRemoveFromRoomCallback';\nimport type { FederationRoomServiceSender } from '../../../application/room/sender/RoomServiceSender';\nimport { isFederationEnabled, throwIfFederationNotEnabledOrNotReady, throwIfFederationNotReady } from '../../../utils';\n\nexport class FederationHooks {\n\tpublic static afterUserLeaveRoom(callback: (user: IUser, room: IRoom) => Promise<void>): void {\n\t\tafterLeaveRoomCallback.add(\n\t\t\tasync (user: IUser, room?: IRoom): Promise<void> => {\n\t\t\t\tif (!room || !isRoomFederated(room) || !user) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tthrowIfFederationNotEnabledOrNotReady();\n\n\t\t\t\tawait callback(user, room);\n\t\t\t},\n\t\t\tcallbacks.priority.HIGH,\n\t\t\t'federation-v2-after-leave-room',\n\t\t);\n\t}\n\n\tpublic static onUserRemovedFromRoom(callback: (removedUser: IUser, room: IRoom, userWhoRemoved: IUser) => Promise<void>): void {\n\t\tafterRemoveFromRoomCallback.add(\n\t\t\tasync (params, room): Promise<void> => {\n\t\t\t\tif (!room || !isRoomFederated(room) || !params || !params.removedUser || !params.userWhoRemoved) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tthrowIfFederationNotEnabledOrNotReady();\n\n\t\t\t\tawait callback(params.removedUser, room, params.userWhoRemoved);\n\t\t\t},\n\t\t\tcallbacks.priority.HIGH,\n\t\t\t'federation-v2-after-remove-from-room',\n\t\t);\n\t}\n\n\tpublic static canAddFederatedUserToNonFederatedRoom(callback: (user: IUser | string, room: IRoom) => Promise<void>): void {\n\t\tcallbacks.add(\n\t\t\t'federation.beforeAddUserToARoom',\n\t\t\tasync (params: { user: IUser | string; inviter?: IUser }, room: IRoom): Promise<void> => {\n\t\t\t\tif (!params?.user || !room || !isFederationEnabled()) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tawait callback(params.user, room);\n\t\t\t},\n\t\t\tcallbacks.priority.HIGH,\n\t\t\t'federation-v2-can-add-federated-user-to-non-federated-room',\n\t\t);\n\t}\n\n\tpublic static canAddFederatedUserToFederatedRoom(callback: (user: IUser | string, inviter: IUser, room: IRoom) => Promise<void>): void {\n\t\tcallbacks.add(\n\t\t\t'federation.beforeAddUserToARoom',\n\t\t\tasync (params: { user: IUser | string; inviter: IUser }, room: IRoom): Promise<void> => {\n\t\t\t\tif (!params?.user || !params.inviter || !room || !isFederationEnabled()) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tawait callback(params.user, params.inviter, room);\n\t\t\t},\n\t\t\tcallbacks.priority.HIGH,\n\t\t\t'federation-v2-can-add-federated-user-to-federated-room',\n\t\t);\n\t}\n\n\tpublic static canCreateDirectMessageFromUI(callback: (members: IUser[]) => Promise<void>): void {\n\t\tcallbacks.add(\n\t\t\t'federation.beforeCreateDirectMessage',\n\t\t\tasync (members: IUser[]): Promise<void> => {\n\t\t\t\tif (!members) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tthrowIfFederationNotEnabledOrNotReady();\n\n\t\t\t\tawait callback(members);\n\t\t\t},\n\t\t\tcallbacks.priority.HIGH,\n\t\t\t'federation-v2-can-create-direct-message-from-ui-ce',\n\t\t);\n\t}\n\n\tpublic static afterMessageReacted(callback: (message: IMessage, user: IUser, reaction: string) => Promise<void>): void {\n\t\tcallbacks.add(\n\t\t\t'afterSetReaction',\n\t\t\tasync (message: IMessage, params: { user: IUser; reaction: string }): Promise<void> => {\n\t\t\t\tif (!message || !isMessageFromMatrixFederation(message) || !params || !params.user || !params.reaction) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tthrowIfFederationNotEnabledOrNotReady();\n\n\t\t\t\tawait callback(message, params.user, params.reaction);\n\t\t\t},\n\t\t\tcallbacks.priority.HIGH,\n\t\t\t'federation-v2-after-message-reacted',\n\t\t);\n\t}\n\n\tpublic static afterMessageunReacted(callback: (message: IMessage, user: IUser, reaction: string) => Promise<void>): void {\n\t\tcallbacks.add(\n\t\t\t'afterUnsetReaction',\n\t\t\tasync (message: IMessage, params: { user: IUser; reaction: string; oldMessage: IMessage }): Promise<void> => {\n\t\t\t\tif (!message || !isMessageFromMatrixFederation(message) || !params || !params.user || !params.reaction || !params.oldMessage) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tthrowIfFederationNotEnabledOrNotReady();\n\n\t\t\t\tawait callback(params.oldMessage, params.user, params.reaction);\n\t\t\t},\n\t\t\tcallbacks.priority.HIGH,\n\t\t\t'federation-v2-after-message-unreacted',\n\t\t);\n\t}\n\n\tpublic static afterMessageDeleted(callback: (message: IMessage, roomId: IRoom['_id']) => Promise<void>): void {\n\t\tcallbacks.add(\n\t\t\t'afterDeleteMessage',\n\t\t\tasync (message: IMessage, room: IRoom): Promise<void> => {\n\t\t\t\tif (!room || !message || !isRoomFederated(room) || !isMessageFromMatrixFederation(message)) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tthrowIfFederationNotEnabledOrNotReady();\n\n\t\t\t\tawait callback(message, room._id);\n\t\t\t},\n\t\t\tcallbacks.priority.HIGH,\n\t\t\t'federation-v2-after-room-message-deleted',\n\t\t);\n\t}\n\n\tpublic static afterMessageUpdated(callback: (message: IMessage, roomId: IRoom['_id'], userId: string) => Promise<void>): void {\n\t\tcallbacks.add(\n\t\t\t'afterSaveMessage',\n\t\t\tasync (message: IMessage, { room }): Promise<IMessage> => {\n\t\t\t\tif (!room || !isRoomFederated(room) || !message || !isMessageFromMatrixFederation(message)) {\n\t\t\t\t\treturn message;\n\t\t\t\t}\n\n\t\t\t\tthrowIfFederationNotEnabledOrNotReady();\n\n\t\t\t\tif (!isEditedMessage(message)) {\n\t\t\t\t\treturn message;\n\t\t\t\t}\n\t\t\t\tawait callback(message, room._id, message.editedBy._id);\n\t\t\t\treturn message;\n\t\t\t},\n\t\t\tcallbacks.priority.HIGH,\n\t\t\t'federation-v2-after-room-message-updated',\n\t\t);\n\t}\n\n\tpublic static afterMessageSent(callback: (message: IMessage, roomId: IRoom['_id'], userId: string) => Promise<void>): void {\n\t\tcallbacks.add(\n\t\t\t'afterSaveMessage',\n\t\t\tasync (message: IMessage, { room }): Promise<IMessage> => {\n\t\t\t\tif (!room || !isRoomFederated(room) || !message) {\n\t\t\t\t\treturn message;\n\t\t\t\t}\n\n\t\t\t\tthrowIfFederationNotEnabledOrNotReady();\n\n\t\t\t\tif (isEditedMessage(message)) {\n\t\t\t\t\treturn message;\n\t\t\t\t}\n\t\t\t\tawait callback(message, room._id, message.u?._id);\n\t\t\t\treturn message;\n\t\t\t},\n\t\t\tcallbacks.priority.HIGH,\n\t\t\t'federation-v2-after-room-message-sent',\n\t\t);\n\t}\n\n\tpublic static async afterRoomRoleChanged(federationRoomService: FederationRoomServiceSender, data?: Record<string, any>) {\n\t\tif (!data) {\n\t\t\treturn;\n\t\t}\n\n\t\tif (!isFederationEnabled()) {\n\t\t\treturn;\n\t\t}\n\n\t\tthrowIfFederationNotReady();\n\n\t\tconst {\n\t\t\t_id: role,\n\t\t\ttype: action,\n\t\t\tscope: internalRoomId,\n\t\t\tu: { _id: internalTargetUserId = undefined } = {},\n\t\t\tgivenByUserId: internalUserId,\n\t\t} = data;\n\t\tconst roleEventsInterestedIn = ['moderator', 'owner'];\n\t\tif (!roleEventsInterestedIn.includes(role)) {\n\t\t\treturn;\n\t\t}\n\t\tconst handlers: Record<string, (internalUserId: string, internalTargetUserId: string, internalRoomId: string) => Promise<void>> = {\n\t\t\t'owner-added': (internalUserId: string, internalTargetUserId: string, internalRoomId: string): Promise<void> =>\n\t\t\t\tfederationRoomService.onRoomOwnerAdded(internalUserId, internalTargetUserId, internalRoomId),\n\t\t\t'owner-removed': (internalUserId: string, internalTargetUserId: string, internalRoomId: string): Promise<void> =>\n\t\t\t\tfederationRoomService.onRoomOwnerRemoved(internalUserId, internalTargetUserId, internalRoomId),\n\t\t\t'moderator-added': (internalUserId: string, internalTargetUserId: string, internalRoomId: string): Promise<void> =>\n\t\t\t\tfederationRoomService.onRoomModeratorAdded(internalUserId, internalTargetUserId, internalRoomId),\n\t\t\t'moderator-removed': (internalUserId: string, internalTargetUserId: string, internalRoomId: string): Promise<void> =>\n\t\t\t\tfederationRoomService.onRoomModeratorRemoved(internalUserId, internalTargetUserId, internalRoomId),\n\t\t};\n\n\t\tif (!handlers[`${role}-${action}`]) {\n\t\t\treturn;\n\t\t}\n\t\tawait handlers[`${role}-${action}`](internalUserId, internalTargetUserId, internalRoomId);\n\t}\n\n\tpublic static afterRoomNameChanged(callback: (roomId: string, changedRoomName: string) => Promise<void>): void {\n\t\tcallbacks.add(\n\t\t\t'afterRoomNameChange',\n\t\t\tasync (params: Record<string, any>): Promise<void> => {\n\t\t\t\tif (!params?.rid || !params.name) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tthrowIfFederationNotEnabledOrNotReady();\n\n\t\t\t\tawait callback(params.rid, params.name);\n\t\t\t},\n\t\t\tcallbacks.priority.HIGH,\n\t\t\t'federation-v2-after-room-name-changed',\n\t\t);\n\t}\n\n\tpublic static afterRoomTopicChanged(callback: (roomId: string, changedRoomTopic: string) => Promise<void>): void {\n\t\tcallbacks.add(\n\t\t\t'afterRoomTopicChange',\n\t\t\tasync (params: Record<string, any>): Promise<void> => {\n\t\t\t\tif (!params?.rid || !params.topic) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tthrowIfFederationNotEnabledOrNotReady();\n\n\t\t\t\tawait callback(params.rid, params.topic);\n\t\t\t},\n\t\t\tcallbacks.priority.HIGH,\n\t\t\t'federation-v2-after-room-topic-changed',\n\t\t);\n\t}\n\n\tpublic static removeCEValidation(): void {\n\t\tcallbacks.remove('federation.beforeAddUserToARoom', 'federation-v2-can-add-federated-user-to-federated-room');\n\t\tcallbacks.remove('federation.beforeCreateDirectMessage', 'federation-v2-can-create-direct-message-from-ui-ce');\n\t}\n\n\tpublic static removeAllListeners(): void {\n\t\tafterLeaveRoomCallback.remove('federation-v2-after-leave-room');\n\t\tafterRemoveFromRoomCallback.remove('federation-v2-after-remove-from-room');\n\t\tcallbacks.remove('federation.beforeAddUserToARoom', 'federation-v2-can-add-federated-user-to-non-federated-room');\n\t\tcallbacks.remove('federation.beforeAddUserToARoom', 'federation-v2-can-add-federated-user-to-federated-room');\n\t\tcallbacks.remove('federation.beforeCreateDirectMessage', 'federation-v2-can-create-direct-message-from-ui-ce');\n\t\tcallbacks.remove('afterSetReaction', 'federation-v2-after-message-reacted');\n\t\tcallbacks.remove('afterUnsetReaction', 'federation-v2-after-message-unreacted');\n\t\tcallbacks.remove('afterDeleteMessage', 'federation-v2-after-room-message-deleted');\n\t\tcallbacks.remove('afterSaveMessage', 'federation-v2-after-room-message-updated');\n\t\tcallbacks.remove('afterSaveMessage', 'federation-v2-after-room-message-sent');\n\t\tcallbacks.remove('afterSaveMessage', 'federation-v2-after-room-message-sent');\n\t\tcallbacks.remove('afterRoomNameChange', 'federation-v2-after-room-name-changed');\n\t\tcallbacks.remove('afterRoomTopicChange', 'federation-v2-after-room-topic-changed');\n\t}\n}\n"]},"targets":{"android":"125.0.0","chrome":"125.0.0","edge":"125.0.0","firefox":"115.0.0","ie":"10.0.0","ios":"17.4.0","opera":"110.0.0","opera_mobile":"80.0.0","safari":"17.4.0","samsung":"24.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor","root":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":false,"enforceStrictMode":false,"dynamicImport":true,"generateLetDeclarations":true,"topLevelAwait":true},"externalDependencies":[]},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"version":"7.17.2","helpers":true,"useESModules":false,"corejs":false},"externalDependencies":[]},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-async-generator-functions","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-class-properties","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true},"externalDependencies":[]},{"key":"transform-react-jsx","visitor":{"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXFragment":{"exit":[null]},"JSXElement":{"exit":[null]},"JSXAttribute":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false},"externalDependencies":[]},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-nullish-coalescing-operator","visitor":{"LogicalExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-optional-chaining","visitor":{"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-optional-catch-binding","visitor":{"CatchClause":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-class-properties","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-async-generator-functions","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-logical-assignment-operators","visitor":{"AssignmentExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]}],"presets":[],"generatorOpts":{"filename":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/server/services/federation/infrastructure/rocket-chat/hooks/index.ts","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"server/services/federation/infrastructure/rocket-chat/hooks/index.ts","inputSourceMap":{"version":3,"file":"server/services/federation/infrastructure/rocket-chat/hooks/index.ts","sourceRoot":"","sources":["server/services/federation/infrastructure/rocket-chat/hooks/index.ts"],"names":[],"mappings":"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","sourcesContent":["import type { IMessage, IRoom, IUser } from '@rocket.chat/core-typings';\nimport { isMessageFromMatrixFederation, isRoomFederated, isEditedMessage } from '@rocket.chat/core-typings';\n\nimport { callbacks } from '../../../../../../lib/callbacks';\nimport { afterLeaveRoomCallback } from '../../../../../../lib/callbacks/afterLeaveRoomCallback';\nimport { afterRemoveFromRoomCallback } from '../../../../../../lib/callbacks/afterRemoveFromRoomCallback';\nimport type { FederationRoomServiceSender } from '../../../application/room/sender/RoomServiceSender';\nimport { isFederationEnabled, throwIfFederationNotEnabledOrNotReady, throwIfFederationNotReady } from '../../../utils';\n\nexport class FederationHooks {\n\tpublic static afterUserLeaveRoom(callback: (user: IUser, room: IRoom) => Promise<void>): void {\n\t\tafterLeaveRoomCallback.add(\n\t\t\tasync (user: IUser, room?: IRoom): Promise<void> => {\n\t\t\t\tif (!room || !isRoomFederated(room) || !user) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tthrowIfFederationNotEnabledOrNotReady();\n\n\t\t\t\tawait callback(user, room);\n\t\t\t},\n\t\t\tcallbacks.priority.HIGH,\n\t\t\t'federation-v2-after-leave-room',\n\t\t);\n\t}\n\n\tpublic static onUserRemovedFromRoom(callback: (removedUser: IUser, room: IRoom, userWhoRemoved: IUser) => Promise<void>): void {\n\t\tafterRemoveFromRoomCallback.add(\n\t\t\tasync (params, room): Promise<void> => {\n\t\t\t\tif (!room || !isRoomFederated(room) || !params || !params.removedUser || !params.userWhoRemoved) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tthrowIfFederationNotEnabledOrNotReady();\n\n\t\t\t\tawait callback(params.removedUser, room, params.userWhoRemoved);\n\t\t\t},\n\t\t\tcallbacks.priority.HIGH,\n\t\t\t'federation-v2-after-remove-from-room',\n\t\t);\n\t}\n\n\tpublic static canAddFederatedUserToNonFederatedRoom(callback: (user: IUser | string, room: IRoom) => Promise<void>): void {\n\t\tcallbacks.add(\n\t\t\t'federation.beforeAddUserToARoom',\n\t\t\tasync (params: { user: IUser | string; inviter?: IUser }, room: IRoom): Promise<void> => {\n\t\t\t\tif (!params?.user || !room || !isFederationEnabled()) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tawait callback(params.user, room);\n\t\t\t},\n\t\t\tcallbacks.priority.HIGH,\n\t\t\t'federation-v2-can-add-federated-user-to-non-federated-room',\n\t\t);\n\t}\n\n\tpublic static canAddFederatedUserToFederatedRoom(callback: (user: IUser | string, inviter: IUser, room: IRoom) => Promise<void>): void {\n\t\tcallbacks.add(\n\t\t\t'federation.beforeAddUserToARoom',\n\t\t\tasync (params: { user: IUser | string; inviter: IUser }, room: IRoom): Promise<void> => {\n\t\t\t\tif (!params?.user || !params.inviter || !room || !isFederationEnabled()) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tawait callback(params.user, params.inviter, room);\n\t\t\t},\n\t\t\tcallbacks.priority.HIGH,\n\t\t\t'federation-v2-can-add-federated-user-to-federated-room',\n\t\t);\n\t}\n\n\tpublic static canCreateDirectMessageFromUI(callback: (members: IUser[]) => Promise<void>): void {\n\t\tcallbacks.add(\n\t\t\t'federation.beforeCreateDirectMessage',\n\t\t\tasync (members: IUser[]): Promise<void> => {\n\t\t\t\tif (!members) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tthrowIfFederationNotEnabledOrNotReady();\n\n\t\t\t\tawait callback(members);\n\t\t\t},\n\t\t\tcallbacks.priority.HIGH,\n\t\t\t'federation-v2-can-create-direct-message-from-ui-ce',\n\t\t);\n\t}\n\n\tpublic static afterMessageReacted(callback: (message: IMessage, user: IUser, reaction: string) => Promise<void>): void {\n\t\tcallbacks.add(\n\t\t\t'afterSetReaction',\n\t\t\tasync (message: IMessage, params: { user: IUser; reaction: string }): Promise<void> => {\n\t\t\t\tif (!message || !isMessageFromMatrixFederation(message) || !params || !params.user || !params.reaction) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tthrowIfFederationNotEnabledOrNotReady();\n\n\t\t\t\tawait callback(message, params.user, params.reaction);\n\t\t\t},\n\t\t\tcallbacks.priority.HIGH,\n\t\t\t'federation-v2-after-message-reacted',\n\t\t);\n\t}\n\n\tpublic static afterMessageunReacted(callback: (message: IMessage, user: IUser, reaction: string) => Promise<void>): void {\n\t\tcallbacks.add(\n\t\t\t'afterUnsetReaction',\n\t\t\tasync (message: IMessage, params: { user: IUser; reaction: string; oldMessage: IMessage }): Promise<void> => {\n\t\t\t\tif (!message || !isMessageFromMatrixFederation(message) || !params || !params.user || !params.reaction || !params.oldMessage) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tthrowIfFederationNotEnabledOrNotReady();\n\n\t\t\t\tawait callback(params.oldMessage, params.user, params.reaction);\n\t\t\t},\n\t\t\tcallbacks.priority.HIGH,\n\t\t\t'federation-v2-after-message-unreacted',\n\t\t);\n\t}\n\n\tpublic static afterMessageDeleted(callback: (message: IMessage, roomId: IRoom['_id']) => Promise<void>): void {\n\t\tcallbacks.add(\n\t\t\t'afterDeleteMessage',\n\t\t\tasync (message: IMessage, room: IRoom): Promise<void> => {\n\t\t\t\tif (!room || !message || !isRoomFederated(room) || !isMessageFromMatrixFederation(message)) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tthrowIfFederationNotEnabledOrNotReady();\n\n\t\t\t\tawait callback(message, room._id);\n\t\t\t},\n\t\t\tcallbacks.priority.HIGH,\n\t\t\t'federation-v2-after-room-message-deleted',\n\t\t);\n\t}\n\n\tpublic static afterMessageUpdated(callback: (message: IMessage, roomId: IRoom['_id'], userId: string) => Promise<void>): void {\n\t\tcallbacks.add(\n\t\t\t'afterSaveMessage',\n\t\t\tasync (message: IMessage, { room }): Promise<IMessage> => {\n\t\t\t\tif (!room || !isRoomFederated(room) || !message || !isMessageFromMatrixFederation(message)) {\n\t\t\t\t\treturn message;\n\t\t\t\t}\n\n\t\t\t\tthrowIfFederationNotEnabledOrNotReady();\n\n\t\t\t\tif (!isEditedMessage(message)) {\n\t\t\t\t\treturn message;\n\t\t\t\t}\n\t\t\t\tawait callback(message, room._id, message.editedBy._id);\n\t\t\t\treturn message;\n\t\t\t},\n\t\t\tcallbacks.priority.HIGH,\n\t\t\t'federation-v2-after-room-message-updated',\n\t\t);\n\t}\n\n\tpublic static afterMessageSent(callback: (message: IMessage, roomId: IRoom['_id'], userId: string) => Promise<void>): void {\n\t\tcallbacks.add(\n\t\t\t'afterSaveMessage',\n\t\t\tasync (message: IMessage, { room }): Promise<IMessage> => {\n\t\t\t\tif (!room || !isRoomFederated(room) || !message) {\n\t\t\t\t\treturn message;\n\t\t\t\t}\n\n\t\t\t\tthrowIfFederationNotEnabledOrNotReady();\n\n\t\t\t\tif (isEditedMessage(message)) {\n\t\t\t\t\treturn message;\n\t\t\t\t}\n\t\t\t\tawait callback(message, room._id, message.u?._id);\n\t\t\t\treturn message;\n\t\t\t},\n\t\t\tcallbacks.priority.HIGH,\n\t\t\t'federation-v2-after-room-message-sent',\n\t\t);\n\t}\n\n\tpublic static async afterRoomRoleChanged(federationRoomService: FederationRoomServiceSender, data?: Record<string, any>) {\n\t\tif (!data) {\n\t\t\treturn;\n\t\t}\n\n\t\tif (!isFederationEnabled()) {\n\t\t\treturn;\n\t\t}\n\n\t\tthrowIfFederationNotReady();\n\n\t\tconst {\n\t\t\t_id: role,\n\t\t\ttype: action,\n\t\t\tscope: internalRoomId,\n\t\t\tu: { _id: internalTargetUserId = undefined } = {},\n\t\t\tgivenByUserId: internalUserId,\n\t\t} = data;\n\t\tconst roleEventsInterestedIn = ['moderator', 'owner'];\n\t\tif (!roleEventsInterestedIn.includes(role)) {\n\t\t\treturn;\n\t\t}\n\t\tconst handlers: Record<string, (internalUserId: string, internalTargetUserId: string, internalRoomId: string) => Promise<void>> = {\n\t\t\t'owner-added': (internalUserId: string, internalTargetUserId: string, internalRoomId: string): Promise<void> =>\n\t\t\t\tfederationRoomService.onRoomOwnerAdded(internalUserId, internalTargetUserId, internalRoomId),\n\t\t\t'owner-removed': (internalUserId: string, internalTargetUserId: string, internalRoomId: string): Promise<void> =>\n\t\t\t\tfederationRoomService.onRoomOwnerRemoved(internalUserId, internalTargetUserId, internalRoomId),\n\t\t\t'moderator-added': (internalUserId: string, internalTargetUserId: string, internalRoomId: string): Promise<void> =>\n\t\t\t\tfederationRoomService.onRoomModeratorAdded(internalUserId, internalTargetUserId, internalRoomId),\n\t\t\t'moderator-removed': (internalUserId: string, internalTargetUserId: string, internalRoomId: string): Promise<void> =>\n\t\t\t\tfederationRoomService.onRoomModeratorRemoved(internalUserId, internalTargetUserId, internalRoomId),\n\t\t};\n\n\t\tif (!handlers[`${role}-${action}`]) {\n\t\t\treturn;\n\t\t}\n\t\tawait handlers[`${role}-${action}`](internalUserId, internalTargetUserId, internalRoomId);\n\t}\n\n\tpublic static afterRoomNameChanged(callback: (roomId: string, changedRoomName: string) => Promise<void>): void {\n\t\tcallbacks.add(\n\t\t\t'afterRoomNameChange',\n\t\t\tasync (params: Record<string, any>): Promise<void> => {\n\t\t\t\tif (!params?.rid || !params.name) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tthrowIfFederationNotEnabledOrNotReady();\n\n\t\t\t\tawait callback(params.rid, params.name);\n\t\t\t},\n\t\t\tcallbacks.priority.HIGH,\n\t\t\t'federation-v2-after-room-name-changed',\n\t\t);\n\t}\n\n\tpublic static afterRoomTopicChanged(callback: (roomId: string, changedRoomTopic: string) => Promise<void>): void {\n\t\tcallbacks.add(\n\t\t\t'afterRoomTopicChange',\n\t\t\tasync (params: Record<string, any>): Promise<void> => {\n\t\t\t\tif (!params?.rid || !params.topic) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tthrowIfFederationNotEnabledOrNotReady();\n\n\t\t\t\tawait callback(params.rid, params.topic);\n\t\t\t},\n\t\t\tcallbacks.priority.HIGH,\n\t\t\t'federation-v2-after-room-topic-changed',\n\t\t);\n\t}\n\n\tpublic static removeCEValidation(): void {\n\t\tcallbacks.remove('federation.beforeAddUserToARoom', 'federation-v2-can-add-federated-user-to-federated-room');\n\t\tcallbacks.remove('federation.beforeCreateDirectMessage', 'federation-v2-can-create-direct-message-from-ui-ce');\n\t}\n\n\tpublic static removeAllListeners(): void {\n\t\tafterLeaveRoomCallback.remove('federation-v2-after-leave-room');\n\t\tafterRemoveFromRoomCallback.remove('federation-v2-after-remove-from-room');\n\t\tcallbacks.remove('federation.beforeAddUserToARoom', 'federation-v2-can-add-federated-user-to-non-federated-room');\n\t\tcallbacks.remove('federation.beforeAddUserToARoom', 'federation-v2-can-add-federated-user-to-federated-room');\n\t\tcallbacks.remove('federation.beforeCreateDirectMessage', 'federation-v2-can-create-direct-message-from-ui-ce');\n\t\tcallbacks.remove('afterSetReaction', 'federation-v2-after-message-reacted');\n\t\tcallbacks.remove('afterUnsetReaction', 'federation-v2-after-message-unreacted');\n\t\tcallbacks.remove('afterDeleteMessage', 'federation-v2-after-room-message-deleted');\n\t\tcallbacks.remove('afterSaveMessage', 'federation-v2-after-room-message-updated');\n\t\tcallbacks.remove('afterSaveMessage', 'federation-v2-after-room-message-sent');\n\t\tcallbacks.remove('afterSaveMessage', 'federation-v2-after-room-message-sent');\n\t\tcallbacks.remove('afterRoomNameChange', 'federation-v2-after-room-name-changed');\n\t\tcallbacks.remove('afterRoomTopicChange', 'federation-v2-after-room-topic-changed');\n\t}\n}\n"]}}},"code":"!module.wrapAsync(async function (module, __reifyWaitForDeps__, __reify_async_result__) {\n  \"use strict\";\n  try {\n    module.export({\n      FederationHooks: () => FederationHooks\n    });\n    let isMessageFromMatrixFederation, isRoomFederated, isEditedMessage;\n    module.link(\"@rocket.chat/core-typings\", {\n      isMessageFromMatrixFederation(v) {\n        isMessageFromMatrixFederation = v;\n      },\n      isRoomFederated(v) {\n        isRoomFederated = v;\n      },\n      isEditedMessage(v) {\n        isEditedMessage = v;\n      }\n    }, 0);\n    let callbacks;\n    module.link(\"../../../../../../lib/callbacks\", {\n      callbacks(v) {\n        callbacks = v;\n      }\n    }, 1);\n    let afterLeaveRoomCallback;\n    module.link(\"../../../../../../lib/callbacks/afterLeaveRoomCallback\", {\n      afterLeaveRoomCallback(v) {\n        afterLeaveRoomCallback = v;\n      }\n    }, 2);\n    let afterRemoveFromRoomCallback;\n    module.link(\"../../../../../../lib/callbacks/afterRemoveFromRoomCallback\", {\n      afterRemoveFromRoomCallback(v) {\n        afterRemoveFromRoomCallback = v;\n      }\n    }, 3);\n    let isFederationEnabled, throwIfFederationNotEnabledOrNotReady, throwIfFederationNotReady;\n    module.link(\"../../../utils\", {\n      isFederationEnabled(v) {\n        isFederationEnabled = v;\n      },\n      throwIfFederationNotEnabledOrNotReady(v) {\n        throwIfFederationNotEnabledOrNotReady = v;\n      },\n      throwIfFederationNotReady(v) {\n        throwIfFederationNotReady = v;\n      }\n    }, 4);\n    if (__reifyWaitForDeps__()) (await __reifyWaitForDeps__())();\n    class FederationHooks {\n      static afterUserLeaveRoom(callback) {\n        afterLeaveRoomCallback.add(async (user, room) => {\n          if (!room || !isRoomFederated(room) || !user) {\n            return;\n          }\n          throwIfFederationNotEnabledOrNotReady();\n          await callback(user, room);\n        }, callbacks.priority.HIGH, 'federation-v2-after-leave-room');\n      }\n      static onUserRemovedFromRoom(callback) {\n        afterRemoveFromRoomCallback.add(async (params, room) => {\n          if (!room || !isRoomFederated(room) || !params || !params.removedUser || !params.userWhoRemoved) {\n            return;\n          }\n          throwIfFederationNotEnabledOrNotReady();\n          await callback(params.removedUser, room, params.userWhoRemoved);\n        }, callbacks.priority.HIGH, 'federation-v2-after-remove-from-room');\n      }\n      static canAddFederatedUserToNonFederatedRoom(callback) {\n        callbacks.add('federation.beforeAddUserToARoom', async (params, room) => {\n          if (!(params !== null && params !== void 0 && params.user) || !room || !isFederationEnabled()) {\n            return;\n          }\n          await callback(params.user, room);\n        }, callbacks.priority.HIGH, 'federation-v2-can-add-federated-user-to-non-federated-room');\n      }\n      static canAddFederatedUserToFederatedRoom(callback) {\n        callbacks.add('federation.beforeAddUserToARoom', async (params, room) => {\n          if (!(params !== null && params !== void 0 && params.user) || !params.inviter || !room || !isFederationEnabled()) {\n            return;\n          }\n          await callback(params.user, params.inviter, room);\n        }, callbacks.priority.HIGH, 'federation-v2-can-add-federated-user-to-federated-room');\n      }\n      static canCreateDirectMessageFromUI(callback) {\n        callbacks.add('federation.beforeCreateDirectMessage', async members => {\n          if (!members) {\n            return;\n          }\n          throwIfFederationNotEnabledOrNotReady();\n          await callback(members);\n        }, callbacks.priority.HIGH, 'federation-v2-can-create-direct-message-from-ui-ce');\n      }\n      static afterMessageReacted(callback) {\n        callbacks.add('afterSetReaction', async (message, params) => {\n          if (!message || !isMessageFromMatrixFederation(message) || !params || !params.user || !params.reaction) {\n            return;\n          }\n          throwIfFederationNotEnabledOrNotReady();\n          await callback(message, params.user, params.reaction);\n        }, callbacks.priority.HIGH, 'federation-v2-after-message-reacted');\n      }\n      static afterMessageunReacted(callback) {\n        callbacks.add('afterUnsetReaction', async (message, params) => {\n          if (!message || !isMessageFromMatrixFederation(message) || !params || !params.user || !params.reaction || !params.oldMessage) {\n            return;\n          }\n          throwIfFederationNotEnabledOrNotReady();\n          await callback(params.oldMessage, params.user, params.reaction);\n        }, callbacks.priority.HIGH, 'federation-v2-after-message-unreacted');\n      }\n      static afterMessageDeleted(callback) {\n        callbacks.add('afterDeleteMessage', async (message, room) => {\n          if (!room || !message || !isRoomFederated(room) || !isMessageFromMatrixFederation(message)) {\n            return;\n          }\n          throwIfFederationNotEnabledOrNotReady();\n          await callback(message, room._id);\n        }, callbacks.priority.HIGH, 'federation-v2-after-room-message-deleted');\n      }\n      static afterMessageUpdated(callback) {\n        callbacks.add('afterSaveMessage', async (message, _ref) => {\n          let {\n            room\n          } = _ref;\n          if (!room || !isRoomFederated(room) || !message || !isMessageFromMatrixFederation(message)) {\n            return message;\n          }\n          throwIfFederationNotEnabledOrNotReady();\n          if (!isEditedMessage(message)) {\n            return message;\n          }\n          await callback(message, room._id, message.editedBy._id);\n          return message;\n        }, callbacks.priority.HIGH, 'federation-v2-after-room-message-updated');\n      }\n      static afterMessageSent(callback) {\n        callbacks.add('afterSaveMessage', async (message, _ref2) => {\n          var _message$u;\n          let {\n            room\n          } = _ref2;\n          if (!room || !isRoomFederated(room) || !message) {\n            return message;\n          }\n          throwIfFederationNotEnabledOrNotReady();\n          if (isEditedMessage(message)) {\n            return message;\n          }\n          await callback(message, room._id, (_message$u = message.u) === null || _message$u === void 0 ? void 0 : _message$u._id);\n          return message;\n        }, callbacks.priority.HIGH, 'federation-v2-after-room-message-sent');\n      }\n      static async afterRoomRoleChanged(federationRoomService, data) {\n        if (!data) {\n          return;\n        }\n        if (!isFederationEnabled()) {\n          return;\n        }\n        throwIfFederationNotReady();\n        const {\n          _id: role,\n          type: action,\n          scope: internalRoomId,\n          u: {\n            _id: internalTargetUserId = undefined\n          } = {},\n          givenByUserId: internalUserId\n        } = data;\n        const roleEventsInterestedIn = ['moderator', 'owner'];\n        if (!roleEventsInterestedIn.includes(role)) {\n          return;\n        }\n        const handlers = {\n          'owner-added': (internalUserId, internalTargetUserId, internalRoomId) => federationRoomService.onRoomOwnerAdded(internalUserId, internalTargetUserId, internalRoomId),\n          'owner-removed': (internalUserId, internalTargetUserId, internalRoomId) => federationRoomService.onRoomOwnerRemoved(internalUserId, internalTargetUserId, internalRoomId),\n          'moderator-added': (internalUserId, internalTargetUserId, internalRoomId) => federationRoomService.onRoomModeratorAdded(internalUserId, internalTargetUserId, internalRoomId),\n          'moderator-removed': (internalUserId, internalTargetUserId, internalRoomId) => federationRoomService.onRoomModeratorRemoved(internalUserId, internalTargetUserId, internalRoomId)\n        };\n        if (!handlers[\"\".concat(role, \"-\").concat(action)]) {\n          return;\n        }\n        await handlers[\"\".concat(role, \"-\").concat(action)](internalUserId, internalTargetUserId, internalRoomId);\n      }\n      static afterRoomNameChanged(callback) {\n        callbacks.add('afterRoomNameChange', async params => {\n          if (!(params !== null && params !== void 0 && params.rid) || !params.name) {\n            return;\n          }\n          throwIfFederationNotEnabledOrNotReady();\n          await callback(params.rid, params.name);\n        }, callbacks.priority.HIGH, 'federation-v2-after-room-name-changed');\n      }\n      static afterRoomTopicChanged(callback) {\n        callbacks.add('afterRoomTopicChange', async params => {\n          if (!(params !== null && params !== void 0 && params.rid) || !params.topic) {\n            return;\n          }\n          throwIfFederationNotEnabledOrNotReady();\n          await callback(params.rid, params.topic);\n        }, callbacks.priority.HIGH, 'federation-v2-after-room-topic-changed');\n      }\n      static removeCEValidation() {\n        callbacks.remove('federation.beforeAddUserToARoom', 'federation-v2-can-add-federated-user-to-federated-room');\n        callbacks.remove('federation.beforeCreateDirectMessage', 'federation-v2-can-create-direct-message-from-ui-ce');\n      }\n      static removeAllListeners() {\n        afterLeaveRoomCallback.remove('federation-v2-after-leave-room');\n        afterRemoveFromRoomCallback.remove('federation-v2-after-remove-from-room');\n        callbacks.remove('federation.beforeAddUserToARoom', 'federation-v2-can-add-federated-user-to-non-federated-room');\n        callbacks.remove('federation.beforeAddUserToARoom', 'federation-v2-can-add-federated-user-to-federated-room');\n        callbacks.remove('federation.beforeCreateDirectMessage', 'federation-v2-can-create-direct-message-from-ui-ce');\n        callbacks.remove('afterSetReaction', 'federation-v2-after-message-reacted');\n        callbacks.remove('afterUnsetReaction', 'federation-v2-after-message-unreacted');\n        callbacks.remove('afterDeleteMessage', 'federation-v2-after-room-message-deleted');\n        callbacks.remove('afterSaveMessage', 'federation-v2-after-room-message-updated');\n        callbacks.remove('afterSaveMessage', 'federation-v2-after-room-message-sent');\n        callbacks.remove('afterSaveMessage', 'federation-v2-after-room-message-sent');\n        callbacks.remove('afterRoomNameChange', 'federation-v2-after-room-name-changed');\n        callbacks.remove('afterRoomTopicChange', 'federation-v2-after-room-topic-changed');\n      }\n    }\n    __reify_async_result__();\n  } catch (_reifyError) {\n    return __reify_async_result__(_reifyError);\n  }\n  __reify_async_result__()\n}, {\n  self: this,\n  async: false\n});","map":{"version":3,"names":["module","export","FederationHooks","isMessageFromMatrixFederation","isRoomFederated","isEditedMessage","link","v","callbacks","afterLeaveRoomCallback","afterRemoveFromRoomCallback","isFederationEnabled","throwIfFederationNotEnabledOrNotReady","throwIfFederationNotReady","__reifyWaitForDeps__","afterUserLeaveRoom","callback","add","user","room","priority","HIGH","onUserRemovedFromRoom","params","removedUser","userWhoRemoved","canAddFederatedUserToNonFederatedRoom","canAddFederatedUserToFederatedRoom","inviter","canCreateDirectMessageFromUI","members","afterMessageReacted","message","reaction","afterMessageunReacted","oldMessage","afterMessageDeleted","_id","afterMessageUpdated","_ref","editedBy","afterMessageSent","_ref2","_message$u","u","afterRoomRoleChanged","federationRoomService","data","role","type","action","scope","internalRoomId","internalTargetUserId","undefined","givenByUserId","internalUserId","roleEventsInterestedIn","includes","handlers","owner-added","onRoomOwnerAdded","owner-removed","onRoomOwnerRemoved","moderator-added","onRoomModeratorAdded","moderator-removed","onRoomModeratorRemoved","concat","afterRoomNameChanged","rid","name","afterRoomTopicChanged","topic","removeCEValidation","remove","removeAllListeners","__reify_async_result__","_reifyError","self","async"],"sources":["server/services/federation/infrastructure/rocket-chat/hooks/index.ts"],"sourcesContent":["import type { IMessage, IRoom, IUser } from '@rocket.chat/core-typings';\nimport { isMessageFromMatrixFederation, isRoomFederated, isEditedMessage } from '@rocket.chat/core-typings';\n\nimport { callbacks } from '../../../../../../lib/callbacks';\nimport { afterLeaveRoomCallback } from '../../../../../../lib/callbacks/afterLeaveRoomCallback';\nimport { afterRemoveFromRoomCallback } from '../../../../../../lib/callbacks/afterRemoveFromRoomCallback';\nimport type { FederationRoomServiceSender } from '../../../application/room/sender/RoomServiceSender';\nimport { isFederationEnabled, throwIfFederationNotEnabledOrNotReady, throwIfFederationNotReady } from '../../../utils';\n\nexport class FederationHooks {\n\tpublic static afterUserLeaveRoom(callback: (user: IUser, room: IRoom) => Promise<void>): void {\n\t\tafterLeaveRoomCallback.add(\n\t\t\tasync (user: IUser, room?: IRoom): Promise<void> => {\n\t\t\t\tif (!room || !isRoomFederated(room) || !user) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tthrowIfFederationNotEnabledOrNotReady();\n\n\t\t\t\tawait callback(user, room);\n\t\t\t},\n\t\t\tcallbacks.priority.HIGH,\n\t\t\t'federation-v2-after-leave-room',\n\t\t);\n\t}\n\n\tpublic static onUserRemovedFromRoom(callback: (removedUser: IUser, room: IRoom, userWhoRemoved: IUser) => Promise<void>): void {\n\t\tafterRemoveFromRoomCallback.add(\n\t\t\tasync (params, room): Promise<void> => {\n\t\t\t\tif (!room || !isRoomFederated(room) || !params || !params.removedUser || !params.userWhoRemoved) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tthrowIfFederationNotEnabledOrNotReady();\n\n\t\t\t\tawait callback(params.removedUser, room, params.userWhoRemoved);\n\t\t\t},\n\t\t\tcallbacks.priority.HIGH,\n\t\t\t'federation-v2-after-remove-from-room',\n\t\t);\n\t}\n\n\tpublic static canAddFederatedUserToNonFederatedRoom(callback: (user: IUser | string, room: IRoom) => Promise<void>): void {\n\t\tcallbacks.add(\n\t\t\t'federation.beforeAddUserToARoom',\n\t\t\tasync (params: { user: IUser | string; inviter?: IUser }, room: IRoom): Promise<void> => {\n\t\t\t\tif (!params?.user || !room || !isFederationEnabled()) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tawait callback(params.user, room);\n\t\t\t},\n\t\t\tcallbacks.priority.HIGH,\n\t\t\t'federation-v2-can-add-federated-user-to-non-federated-room',\n\t\t);\n\t}\n\n\tpublic static canAddFederatedUserToFederatedRoom(callback: (user: IUser | string, inviter: IUser, room: IRoom) => Promise<void>): void {\n\t\tcallbacks.add(\n\t\t\t'federation.beforeAddUserToARoom',\n\t\t\tasync (params: { user: IUser | string; inviter: IUser }, room: IRoom): Promise<void> => {\n\t\t\t\tif (!params?.user || !params.inviter || !room || !isFederationEnabled()) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tawait callback(params.user, params.inviter, room);\n\t\t\t},\n\t\t\tcallbacks.priority.HIGH,\n\t\t\t'federation-v2-can-add-federated-user-to-federated-room',\n\t\t);\n\t}\n\n\tpublic static canCreateDirectMessageFromUI(callback: (members: IUser[]) => Promise<void>): void {\n\t\tcallbacks.add(\n\t\t\t'federation.beforeCreateDirectMessage',\n\t\t\tasync (members: IUser[]): Promise<void> => {\n\t\t\t\tif (!members) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tthrowIfFederationNotEnabledOrNotReady();\n\n\t\t\t\tawait callback(members);\n\t\t\t},\n\t\t\tcallbacks.priority.HIGH,\n\t\t\t'federation-v2-can-create-direct-message-from-ui-ce',\n\t\t);\n\t}\n\n\tpublic static afterMessageReacted(callback: (message: IMessage, user: IUser, reaction: string) => Promise<void>): void {\n\t\tcallbacks.add(\n\t\t\t'afterSetReaction',\n\t\t\tasync (message: IMessage, params: { user: IUser; reaction: string }): Promise<void> => {\n\t\t\t\tif (!message || !isMessageFromMatrixFederation(message) || !params || !params.user || !params.reaction) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tthrowIfFederationNotEnabledOrNotReady();\n\n\t\t\t\tawait callback(message, params.user, params.reaction);\n\t\t\t},\n\t\t\tcallbacks.priority.HIGH,\n\t\t\t'federation-v2-after-message-reacted',\n\t\t);\n\t}\n\n\tpublic static afterMessageunReacted(callback: (message: IMessage, user: IUser, reaction: string) => Promise<void>): void {\n\t\tcallbacks.add(\n\t\t\t'afterUnsetReaction',\n\t\t\tasync (message: IMessage, params: { user: IUser; reaction: string; oldMessage: IMessage }): Promise<void> => {\n\t\t\t\tif (!message || !isMessageFromMatrixFederation(message) || !params || !params.user || !params.reaction || !params.oldMessage) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tthrowIfFederationNotEnabledOrNotReady();\n\n\t\t\t\tawait callback(params.oldMessage, params.user, params.reaction);\n\t\t\t},\n\t\t\tcallbacks.priority.HIGH,\n\t\t\t'federation-v2-after-message-unreacted',\n\t\t);\n\t}\n\n\tpublic static afterMessageDeleted(callback: (message: IMessage, roomId: IRoom['_id']) => Promise<void>): void {\n\t\tcallbacks.add(\n\t\t\t'afterDeleteMessage',\n\t\t\tasync (message: IMessage, room: IRoom): Promise<void> => {\n\t\t\t\tif (!room || !message || !isRoomFederated(room) || !isMessageFromMatrixFederation(message)) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tthrowIfFederationNotEnabledOrNotReady();\n\n\t\t\t\tawait callback(message, room._id);\n\t\t\t},\n\t\t\tcallbacks.priority.HIGH,\n\t\t\t'federation-v2-after-room-message-deleted',\n\t\t);\n\t}\n\n\tpublic static afterMessageUpdated(callback: (message: IMessage, roomId: IRoom['_id'], userId: string) => Promise<void>): void {\n\t\tcallbacks.add(\n\t\t\t'afterSaveMessage',\n\t\t\tasync (message: IMessage, { room }): Promise<IMessage> => {\n\t\t\t\tif (!room || !isRoomFederated(room) || !message || !isMessageFromMatrixFederation(message)) {\n\t\t\t\t\treturn message;\n\t\t\t\t}\n\n\t\t\t\tthrowIfFederationNotEnabledOrNotReady();\n\n\t\t\t\tif (!isEditedMessage(message)) {\n\t\t\t\t\treturn message;\n\t\t\t\t}\n\t\t\t\tawait callback(message, room._id, message.editedBy._id);\n\t\t\t\treturn message;\n\t\t\t},\n\t\t\tcallbacks.priority.HIGH,\n\t\t\t'federation-v2-after-room-message-updated',\n\t\t);\n\t}\n\n\tpublic static afterMessageSent(callback: (message: IMessage, roomId: IRoom['_id'], userId: string) => Promise<void>): void {\n\t\tcallbacks.add(\n\t\t\t'afterSaveMessage',\n\t\t\tasync (message: IMessage, { room }): Promise<IMessage> => {\n\t\t\t\tif (!room || !isRoomFederated(room) || !message) {\n\t\t\t\t\treturn message;\n\t\t\t\t}\n\n\t\t\t\tthrowIfFederationNotEnabledOrNotReady();\n\n\t\t\t\tif (isEditedMessage(message)) {\n\t\t\t\t\treturn message;\n\t\t\t\t}\n\t\t\t\tawait callback(message, room._id, message.u?._id);\n\t\t\t\treturn message;\n\t\t\t},\n\t\t\tcallbacks.priority.HIGH,\n\t\t\t'federation-v2-after-room-message-sent',\n\t\t);\n\t}\n\n\tpublic static async afterRoomRoleChanged(federationRoomService: FederationRoomServiceSender, data?: Record<string, any>) {\n\t\tif (!data) {\n\t\t\treturn;\n\t\t}\n\n\t\tif (!isFederationEnabled()) {\n\t\t\treturn;\n\t\t}\n\n\t\tthrowIfFederationNotReady();\n\n\t\tconst {\n\t\t\t_id: role,\n\t\t\ttype: action,\n\t\t\tscope: internalRoomId,\n\t\t\tu: { _id: internalTargetUserId = undefined } = {},\n\t\t\tgivenByUserId: internalUserId,\n\t\t} = data;\n\t\tconst roleEventsInterestedIn = ['moderator', 'owner'];\n\t\tif (!roleEventsInterestedIn.includes(role)) {\n\t\t\treturn;\n\t\t}\n\t\tconst handlers: Record<string, (internalUserId: string, internalTargetUserId: string, internalRoomId: string) => Promise<void>> = {\n\t\t\t'owner-added': (internalUserId: string, internalTargetUserId: string, internalRoomId: string): Promise<void> =>\n\t\t\t\tfederationRoomService.onRoomOwnerAdded(internalUserId, internalTargetUserId, internalRoomId),\n\t\t\t'owner-removed': (internalUserId: string, internalTargetUserId: string, internalRoomId: string): Promise<void> =>\n\t\t\t\tfederationRoomService.onRoomOwnerRemoved(internalUserId, internalTargetUserId, internalRoomId),\n\t\t\t'moderator-added': (internalUserId: string, internalTargetUserId: string, internalRoomId: string): Promise<void> =>\n\t\t\t\tfederationRoomService.onRoomModeratorAdded(internalUserId, internalTargetUserId, internalRoomId),\n\t\t\t'moderator-removed': (internalUserId: string, internalTargetUserId: string, internalRoomId: string): Promise<void> =>\n\t\t\t\tfederationRoomService.onRoomModeratorRemoved(internalUserId, internalTargetUserId, internalRoomId),\n\t\t};\n\n\t\tif (!handlers[`${role}-${action}`]) {\n\t\t\treturn;\n\t\t}\n\t\tawait handlers[`${role}-${action}`](internalUserId, internalTargetUserId, internalRoomId);\n\t}\n\n\tpublic static afterRoomNameChanged(callback: (roomId: string, changedRoomName: string) => Promise<void>): void {\n\t\tcallbacks.add(\n\t\t\t'afterRoomNameChange',\n\t\t\tasync (params: Record<string, any>): Promise<void> => {\n\t\t\t\tif (!params?.rid || !params.name) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tthrowIfFederationNotEnabledOrNotReady();\n\n\t\t\t\tawait callback(params.rid, params.name);\n\t\t\t},\n\t\t\tcallbacks.priority.HIGH,\n\t\t\t'federation-v2-after-room-name-changed',\n\t\t);\n\t}\n\n\tpublic static afterRoomTopicChanged(callback: (roomId: string, changedRoomTopic: string) => Promise<void>): void {\n\t\tcallbacks.add(\n\t\t\t'afterRoomTopicChange',\n\t\t\tasync (params: Record<string, any>): Promise<void> => {\n\t\t\t\tif (!params?.rid || !params.topic) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tthrowIfFederationNotEnabledOrNotReady();\n\n\t\t\t\tawait callback(params.rid, params.topic);\n\t\t\t},\n\t\t\tcallbacks.priority.HIGH,\n\t\t\t'federation-v2-after-room-topic-changed',\n\t\t);\n\t}\n\n\tpublic static removeCEValidation(): void {\n\t\tcallbacks.remove('federation.beforeAddUserToARoom', 'federation-v2-can-add-federated-user-to-federated-room');\n\t\tcallbacks.remove('federation.beforeCreateDirectMessage', 'federation-v2-can-create-direct-message-from-ui-ce');\n\t}\n\n\tpublic static removeAllListeners(): void {\n\t\tafterLeaveRoomCallback.remove('federation-v2-after-leave-room');\n\t\tafterRemoveFromRoomCallback.remove('federation-v2-after-remove-from-room');\n\t\tcallbacks.remove('federation.beforeAddUserToARoom', 'federation-v2-can-add-federated-user-to-non-federated-room');\n\t\tcallbacks.remove('federation.beforeAddUserToARoom', 'federation-v2-can-add-federated-user-to-federated-room');\n\t\tcallbacks.remove('federation.beforeCreateDirectMessage', 'federation-v2-can-create-direct-message-from-ui-ce');\n\t\tcallbacks.remove('afterSetReaction', 'federation-v2-after-message-reacted');\n\t\tcallbacks.remove('afterUnsetReaction', 'federation-v2-after-message-unreacted');\n\t\tcallbacks.remove('afterDeleteMessage', 'federation-v2-after-room-message-deleted');\n\t\tcallbacks.remove('afterSaveMessage', 'federation-v2-after-room-message-updated');\n\t\tcallbacks.remove('afterSaveMessage', 'federation-v2-after-room-message-sent');\n\t\tcallbacks.remove('afterSaveMessage', 'federation-v2-after-room-message-sent');\n\t\tcallbacks.remove('afterRoomNameChange', 'federation-v2-after-room-name-changed');\n\t\tcallbacks.remove('afterRoomTopicChange', 'federation-v2-after-room-topic-changed');\n\t}\n}\n"],"mappings":"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","ignoreList":[]},"sourceType":"module","externalDependencies":{},"hash":"86a6577c5060007308940355be7514771fba0e4e"}
