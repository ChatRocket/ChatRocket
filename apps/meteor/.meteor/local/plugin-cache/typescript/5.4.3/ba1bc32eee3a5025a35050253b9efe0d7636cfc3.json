{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/app/reactions/client/methods/setReaction.ts","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","topLevelAwait","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"web.browser"},"sourceFileName":"app/reactions/client/methods/setReaction.ts","filename":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/app/reactions/client/methods/setReaction.ts","inputSourceMap":{"version":3,"file":"app/reactions/client/methods/setReaction.ts","sourceRoot":"","sources":["app/reactions/client/methods/setReaction.ts"],"names":[],"mappings":"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","sourcesContent":["import type { IMessage, IRoom } from '@rocket.chat/core-typings';\nimport type { ServerMethods } from '@rocket.chat/ddp-client';\nimport { Meteor } from 'meteor/meteor';\n\nimport { roomCoordinator } from '../../../../client/lib/rooms/roomCoordinator';\nimport { emoji } from '../../../emoji/client';\nimport { Messages, ChatRoom, Subscriptions } from '../../../models/client';\n\nMeteor.methods<ServerMethods>({\n\tasync setReaction(reaction, messageId) {\n\t\tif (!Meteor.userId()) {\n\t\t\tthrow new Meteor.Error(203, 'User_logged_out');\n\t\t}\n\n\t\tconst user = Meteor.user();\n\n\t\tif (!user?.username) {\n\t\t\treturn false;\n\t\t}\n\n\t\tconst message: IMessage | undefined = Messages.findOne({ _id: messageId });\n\t\tif (!message) {\n\t\t\treturn false;\n\t\t}\n\n\t\tconst room: IRoom | undefined = ChatRoom.findOne({ _id: message.rid });\n\t\tif (!room) {\n\t\t\treturn false;\n\t\t}\n\n\t\tif (message.private) {\n\t\t\treturn false;\n\t\t}\n\n\t\tif (!emoji.list[reaction]) {\n\t\t\treturn false;\n\t\t}\n\n\t\tif (roomCoordinator.readOnly(room._id, user)) {\n\t\t\treturn false;\n\t\t}\n\n\t\tif (!Subscriptions.findOne({ rid: message.rid })) {\n\t\t\treturn false;\n\t\t}\n\n\t\tif (message.reactions?.[reaction] && message.reactions[reaction].usernames.indexOf(user.username) !== -1) {\n\t\t\tmessage.reactions[reaction].usernames.splice(message.reactions[reaction].usernames.indexOf(user.username), 1);\n\n\t\t\tif (message.reactions[reaction].usernames.length === 0) {\n\t\t\t\tdelete message.reactions[reaction];\n\t\t\t}\n\n\t\t\tif (!message.reactions || typeof message.reactions !== 'object' || Object.keys(message.reactions).length === 0) {\n\t\t\t\tdelete message.reactions;\n\t\t\t\tMessages.update({ _id: messageId }, { $unset: { reactions: 1 } });\n\t\t\t} else {\n\t\t\t\tMessages.update({ _id: messageId }, { $set: { reactions: message.reactions } });\n\t\t\t}\n\t\t} else {\n\t\t\tif (!message.reactions) {\n\t\t\t\tmessage.reactions = {};\n\t\t\t}\n\t\t\tif (!message.reactions[reaction]) {\n\t\t\t\tmessage.reactions[reaction] = {\n\t\t\t\t\tusernames: [],\n\t\t\t\t};\n\t\t\t}\n\t\t\tmessage.reactions[reaction].usernames.push(user.username);\n\n\t\t\tMessages.update({ _id: messageId }, { $set: { reactions: message.reactions } });\n\t\t}\n\t},\n});\n"]},"targets":{"android":"125.0.0","chrome":"125.0.0","edge":"125.0.0","firefox":"115.0.0","ie":"10.0.0","ios":"17.4.0","opera":"110.0.0","opera_mobile":"80.0.0","safari":"17.4.0","samsung":"24.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor","root":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":false,"enforceStrictMode":false,"dynamicImport":true,"generateLetDeclarations":true},"externalDependencies":[]},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"version":"7.17.2","helpers":true,"useESModules":false,"corejs":false},"externalDependencies":[]},{"key":"proposal-class-properties","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true},"externalDependencies":[]},{"key":"transform-react-jsx","visitor":{"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXFragment":{"exit":[null]},"JSXElement":{"exit":[null]},"JSXAttribute":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false},"externalDependencies":[]},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-nullish-coalescing-operator","visitor":{"LogicalExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-optional-chaining","visitor":{"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-optional-catch-binding","visitor":{"CatchClause":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-class-properties","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-async-generator-functions","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-logical-assignment-operators","visitor":{"AssignmentExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]}],"presets":[],"generatorOpts":{"filename":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/app/reactions/client/methods/setReaction.ts","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"app/reactions/client/methods/setReaction.ts","inputSourceMap":{"version":3,"file":"app/reactions/client/methods/setReaction.ts","sourceRoot":"","sources":["app/reactions/client/methods/setReaction.ts"],"names":[],"mappings":"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","sourcesContent":["import type { IMessage, IRoom } from '@rocket.chat/core-typings';\nimport type { ServerMethods } from '@rocket.chat/ddp-client';\nimport { Meteor } from 'meteor/meteor';\n\nimport { roomCoordinator } from '../../../../client/lib/rooms/roomCoordinator';\nimport { emoji } from '../../../emoji/client';\nimport { Messages, ChatRoom, Subscriptions } from '../../../models/client';\n\nMeteor.methods<ServerMethods>({\n\tasync setReaction(reaction, messageId) {\n\t\tif (!Meteor.userId()) {\n\t\t\tthrow new Meteor.Error(203, 'User_logged_out');\n\t\t}\n\n\t\tconst user = Meteor.user();\n\n\t\tif (!user?.username) {\n\t\t\treturn false;\n\t\t}\n\n\t\tconst message: IMessage | undefined = Messages.findOne({ _id: messageId });\n\t\tif (!message) {\n\t\t\treturn false;\n\t\t}\n\n\t\tconst room: IRoom | undefined = ChatRoom.findOne({ _id: message.rid });\n\t\tif (!room) {\n\t\t\treturn false;\n\t\t}\n\n\t\tif (message.private) {\n\t\t\treturn false;\n\t\t}\n\n\t\tif (!emoji.list[reaction]) {\n\t\t\treturn false;\n\t\t}\n\n\t\tif (roomCoordinator.readOnly(room._id, user)) {\n\t\t\treturn false;\n\t\t}\n\n\t\tif (!Subscriptions.findOne({ rid: message.rid })) {\n\t\t\treturn false;\n\t\t}\n\n\t\tif (message.reactions?.[reaction] && message.reactions[reaction].usernames.indexOf(user.username) !== -1) {\n\t\t\tmessage.reactions[reaction].usernames.splice(message.reactions[reaction].usernames.indexOf(user.username), 1);\n\n\t\t\tif (message.reactions[reaction].usernames.length === 0) {\n\t\t\t\tdelete message.reactions[reaction];\n\t\t\t}\n\n\t\t\tif (!message.reactions || typeof message.reactions !== 'object' || Object.keys(message.reactions).length === 0) {\n\t\t\t\tdelete message.reactions;\n\t\t\t\tMessages.update({ _id: messageId }, { $unset: { reactions: 1 } });\n\t\t\t} else {\n\t\t\t\tMessages.update({ _id: messageId }, { $set: { reactions: message.reactions } });\n\t\t\t}\n\t\t} else {\n\t\t\tif (!message.reactions) {\n\t\t\t\tmessage.reactions = {};\n\t\t\t}\n\t\t\tif (!message.reactions[reaction]) {\n\t\t\t\tmessage.reactions[reaction] = {\n\t\t\t\t\tusernames: [],\n\t\t\t\t};\n\t\t\t}\n\t\t\tmessage.reactions[reaction].usernames.push(user.username);\n\n\t\t\tMessages.update({ _id: messageId }, { $set: { reactions: message.reactions } });\n\t\t}\n\t},\n});\n"]}}},"code":"let Meteor;\nmodule.link(\"meteor/meteor\", {\n  Meteor(v) {\n    Meteor = v;\n  }\n}, 0);\nlet roomCoordinator;\nmodule.link(\"../../../../client/lib/rooms/roomCoordinator\", {\n  roomCoordinator(v) {\n    roomCoordinator = v;\n  }\n}, 1);\nlet emoji;\nmodule.link(\"../../../emoji/client\", {\n  emoji(v) {\n    emoji = v;\n  }\n}, 2);\nlet Messages, ChatRoom, Subscriptions;\nmodule.link(\"../../../models/client\", {\n  Messages(v) {\n    Messages = v;\n  },\n  ChatRoom(v) {\n    ChatRoom = v;\n  },\n  Subscriptions(v) {\n    Subscriptions = v;\n  }\n}, 3);\nMeteor.methods({\n  async setReaction(reaction, messageId) {\n    var _message$reactions;\n    if (!Meteor.userId()) {\n      throw new Meteor.Error(203, 'User_logged_out');\n    }\n    const user = Meteor.user();\n    if (!(user !== null && user !== void 0 && user.username)) {\n      return false;\n    }\n    const message = Messages.findOne({\n      _id: messageId\n    });\n    if (!message) {\n      return false;\n    }\n    const room = ChatRoom.findOne({\n      _id: message.rid\n    });\n    if (!room) {\n      return false;\n    }\n    if (message.private) {\n      return false;\n    }\n    if (!emoji.list[reaction]) {\n      return false;\n    }\n    if (roomCoordinator.readOnly(room._id, user)) {\n      return false;\n    }\n    if (!Subscriptions.findOne({\n      rid: message.rid\n    })) {\n      return false;\n    }\n    if ((_message$reactions = message.reactions) !== null && _message$reactions !== void 0 && _message$reactions[reaction] && message.reactions[reaction].usernames.indexOf(user.username) !== -1) {\n      message.reactions[reaction].usernames.splice(message.reactions[reaction].usernames.indexOf(user.username), 1);\n      if (message.reactions[reaction].usernames.length === 0) {\n        delete message.reactions[reaction];\n      }\n      if (!message.reactions || typeof message.reactions !== 'object' || Object.keys(message.reactions).length === 0) {\n        delete message.reactions;\n        Messages.update({\n          _id: messageId\n        }, {\n          $unset: {\n            reactions: 1\n          }\n        });\n      } else {\n        Messages.update({\n          _id: messageId\n        }, {\n          $set: {\n            reactions: message.reactions\n          }\n        });\n      }\n    } else {\n      if (!message.reactions) {\n        message.reactions = {};\n      }\n      if (!message.reactions[reaction]) {\n        message.reactions[reaction] = {\n          usernames: []\n        };\n      }\n      message.reactions[reaction].usernames.push(user.username);\n      Messages.update({\n        _id: messageId\n      }, {\n        $set: {\n          reactions: message.reactions\n        }\n      });\n    }\n  }\n});","map":{"version":3,"names":["Meteor","module","link","v","roomCoordinator","emoji","Messages","ChatRoom","Subscriptions","methods","setReaction","reaction","messageId","_message$reactions","userId","Error","user","username","message","findOne","_id","room","rid","private","list","readOnly","reactions","usernames","indexOf","splice","length","Object","keys","update","$unset","$set","push"],"sources":["app/reactions/client/methods/setReaction.ts"],"sourcesContent":["import type { IMessage, IRoom } from '@rocket.chat/core-typings';\nimport type { ServerMethods } from '@rocket.chat/ddp-client';\nimport { Meteor } from 'meteor/meteor';\n\nimport { roomCoordinator } from '../../../../client/lib/rooms/roomCoordinator';\nimport { emoji } from '../../../emoji/client';\nimport { Messages, ChatRoom, Subscriptions } from '../../../models/client';\n\nMeteor.methods<ServerMethods>({\n\tasync setReaction(reaction, messageId) {\n\t\tif (!Meteor.userId()) {\n\t\t\tthrow new Meteor.Error(203, 'User_logged_out');\n\t\t}\n\n\t\tconst user = Meteor.user();\n\n\t\tif (!user?.username) {\n\t\t\treturn false;\n\t\t}\n\n\t\tconst message: IMessage | undefined = Messages.findOne({ _id: messageId });\n\t\tif (!message) {\n\t\t\treturn false;\n\t\t}\n\n\t\tconst room: IRoom | undefined = ChatRoom.findOne({ _id: message.rid });\n\t\tif (!room) {\n\t\t\treturn false;\n\t\t}\n\n\t\tif (message.private) {\n\t\t\treturn false;\n\t\t}\n\n\t\tif (!emoji.list[reaction]) {\n\t\t\treturn false;\n\t\t}\n\n\t\tif (roomCoordinator.readOnly(room._id, user)) {\n\t\t\treturn false;\n\t\t}\n\n\t\tif (!Subscriptions.findOne({ rid: message.rid })) {\n\t\t\treturn false;\n\t\t}\n\n\t\tif (message.reactions?.[reaction] && message.reactions[reaction].usernames.indexOf(user.username) !== -1) {\n\t\t\tmessage.reactions[reaction].usernames.splice(message.reactions[reaction].usernames.indexOf(user.username), 1);\n\n\t\t\tif (message.reactions[reaction].usernames.length === 0) {\n\t\t\t\tdelete message.reactions[reaction];\n\t\t\t}\n\n\t\t\tif (!message.reactions || typeof message.reactions !== 'object' || Object.keys(message.reactions).length === 0) {\n\t\t\t\tdelete message.reactions;\n\t\t\t\tMessages.update({ _id: messageId }, { $unset: { reactions: 1 } });\n\t\t\t} else {\n\t\t\t\tMessages.update({ _id: messageId }, { $set: { reactions: message.reactions } });\n\t\t\t}\n\t\t} else {\n\t\t\tif (!message.reactions) {\n\t\t\t\tmessage.reactions = {};\n\t\t\t}\n\t\t\tif (!message.reactions[reaction]) {\n\t\t\t\tmessage.reactions[reaction] = {\n\t\t\t\t\tusernames: [],\n\t\t\t\t};\n\t\t\t}\n\t\t\tmessage.reactions[reaction].usernames.push(user.username);\n\n\t\t\tMessages.update({ _id: messageId }, { $set: { reactions: message.reactions } });\n\t\t}\n\t},\n});\n"],"mappings":"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","ignoreList":[]},"sourceType":"module","externalDependencies":{},"hash":"ba1bc32eee3a5025a35050253b9efe0d7636cfc3"}
