{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/app/apps/server/bridges/api.ts","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","topLevelAwait","objectRestSpread","objectRestSpread","asyncGenerators","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"os.osx.arm64"},"sourceFileName":"app/apps/server/bridges/api.ts","filename":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/app/apps/server/bridges/api.ts","inputSourceMap":{"version":3,"file":"app/apps/server/bridges/api.ts","sourceRoot":"","sources":["app/apps/server/bridges/api.ts"],"names":[],"mappings":"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","sourcesContent":["import type { IAppServerOrchestrator } from '@rocket.chat/apps';\nimport type { RequestMethod } from '@rocket.chat/apps-engine/definition/accessors';\nimport type { IApiRequest, IApiEndpoint, IApi } from '@rocket.chat/apps-engine/definition/api';\nimport { ApiBridge } from '@rocket.chat/apps-engine/server/bridges/ApiBridge';\nimport type { AppApi } from '@rocket.chat/apps-engine/server/managers/AppApi';\nimport type { Response, Request, IRouter, RequestHandler } from 'express';\nimport express from 'express';\nimport { Meteor } from 'meteor/meteor';\nimport { WebApp } from 'meteor/webapp';\n\nimport { authenticationMiddleware } from '../../../api/server/middlewares/authentication';\n\nconst apiServer = express();\n\napiServer.disable('x-powered-by');\n\nWebApp.connectHandlers.use(apiServer);\n\ninterface IRequestWithPrivateHash extends Request {\n\t_privateHash?: string;\n\tcontent?: any;\n}\n\nexport class AppApisBridge extends ApiBridge {\n\tappRouters: Map<string, IRouter>;\n\n\tconstructor(private readonly orch: IAppServerOrchestrator) {\n\t\tsuper();\n\t\tthis.appRouters = new Map();\n\n\t\tapiServer.use('/api/apps/private/:appId/:hash', (req: IRequestWithPrivateHash, res: Response) => {\n\t\t\tconst notFound = (): Response => res.sendStatus(404);\n\n\t\t\tconst router = this.appRouters.get(req.params.appId);\n\n\t\t\tif (router) {\n\t\t\t\treq._privateHash = req.params.hash;\n\t\t\t\treturn router(req, res, notFound);\n\t\t\t}\n\n\t\t\tnotFound();\n\t\t});\n\n\t\tapiServer.use('/api/apps/public/:appId', (req: Request, res: Response) => {\n\t\t\tconst notFound = (): Response => res.sendStatus(404);\n\n\t\t\tconst router = this.appRouters.get(req.params.appId);\n\n\t\t\tif (router) {\n\t\t\t\treturn router(req, res, notFound);\n\t\t\t}\n\n\t\t\tnotFound();\n\t\t});\n\t}\n\n\tpublic async registerApi({ api, computedPath, endpoint }: AppApi, appId: string): Promise<void> {\n\t\tthis.orch.debugLog(`The App ${appId} is registering the api: \"${endpoint.path}\" (${computedPath})`);\n\n\t\tthis._verifyApi(api, endpoint);\n\n\t\tlet router = this.appRouters.get(appId);\n\n\t\tif (!router) {\n\t\t\trouter = express.Router(); // eslint-disable-line new-cap\n\t\t\tthis.appRouters.set(appId, router);\n\t\t}\n\n\t\tconst method = 'all';\n\n\t\tlet routePath = endpoint.path.trim();\n\t\tif (!routePath.startsWith('/')) {\n\t\t\troutePath = `/${routePath}`;\n\t\t}\n\n\t\tif (router[method] instanceof Function) {\n\t\t\trouter[method](\n\t\t\t\troutePath,\n\t\t\t\tauthenticationMiddleware({ rejectUnauthorized: !!endpoint.authRequired }),\n\t\t\t\tMeteor.bindEnvironment(this._appApiExecutor(endpoint, appId)),\n\t\t\t);\n\t\t}\n\t}\n\n\tpublic async unregisterApis(appId: string): Promise<void> {\n\t\tthis.orch.debugLog(`The App ${appId} is unregistering all apis`);\n\n\t\tif (this.appRouters.get(appId)) {\n\t\t\tthis.appRouters.delete(appId);\n\t\t}\n\t}\n\n\tprivate _verifyApi(api: IApi, endpoint: IApiEndpoint): void {\n\t\tif (typeof api !== 'object') {\n\t\t\tthrow new Error('Invalid Api parameter provided, it must be a valid IApi object.');\n\t\t}\n\n\t\tif (typeof endpoint.path !== 'string') {\n\t\t\tthrow new Error('Invalid Api parameter provided, it must be a valid IApi object.');\n\t\t}\n\t}\n\n\tprivate _appApiExecutor(endpoint: IApiEndpoint, appId: string): RequestHandler {\n\t\treturn (req: IRequestWithPrivateHash, res: Response): void => {\n\t\t\tconst request: IApiRequest = {\n\t\t\t\tmethod: req.method.toLowerCase() as RequestMethod,\n\t\t\t\theaders: req.headers as { [key: string]: string },\n\t\t\t\tquery: (req.query as { [key: string]: string }) || {},\n\t\t\t\tparams: req.params || {},\n\t\t\t\tcontent: req.body,\n\t\t\t\tprivateHash: req._privateHash,\n\t\t\t\tuser: req.user && this.orch.getConverters()?.get('users')?.convertToApp(req.user),\n\t\t\t};\n\n\t\t\tthis.orch\n\t\t\t\t.getManager()\n\t\t\t\t?.getApiManager()\n\t\t\t\t.executeApi(appId, endpoint.path, request)\n\t\t\t\t.then(({ status, headers = {}, content }) => {\n\t\t\t\t\tres.set(headers);\n\t\t\t\t\tres.status(status);\n\t\t\t\t\tres.send(content);\n\t\t\t\t})\n\t\t\t\t.catch((reason) => {\n\t\t\t\t\t// Should we handle this as an error?\n\t\t\t\t\tres.status(500).send(reason.message);\n\t\t\t\t});\n\t\t};\n\t}\n}\n"]},"targets":{"android":"125.0.0","chrome":"125.0.0","edge":"125.0.0","firefox":"115.0.0","ie":"10.0.0","ios":"17.4.0","opera":"110.0.0","opera_mobile":"80.0.0","safari":"17.4.0","samsung":"24.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor","root":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":false,"enforceStrictMode":false,"dynamicImport":true,"generateLetDeclarations":true,"topLevelAwait":true},"externalDependencies":[]},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"version":"7.17.2","helpers":true,"useESModules":false,"corejs":false},"externalDependencies":[]},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-async-generator-functions","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-class-properties","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true},"externalDependencies":[]},{"key":"transform-react-jsx","visitor":{"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXFragment":{"exit":[null]},"JSXElement":{"exit":[null]},"JSXAttribute":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false},"externalDependencies":[]},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-nullish-coalescing-operator","visitor":{"LogicalExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-optional-chaining","visitor":{"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-optional-catch-binding","visitor":{"CatchClause":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-class-properties","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-async-generator-functions","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-logical-assignment-operators","visitor":{"AssignmentExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]}],"presets":[],"generatorOpts":{"filename":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/app/apps/server/bridges/api.ts","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"app/apps/server/bridges/api.ts","inputSourceMap":{"version":3,"file":"app/apps/server/bridges/api.ts","sourceRoot":"","sources":["app/apps/server/bridges/api.ts"],"names":[],"mappings":"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","sourcesContent":["import type { IAppServerOrchestrator } from '@rocket.chat/apps';\nimport type { RequestMethod } from '@rocket.chat/apps-engine/definition/accessors';\nimport type { IApiRequest, IApiEndpoint, IApi } from '@rocket.chat/apps-engine/definition/api';\nimport { ApiBridge } from '@rocket.chat/apps-engine/server/bridges/ApiBridge';\nimport type { AppApi } from '@rocket.chat/apps-engine/server/managers/AppApi';\nimport type { Response, Request, IRouter, RequestHandler } from 'express';\nimport express from 'express';\nimport { Meteor } from 'meteor/meteor';\nimport { WebApp } from 'meteor/webapp';\n\nimport { authenticationMiddleware } from '../../../api/server/middlewares/authentication';\n\nconst apiServer = express();\n\napiServer.disable('x-powered-by');\n\nWebApp.connectHandlers.use(apiServer);\n\ninterface IRequestWithPrivateHash extends Request {\n\t_privateHash?: string;\n\tcontent?: any;\n}\n\nexport class AppApisBridge extends ApiBridge {\n\tappRouters: Map<string, IRouter>;\n\n\tconstructor(private readonly orch: IAppServerOrchestrator) {\n\t\tsuper();\n\t\tthis.appRouters = new Map();\n\n\t\tapiServer.use('/api/apps/private/:appId/:hash', (req: IRequestWithPrivateHash, res: Response) => {\n\t\t\tconst notFound = (): Response => res.sendStatus(404);\n\n\t\t\tconst router = this.appRouters.get(req.params.appId);\n\n\t\t\tif (router) {\n\t\t\t\treq._privateHash = req.params.hash;\n\t\t\t\treturn router(req, res, notFound);\n\t\t\t}\n\n\t\t\tnotFound();\n\t\t});\n\n\t\tapiServer.use('/api/apps/public/:appId', (req: Request, res: Response) => {\n\t\t\tconst notFound = (): Response => res.sendStatus(404);\n\n\t\t\tconst router = this.appRouters.get(req.params.appId);\n\n\t\t\tif (router) {\n\t\t\t\treturn router(req, res, notFound);\n\t\t\t}\n\n\t\t\tnotFound();\n\t\t});\n\t}\n\n\tpublic async registerApi({ api, computedPath, endpoint }: AppApi, appId: string): Promise<void> {\n\t\tthis.orch.debugLog(`The App ${appId} is registering the api: \"${endpoint.path}\" (${computedPath})`);\n\n\t\tthis._verifyApi(api, endpoint);\n\n\t\tlet router = this.appRouters.get(appId);\n\n\t\tif (!router) {\n\t\t\trouter = express.Router(); // eslint-disable-line new-cap\n\t\t\tthis.appRouters.set(appId, router);\n\t\t}\n\n\t\tconst method = 'all';\n\n\t\tlet routePath = endpoint.path.trim();\n\t\tif (!routePath.startsWith('/')) {\n\t\t\troutePath = `/${routePath}`;\n\t\t}\n\n\t\tif (router[method] instanceof Function) {\n\t\t\trouter[method](\n\t\t\t\troutePath,\n\t\t\t\tauthenticationMiddleware({ rejectUnauthorized: !!endpoint.authRequired }),\n\t\t\t\tMeteor.bindEnvironment(this._appApiExecutor(endpoint, appId)),\n\t\t\t);\n\t\t}\n\t}\n\n\tpublic async unregisterApis(appId: string): Promise<void> {\n\t\tthis.orch.debugLog(`The App ${appId} is unregistering all apis`);\n\n\t\tif (this.appRouters.get(appId)) {\n\t\t\tthis.appRouters.delete(appId);\n\t\t}\n\t}\n\n\tprivate _verifyApi(api: IApi, endpoint: IApiEndpoint): void {\n\t\tif (typeof api !== 'object') {\n\t\t\tthrow new Error('Invalid Api parameter provided, it must be a valid IApi object.');\n\t\t}\n\n\t\tif (typeof endpoint.path !== 'string') {\n\t\t\tthrow new Error('Invalid Api parameter provided, it must be a valid IApi object.');\n\t\t}\n\t}\n\n\tprivate _appApiExecutor(endpoint: IApiEndpoint, appId: string): RequestHandler {\n\t\treturn (req: IRequestWithPrivateHash, res: Response): void => {\n\t\t\tconst request: IApiRequest = {\n\t\t\t\tmethod: req.method.toLowerCase() as RequestMethod,\n\t\t\t\theaders: req.headers as { [key: string]: string },\n\t\t\t\tquery: (req.query as { [key: string]: string }) || {},\n\t\t\t\tparams: req.params || {},\n\t\t\t\tcontent: req.body,\n\t\t\t\tprivateHash: req._privateHash,\n\t\t\t\tuser: req.user && this.orch.getConverters()?.get('users')?.convertToApp(req.user),\n\t\t\t};\n\n\t\t\tthis.orch\n\t\t\t\t.getManager()\n\t\t\t\t?.getApiManager()\n\t\t\t\t.executeApi(appId, endpoint.path, request)\n\t\t\t\t.then(({ status, headers = {}, content }) => {\n\t\t\t\t\tres.set(headers);\n\t\t\t\t\tres.status(status);\n\t\t\t\t\tres.send(content);\n\t\t\t\t})\n\t\t\t\t.catch((reason) => {\n\t\t\t\t\t// Should we handle this as an error?\n\t\t\t\t\tres.status(500).send(reason.message);\n\t\t\t\t});\n\t\t};\n\t}\n}\n"]}}},"code":"!module.wrapAsync(async function (module, __reifyWaitForDeps__, __reify_async_result__) {\n  \"use strict\";\n  try {\n    module.export({\n      AppApisBridge: () => AppApisBridge\n    });\n    let ApiBridge;\n    module.link(\"@rocket.chat/apps-engine/server/bridges/ApiBridge\", {\n      ApiBridge(v) {\n        ApiBridge = v;\n      }\n    }, 0);\n    let express;\n    module.link(\"express\", {\n      default(v) {\n        express = v;\n      }\n    }, 1);\n    let Meteor;\n    module.link(\"meteor/meteor\", {\n      Meteor(v) {\n        Meteor = v;\n      }\n    }, 2);\n    let WebApp;\n    module.link(\"meteor/webapp\", {\n      WebApp(v) {\n        WebApp = v;\n      }\n    }, 3);\n    let authenticationMiddleware;\n    module.link(\"../../../api/server/middlewares/authentication\", {\n      authenticationMiddleware(v) {\n        authenticationMiddleware = v;\n      }\n    }, 4);\n    if (__reifyWaitForDeps__()) (await __reifyWaitForDeps__())();\n    const apiServer = express();\n    apiServer.disable('x-powered-by');\n    WebApp.connectHandlers.use(apiServer);\n    class AppApisBridge extends ApiBridge {\n      constructor(orch) {\n        super();\n        this.orch = void 0;\n        this.appRouters = void 0;\n        this.orch = orch;\n        this.appRouters = new Map();\n        apiServer.use('/api/apps/private/:appId/:hash', (req, res) => {\n          const notFound = () => res.sendStatus(404);\n          const router = this.appRouters.get(req.params.appId);\n          if (router) {\n            req._privateHash = req.params.hash;\n            return router(req, res, notFound);\n          }\n          notFound();\n        });\n        apiServer.use('/api/apps/public/:appId', (req, res) => {\n          const notFound = () => res.sendStatus(404);\n          const router = this.appRouters.get(req.params.appId);\n          if (router) {\n            return router(req, res, notFound);\n          }\n          notFound();\n        });\n      }\n      async registerApi(_ref, appId) {\n        let {\n          api,\n          computedPath,\n          endpoint\n        } = _ref;\n        this.orch.debugLog(\"The App \".concat(appId, \" is registering the api: \\\"\").concat(endpoint.path, \"\\\" (\").concat(computedPath, \")\"));\n        this._verifyApi(api, endpoint);\n        let router = this.appRouters.get(appId);\n        if (!router) {\n          router = express.Router(); // eslint-disable-line new-cap\n          this.appRouters.set(appId, router);\n        }\n        const method = 'all';\n        let routePath = endpoint.path.trim();\n        if (!routePath.startsWith('/')) {\n          routePath = \"/\".concat(routePath);\n        }\n        if (router[method] instanceof Function) {\n          router[method](routePath, authenticationMiddleware({\n            rejectUnauthorized: !!endpoint.authRequired\n          }), Meteor.bindEnvironment(this._appApiExecutor(endpoint, appId)));\n        }\n      }\n      async unregisterApis(appId) {\n        this.orch.debugLog(\"The App \".concat(appId, \" is unregistering all apis\"));\n        if (this.appRouters.get(appId)) {\n          this.appRouters.delete(appId);\n        }\n      }\n      _verifyApi(api, endpoint) {\n        if (typeof api !== 'object') {\n          throw new Error('Invalid Api parameter provided, it must be a valid IApi object.');\n        }\n        if (typeof endpoint.path !== 'string') {\n          throw new Error('Invalid Api parameter provided, it must be a valid IApi object.');\n        }\n      }\n      _appApiExecutor(endpoint, appId) {\n        return (req, res) => {\n          var _this$orch$getConvert, _this$orch$getConvert2, _this$orch$getManager;\n          const request = {\n            method: req.method.toLowerCase(),\n            headers: req.headers,\n            query: req.query || {},\n            params: req.params || {},\n            content: req.body,\n            privateHash: req._privateHash,\n            user: req.user && ((_this$orch$getConvert = this.orch.getConverters()) === null || _this$orch$getConvert === void 0 ? void 0 : (_this$orch$getConvert2 = _this$orch$getConvert.get('users')) === null || _this$orch$getConvert2 === void 0 ? void 0 : _this$orch$getConvert2.convertToApp(req.user))\n          };\n          (_this$orch$getManager = this.orch.getManager()) === null || _this$orch$getManager === void 0 ? void 0 : _this$orch$getManager.getApiManager().executeApi(appId, endpoint.path, request).then(_ref2 => {\n            let {\n              status,\n              headers = {},\n              content\n            } = _ref2;\n            res.set(headers);\n            res.status(status);\n            res.send(content);\n          }).catch(reason => {\n            // Should we handle this as an error?\n            res.status(500).send(reason.message);\n          });\n        };\n      }\n    }\n    __reify_async_result__();\n  } catch (_reifyError) {\n    return __reify_async_result__(_reifyError);\n  }\n  __reify_async_result__()\n}, {\n  self: this,\n  async: false\n});","map":{"version":3,"names":["module","export","AppApisBridge","ApiBridge","link","v","express","default","Meteor","WebApp","authenticationMiddleware","__reifyWaitForDeps__","apiServer","disable","connectHandlers","use","constructor","orch","appRouters","Map","req","res","notFound","sendStatus","router","get","params","appId","_privateHash","hash","registerApi","_ref","api","computedPath","endpoint","debugLog","concat","path","_verifyApi","Router","set","method","routePath","trim","startsWith","Function","rejectUnauthorized","authRequired","bindEnvironment","_appApiExecutor","unregisterApis","delete","Error","_this$orch$getConvert","_this$orch$getConvert2","_this$orch$getManager","request","toLowerCase","headers","query","content","body","privateHash","user","getConverters","convertToApp","getManager","getApiManager","executeApi","then","_ref2","status","send","catch","reason","message","__reify_async_result__","_reifyError","self","async"],"sources":["app/apps/server/bridges/api.ts"],"sourcesContent":["import type { IAppServerOrchestrator } from '@rocket.chat/apps';\nimport type { RequestMethod } from '@rocket.chat/apps-engine/definition/accessors';\nimport type { IApiRequest, IApiEndpoint, IApi } from '@rocket.chat/apps-engine/definition/api';\nimport { ApiBridge } from '@rocket.chat/apps-engine/server/bridges/ApiBridge';\nimport type { AppApi } from '@rocket.chat/apps-engine/server/managers/AppApi';\nimport type { Response, Request, IRouter, RequestHandler } from 'express';\nimport express from 'express';\nimport { Meteor } from 'meteor/meteor';\nimport { WebApp } from 'meteor/webapp';\n\nimport { authenticationMiddleware } from '../../../api/server/middlewares/authentication';\n\nconst apiServer = express();\n\napiServer.disable('x-powered-by');\n\nWebApp.connectHandlers.use(apiServer);\n\ninterface IRequestWithPrivateHash extends Request {\n\t_privateHash?: string;\n\tcontent?: any;\n}\n\nexport class AppApisBridge extends ApiBridge {\n\tappRouters: Map<string, IRouter>;\n\n\tconstructor(private readonly orch: IAppServerOrchestrator) {\n\t\tsuper();\n\t\tthis.appRouters = new Map();\n\n\t\tapiServer.use('/api/apps/private/:appId/:hash', (req: IRequestWithPrivateHash, res: Response) => {\n\t\t\tconst notFound = (): Response => res.sendStatus(404);\n\n\t\t\tconst router = this.appRouters.get(req.params.appId);\n\n\t\t\tif (router) {\n\t\t\t\treq._privateHash = req.params.hash;\n\t\t\t\treturn router(req, res, notFound);\n\t\t\t}\n\n\t\t\tnotFound();\n\t\t});\n\n\t\tapiServer.use('/api/apps/public/:appId', (req: Request, res: Response) => {\n\t\t\tconst notFound = (): Response => res.sendStatus(404);\n\n\t\t\tconst router = this.appRouters.get(req.params.appId);\n\n\t\t\tif (router) {\n\t\t\t\treturn router(req, res, notFound);\n\t\t\t}\n\n\t\t\tnotFound();\n\t\t});\n\t}\n\n\tpublic async registerApi({ api, computedPath, endpoint }: AppApi, appId: string): Promise<void> {\n\t\tthis.orch.debugLog(`The App ${appId} is registering the api: \"${endpoint.path}\" (${computedPath})`);\n\n\t\tthis._verifyApi(api, endpoint);\n\n\t\tlet router = this.appRouters.get(appId);\n\n\t\tif (!router) {\n\t\t\trouter = express.Router(); // eslint-disable-line new-cap\n\t\t\tthis.appRouters.set(appId, router);\n\t\t}\n\n\t\tconst method = 'all';\n\n\t\tlet routePath = endpoint.path.trim();\n\t\tif (!routePath.startsWith('/')) {\n\t\t\troutePath = `/${routePath}`;\n\t\t}\n\n\t\tif (router[method] instanceof Function) {\n\t\t\trouter[method](\n\t\t\t\troutePath,\n\t\t\t\tauthenticationMiddleware({ rejectUnauthorized: !!endpoint.authRequired }),\n\t\t\t\tMeteor.bindEnvironment(this._appApiExecutor(endpoint, appId)),\n\t\t\t);\n\t\t}\n\t}\n\n\tpublic async unregisterApis(appId: string): Promise<void> {\n\t\tthis.orch.debugLog(`The App ${appId} is unregistering all apis`);\n\n\t\tif (this.appRouters.get(appId)) {\n\t\t\tthis.appRouters.delete(appId);\n\t\t}\n\t}\n\n\tprivate _verifyApi(api: IApi, endpoint: IApiEndpoint): void {\n\t\tif (typeof api !== 'object') {\n\t\t\tthrow new Error('Invalid Api parameter provided, it must be a valid IApi object.');\n\t\t}\n\n\t\tif (typeof endpoint.path !== 'string') {\n\t\t\tthrow new Error('Invalid Api parameter provided, it must be a valid IApi object.');\n\t\t}\n\t}\n\n\tprivate _appApiExecutor(endpoint: IApiEndpoint, appId: string): RequestHandler {\n\t\treturn (req: IRequestWithPrivateHash, res: Response): void => {\n\t\t\tconst request: IApiRequest = {\n\t\t\t\tmethod: req.method.toLowerCase() as RequestMethod,\n\t\t\t\theaders: req.headers as { [key: string]: string },\n\t\t\t\tquery: (req.query as { [key: string]: string }) || {},\n\t\t\t\tparams: req.params || {},\n\t\t\t\tcontent: req.body,\n\t\t\t\tprivateHash: req._privateHash,\n\t\t\t\tuser: req.user && this.orch.getConverters()?.get('users')?.convertToApp(req.user),\n\t\t\t};\n\n\t\t\tthis.orch\n\t\t\t\t.getManager()\n\t\t\t\t?.getApiManager()\n\t\t\t\t.executeApi(appId, endpoint.path, request)\n\t\t\t\t.then(({ status, headers = {}, content }) => {\n\t\t\t\t\tres.set(headers);\n\t\t\t\t\tres.status(status);\n\t\t\t\t\tres.send(content);\n\t\t\t\t})\n\t\t\t\t.catch((reason) => {\n\t\t\t\t\t// Should we handle this as an error?\n\t\t\t\t\tres.status(500).send(reason.message);\n\t\t\t\t});\n\t\t};\n\t}\n}\n"],"mappings":"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","ignoreList":[]},"sourceType":"module","externalDependencies":{},"hash":"8e99a27b82b4d01ea9c1cc68d0a4361a9f2823da"}
