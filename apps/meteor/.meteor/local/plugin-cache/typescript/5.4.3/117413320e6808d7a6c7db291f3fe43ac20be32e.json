{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/app/file-upload/server/config/GoogleStorage.ts","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","topLevelAwait","objectRestSpread","objectRestSpread","asyncGenerators","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"os.osx.arm64"},"sourceFileName":"app/file-upload/server/config/GoogleStorage.ts","filename":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/app/file-upload/server/config/GoogleStorage.ts","inputSourceMap":{"version":3,"file":"app/file-upload/server/config/GoogleStorage.ts","sourceRoot":"","sources":["app/file-upload/server/config/GoogleStorage.ts"],"names":[],"mappings":"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","sourcesContent":["import http from 'http';\nimport https from 'https';\n\nimport _ from 'underscore';\n\nimport { forceDownload } from './helper';\nimport { settings } from '../../../settings/server';\nimport { FileUploadClass, FileUpload } from '../lib/FileUpload';\nimport '../../ufs/GoogleStorage/server';\n\nconst get: FileUploadClass['get'] = async function (this: FileUploadClass, file, req, res) {\n\tconst forcedDownload = forceDownload(req);\n\n\tconst fileUrl = await this.store.getRedirectURL(file, forcedDownload);\n\tif (!fileUrl || !file.store) {\n\t\tres.end();\n\t\treturn;\n\t}\n\n\tconst storeType = file.store.split(':').pop();\n\tif (settings.get(`FileUpload_GoogleStorage_Proxy_${storeType}`)) {\n\t\tconst request = /^https:/.test(fileUrl) ? https : http;\n\n\t\tFileUpload.proxyFile(file.name || '', fileUrl, forcedDownload, request, req, res);\n\t\treturn;\n\t}\n\n\tFileUpload.redirectToFile(fileUrl, req, res);\n};\n\nconst copy: FileUploadClass['copy'] = async function (this: FileUploadClass, file, out) {\n\tconst fileUrl = await this.store.getRedirectURL(file, false);\n\n\tif (!fileUrl) {\n\t\tout.end();\n\t\treturn;\n\t}\n\n\tconst request = /^https:/.test(fileUrl) ? https : http;\n\treturn new Promise((resolve) => {\n\t\trequest.get(fileUrl, (fileRes) => fileRes.pipe(out).on('finish', () => resolve()));\n\t});\n};\n\nconst GoogleCloudStorageUploads = new FileUploadClass({\n\tname: 'GoogleCloudStorage:Uploads',\n\tget,\n\tcopy,\n\t// store setted bellow\n});\n\nconst GoogleCloudStorageAvatars = new FileUploadClass({\n\tname: 'GoogleCloudStorage:Avatars',\n\tget,\n\tcopy,\n\t// store setted bellow\n});\n\nconst GoogleCloudStorageUserDataFiles = new FileUploadClass({\n\tname: 'GoogleCloudStorage:UserDataFiles',\n\tget,\n\tcopy,\n\t// store setted bellow\n});\n\nconst configure = _.debounce(() => {\n\tconst bucket = settings.get('FileUpload_GoogleStorage_Bucket');\n\tconst projectId = settings.get('FileUpload_GoogleStorage_ProjectId');\n\tconst accessId = settings.get('FileUpload_GoogleStorage_AccessId');\n\tconst secret = settings.get('FileUpload_GoogleStorage_Secret');\n\tconst URLExpiryTimeSpan = settings.get('FileUpload_S3_URLExpiryTimeSpan');\n\n\tif (!bucket || !accessId || !secret) {\n\t\treturn;\n\t}\n\n\tconst config = {\n\t\tconnection: {\n\t\t\tcredentials: {\n\t\t\t\tclient_email: accessId,\n\t\t\t\tprivate_key: secret,\n\t\t\t},\n\t\t\tprojectId,\n\t\t},\n\t\tbucket,\n\t\tURLExpiryTimeSpan,\n\t};\n\n\tGoogleCloudStorageUploads.store = FileUpload.configureUploadsStore('GoogleStorage', GoogleCloudStorageUploads.name, config);\n\tGoogleCloudStorageAvatars.store = FileUpload.configureUploadsStore('GoogleStorage', GoogleCloudStorageAvatars.name, config);\n\tGoogleCloudStorageUserDataFiles.store = FileUpload.configureUploadsStore('GoogleStorage', GoogleCloudStorageUserDataFiles.name, config);\n}, 500);\n\nsettings.watchByRegex(/^FileUpload_GoogleStorage_/, configure);\n"]},"targets":{"android":"125.0.0","chrome":"125.0.0","edge":"125.0.0","firefox":"115.0.0","ie":"10.0.0","ios":"17.4.0","opera":"110.0.0","opera_mobile":"80.0.0","safari":"17.4.0","samsung":"24.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor","root":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":false,"enforceStrictMode":false,"dynamicImport":true,"generateLetDeclarations":true,"topLevelAwait":true},"externalDependencies":[]},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"version":"7.17.2","helpers":true,"useESModules":false,"corejs":false},"externalDependencies":[]},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-async-generator-functions","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-class-properties","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true},"externalDependencies":[]},{"key":"transform-react-jsx","visitor":{"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXFragment":{"exit":[null]},"JSXElement":{"exit":[null]},"JSXAttribute":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false},"externalDependencies":[]},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-nullish-coalescing-operator","visitor":{"LogicalExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-optional-chaining","visitor":{"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-optional-catch-binding","visitor":{"CatchClause":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-class-properties","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-async-generator-functions","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-logical-assignment-operators","visitor":{"AssignmentExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]}],"presets":[],"generatorOpts":{"filename":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/app/file-upload/server/config/GoogleStorage.ts","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"app/file-upload/server/config/GoogleStorage.ts","inputSourceMap":{"version":3,"file":"app/file-upload/server/config/GoogleStorage.ts","sourceRoot":"","sources":["app/file-upload/server/config/GoogleStorage.ts"],"names":[],"mappings":"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","sourcesContent":["import http from 'http';\nimport https from 'https';\n\nimport _ from 'underscore';\n\nimport { forceDownload } from './helper';\nimport { settings } from '../../../settings/server';\nimport { FileUploadClass, FileUpload } from '../lib/FileUpload';\nimport '../../ufs/GoogleStorage/server';\n\nconst get: FileUploadClass['get'] = async function (this: FileUploadClass, file, req, res) {\n\tconst forcedDownload = forceDownload(req);\n\n\tconst fileUrl = await this.store.getRedirectURL(file, forcedDownload);\n\tif (!fileUrl || !file.store) {\n\t\tres.end();\n\t\treturn;\n\t}\n\n\tconst storeType = file.store.split(':').pop();\n\tif (settings.get(`FileUpload_GoogleStorage_Proxy_${storeType}`)) {\n\t\tconst request = /^https:/.test(fileUrl) ? https : http;\n\n\t\tFileUpload.proxyFile(file.name || '', fileUrl, forcedDownload, request, req, res);\n\t\treturn;\n\t}\n\n\tFileUpload.redirectToFile(fileUrl, req, res);\n};\n\nconst copy: FileUploadClass['copy'] = async function (this: FileUploadClass, file, out) {\n\tconst fileUrl = await this.store.getRedirectURL(file, false);\n\n\tif (!fileUrl) {\n\t\tout.end();\n\t\treturn;\n\t}\n\n\tconst request = /^https:/.test(fileUrl) ? https : http;\n\treturn new Promise((resolve) => {\n\t\trequest.get(fileUrl, (fileRes) => fileRes.pipe(out).on('finish', () => resolve()));\n\t});\n};\n\nconst GoogleCloudStorageUploads = new FileUploadClass({\n\tname: 'GoogleCloudStorage:Uploads',\n\tget,\n\tcopy,\n\t// store setted bellow\n});\n\nconst GoogleCloudStorageAvatars = new FileUploadClass({\n\tname: 'GoogleCloudStorage:Avatars',\n\tget,\n\tcopy,\n\t// store setted bellow\n});\n\nconst GoogleCloudStorageUserDataFiles = new FileUploadClass({\n\tname: 'GoogleCloudStorage:UserDataFiles',\n\tget,\n\tcopy,\n\t// store setted bellow\n});\n\nconst configure = _.debounce(() => {\n\tconst bucket = settings.get('FileUpload_GoogleStorage_Bucket');\n\tconst projectId = settings.get('FileUpload_GoogleStorage_ProjectId');\n\tconst accessId = settings.get('FileUpload_GoogleStorage_AccessId');\n\tconst secret = settings.get('FileUpload_GoogleStorage_Secret');\n\tconst URLExpiryTimeSpan = settings.get('FileUpload_S3_URLExpiryTimeSpan');\n\n\tif (!bucket || !accessId || !secret) {\n\t\treturn;\n\t}\n\n\tconst config = {\n\t\tconnection: {\n\t\t\tcredentials: {\n\t\t\t\tclient_email: accessId,\n\t\t\t\tprivate_key: secret,\n\t\t\t},\n\t\t\tprojectId,\n\t\t},\n\t\tbucket,\n\t\tURLExpiryTimeSpan,\n\t};\n\n\tGoogleCloudStorageUploads.store = FileUpload.configureUploadsStore('GoogleStorage', GoogleCloudStorageUploads.name, config);\n\tGoogleCloudStorageAvatars.store = FileUpload.configureUploadsStore('GoogleStorage', GoogleCloudStorageAvatars.name, config);\n\tGoogleCloudStorageUserDataFiles.store = FileUpload.configureUploadsStore('GoogleStorage', GoogleCloudStorageUserDataFiles.name, config);\n}, 500);\n\nsettings.watchByRegex(/^FileUpload_GoogleStorage_/, configure);\n"]}}},"code":"!module.wrapAsync(async function (module, __reifyWaitForDeps__, __reify_async_result__) {\n  \"use strict\";\n  try {\n    let http;\n    module.link(\"http\", {\n      default(v) {\n        http = v;\n      }\n    }, 0);\n    let https;\n    module.link(\"https\", {\n      default(v) {\n        https = v;\n      }\n    }, 1);\n    let _;\n    module.link(\"underscore\", {\n      default(v) {\n        _ = v;\n      }\n    }, 2);\n    let forceDownload;\n    module.link(\"./helper\", {\n      forceDownload(v) {\n        forceDownload = v;\n      }\n    }, 3);\n    let settings;\n    module.link(\"../../../settings/server\", {\n      settings(v) {\n        settings = v;\n      }\n    }, 4);\n    let FileUploadClass, FileUpload;\n    module.link(\"../lib/FileUpload\", {\n      FileUploadClass(v) {\n        FileUploadClass = v;\n      },\n      FileUpload(v) {\n        FileUpload = v;\n      }\n    }, 5);\n    module.link(\"../../ufs/GoogleStorage/server\");\n    if (__reifyWaitForDeps__()) (await __reifyWaitForDeps__())();\n    const get = async function (file, req, res) {\n      const forcedDownload = forceDownload(req);\n      const fileUrl = await this.store.getRedirectURL(file, forcedDownload);\n      if (!fileUrl || !file.store) {\n        res.end();\n        return;\n      }\n      const storeType = file.store.split(':').pop();\n      if (settings.get(\"FileUpload_GoogleStorage_Proxy_\".concat(storeType))) {\n        const request = /^https:/.test(fileUrl) ? https : http;\n        FileUpload.proxyFile(file.name || '', fileUrl, forcedDownload, request, req, res);\n        return;\n      }\n      FileUpload.redirectToFile(fileUrl, req, res);\n    };\n    const copy = async function (file, out) {\n      const fileUrl = await this.store.getRedirectURL(file, false);\n      if (!fileUrl) {\n        out.end();\n        return;\n      }\n      const request = /^https:/.test(fileUrl) ? https : http;\n      return new Promise(resolve => {\n        request.get(fileUrl, fileRes => fileRes.pipe(out).on('finish', () => resolve()));\n      });\n    };\n    const GoogleCloudStorageUploads = new FileUploadClass({\n      name: 'GoogleCloudStorage:Uploads',\n      get,\n      copy\n      // store setted bellow\n    });\n    const GoogleCloudStorageAvatars = new FileUploadClass({\n      name: 'GoogleCloudStorage:Avatars',\n      get,\n      copy\n      // store setted bellow\n    });\n    const GoogleCloudStorageUserDataFiles = new FileUploadClass({\n      name: 'GoogleCloudStorage:UserDataFiles',\n      get,\n      copy\n      // store setted bellow\n    });\n    const configure = _.debounce(() => {\n      const bucket = settings.get('FileUpload_GoogleStorage_Bucket');\n      const projectId = settings.get('FileUpload_GoogleStorage_ProjectId');\n      const accessId = settings.get('FileUpload_GoogleStorage_AccessId');\n      const secret = settings.get('FileUpload_GoogleStorage_Secret');\n      const URLExpiryTimeSpan = settings.get('FileUpload_S3_URLExpiryTimeSpan');\n      if (!bucket || !accessId || !secret) {\n        return;\n      }\n      const config = {\n        connection: {\n          credentials: {\n            client_email: accessId,\n            private_key: secret\n          },\n          projectId\n        },\n        bucket,\n        URLExpiryTimeSpan\n      };\n      GoogleCloudStorageUploads.store = FileUpload.configureUploadsStore('GoogleStorage', GoogleCloudStorageUploads.name, config);\n      GoogleCloudStorageAvatars.store = FileUpload.configureUploadsStore('GoogleStorage', GoogleCloudStorageAvatars.name, config);\n      GoogleCloudStorageUserDataFiles.store = FileUpload.configureUploadsStore('GoogleStorage', GoogleCloudStorageUserDataFiles.name, config);\n    }, 500);\n    settings.watchByRegex(/^FileUpload_GoogleStorage_/, configure);\n    __reify_async_result__();\n  } catch (_reifyError) {\n    return __reify_async_result__(_reifyError);\n  }\n  __reify_async_result__()\n}, {\n  self: this,\n  async: false\n});","map":{"version":3,"names":["http","module","link","default","v","https","_","forceDownload","settings","FileUploadClass","FileUpload","__reifyWaitForDeps__","get","file","req","res","forcedDownload","fileUrl","store","getRedirectURL","end","storeType","split","pop","concat","request","test","proxyFile","name","redirectToFile","copy","out","Promise","resolve","fileRes","pipe","on","GoogleCloudStorageUploads","GoogleCloudStorageAvatars","GoogleCloudStorageUserDataFiles","configure","debounce","bucket","projectId","accessId","secret","URLExpiryTimeSpan","config","connection","credentials","client_email","private_key","configureUploadsStore","watchByRegex","__reify_async_result__","_reifyError","self","async"],"sources":["app/file-upload/server/config/GoogleStorage.ts"],"sourcesContent":["import http from 'http';\nimport https from 'https';\n\nimport _ from 'underscore';\n\nimport { forceDownload } from './helper';\nimport { settings } from '../../../settings/server';\nimport { FileUploadClass, FileUpload } from '../lib/FileUpload';\nimport '../../ufs/GoogleStorage/server';\n\nconst get: FileUploadClass['get'] = async function (this: FileUploadClass, file, req, res) {\n\tconst forcedDownload = forceDownload(req);\n\n\tconst fileUrl = await this.store.getRedirectURL(file, forcedDownload);\n\tif (!fileUrl || !file.store) {\n\t\tres.end();\n\t\treturn;\n\t}\n\n\tconst storeType = file.store.split(':').pop();\n\tif (settings.get(`FileUpload_GoogleStorage_Proxy_${storeType}`)) {\n\t\tconst request = /^https:/.test(fileUrl) ? https : http;\n\n\t\tFileUpload.proxyFile(file.name || '', fileUrl, forcedDownload, request, req, res);\n\t\treturn;\n\t}\n\n\tFileUpload.redirectToFile(fileUrl, req, res);\n};\n\nconst copy: FileUploadClass['copy'] = async function (this: FileUploadClass, file, out) {\n\tconst fileUrl = await this.store.getRedirectURL(file, false);\n\n\tif (!fileUrl) {\n\t\tout.end();\n\t\treturn;\n\t}\n\n\tconst request = /^https:/.test(fileUrl) ? https : http;\n\treturn new Promise((resolve) => {\n\t\trequest.get(fileUrl, (fileRes) => fileRes.pipe(out).on('finish', () => resolve()));\n\t});\n};\n\nconst GoogleCloudStorageUploads = new FileUploadClass({\n\tname: 'GoogleCloudStorage:Uploads',\n\tget,\n\tcopy,\n\t// store setted bellow\n});\n\nconst GoogleCloudStorageAvatars = new FileUploadClass({\n\tname: 'GoogleCloudStorage:Avatars',\n\tget,\n\tcopy,\n\t// store setted bellow\n});\n\nconst GoogleCloudStorageUserDataFiles = new FileUploadClass({\n\tname: 'GoogleCloudStorage:UserDataFiles',\n\tget,\n\tcopy,\n\t// store setted bellow\n});\n\nconst configure = _.debounce(() => {\n\tconst bucket = settings.get('FileUpload_GoogleStorage_Bucket');\n\tconst projectId = settings.get('FileUpload_GoogleStorage_ProjectId');\n\tconst accessId = settings.get('FileUpload_GoogleStorage_AccessId');\n\tconst secret = settings.get('FileUpload_GoogleStorage_Secret');\n\tconst URLExpiryTimeSpan = settings.get('FileUpload_S3_URLExpiryTimeSpan');\n\n\tif (!bucket || !accessId || !secret) {\n\t\treturn;\n\t}\n\n\tconst config = {\n\t\tconnection: {\n\t\t\tcredentials: {\n\t\t\t\tclient_email: accessId,\n\t\t\t\tprivate_key: secret,\n\t\t\t},\n\t\t\tprojectId,\n\t\t},\n\t\tbucket,\n\t\tURLExpiryTimeSpan,\n\t};\n\n\tGoogleCloudStorageUploads.store = FileUpload.configureUploadsStore('GoogleStorage', GoogleCloudStorageUploads.name, config);\n\tGoogleCloudStorageAvatars.store = FileUpload.configureUploadsStore('GoogleStorage', GoogleCloudStorageAvatars.name, config);\n\tGoogleCloudStorageUserDataFiles.store = FileUpload.configureUploadsStore('GoogleStorage', GoogleCloudStorageUserDataFiles.name, config);\n}, 500);\n\nsettings.watchByRegex(/^FileUpload_GoogleStorage_/, configure);\n"],"mappings":"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","ignoreList":[]},"sourceType":"module","externalDependencies":{},"hash":"117413320e6808d7a6c7db291f3fe43ac20be32e"}
