{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/client/lib/chats/uploads.ts","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","topLevelAwait","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"web.browser.legacy"},"sourceFileName":"client/lib/chats/uploads.ts","filename":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/client/lib/chats/uploads.ts","inputSourceMap":{"version":3,"file":"client/lib/chats/uploads.ts","sourceRoot":"","sources":["client/lib/chats/uploads.ts"],"names":[],"mappings":"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","sourcesContent":["import type { IMessage, IRoom, IE2EEMessage, IUpload } from '@rocket.chat/core-typings';\nimport { Emitter } from '@rocket.chat/emitter';\nimport { Random } from '@rocket.chat/random';\n\nimport { UserAction, USER_ACTIVITIES } from '../../../app/ui/client/lib/UserAction';\nimport { sdk } from '../../../app/utils/client/lib/SDKClient';\nimport { getErrorMessage } from '../errorHandling';\nimport type { UploadsAPI } from './ChatAPI';\nimport type { Upload } from './Upload';\n\nlet uploads: readonly Upload[] = [];\n\nconst emitter = new Emitter<{ update: void; [x: `cancelling-${Upload['id']}`]: void }>();\n\nconst updateUploads = (update: (uploads: readonly Upload[]) => readonly Upload[]): void => {\n\tuploads = update(uploads);\n\temitter.emit('update');\n};\n\nconst get = (): readonly Upload[] => uploads;\n\nconst subscribe = (callback: () => void): (() => void) => emitter.on('update', callback);\n\nconst cancel = (id: Upload['id']): void => {\n\temitter.emit(`cancelling-${id}`);\n};\n\nconst wipeFailedOnes = (): void => {\n\tupdateUploads((uploads) => uploads.filter((upload) => !upload.error));\n};\n\nconst send = async (\n\tfile: File,\n\t{\n\t\tdescription,\n\t\tmsg,\n\t\trid,\n\t\ttmid,\n\t\tt,\n\t}: {\n\t\tdescription?: string;\n\t\tmsg?: string;\n\t\trid: string;\n\t\ttmid?: string;\n\t\tt?: IMessage['t'];\n\t},\n\tgetContent?: (fileId: string, fileUrl: string) => Promise<IE2EEMessage['content']>,\n\tfileContent?: { raw: Partial<IUpload>; encrypted: IE2EEMessage['content'] },\n): Promise<void> => {\n\tconst id = Random.id();\n\n\tupdateUploads((uploads) => [\n\t\t...uploads,\n\t\t{\n\t\t\tid,\n\t\t\tname: fileContent?.raw.name || file.name,\n\t\t\tpercentage: 0,\n\t\t},\n\t]);\n\n\ttry {\n\t\tawait new Promise((resolve, reject) => {\n\t\t\tconst xhr = sdk.rest.upload(\n\t\t\t\t`/v1/rooms.media/${rid}`,\n\t\t\t\t{\n\t\t\t\t\tfile,\n\t\t\t\t\t...(fileContent && {\n\t\t\t\t\t\tcontent: JSON.stringify(fileContent.encrypted),\n\t\t\t\t\t}),\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\tload: (event) => {\n\t\t\t\t\t\tresolve(event);\n\t\t\t\t\t},\n\t\t\t\t\tprogress: (event) => {\n\t\t\t\t\t\tif (!event.lengthComputable) {\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\t\t\t\t\t\tconst progress = (event.loaded / event.total) * 100;\n\t\t\t\t\t\tif (progress === 100) {\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tupdateUploads((uploads) =>\n\t\t\t\t\t\t\tuploads.map((upload) => {\n\t\t\t\t\t\t\t\tif (upload.id !== id) {\n\t\t\t\t\t\t\t\t\treturn upload;\n\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\treturn {\n\t\t\t\t\t\t\t\t\t...upload,\n\t\t\t\t\t\t\t\t\tpercentage: Math.round(progress) || 0,\n\t\t\t\t\t\t\t\t};\n\t\t\t\t\t\t\t}),\n\t\t\t\t\t\t);\n\t\t\t\t\t},\n\t\t\t\t\terror: (event) => {\n\t\t\t\t\t\tupdateUploads((uploads) =>\n\t\t\t\t\t\t\tuploads.map((upload) => {\n\t\t\t\t\t\t\t\tif (upload.id !== id) {\n\t\t\t\t\t\t\t\t\treturn upload;\n\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\treturn {\n\t\t\t\t\t\t\t\t\t...upload,\n\t\t\t\t\t\t\t\t\tpercentage: 0,\n\t\t\t\t\t\t\t\t\terror: new Error(xhr.responseText),\n\t\t\t\t\t\t\t\t};\n\t\t\t\t\t\t\t}),\n\t\t\t\t\t\t);\n\t\t\t\t\t\treject(event);\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t);\n\n\t\t\txhr.onload = async () => {\n\t\t\t\tif (xhr.readyState === xhr.DONE && xhr.status === 200) {\n\t\t\t\t\tconst result = JSON.parse(xhr.responseText);\n\t\t\t\t\tlet content;\n\t\t\t\t\tif (getContent) {\n\t\t\t\t\t\tcontent = await getContent(result.file._id, result.file.url);\n\t\t\t\t\t}\n\n\t\t\t\t\tawait sdk.rest.post(`/v1/rooms.mediaConfirm/${rid}/${result.file._id}`, {\n\t\t\t\t\t\tmsg,\n\t\t\t\t\t\ttmid,\n\t\t\t\t\t\tdescription,\n\t\t\t\t\t\tt,\n\t\t\t\t\t\tcontent,\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t};\n\n\t\t\tif (uploads.length) {\n\t\t\t\tUserAction.performContinuously(rid, USER_ACTIVITIES.USER_UPLOADING, { tmid });\n\t\t\t}\n\n\t\t\temitter.once(`cancelling-${id}`, () => {\n\t\t\t\txhr.abort();\n\t\t\t\tupdateUploads((uploads) => uploads.filter((upload) => upload.id !== id));\n\t\t\t});\n\t\t});\n\n\t\tupdateUploads((uploads) => uploads.filter((upload) => upload.id !== id));\n\t} catch (error: unknown) {\n\t\tupdateUploads((uploads) =>\n\t\t\tuploads.map((upload) => {\n\t\t\t\tif (upload.id !== id) {\n\t\t\t\t\treturn upload;\n\t\t\t\t}\n\n\t\t\t\treturn {\n\t\t\t\t\t...upload,\n\t\t\t\t\tpercentage: 0,\n\t\t\t\t\terror: new Error(getErrorMessage(error)),\n\t\t\t\t};\n\t\t\t}),\n\t\t);\n\t} finally {\n\t\tif (!uploads.length) {\n\t\t\tUserAction.stop(rid, USER_ACTIVITIES.USER_UPLOADING, { tmid });\n\t\t}\n\t}\n};\n\nexport const createUploadsAPI = ({ rid, tmid }: { rid: IRoom['_id']; tmid?: IMessage['_id'] }): UploadsAPI => ({\n\tget,\n\tsubscribe,\n\twipeFailedOnes,\n\tcancel,\n\tsend: (\n\t\tfile: File,\n\t\t{ description, msg, t }: { description?: string; msg?: string; t?: IMessage['t'] },\n\t\tgetContent?: (fileId: string, fileUrl: string) => Promise<IE2EEMessage['content']>,\n\t\tfileContent?: { raw: Partial<IUpload>; encrypted: IE2EEMessage['content'] },\n\t): Promise<void> => send(file, { description, msg, rid, tmid, t }, getContent, fileContent),\n});\n"]},"targets":{"android":"125.0.0","chrome":"125.0.0","edge":"125.0.0","firefox":"115.0.0","ie":"10.0.0","ios":"17.4.0","opera":"110.0.0","opera_mobile":"80.0.0","safari":"17.4.0","samsung":"24.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor","root":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":true,"enforceStrictMode":false,"dynamicImport":true},"externalDependencies":[]},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"version":"7.17.2","helpers":true,"useESModules":false,"corejs":false},"externalDependencies":[]},{"key":"proposal-class-properties","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true},"externalDependencies":[]},{"key":"base$0$3","visitor":{"FunctionExpression":{"exit":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"base$0$4","visitor":{"ForInStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-react-jsx","visitor":{"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXFragment":{"exit":[null]},"JSXElement":{"exit":[null]},"JSXAttribute":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false},"externalDependencies":[]},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-nullish-coalescing-operator","visitor":{"LogicalExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-optional-chaining","visitor":{"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-optional-catch-binding","visitor":{"CatchClause":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-class-properties","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-async-generator-functions","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-logical-assignment-operators","visitor":{"AssignmentExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-arrow-functions","visitor":{"ArrowFunctionExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-block-scoped-functions","visitor":{"BlockStatement":{"enter":[null]},"SwitchCase":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-block-scoping","visitor":{"VariableDeclaration":{"enter":[null,null]},"BlockStatement":{"enter":[null]},"SwitchCase":{"enter":[null]},"ClassDeclaration":{"enter":[null]},"DoWhileStatement":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForStatement":{"enter":[null]},"WhileStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-classes","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"ClassDeclaration":{"enter":[null]},"ClassExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"loose":true},"externalDependencies":[]},{"key":"transform-computed-properties","visitor":{"ObjectExpression":{"exit":[null]},"_exploded":true,"_verified":true},"options":{"loose":true},"externalDependencies":[]},{"key":"transform-destructuring","visitor":{"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"VariableDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"transform-for-of","visitor":{"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"loose":true},"externalDependencies":[]},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-object-super","visitor":{"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true,"DoWhileStatement":{"exit":[null]},"ForInStatement":{"exit":[null]},"ForStatement":{"exit":[null]},"WhileStatement":{"exit":[null]},"ForOfStatement":{"exit":[null]}},"options":{},"externalDependencies":[]},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"transform-shorthand-properties","visitor":{"ObjectMethod":{"enter":[null]},"ObjectProperty":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-spread","visitor":{"ArrayExpression":{"enter":[null]},"CallExpression":{"enter":[null]},"NewExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-sticky-regex","visitor":{"RegExpLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"loose":true},"externalDependencies":[]},{"key":"transform-typeof-symbol","visitor":{"UnaryExpression":{"enter":[null]},"_exploded":true,"_verified":true,"BlockStatement":{"enter":[null]},"CatchClause":{"enter":[null]},"DoWhileStatement":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForStatement":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"Program":{"enter":[null]},"ObjectMethod":{"enter":[null]},"SwitchStatement":{"enter":[null]},"WhileStatement":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]},"ForOfStatement":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"StaticBlock":{"enter":[null]},"TSModuleBlock":{"enter":[null]},"AssignmentPattern":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectPattern":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"transform-unicode-regex","visitor":{"RegExpLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-property-literals","visitor":{"ObjectProperty":{"exit":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-regenerator","visitor":{"ObjectMethod":{"enter":[null],"exit":[null]},"ClassMethod":{"enter":[null],"exit":[null]},"ClassPrivateMethod":{"enter":[null],"exit":[null]},"FunctionDeclaration":{"exit":[null]},"FunctionExpression":{"exit":[null]},"ArrowFunctionExpression":{"exit":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]}],"presets":[],"generatorOpts":{"filename":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/client/lib/chats/uploads.ts","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"client/lib/chats/uploads.ts","inputSourceMap":{"version":3,"file":"client/lib/chats/uploads.ts","sourceRoot":"","sources":["client/lib/chats/uploads.ts"],"names":[],"mappings":"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","sourcesContent":["import type { IMessage, IRoom, IE2EEMessage, IUpload } from '@rocket.chat/core-typings';\nimport { Emitter } from '@rocket.chat/emitter';\nimport { Random } from '@rocket.chat/random';\n\nimport { UserAction, USER_ACTIVITIES } from '../../../app/ui/client/lib/UserAction';\nimport { sdk } from '../../../app/utils/client/lib/SDKClient';\nimport { getErrorMessage } from '../errorHandling';\nimport type { UploadsAPI } from './ChatAPI';\nimport type { Upload } from './Upload';\n\nlet uploads: readonly Upload[] = [];\n\nconst emitter = new Emitter<{ update: void; [x: `cancelling-${Upload['id']}`]: void }>();\n\nconst updateUploads = (update: (uploads: readonly Upload[]) => readonly Upload[]): void => {\n\tuploads = update(uploads);\n\temitter.emit('update');\n};\n\nconst get = (): readonly Upload[] => uploads;\n\nconst subscribe = (callback: () => void): (() => void) => emitter.on('update', callback);\n\nconst cancel = (id: Upload['id']): void => {\n\temitter.emit(`cancelling-${id}`);\n};\n\nconst wipeFailedOnes = (): void => {\n\tupdateUploads((uploads) => uploads.filter((upload) => !upload.error));\n};\n\nconst send = async (\n\tfile: File,\n\t{\n\t\tdescription,\n\t\tmsg,\n\t\trid,\n\t\ttmid,\n\t\tt,\n\t}: {\n\t\tdescription?: string;\n\t\tmsg?: string;\n\t\trid: string;\n\t\ttmid?: string;\n\t\tt?: IMessage['t'];\n\t},\n\tgetContent?: (fileId: string, fileUrl: string) => Promise<IE2EEMessage['content']>,\n\tfileContent?: { raw: Partial<IUpload>; encrypted: IE2EEMessage['content'] },\n): Promise<void> => {\n\tconst id = Random.id();\n\n\tupdateUploads((uploads) => [\n\t\t...uploads,\n\t\t{\n\t\t\tid,\n\t\t\tname: fileContent?.raw.name || file.name,\n\t\t\tpercentage: 0,\n\t\t},\n\t]);\n\n\ttry {\n\t\tawait new Promise((resolve, reject) => {\n\t\t\tconst xhr = sdk.rest.upload(\n\t\t\t\t`/v1/rooms.media/${rid}`,\n\t\t\t\t{\n\t\t\t\t\tfile,\n\t\t\t\t\t...(fileContent && {\n\t\t\t\t\t\tcontent: JSON.stringify(fileContent.encrypted),\n\t\t\t\t\t}),\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\tload: (event) => {\n\t\t\t\t\t\tresolve(event);\n\t\t\t\t\t},\n\t\t\t\t\tprogress: (event) => {\n\t\t\t\t\t\tif (!event.lengthComputable) {\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\t\t\t\t\t\tconst progress = (event.loaded / event.total) * 100;\n\t\t\t\t\t\tif (progress === 100) {\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tupdateUploads((uploads) =>\n\t\t\t\t\t\t\tuploads.map((upload) => {\n\t\t\t\t\t\t\t\tif (upload.id !== id) {\n\t\t\t\t\t\t\t\t\treturn upload;\n\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\treturn {\n\t\t\t\t\t\t\t\t\t...upload,\n\t\t\t\t\t\t\t\t\tpercentage: Math.round(progress) || 0,\n\t\t\t\t\t\t\t\t};\n\t\t\t\t\t\t\t}),\n\t\t\t\t\t\t);\n\t\t\t\t\t},\n\t\t\t\t\terror: (event) => {\n\t\t\t\t\t\tupdateUploads((uploads) =>\n\t\t\t\t\t\t\tuploads.map((upload) => {\n\t\t\t\t\t\t\t\tif (upload.id !== id) {\n\t\t\t\t\t\t\t\t\treturn upload;\n\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\treturn {\n\t\t\t\t\t\t\t\t\t...upload,\n\t\t\t\t\t\t\t\t\tpercentage: 0,\n\t\t\t\t\t\t\t\t\terror: new Error(xhr.responseText),\n\t\t\t\t\t\t\t\t};\n\t\t\t\t\t\t\t}),\n\t\t\t\t\t\t);\n\t\t\t\t\t\treject(event);\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t);\n\n\t\t\txhr.onload = async () => {\n\t\t\t\tif (xhr.readyState === xhr.DONE && xhr.status === 200) {\n\t\t\t\t\tconst result = JSON.parse(xhr.responseText);\n\t\t\t\t\tlet content;\n\t\t\t\t\tif (getContent) {\n\t\t\t\t\t\tcontent = await getContent(result.file._id, result.file.url);\n\t\t\t\t\t}\n\n\t\t\t\t\tawait sdk.rest.post(`/v1/rooms.mediaConfirm/${rid}/${result.file._id}`, {\n\t\t\t\t\t\tmsg,\n\t\t\t\t\t\ttmid,\n\t\t\t\t\t\tdescription,\n\t\t\t\t\t\tt,\n\t\t\t\t\t\tcontent,\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t};\n\n\t\t\tif (uploads.length) {\n\t\t\t\tUserAction.performContinuously(rid, USER_ACTIVITIES.USER_UPLOADING, { tmid });\n\t\t\t}\n\n\t\t\temitter.once(`cancelling-${id}`, () => {\n\t\t\t\txhr.abort();\n\t\t\t\tupdateUploads((uploads) => uploads.filter((upload) => upload.id !== id));\n\t\t\t});\n\t\t});\n\n\t\tupdateUploads((uploads) => uploads.filter((upload) => upload.id !== id));\n\t} catch (error: unknown) {\n\t\tupdateUploads((uploads) =>\n\t\t\tuploads.map((upload) => {\n\t\t\t\tif (upload.id !== id) {\n\t\t\t\t\treturn upload;\n\t\t\t\t}\n\n\t\t\t\treturn {\n\t\t\t\t\t...upload,\n\t\t\t\t\tpercentage: 0,\n\t\t\t\t\terror: new Error(getErrorMessage(error)),\n\t\t\t\t};\n\t\t\t}),\n\t\t);\n\t} finally {\n\t\tif (!uploads.length) {\n\t\t\tUserAction.stop(rid, USER_ACTIVITIES.USER_UPLOADING, { tmid });\n\t\t}\n\t}\n};\n\nexport const createUploadsAPI = ({ rid, tmid }: { rid: IRoom['_id']; tmid?: IMessage['_id'] }): UploadsAPI => ({\n\tget,\n\tsubscribe,\n\twipeFailedOnes,\n\tcancel,\n\tsend: (\n\t\tfile: File,\n\t\t{ description, msg, t }: { description?: string; msg?: string; t?: IMessage['t'] },\n\t\tgetContent?: (fileId: string, fileUrl: string) => Promise<IE2EEMessage['content']>,\n\t\tfileContent?: { raw: Partial<IUpload>; encrypted: IE2EEMessage['content'] },\n\t): Promise<void> => send(file, { description, msg, rid, tmid, t }, getContent, fileContent),\n});\n"]}}},"code":"var _regeneratorRuntime;\nmodule.link(\"@babel/runtime/regenerator\", {\n  default: function (v) {\n    _regeneratorRuntime = v;\n  }\n}, 0);\nvar _objectSpread;\nmodule.link(\"@babel/runtime/helpers/objectSpread2\", {\n  default: function (v) {\n    _objectSpread = v;\n  }\n}, 1);\nvar _toConsumableArray;\nmodule.link(\"@babel/runtime/helpers/toConsumableArray\", {\n  default: function (v) {\n    _toConsumableArray = v;\n  }\n}, 2);\nmodule.export({\n  createUploadsAPI: function () {\n    return createUploadsAPI;\n  }\n});\nvar Emitter;\nmodule.link(\"@rocket.chat/emitter\", {\n  Emitter: function (v) {\n    Emitter = v;\n  }\n}, 0);\nvar Random;\nmodule.link(\"@rocket.chat/random\", {\n  Random: function (v) {\n    Random = v;\n  }\n}, 1);\nvar UserAction, USER_ACTIVITIES;\nmodule.link(\"../../../app/ui/client/lib/UserAction\", {\n  UserAction: function (v) {\n    UserAction = v;\n  },\n  USER_ACTIVITIES: function (v) {\n    USER_ACTIVITIES = v;\n  }\n}, 2);\nvar sdk;\nmodule.link(\"../../../app/utils/client/lib/SDKClient\", {\n  sdk: function (v) {\n    sdk = v;\n  }\n}, 3);\nvar getErrorMessage;\nmodule.link(\"../errorHandling\", {\n  getErrorMessage: function (v) {\n    getErrorMessage = v;\n  }\n}, 4);\nvar uploads = [];\nvar emitter = new Emitter();\nvar updateUploads = function (update) {\n  uploads = update(uploads);\n  emitter.emit('update');\n};\nvar get = function () {\n  return uploads;\n};\nvar subscribe = function (callback) {\n  return emitter.on('update', callback);\n};\nvar cancel = function (id) {\n  emitter.emit(\"cancelling-\" + id);\n};\nvar wipeFailedOnes = function () {\n  updateUploads(function (uploads) {\n    return uploads.filter(function (upload) {\n      return !upload.error;\n    });\n  });\n};\nvar send = function () {\n  function _callee2(file, _ref, getContent, fileContent) {\n    var description, msg, rid, tmid, t, id;\n    return _regeneratorRuntime.async(function () {\n      function _callee2$(_context2) {\n        while (1) switch (_context2.prev = _context2.next) {\n          case 0:\n            description = _ref.description, msg = _ref.msg, rid = _ref.rid, tmid = _ref.tmid, t = _ref.t;\n            id = Random.id();\n            updateUploads(function (uploads) {\n              return [].concat(_toConsumableArray(uploads), [{\n                id: id,\n                name: (fileContent === null || fileContent === void 0 ? void 0 : fileContent.raw.name) || file.name,\n                percentage: 0\n              }]);\n            });\n            _context2.prev = 3;\n            _context2.next = 6;\n            return _regeneratorRuntime.awrap(new Promise(function (resolve, reject) {\n              var xhr = sdk.rest.upload(\"/v1/rooms.media/\" + rid, _objectSpread({\n                file: file\n              }, fileContent && {\n                content: JSON.stringify(fileContent.encrypted)\n              }), {\n                load: function (event) {\n                  resolve(event);\n                },\n                progress: function (event) {\n                  if (!event.lengthComputable) {\n                    return;\n                  }\n                  var progress = event.loaded / event.total * 100;\n                  if (progress === 100) {\n                    return;\n                  }\n                  updateUploads(function (uploads) {\n                    return uploads.map(function (upload) {\n                      if (upload.id !== id) {\n                        return upload;\n                      }\n                      return _objectSpread(_objectSpread({}, upload), {}, {\n                        percentage: Math.round(progress) || 0\n                      });\n                    });\n                  });\n                },\n                error: function (event) {\n                  updateUploads(function (uploads) {\n                    return uploads.map(function (upload) {\n                      if (upload.id !== id) {\n                        return upload;\n                      }\n                      return _objectSpread(_objectSpread({}, upload), {}, {\n                        percentage: 0,\n                        error: new Error(xhr.responseText)\n                      });\n                    });\n                  });\n                  reject(event);\n                }\n              });\n              xhr.onload = function () {\n                function _callee() {\n                  var result, content;\n                  return _regeneratorRuntime.async(function () {\n                    function _callee$(_context) {\n                      while (1) switch (_context.prev = _context.next) {\n                        case 0:\n                          if (!(xhr.readyState === xhr.DONE && xhr.status === 200)) {\n                            _context.next = 8;\n                            break;\n                          }\n                          result = JSON.parse(xhr.responseText);\n                          if (!getContent) {\n                            _context.next = 6;\n                            break;\n                          }\n                          _context.next = 5;\n                          return _regeneratorRuntime.awrap(getContent(result.file._id, result.file.url));\n                        case 5:\n                          content = _context.sent;\n                        case 6:\n                          _context.next = 8;\n                          return _regeneratorRuntime.awrap(sdk.rest.post(\"/v1/rooms.mediaConfirm/\" + rid + \"/\" + result.file._id, {\n                            msg: msg,\n                            tmid: tmid,\n                            description: description,\n                            t: t,\n                            content: content\n                          }));\n                        case 8:\n                        case \"end\":\n                          return _context.stop();\n                      }\n                    }\n                    return _callee$;\n                  }(), null, null, null, Promise);\n                }\n                return _callee;\n              }();\n              if (uploads.length) {\n                UserAction.performContinuously(rid, USER_ACTIVITIES.USER_UPLOADING, {\n                  tmid: tmid\n                });\n              }\n              emitter.once(\"cancelling-\" + id, function () {\n                xhr.abort();\n                updateUploads(function (uploads) {\n                  return uploads.filter(function (upload) {\n                    return upload.id !== id;\n                  });\n                });\n              });\n            }));\n          case 6:\n            updateUploads(function (uploads) {\n              return uploads.filter(function (upload) {\n                return upload.id !== id;\n              });\n            });\n            _context2.next = 12;\n            break;\n          case 9:\n            _context2.prev = 9;\n            _context2.t0 = _context2[\"catch\"](3);\n            updateUploads(function (uploads) {\n              return uploads.map(function (upload) {\n                if (upload.id !== id) {\n                  return upload;\n                }\n                return _objectSpread(_objectSpread({}, upload), {}, {\n                  percentage: 0,\n                  error: new Error(getErrorMessage(_context2.t0))\n                });\n              });\n            });\n          case 12:\n            _context2.prev = 12;\n            if (!uploads.length) {\n              UserAction.stop(rid, USER_ACTIVITIES.USER_UPLOADING, {\n                tmid: tmid\n              });\n            }\n            return _context2.finish(12);\n          case 15:\n          case \"end\":\n            return _context2.stop();\n        }\n      }\n      return _callee2$;\n    }(), null, null, [[3, 9, 12, 15]], Promise);\n  }\n  return _callee2;\n}();\nvar createUploadsAPI = function (_ref2) {\n  var rid = _ref2.rid,\n    tmid = _ref2.tmid;\n  return {\n    get: get,\n    subscribe: subscribe,\n    wipeFailedOnes: wipeFailedOnes,\n    cancel: cancel,\n    send: function (file, _ref3, getContent, fileContent) {\n      var description = _ref3.description,\n        msg = _ref3.msg,\n        t = _ref3.t;\n      return send(file, {\n        description: description,\n        msg: msg,\n        rid: rid,\n        tmid: tmid,\n        t: t\n      }, getContent, fileContent);\n    }\n  };\n};","map":{"version":3,"names":["_regeneratorRuntime","module","link","default","v","_objectSpread","_toConsumableArray","export","createUploadsAPI","Emitter","Random","UserAction","USER_ACTIVITIES","sdk","getErrorMessage","uploads","emitter","updateUploads","update","emit","get","subscribe","callback","on","cancel","id","wipeFailedOnes","filter","upload","error","send","_callee2","file","_ref","getContent","fileContent","description","msg","rid","tmid","t","async","_callee2$","_context2","prev","next","concat","name","raw","percentage","awrap","Promise","resolve","reject","xhr","rest","content","JSON","stringify","encrypted","load","event","progress","lengthComputable","loaded","total","map","Math","round","Error","responseText","onload","_callee","result","_callee$","_context","readyState","DONE","status","parse","_id","url","sent","post","stop","length","performContinuously","USER_UPLOADING","once","abort","t0","finish","_ref2","_ref3"],"sources":["client/lib/chats/uploads.ts"],"sourcesContent":["import type { IMessage, IRoom, IE2EEMessage, IUpload } from '@rocket.chat/core-typings';\nimport { Emitter } from '@rocket.chat/emitter';\nimport { Random } from '@rocket.chat/random';\n\nimport { UserAction, USER_ACTIVITIES } from '../../../app/ui/client/lib/UserAction';\nimport { sdk } from '../../../app/utils/client/lib/SDKClient';\nimport { getErrorMessage } from '../errorHandling';\nimport type { UploadsAPI } from './ChatAPI';\nimport type { Upload } from './Upload';\n\nlet uploads: readonly Upload[] = [];\n\nconst emitter = new Emitter<{ update: void; [x: `cancelling-${Upload['id']}`]: void }>();\n\nconst updateUploads = (update: (uploads: readonly Upload[]) => readonly Upload[]): void => {\n\tuploads = update(uploads);\n\temitter.emit('update');\n};\n\nconst get = (): readonly Upload[] => uploads;\n\nconst subscribe = (callback: () => void): (() => void) => emitter.on('update', callback);\n\nconst cancel = (id: Upload['id']): void => {\n\temitter.emit(`cancelling-${id}`);\n};\n\nconst wipeFailedOnes = (): void => {\n\tupdateUploads((uploads) => uploads.filter((upload) => !upload.error));\n};\n\nconst send = async (\n\tfile: File,\n\t{\n\t\tdescription,\n\t\tmsg,\n\t\trid,\n\t\ttmid,\n\t\tt,\n\t}: {\n\t\tdescription?: string;\n\t\tmsg?: string;\n\t\trid: string;\n\t\ttmid?: string;\n\t\tt?: IMessage['t'];\n\t},\n\tgetContent?: (fileId: string, fileUrl: string) => Promise<IE2EEMessage['content']>,\n\tfileContent?: { raw: Partial<IUpload>; encrypted: IE2EEMessage['content'] },\n): Promise<void> => {\n\tconst id = Random.id();\n\n\tupdateUploads((uploads) => [\n\t\t...uploads,\n\t\t{\n\t\t\tid,\n\t\t\tname: fileContent?.raw.name || file.name,\n\t\t\tpercentage: 0,\n\t\t},\n\t]);\n\n\ttry {\n\t\tawait new Promise((resolve, reject) => {\n\t\t\tconst xhr = sdk.rest.upload(\n\t\t\t\t`/v1/rooms.media/${rid}`,\n\t\t\t\t{\n\t\t\t\t\tfile,\n\t\t\t\t\t...(fileContent && {\n\t\t\t\t\t\tcontent: JSON.stringify(fileContent.encrypted),\n\t\t\t\t\t}),\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\tload: (event) => {\n\t\t\t\t\t\tresolve(event);\n\t\t\t\t\t},\n\t\t\t\t\tprogress: (event) => {\n\t\t\t\t\t\tif (!event.lengthComputable) {\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\t\t\t\t\t\tconst progress = (event.loaded / event.total) * 100;\n\t\t\t\t\t\tif (progress === 100) {\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tupdateUploads((uploads) =>\n\t\t\t\t\t\t\tuploads.map((upload) => {\n\t\t\t\t\t\t\t\tif (upload.id !== id) {\n\t\t\t\t\t\t\t\t\treturn upload;\n\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\treturn {\n\t\t\t\t\t\t\t\t\t...upload,\n\t\t\t\t\t\t\t\t\tpercentage: Math.round(progress) || 0,\n\t\t\t\t\t\t\t\t};\n\t\t\t\t\t\t\t}),\n\t\t\t\t\t\t);\n\t\t\t\t\t},\n\t\t\t\t\terror: (event) => {\n\t\t\t\t\t\tupdateUploads((uploads) =>\n\t\t\t\t\t\t\tuploads.map((upload) => {\n\t\t\t\t\t\t\t\tif (upload.id !== id) {\n\t\t\t\t\t\t\t\t\treturn upload;\n\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\treturn {\n\t\t\t\t\t\t\t\t\t...upload,\n\t\t\t\t\t\t\t\t\tpercentage: 0,\n\t\t\t\t\t\t\t\t\terror: new Error(xhr.responseText),\n\t\t\t\t\t\t\t\t};\n\t\t\t\t\t\t\t}),\n\t\t\t\t\t\t);\n\t\t\t\t\t\treject(event);\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t);\n\n\t\t\txhr.onload = async () => {\n\t\t\t\tif (xhr.readyState === xhr.DONE && xhr.status === 200) {\n\t\t\t\t\tconst result = JSON.parse(xhr.responseText);\n\t\t\t\t\tlet content;\n\t\t\t\t\tif (getContent) {\n\t\t\t\t\t\tcontent = await getContent(result.file._id, result.file.url);\n\t\t\t\t\t}\n\n\t\t\t\t\tawait sdk.rest.post(`/v1/rooms.mediaConfirm/${rid}/${result.file._id}`, {\n\t\t\t\t\t\tmsg,\n\t\t\t\t\t\ttmid,\n\t\t\t\t\t\tdescription,\n\t\t\t\t\t\tt,\n\t\t\t\t\t\tcontent,\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t};\n\n\t\t\tif (uploads.length) {\n\t\t\t\tUserAction.performContinuously(rid, USER_ACTIVITIES.USER_UPLOADING, { tmid });\n\t\t\t}\n\n\t\t\temitter.once(`cancelling-${id}`, () => {\n\t\t\t\txhr.abort();\n\t\t\t\tupdateUploads((uploads) => uploads.filter((upload) => upload.id !== id));\n\t\t\t});\n\t\t});\n\n\t\tupdateUploads((uploads) => uploads.filter((upload) => upload.id !== id));\n\t} catch (error: unknown) {\n\t\tupdateUploads((uploads) =>\n\t\t\tuploads.map((upload) => {\n\t\t\t\tif (upload.id !== id) {\n\t\t\t\t\treturn upload;\n\t\t\t\t}\n\n\t\t\t\treturn {\n\t\t\t\t\t...upload,\n\t\t\t\t\tpercentage: 0,\n\t\t\t\t\terror: new Error(getErrorMessage(error)),\n\t\t\t\t};\n\t\t\t}),\n\t\t);\n\t} finally {\n\t\tif (!uploads.length) {\n\t\t\tUserAction.stop(rid, USER_ACTIVITIES.USER_UPLOADING, { tmid });\n\t\t}\n\t}\n};\n\nexport const createUploadsAPI = ({ rid, tmid }: { rid: IRoom['_id']; tmid?: IMessage['_id'] }): UploadsAPI => ({\n\tget,\n\tsubscribe,\n\twipeFailedOnes,\n\tcancel,\n\tsend: (\n\t\tfile: File,\n\t\t{ description, msg, t }: { description?: string; msg?: string; t?: IMessage['t'] },\n\t\tgetContent?: (fileId: string, fileUrl: string) => Promise<IE2EEMessage['content']>,\n\t\tfileContent?: { raw: Partial<IUpload>; encrypted: IE2EEMessage['content'] },\n\t): Promise<void> => send(file, { description, msg, rid, tmid, t }, getContent, fileContent),\n});\n"],"mappings":"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","ignoreList":[]},"sourceType":"module","externalDependencies":{},"hash":"746c0b38f5d010c2072b9c2273586ddc9a19e00c"}
