{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/ee/server/apps/communication/uikit.ts","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","topLevelAwait","objectRestSpread","objectRestSpread","asyncGenerators","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"os.osx.arm64"},"sourceFileName":"ee/server/apps/communication/uikit.ts","filename":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/ee/server/apps/communication/uikit.ts","inputSourceMap":{"version":3,"file":"ee/server/apps/communication/uikit.ts","sourceRoot":"","sources":["ee/server/apps/communication/uikit.ts"],"names":[],"mappings":"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","sourcesContent":["import type { UiKitCoreAppPayload } from '@rocket.chat/core-services';\nimport { UiKitCoreApp } from '@rocket.chat/core-services';\nimport type { OperationParams, UrlParams } from '@rocket.chat/rest-typings';\nimport cors from 'cors';\nimport type { Request, Response } from 'express';\nimport express from 'express';\nimport rateLimit from 'express-rate-limit';\nimport { Meteor } from 'meteor/meteor';\nimport { WebApp } from 'meteor/webapp';\n\nimport { authenticationMiddleware } from '../../../../app/api/server/middlewares/authentication';\nimport { settings } from '../../../../app/settings/server';\nimport type { AppServerOrchestrator } from '../orchestrator';\nimport { Apps } from '../orchestrator';\n\nconst apiServer = express();\n\napiServer.disable('x-powered-by');\n\nlet corsEnabled = false;\nlet allowListOrigins: string[] = [];\n\nsettings.watch('API_Enable_CORS', (value: boolean) => {\n\tcorsEnabled = value;\n});\n\nsettings.watch('API_CORS_Origin', (value: string) => {\n\tallowListOrigins = value\n\t\t? value\n\t\t\t\t.trim()\n\t\t\t\t.split(',')\n\t\t\t\t.map((origin) => String(origin).trim().toLocaleLowerCase())\n\t\t: [];\n});\n\nWebApp.connectHandlers.use(apiServer);\n\n// eslint-disable-next-line new-cap\nconst router = express.Router();\n\nconst unauthorized = (res: Response): unknown =>\n\tres.status(401).send({\n\t\tstatus: 'error',\n\t\tmessage: 'You must be logged in to do this.',\n\t});\n\nMeteor.startup(() => {\n\t// use specific rate limit of 600 (which is 60 times the default limits) requests per minute (around 10/second)\n\tconst apiLimiter = rateLimit({\n\t\twindowMs: settings.get('API_Enable_Rate_Limiter_Limit_Time_Default'),\n\t\tmax: (settings.get('API_Enable_Rate_Limiter_Limit_Calls_Default') as number) * 60,\n\t\tskip: () =>\n\t\t\tsettings.get('API_Enable_Rate_Limiter') !== true ||\n\t\t\t(process.env.NODE_ENV === 'development' && settings.get('API_Enable_Rate_Limiter_Dev') !== true),\n\t});\n\n\trouter.use(apiLimiter);\n});\n\nrouter.use(authenticationMiddleware({ rejectUnauthorized: false }));\n\nrouter.use(async (req: Request, res, next) => {\n\tconst { 'x-visitor-token': visitorToken } = req.headers;\n\n\tif (visitorToken) {\n\t\treq.body.visitor = await Apps.getConverters()?.get('visitors').convertByToken(visitorToken);\n\t}\n\n\tif (!req.user && !req.body.visitor) {\n\t\treturn unauthorized(res);\n\t}\n\n\tnext();\n});\n\nconst corsOptions: cors.CorsOptions = {\n\torigin: (origin, callback) => {\n\t\tif (\n\t\t\t!origin ||\n\t\t\t!corsEnabled ||\n\t\t\tallowListOrigins.includes('*') ||\n\t\t\tallowListOrigins.includes(origin) ||\n\t\t\torigin === settings.get('Site_Url')\n\t\t) {\n\t\t\tcallback(null, true);\n\t\t} else {\n\t\t\tcallback(new Error('Not allowed by CORS'), false);\n\t\t}\n\t},\n};\n\napiServer.use('/api/apps/ui.interaction/', cors(corsOptions), router); // didn't have the rateLimiter option\n\ntype UiKitUserInteractionRequest = Request<\n\tUrlParams<'/apps/ui.interaction/:id'>,\n\tany,\n\tOperationParams<'POST', '/apps/ui.interaction/:id'> & {\n\t\tvisitor?: {\n\t\t\tid: string;\n\t\t\tusername: string;\n\t\t\tname?: string;\n\t\t\tdepartment?: string;\n\t\t\tupdatedAt?: Date;\n\t\t\ttoken: string;\n\t\t\tphone?: { phoneNumber: string }[] | null;\n\t\t\tvisitorEmails?: { address: string }[];\n\t\t\tlivechatData?: Record<string, unknown>;\n\t\t\tstatus?: 'online' | 'away' | 'offline' | 'busy' | 'disabled';\n\t\t};\n\t}\n>;\n\nconst getCoreAppPayload = (req: UiKitUserInteractionRequest): UiKitCoreAppPayload => {\n\tconst { id: appId } = req.params;\n\n\tif (req.body.type === 'blockAction') {\n\t\tconst { user } = req;\n\t\tconst { type, actionId, triggerId, payload, container, visitor } = req.body;\n\t\tconst message = 'mid' in req.body ? req.body.mid : undefined;\n\t\tconst room = 'rid' in req.body ? req.body.rid : undefined;\n\n\t\treturn {\n\t\t\tappId,\n\t\t\ttype,\n\t\t\tactionId,\n\t\t\ttriggerId,\n\t\t\tcontainer,\n\t\t\tmessage,\n\t\t\tpayload,\n\t\t\tuser,\n\t\t\tvisitor,\n\t\t\troom,\n\t\t};\n\t}\n\n\tif (req.body.type === 'viewClosed') {\n\t\tconst { user } = req;\n\t\tconst {\n\t\t\ttype,\n\t\t\tpayload: { view, isCleared },\n\t\t\ttriggerId,\n\t\t} = req.body;\n\n\t\treturn {\n\t\t\tappId,\n\t\t\ttriggerId,\n\t\t\ttype,\n\t\t\tuser,\n\t\t\tpayload: {\n\t\t\t\tview,\n\t\t\t\tisCleared,\n\t\t\t},\n\t\t};\n\t}\n\n\tif (req.body.type === 'viewSubmit') {\n\t\tconst { user } = req;\n\t\tconst { type, actionId, triggerId, payload } = req.body;\n\n\t\treturn {\n\t\t\tappId,\n\t\t\ttype,\n\t\t\tactionId,\n\t\t\ttriggerId,\n\t\t\tpayload,\n\t\t\tuser,\n\t\t};\n\t}\n\n\tthrow new Error('Type not supported');\n};\n\nrouter.post('/:id', async (req: UiKitUserInteractionRequest, res, next) => {\n\tconst { id: appId } = req.params;\n\n\tconst isCoreApp = await UiKitCoreApp.isRegistered(appId);\n\tif (!isCoreApp) {\n\t\treturn next();\n\t}\n\n\ttry {\n\t\tconst payload = getCoreAppPayload(req);\n\n\t\tconst result = await UiKitCoreApp[payload.type](payload);\n\n\t\t// Using ?? to always send something in the response, even if the app had no result.\n\t\tres.send(result ?? {});\n\t} catch (e) {\n\t\tconst error = e instanceof Error ? e.message : e;\n\t\tres.status(500).send({ error });\n\t}\n});\n\nexport class AppUIKitInteractionApi {\n\torch: AppServerOrchestrator;\n\n\tconstructor(orch: AppServerOrchestrator) {\n\t\tthis.orch = orch;\n\n\t\trouter.post('/:id', this.routeHandler);\n\t}\n\n\tprivate routeHandler = async (req: UiKitUserInteractionRequest, res: Response): Promise<void> => {\n\t\tconst { orch } = this;\n\t\tconst { id: appId } = req.params;\n\n\t\tswitch (req.body.type) {\n\t\t\tcase 'blockAction': {\n\t\t\t\tconst { type, actionId, triggerId, payload, container } = req.body;\n\t\t\t\tconst mid = 'mid' in req.body ? req.body.mid : undefined;\n\t\t\t\tconst rid = 'rid' in req.body ? req.body.rid : undefined;\n\n\t\t\t\tconst { visitor } = req.body;\n\t\t\t\tconst room = await orch.getConverters()?.get('rooms').convertById(rid);\n\t\t\t\tconst user = orch.getConverters()?.get('users').convertToApp(req.user);\n\t\t\t\tconst message = mid && (await orch.getConverters()?.get('messages').convertById(mid));\n\n\t\t\t\tconst action = {\n\t\t\t\t\ttype,\n\t\t\t\t\tcontainer,\n\t\t\t\t\tappId,\n\t\t\t\t\tactionId,\n\t\t\t\t\tmessage,\n\t\t\t\t\ttriggerId,\n\t\t\t\t\tpayload,\n\t\t\t\t\tuser,\n\t\t\t\t\tvisitor,\n\t\t\t\t\troom,\n\t\t\t\t};\n\n\t\t\t\ttry {\n\t\t\t\t\tconst eventInterface = !visitor ? 'IUIKitInteractionHandler' : 'IUIKitLivechatInteractionHandler';\n\n\t\t\t\t\tconst result = await orch.triggerEvent(eventInterface, action);\n\n\t\t\t\t\tres.send(result);\n\t\t\t\t} catch (e) {\n\t\t\t\t\tconst error = e instanceof Error ? e.message : e;\n\t\t\t\t\tres.status(500).send({ error });\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\tcase 'viewClosed': {\n\t\t\t\tconst {\n\t\t\t\t\ttype,\n\t\t\t\t\tpayload: { view, isCleared },\n\t\t\t\t} = req.body;\n\n\t\t\t\tconst user = orch.getConverters()?.get('users').convertToApp(req.user);\n\n\t\t\t\tconst action = {\n\t\t\t\t\ttype,\n\t\t\t\t\tappId,\n\t\t\t\t\tuser,\n\t\t\t\t\tpayload: {\n\t\t\t\t\t\tview,\n\t\t\t\t\t\tisCleared,\n\t\t\t\t\t},\n\t\t\t\t};\n\n\t\t\t\ttry {\n\t\t\t\t\tconst result = await orch.triggerEvent('IUIKitInteractionHandler', action);\n\n\t\t\t\t\tres.send(result);\n\t\t\t\t} catch (e) {\n\t\t\t\t\tconst error = e instanceof Error ? e.message : e;\n\t\t\t\t\tres.status(500).send({ error });\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\tcase 'viewSubmit': {\n\t\t\t\tconst { type, actionId, triggerId, payload } = req.body;\n\n\t\t\t\tconst user = orch.getConverters()?.get('users').convertToApp(req.user);\n\n\t\t\t\tconst action = {\n\t\t\t\t\ttype,\n\t\t\t\t\tappId,\n\t\t\t\t\tactionId,\n\t\t\t\t\ttriggerId,\n\t\t\t\t\tpayload,\n\t\t\t\t\tuser,\n\t\t\t\t};\n\n\t\t\t\ttry {\n\t\t\t\t\tconst result = await orch.triggerEvent('IUIKitInteractionHandler', action);\n\n\t\t\t\t\tres.send(result);\n\t\t\t\t} catch (e) {\n\t\t\t\t\tconst error = e instanceof Error ? e.message : e;\n\t\t\t\t\tres.status(500).send({ error });\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\tcase 'actionButton': {\n\t\t\t\tconst {\n\t\t\t\t\ttype,\n\t\t\t\t\tactionId,\n\t\t\t\t\ttriggerId,\n\t\t\t\t\trid,\n\t\t\t\t\tmid,\n\t\t\t\t\ttmid,\n\t\t\t\t\tpayload: { context, message: msgText },\n\t\t\t\t} = req.body;\n\n\t\t\t\tconst room = await orch.getConverters()?.get('rooms').convertById(rid);\n\t\t\t\tconst user = orch.getConverters()?.get('users').convertToApp(req.user);\n\t\t\t\tconst message = mid && (await orch.getConverters()?.get('messages').convertById(mid));\n\n\t\t\t\tconst action = {\n\t\t\t\t\ttype,\n\t\t\t\t\tappId,\n\t\t\t\t\tactionId,\n\t\t\t\t\ttriggerId,\n\t\t\t\t\tuser,\n\t\t\t\t\troom,\n\t\t\t\t\tmessage,\n\t\t\t\t\ttmid,\n\t\t\t\t\tpayload: {\n\t\t\t\t\t\tcontext,\n\t\t\t\t\t\t...(msgText ? { message: msgText } : {}),\n\t\t\t\t\t},\n\t\t\t\t};\n\n\t\t\t\ttry {\n\t\t\t\t\tconst result = await orch.triggerEvent('IUIKitInteractionHandler', action);\n\n\t\t\t\t\tres.send(result);\n\t\t\t\t} catch (e) {\n\t\t\t\t\tconst error = e instanceof Error ? e.message : e;\n\t\t\t\t\tres.status(500).send({ error });\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\tdefault: {\n\t\t\t\tres.status(400).send({ error: 'Unknown action' });\n\t\t\t}\n\t\t}\n\n\t\t// TODO: validate payloads per type\n\t};\n}\n"]},"targets":{"android":"125.0.0","chrome":"125.0.0","edge":"125.0.0","firefox":"115.0.0","ie":"10.0.0","ios":"17.4.0","opera":"110.0.0","opera_mobile":"80.0.0","safari":"17.4.0","samsung":"24.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor","root":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":false,"enforceStrictMode":false,"dynamicImport":true,"generateLetDeclarations":true,"topLevelAwait":true},"externalDependencies":[]},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"version":"7.17.2","helpers":true,"useESModules":false,"corejs":false},"externalDependencies":[]},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-async-generator-functions","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-class-properties","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true},"externalDependencies":[]},{"key":"transform-react-jsx","visitor":{"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXFragment":{"exit":[null]},"JSXElement":{"exit":[null]},"JSXAttribute":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false},"externalDependencies":[]},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-nullish-coalescing-operator","visitor":{"LogicalExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-optional-chaining","visitor":{"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-optional-catch-binding","visitor":{"CatchClause":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-class-properties","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-async-generator-functions","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-logical-assignment-operators","visitor":{"AssignmentExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]}],"presets":[],"generatorOpts":{"filename":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/ee/server/apps/communication/uikit.ts","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"ee/server/apps/communication/uikit.ts","inputSourceMap":{"version":3,"file":"ee/server/apps/communication/uikit.ts","sourceRoot":"","sources":["ee/server/apps/communication/uikit.ts"],"names":[],"mappings":"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","sourcesContent":["import type { UiKitCoreAppPayload } from '@rocket.chat/core-services';\nimport { UiKitCoreApp } from '@rocket.chat/core-services';\nimport type { OperationParams, UrlParams } from '@rocket.chat/rest-typings';\nimport cors from 'cors';\nimport type { Request, Response } from 'express';\nimport express from 'express';\nimport rateLimit from 'express-rate-limit';\nimport { Meteor } from 'meteor/meteor';\nimport { WebApp } from 'meteor/webapp';\n\nimport { authenticationMiddleware } from '../../../../app/api/server/middlewares/authentication';\nimport { settings } from '../../../../app/settings/server';\nimport type { AppServerOrchestrator } from '../orchestrator';\nimport { Apps } from '../orchestrator';\n\nconst apiServer = express();\n\napiServer.disable('x-powered-by');\n\nlet corsEnabled = false;\nlet allowListOrigins: string[] = [];\n\nsettings.watch('API_Enable_CORS', (value: boolean) => {\n\tcorsEnabled = value;\n});\n\nsettings.watch('API_CORS_Origin', (value: string) => {\n\tallowListOrigins = value\n\t\t? value\n\t\t\t\t.trim()\n\t\t\t\t.split(',')\n\t\t\t\t.map((origin) => String(origin).trim().toLocaleLowerCase())\n\t\t: [];\n});\n\nWebApp.connectHandlers.use(apiServer);\n\n// eslint-disable-next-line new-cap\nconst router = express.Router();\n\nconst unauthorized = (res: Response): unknown =>\n\tres.status(401).send({\n\t\tstatus: 'error',\n\t\tmessage: 'You must be logged in to do this.',\n\t});\n\nMeteor.startup(() => {\n\t// use specific rate limit of 600 (which is 60 times the default limits) requests per minute (around 10/second)\n\tconst apiLimiter = rateLimit({\n\t\twindowMs: settings.get('API_Enable_Rate_Limiter_Limit_Time_Default'),\n\t\tmax: (settings.get('API_Enable_Rate_Limiter_Limit_Calls_Default') as number) * 60,\n\t\tskip: () =>\n\t\t\tsettings.get('API_Enable_Rate_Limiter') !== true ||\n\t\t\t(process.env.NODE_ENV === 'development' && settings.get('API_Enable_Rate_Limiter_Dev') !== true),\n\t});\n\n\trouter.use(apiLimiter);\n});\n\nrouter.use(authenticationMiddleware({ rejectUnauthorized: false }));\n\nrouter.use(async (req: Request, res, next) => {\n\tconst { 'x-visitor-token': visitorToken } = req.headers;\n\n\tif (visitorToken) {\n\t\treq.body.visitor = await Apps.getConverters()?.get('visitors').convertByToken(visitorToken);\n\t}\n\n\tif (!req.user && !req.body.visitor) {\n\t\treturn unauthorized(res);\n\t}\n\n\tnext();\n});\n\nconst corsOptions: cors.CorsOptions = {\n\torigin: (origin, callback) => {\n\t\tif (\n\t\t\t!origin ||\n\t\t\t!corsEnabled ||\n\t\t\tallowListOrigins.includes('*') ||\n\t\t\tallowListOrigins.includes(origin) ||\n\t\t\torigin === settings.get('Site_Url')\n\t\t) {\n\t\t\tcallback(null, true);\n\t\t} else {\n\t\t\tcallback(new Error('Not allowed by CORS'), false);\n\t\t}\n\t},\n};\n\napiServer.use('/api/apps/ui.interaction/', cors(corsOptions), router); // didn't have the rateLimiter option\n\ntype UiKitUserInteractionRequest = Request<\n\tUrlParams<'/apps/ui.interaction/:id'>,\n\tany,\n\tOperationParams<'POST', '/apps/ui.interaction/:id'> & {\n\t\tvisitor?: {\n\t\t\tid: string;\n\t\t\tusername: string;\n\t\t\tname?: string;\n\t\t\tdepartment?: string;\n\t\t\tupdatedAt?: Date;\n\t\t\ttoken: string;\n\t\t\tphone?: { phoneNumber: string }[] | null;\n\t\t\tvisitorEmails?: { address: string }[];\n\t\t\tlivechatData?: Record<string, unknown>;\n\t\t\tstatus?: 'online' | 'away' | 'offline' | 'busy' | 'disabled';\n\t\t};\n\t}\n>;\n\nconst getCoreAppPayload = (req: UiKitUserInteractionRequest): UiKitCoreAppPayload => {\n\tconst { id: appId } = req.params;\n\n\tif (req.body.type === 'blockAction') {\n\t\tconst { user } = req;\n\t\tconst { type, actionId, triggerId, payload, container, visitor } = req.body;\n\t\tconst message = 'mid' in req.body ? req.body.mid : undefined;\n\t\tconst room = 'rid' in req.body ? req.body.rid : undefined;\n\n\t\treturn {\n\t\t\tappId,\n\t\t\ttype,\n\t\t\tactionId,\n\t\t\ttriggerId,\n\t\t\tcontainer,\n\t\t\tmessage,\n\t\t\tpayload,\n\t\t\tuser,\n\t\t\tvisitor,\n\t\t\troom,\n\t\t};\n\t}\n\n\tif (req.body.type === 'viewClosed') {\n\t\tconst { user } = req;\n\t\tconst {\n\t\t\ttype,\n\t\t\tpayload: { view, isCleared },\n\t\t\ttriggerId,\n\t\t} = req.body;\n\n\t\treturn {\n\t\t\tappId,\n\t\t\ttriggerId,\n\t\t\ttype,\n\t\t\tuser,\n\t\t\tpayload: {\n\t\t\t\tview,\n\t\t\t\tisCleared,\n\t\t\t},\n\t\t};\n\t}\n\n\tif (req.body.type === 'viewSubmit') {\n\t\tconst { user } = req;\n\t\tconst { type, actionId, triggerId, payload } = req.body;\n\n\t\treturn {\n\t\t\tappId,\n\t\t\ttype,\n\t\t\tactionId,\n\t\t\ttriggerId,\n\t\t\tpayload,\n\t\t\tuser,\n\t\t};\n\t}\n\n\tthrow new Error('Type not supported');\n};\n\nrouter.post('/:id', async (req: UiKitUserInteractionRequest, res, next) => {\n\tconst { id: appId } = req.params;\n\n\tconst isCoreApp = await UiKitCoreApp.isRegistered(appId);\n\tif (!isCoreApp) {\n\t\treturn next();\n\t}\n\n\ttry {\n\t\tconst payload = getCoreAppPayload(req);\n\n\t\tconst result = await UiKitCoreApp[payload.type](payload);\n\n\t\t// Using ?? to always send something in the response, even if the app had no result.\n\t\tres.send(result ?? {});\n\t} catch (e) {\n\t\tconst error = e instanceof Error ? e.message : e;\n\t\tres.status(500).send({ error });\n\t}\n});\n\nexport class AppUIKitInteractionApi {\n\torch: AppServerOrchestrator;\n\n\tconstructor(orch: AppServerOrchestrator) {\n\t\tthis.orch = orch;\n\n\t\trouter.post('/:id', this.routeHandler);\n\t}\n\n\tprivate routeHandler = async (req: UiKitUserInteractionRequest, res: Response): Promise<void> => {\n\t\tconst { orch } = this;\n\t\tconst { id: appId } = req.params;\n\n\t\tswitch (req.body.type) {\n\t\t\tcase 'blockAction': {\n\t\t\t\tconst { type, actionId, triggerId, payload, container } = req.body;\n\t\t\t\tconst mid = 'mid' in req.body ? req.body.mid : undefined;\n\t\t\t\tconst rid = 'rid' in req.body ? req.body.rid : undefined;\n\n\t\t\t\tconst { visitor } = req.body;\n\t\t\t\tconst room = await orch.getConverters()?.get('rooms').convertById(rid);\n\t\t\t\tconst user = orch.getConverters()?.get('users').convertToApp(req.user);\n\t\t\t\tconst message = mid && (await orch.getConverters()?.get('messages').convertById(mid));\n\n\t\t\t\tconst action = {\n\t\t\t\t\ttype,\n\t\t\t\t\tcontainer,\n\t\t\t\t\tappId,\n\t\t\t\t\tactionId,\n\t\t\t\t\tmessage,\n\t\t\t\t\ttriggerId,\n\t\t\t\t\tpayload,\n\t\t\t\t\tuser,\n\t\t\t\t\tvisitor,\n\t\t\t\t\troom,\n\t\t\t\t};\n\n\t\t\t\ttry {\n\t\t\t\t\tconst eventInterface = !visitor ? 'IUIKitInteractionHandler' : 'IUIKitLivechatInteractionHandler';\n\n\t\t\t\t\tconst result = await orch.triggerEvent(eventInterface, action);\n\n\t\t\t\t\tres.send(result);\n\t\t\t\t} catch (e) {\n\t\t\t\t\tconst error = e instanceof Error ? e.message : e;\n\t\t\t\t\tres.status(500).send({ error });\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\tcase 'viewClosed': {\n\t\t\t\tconst {\n\t\t\t\t\ttype,\n\t\t\t\t\tpayload: { view, isCleared },\n\t\t\t\t} = req.body;\n\n\t\t\t\tconst user = orch.getConverters()?.get('users').convertToApp(req.user);\n\n\t\t\t\tconst action = {\n\t\t\t\t\ttype,\n\t\t\t\t\tappId,\n\t\t\t\t\tuser,\n\t\t\t\t\tpayload: {\n\t\t\t\t\t\tview,\n\t\t\t\t\t\tisCleared,\n\t\t\t\t\t},\n\t\t\t\t};\n\n\t\t\t\ttry {\n\t\t\t\t\tconst result = await orch.triggerEvent('IUIKitInteractionHandler', action);\n\n\t\t\t\t\tres.send(result);\n\t\t\t\t} catch (e) {\n\t\t\t\t\tconst error = e instanceof Error ? e.message : e;\n\t\t\t\t\tres.status(500).send({ error });\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\tcase 'viewSubmit': {\n\t\t\t\tconst { type, actionId, triggerId, payload } = req.body;\n\n\t\t\t\tconst user = orch.getConverters()?.get('users').convertToApp(req.user);\n\n\t\t\t\tconst action = {\n\t\t\t\t\ttype,\n\t\t\t\t\tappId,\n\t\t\t\t\tactionId,\n\t\t\t\t\ttriggerId,\n\t\t\t\t\tpayload,\n\t\t\t\t\tuser,\n\t\t\t\t};\n\n\t\t\t\ttry {\n\t\t\t\t\tconst result = await orch.triggerEvent('IUIKitInteractionHandler', action);\n\n\t\t\t\t\tres.send(result);\n\t\t\t\t} catch (e) {\n\t\t\t\t\tconst error = e instanceof Error ? e.message : e;\n\t\t\t\t\tres.status(500).send({ error });\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\tcase 'actionButton': {\n\t\t\t\tconst {\n\t\t\t\t\ttype,\n\t\t\t\t\tactionId,\n\t\t\t\t\ttriggerId,\n\t\t\t\t\trid,\n\t\t\t\t\tmid,\n\t\t\t\t\ttmid,\n\t\t\t\t\tpayload: { context, message: msgText },\n\t\t\t\t} = req.body;\n\n\t\t\t\tconst room = await orch.getConverters()?.get('rooms').convertById(rid);\n\t\t\t\tconst user = orch.getConverters()?.get('users').convertToApp(req.user);\n\t\t\t\tconst message = mid && (await orch.getConverters()?.get('messages').convertById(mid));\n\n\t\t\t\tconst action = {\n\t\t\t\t\ttype,\n\t\t\t\t\tappId,\n\t\t\t\t\tactionId,\n\t\t\t\t\ttriggerId,\n\t\t\t\t\tuser,\n\t\t\t\t\troom,\n\t\t\t\t\tmessage,\n\t\t\t\t\ttmid,\n\t\t\t\t\tpayload: {\n\t\t\t\t\t\tcontext,\n\t\t\t\t\t\t...(msgText ? { message: msgText } : {}),\n\t\t\t\t\t},\n\t\t\t\t};\n\n\t\t\t\ttry {\n\t\t\t\t\tconst result = await orch.triggerEvent('IUIKitInteractionHandler', action);\n\n\t\t\t\t\tres.send(result);\n\t\t\t\t} catch (e) {\n\t\t\t\t\tconst error = e instanceof Error ? e.message : e;\n\t\t\t\t\tres.status(500).send({ error });\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\tdefault: {\n\t\t\t\tres.status(400).send({ error: 'Unknown action' });\n\t\t\t}\n\t\t}\n\n\t\t// TODO: validate payloads per type\n\t};\n}\n"]}}},"code":"!module.wrapAsync(async function (module, __reifyWaitForDeps__, __reify_async_result__) {\n  \"use strict\";\n  try {\n    let _objectSpread;\n    module.link(\"@babel/runtime/helpers/objectSpread2\", {\n      default(v) {\n        _objectSpread = v;\n      }\n    }, 0);\n    module.export({\n      AppUIKitInteractionApi: () => AppUIKitInteractionApi\n    });\n    let UiKitCoreApp;\n    module.link(\"@rocket.chat/core-services\", {\n      UiKitCoreApp(v) {\n        UiKitCoreApp = v;\n      }\n    }, 0);\n    let cors;\n    module.link(\"cors\", {\n      default(v) {\n        cors = v;\n      }\n    }, 1);\n    let express;\n    module.link(\"express\", {\n      default(v) {\n        express = v;\n      }\n    }, 2);\n    let rateLimit;\n    module.link(\"express-rate-limit\", {\n      default(v) {\n        rateLimit = v;\n      }\n    }, 3);\n    let Meteor;\n    module.link(\"meteor/meteor\", {\n      Meteor(v) {\n        Meteor = v;\n      }\n    }, 4);\n    let WebApp;\n    module.link(\"meteor/webapp\", {\n      WebApp(v) {\n        WebApp = v;\n      }\n    }, 5);\n    let authenticationMiddleware;\n    module.link(\"../../../../app/api/server/middlewares/authentication\", {\n      authenticationMiddleware(v) {\n        authenticationMiddleware = v;\n      }\n    }, 6);\n    let settings;\n    module.link(\"../../../../app/settings/server\", {\n      settings(v) {\n        settings = v;\n      }\n    }, 7);\n    let Apps;\n    module.link(\"../orchestrator\", {\n      Apps(v) {\n        Apps = v;\n      }\n    }, 8);\n    if (__reifyWaitForDeps__()) (await __reifyWaitForDeps__())();\n    const apiServer = express();\n    apiServer.disable('x-powered-by');\n    let corsEnabled = false;\n    let allowListOrigins = [];\n    settings.watch('API_Enable_CORS', value => {\n      corsEnabled = value;\n    });\n    settings.watch('API_CORS_Origin', value => {\n      allowListOrigins = value ? value.trim().split(',').map(origin => String(origin).trim().toLocaleLowerCase()) : [];\n    });\n    WebApp.connectHandlers.use(apiServer);\n    // eslint-disable-next-line new-cap\n    const router = express.Router();\n    const unauthorized = res => res.status(401).send({\n      status: 'error',\n      message: 'You must be logged in to do this.'\n    });\n    Meteor.startup(() => {\n      // use specific rate limit of 600 (which is 60 times the default limits) requests per minute (around 10/second)\n      const apiLimiter = rateLimit({\n        windowMs: settings.get('API_Enable_Rate_Limiter_Limit_Time_Default'),\n        max: settings.get('API_Enable_Rate_Limiter_Limit_Calls_Default') * 60,\n        skip: () => settings.get('API_Enable_Rate_Limiter') !== true || process.env.NODE_ENV === 'development' && settings.get('API_Enable_Rate_Limiter_Dev') !== true\n      });\n      router.use(apiLimiter);\n    });\n    router.use(authenticationMiddleware({\n      rejectUnauthorized: false\n    }));\n    router.use(async (req, res, next) => {\n      const {\n        'x-visitor-token': visitorToken\n      } = req.headers;\n      if (visitorToken) {\n        var _Apps$getConverters;\n        req.body.visitor = await ((_Apps$getConverters = Apps.getConverters()) === null || _Apps$getConverters === void 0 ? void 0 : _Apps$getConverters.get('visitors').convertByToken(visitorToken));\n      }\n      if (!req.user && !req.body.visitor) {\n        return unauthorized(res);\n      }\n      next();\n    });\n    const corsOptions = {\n      origin: (origin, callback) => {\n        if (!origin || !corsEnabled || allowListOrigins.includes('*') || allowListOrigins.includes(origin) || origin === settings.get('Site_Url')) {\n          callback(null, true);\n        } else {\n          callback(new Error('Not allowed by CORS'), false);\n        }\n      }\n    };\n    apiServer.use('/api/apps/ui.interaction/', cors(corsOptions), router); // didn't have the rateLimiter option\n    const getCoreAppPayload = req => {\n      const {\n        id: appId\n      } = req.params;\n      if (req.body.type === 'blockAction') {\n        const {\n          user\n        } = req;\n        const {\n          type,\n          actionId,\n          triggerId,\n          payload,\n          container,\n          visitor\n        } = req.body;\n        const message = 'mid' in req.body ? req.body.mid : undefined;\n        const room = 'rid' in req.body ? req.body.rid : undefined;\n        return {\n          appId,\n          type,\n          actionId,\n          triggerId,\n          container,\n          message,\n          payload,\n          user,\n          visitor,\n          room\n        };\n      }\n      if (req.body.type === 'viewClosed') {\n        const {\n          user\n        } = req;\n        const {\n          type,\n          payload: {\n            view,\n            isCleared\n          },\n          triggerId\n        } = req.body;\n        return {\n          appId,\n          triggerId,\n          type,\n          user,\n          payload: {\n            view,\n            isCleared\n          }\n        };\n      }\n      if (req.body.type === 'viewSubmit') {\n        const {\n          user\n        } = req;\n        const {\n          type,\n          actionId,\n          triggerId,\n          payload\n        } = req.body;\n        return {\n          appId,\n          type,\n          actionId,\n          triggerId,\n          payload,\n          user\n        };\n      }\n      throw new Error('Type not supported');\n    };\n    router.post('/:id', async (req, res, next) => {\n      const {\n        id: appId\n      } = req.params;\n      const isCoreApp = await UiKitCoreApp.isRegistered(appId);\n      if (!isCoreApp) {\n        return next();\n      }\n      try {\n        const payload = getCoreAppPayload(req);\n        const result = await UiKitCoreApp[payload.type](payload);\n        // Using ?? to always send something in the response, even if the app had no result.\n        res.send(result !== null && result !== void 0 ? result : {});\n      } catch (e) {\n        const error = e instanceof Error ? e.message : e;\n        res.status(500).send({\n          error\n        });\n      }\n    });\n    class AppUIKitInteractionApi {\n      constructor(_orch) {\n        this.orch = void 0;\n        this.routeHandler = async (req, res) => {\n          const {\n            orch\n          } = this;\n          const {\n            id: appId\n          } = req.params;\n          switch (req.body.type) {\n            case 'blockAction':\n              {\n                var _orch$getConverters, _orch$getConverters2, _orch$getConverters3;\n                const {\n                  type,\n                  actionId,\n                  triggerId,\n                  payload,\n                  container\n                } = req.body;\n                const mid = 'mid' in req.body ? req.body.mid : undefined;\n                const rid = 'rid' in req.body ? req.body.rid : undefined;\n                const {\n                  visitor\n                } = req.body;\n                const room = await ((_orch$getConverters = orch.getConverters()) === null || _orch$getConverters === void 0 ? void 0 : _orch$getConverters.get('rooms').convertById(rid));\n                const user = (_orch$getConverters2 = orch.getConverters()) === null || _orch$getConverters2 === void 0 ? void 0 : _orch$getConverters2.get('users').convertToApp(req.user);\n                const message = mid && (await ((_orch$getConverters3 = orch.getConverters()) === null || _orch$getConverters3 === void 0 ? void 0 : _orch$getConverters3.get('messages').convertById(mid)));\n                const action = {\n                  type,\n                  container,\n                  appId,\n                  actionId,\n                  message,\n                  triggerId,\n                  payload,\n                  user,\n                  visitor,\n                  room\n                };\n                try {\n                  const eventInterface = !visitor ? 'IUIKitInteractionHandler' : 'IUIKitLivechatInteractionHandler';\n                  const result = await orch.triggerEvent(eventInterface, action);\n                  res.send(result);\n                } catch (e) {\n                  const error = e instanceof Error ? e.message : e;\n                  res.status(500).send({\n                    error\n                  });\n                }\n                break;\n              }\n            case 'viewClosed':\n              {\n                var _orch$getConverters4;\n                const {\n                  type,\n                  payload: {\n                    view,\n                    isCleared\n                  }\n                } = req.body;\n                const user = (_orch$getConverters4 = orch.getConverters()) === null || _orch$getConverters4 === void 0 ? void 0 : _orch$getConverters4.get('users').convertToApp(req.user);\n                const action = {\n                  type,\n                  appId,\n                  user,\n                  payload: {\n                    view,\n                    isCleared\n                  }\n                };\n                try {\n                  const result = await orch.triggerEvent('IUIKitInteractionHandler', action);\n                  res.send(result);\n                } catch (e) {\n                  const error = e instanceof Error ? e.message : e;\n                  res.status(500).send({\n                    error\n                  });\n                }\n                break;\n              }\n            case 'viewSubmit':\n              {\n                var _orch$getConverters5;\n                const {\n                  type,\n                  actionId,\n                  triggerId,\n                  payload\n                } = req.body;\n                const user = (_orch$getConverters5 = orch.getConverters()) === null || _orch$getConverters5 === void 0 ? void 0 : _orch$getConverters5.get('users').convertToApp(req.user);\n                const action = {\n                  type,\n                  appId,\n                  actionId,\n                  triggerId,\n                  payload,\n                  user\n                };\n                try {\n                  const result = await orch.triggerEvent('IUIKitInteractionHandler', action);\n                  res.send(result);\n                } catch (e) {\n                  const error = e instanceof Error ? e.message : e;\n                  res.status(500).send({\n                    error\n                  });\n                }\n                break;\n              }\n            case 'actionButton':\n              {\n                var _orch$getConverters6, _orch$getConverters7, _orch$getConverters8;\n                const {\n                  type,\n                  actionId,\n                  triggerId,\n                  rid,\n                  mid,\n                  tmid,\n                  payload: {\n                    context,\n                    message: msgText\n                  }\n                } = req.body;\n                const room = await ((_orch$getConverters6 = orch.getConverters()) === null || _orch$getConverters6 === void 0 ? void 0 : _orch$getConverters6.get('rooms').convertById(rid));\n                const user = (_orch$getConverters7 = orch.getConverters()) === null || _orch$getConverters7 === void 0 ? void 0 : _orch$getConverters7.get('users').convertToApp(req.user);\n                const message = mid && (await ((_orch$getConverters8 = orch.getConverters()) === null || _orch$getConverters8 === void 0 ? void 0 : _orch$getConverters8.get('messages').convertById(mid)));\n                const action = {\n                  type,\n                  appId,\n                  actionId,\n                  triggerId,\n                  user,\n                  room,\n                  message,\n                  tmid,\n                  payload: _objectSpread({\n                    context\n                  }, msgText ? {\n                    message: msgText\n                  } : {})\n                };\n                try {\n                  const result = await orch.triggerEvent('IUIKitInteractionHandler', action);\n                  res.send(result);\n                } catch (e) {\n                  const error = e instanceof Error ? e.message : e;\n                  res.status(500).send({\n                    error\n                  });\n                }\n                break;\n              }\n            default:\n              {\n                res.status(400).send({\n                  error: 'Unknown action'\n                });\n              }\n          }\n          // TODO: validate payloads per type\n        };\n        this.orch = _orch;\n        router.post('/:id', this.routeHandler);\n      }\n    }\n    __reify_async_result__();\n  } catch (_reifyError) {\n    return __reify_async_result__(_reifyError);\n  }\n  __reify_async_result__()\n}, {\n  self: this,\n  async: false\n});","map":{"version":3,"names":["_objectSpread","module","link","default","v","export","AppUIKitInteractionApi","UiKitCoreApp","cors","express","rateLimit","Meteor","WebApp","authenticationMiddleware","settings","Apps","__reifyWaitForDeps__","apiServer","disable","corsEnabled","allowListOrigins","watch","value","trim","split","map","origin","String","toLocaleLowerCase","connectHandlers","use","router","Router","unauthorized","res","status","send","message","startup","apiLimiter","windowMs","get","max","skip","process","env","NODE_ENV","rejectUnauthorized","req","next","visitorToken","headers","_Apps$getConverters","body","visitor","getConverters","convertByToken","user","corsOptions","callback","includes","Error","getCoreAppPayload","id","appId","params","type","actionId","triggerId","payload","container","mid","undefined","room","rid","view","isCleared","post","isCoreApp","isRegistered","result","e","error","constructor","orch","routeHandler","_orch$getConverters","_orch$getConverters2","_orch$getConverters3","convertById","convertToApp","action","eventInterface","triggerEvent","_orch$getConverters4","_orch$getConverters5","_orch$getConverters6","_orch$getConverters7","_orch$getConverters8","tmid","context","msgText","__reify_async_result__","_reifyError","self","async"],"sources":["ee/server/apps/communication/uikit.ts"],"sourcesContent":["import type { UiKitCoreAppPayload } from '@rocket.chat/core-services';\nimport { UiKitCoreApp } from '@rocket.chat/core-services';\nimport type { OperationParams, UrlParams } from '@rocket.chat/rest-typings';\nimport cors from 'cors';\nimport type { Request, Response } from 'express';\nimport express from 'express';\nimport rateLimit from 'express-rate-limit';\nimport { Meteor } from 'meteor/meteor';\nimport { WebApp } from 'meteor/webapp';\n\nimport { authenticationMiddleware } from '../../../../app/api/server/middlewares/authentication';\nimport { settings } from '../../../../app/settings/server';\nimport type { AppServerOrchestrator } from '../orchestrator';\nimport { Apps } from '../orchestrator';\n\nconst apiServer = express();\n\napiServer.disable('x-powered-by');\n\nlet corsEnabled = false;\nlet allowListOrigins: string[] = [];\n\nsettings.watch('API_Enable_CORS', (value: boolean) => {\n\tcorsEnabled = value;\n});\n\nsettings.watch('API_CORS_Origin', (value: string) => {\n\tallowListOrigins = value\n\t\t? value\n\t\t\t\t.trim()\n\t\t\t\t.split(',')\n\t\t\t\t.map((origin) => String(origin).trim().toLocaleLowerCase())\n\t\t: [];\n});\n\nWebApp.connectHandlers.use(apiServer);\n\n// eslint-disable-next-line new-cap\nconst router = express.Router();\n\nconst unauthorized = (res: Response): unknown =>\n\tres.status(401).send({\n\t\tstatus: 'error',\n\t\tmessage: 'You must be logged in to do this.',\n\t});\n\nMeteor.startup(() => {\n\t// use specific rate limit of 600 (which is 60 times the default limits) requests per minute (around 10/second)\n\tconst apiLimiter = rateLimit({\n\t\twindowMs: settings.get('API_Enable_Rate_Limiter_Limit_Time_Default'),\n\t\tmax: (settings.get('API_Enable_Rate_Limiter_Limit_Calls_Default') as number) * 60,\n\t\tskip: () =>\n\t\t\tsettings.get('API_Enable_Rate_Limiter') !== true ||\n\t\t\t(process.env.NODE_ENV === 'development' && settings.get('API_Enable_Rate_Limiter_Dev') !== true),\n\t});\n\n\trouter.use(apiLimiter);\n});\n\nrouter.use(authenticationMiddleware({ rejectUnauthorized: false }));\n\nrouter.use(async (req: Request, res, next) => {\n\tconst { 'x-visitor-token': visitorToken } = req.headers;\n\n\tif (visitorToken) {\n\t\treq.body.visitor = await Apps.getConverters()?.get('visitors').convertByToken(visitorToken);\n\t}\n\n\tif (!req.user && !req.body.visitor) {\n\t\treturn unauthorized(res);\n\t}\n\n\tnext();\n});\n\nconst corsOptions: cors.CorsOptions = {\n\torigin: (origin, callback) => {\n\t\tif (\n\t\t\t!origin ||\n\t\t\t!corsEnabled ||\n\t\t\tallowListOrigins.includes('*') ||\n\t\t\tallowListOrigins.includes(origin) ||\n\t\t\torigin === settings.get('Site_Url')\n\t\t) {\n\t\t\tcallback(null, true);\n\t\t} else {\n\t\t\tcallback(new Error('Not allowed by CORS'), false);\n\t\t}\n\t},\n};\n\napiServer.use('/api/apps/ui.interaction/', cors(corsOptions), router); // didn't have the rateLimiter option\n\ntype UiKitUserInteractionRequest = Request<\n\tUrlParams<'/apps/ui.interaction/:id'>,\n\tany,\n\tOperationParams<'POST', '/apps/ui.interaction/:id'> & {\n\t\tvisitor?: {\n\t\t\tid: string;\n\t\t\tusername: string;\n\t\t\tname?: string;\n\t\t\tdepartment?: string;\n\t\t\tupdatedAt?: Date;\n\t\t\ttoken: string;\n\t\t\tphone?: { phoneNumber: string }[] | null;\n\t\t\tvisitorEmails?: { address: string }[];\n\t\t\tlivechatData?: Record<string, unknown>;\n\t\t\tstatus?: 'online' | 'away' | 'offline' | 'busy' | 'disabled';\n\t\t};\n\t}\n>;\n\nconst getCoreAppPayload = (req: UiKitUserInteractionRequest): UiKitCoreAppPayload => {\n\tconst { id: appId } = req.params;\n\n\tif (req.body.type === 'blockAction') {\n\t\tconst { user } = req;\n\t\tconst { type, actionId, triggerId, payload, container, visitor } = req.body;\n\t\tconst message = 'mid' in req.body ? req.body.mid : undefined;\n\t\tconst room = 'rid' in req.body ? req.body.rid : undefined;\n\n\t\treturn {\n\t\t\tappId,\n\t\t\ttype,\n\t\t\tactionId,\n\t\t\ttriggerId,\n\t\t\tcontainer,\n\t\t\tmessage,\n\t\t\tpayload,\n\t\t\tuser,\n\t\t\tvisitor,\n\t\t\troom,\n\t\t};\n\t}\n\n\tif (req.body.type === 'viewClosed') {\n\t\tconst { user } = req;\n\t\tconst {\n\t\t\ttype,\n\t\t\tpayload: { view, isCleared },\n\t\t\ttriggerId,\n\t\t} = req.body;\n\n\t\treturn {\n\t\t\tappId,\n\t\t\ttriggerId,\n\t\t\ttype,\n\t\t\tuser,\n\t\t\tpayload: {\n\t\t\t\tview,\n\t\t\t\tisCleared,\n\t\t\t},\n\t\t};\n\t}\n\n\tif (req.body.type === 'viewSubmit') {\n\t\tconst { user } = req;\n\t\tconst { type, actionId, triggerId, payload } = req.body;\n\n\t\treturn {\n\t\t\tappId,\n\t\t\ttype,\n\t\t\tactionId,\n\t\t\ttriggerId,\n\t\t\tpayload,\n\t\t\tuser,\n\t\t};\n\t}\n\n\tthrow new Error('Type not supported');\n};\n\nrouter.post('/:id', async (req: UiKitUserInteractionRequest, res, next) => {\n\tconst { id: appId } = req.params;\n\n\tconst isCoreApp = await UiKitCoreApp.isRegistered(appId);\n\tif (!isCoreApp) {\n\t\treturn next();\n\t}\n\n\ttry {\n\t\tconst payload = getCoreAppPayload(req);\n\n\t\tconst result = await UiKitCoreApp[payload.type](payload);\n\n\t\t// Using ?? to always send something in the response, even if the app had no result.\n\t\tres.send(result ?? {});\n\t} catch (e) {\n\t\tconst error = e instanceof Error ? e.message : e;\n\t\tres.status(500).send({ error });\n\t}\n});\n\nexport class AppUIKitInteractionApi {\n\torch: AppServerOrchestrator;\n\n\tconstructor(orch: AppServerOrchestrator) {\n\t\tthis.orch = orch;\n\n\t\trouter.post('/:id', this.routeHandler);\n\t}\n\n\tprivate routeHandler = async (req: UiKitUserInteractionRequest, res: Response): Promise<void> => {\n\t\tconst { orch } = this;\n\t\tconst { id: appId } = req.params;\n\n\t\tswitch (req.body.type) {\n\t\t\tcase 'blockAction': {\n\t\t\t\tconst { type, actionId, triggerId, payload, container } = req.body;\n\t\t\t\tconst mid = 'mid' in req.body ? req.body.mid : undefined;\n\t\t\t\tconst rid = 'rid' in req.body ? req.body.rid : undefined;\n\n\t\t\t\tconst { visitor } = req.body;\n\t\t\t\tconst room = await orch.getConverters()?.get('rooms').convertById(rid);\n\t\t\t\tconst user = orch.getConverters()?.get('users').convertToApp(req.user);\n\t\t\t\tconst message = mid && (await orch.getConverters()?.get('messages').convertById(mid));\n\n\t\t\t\tconst action = {\n\t\t\t\t\ttype,\n\t\t\t\t\tcontainer,\n\t\t\t\t\tappId,\n\t\t\t\t\tactionId,\n\t\t\t\t\tmessage,\n\t\t\t\t\ttriggerId,\n\t\t\t\t\tpayload,\n\t\t\t\t\tuser,\n\t\t\t\t\tvisitor,\n\t\t\t\t\troom,\n\t\t\t\t};\n\n\t\t\t\ttry {\n\t\t\t\t\tconst eventInterface = !visitor ? 'IUIKitInteractionHandler' : 'IUIKitLivechatInteractionHandler';\n\n\t\t\t\t\tconst result = await orch.triggerEvent(eventInterface, action);\n\n\t\t\t\t\tres.send(result);\n\t\t\t\t} catch (e) {\n\t\t\t\t\tconst error = e instanceof Error ? e.message : e;\n\t\t\t\t\tres.status(500).send({ error });\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\tcase 'viewClosed': {\n\t\t\t\tconst {\n\t\t\t\t\ttype,\n\t\t\t\t\tpayload: { view, isCleared },\n\t\t\t\t} = req.body;\n\n\t\t\t\tconst user = orch.getConverters()?.get('users').convertToApp(req.user);\n\n\t\t\t\tconst action = {\n\t\t\t\t\ttype,\n\t\t\t\t\tappId,\n\t\t\t\t\tuser,\n\t\t\t\t\tpayload: {\n\t\t\t\t\t\tview,\n\t\t\t\t\t\tisCleared,\n\t\t\t\t\t},\n\t\t\t\t};\n\n\t\t\t\ttry {\n\t\t\t\t\tconst result = await orch.triggerEvent('IUIKitInteractionHandler', action);\n\n\t\t\t\t\tres.send(result);\n\t\t\t\t} catch (e) {\n\t\t\t\t\tconst error = e instanceof Error ? e.message : e;\n\t\t\t\t\tres.status(500).send({ error });\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\tcase 'viewSubmit': {\n\t\t\t\tconst { type, actionId, triggerId, payload } = req.body;\n\n\t\t\t\tconst user = orch.getConverters()?.get('users').convertToApp(req.user);\n\n\t\t\t\tconst action = {\n\t\t\t\t\ttype,\n\t\t\t\t\tappId,\n\t\t\t\t\tactionId,\n\t\t\t\t\ttriggerId,\n\t\t\t\t\tpayload,\n\t\t\t\t\tuser,\n\t\t\t\t};\n\n\t\t\t\ttry {\n\t\t\t\t\tconst result = await orch.triggerEvent('IUIKitInteractionHandler', action);\n\n\t\t\t\t\tres.send(result);\n\t\t\t\t} catch (e) {\n\t\t\t\t\tconst error = e instanceof Error ? e.message : e;\n\t\t\t\t\tres.status(500).send({ error });\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\tcase 'actionButton': {\n\t\t\t\tconst {\n\t\t\t\t\ttype,\n\t\t\t\t\tactionId,\n\t\t\t\t\ttriggerId,\n\t\t\t\t\trid,\n\t\t\t\t\tmid,\n\t\t\t\t\ttmid,\n\t\t\t\t\tpayload: { context, message: msgText },\n\t\t\t\t} = req.body;\n\n\t\t\t\tconst room = await orch.getConverters()?.get('rooms').convertById(rid);\n\t\t\t\tconst user = orch.getConverters()?.get('users').convertToApp(req.user);\n\t\t\t\tconst message = mid && (await orch.getConverters()?.get('messages').convertById(mid));\n\n\t\t\t\tconst action = {\n\t\t\t\t\ttype,\n\t\t\t\t\tappId,\n\t\t\t\t\tactionId,\n\t\t\t\t\ttriggerId,\n\t\t\t\t\tuser,\n\t\t\t\t\troom,\n\t\t\t\t\tmessage,\n\t\t\t\t\ttmid,\n\t\t\t\t\tpayload: {\n\t\t\t\t\t\tcontext,\n\t\t\t\t\t\t...(msgText ? { message: msgText } : {}),\n\t\t\t\t\t},\n\t\t\t\t};\n\n\t\t\t\ttry {\n\t\t\t\t\tconst result = await orch.triggerEvent('IUIKitInteractionHandler', action);\n\n\t\t\t\t\tres.send(result);\n\t\t\t\t} catch (e) {\n\t\t\t\t\tconst error = e instanceof Error ? e.message : e;\n\t\t\t\t\tres.status(500).send({ error });\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\tdefault: {\n\t\t\t\tres.status(400).send({ error: 'Unknown action' });\n\t\t\t}\n\t\t}\n\n\t\t// TODO: validate payloads per type\n\t};\n}\n"],"mappings":"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","ignoreList":[]},"sourceType":"module","externalDependencies":{},"hash":"a317849fbe62e61686af63398ecc334b49f78021"}
