{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/client/views/room/body/hooks/useUnreadMessages.ts","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","topLevelAwait","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"web.browser"},"sourceFileName":"client/views/room/body/hooks/useUnreadMessages.ts","filename":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/client/views/room/body/hooks/useUnreadMessages.ts","inputSourceMap":{"version":3,"file":"client/views/room/body/hooks/useUnreadMessages.ts","sourceRoot":"","sources":["client/views/room/body/hooks/useUnreadMessages.ts"],"names":[],"mappings":"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","sourcesContent":["import type { IRoom, ISubscription } from '@rocket.chat/core-typings';\nimport { useRouter } from '@rocket.chat/ui-contexts';\nimport type { Dispatch, SetStateAction } from 'react';\nimport { useCallback, useEffect, useMemo, useRef, useState } from 'react';\n\nimport { ChatMessage } from '../../../../../app/models/client';\nimport { LegacyRoomManager, RoomHistoryManager } from '../../../../../app/ui-utils/client';\nimport { withDebouncing, withThrottling } from '../../../../../lib/utils/highOrderFunctions';\nimport { useReactiveValue } from '../../../../hooks/useReactiveValue';\nimport { roomCoordinator } from '../../../../lib/rooms/roomCoordinator';\nimport { setMessageJumpQueryStringParameter } from '../../../../lib/utils/setMessageJumpQueryStringParameter';\nimport { useChat } from '../../contexts/ChatContext';\n\ninterface IUnreadMessages {\n\tcount: number;\n\tsince: Date;\n}\n\nconst useUnreadMessages = (room: IRoom): readonly [data: IUnreadMessages | undefined, setUnreadCount: Dispatch<SetStateAction<number>>] => {\n\tconst notLoadedCount = useReactiveValue(useCallback(() => RoomHistoryManager.getRoom(room._id).unreadNotLoaded.get(), [room._id]));\n\tconst [loadedCount, setLoadedCount] = useState(0);\n\n\tconst count = useMemo(() => notLoadedCount + loadedCount, [notLoadedCount, loadedCount]);\n\n\tconst since = useReactiveValue(useCallback(() => LegacyRoomManager.getOpenedRoomByRid(room._id)?.unreadSince.get(), [room._id]));\n\n\treturn useMemo(() => {\n\t\tif (count && since) {\n\t\t\treturn [{ count, since }, setLoadedCount];\n\t\t}\n\n\t\treturn [undefined, setLoadedCount];\n\t}, [count, since]);\n};\n\nexport const useHandleUnread = (\n\troom: IRoom,\n\tsubscription?: ISubscription,\n): {\n\tinnerRef: (wrapper: HTMLDivElement | null) => void;\n\twrapperRef: React.MutableRefObject<HTMLDivElement | null>;\n\thandleUnreadBarJumpToButtonClick: () => void;\n\thandleMarkAsReadButtonClick: () => void;\n\tcounter: readonly [number, Date | undefined];\n} => {\n\tconst messagesBoxRef = useRef<HTMLDivElement>(null);\n\n\tconst subscribed = Boolean(subscription);\n\tconst [unread, setUnreadCount] = useUnreadMessages(room);\n\n\tconst [lastMessageDate, setLastMessageDate] = useState<Date | undefined>();\n\n\tconst chat = useChat();\n\n\tif (!chat) {\n\t\tthrow new Error('No ChatContext provided');\n\t}\n\tconst handleUnreadBarJumpToButtonClick = useCallback(() => {\n\t\tconst rid = room._id;\n\t\tconst { firstUnread } = RoomHistoryManager.getRoom(rid);\n\t\tlet message = firstUnread?.get();\n\t\tif (!message) {\n\t\t\tmessage = ChatMessage.findOne({ rid, ts: { $gt: unread?.since } }, { sort: { ts: 1 }, limit: 1 });\n\t\t}\n\t\tif (!message) {\n\t\t\treturn;\n\t\t}\n\t\tsetMessageJumpQueryStringParameter(message?._id);\n\t\tsetUnreadCount(0);\n\t}, [room._id, unread?.since, setUnreadCount]);\n\n\tconst handleMarkAsReadButtonClick = useCallback(() => {\n\t\tchat.readStateManager.markAsRead();\n\t\tsetUnreadCount(0);\n\t}, [chat.readStateManager, setUnreadCount]);\n\n\tuseEffect(() => {\n\t\tif (!subscribed) {\n\t\t\tsetUnreadCount(0);\n\t\t\treturn;\n\t\t}\n\n\t\tconst count = ChatMessage.find({\n\t\t\trid: room._id,\n\t\t\tts: { $lte: lastMessageDate, $gt: subscription?.ls },\n\t\t}).count();\n\n\t\tsetUnreadCount(count);\n\t}, [lastMessageDate, room._id, setUnreadCount, subscribed, subscription?.ls]);\n\n\tconst router = useRouter();\n\n\tconst debouncedReadMessageRead = useMemo(\n\t\t() =>\n\t\t\twithDebouncing({ wait: 500 })(() => {\n\t\t\t\tif (subscribed) {\n\t\t\t\t\tchat.readStateManager.attemptMarkAsRead();\n\t\t\t\t}\n\t\t\t}),\n\t\t[chat.readStateManager, subscribed],\n\t);\n\n\tuseEffect(\n\t\t() =>\n\t\t\trouter.subscribeToRouteChange(() => {\n\t\t\t\tconst routeName = router.getRouteName();\n\t\t\t\tif (!routeName || !roomCoordinator.isRouteNameKnown(routeName)) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tdebouncedReadMessageRead();\n\t\t\t}),\n\t\t[debouncedReadMessageRead, room._id, router, subscribed, subscription?.alert, subscription?.unread],\n\t);\n\n\tuseEffect(() => {\n\t\tif (!unread?.count) {\n\t\t\treturn debouncedReadMessageRead();\n\t\t}\n\t}, [debouncedReadMessageRead, room._id, unread?.count]);\n\n\tconst ref = useCallback(\n\t\t(wrapper: HTMLDivElement | null) => {\n\t\t\tif (!wrapper) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconst getElementFromPoint = (topOffset = 0): Element | undefined => {\n\t\t\t\tconst messagesBox = messagesBoxRef.current;\n\n\t\t\t\tif (!messagesBox) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tconst messagesBoxLeft = messagesBox.getBoundingClientRect().left + window.pageXOffset;\n\t\t\t\tconst messagesBoxTop = messagesBox.getBoundingClientRect().top + window.pageYOffset;\n\t\t\t\tconst messagesBoxWidth = parseFloat(getComputedStyle(messagesBox).width);\n\n\t\t\t\tlet element;\n\t\t\t\tif (document.dir === 'rtl') {\n\t\t\t\t\telement = document.elementFromPoint(messagesBoxLeft + messagesBoxWidth - 2, messagesBoxTop + topOffset + 2);\n\t\t\t\t} else {\n\t\t\t\t\telement = document.elementFromPoint(messagesBoxLeft + 2, messagesBoxTop + topOffset + 2);\n\t\t\t\t}\n\n\t\t\t\tif (element?.classList.contains('rcx-message') || element?.classList.contains('rcx-message--sequential')) {\n\t\t\t\t\treturn element;\n\t\t\t\t}\n\t\t\t};\n\t\t\twrapper.addEventListener(\n\t\t\t\t'scroll',\n\t\t\t\twithThrottling({ wait: 300 })(() => {\n\t\t\t\t\tTracker.afterFlush(() => {\n\t\t\t\t\t\tconst lastInvisibleMessageOnScreen = getElementFromPoint(0) || getElementFromPoint(20) || getElementFromPoint(40);\n\n\t\t\t\t\t\tif (!lastInvisibleMessageOnScreen) {\n\t\t\t\t\t\t\tsetUnreadCount(0);\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tconst lastMessage = ChatMessage.findOne(lastInvisibleMessageOnScreen.id);\n\t\t\t\t\t\tif (!lastMessage) {\n\t\t\t\t\t\t\tsetUnreadCount(0);\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tsetLastMessageDate(lastMessage.ts);\n\t\t\t\t\t});\n\t\t\t\t}),\n\t\t\t);\n\t\t},\n\t\t[setUnreadCount],\n\t);\n\n\treturn {\n\t\tinnerRef: ref,\n\t\twrapperRef: messagesBoxRef,\n\t\thandleUnreadBarJumpToButtonClick,\n\t\thandleMarkAsReadButtonClick,\n\t\tcounter: [unread?.count ?? 0, unread?.since] as const,\n\t};\n};\n"]},"targets":{"android":"125.0.0","chrome":"125.0.0","edge":"125.0.0","firefox":"115.0.0","ie":"10.0.0","ios":"17.4.0","opera":"110.0.0","opera_mobile":"80.0.0","safari":"17.4.0","samsung":"24.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor","root":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":false,"enforceStrictMode":false,"dynamicImport":true,"generateLetDeclarations":true},"externalDependencies":[]},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"version":"7.17.2","helpers":true,"useESModules":false,"corejs":false},"externalDependencies":[]},{"key":"proposal-class-properties","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true},"externalDependencies":[]},{"key":"transform-react-jsx","visitor":{"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXFragment":{"exit":[null]},"JSXElement":{"exit":[null]},"JSXAttribute":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false},"externalDependencies":[]},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-nullish-coalescing-operator","visitor":{"LogicalExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-optional-chaining","visitor":{"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-optional-catch-binding","visitor":{"CatchClause":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-class-properties","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-async-generator-functions","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-logical-assignment-operators","visitor":{"AssignmentExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]}],"presets":[],"generatorOpts":{"filename":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/client/views/room/body/hooks/useUnreadMessages.ts","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"client/views/room/body/hooks/useUnreadMessages.ts","inputSourceMap":{"version":3,"file":"client/views/room/body/hooks/useUnreadMessages.ts","sourceRoot":"","sources":["client/views/room/body/hooks/useUnreadMessages.ts"],"names":[],"mappings":"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","sourcesContent":["import type { IRoom, ISubscription } from '@rocket.chat/core-typings';\nimport { useRouter } from '@rocket.chat/ui-contexts';\nimport type { Dispatch, SetStateAction } from 'react';\nimport { useCallback, useEffect, useMemo, useRef, useState } from 'react';\n\nimport { ChatMessage } from '../../../../../app/models/client';\nimport { LegacyRoomManager, RoomHistoryManager } from '../../../../../app/ui-utils/client';\nimport { withDebouncing, withThrottling } from '../../../../../lib/utils/highOrderFunctions';\nimport { useReactiveValue } from '../../../../hooks/useReactiveValue';\nimport { roomCoordinator } from '../../../../lib/rooms/roomCoordinator';\nimport { setMessageJumpQueryStringParameter } from '../../../../lib/utils/setMessageJumpQueryStringParameter';\nimport { useChat } from '../../contexts/ChatContext';\n\ninterface IUnreadMessages {\n\tcount: number;\n\tsince: Date;\n}\n\nconst useUnreadMessages = (room: IRoom): readonly [data: IUnreadMessages | undefined, setUnreadCount: Dispatch<SetStateAction<number>>] => {\n\tconst notLoadedCount = useReactiveValue(useCallback(() => RoomHistoryManager.getRoom(room._id).unreadNotLoaded.get(), [room._id]));\n\tconst [loadedCount, setLoadedCount] = useState(0);\n\n\tconst count = useMemo(() => notLoadedCount + loadedCount, [notLoadedCount, loadedCount]);\n\n\tconst since = useReactiveValue(useCallback(() => LegacyRoomManager.getOpenedRoomByRid(room._id)?.unreadSince.get(), [room._id]));\n\n\treturn useMemo(() => {\n\t\tif (count && since) {\n\t\t\treturn [{ count, since }, setLoadedCount];\n\t\t}\n\n\t\treturn [undefined, setLoadedCount];\n\t}, [count, since]);\n};\n\nexport const useHandleUnread = (\n\troom: IRoom,\n\tsubscription?: ISubscription,\n): {\n\tinnerRef: (wrapper: HTMLDivElement | null) => void;\n\twrapperRef: React.MutableRefObject<HTMLDivElement | null>;\n\thandleUnreadBarJumpToButtonClick: () => void;\n\thandleMarkAsReadButtonClick: () => void;\n\tcounter: readonly [number, Date | undefined];\n} => {\n\tconst messagesBoxRef = useRef<HTMLDivElement>(null);\n\n\tconst subscribed = Boolean(subscription);\n\tconst [unread, setUnreadCount] = useUnreadMessages(room);\n\n\tconst [lastMessageDate, setLastMessageDate] = useState<Date | undefined>();\n\n\tconst chat = useChat();\n\n\tif (!chat) {\n\t\tthrow new Error('No ChatContext provided');\n\t}\n\tconst handleUnreadBarJumpToButtonClick = useCallback(() => {\n\t\tconst rid = room._id;\n\t\tconst { firstUnread } = RoomHistoryManager.getRoom(rid);\n\t\tlet message = firstUnread?.get();\n\t\tif (!message) {\n\t\t\tmessage = ChatMessage.findOne({ rid, ts: { $gt: unread?.since } }, { sort: { ts: 1 }, limit: 1 });\n\t\t}\n\t\tif (!message) {\n\t\t\treturn;\n\t\t}\n\t\tsetMessageJumpQueryStringParameter(message?._id);\n\t\tsetUnreadCount(0);\n\t}, [room._id, unread?.since, setUnreadCount]);\n\n\tconst handleMarkAsReadButtonClick = useCallback(() => {\n\t\tchat.readStateManager.markAsRead();\n\t\tsetUnreadCount(0);\n\t}, [chat.readStateManager, setUnreadCount]);\n\n\tuseEffect(() => {\n\t\tif (!subscribed) {\n\t\t\tsetUnreadCount(0);\n\t\t\treturn;\n\t\t}\n\n\t\tconst count = ChatMessage.find({\n\t\t\trid: room._id,\n\t\t\tts: { $lte: lastMessageDate, $gt: subscription?.ls },\n\t\t}).count();\n\n\t\tsetUnreadCount(count);\n\t}, [lastMessageDate, room._id, setUnreadCount, subscribed, subscription?.ls]);\n\n\tconst router = useRouter();\n\n\tconst debouncedReadMessageRead = useMemo(\n\t\t() =>\n\t\t\twithDebouncing({ wait: 500 })(() => {\n\t\t\t\tif (subscribed) {\n\t\t\t\t\tchat.readStateManager.attemptMarkAsRead();\n\t\t\t\t}\n\t\t\t}),\n\t\t[chat.readStateManager, subscribed],\n\t);\n\n\tuseEffect(\n\t\t() =>\n\t\t\trouter.subscribeToRouteChange(() => {\n\t\t\t\tconst routeName = router.getRouteName();\n\t\t\t\tif (!routeName || !roomCoordinator.isRouteNameKnown(routeName)) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tdebouncedReadMessageRead();\n\t\t\t}),\n\t\t[debouncedReadMessageRead, room._id, router, subscribed, subscription?.alert, subscription?.unread],\n\t);\n\n\tuseEffect(() => {\n\t\tif (!unread?.count) {\n\t\t\treturn debouncedReadMessageRead();\n\t\t}\n\t}, [debouncedReadMessageRead, room._id, unread?.count]);\n\n\tconst ref = useCallback(\n\t\t(wrapper: HTMLDivElement | null) => {\n\t\t\tif (!wrapper) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconst getElementFromPoint = (topOffset = 0): Element | undefined => {\n\t\t\t\tconst messagesBox = messagesBoxRef.current;\n\n\t\t\t\tif (!messagesBox) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tconst messagesBoxLeft = messagesBox.getBoundingClientRect().left + window.pageXOffset;\n\t\t\t\tconst messagesBoxTop = messagesBox.getBoundingClientRect().top + window.pageYOffset;\n\t\t\t\tconst messagesBoxWidth = parseFloat(getComputedStyle(messagesBox).width);\n\n\t\t\t\tlet element;\n\t\t\t\tif (document.dir === 'rtl') {\n\t\t\t\t\telement = document.elementFromPoint(messagesBoxLeft + messagesBoxWidth - 2, messagesBoxTop + topOffset + 2);\n\t\t\t\t} else {\n\t\t\t\t\telement = document.elementFromPoint(messagesBoxLeft + 2, messagesBoxTop + topOffset + 2);\n\t\t\t\t}\n\n\t\t\t\tif (element?.classList.contains('rcx-message') || element?.classList.contains('rcx-message--sequential')) {\n\t\t\t\t\treturn element;\n\t\t\t\t}\n\t\t\t};\n\t\t\twrapper.addEventListener(\n\t\t\t\t'scroll',\n\t\t\t\twithThrottling({ wait: 300 })(() => {\n\t\t\t\t\tTracker.afterFlush(() => {\n\t\t\t\t\t\tconst lastInvisibleMessageOnScreen = getElementFromPoint(0) || getElementFromPoint(20) || getElementFromPoint(40);\n\n\t\t\t\t\t\tif (!lastInvisibleMessageOnScreen) {\n\t\t\t\t\t\t\tsetUnreadCount(0);\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tconst lastMessage = ChatMessage.findOne(lastInvisibleMessageOnScreen.id);\n\t\t\t\t\t\tif (!lastMessage) {\n\t\t\t\t\t\t\tsetUnreadCount(0);\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tsetLastMessageDate(lastMessage.ts);\n\t\t\t\t\t});\n\t\t\t\t}),\n\t\t\t);\n\t\t},\n\t\t[setUnreadCount],\n\t);\n\n\treturn {\n\t\tinnerRef: ref,\n\t\twrapperRef: messagesBoxRef,\n\t\thandleUnreadBarJumpToButtonClick,\n\t\thandleMarkAsReadButtonClick,\n\t\tcounter: [unread?.count ?? 0, unread?.since] as const,\n\t};\n};\n"]}}},"code":"module.export({\n  useHandleUnread: () => useHandleUnread\n});\nlet useRouter;\nmodule.link(\"@rocket.chat/ui-contexts\", {\n  useRouter(v) {\n    useRouter = v;\n  }\n}, 0);\nlet useCallback, useEffect, useMemo, useRef, useState;\nmodule.link(\"react\", {\n  useCallback(v) {\n    useCallback = v;\n  },\n  useEffect(v) {\n    useEffect = v;\n  },\n  useMemo(v) {\n    useMemo = v;\n  },\n  useRef(v) {\n    useRef = v;\n  },\n  useState(v) {\n    useState = v;\n  }\n}, 1);\nlet ChatMessage;\nmodule.link(\"../../../../../app/models/client\", {\n  ChatMessage(v) {\n    ChatMessage = v;\n  }\n}, 2);\nlet LegacyRoomManager, RoomHistoryManager;\nmodule.link(\"../../../../../app/ui-utils/client\", {\n  LegacyRoomManager(v) {\n    LegacyRoomManager = v;\n  },\n  RoomHistoryManager(v) {\n    RoomHistoryManager = v;\n  }\n}, 3);\nlet withDebouncing, withThrottling;\nmodule.link(\"../../../../../lib/utils/highOrderFunctions\", {\n  withDebouncing(v) {\n    withDebouncing = v;\n  },\n  withThrottling(v) {\n    withThrottling = v;\n  }\n}, 4);\nlet useReactiveValue;\nmodule.link(\"../../../../hooks/useReactiveValue\", {\n  useReactiveValue(v) {\n    useReactiveValue = v;\n  }\n}, 5);\nlet roomCoordinator;\nmodule.link(\"../../../../lib/rooms/roomCoordinator\", {\n  roomCoordinator(v) {\n    roomCoordinator = v;\n  }\n}, 6);\nlet setMessageJumpQueryStringParameter;\nmodule.link(\"../../../../lib/utils/setMessageJumpQueryStringParameter\", {\n  setMessageJumpQueryStringParameter(v) {\n    setMessageJumpQueryStringParameter = v;\n  }\n}, 7);\nlet useChat;\nmodule.link(\"../../contexts/ChatContext\", {\n  useChat(v) {\n    useChat = v;\n  }\n}, 8);\nconst useUnreadMessages = room => {\n  const notLoadedCount = useReactiveValue(useCallback(() => RoomHistoryManager.getRoom(room._id).unreadNotLoaded.get(), [room._id]));\n  const [loadedCount, setLoadedCount] = useState(0);\n  const count = useMemo(() => notLoadedCount + loadedCount, [notLoadedCount, loadedCount]);\n  const since = useReactiveValue(useCallback(() => {\n    var _LegacyRoomManager$ge;\n    return (_LegacyRoomManager$ge = LegacyRoomManager.getOpenedRoomByRid(room._id)) === null || _LegacyRoomManager$ge === void 0 ? void 0 : _LegacyRoomManager$ge.unreadSince.get();\n  }, [room._id]));\n  return useMemo(() => {\n    if (count && since) {\n      return [{\n        count,\n        since\n      }, setLoadedCount];\n    }\n    return [undefined, setLoadedCount];\n  }, [count, since]);\n};\nconst useHandleUnread = (room, subscription) => {\n  var _unread$count;\n  const messagesBoxRef = useRef(null);\n  const subscribed = Boolean(subscription);\n  const [unread, setUnreadCount] = useUnreadMessages(room);\n  const [lastMessageDate, setLastMessageDate] = useState();\n  const chat = useChat();\n  if (!chat) {\n    throw new Error('No ChatContext provided');\n  }\n  const handleUnreadBarJumpToButtonClick = useCallback(() => {\n    var _message;\n    const rid = room._id;\n    const {\n      firstUnread\n    } = RoomHistoryManager.getRoom(rid);\n    let message = firstUnread === null || firstUnread === void 0 ? void 0 : firstUnread.get();\n    if (!message) {\n      message = ChatMessage.findOne({\n        rid,\n        ts: {\n          $gt: unread === null || unread === void 0 ? void 0 : unread.since\n        }\n      }, {\n        sort: {\n          ts: 1\n        },\n        limit: 1\n      });\n    }\n    if (!message) {\n      return;\n    }\n    setMessageJumpQueryStringParameter((_message = message) === null || _message === void 0 ? void 0 : _message._id);\n    setUnreadCount(0);\n  }, [room._id, unread === null || unread === void 0 ? void 0 : unread.since, setUnreadCount]);\n  const handleMarkAsReadButtonClick = useCallback(() => {\n    chat.readStateManager.markAsRead();\n    setUnreadCount(0);\n  }, [chat.readStateManager, setUnreadCount]);\n  useEffect(() => {\n    if (!subscribed) {\n      setUnreadCount(0);\n      return;\n    }\n    const count = ChatMessage.find({\n      rid: room._id,\n      ts: {\n        $lte: lastMessageDate,\n        $gt: subscription === null || subscription === void 0 ? void 0 : subscription.ls\n      }\n    }).count();\n    setUnreadCount(count);\n  }, [lastMessageDate, room._id, setUnreadCount, subscribed, subscription === null || subscription === void 0 ? void 0 : subscription.ls]);\n  const router = useRouter();\n  const debouncedReadMessageRead = useMemo(() => withDebouncing({\n    wait: 500\n  })(() => {\n    if (subscribed) {\n      chat.readStateManager.attemptMarkAsRead();\n    }\n  }), [chat.readStateManager, subscribed]);\n  useEffect(() => router.subscribeToRouteChange(() => {\n    const routeName = router.getRouteName();\n    if (!routeName || !roomCoordinator.isRouteNameKnown(routeName)) {\n      return;\n    }\n    debouncedReadMessageRead();\n  }), [debouncedReadMessageRead, room._id, router, subscribed, subscription === null || subscription === void 0 ? void 0 : subscription.alert, subscription === null || subscription === void 0 ? void 0 : subscription.unread]);\n  useEffect(() => {\n    if (!(unread !== null && unread !== void 0 && unread.count)) {\n      return debouncedReadMessageRead();\n    }\n  }, [debouncedReadMessageRead, room._id, unread === null || unread === void 0 ? void 0 : unread.count]);\n  const ref = useCallback(wrapper => {\n    if (!wrapper) {\n      return;\n    }\n    const getElementFromPoint = function () {\n      var _element, _element2;\n      let topOffset = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : 0;\n      const messagesBox = messagesBoxRef.current;\n      if (!messagesBox) {\n        return;\n      }\n      const messagesBoxLeft = messagesBox.getBoundingClientRect().left + window.pageXOffset;\n      const messagesBoxTop = messagesBox.getBoundingClientRect().top + window.pageYOffset;\n      const messagesBoxWidth = parseFloat(getComputedStyle(messagesBox).width);\n      let element;\n      if (document.dir === 'rtl') {\n        element = document.elementFromPoint(messagesBoxLeft + messagesBoxWidth - 2, messagesBoxTop + topOffset + 2);\n      } else {\n        element = document.elementFromPoint(messagesBoxLeft + 2, messagesBoxTop + topOffset + 2);\n      }\n      if ((_element = element) !== null && _element !== void 0 && _element.classList.contains('rcx-message') || (_element2 = element) !== null && _element2 !== void 0 && _element2.classList.contains('rcx-message--sequential')) {\n        return element;\n      }\n    };\n    wrapper.addEventListener('scroll', withThrottling({\n      wait: 300\n    })(() => {\n      Tracker.afterFlush(() => {\n        const lastInvisibleMessageOnScreen = getElementFromPoint(0) || getElementFromPoint(20) || getElementFromPoint(40);\n        if (!lastInvisibleMessageOnScreen) {\n          setUnreadCount(0);\n          return;\n        }\n        const lastMessage = ChatMessage.findOne(lastInvisibleMessageOnScreen.id);\n        if (!lastMessage) {\n          setUnreadCount(0);\n          return;\n        }\n        setLastMessageDate(lastMessage.ts);\n      });\n    }));\n  }, [setUnreadCount]);\n  return {\n    innerRef: ref,\n    wrapperRef: messagesBoxRef,\n    handleUnreadBarJumpToButtonClick,\n    handleMarkAsReadButtonClick,\n    counter: [(_unread$count = unread === null || unread === void 0 ? void 0 : unread.count) !== null && _unread$count !== void 0 ? _unread$count : 0, unread === null || unread === void 0 ? void 0 : unread.since]\n  };\n};","map":{"version":3,"names":["module","export","useHandleUnread","useRouter","link","v","useCallback","useEffect","useMemo","useRef","useState","ChatMessage","LegacyRoomManager","RoomHistoryManager","withDebouncing","withThrottling","useReactiveValue","roomCoordinator","setMessageJumpQueryStringParameter","useChat","useUnreadMessages","room","notLoadedCount","getRoom","_id","unreadNotLoaded","get","loadedCount","setLoadedCount","count","since","_LegacyRoomManager$ge","getOpenedRoomByRid","unreadSince","undefined","subscription","_unread$count","messagesBoxRef","subscribed","Boolean","unread","setUnreadCount","lastMessageDate","setLastMessageDate","chat","Error","handleUnreadBarJumpToButtonClick","_message","rid","firstUnread","message","findOne","ts","$gt","sort","limit","handleMarkAsReadButtonClick","readStateManager","markAsRead","find","$lte","ls","router","debouncedReadMessageRead","wait","attemptMarkAsRead","subscribeToRouteChange","routeName","getRouteName","isRouteNameKnown","alert","ref","wrapper","getElementFromPoint","_element","_element2","topOffset","arguments","length","messagesBox","current","messagesBoxLeft","getBoundingClientRect","left","window","pageXOffset","messagesBoxTop","top","pageYOffset","messagesBoxWidth","parseFloat","getComputedStyle","width","element","document","dir","elementFromPoint","classList","contains","addEventListener","Tracker","afterFlush","lastInvisibleMessageOnScreen","lastMessage","id","innerRef","wrapperRef","counter"],"sources":["client/views/room/body/hooks/useUnreadMessages.ts"],"sourcesContent":["import type { IRoom, ISubscription } from '@rocket.chat/core-typings';\nimport { useRouter } from '@rocket.chat/ui-contexts';\nimport type { Dispatch, SetStateAction } from 'react';\nimport { useCallback, useEffect, useMemo, useRef, useState } from 'react';\n\nimport { ChatMessage } from '../../../../../app/models/client';\nimport { LegacyRoomManager, RoomHistoryManager } from '../../../../../app/ui-utils/client';\nimport { withDebouncing, withThrottling } from '../../../../../lib/utils/highOrderFunctions';\nimport { useReactiveValue } from '../../../../hooks/useReactiveValue';\nimport { roomCoordinator } from '../../../../lib/rooms/roomCoordinator';\nimport { setMessageJumpQueryStringParameter } from '../../../../lib/utils/setMessageJumpQueryStringParameter';\nimport { useChat } from '../../contexts/ChatContext';\n\ninterface IUnreadMessages {\n\tcount: number;\n\tsince: Date;\n}\n\nconst useUnreadMessages = (room: IRoom): readonly [data: IUnreadMessages | undefined, setUnreadCount: Dispatch<SetStateAction<number>>] => {\n\tconst notLoadedCount = useReactiveValue(useCallback(() => RoomHistoryManager.getRoom(room._id).unreadNotLoaded.get(), [room._id]));\n\tconst [loadedCount, setLoadedCount] = useState(0);\n\n\tconst count = useMemo(() => notLoadedCount + loadedCount, [notLoadedCount, loadedCount]);\n\n\tconst since = useReactiveValue(useCallback(() => LegacyRoomManager.getOpenedRoomByRid(room._id)?.unreadSince.get(), [room._id]));\n\n\treturn useMemo(() => {\n\t\tif (count && since) {\n\t\t\treturn [{ count, since }, setLoadedCount];\n\t\t}\n\n\t\treturn [undefined, setLoadedCount];\n\t}, [count, since]);\n};\n\nexport const useHandleUnread = (\n\troom: IRoom,\n\tsubscription?: ISubscription,\n): {\n\tinnerRef: (wrapper: HTMLDivElement | null) => void;\n\twrapperRef: React.MutableRefObject<HTMLDivElement | null>;\n\thandleUnreadBarJumpToButtonClick: () => void;\n\thandleMarkAsReadButtonClick: () => void;\n\tcounter: readonly [number, Date | undefined];\n} => {\n\tconst messagesBoxRef = useRef<HTMLDivElement>(null);\n\n\tconst subscribed = Boolean(subscription);\n\tconst [unread, setUnreadCount] = useUnreadMessages(room);\n\n\tconst [lastMessageDate, setLastMessageDate] = useState<Date | undefined>();\n\n\tconst chat = useChat();\n\n\tif (!chat) {\n\t\tthrow new Error('No ChatContext provided');\n\t}\n\tconst handleUnreadBarJumpToButtonClick = useCallback(() => {\n\t\tconst rid = room._id;\n\t\tconst { firstUnread } = RoomHistoryManager.getRoom(rid);\n\t\tlet message = firstUnread?.get();\n\t\tif (!message) {\n\t\t\tmessage = ChatMessage.findOne({ rid, ts: { $gt: unread?.since } }, { sort: { ts: 1 }, limit: 1 });\n\t\t}\n\t\tif (!message) {\n\t\t\treturn;\n\t\t}\n\t\tsetMessageJumpQueryStringParameter(message?._id);\n\t\tsetUnreadCount(0);\n\t}, [room._id, unread?.since, setUnreadCount]);\n\n\tconst handleMarkAsReadButtonClick = useCallback(() => {\n\t\tchat.readStateManager.markAsRead();\n\t\tsetUnreadCount(0);\n\t}, [chat.readStateManager, setUnreadCount]);\n\n\tuseEffect(() => {\n\t\tif (!subscribed) {\n\t\t\tsetUnreadCount(0);\n\t\t\treturn;\n\t\t}\n\n\t\tconst count = ChatMessage.find({\n\t\t\trid: room._id,\n\t\t\tts: { $lte: lastMessageDate, $gt: subscription?.ls },\n\t\t}).count();\n\n\t\tsetUnreadCount(count);\n\t}, [lastMessageDate, room._id, setUnreadCount, subscribed, subscription?.ls]);\n\n\tconst router = useRouter();\n\n\tconst debouncedReadMessageRead = useMemo(\n\t\t() =>\n\t\t\twithDebouncing({ wait: 500 })(() => {\n\t\t\t\tif (subscribed) {\n\t\t\t\t\tchat.readStateManager.attemptMarkAsRead();\n\t\t\t\t}\n\t\t\t}),\n\t\t[chat.readStateManager, subscribed],\n\t);\n\n\tuseEffect(\n\t\t() =>\n\t\t\trouter.subscribeToRouteChange(() => {\n\t\t\t\tconst routeName = router.getRouteName();\n\t\t\t\tif (!routeName || !roomCoordinator.isRouteNameKnown(routeName)) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tdebouncedReadMessageRead();\n\t\t\t}),\n\t\t[debouncedReadMessageRead, room._id, router, subscribed, subscription?.alert, subscription?.unread],\n\t);\n\n\tuseEffect(() => {\n\t\tif (!unread?.count) {\n\t\t\treturn debouncedReadMessageRead();\n\t\t}\n\t}, [debouncedReadMessageRead, room._id, unread?.count]);\n\n\tconst ref = useCallback(\n\t\t(wrapper: HTMLDivElement | null) => {\n\t\t\tif (!wrapper) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconst getElementFromPoint = (topOffset = 0): Element | undefined => {\n\t\t\t\tconst messagesBox = messagesBoxRef.current;\n\n\t\t\t\tif (!messagesBox) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tconst messagesBoxLeft = messagesBox.getBoundingClientRect().left + window.pageXOffset;\n\t\t\t\tconst messagesBoxTop = messagesBox.getBoundingClientRect().top + window.pageYOffset;\n\t\t\t\tconst messagesBoxWidth = parseFloat(getComputedStyle(messagesBox).width);\n\n\t\t\t\tlet element;\n\t\t\t\tif (document.dir === 'rtl') {\n\t\t\t\t\telement = document.elementFromPoint(messagesBoxLeft + messagesBoxWidth - 2, messagesBoxTop + topOffset + 2);\n\t\t\t\t} else {\n\t\t\t\t\telement = document.elementFromPoint(messagesBoxLeft + 2, messagesBoxTop + topOffset + 2);\n\t\t\t\t}\n\n\t\t\t\tif (element?.classList.contains('rcx-message') || element?.classList.contains('rcx-message--sequential')) {\n\t\t\t\t\treturn element;\n\t\t\t\t}\n\t\t\t};\n\t\t\twrapper.addEventListener(\n\t\t\t\t'scroll',\n\t\t\t\twithThrottling({ wait: 300 })(() => {\n\t\t\t\t\tTracker.afterFlush(() => {\n\t\t\t\t\t\tconst lastInvisibleMessageOnScreen = getElementFromPoint(0) || getElementFromPoint(20) || getElementFromPoint(40);\n\n\t\t\t\t\t\tif (!lastInvisibleMessageOnScreen) {\n\t\t\t\t\t\t\tsetUnreadCount(0);\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tconst lastMessage = ChatMessage.findOne(lastInvisibleMessageOnScreen.id);\n\t\t\t\t\t\tif (!lastMessage) {\n\t\t\t\t\t\t\tsetUnreadCount(0);\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tsetLastMessageDate(lastMessage.ts);\n\t\t\t\t\t});\n\t\t\t\t}),\n\t\t\t);\n\t\t},\n\t\t[setUnreadCount],\n\t);\n\n\treturn {\n\t\tinnerRef: ref,\n\t\twrapperRef: messagesBoxRef,\n\t\thandleUnreadBarJumpToButtonClick,\n\t\thandleMarkAsReadButtonClick,\n\t\tcounter: [unread?.count ?? 0, unread?.since] as const,\n\t};\n};\n"],"mappings":"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","ignoreList":[]},"sourceType":"module","externalDependencies":{},"hash":"e86142e3f4fb329cba5761f749b59d753583ca88"}
