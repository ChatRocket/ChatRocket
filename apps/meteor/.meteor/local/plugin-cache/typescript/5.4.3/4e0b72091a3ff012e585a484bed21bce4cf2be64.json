{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/server/models/raw/Banners.ts","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","topLevelAwait","objectRestSpread","objectRestSpread","asyncGenerators","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"os.osx.arm64"},"sourceFileName":"server/models/raw/Banners.ts","filename":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/server/models/raw/Banners.ts","inputSourceMap":{"version":3,"file":"server/models/raw/Banners.ts","sourceRoot":"","sources":["server/models/raw/Banners.ts"],"names":[],"mappings":"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","sourcesContent":["import type { IBanner, RocketChatRecordDeleted } from '@rocket.chat/core-typings';\nimport { BannerPlatform } from '@rocket.chat/core-typings';\nimport type { IBannersModel } from '@rocket.chat/model-typings';\nimport type { Collection, FindCursor, Db, FindOptions, IndexDescription, InsertOneResult, UpdateResult } from 'mongodb';\n\nimport { BaseRaw } from './BaseRaw';\n\nexport class BannersRaw extends BaseRaw<IBanner> implements IBannersModel {\n\tconstructor(db: Db, trash?: Collection<RocketChatRecordDeleted<IBanner>>) {\n\t\tsuper(db, 'banner', trash);\n\t}\n\n\tprotected modelIndexes(): IndexDescription[] {\n\t\treturn [{ key: { platform: 1, startAt: 1, expireAt: 1 } }, { key: { platform: 1, startAt: 1, expireAt: 1, active: 1 } }];\n\t}\n\n\tcreate(doc: IBanner): Promise<InsertOneResult<IBanner>> {\n\t\tconst invalidPlatform = doc.platform?.some((platform) => !Object.values(BannerPlatform).includes(platform));\n\t\tif (invalidPlatform) {\n\t\t\tthrow new Error('Invalid platform');\n\t\t}\n\n\t\tif (doc.startAt > doc.expireAt) {\n\t\t\tthrow new Error('Start date cannot be later than expire date');\n\t\t}\n\n\t\tif (doc.expireAt < new Date()) {\n\t\t\tthrow new Error('Cannot create banner already expired');\n\t\t}\n\n\t\treturn this.insertOne({\n\t\t\tactive: true,\n\t\t\t...doc,\n\t\t});\n\t}\n\n\tfindActiveByRoleOrId(roles: string[], platform: BannerPlatform, bannerId?: string, options?: FindOptions<IBanner>): FindCursor<IBanner> {\n\t\tconst today = new Date();\n\n\t\tconst query = {\n\t\t\t...(bannerId && { _id: bannerId }),\n\t\t\tplatform,\n\t\t\tstartAt: { $lte: today },\n\t\t\texpireAt: { $gte: today },\n\t\t\tactive: { $ne: false },\n\t\t\t$or: [{ roles: { $in: roles } }, { roles: { $exists: false } }],\n\t\t};\n\n\t\treturn this.find(query, options);\n\t}\n\n\tdisable(bannerId: string): Promise<UpdateResult> {\n\t\treturn this.updateOne({ _id: bannerId, active: { $ne: false } }, { $set: { active: false, inactivedAt: new Date() } });\n\t}\n\n\tcreateOrUpdate(banner: IBanner): Promise<UpdateResult> {\n\t\tconst invalidPlatform = banner.platform?.some((platform) => !Object.values(BannerPlatform).includes(platform));\n\t\tif (invalidPlatform) {\n\t\t\tthrow new Error('Invalid platform');\n\t\t}\n\n\t\tif (banner.startAt > banner.expireAt) {\n\t\t\tthrow new Error('Start date cannot be later than expire date');\n\t\t}\n\n\t\tif (banner.expireAt < new Date()) {\n\t\t\tthrow new Error('Cannot create banner already expired');\n\t\t}\n\n\t\tconst { _id: bannerId, ...doc } = banner;\n\n\t\treturn this.updateOne({ _id: bannerId }, { $set: { active: true, ...doc } }, { upsert: true });\n\t}\n}\n"]},"targets":{"android":"125.0.0","chrome":"125.0.0","edge":"125.0.0","firefox":"115.0.0","ie":"10.0.0","ios":"17.4.0","opera":"110.0.0","opera_mobile":"80.0.0","safari":"17.4.0","samsung":"24.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor","root":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":false,"enforceStrictMode":false,"dynamicImport":true,"generateLetDeclarations":true,"topLevelAwait":true},"externalDependencies":[]},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"version":"7.17.2","helpers":true,"useESModules":false,"corejs":false},"externalDependencies":[]},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-async-generator-functions","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-class-properties","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true},"externalDependencies":[]},{"key":"transform-react-jsx","visitor":{"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXFragment":{"exit":[null]},"JSXElement":{"exit":[null]},"JSXAttribute":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false},"externalDependencies":[]},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-nullish-coalescing-operator","visitor":{"LogicalExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-optional-chaining","visitor":{"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-optional-catch-binding","visitor":{"CatchClause":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-class-properties","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-async-generator-functions","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-logical-assignment-operators","visitor":{"AssignmentExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]}],"presets":[],"generatorOpts":{"filename":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/server/models/raw/Banners.ts","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"server/models/raw/Banners.ts","inputSourceMap":{"version":3,"file":"server/models/raw/Banners.ts","sourceRoot":"","sources":["server/models/raw/Banners.ts"],"names":[],"mappings":"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","sourcesContent":["import type { IBanner, RocketChatRecordDeleted } from '@rocket.chat/core-typings';\nimport { BannerPlatform } from '@rocket.chat/core-typings';\nimport type { IBannersModel } from '@rocket.chat/model-typings';\nimport type { Collection, FindCursor, Db, FindOptions, IndexDescription, InsertOneResult, UpdateResult } from 'mongodb';\n\nimport { BaseRaw } from './BaseRaw';\n\nexport class BannersRaw extends BaseRaw<IBanner> implements IBannersModel {\n\tconstructor(db: Db, trash?: Collection<RocketChatRecordDeleted<IBanner>>) {\n\t\tsuper(db, 'banner', trash);\n\t}\n\n\tprotected modelIndexes(): IndexDescription[] {\n\t\treturn [{ key: { platform: 1, startAt: 1, expireAt: 1 } }, { key: { platform: 1, startAt: 1, expireAt: 1, active: 1 } }];\n\t}\n\n\tcreate(doc: IBanner): Promise<InsertOneResult<IBanner>> {\n\t\tconst invalidPlatform = doc.platform?.some((platform) => !Object.values(BannerPlatform).includes(platform));\n\t\tif (invalidPlatform) {\n\t\t\tthrow new Error('Invalid platform');\n\t\t}\n\n\t\tif (doc.startAt > doc.expireAt) {\n\t\t\tthrow new Error('Start date cannot be later than expire date');\n\t\t}\n\n\t\tif (doc.expireAt < new Date()) {\n\t\t\tthrow new Error('Cannot create banner already expired');\n\t\t}\n\n\t\treturn this.insertOne({\n\t\t\tactive: true,\n\t\t\t...doc,\n\t\t});\n\t}\n\n\tfindActiveByRoleOrId(roles: string[], platform: BannerPlatform, bannerId?: string, options?: FindOptions<IBanner>): FindCursor<IBanner> {\n\t\tconst today = new Date();\n\n\t\tconst query = {\n\t\t\t...(bannerId && { _id: bannerId }),\n\t\t\tplatform,\n\t\t\tstartAt: { $lte: today },\n\t\t\texpireAt: { $gte: today },\n\t\t\tactive: { $ne: false },\n\t\t\t$or: [{ roles: { $in: roles } }, { roles: { $exists: false } }],\n\t\t};\n\n\t\treturn this.find(query, options);\n\t}\n\n\tdisable(bannerId: string): Promise<UpdateResult> {\n\t\treturn this.updateOne({ _id: bannerId, active: { $ne: false } }, { $set: { active: false, inactivedAt: new Date() } });\n\t}\n\n\tcreateOrUpdate(banner: IBanner): Promise<UpdateResult> {\n\t\tconst invalidPlatform = banner.platform?.some((platform) => !Object.values(BannerPlatform).includes(platform));\n\t\tif (invalidPlatform) {\n\t\t\tthrow new Error('Invalid platform');\n\t\t}\n\n\t\tif (banner.startAt > banner.expireAt) {\n\t\t\tthrow new Error('Start date cannot be later than expire date');\n\t\t}\n\n\t\tif (banner.expireAt < new Date()) {\n\t\t\tthrow new Error('Cannot create banner already expired');\n\t\t}\n\n\t\tconst { _id: bannerId, ...doc } = banner;\n\n\t\treturn this.updateOne({ _id: bannerId }, { $set: { active: true, ...doc } }, { upsert: true });\n\t}\n}\n"]}}},"code":"!module.wrapAsync(async function (module, __reifyWaitForDeps__, __reify_async_result__) {\n  \"use strict\";\n  try {\n    let _objectWithoutProperties;\n    module.link(\"@babel/runtime/helpers/objectWithoutProperties\", {\n      default(v) {\n        _objectWithoutProperties = v;\n      }\n    }, 0);\n    let _objectSpread;\n    module.link(\"@babel/runtime/helpers/objectSpread2\", {\n      default(v) {\n        _objectSpread = v;\n      }\n    }, 1);\n    const _excluded = [\"_id\"];\n    module.export({\n      BannersRaw: () => BannersRaw\n    });\n    let BannerPlatform;\n    module.link(\"@rocket.chat/core-typings\", {\n      BannerPlatform(v) {\n        BannerPlatform = v;\n      }\n    }, 0);\n    let BaseRaw;\n    module.link(\"./BaseRaw\", {\n      BaseRaw(v) {\n        BaseRaw = v;\n      }\n    }, 1);\n    if (__reifyWaitForDeps__()) (await __reifyWaitForDeps__())();\n    class BannersRaw extends BaseRaw {\n      constructor(db, trash) {\n        super(db, 'banner', trash);\n      }\n      modelIndexes() {\n        return [{\n          key: {\n            platform: 1,\n            startAt: 1,\n            expireAt: 1\n          }\n        }, {\n          key: {\n            platform: 1,\n            startAt: 1,\n            expireAt: 1,\n            active: 1\n          }\n        }];\n      }\n      create(doc) {\n        var _doc$platform;\n        const invalidPlatform = (_doc$platform = doc.platform) === null || _doc$platform === void 0 ? void 0 : _doc$platform.some(platform => !Object.values(BannerPlatform).includes(platform));\n        if (invalidPlatform) {\n          throw new Error('Invalid platform');\n        }\n        if (doc.startAt > doc.expireAt) {\n          throw new Error('Start date cannot be later than expire date');\n        }\n        if (doc.expireAt < new Date()) {\n          throw new Error('Cannot create banner already expired');\n        }\n        return this.insertOne(_objectSpread({\n          active: true\n        }, doc));\n      }\n      findActiveByRoleOrId(roles, platform, bannerId, options) {\n        const today = new Date();\n        const query = _objectSpread(_objectSpread({}, bannerId && {\n          _id: bannerId\n        }), {}, {\n          platform,\n          startAt: {\n            $lte: today\n          },\n          expireAt: {\n            $gte: today\n          },\n          active: {\n            $ne: false\n          },\n          $or: [{\n            roles: {\n              $in: roles\n            }\n          }, {\n            roles: {\n              $exists: false\n            }\n          }]\n        });\n        return this.find(query, options);\n      }\n      disable(bannerId) {\n        return this.updateOne({\n          _id: bannerId,\n          active: {\n            $ne: false\n          }\n        }, {\n          $set: {\n            active: false,\n            inactivedAt: new Date()\n          }\n        });\n      }\n      createOrUpdate(banner) {\n        var _banner$platform;\n        const invalidPlatform = (_banner$platform = banner.platform) === null || _banner$platform === void 0 ? void 0 : _banner$platform.some(platform => !Object.values(BannerPlatform).includes(platform));\n        if (invalidPlatform) {\n          throw new Error('Invalid platform');\n        }\n        if (banner.startAt > banner.expireAt) {\n          throw new Error('Start date cannot be later than expire date');\n        }\n        if (banner.expireAt < new Date()) {\n          throw new Error('Cannot create banner already expired');\n        }\n        const {\n            _id: bannerId\n          } = banner,\n          doc = _objectWithoutProperties(banner, _excluded);\n        return this.updateOne({\n          _id: bannerId\n        }, {\n          $set: _objectSpread({\n            active: true\n          }, doc)\n        }, {\n          upsert: true\n        });\n      }\n    }\n    __reify_async_result__();\n  } catch (_reifyError) {\n    return __reify_async_result__(_reifyError);\n  }\n  __reify_async_result__()\n}, {\n  self: this,\n  async: false\n});","map":{"version":3,"names":["_objectWithoutProperties","module","link","default","v","_objectSpread","_excluded","export","BannersRaw","BannerPlatform","BaseRaw","__reifyWaitForDeps__","constructor","db","trash","modelIndexes","key","platform","startAt","expireAt","active","create","doc","_doc$platform","invalidPlatform","some","Object","values","includes","Error","Date","insertOne","findActiveByRoleOrId","roles","bannerId","options","today","query","_id","$lte","$gte","$ne","$or","$in","$exists","find","disable","updateOne","$set","inactivedAt","createOrUpdate","banner","_banner$platform","upsert","__reify_async_result__","_reifyError","self","async"],"sources":["server/models/raw/Banners.ts"],"sourcesContent":["import type { IBanner, RocketChatRecordDeleted } from '@rocket.chat/core-typings';\nimport { BannerPlatform } from '@rocket.chat/core-typings';\nimport type { IBannersModel } from '@rocket.chat/model-typings';\nimport type { Collection, FindCursor, Db, FindOptions, IndexDescription, InsertOneResult, UpdateResult } from 'mongodb';\n\nimport { BaseRaw } from './BaseRaw';\n\nexport class BannersRaw extends BaseRaw<IBanner> implements IBannersModel {\n\tconstructor(db: Db, trash?: Collection<RocketChatRecordDeleted<IBanner>>) {\n\t\tsuper(db, 'banner', trash);\n\t}\n\n\tprotected modelIndexes(): IndexDescription[] {\n\t\treturn [{ key: { platform: 1, startAt: 1, expireAt: 1 } }, { key: { platform: 1, startAt: 1, expireAt: 1, active: 1 } }];\n\t}\n\n\tcreate(doc: IBanner): Promise<InsertOneResult<IBanner>> {\n\t\tconst invalidPlatform = doc.platform?.some((platform) => !Object.values(BannerPlatform).includes(platform));\n\t\tif (invalidPlatform) {\n\t\t\tthrow new Error('Invalid platform');\n\t\t}\n\n\t\tif (doc.startAt > doc.expireAt) {\n\t\t\tthrow new Error('Start date cannot be later than expire date');\n\t\t}\n\n\t\tif (doc.expireAt < new Date()) {\n\t\t\tthrow new Error('Cannot create banner already expired');\n\t\t}\n\n\t\treturn this.insertOne({\n\t\t\tactive: true,\n\t\t\t...doc,\n\t\t});\n\t}\n\n\tfindActiveByRoleOrId(roles: string[], platform: BannerPlatform, bannerId?: string, options?: FindOptions<IBanner>): FindCursor<IBanner> {\n\t\tconst today = new Date();\n\n\t\tconst query = {\n\t\t\t...(bannerId && { _id: bannerId }),\n\t\t\tplatform,\n\t\t\tstartAt: { $lte: today },\n\t\t\texpireAt: { $gte: today },\n\t\t\tactive: { $ne: false },\n\t\t\t$or: [{ roles: { $in: roles } }, { roles: { $exists: false } }],\n\t\t};\n\n\t\treturn this.find(query, options);\n\t}\n\n\tdisable(bannerId: string): Promise<UpdateResult> {\n\t\treturn this.updateOne({ _id: bannerId, active: { $ne: false } }, { $set: { active: false, inactivedAt: new Date() } });\n\t}\n\n\tcreateOrUpdate(banner: IBanner): Promise<UpdateResult> {\n\t\tconst invalidPlatform = banner.platform?.some((platform) => !Object.values(BannerPlatform).includes(platform));\n\t\tif (invalidPlatform) {\n\t\t\tthrow new Error('Invalid platform');\n\t\t}\n\n\t\tif (banner.startAt > banner.expireAt) {\n\t\t\tthrow new Error('Start date cannot be later than expire date');\n\t\t}\n\n\t\tif (banner.expireAt < new Date()) {\n\t\t\tthrow new Error('Cannot create banner already expired');\n\t\t}\n\n\t\tconst { _id: bannerId, ...doc } = banner;\n\n\t\treturn this.updateOne({ _id: bannerId }, { $set: { active: true, ...doc } }, { upsert: true });\n\t}\n}\n"],"mappings":"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","ignoreList":[]},"sourceType":"module","externalDependencies":{},"hash":"4e0b72091a3ff012e585a484bed21bce4cf2be64"}
