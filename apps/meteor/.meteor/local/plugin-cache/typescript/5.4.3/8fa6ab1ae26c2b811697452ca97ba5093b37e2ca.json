{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/client/sidebarv2/header/hooks/useSearchItems.ts","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","topLevelAwait","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"web.browser.legacy"},"sourceFileName":"client/sidebarv2/header/hooks/useSearchItems.ts","filename":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/client/sidebarv2/header/hooks/useSearchItems.ts","inputSourceMap":{"version":3,"file":"client/sidebarv2/header/hooks/useSearchItems.ts","sourceRoot":"","sources":["client/sidebarv2/header/hooks/useSearchItems.ts"],"names":[],"mappings":"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","sourcesContent":["import type { IRoom, ISubscription } from '@rocket.chat/core-typings';\nimport { escapeRegExp } from '@rocket.chat/string-helpers';\nimport { useMethod, useUserSubscriptions } from '@rocket.chat/ui-contexts';\nimport { useQuery, type UseQueryResult } from '@tanstack/react-query';\nimport { useMemo } from 'react';\n\nimport { getConfig } from '../../../lib/utils/getConfig';\n\nconst LIMIT = parseInt(String(getConfig('Sidebar_Search_Spotlight_LIMIT', 20)));\n\nconst options = {\n\tsort: {\n\t\tlm: -1,\n\t\tname: 1,\n\t},\n\tlimit: LIMIT,\n} as const;\n\nexport const useSearchItems = (filterText: string): UseQueryResult<(ISubscription & IRoom)[] | undefined, Error> => {\n\tconst [, mention, name] = useMemo(() => filterText.match(/(@|#)?(.*)/i) || [], [filterText]);\n\tconst query = useMemo(() => {\n\t\tconst filterRegex = new RegExp(escapeRegExp(name), 'i');\n\n\t\treturn {\n\t\t\t$or: [{ name: filterRegex }, { fname: filterRegex }],\n\t\t\t...(mention && {\n\t\t\t\tt: mention === '@' ? 'd' : { $ne: 'd' },\n\t\t\t}),\n\t\t};\n\t}, [name, mention]);\n\n\tconst localRooms = useUserSubscriptions(query, options);\n\n\tconst usernamesFromClient = [...localRooms?.map(({ t, name }) => (t === 'd' ? name : null))].filter(Boolean) as string[];\n\n\tconst searchForChannels = mention === '#';\n\tconst searchForDMs = mention === '@';\n\n\tconst type = useMemo(() => {\n\t\tif (searchForChannels) {\n\t\t\treturn { users: false, rooms: true, includeFederatedRooms: true };\n\t\t}\n\t\tif (searchForDMs) {\n\t\t\treturn { users: true, rooms: false };\n\t\t}\n\t\treturn { users: true, rooms: true, includeFederatedRooms: true };\n\t}, [searchForChannels, searchForDMs]);\n\n\tconst getSpotlight = useMethod('spotlight');\n\n\treturn useQuery(\n\t\t['sidebar/search/spotlight', name, usernamesFromClient, type, localRooms.map(({ _id, name }) => _id + name)],\n\t\tasync () => {\n\t\t\tif (localRooms.length === LIMIT) {\n\t\t\t\treturn localRooms;\n\t\t\t}\n\n\t\t\tconst spotlight = await getSpotlight(name, usernamesFromClient, type);\n\n\t\t\tconst filterUsersUnique = ({ _id }: { _id: string }, index: number, arr: { _id: string }[]): boolean =>\n\t\t\t\tindex === arr.findIndex((user) => _id === user._id);\n\n\t\t\tconst roomFilter = (room: { t: string; uids?: string[]; _id: string; name?: string }): boolean =>\n\t\t\t\t!localRooms.find(\n\t\t\t\t\t(item) =>\n\t\t\t\t\t\t(room.t === 'd' && room.uids && room.uids.length > 1 && room.uids?.includes(item._id)) ||\n\t\t\t\t\t\t[item.rid, item._id].includes(room._id),\n\t\t\t\t);\n\t\t\tconst usersFilter = (user: { _id: string }): boolean =>\n\t\t\t\t!localRooms.find((room) => room.t === 'd' && room.uids && room.uids?.length === 2 && room.uids.includes(user._id));\n\n\t\t\tconst userMap = (user: {\n\t\t\t\t_id: string;\n\t\t\t\tname: string;\n\t\t\t\tusername: string;\n\t\t\t\tavatarETag?: string;\n\t\t\t}): {\n\t\t\t\t_id: string;\n\t\t\t\tt: string;\n\t\t\t\tname: string;\n\t\t\t\tfname: string;\n\t\t\t\tavatarETag?: string;\n\t\t\t} => ({\n\t\t\t\t_id: user._id,\n\t\t\t\tt: 'd',\n\t\t\t\tname: user.username,\n\t\t\t\tfname: user.name,\n\t\t\t\tavatarETag: user.avatarETag,\n\t\t\t});\n\n\t\t\ttype resultsFromServerType = {\n\t\t\t\t_id: string;\n\t\t\t\tt: string;\n\t\t\t\tname: string;\n\t\t\t\tteamMain?: boolean;\n\t\t\t\tfname?: string;\n\t\t\t\tavatarETag?: string | undefined;\n\t\t\t\tuids?: string[] | undefined;\n\t\t\t}[];\n\n\t\t\tconst resultsFromServer: resultsFromServerType = [];\n\t\t\tresultsFromServer.push(...spotlight.users.filter(filterUsersUnique).filter(usersFilter).map(userMap));\n\t\t\tresultsFromServer.push(...spotlight.rooms.filter(roomFilter));\n\n\t\t\tconst exact = resultsFromServer?.filter((item) => [item.name, item.fname].includes(name));\n\t\t\treturn Array.from(new Set([...exact, ...localRooms, ...resultsFromServer]));\n\t\t},\n\t\t{\n\t\t\tstaleTime: 60_000,\n\t\t\tkeepPreviousData: true,\n\t\t\tplaceholderData: localRooms,\n\t\t},\n\t);\n};\n"]},"targets":{"android":"125.0.0","chrome":"125.0.0","edge":"125.0.0","firefox":"115.0.0","ie":"10.0.0","ios":"17.4.0","opera":"110.0.0","opera_mobile":"80.0.0","safari":"17.4.0","samsung":"24.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor","root":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":true,"enforceStrictMode":false,"dynamicImport":true},"externalDependencies":[]},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"version":"7.17.2","helpers":true,"useESModules":false,"corejs":false},"externalDependencies":[]},{"key":"proposal-class-properties","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true},"externalDependencies":[]},{"key":"base$0$3","visitor":{"FunctionExpression":{"exit":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"base$0$4","visitor":{"ForInStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-react-jsx","visitor":{"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXFragment":{"exit":[null]},"JSXElement":{"exit":[null]},"JSXAttribute":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false},"externalDependencies":[]},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-nullish-coalescing-operator","visitor":{"LogicalExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-optional-chaining","visitor":{"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-optional-catch-binding","visitor":{"CatchClause":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-class-properties","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-async-generator-functions","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-logical-assignment-operators","visitor":{"AssignmentExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-arrow-functions","visitor":{"ArrowFunctionExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-block-scoped-functions","visitor":{"BlockStatement":{"enter":[null]},"SwitchCase":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-block-scoping","visitor":{"VariableDeclaration":{"enter":[null,null]},"BlockStatement":{"enter":[null]},"SwitchCase":{"enter":[null]},"ClassDeclaration":{"enter":[null]},"DoWhileStatement":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForStatement":{"enter":[null]},"WhileStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-classes","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"ClassDeclaration":{"enter":[null]},"ClassExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"loose":true},"externalDependencies":[]},{"key":"transform-computed-properties","visitor":{"ObjectExpression":{"exit":[null]},"_exploded":true,"_verified":true},"options":{"loose":true},"externalDependencies":[]},{"key":"transform-destructuring","visitor":{"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"VariableDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"transform-for-of","visitor":{"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"loose":true},"externalDependencies":[]},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-object-super","visitor":{"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true,"DoWhileStatement":{"exit":[null]},"ForInStatement":{"exit":[null]},"ForStatement":{"exit":[null]},"WhileStatement":{"exit":[null]},"ForOfStatement":{"exit":[null]}},"options":{},"externalDependencies":[]},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"transform-shorthand-properties","visitor":{"ObjectMethod":{"enter":[null]},"ObjectProperty":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-spread","visitor":{"ArrayExpression":{"enter":[null]},"CallExpression":{"enter":[null]},"NewExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-sticky-regex","visitor":{"RegExpLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"loose":true},"externalDependencies":[]},{"key":"transform-typeof-symbol","visitor":{"UnaryExpression":{"enter":[null]},"_exploded":true,"_verified":true,"BlockStatement":{"enter":[null]},"CatchClause":{"enter":[null]},"DoWhileStatement":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForStatement":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"Program":{"enter":[null]},"ObjectMethod":{"enter":[null]},"SwitchStatement":{"enter":[null]},"WhileStatement":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]},"ForOfStatement":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"StaticBlock":{"enter":[null]},"TSModuleBlock":{"enter":[null]},"AssignmentPattern":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectPattern":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"transform-unicode-regex","visitor":{"RegExpLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-property-literals","visitor":{"ObjectProperty":{"exit":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-regenerator","visitor":{"ObjectMethod":{"enter":[null],"exit":[null]},"ClassMethod":{"enter":[null],"exit":[null]},"ClassPrivateMethod":{"enter":[null],"exit":[null]},"FunctionDeclaration":{"exit":[null]},"FunctionExpression":{"exit":[null]},"ArrowFunctionExpression":{"exit":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]}],"presets":[],"generatorOpts":{"filename":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/client/sidebarv2/header/hooks/useSearchItems.ts","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"client/sidebarv2/header/hooks/useSearchItems.ts","inputSourceMap":{"version":3,"file":"client/sidebarv2/header/hooks/useSearchItems.ts","sourceRoot":"","sources":["client/sidebarv2/header/hooks/useSearchItems.ts"],"names":[],"mappings":"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","sourcesContent":["import type { IRoom, ISubscription } from '@rocket.chat/core-typings';\nimport { escapeRegExp } from '@rocket.chat/string-helpers';\nimport { useMethod, useUserSubscriptions } from '@rocket.chat/ui-contexts';\nimport { useQuery, type UseQueryResult } from '@tanstack/react-query';\nimport { useMemo } from 'react';\n\nimport { getConfig } from '../../../lib/utils/getConfig';\n\nconst LIMIT = parseInt(String(getConfig('Sidebar_Search_Spotlight_LIMIT', 20)));\n\nconst options = {\n\tsort: {\n\t\tlm: -1,\n\t\tname: 1,\n\t},\n\tlimit: LIMIT,\n} as const;\n\nexport const useSearchItems = (filterText: string): UseQueryResult<(ISubscription & IRoom)[] | undefined, Error> => {\n\tconst [, mention, name] = useMemo(() => filterText.match(/(@|#)?(.*)/i) || [], [filterText]);\n\tconst query = useMemo(() => {\n\t\tconst filterRegex = new RegExp(escapeRegExp(name), 'i');\n\n\t\treturn {\n\t\t\t$or: [{ name: filterRegex }, { fname: filterRegex }],\n\t\t\t...(mention && {\n\t\t\t\tt: mention === '@' ? 'd' : { $ne: 'd' },\n\t\t\t}),\n\t\t};\n\t}, [name, mention]);\n\n\tconst localRooms = useUserSubscriptions(query, options);\n\n\tconst usernamesFromClient = [...localRooms?.map(({ t, name }) => (t === 'd' ? name : null))].filter(Boolean) as string[];\n\n\tconst searchForChannels = mention === '#';\n\tconst searchForDMs = mention === '@';\n\n\tconst type = useMemo(() => {\n\t\tif (searchForChannels) {\n\t\t\treturn { users: false, rooms: true, includeFederatedRooms: true };\n\t\t}\n\t\tif (searchForDMs) {\n\t\t\treturn { users: true, rooms: false };\n\t\t}\n\t\treturn { users: true, rooms: true, includeFederatedRooms: true };\n\t}, [searchForChannels, searchForDMs]);\n\n\tconst getSpotlight = useMethod('spotlight');\n\n\treturn useQuery(\n\t\t['sidebar/search/spotlight', name, usernamesFromClient, type, localRooms.map(({ _id, name }) => _id + name)],\n\t\tasync () => {\n\t\t\tif (localRooms.length === LIMIT) {\n\t\t\t\treturn localRooms;\n\t\t\t}\n\n\t\t\tconst spotlight = await getSpotlight(name, usernamesFromClient, type);\n\n\t\t\tconst filterUsersUnique = ({ _id }: { _id: string }, index: number, arr: { _id: string }[]): boolean =>\n\t\t\t\tindex === arr.findIndex((user) => _id === user._id);\n\n\t\t\tconst roomFilter = (room: { t: string; uids?: string[]; _id: string; name?: string }): boolean =>\n\t\t\t\t!localRooms.find(\n\t\t\t\t\t(item) =>\n\t\t\t\t\t\t(room.t === 'd' && room.uids && room.uids.length > 1 && room.uids?.includes(item._id)) ||\n\t\t\t\t\t\t[item.rid, item._id].includes(room._id),\n\t\t\t\t);\n\t\t\tconst usersFilter = (user: { _id: string }): boolean =>\n\t\t\t\t!localRooms.find((room) => room.t === 'd' && room.uids && room.uids?.length === 2 && room.uids.includes(user._id));\n\n\t\t\tconst userMap = (user: {\n\t\t\t\t_id: string;\n\t\t\t\tname: string;\n\t\t\t\tusername: string;\n\t\t\t\tavatarETag?: string;\n\t\t\t}): {\n\t\t\t\t_id: string;\n\t\t\t\tt: string;\n\t\t\t\tname: string;\n\t\t\t\tfname: string;\n\t\t\t\tavatarETag?: string;\n\t\t\t} => ({\n\t\t\t\t_id: user._id,\n\t\t\t\tt: 'd',\n\t\t\t\tname: user.username,\n\t\t\t\tfname: user.name,\n\t\t\t\tavatarETag: user.avatarETag,\n\t\t\t});\n\n\t\t\ttype resultsFromServerType = {\n\t\t\t\t_id: string;\n\t\t\t\tt: string;\n\t\t\t\tname: string;\n\t\t\t\tteamMain?: boolean;\n\t\t\t\tfname?: string;\n\t\t\t\tavatarETag?: string | undefined;\n\t\t\t\tuids?: string[] | undefined;\n\t\t\t}[];\n\n\t\t\tconst resultsFromServer: resultsFromServerType = [];\n\t\t\tresultsFromServer.push(...spotlight.users.filter(filterUsersUnique).filter(usersFilter).map(userMap));\n\t\t\tresultsFromServer.push(...spotlight.rooms.filter(roomFilter));\n\n\t\t\tconst exact = resultsFromServer?.filter((item) => [item.name, item.fname].includes(name));\n\t\t\treturn Array.from(new Set([...exact, ...localRooms, ...resultsFromServer]));\n\t\t},\n\t\t{\n\t\t\tstaleTime: 60_000,\n\t\t\tkeepPreviousData: true,\n\t\t\tplaceholderData: localRooms,\n\t\t},\n\t);\n};\n"]}}},"code":"var _regeneratorRuntime;\nmodule.link(\"@babel/runtime/regenerator\", {\n  default: function (v) {\n    _regeneratorRuntime = v;\n  }\n}, 0);\nvar _toConsumableArray;\nmodule.link(\"@babel/runtime/helpers/toConsumableArray\", {\n  default: function (v) {\n    _toConsumableArray = v;\n  }\n}, 1);\nvar _objectSpread;\nmodule.link(\"@babel/runtime/helpers/objectSpread2\", {\n  default: function (v) {\n    _objectSpread = v;\n  }\n}, 2);\nvar _slicedToArray;\nmodule.link(\"@babel/runtime/helpers/slicedToArray\", {\n  default: function (v) {\n    _slicedToArray = v;\n  }\n}, 3);\nmodule.export({\n  useSearchItems: function () {\n    return useSearchItems;\n  }\n});\nvar escapeRegExp;\nmodule.link(\"@rocket.chat/string-helpers\", {\n  escapeRegExp: function (v) {\n    escapeRegExp = v;\n  }\n}, 0);\nvar useMethod, useUserSubscriptions;\nmodule.link(\"@rocket.chat/ui-contexts\", {\n  useMethod: function (v) {\n    useMethod = v;\n  },\n  useUserSubscriptions: function (v) {\n    useUserSubscriptions = v;\n  }\n}, 1);\nvar useQuery;\nmodule.link(\"@tanstack/react-query\", {\n  useQuery: function (v) {\n    useQuery = v;\n  }\n}, 2);\nvar useMemo;\nmodule.link(\"react\", {\n  useMemo: function (v) {\n    useMemo = v;\n  }\n}, 3);\nvar getConfig;\nmodule.link(\"../../../lib/utils/getConfig\", {\n  getConfig: function (v) {\n    getConfig = v;\n  }\n}, 4);\nvar LIMIT = parseInt(String(getConfig('Sidebar_Search_Spotlight_LIMIT', 20)));\nvar options = {\n  sort: {\n    lm: -1,\n    name: 1\n  },\n  limit: LIMIT\n};\nvar useSearchItems = function (filterText) {\n  var _useMemo = useMemo(function () {\n      return filterText.match(/(@|#)?(.*)/i) || [];\n    }, [filterText]),\n    _useMemo2 = _slicedToArray(_useMemo, 3),\n    mention = _useMemo2[1],\n    name = _useMemo2[2];\n  var query = useMemo(function () {\n    var filterRegex = new RegExp(escapeRegExp(name), 'i');\n    return _objectSpread({\n      $or: [{\n        name: filterRegex\n      }, {\n        fname: filterRegex\n      }]\n    }, mention && {\n      t: mention === '@' ? 'd' : {\n        $ne: 'd'\n      }\n    });\n  }, [name, mention]);\n  var localRooms = useUserSubscriptions(query, options);\n  var usernamesFromClient = _toConsumableArray(localRooms === null || localRooms === void 0 ? void 0 : localRooms.map(function (_ref) {\n    var t = _ref.t,\n      name = _ref.name;\n    return t === 'd' ? name : null;\n  })).filter(Boolean);\n  var searchForChannels = mention === '#';\n  var searchForDMs = mention === '@';\n  var type = useMemo(function () {\n    if (searchForChannels) {\n      return {\n        users: false,\n        rooms: true,\n        includeFederatedRooms: true\n      };\n    }\n    if (searchForDMs) {\n      return {\n        users: true,\n        rooms: false\n      };\n    }\n    return {\n      users: true,\n      rooms: true,\n      includeFederatedRooms: true\n    };\n  }, [searchForChannels, searchForDMs]);\n  var getSpotlight = useMethod('spotlight');\n  return useQuery(['sidebar/search/spotlight', name, usernamesFromClient, type, localRooms.map(function (_ref2) {\n    var _id = _ref2._id,\n      name = _ref2.name;\n    return _id + name;\n  })], function () {\n    function _callee() {\n      var spotlight, filterUsersUnique, roomFilter, usersFilter, userMap, resultsFromServer, exact;\n      return _regeneratorRuntime.async(function () {\n        function _callee$(_context) {\n          while (1) switch (_context.prev = _context.next) {\n            case 0:\n              if (!(localRooms.length === LIMIT)) {\n                _context.next = 2;\n                break;\n              }\n              return _context.abrupt(\"return\", localRooms);\n            case 2:\n              _context.next = 4;\n              return _regeneratorRuntime.awrap(getSpotlight(name, usernamesFromClient, type));\n            case 4:\n              spotlight = _context.sent;\n              filterUsersUnique = function (_ref3, index, arr) {\n                var _id = _ref3._id;\n                return index === arr.findIndex(function (user) {\n                  return _id === user._id;\n                });\n              };\n              roomFilter = function (room) {\n                return !localRooms.find(function (item) {\n                  var _room$uids;\n                  return room.t === 'd' && room.uids && room.uids.length > 1 && ((_room$uids = room.uids) === null || _room$uids === void 0 ? void 0 : _room$uids.includes(item._id)) || [item.rid, item._id].includes(room._id);\n                });\n              };\n              usersFilter = function (user) {\n                return !localRooms.find(function (room) {\n                  var _room$uids2;\n                  return room.t === 'd' && room.uids && ((_room$uids2 = room.uids) === null || _room$uids2 === void 0 ? void 0 : _room$uids2.length) === 2 && room.uids.includes(user._id);\n                });\n              };\n              userMap = function (user) {\n                return {\n                  _id: user._id,\n                  t: 'd',\n                  name: user.username,\n                  fname: user.name,\n                  avatarETag: user.avatarETag\n                };\n              };\n              resultsFromServer = [];\n              resultsFromServer.push.apply(resultsFromServer, _toConsumableArray(spotlight.users.filter(filterUsersUnique).filter(usersFilter).map(userMap)));\n              resultsFromServer.push.apply(resultsFromServer, _toConsumableArray(spotlight.rooms.filter(roomFilter)));\n              exact = resultsFromServer === null || resultsFromServer === void 0 ? void 0 : resultsFromServer.filter(function (item) {\n                return [item.name, item.fname].includes(name);\n              });\n              return _context.abrupt(\"return\", Array.from(new Set([].concat(_toConsumableArray(exact), _toConsumableArray(localRooms), resultsFromServer))));\n            case 14:\n            case \"end\":\n              return _context.stop();\n          }\n        }\n        return _callee$;\n      }(), null, null, null, Promise);\n    }\n    return _callee;\n  }(), {\n    staleTime: 60_000,\n    keepPreviousData: true,\n    placeholderData: localRooms\n  });\n};","map":{"version":3,"names":["_regeneratorRuntime","module","link","default","v","_toConsumableArray","_objectSpread","_slicedToArray","export","useSearchItems","escapeRegExp","useMethod","useUserSubscriptions","useQuery","useMemo","getConfig","LIMIT","parseInt","String","options","sort","lm","name","limit","filterText","_useMemo","match","_useMemo2","mention","query","filterRegex","RegExp","$or","fname","t","$ne","localRooms","usernamesFromClient","map","_ref","filter","Boolean","searchForChannels","searchForDMs","type","users","rooms","includeFederatedRooms","getSpotlight","_ref2","_id","_callee","spotlight","filterUsersUnique","roomFilter","usersFilter","userMap","resultsFromServer","exact","async","_callee$","_context","prev","next","length","abrupt","awrap","sent","_ref3","index","arr","findIndex","user","room","find","item","_room$uids","uids","includes","rid","_room$uids2","username","avatarETag","push","apply","Array","from","Set","concat","stop","Promise","staleTime","keepPreviousData","placeholderData"],"sources":["client/sidebarv2/header/hooks/useSearchItems.ts"],"sourcesContent":["import type { IRoom, ISubscription } from '@rocket.chat/core-typings';\nimport { escapeRegExp } from '@rocket.chat/string-helpers';\nimport { useMethod, useUserSubscriptions } from '@rocket.chat/ui-contexts';\nimport { useQuery, type UseQueryResult } from '@tanstack/react-query';\nimport { useMemo } from 'react';\n\nimport { getConfig } from '../../../lib/utils/getConfig';\n\nconst LIMIT = parseInt(String(getConfig('Sidebar_Search_Spotlight_LIMIT', 20)));\n\nconst options = {\n\tsort: {\n\t\tlm: -1,\n\t\tname: 1,\n\t},\n\tlimit: LIMIT,\n} as const;\n\nexport const useSearchItems = (filterText: string): UseQueryResult<(ISubscription & IRoom)[] | undefined, Error> => {\n\tconst [, mention, name] = useMemo(() => filterText.match(/(@|#)?(.*)/i) || [], [filterText]);\n\tconst query = useMemo(() => {\n\t\tconst filterRegex = new RegExp(escapeRegExp(name), 'i');\n\n\t\treturn {\n\t\t\t$or: [{ name: filterRegex }, { fname: filterRegex }],\n\t\t\t...(mention && {\n\t\t\t\tt: mention === '@' ? 'd' : { $ne: 'd' },\n\t\t\t}),\n\t\t};\n\t}, [name, mention]);\n\n\tconst localRooms = useUserSubscriptions(query, options);\n\n\tconst usernamesFromClient = [...localRooms?.map(({ t, name }) => (t === 'd' ? name : null))].filter(Boolean) as string[];\n\n\tconst searchForChannels = mention === '#';\n\tconst searchForDMs = mention === '@';\n\n\tconst type = useMemo(() => {\n\t\tif (searchForChannels) {\n\t\t\treturn { users: false, rooms: true, includeFederatedRooms: true };\n\t\t}\n\t\tif (searchForDMs) {\n\t\t\treturn { users: true, rooms: false };\n\t\t}\n\t\treturn { users: true, rooms: true, includeFederatedRooms: true };\n\t}, [searchForChannels, searchForDMs]);\n\n\tconst getSpotlight = useMethod('spotlight');\n\n\treturn useQuery(\n\t\t['sidebar/search/spotlight', name, usernamesFromClient, type, localRooms.map(({ _id, name }) => _id + name)],\n\t\tasync () => {\n\t\t\tif (localRooms.length === LIMIT) {\n\t\t\t\treturn localRooms;\n\t\t\t}\n\n\t\t\tconst spotlight = await getSpotlight(name, usernamesFromClient, type);\n\n\t\t\tconst filterUsersUnique = ({ _id }: { _id: string }, index: number, arr: { _id: string }[]): boolean =>\n\t\t\t\tindex === arr.findIndex((user) => _id === user._id);\n\n\t\t\tconst roomFilter = (room: { t: string; uids?: string[]; _id: string; name?: string }): boolean =>\n\t\t\t\t!localRooms.find(\n\t\t\t\t\t(item) =>\n\t\t\t\t\t\t(room.t === 'd' && room.uids && room.uids.length > 1 && room.uids?.includes(item._id)) ||\n\t\t\t\t\t\t[item.rid, item._id].includes(room._id),\n\t\t\t\t);\n\t\t\tconst usersFilter = (user: { _id: string }): boolean =>\n\t\t\t\t!localRooms.find((room) => room.t === 'd' && room.uids && room.uids?.length === 2 && room.uids.includes(user._id));\n\n\t\t\tconst userMap = (user: {\n\t\t\t\t_id: string;\n\t\t\t\tname: string;\n\t\t\t\tusername: string;\n\t\t\t\tavatarETag?: string;\n\t\t\t}): {\n\t\t\t\t_id: string;\n\t\t\t\tt: string;\n\t\t\t\tname: string;\n\t\t\t\tfname: string;\n\t\t\t\tavatarETag?: string;\n\t\t\t} => ({\n\t\t\t\t_id: user._id,\n\t\t\t\tt: 'd',\n\t\t\t\tname: user.username,\n\t\t\t\tfname: user.name,\n\t\t\t\tavatarETag: user.avatarETag,\n\t\t\t});\n\n\t\t\ttype resultsFromServerType = {\n\t\t\t\t_id: string;\n\t\t\t\tt: string;\n\t\t\t\tname: string;\n\t\t\t\tteamMain?: boolean;\n\t\t\t\tfname?: string;\n\t\t\t\tavatarETag?: string | undefined;\n\t\t\t\tuids?: string[] | undefined;\n\t\t\t}[];\n\n\t\t\tconst resultsFromServer: resultsFromServerType = [];\n\t\t\tresultsFromServer.push(...spotlight.users.filter(filterUsersUnique).filter(usersFilter).map(userMap));\n\t\t\tresultsFromServer.push(...spotlight.rooms.filter(roomFilter));\n\n\t\t\tconst exact = resultsFromServer?.filter((item) => [item.name, item.fname].includes(name));\n\t\t\treturn Array.from(new Set([...exact, ...localRooms, ...resultsFromServer]));\n\t\t},\n\t\t{\n\t\t\tstaleTime: 60_000,\n\t\t\tkeepPreviousData: true,\n\t\t\tplaceholderData: localRooms,\n\t\t},\n\t);\n};\n"],"mappings":"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","ignoreList":[]},"sourceType":"module","externalDependencies":{},"hash":"8fa6ab1ae26c2b811697452ca97ba5093b37e2ca"}
