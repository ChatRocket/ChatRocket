{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/app/api/server/api.helpers.ts","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","topLevelAwait","objectRestSpread","objectRestSpread","asyncGenerators","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"os.osx.arm64"},"sourceFileName":"app/api/server/api.helpers.ts","filename":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/app/api/server/api.helpers.ts","inputSourceMap":{"version":3,"file":"app/api/server/api.helpers.ts","sourceRoot":"","sources":["app/api/server/api.helpers.ts"],"names":[],"mappings":"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","sourcesContent":["import type { IUser } from '@rocket.chat/core-typings';\n\nimport { hasAllPermissionAsync, hasAtLeastOnePermissionAsync } from '../../authorization/server/functions/hasPermission';\nimport { apiDeprecationLogger } from '../../lib/server/lib/deprecationWarningLogger';\n\ntype RequestMethod = 'GET' | 'POST' | 'PUT' | 'DELETE' | '*';\nexport type PermissionsPayload = {\n\t[key in RequestMethod]?: {\n\t\toperation: 'hasAll' | 'hasAny';\n\t\tpermissions: string[];\n\t};\n};\n\ntype PermissionsPayloadLight = {\n\t[key in RequestMethod]?: string[];\n};\n\ntype PermissionsRequiredKey = string[] | PermissionsPayload | PermissionsPayloadLight;\n\nconst isLegacyPermissionsPayload = (permissionsPayload: PermissionsRequiredKey): permissionsPayload is string[] => {\n\treturn Array.isArray(permissionsPayload);\n};\n\nconst isLightPermissionsPayload = (permissionsPayload: PermissionsRequiredKey): permissionsPayload is PermissionsPayloadLight => {\n\treturn (\n\t\ttypeof permissionsPayload === 'object' &&\n\t\tObject.keys(permissionsPayload).some((key) => ['GET', 'POST', 'PUT', 'DELETE', '*'].includes(key.toUpperCase())) &&\n\t\tObject.values(permissionsPayload).every((value) => Array.isArray(value))\n\t);\n};\n\nconst isPermissionsPayload = (permissionsPayload: PermissionsRequiredKey): permissionsPayload is PermissionsPayload => {\n\treturn (\n\t\ttypeof permissionsPayload === 'object' &&\n\t\tObject.keys(permissionsPayload).some((key) => ['GET', 'POST', 'PUT', 'DELETE', '*'].includes(key.toUpperCase())) &&\n\t\tObject.values(permissionsPayload).every((value) => typeof value === 'object' && value.operation && value.permissions)\n\t);\n};\n\nexport async function checkPermissionsForInvocation(\n\tuserId: IUser['_id'],\n\tpermissionsPayload: PermissionsPayload,\n\trequestMethod: RequestMethod,\n): Promise<boolean> {\n\tconst permissions = permissionsPayload[requestMethod] || permissionsPayload['*'];\n\n\tif (!permissions) {\n\t\t// how we reached here in the first place?\n\t\treturn false;\n\t}\n\n\tif (permissions.permissions.length === 0) {\n\t\t// You can pass an empty array of permissions to allow access to the method\n\t\treturn true;\n\t}\n\n\tif (permissions.operation === 'hasAll') {\n\t\treturn hasAllPermissionAsync(userId, permissions.permissions);\n\t}\n\n\tif (permissions.operation === 'hasAny') {\n\t\treturn hasAtLeastOnePermissionAsync(userId, permissions.permissions);\n\t}\n\n\treturn false;\n}\n\n// We'll assume options only contains permissionsRequired, as we don't care of the other elements\nexport function checkPermissions(options: { permissionsRequired?: PermissionsRequiredKey }) {\n\tif (!options.permissionsRequired) {\n\t\treturn false;\n\t}\n\n\tif (isPermissionsPayload(options.permissionsRequired)) {\n\t\t// No modifications needed\n\t\treturn true;\n\t}\n\n\tif (isLegacyPermissionsPayload(options.permissionsRequired)) {\n\t\toptions.permissionsRequired = {\n\t\t\t'*': {\n\t\t\t\toperation: 'hasAll',\n\t\t\t\tpermissions: options.permissionsRequired,\n\t\t\t},\n\t\t};\n\t\treturn true;\n\t}\n\n\tif (isLightPermissionsPayload(options.permissionsRequired)) {\n\t\tObject.keys(options.permissionsRequired).forEach((method) => {\n\t\t\tconst methodKey = method as RequestMethod;\n\t\t\t// @ts-expect-error -- we know the type of the value but ts refuses to infer it\n\t\t\toptions.permissionsRequired[methodKey] = {\n\t\t\t\toperation: 'hasAll',\n\t\t\t\t// @ts-expect-error -- we know the type of the value but ts refuses to infer it\n\t\t\t\tpermissions: options.permissionsRequired[methodKey],\n\t\t\t};\n\t\t});\n\t\treturn true;\n\t}\n\n\t// If reached here, options.permissionsRequired contained an invalid payload\n\treturn false;\n}\n\nexport function parseDeprecation(methodThis: any, { alternatives, version }: { version: string; alternatives?: string[] }): void {\n\tconst infoMessage = alternatives?.length ? ` Please use the alternative(s): ${alternatives.join(',')}` : '';\n\tapiDeprecationLogger.endpoint(methodThis.request.route, version, methodThis.response, infoMessage);\n}\n"]},"targets":{"android":"125.0.0","chrome":"125.0.0","edge":"125.0.0","firefox":"115.0.0","ie":"10.0.0","ios":"17.4.0","opera":"110.0.0","opera_mobile":"80.0.0","safari":"17.4.0","samsung":"24.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor","root":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":false,"enforceStrictMode":false,"dynamicImport":true,"generateLetDeclarations":true,"topLevelAwait":true},"externalDependencies":[]},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"version":"7.17.2","helpers":true,"useESModules":false,"corejs":false},"externalDependencies":[]},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-async-generator-functions","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-class-properties","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true},"externalDependencies":[]},{"key":"transform-react-jsx","visitor":{"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXFragment":{"exit":[null]},"JSXElement":{"exit":[null]},"JSXAttribute":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false},"externalDependencies":[]},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-nullish-coalescing-operator","visitor":{"LogicalExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-optional-chaining","visitor":{"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-optional-catch-binding","visitor":{"CatchClause":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-class-properties","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-async-generator-functions","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-logical-assignment-operators","visitor":{"AssignmentExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]}],"presets":[],"generatorOpts":{"filename":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/app/api/server/api.helpers.ts","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"app/api/server/api.helpers.ts","inputSourceMap":{"version":3,"file":"app/api/server/api.helpers.ts","sourceRoot":"","sources":["app/api/server/api.helpers.ts"],"names":[],"mappings":"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","sourcesContent":["import type { IUser } from '@rocket.chat/core-typings';\n\nimport { hasAllPermissionAsync, hasAtLeastOnePermissionAsync } from '../../authorization/server/functions/hasPermission';\nimport { apiDeprecationLogger } from '../../lib/server/lib/deprecationWarningLogger';\n\ntype RequestMethod = 'GET' | 'POST' | 'PUT' | 'DELETE' | '*';\nexport type PermissionsPayload = {\n\t[key in RequestMethod]?: {\n\t\toperation: 'hasAll' | 'hasAny';\n\t\tpermissions: string[];\n\t};\n};\n\ntype PermissionsPayloadLight = {\n\t[key in RequestMethod]?: string[];\n};\n\ntype PermissionsRequiredKey = string[] | PermissionsPayload | PermissionsPayloadLight;\n\nconst isLegacyPermissionsPayload = (permissionsPayload: PermissionsRequiredKey): permissionsPayload is string[] => {\n\treturn Array.isArray(permissionsPayload);\n};\n\nconst isLightPermissionsPayload = (permissionsPayload: PermissionsRequiredKey): permissionsPayload is PermissionsPayloadLight => {\n\treturn (\n\t\ttypeof permissionsPayload === 'object' &&\n\t\tObject.keys(permissionsPayload).some((key) => ['GET', 'POST', 'PUT', 'DELETE', '*'].includes(key.toUpperCase())) &&\n\t\tObject.values(permissionsPayload).every((value) => Array.isArray(value))\n\t);\n};\n\nconst isPermissionsPayload = (permissionsPayload: PermissionsRequiredKey): permissionsPayload is PermissionsPayload => {\n\treturn (\n\t\ttypeof permissionsPayload === 'object' &&\n\t\tObject.keys(permissionsPayload).some((key) => ['GET', 'POST', 'PUT', 'DELETE', '*'].includes(key.toUpperCase())) &&\n\t\tObject.values(permissionsPayload).every((value) => typeof value === 'object' && value.operation && value.permissions)\n\t);\n};\n\nexport async function checkPermissionsForInvocation(\n\tuserId: IUser['_id'],\n\tpermissionsPayload: PermissionsPayload,\n\trequestMethod: RequestMethod,\n): Promise<boolean> {\n\tconst permissions = permissionsPayload[requestMethod] || permissionsPayload['*'];\n\n\tif (!permissions) {\n\t\t// how we reached here in the first place?\n\t\treturn false;\n\t}\n\n\tif (permissions.permissions.length === 0) {\n\t\t// You can pass an empty array of permissions to allow access to the method\n\t\treturn true;\n\t}\n\n\tif (permissions.operation === 'hasAll') {\n\t\treturn hasAllPermissionAsync(userId, permissions.permissions);\n\t}\n\n\tif (permissions.operation === 'hasAny') {\n\t\treturn hasAtLeastOnePermissionAsync(userId, permissions.permissions);\n\t}\n\n\treturn false;\n}\n\n// We'll assume options only contains permissionsRequired, as we don't care of the other elements\nexport function checkPermissions(options: { permissionsRequired?: PermissionsRequiredKey }) {\n\tif (!options.permissionsRequired) {\n\t\treturn false;\n\t}\n\n\tif (isPermissionsPayload(options.permissionsRequired)) {\n\t\t// No modifications needed\n\t\treturn true;\n\t}\n\n\tif (isLegacyPermissionsPayload(options.permissionsRequired)) {\n\t\toptions.permissionsRequired = {\n\t\t\t'*': {\n\t\t\t\toperation: 'hasAll',\n\t\t\t\tpermissions: options.permissionsRequired,\n\t\t\t},\n\t\t};\n\t\treturn true;\n\t}\n\n\tif (isLightPermissionsPayload(options.permissionsRequired)) {\n\t\tObject.keys(options.permissionsRequired).forEach((method) => {\n\t\t\tconst methodKey = method as RequestMethod;\n\t\t\t// @ts-expect-error -- we know the type of the value but ts refuses to infer it\n\t\t\toptions.permissionsRequired[methodKey] = {\n\t\t\t\toperation: 'hasAll',\n\t\t\t\t// @ts-expect-error -- we know the type of the value but ts refuses to infer it\n\t\t\t\tpermissions: options.permissionsRequired[methodKey],\n\t\t\t};\n\t\t});\n\t\treturn true;\n\t}\n\n\t// If reached here, options.permissionsRequired contained an invalid payload\n\treturn false;\n}\n\nexport function parseDeprecation(methodThis: any, { alternatives, version }: { version: string; alternatives?: string[] }): void {\n\tconst infoMessage = alternatives?.length ? ` Please use the alternative(s): ${alternatives.join(',')}` : '';\n\tapiDeprecationLogger.endpoint(methodThis.request.route, version, methodThis.response, infoMessage);\n}\n"]}}},"code":"!module.wrapAsync(async function (module, __reifyWaitForDeps__, __reify_async_result__) {\n  \"use strict\";\n  try {\n    module.export({\n      checkPermissionsForInvocation: () => checkPermissionsForInvocation,\n      checkPermissions: () => checkPermissions,\n      parseDeprecation: () => parseDeprecation\n    });\n    let hasAllPermissionAsync, hasAtLeastOnePermissionAsync;\n    module.link(\"../../authorization/server/functions/hasPermission\", {\n      hasAllPermissionAsync(v) {\n        hasAllPermissionAsync = v;\n      },\n      hasAtLeastOnePermissionAsync(v) {\n        hasAtLeastOnePermissionAsync = v;\n      }\n    }, 0);\n    let apiDeprecationLogger;\n    module.link(\"../../lib/server/lib/deprecationWarningLogger\", {\n      apiDeprecationLogger(v) {\n        apiDeprecationLogger = v;\n      }\n    }, 1);\n    if (__reifyWaitForDeps__()) (await __reifyWaitForDeps__())();\n    const isLegacyPermissionsPayload = permissionsPayload => {\n      return Array.isArray(permissionsPayload);\n    };\n    const isLightPermissionsPayload = permissionsPayload => {\n      return typeof permissionsPayload === 'object' && Object.keys(permissionsPayload).some(key => ['GET', 'POST', 'PUT', 'DELETE', '*'].includes(key.toUpperCase())) && Object.values(permissionsPayload).every(value => Array.isArray(value));\n    };\n    const isPermissionsPayload = permissionsPayload => {\n      return typeof permissionsPayload === 'object' && Object.keys(permissionsPayload).some(key => ['GET', 'POST', 'PUT', 'DELETE', '*'].includes(key.toUpperCase())) && Object.values(permissionsPayload).every(value => typeof value === 'object' && value.operation && value.permissions);\n    };\n    async function checkPermissionsForInvocation(userId, permissionsPayload, requestMethod) {\n      const permissions = permissionsPayload[requestMethod] || permissionsPayload['*'];\n      if (!permissions) {\n        // how we reached here in the first place?\n        return false;\n      }\n      if (permissions.permissions.length === 0) {\n        // You can pass an empty array of permissions to allow access to the method\n        return true;\n      }\n      if (permissions.operation === 'hasAll') {\n        return hasAllPermissionAsync(userId, permissions.permissions);\n      }\n      if (permissions.operation === 'hasAny') {\n        return hasAtLeastOnePermissionAsync(userId, permissions.permissions);\n      }\n      return false;\n    }\n    function checkPermissions(options) {\n      if (!options.permissionsRequired) {\n        return false;\n      }\n      if (isPermissionsPayload(options.permissionsRequired)) {\n        // No modifications needed\n        return true;\n      }\n      if (isLegacyPermissionsPayload(options.permissionsRequired)) {\n        options.permissionsRequired = {\n          '*': {\n            operation: 'hasAll',\n            permissions: options.permissionsRequired\n          }\n        };\n        return true;\n      }\n      if (isLightPermissionsPayload(options.permissionsRequired)) {\n        Object.keys(options.permissionsRequired).forEach(method => {\n          const methodKey = method;\n          // @ts-expect-error -- we know the type of the value but ts refuses to infer it\n          options.permissionsRequired[methodKey] = {\n            operation: 'hasAll',\n            // @ts-expect-error -- we know the type of the value but ts refuses to infer it\n            permissions: options.permissionsRequired[methodKey]\n          };\n        });\n        return true;\n      }\n      // If reached here, options.permissionsRequired contained an invalid payload\n      return false;\n    }\n    function parseDeprecation(methodThis, _ref) {\n      let {\n        alternatives,\n        version\n      } = _ref;\n      const infoMessage = alternatives !== null && alternatives !== void 0 && alternatives.length ? \" Please use the alternative(s): \".concat(alternatives.join(',')) : '';\n      apiDeprecationLogger.endpoint(methodThis.request.route, version, methodThis.response, infoMessage);\n    }\n    __reify_async_result__();\n  } catch (_reifyError) {\n    return __reify_async_result__(_reifyError);\n  }\n  __reify_async_result__()\n}, {\n  self: this,\n  async: false\n});","map":{"version":3,"names":["module","export","checkPermissionsForInvocation","checkPermissions","parseDeprecation","hasAllPermissionAsync","hasAtLeastOnePermissionAsync","link","v","apiDeprecationLogger","__reifyWaitForDeps__","isLegacyPermissionsPayload","permissionsPayload","Array","isArray","isLightPermissionsPayload","Object","keys","some","key","includes","toUpperCase","values","every","value","isPermissionsPayload","operation","permissions","userId","requestMethod","length","options","permissionsRequired","forEach","method","methodKey","methodThis","_ref","alternatives","version","infoMessage","concat","join","endpoint","request","route","response","__reify_async_result__","_reifyError","self","async"],"sources":["app/api/server/api.helpers.ts"],"sourcesContent":["import type { IUser } from '@rocket.chat/core-typings';\n\nimport { hasAllPermissionAsync, hasAtLeastOnePermissionAsync } from '../../authorization/server/functions/hasPermission';\nimport { apiDeprecationLogger } from '../../lib/server/lib/deprecationWarningLogger';\n\ntype RequestMethod = 'GET' | 'POST' | 'PUT' | 'DELETE' | '*';\nexport type PermissionsPayload = {\n\t[key in RequestMethod]?: {\n\t\toperation: 'hasAll' | 'hasAny';\n\t\tpermissions: string[];\n\t};\n};\n\ntype PermissionsPayloadLight = {\n\t[key in RequestMethod]?: string[];\n};\n\ntype PermissionsRequiredKey = string[] | PermissionsPayload | PermissionsPayloadLight;\n\nconst isLegacyPermissionsPayload = (permissionsPayload: PermissionsRequiredKey): permissionsPayload is string[] => {\n\treturn Array.isArray(permissionsPayload);\n};\n\nconst isLightPermissionsPayload = (permissionsPayload: PermissionsRequiredKey): permissionsPayload is PermissionsPayloadLight => {\n\treturn (\n\t\ttypeof permissionsPayload === 'object' &&\n\t\tObject.keys(permissionsPayload).some((key) => ['GET', 'POST', 'PUT', 'DELETE', '*'].includes(key.toUpperCase())) &&\n\t\tObject.values(permissionsPayload).every((value) => Array.isArray(value))\n\t);\n};\n\nconst isPermissionsPayload = (permissionsPayload: PermissionsRequiredKey): permissionsPayload is PermissionsPayload => {\n\treturn (\n\t\ttypeof permissionsPayload === 'object' &&\n\t\tObject.keys(permissionsPayload).some((key) => ['GET', 'POST', 'PUT', 'DELETE', '*'].includes(key.toUpperCase())) &&\n\t\tObject.values(permissionsPayload).every((value) => typeof value === 'object' && value.operation && value.permissions)\n\t);\n};\n\nexport async function checkPermissionsForInvocation(\n\tuserId: IUser['_id'],\n\tpermissionsPayload: PermissionsPayload,\n\trequestMethod: RequestMethod,\n): Promise<boolean> {\n\tconst permissions = permissionsPayload[requestMethod] || permissionsPayload['*'];\n\n\tif (!permissions) {\n\t\t// how we reached here in the first place?\n\t\treturn false;\n\t}\n\n\tif (permissions.permissions.length === 0) {\n\t\t// You can pass an empty array of permissions to allow access to the method\n\t\treturn true;\n\t}\n\n\tif (permissions.operation === 'hasAll') {\n\t\treturn hasAllPermissionAsync(userId, permissions.permissions);\n\t}\n\n\tif (permissions.operation === 'hasAny') {\n\t\treturn hasAtLeastOnePermissionAsync(userId, permissions.permissions);\n\t}\n\n\treturn false;\n}\n\n// We'll assume options only contains permissionsRequired, as we don't care of the other elements\nexport function checkPermissions(options: { permissionsRequired?: PermissionsRequiredKey }) {\n\tif (!options.permissionsRequired) {\n\t\treturn false;\n\t}\n\n\tif (isPermissionsPayload(options.permissionsRequired)) {\n\t\t// No modifications needed\n\t\treturn true;\n\t}\n\n\tif (isLegacyPermissionsPayload(options.permissionsRequired)) {\n\t\toptions.permissionsRequired = {\n\t\t\t'*': {\n\t\t\t\toperation: 'hasAll',\n\t\t\t\tpermissions: options.permissionsRequired,\n\t\t\t},\n\t\t};\n\t\treturn true;\n\t}\n\n\tif (isLightPermissionsPayload(options.permissionsRequired)) {\n\t\tObject.keys(options.permissionsRequired).forEach((method) => {\n\t\t\tconst methodKey = method as RequestMethod;\n\t\t\t// @ts-expect-error -- we know the type of the value but ts refuses to infer it\n\t\t\toptions.permissionsRequired[methodKey] = {\n\t\t\t\toperation: 'hasAll',\n\t\t\t\t// @ts-expect-error -- we know the type of the value but ts refuses to infer it\n\t\t\t\tpermissions: options.permissionsRequired[methodKey],\n\t\t\t};\n\t\t});\n\t\treturn true;\n\t}\n\n\t// If reached here, options.permissionsRequired contained an invalid payload\n\treturn false;\n}\n\nexport function parseDeprecation(methodThis: any, { alternatives, version }: { version: string; alternatives?: string[] }): void {\n\tconst infoMessage = alternatives?.length ? ` Please use the alternative(s): ${alternatives.join(',')}` : '';\n\tapiDeprecationLogger.endpoint(methodThis.request.route, version, methodThis.response, infoMessage);\n}\n"],"mappings":"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","ignoreList":[]},"sourceType":"module","externalDependencies":{},"hash":"8414bc3eeef40473861bd1ceb375caf32f487688"}
