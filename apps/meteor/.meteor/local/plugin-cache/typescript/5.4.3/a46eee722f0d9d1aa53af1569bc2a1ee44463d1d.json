{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/app/api/server/v1/cloud.ts","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","topLevelAwait","objectRestSpread","objectRestSpread","asyncGenerators","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"os.osx.arm64"},"sourceFileName":"app/api/server/v1/cloud.ts","filename":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/app/api/server/v1/cloud.ts","inputSourceMap":{"version":3,"file":"app/api/server/v1/cloud.ts","sourceRoot":"","sources":["app/api/server/v1/cloud.ts"],"names":[],"mappings":"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","sourcesContent":["import { isCloudConfirmationPollProps, isCloudCreateRegistrationIntentProps, isCloudManualRegisterProps } from '@rocket.chat/rest-typings';\n\nimport { CloudWorkspaceRegistrationError } from '../../../../lib/errors/CloudWorkspaceRegistrationError';\nimport { SystemLogger } from '../../../../server/lib/logger/system';\nimport { hasRoleAsync } from '../../../authorization/server/functions/hasRole';\nimport { getCheckoutUrl } from '../../../cloud/server/functions/getCheckoutUrl';\nimport { getConfirmationPoll } from '../../../cloud/server/functions/getConfirmationPoll';\nimport {\n\tCloudWorkspaceAccessTokenEmptyError,\n\tCloudWorkspaceAccessTokenError,\n} from '../../../cloud/server/functions/getWorkspaceAccessToken';\nimport { registerPreIntentWorkspaceWizard } from '../../../cloud/server/functions/registerPreIntentWorkspaceWizard';\nimport { removeLicense } from '../../../cloud/server/functions/removeLicense';\nimport { retrieveRegistrationStatus } from '../../../cloud/server/functions/retrieveRegistrationStatus';\nimport { saveRegistrationData, saveRegistrationDataManual } from '../../../cloud/server/functions/saveRegistrationData';\nimport { startRegisterWorkspaceSetupWizard } from '../../../cloud/server/functions/startRegisterWorkspaceSetupWizard';\nimport { syncWorkspace } from '../../../cloud/server/functions/syncWorkspace';\nimport { API } from '../api';\n\nAPI.v1.addRoute(\n\t'cloud.manualRegister',\n\t{ authRequired: true, permissionsRequired: ['register-on-cloud'], validateParams: isCloudManualRegisterProps },\n\t{\n\t\tasync post() {\n\t\t\tconst registrationInfo = await retrieveRegistrationStatus();\n\n\t\t\tif (registrationInfo.workspaceRegistered) {\n\t\t\t\treturn API.v1.failure('Workspace is already registered');\n\t\t\t}\n\n\t\t\tconst settingsData = JSON.parse(Buffer.from(this.bodyParams.cloudBlob, 'base64').toString());\n\n\t\t\tawait saveRegistrationDataManual(settingsData);\n\n\t\t\treturn API.v1.success();\n\t\t},\n\t},\n);\n\nAPI.v1.addRoute(\n\t'cloud.createRegistrationIntent',\n\t{ authRequired: true, permissionsRequired: ['manage-cloud'], validateParams: isCloudCreateRegistrationIntentProps },\n\t{\n\t\tasync post() {\n\t\t\tconst intentData = await startRegisterWorkspaceSetupWizard(this.bodyParams.resend, this.bodyParams.email);\n\n\t\t\tif (intentData) {\n\t\t\t\treturn API.v1.success({ intentData });\n\t\t\t}\n\n\t\t\treturn API.v1.failure('Invalid query');\n\t\t},\n\t},\n);\n\nAPI.v1.addRoute(\n\t'cloud.registerPreIntent',\n\t{ authRequired: true, permissionsRequired: ['manage-cloud'] },\n\t{\n\t\tasync post() {\n\t\t\treturn API.v1.success({ offline: !(await registerPreIntentWorkspaceWizard()) });\n\t\t},\n\t},\n);\n\nAPI.v1.addRoute(\n\t'cloud.confirmationPoll',\n\t{ authRequired: true, permissionsRequired: ['manage-cloud'], validateParams: isCloudConfirmationPollProps },\n\t{\n\t\tasync get() {\n\t\t\tconst { deviceCode } = this.queryParams;\n\n\t\t\tconst pollData = await getConfirmationPoll(deviceCode);\n\t\t\tif (pollData) {\n\t\t\t\tif ('successful' in pollData && pollData.successful) {\n\t\t\t\t\tawait saveRegistrationData(pollData.payload);\n\t\t\t\t}\n\t\t\t\treturn API.v1.success({ pollData });\n\t\t\t}\n\n\t\t\treturn API.v1.failure('Invalid query');\n\t\t},\n\t},\n);\n\nAPI.v1.addRoute(\n\t'cloud.registrationStatus',\n\t{ authRequired: true },\n\t{\n\t\tasync get() {\n\t\t\tif (!(await hasRoleAsync(this.userId, 'admin'))) {\n\t\t\t\treturn API.v1.unauthorized();\n\t\t\t}\n\n\t\t\tconst registrationStatus = await retrieveRegistrationStatus();\n\n\t\t\treturn API.v1.success({ registrationStatus });\n\t\t},\n\t},\n);\n\nAPI.v1.addRoute(\n\t'cloud.syncWorkspace',\n\t{\n\t\tauthRequired: true,\n\t\tpermissionsRequired: ['manage-cloud'],\n\t\trateLimiterOptions: { numRequestsAllowed: 2, intervalTimeInMS: 60000 },\n\t},\n\t{\n\t\tasync post() {\n\t\t\ttry {\n\t\t\t\tawait syncWorkspace();\n\n\t\t\t\treturn API.v1.success({ success: true });\n\t\t\t} catch (error) {\n\t\t\t\treturn API.v1.failure('Error during workspace sync');\n\t\t\t}\n\t\t},\n\t},\n);\n\nAPI.v1.addRoute(\n\t'cloud.removeLicense',\n\t{\n\t\tauthRequired: true,\n\t\tpermissionsRequired: ['manage-cloud'],\n\t\trateLimiterOptions: { numRequestsAllowed: 2, intervalTimeInMS: 60000 },\n\t},\n\t{\n\t\tasync post() {\n\t\t\ttry {\n\t\t\t\tawait removeLicense();\n\t\t\t\treturn API.v1.success({ success: true });\n\t\t\t} catch (error) {\n\t\t\t\tswitch (true) {\n\t\t\t\t\tcase error instanceof CloudWorkspaceRegistrationError:\n\t\t\t\t\tcase error instanceof CloudWorkspaceAccessTokenEmptyError:\n\t\t\t\t\tcase error instanceof CloudWorkspaceAccessTokenError: {\n\t\t\t\t\t\tSystemLogger.info({\n\t\t\t\t\t\t\tmsg: 'Manual license removal failed',\n\t\t\t\t\t\t\tendpoint: 'cloud.removeLicense',\n\t\t\t\t\t\t\terror,\n\t\t\t\t\t\t});\n\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\t\t\t\t\tdefault: {\n\t\t\t\t\t\tSystemLogger.error({\n\t\t\t\t\t\t\tmsg: 'Manual license removal failed',\n\t\t\t\t\t\t\tendpoint: 'cloud.removeLicense',\n\t\t\t\t\t\t\terror,\n\t\t\t\t\t\t});\n\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t\treturn API.v1.failure('License removal failed');\n\t\t},\n\t},\n);\n\n/**\n * Declaring endpoint here because we don't want this available to the sdk client\n */\ndeclare module '@rocket.chat/rest-typings' {\n\t// eslint-disable-next-line @typescript-eslint/naming-convention\n\tinterface Endpoints {\n\t\t'/v1/cloud.checkoutUrl': {\n\t\t\tGET: () => { url: string };\n\t\t};\n\t}\n}\n\nAPI.v1.addRoute(\n\t'cloud.checkoutUrl',\n\t{ authRequired: true, permissionsRequired: ['manage-cloud'] },\n\t{\n\t\tasync get() {\n\t\t\tconst checkoutUrl = await getCheckoutUrl();\n\n\t\t\tif (!checkoutUrl.url) {\n\t\t\t\treturn API.v1.failure();\n\t\t\t}\n\n\t\t\treturn API.v1.success({ url: checkoutUrl.url });\n\t\t},\n\t},\n);\n"]},"targets":{"android":"125.0.0","chrome":"125.0.0","edge":"125.0.0","firefox":"115.0.0","ie":"10.0.0","ios":"17.4.0","opera":"110.0.0","opera_mobile":"80.0.0","safari":"17.4.0","samsung":"24.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor","root":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":false,"enforceStrictMode":false,"dynamicImport":true,"generateLetDeclarations":true,"topLevelAwait":true},"externalDependencies":[]},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"version":"7.17.2","helpers":true,"useESModules":false,"corejs":false},"externalDependencies":[]},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-async-generator-functions","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-class-properties","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true},"externalDependencies":[]},{"key":"transform-react-jsx","visitor":{"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXFragment":{"exit":[null]},"JSXElement":{"exit":[null]},"JSXAttribute":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false},"externalDependencies":[]},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-nullish-coalescing-operator","visitor":{"LogicalExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-optional-chaining","visitor":{"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-optional-catch-binding","visitor":{"CatchClause":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-class-properties","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-async-generator-functions","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-logical-assignment-operators","visitor":{"AssignmentExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]}],"presets":[],"generatorOpts":{"filename":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/app/api/server/v1/cloud.ts","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"app/api/server/v1/cloud.ts","inputSourceMap":{"version":3,"file":"app/api/server/v1/cloud.ts","sourceRoot":"","sources":["app/api/server/v1/cloud.ts"],"names":[],"mappings":"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","sourcesContent":["import { isCloudConfirmationPollProps, isCloudCreateRegistrationIntentProps, isCloudManualRegisterProps } from '@rocket.chat/rest-typings';\n\nimport { CloudWorkspaceRegistrationError } from '../../../../lib/errors/CloudWorkspaceRegistrationError';\nimport { SystemLogger } from '../../../../server/lib/logger/system';\nimport { hasRoleAsync } from '../../../authorization/server/functions/hasRole';\nimport { getCheckoutUrl } from '../../../cloud/server/functions/getCheckoutUrl';\nimport { getConfirmationPoll } from '../../../cloud/server/functions/getConfirmationPoll';\nimport {\n\tCloudWorkspaceAccessTokenEmptyError,\n\tCloudWorkspaceAccessTokenError,\n} from '../../../cloud/server/functions/getWorkspaceAccessToken';\nimport { registerPreIntentWorkspaceWizard } from '../../../cloud/server/functions/registerPreIntentWorkspaceWizard';\nimport { removeLicense } from '../../../cloud/server/functions/removeLicense';\nimport { retrieveRegistrationStatus } from '../../../cloud/server/functions/retrieveRegistrationStatus';\nimport { saveRegistrationData, saveRegistrationDataManual } from '../../../cloud/server/functions/saveRegistrationData';\nimport { startRegisterWorkspaceSetupWizard } from '../../../cloud/server/functions/startRegisterWorkspaceSetupWizard';\nimport { syncWorkspace } from '../../../cloud/server/functions/syncWorkspace';\nimport { API } from '../api';\n\nAPI.v1.addRoute(\n\t'cloud.manualRegister',\n\t{ authRequired: true, permissionsRequired: ['register-on-cloud'], validateParams: isCloudManualRegisterProps },\n\t{\n\t\tasync post() {\n\t\t\tconst registrationInfo = await retrieveRegistrationStatus();\n\n\t\t\tif (registrationInfo.workspaceRegistered) {\n\t\t\t\treturn API.v1.failure('Workspace is already registered');\n\t\t\t}\n\n\t\t\tconst settingsData = JSON.parse(Buffer.from(this.bodyParams.cloudBlob, 'base64').toString());\n\n\t\t\tawait saveRegistrationDataManual(settingsData);\n\n\t\t\treturn API.v1.success();\n\t\t},\n\t},\n);\n\nAPI.v1.addRoute(\n\t'cloud.createRegistrationIntent',\n\t{ authRequired: true, permissionsRequired: ['manage-cloud'], validateParams: isCloudCreateRegistrationIntentProps },\n\t{\n\t\tasync post() {\n\t\t\tconst intentData = await startRegisterWorkspaceSetupWizard(this.bodyParams.resend, this.bodyParams.email);\n\n\t\t\tif (intentData) {\n\t\t\t\treturn API.v1.success({ intentData });\n\t\t\t}\n\n\t\t\treturn API.v1.failure('Invalid query');\n\t\t},\n\t},\n);\n\nAPI.v1.addRoute(\n\t'cloud.registerPreIntent',\n\t{ authRequired: true, permissionsRequired: ['manage-cloud'] },\n\t{\n\t\tasync post() {\n\t\t\treturn API.v1.success({ offline: !(await registerPreIntentWorkspaceWizard()) });\n\t\t},\n\t},\n);\n\nAPI.v1.addRoute(\n\t'cloud.confirmationPoll',\n\t{ authRequired: true, permissionsRequired: ['manage-cloud'], validateParams: isCloudConfirmationPollProps },\n\t{\n\t\tasync get() {\n\t\t\tconst { deviceCode } = this.queryParams;\n\n\t\t\tconst pollData = await getConfirmationPoll(deviceCode);\n\t\t\tif (pollData) {\n\t\t\t\tif ('successful' in pollData && pollData.successful) {\n\t\t\t\t\tawait saveRegistrationData(pollData.payload);\n\t\t\t\t}\n\t\t\t\treturn API.v1.success({ pollData });\n\t\t\t}\n\n\t\t\treturn API.v1.failure('Invalid query');\n\t\t},\n\t},\n);\n\nAPI.v1.addRoute(\n\t'cloud.registrationStatus',\n\t{ authRequired: true },\n\t{\n\t\tasync get() {\n\t\t\tif (!(await hasRoleAsync(this.userId, 'admin'))) {\n\t\t\t\treturn API.v1.unauthorized();\n\t\t\t}\n\n\t\t\tconst registrationStatus = await retrieveRegistrationStatus();\n\n\t\t\treturn API.v1.success({ registrationStatus });\n\t\t},\n\t},\n);\n\nAPI.v1.addRoute(\n\t'cloud.syncWorkspace',\n\t{\n\t\tauthRequired: true,\n\t\tpermissionsRequired: ['manage-cloud'],\n\t\trateLimiterOptions: { numRequestsAllowed: 2, intervalTimeInMS: 60000 },\n\t},\n\t{\n\t\tasync post() {\n\t\t\ttry {\n\t\t\t\tawait syncWorkspace();\n\n\t\t\t\treturn API.v1.success({ success: true });\n\t\t\t} catch (error) {\n\t\t\t\treturn API.v1.failure('Error during workspace sync');\n\t\t\t}\n\t\t},\n\t},\n);\n\nAPI.v1.addRoute(\n\t'cloud.removeLicense',\n\t{\n\t\tauthRequired: true,\n\t\tpermissionsRequired: ['manage-cloud'],\n\t\trateLimiterOptions: { numRequestsAllowed: 2, intervalTimeInMS: 60000 },\n\t},\n\t{\n\t\tasync post() {\n\t\t\ttry {\n\t\t\t\tawait removeLicense();\n\t\t\t\treturn API.v1.success({ success: true });\n\t\t\t} catch (error) {\n\t\t\t\tswitch (true) {\n\t\t\t\t\tcase error instanceof CloudWorkspaceRegistrationError:\n\t\t\t\t\tcase error instanceof CloudWorkspaceAccessTokenEmptyError:\n\t\t\t\t\tcase error instanceof CloudWorkspaceAccessTokenError: {\n\t\t\t\t\t\tSystemLogger.info({\n\t\t\t\t\t\t\tmsg: 'Manual license removal failed',\n\t\t\t\t\t\t\tendpoint: 'cloud.removeLicense',\n\t\t\t\t\t\t\terror,\n\t\t\t\t\t\t});\n\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\t\t\t\t\tdefault: {\n\t\t\t\t\t\tSystemLogger.error({\n\t\t\t\t\t\t\tmsg: 'Manual license removal failed',\n\t\t\t\t\t\t\tendpoint: 'cloud.removeLicense',\n\t\t\t\t\t\t\terror,\n\t\t\t\t\t\t});\n\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t\treturn API.v1.failure('License removal failed');\n\t\t},\n\t},\n);\n\n/**\n * Declaring endpoint here because we don't want this available to the sdk client\n */\ndeclare module '@rocket.chat/rest-typings' {\n\t// eslint-disable-next-line @typescript-eslint/naming-convention\n\tinterface Endpoints {\n\t\t'/v1/cloud.checkoutUrl': {\n\t\t\tGET: () => { url: string };\n\t\t};\n\t}\n}\n\nAPI.v1.addRoute(\n\t'cloud.checkoutUrl',\n\t{ authRequired: true, permissionsRequired: ['manage-cloud'] },\n\t{\n\t\tasync get() {\n\t\t\tconst checkoutUrl = await getCheckoutUrl();\n\n\t\t\tif (!checkoutUrl.url) {\n\t\t\t\treturn API.v1.failure();\n\t\t\t}\n\n\t\t\treturn API.v1.success({ url: checkoutUrl.url });\n\t\t},\n\t},\n);\n"]}}},"code":"!module.wrapAsync(async function (module, __reifyWaitForDeps__, __reify_async_result__) {\n  \"use strict\";\n  try {\n    let isCloudConfirmationPollProps, isCloudCreateRegistrationIntentProps, isCloudManualRegisterProps;\n    module.link(\"@rocket.chat/rest-typings\", {\n      isCloudConfirmationPollProps(v) {\n        isCloudConfirmationPollProps = v;\n      },\n      isCloudCreateRegistrationIntentProps(v) {\n        isCloudCreateRegistrationIntentProps = v;\n      },\n      isCloudManualRegisterProps(v) {\n        isCloudManualRegisterProps = v;\n      }\n    }, 0);\n    let CloudWorkspaceRegistrationError;\n    module.link(\"../../../../lib/errors/CloudWorkspaceRegistrationError\", {\n      CloudWorkspaceRegistrationError(v) {\n        CloudWorkspaceRegistrationError = v;\n      }\n    }, 1);\n    let SystemLogger;\n    module.link(\"../../../../server/lib/logger/system\", {\n      SystemLogger(v) {\n        SystemLogger = v;\n      }\n    }, 2);\n    let hasRoleAsync;\n    module.link(\"../../../authorization/server/functions/hasRole\", {\n      hasRoleAsync(v) {\n        hasRoleAsync = v;\n      }\n    }, 3);\n    let getCheckoutUrl;\n    module.link(\"../../../cloud/server/functions/getCheckoutUrl\", {\n      getCheckoutUrl(v) {\n        getCheckoutUrl = v;\n      }\n    }, 4);\n    let getConfirmationPoll;\n    module.link(\"../../../cloud/server/functions/getConfirmationPoll\", {\n      getConfirmationPoll(v) {\n        getConfirmationPoll = v;\n      }\n    }, 5);\n    let CloudWorkspaceAccessTokenEmptyError, CloudWorkspaceAccessTokenError;\n    module.link(\"../../../cloud/server/functions/getWorkspaceAccessToken\", {\n      CloudWorkspaceAccessTokenEmptyError(v) {\n        CloudWorkspaceAccessTokenEmptyError = v;\n      },\n      CloudWorkspaceAccessTokenError(v) {\n        CloudWorkspaceAccessTokenError = v;\n      }\n    }, 6);\n    let registerPreIntentWorkspaceWizard;\n    module.link(\"../../../cloud/server/functions/registerPreIntentWorkspaceWizard\", {\n      registerPreIntentWorkspaceWizard(v) {\n        registerPreIntentWorkspaceWizard = v;\n      }\n    }, 7);\n    let removeLicense;\n    module.link(\"../../../cloud/server/functions/removeLicense\", {\n      removeLicense(v) {\n        removeLicense = v;\n      }\n    }, 8);\n    let retrieveRegistrationStatus;\n    module.link(\"../../../cloud/server/functions/retrieveRegistrationStatus\", {\n      retrieveRegistrationStatus(v) {\n        retrieveRegistrationStatus = v;\n      }\n    }, 9);\n    let saveRegistrationData, saveRegistrationDataManual;\n    module.link(\"../../../cloud/server/functions/saveRegistrationData\", {\n      saveRegistrationData(v) {\n        saveRegistrationData = v;\n      },\n      saveRegistrationDataManual(v) {\n        saveRegistrationDataManual = v;\n      }\n    }, 10);\n    let startRegisterWorkspaceSetupWizard;\n    module.link(\"../../../cloud/server/functions/startRegisterWorkspaceSetupWizard\", {\n      startRegisterWorkspaceSetupWizard(v) {\n        startRegisterWorkspaceSetupWizard = v;\n      }\n    }, 11);\n    let syncWorkspace;\n    module.link(\"../../../cloud/server/functions/syncWorkspace\", {\n      syncWorkspace(v) {\n        syncWorkspace = v;\n      }\n    }, 12);\n    let API;\n    module.link(\"../api\", {\n      API(v) {\n        API = v;\n      }\n    }, 13);\n    if (__reifyWaitForDeps__()) (await __reifyWaitForDeps__())();\n    API.v1.addRoute('cloud.manualRegister', {\n      authRequired: true,\n      permissionsRequired: ['register-on-cloud'],\n      validateParams: isCloudManualRegisterProps\n    }, {\n      async post() {\n        const registrationInfo = await retrieveRegistrationStatus();\n        if (registrationInfo.workspaceRegistered) {\n          return API.v1.failure('Workspace is already registered');\n        }\n        const settingsData = JSON.parse(Buffer.from(this.bodyParams.cloudBlob, 'base64').toString());\n        await saveRegistrationDataManual(settingsData);\n        return API.v1.success();\n      }\n    });\n    API.v1.addRoute('cloud.createRegistrationIntent', {\n      authRequired: true,\n      permissionsRequired: ['manage-cloud'],\n      validateParams: isCloudCreateRegistrationIntentProps\n    }, {\n      async post() {\n        const intentData = await startRegisterWorkspaceSetupWizard(this.bodyParams.resend, this.bodyParams.email);\n        if (intentData) {\n          return API.v1.success({\n            intentData\n          });\n        }\n        return API.v1.failure('Invalid query');\n      }\n    });\n    API.v1.addRoute('cloud.registerPreIntent', {\n      authRequired: true,\n      permissionsRequired: ['manage-cloud']\n    }, {\n      async post() {\n        return API.v1.success({\n          offline: !(await registerPreIntentWorkspaceWizard())\n        });\n      }\n    });\n    API.v1.addRoute('cloud.confirmationPoll', {\n      authRequired: true,\n      permissionsRequired: ['manage-cloud'],\n      validateParams: isCloudConfirmationPollProps\n    }, {\n      async get() {\n        const {\n          deviceCode\n        } = this.queryParams;\n        const pollData = await getConfirmationPoll(deviceCode);\n        if (pollData) {\n          if ('successful' in pollData && pollData.successful) {\n            await saveRegistrationData(pollData.payload);\n          }\n          return API.v1.success({\n            pollData\n          });\n        }\n        return API.v1.failure('Invalid query');\n      }\n    });\n    API.v1.addRoute('cloud.registrationStatus', {\n      authRequired: true\n    }, {\n      async get() {\n        if (!(await hasRoleAsync(this.userId, 'admin'))) {\n          return API.v1.unauthorized();\n        }\n        const registrationStatus = await retrieveRegistrationStatus();\n        return API.v1.success({\n          registrationStatus\n        });\n      }\n    });\n    API.v1.addRoute('cloud.syncWorkspace', {\n      authRequired: true,\n      permissionsRequired: ['manage-cloud'],\n      rateLimiterOptions: {\n        numRequestsAllowed: 2,\n        intervalTimeInMS: 60000\n      }\n    }, {\n      async post() {\n        try {\n          await syncWorkspace();\n          return API.v1.success({\n            success: true\n          });\n        } catch (error) {\n          return API.v1.failure('Error during workspace sync');\n        }\n      }\n    });\n    API.v1.addRoute('cloud.removeLicense', {\n      authRequired: true,\n      permissionsRequired: ['manage-cloud'],\n      rateLimiterOptions: {\n        numRequestsAllowed: 2,\n        intervalTimeInMS: 60000\n      }\n    }, {\n      async post() {\n        try {\n          await removeLicense();\n          return API.v1.success({\n            success: true\n          });\n        } catch (error) {\n          switch (true) {\n            case error instanceof CloudWorkspaceRegistrationError:\n            case error instanceof CloudWorkspaceAccessTokenEmptyError:\n            case error instanceof CloudWorkspaceAccessTokenError:\n              {\n                SystemLogger.info({\n                  msg: 'Manual license removal failed',\n                  endpoint: 'cloud.removeLicense',\n                  error\n                });\n                break;\n              }\n            default:\n              {\n                SystemLogger.error({\n                  msg: 'Manual license removal failed',\n                  endpoint: 'cloud.removeLicense',\n                  error\n                });\n                break;\n              }\n          }\n        }\n        return API.v1.failure('License removal failed');\n      }\n    });\n    API.v1.addRoute('cloud.checkoutUrl', {\n      authRequired: true,\n      permissionsRequired: ['manage-cloud']\n    }, {\n      async get() {\n        const checkoutUrl = await getCheckoutUrl();\n        if (!checkoutUrl.url) {\n          return API.v1.failure();\n        }\n        return API.v1.success({\n          url: checkoutUrl.url\n        });\n      }\n    });\n    __reify_async_result__();\n  } catch (_reifyError) {\n    return __reify_async_result__(_reifyError);\n  }\n  __reify_async_result__()\n}, {\n  self: this,\n  async: false\n});","map":{"version":3,"names":["isCloudConfirmationPollProps","isCloudCreateRegistrationIntentProps","isCloudManualRegisterProps","module","link","v","CloudWorkspaceRegistrationError","SystemLogger","hasRoleAsync","getCheckoutUrl","getConfirmationPoll","CloudWorkspaceAccessTokenEmptyError","CloudWorkspaceAccessTokenError","registerPreIntentWorkspaceWizard","removeLicense","retrieveRegistrationStatus","saveRegistrationData","saveRegistrationDataManual","startRegisterWorkspaceSetupWizard","syncWorkspace","API","__reifyWaitForDeps__","v1","addRoute","authRequired","permissionsRequired","validateParams","post","registrationInfo","workspaceRegistered","failure","settingsData","JSON","parse","Buffer","from","bodyParams","cloudBlob","toString","success","intentData","resend","email","offline","get","deviceCode","queryParams","pollData","successful","payload","userId","unauthorized","registrationStatus","rateLimiterOptions","numRequestsAllowed","intervalTimeInMS","error","info","msg","endpoint","checkoutUrl","url","__reify_async_result__","_reifyError","self","async"],"sources":["app/api/server/v1/cloud.ts"],"sourcesContent":["import { isCloudConfirmationPollProps, isCloudCreateRegistrationIntentProps, isCloudManualRegisterProps } from '@rocket.chat/rest-typings';\n\nimport { CloudWorkspaceRegistrationError } from '../../../../lib/errors/CloudWorkspaceRegistrationError';\nimport { SystemLogger } from '../../../../server/lib/logger/system';\nimport { hasRoleAsync } from '../../../authorization/server/functions/hasRole';\nimport { getCheckoutUrl } from '../../../cloud/server/functions/getCheckoutUrl';\nimport { getConfirmationPoll } from '../../../cloud/server/functions/getConfirmationPoll';\nimport {\n\tCloudWorkspaceAccessTokenEmptyError,\n\tCloudWorkspaceAccessTokenError,\n} from '../../../cloud/server/functions/getWorkspaceAccessToken';\nimport { registerPreIntentWorkspaceWizard } from '../../../cloud/server/functions/registerPreIntentWorkspaceWizard';\nimport { removeLicense } from '../../../cloud/server/functions/removeLicense';\nimport { retrieveRegistrationStatus } from '../../../cloud/server/functions/retrieveRegistrationStatus';\nimport { saveRegistrationData, saveRegistrationDataManual } from '../../../cloud/server/functions/saveRegistrationData';\nimport { startRegisterWorkspaceSetupWizard } from '../../../cloud/server/functions/startRegisterWorkspaceSetupWizard';\nimport { syncWorkspace } from '../../../cloud/server/functions/syncWorkspace';\nimport { API } from '../api';\n\nAPI.v1.addRoute(\n\t'cloud.manualRegister',\n\t{ authRequired: true, permissionsRequired: ['register-on-cloud'], validateParams: isCloudManualRegisterProps },\n\t{\n\t\tasync post() {\n\t\t\tconst registrationInfo = await retrieveRegistrationStatus();\n\n\t\t\tif (registrationInfo.workspaceRegistered) {\n\t\t\t\treturn API.v1.failure('Workspace is already registered');\n\t\t\t}\n\n\t\t\tconst settingsData = JSON.parse(Buffer.from(this.bodyParams.cloudBlob, 'base64').toString());\n\n\t\t\tawait saveRegistrationDataManual(settingsData);\n\n\t\t\treturn API.v1.success();\n\t\t},\n\t},\n);\n\nAPI.v1.addRoute(\n\t'cloud.createRegistrationIntent',\n\t{ authRequired: true, permissionsRequired: ['manage-cloud'], validateParams: isCloudCreateRegistrationIntentProps },\n\t{\n\t\tasync post() {\n\t\t\tconst intentData = await startRegisterWorkspaceSetupWizard(this.bodyParams.resend, this.bodyParams.email);\n\n\t\t\tif (intentData) {\n\t\t\t\treturn API.v1.success({ intentData });\n\t\t\t}\n\n\t\t\treturn API.v1.failure('Invalid query');\n\t\t},\n\t},\n);\n\nAPI.v1.addRoute(\n\t'cloud.registerPreIntent',\n\t{ authRequired: true, permissionsRequired: ['manage-cloud'] },\n\t{\n\t\tasync post() {\n\t\t\treturn API.v1.success({ offline: !(await registerPreIntentWorkspaceWizard()) });\n\t\t},\n\t},\n);\n\nAPI.v1.addRoute(\n\t'cloud.confirmationPoll',\n\t{ authRequired: true, permissionsRequired: ['manage-cloud'], validateParams: isCloudConfirmationPollProps },\n\t{\n\t\tasync get() {\n\t\t\tconst { deviceCode } = this.queryParams;\n\n\t\t\tconst pollData = await getConfirmationPoll(deviceCode);\n\t\t\tif (pollData) {\n\t\t\t\tif ('successful' in pollData && pollData.successful) {\n\t\t\t\t\tawait saveRegistrationData(pollData.payload);\n\t\t\t\t}\n\t\t\t\treturn API.v1.success({ pollData });\n\t\t\t}\n\n\t\t\treturn API.v1.failure('Invalid query');\n\t\t},\n\t},\n);\n\nAPI.v1.addRoute(\n\t'cloud.registrationStatus',\n\t{ authRequired: true },\n\t{\n\t\tasync get() {\n\t\t\tif (!(await hasRoleAsync(this.userId, 'admin'))) {\n\t\t\t\treturn API.v1.unauthorized();\n\t\t\t}\n\n\t\t\tconst registrationStatus = await retrieveRegistrationStatus();\n\n\t\t\treturn API.v1.success({ registrationStatus });\n\t\t},\n\t},\n);\n\nAPI.v1.addRoute(\n\t'cloud.syncWorkspace',\n\t{\n\t\tauthRequired: true,\n\t\tpermissionsRequired: ['manage-cloud'],\n\t\trateLimiterOptions: { numRequestsAllowed: 2, intervalTimeInMS: 60000 },\n\t},\n\t{\n\t\tasync post() {\n\t\t\ttry {\n\t\t\t\tawait syncWorkspace();\n\n\t\t\t\treturn API.v1.success({ success: true });\n\t\t\t} catch (error) {\n\t\t\t\treturn API.v1.failure('Error during workspace sync');\n\t\t\t}\n\t\t},\n\t},\n);\n\nAPI.v1.addRoute(\n\t'cloud.removeLicense',\n\t{\n\t\tauthRequired: true,\n\t\tpermissionsRequired: ['manage-cloud'],\n\t\trateLimiterOptions: { numRequestsAllowed: 2, intervalTimeInMS: 60000 },\n\t},\n\t{\n\t\tasync post() {\n\t\t\ttry {\n\t\t\t\tawait removeLicense();\n\t\t\t\treturn API.v1.success({ success: true });\n\t\t\t} catch (error) {\n\t\t\t\tswitch (true) {\n\t\t\t\t\tcase error instanceof CloudWorkspaceRegistrationError:\n\t\t\t\t\tcase error instanceof CloudWorkspaceAccessTokenEmptyError:\n\t\t\t\t\tcase error instanceof CloudWorkspaceAccessTokenError: {\n\t\t\t\t\t\tSystemLogger.info({\n\t\t\t\t\t\t\tmsg: 'Manual license removal failed',\n\t\t\t\t\t\t\tendpoint: 'cloud.removeLicense',\n\t\t\t\t\t\t\terror,\n\t\t\t\t\t\t});\n\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\t\t\t\t\tdefault: {\n\t\t\t\t\t\tSystemLogger.error({\n\t\t\t\t\t\t\tmsg: 'Manual license removal failed',\n\t\t\t\t\t\t\tendpoint: 'cloud.removeLicense',\n\t\t\t\t\t\t\terror,\n\t\t\t\t\t\t});\n\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t\treturn API.v1.failure('License removal failed');\n\t\t},\n\t},\n);\n\n/**\n * Declaring endpoint here because we don't want this available to the sdk client\n */\ndeclare module '@rocket.chat/rest-typings' {\n\t// eslint-disable-next-line @typescript-eslint/naming-convention\n\tinterface Endpoints {\n\t\t'/v1/cloud.checkoutUrl': {\n\t\t\tGET: () => { url: string };\n\t\t};\n\t}\n}\n\nAPI.v1.addRoute(\n\t'cloud.checkoutUrl',\n\t{ authRequired: true, permissionsRequired: ['manage-cloud'] },\n\t{\n\t\tasync get() {\n\t\t\tconst checkoutUrl = await getCheckoutUrl();\n\n\t\t\tif (!checkoutUrl.url) {\n\t\t\t\treturn API.v1.failure();\n\t\t\t}\n\n\t\t\treturn API.v1.success({ url: checkoutUrl.url });\n\t\t},\n\t},\n);\n"],"mappings":"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","ignoreList":[]},"sourceType":"module","externalDependencies":{},"hash":"a46eee722f0d9d1aa53af1569bc2a1ee44463d1d"}
