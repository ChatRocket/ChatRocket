{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/server/ufs/ufs-methods.ts","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","topLevelAwait","objectRestSpread","objectRestSpread","asyncGenerators","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"os.osx.arm64"},"sourceFileName":"server/ufs/ufs-methods.ts","filename":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/server/ufs/ufs-methods.ts","inputSourceMap":{"version":3,"file":"server/ufs/ufs-methods.ts","sourceRoot":"","sources":["server/ufs/ufs-methods.ts"],"names":[],"mappings":"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","sourcesContent":["import fs from 'fs';\n\nimport type { IUpload } from '@rocket.chat/core-typings';\nimport { check } from 'meteor/check';\nimport { Meteor } from 'meteor/meteor';\n\nimport { UploadFS } from './ufs';\n\nexport async function ufsComplete(fileId: string, storeName: string): Promise<IUpload> {\n\tcheck(fileId, String);\n\tcheck(storeName, String);\n\n\t// Get store\n\tconst store = UploadFS.getStore(storeName);\n\tif (!store) {\n\t\tthrow new Meteor.Error('invalid-store', 'Store not found');\n\t}\n\n\tconst tmpFile = UploadFS.getTempFilePath(fileId);\n\n\tconst removeTempFile = function () {\n\t\tfs.stat(tmpFile, (err) => {\n\t\t\t!err &&\n\t\t\t\tfs.unlink(tmpFile, (err2) => {\n\t\t\t\t\terr2 && console.error(`ufs: cannot delete temp file \"${tmpFile}\" (${err2.message})`);\n\t\t\t\t});\n\t\t});\n\t};\n\n\treturn new Promise(async (resolve, reject) => {\n\t\ttry {\n\t\t\t// todo check if temp file exists\n\n\t\t\t// Get file\n\t\t\tconst file = await store.getCollection().findOne({ _id: fileId });\n\n\t\t\tif (!file) {\n\t\t\t\tthrow new Meteor.Error('invalid-file', 'File is not valid');\n\t\t\t}\n\n\t\t\t// Validate file before moving to the store\n\t\t\tawait store.validate(file);\n\n\t\t\t// Get the temp file\n\t\t\tconst rs = fs.createReadStream(tmpFile, {\n\t\t\t\tflags: 'r',\n\t\t\t\tencoding: undefined,\n\t\t\t\tautoClose: true,\n\t\t\t});\n\n\t\t\t// Clean upload if error occurs\n\t\t\trs.on('error', (err) => {\n\t\t\t\tconsole.error(err);\n\t\t\t\tvoid store.removeById(fileId);\n\t\t\t\treject(err);\n\t\t\t});\n\n\t\t\t// Save file in the store\n\t\t\tawait store.write(rs, fileId, (err, file) => {\n\t\t\t\tremoveTempFile();\n\n\t\t\t\tif (err) {\n\t\t\t\t\treturn reject(err);\n\t\t\t\t}\n\t\t\t\tif (!file) {\n\t\t\t\t\treturn reject(new Error('Unknown error writing file'));\n\t\t\t\t}\n\t\t\t\tresolve(file);\n\t\t\t});\n\t\t} catch (err: any) {\n\t\t\t// If write failed, remove the file\n\t\t\tawait store.removeById(fileId);\n\t\t\t// removeTempFile(); // todo remove temp file on error or try again ?\n\t\t\treject(new Meteor.Error('ufs: cannot upload file', err));\n\t\t}\n\t});\n}\n"]},"targets":{"android":"125.0.0","chrome":"125.0.0","edge":"125.0.0","firefox":"115.0.0","ie":"10.0.0","ios":"17.4.0","opera":"110.0.0","opera_mobile":"80.0.0","safari":"17.4.0","samsung":"24.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor","root":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":false,"enforceStrictMode":false,"dynamicImport":true,"generateLetDeclarations":true,"topLevelAwait":true},"externalDependencies":[]},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"version":"7.17.2","helpers":true,"useESModules":false,"corejs":false},"externalDependencies":[]},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-async-generator-functions","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-class-properties","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true},"externalDependencies":[]},{"key":"transform-react-jsx","visitor":{"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXFragment":{"exit":[null]},"JSXElement":{"exit":[null]},"JSXAttribute":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false},"externalDependencies":[]},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-nullish-coalescing-operator","visitor":{"LogicalExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-optional-chaining","visitor":{"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-optional-catch-binding","visitor":{"CatchClause":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-class-properties","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-async-generator-functions","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-logical-assignment-operators","visitor":{"AssignmentExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]}],"presets":[],"generatorOpts":{"filename":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/server/ufs/ufs-methods.ts","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"server/ufs/ufs-methods.ts","inputSourceMap":{"version":3,"file":"server/ufs/ufs-methods.ts","sourceRoot":"","sources":["server/ufs/ufs-methods.ts"],"names":[],"mappings":"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","sourcesContent":["import fs from 'fs';\n\nimport type { IUpload } from '@rocket.chat/core-typings';\nimport { check } from 'meteor/check';\nimport { Meteor } from 'meteor/meteor';\n\nimport { UploadFS } from './ufs';\n\nexport async function ufsComplete(fileId: string, storeName: string): Promise<IUpload> {\n\tcheck(fileId, String);\n\tcheck(storeName, String);\n\n\t// Get store\n\tconst store = UploadFS.getStore(storeName);\n\tif (!store) {\n\t\tthrow new Meteor.Error('invalid-store', 'Store not found');\n\t}\n\n\tconst tmpFile = UploadFS.getTempFilePath(fileId);\n\n\tconst removeTempFile = function () {\n\t\tfs.stat(tmpFile, (err) => {\n\t\t\t!err &&\n\t\t\t\tfs.unlink(tmpFile, (err2) => {\n\t\t\t\t\terr2 && console.error(`ufs: cannot delete temp file \"${tmpFile}\" (${err2.message})`);\n\t\t\t\t});\n\t\t});\n\t};\n\n\treturn new Promise(async (resolve, reject) => {\n\t\ttry {\n\t\t\t// todo check if temp file exists\n\n\t\t\t// Get file\n\t\t\tconst file = await store.getCollection().findOne({ _id: fileId });\n\n\t\t\tif (!file) {\n\t\t\t\tthrow new Meteor.Error('invalid-file', 'File is not valid');\n\t\t\t}\n\n\t\t\t// Validate file before moving to the store\n\t\t\tawait store.validate(file);\n\n\t\t\t// Get the temp file\n\t\t\tconst rs = fs.createReadStream(tmpFile, {\n\t\t\t\tflags: 'r',\n\t\t\t\tencoding: undefined,\n\t\t\t\tautoClose: true,\n\t\t\t});\n\n\t\t\t// Clean upload if error occurs\n\t\t\trs.on('error', (err) => {\n\t\t\t\tconsole.error(err);\n\t\t\t\tvoid store.removeById(fileId);\n\t\t\t\treject(err);\n\t\t\t});\n\n\t\t\t// Save file in the store\n\t\t\tawait store.write(rs, fileId, (err, file) => {\n\t\t\t\tremoveTempFile();\n\n\t\t\t\tif (err) {\n\t\t\t\t\treturn reject(err);\n\t\t\t\t}\n\t\t\t\tif (!file) {\n\t\t\t\t\treturn reject(new Error('Unknown error writing file'));\n\t\t\t\t}\n\t\t\t\tresolve(file);\n\t\t\t});\n\t\t} catch (err: any) {\n\t\t\t// If write failed, remove the file\n\t\t\tawait store.removeById(fileId);\n\t\t\t// removeTempFile(); // todo remove temp file on error or try again ?\n\t\t\treject(new Meteor.Error('ufs: cannot upload file', err));\n\t\t}\n\t});\n}\n"]}}},"code":"!module.wrapAsync(async function (module, __reifyWaitForDeps__, __reify_async_result__) {\n  \"use strict\";\n  try {\n    module.export({\n      ufsComplete: () => ufsComplete\n    });\n    let fs;\n    module.link(\"fs\", {\n      default(v) {\n        fs = v;\n      }\n    }, 0);\n    let check;\n    module.link(\"meteor/check\", {\n      check(v) {\n        check = v;\n      }\n    }, 1);\n    let Meteor;\n    module.link(\"meteor/meteor\", {\n      Meteor(v) {\n        Meteor = v;\n      }\n    }, 2);\n    let UploadFS;\n    module.link(\"./ufs\", {\n      UploadFS(v) {\n        UploadFS = v;\n      }\n    }, 3);\n    if (__reifyWaitForDeps__()) (await __reifyWaitForDeps__())();\n    async function ufsComplete(fileId, storeName) {\n      check(fileId, String);\n      check(storeName, String);\n      // Get store\n      const store = UploadFS.getStore(storeName);\n      if (!store) {\n        throw new Meteor.Error('invalid-store', 'Store not found');\n      }\n      const tmpFile = UploadFS.getTempFilePath(fileId);\n      const removeTempFile = function () {\n        fs.stat(tmpFile, err => {\n          !err && fs.unlink(tmpFile, err2 => {\n            err2 && console.error(\"ufs: cannot delete temp file \\\"\".concat(tmpFile, \"\\\" (\").concat(err2.message, \")\"));\n          });\n        });\n      };\n      return new Promise(async (resolve, reject) => {\n        try {\n          // todo check if temp file exists\n          // Get file\n          const file = await store.getCollection().findOne({\n            _id: fileId\n          });\n          if (!file) {\n            throw new Meteor.Error('invalid-file', 'File is not valid');\n          }\n          // Validate file before moving to the store\n          await store.validate(file);\n          // Get the temp file\n          const rs = fs.createReadStream(tmpFile, {\n            flags: 'r',\n            encoding: undefined,\n            autoClose: true\n          });\n          // Clean upload if error occurs\n          rs.on('error', err => {\n            console.error(err);\n            void store.removeById(fileId);\n            reject(err);\n          });\n          // Save file in the store\n          await store.write(rs, fileId, (err, file) => {\n            removeTempFile();\n            if (err) {\n              return reject(err);\n            }\n            if (!file) {\n              return reject(new Error('Unknown error writing file'));\n            }\n            resolve(file);\n          });\n        } catch (err) {\n          // If write failed, remove the file\n          await store.removeById(fileId);\n          // removeTempFile(); // todo remove temp file on error or try again ?\n          reject(new Meteor.Error('ufs: cannot upload file', err));\n        }\n      });\n    }\n    __reify_async_result__();\n  } catch (_reifyError) {\n    return __reify_async_result__(_reifyError);\n  }\n  __reify_async_result__()\n}, {\n  self: this,\n  async: false\n});","map":{"version":3,"names":["module","export","ufsComplete","fs","link","default","v","check","Meteor","UploadFS","__reifyWaitForDeps__","fileId","storeName","String","store","getStore","Error","tmpFile","getTempFilePath","removeTempFile","stat","err","unlink","err2","console","error","concat","message","Promise","resolve","reject","file","getCollection","findOne","_id","validate","rs","createReadStream","flags","encoding","undefined","autoClose","on","removeById","write","__reify_async_result__","_reifyError","self","async"],"sources":["server/ufs/ufs-methods.ts"],"sourcesContent":["import fs from 'fs';\n\nimport type { IUpload } from '@rocket.chat/core-typings';\nimport { check } from 'meteor/check';\nimport { Meteor } from 'meteor/meteor';\n\nimport { UploadFS } from './ufs';\n\nexport async function ufsComplete(fileId: string, storeName: string): Promise<IUpload> {\n\tcheck(fileId, String);\n\tcheck(storeName, String);\n\n\t// Get store\n\tconst store = UploadFS.getStore(storeName);\n\tif (!store) {\n\t\tthrow new Meteor.Error('invalid-store', 'Store not found');\n\t}\n\n\tconst tmpFile = UploadFS.getTempFilePath(fileId);\n\n\tconst removeTempFile = function () {\n\t\tfs.stat(tmpFile, (err) => {\n\t\t\t!err &&\n\t\t\t\tfs.unlink(tmpFile, (err2) => {\n\t\t\t\t\terr2 && console.error(`ufs: cannot delete temp file \"${tmpFile}\" (${err2.message})`);\n\t\t\t\t});\n\t\t});\n\t};\n\n\treturn new Promise(async (resolve, reject) => {\n\t\ttry {\n\t\t\t// todo check if temp file exists\n\n\t\t\t// Get file\n\t\t\tconst file = await store.getCollection().findOne({ _id: fileId });\n\n\t\t\tif (!file) {\n\t\t\t\tthrow new Meteor.Error('invalid-file', 'File is not valid');\n\t\t\t}\n\n\t\t\t// Validate file before moving to the store\n\t\t\tawait store.validate(file);\n\n\t\t\t// Get the temp file\n\t\t\tconst rs = fs.createReadStream(tmpFile, {\n\t\t\t\tflags: 'r',\n\t\t\t\tencoding: undefined,\n\t\t\t\tautoClose: true,\n\t\t\t});\n\n\t\t\t// Clean upload if error occurs\n\t\t\trs.on('error', (err) => {\n\t\t\t\tconsole.error(err);\n\t\t\t\tvoid store.removeById(fileId);\n\t\t\t\treject(err);\n\t\t\t});\n\n\t\t\t// Save file in the store\n\t\t\tawait store.write(rs, fileId, (err, file) => {\n\t\t\t\tremoveTempFile();\n\n\t\t\t\tif (err) {\n\t\t\t\t\treturn reject(err);\n\t\t\t\t}\n\t\t\t\tif (!file) {\n\t\t\t\t\treturn reject(new Error('Unknown error writing file'));\n\t\t\t\t}\n\t\t\t\tresolve(file);\n\t\t\t});\n\t\t} catch (err: any) {\n\t\t\t// If write failed, remove the file\n\t\t\tawait store.removeById(fileId);\n\t\t\t// removeTempFile(); // todo remove temp file on error or try again ?\n\t\t\treject(new Meteor.Error('ufs: cannot upload file', err));\n\t\t}\n\t});\n}\n"],"mappings":"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","ignoreList":[]},"sourceType":"module","externalDependencies":{},"hash":"98e8854d70766789c8d8fdebc78a485838fca382"}
