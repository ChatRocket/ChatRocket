{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/server/routes/avatar/utils.ts","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","topLevelAwait","objectRestSpread","objectRestSpread","asyncGenerators","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"os.osx.arm64"},"sourceFileName":"server/routes/avatar/utils.ts","filename":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/server/routes/avatar/utils.ts","inputSourceMap":{"version":3,"file":"server/routes/avatar/utils.ts","sourceRoot":"","sources":["server/routes/avatar/utils.ts"],"names":[],"mappings":"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","sourcesContent":["import type { ServerResponse } from 'http';\n\nimport { hashLoginToken } from '@rocket.chat/account-utils';\nimport type { IIncomingMessage, IUpload } from '@rocket.chat/core-typings';\nimport { Users } from '@rocket.chat/models';\nimport type { NextFunction } from 'connect';\nimport { Cookies } from 'meteor/ostrio:cookies';\nimport sharp from 'sharp';\nimport { throttle } from 'underscore';\n\nimport { FileUpload } from '../../../app/file-upload/server';\nimport { settings } from '../../../app/settings/server';\nimport { getAvatarColor } from '../../../app/utils/lib/getAvatarColor';\n\nconst FALLBACK_LAST_MODIFIED = 'Thu, 01 Jan 2015 00:00:00 GMT';\n\nconst cookie = new Cookies();\n\nexport const MAX_SVG_AVATAR_SIZE = 1024;\nexport const MIN_SVG_AVATAR_SIZE = 16;\n\nexport const serveAvatarFile = (file: IUpload, req: IIncomingMessage, res: ServerResponse, next: NextFunction) => {\n\tres.setHeader('Content-Security-Policy', \"default-src 'none'\");\n\tconst reqModifiedHeader = req.headers['if-modified-since'];\n\n\tif (reqModifiedHeader && reqModifiedHeader === file.uploadedAt?.toUTCString()) {\n\t\tres.setHeader('Last-Modified', reqModifiedHeader);\n\t\tres.writeHead(304);\n\t\tres.end();\n\t\treturn;\n\t}\n\n\tif (file.uploadedAt) {\n\t\tres.setHeader('Last-Modified', file.uploadedAt?.toUTCString());\n\t}\n\n\tif (file.type) {\n\t\tres.setHeader('Content-Type', file.type);\n\t}\n\n\tif (file.size) {\n\t\tres.setHeader('Content-Length', file.size);\n\t}\n\n\treturn FileUpload.get(file, req, res, next);\n};\n\nexport const getAvatarSizeFromRequest = (req: IIncomingMessage) => {\n\tconst requestSize = req.query.size && parseInt(req.query.size);\n\treturn Math.min(Math.max(requestSize, MIN_SVG_AVATAR_SIZE), MAX_SVG_AVATAR_SIZE);\n};\nexport const serveSvgAvatarInRequestedFormat = ({\n\tnameOrUsername,\n\treq,\n\tres,\n}: {\n\tnameOrUsername: string;\n\treq: IIncomingMessage;\n\tres: ServerResponse;\n}) => {\n\tconst size = getAvatarSizeFromRequest(req);\n\tconst avatar = renderSVGLetters(nameOrUsername, size);\n\tres.setHeader('Last-Modified', FALLBACK_LAST_MODIFIED);\n\n\tconst { format } = req.query;\n\n\tif (['png', 'jpg', 'jpeg'].includes(format)) {\n\t\tres.setHeader('Content-Type', `image/${format}`);\n\t\tsharp(Buffer.from(avatar)).toFormat(format).pipe(res);\n\t\treturn;\n\t}\n\tres.setHeader('Content-Type', 'image/svg+xml');\n\n\tres.write(avatar);\n\tres.end();\n};\n\nexport const wasFallbackModified = (reqModifiedHeader?: string) => {\n\tif (!reqModifiedHeader || reqModifiedHeader !== FALLBACK_LAST_MODIFIED) {\n\t\treturn true;\n\t}\n\treturn false;\n};\n\nasync function isUserAuthenticated({ headers, query }: Pick<IIncomingMessage, 'headers' | 'query'>) {\n\tlet { rc_uid, rc_token } = query;\n\n\tif (!rc_uid && headers.cookie) {\n\t\trc_uid = cookie.get('rc_uid', headers.cookie);\n\t\trc_token = cookie.get('rc_token', headers.cookie);\n\t}\n\n\tif (rc_uid == null || rc_token == null) {\n\t\treturn false;\n\t}\n\n\tconst userFound = await Users.findOneByIdAndLoginToken(rc_uid, hashLoginToken(rc_token), { projection: { _id: 1 } }); // TODO memoize find\n\n\treturn !!userFound;\n}\n\nconst warnUnauthenticatedAccess = throttle(() => {\n\tconsole.warn('The server detected an unauthenticated access to an user avatar. This type of request will soon be blocked by default.');\n}, 60000 * 30); // 30 minutes\n\nexport async function userCanAccessAvatar({ headers = {}, query = {} }: IIncomingMessage) {\n\tif (!settings.get('Accounts_AvatarBlockUnauthenticatedAccess')) {\n\t\treturn true;\n\t}\n\n\tconst isAuthenticated = await isUserAuthenticated({ headers, query });\n\tif (!isAuthenticated) {\n\t\twarnUnauthenticatedAccess();\n\t}\n\n\treturn isAuthenticated;\n}\n\nconst getFirstLetter = (name: string) =>\n\tname\n\t\t.replace(/[^A-Za-z0-9]/g, '')\n\t\t.substr(0, 1)\n\t\t.toUpperCase();\n\nexport const renderSVGLetters = (username: string, viewSize = 200) => {\n\tlet color = '';\n\tlet initials = '';\n\n\tif (username === '?') {\n\t\tcolor = '#000';\n\t\tinitials = username;\n\t} else {\n\t\tcolor = getAvatarColor(username);\n\t\tinitials = getFirstLetter(username);\n\t}\n\n\tconst fontSize = viewSize / 1.6;\n\n\treturn `<svg xmlns=\\\"http://www.w3.org/2000/svg\\\" viewBox=\\\"0 0 ${viewSize} ${viewSize}\\\">\\n<rect width=\\\"100%\\\" height=\\\"100%\\\" fill=\\\"${color}\\\"/>\\n<text x=\\\"50%\\\" y=\\\"50%\\\" dy=\\\"0.36em\\\" text-anchor=\\\"middle\\\" pointer-events=\\\"none\\\" fill=\\\"#ffffff\\\" font-family=\\\"'Helvetica', 'Arial', 'Lucida Grande', 'sans-serif'\\\" font-size=\"${fontSize}\">\\n${initials}\\n</text>\\n</svg>`;\n};\n\nconst getCacheTime = (cacheTime: number) => cacheTime || settings.get('Accounts_AvatarCacheTime');\n\nexport function setCacheAndDispositionHeaders(req: IIncomingMessage, res: ServerResponse) {\n\tconst cacheTime = getCacheTime(req.query.cacheTime);\n\tres.setHeader('Cache-Control', `public, max-age=${cacheTime}`);\n\tres.setHeader('Content-Disposition', 'inline');\n}\n"]},"targets":{"android":"125.0.0","chrome":"125.0.0","edge":"125.0.0","firefox":"115.0.0","ie":"10.0.0","ios":"17.4.0","opera":"110.0.0","opera_mobile":"80.0.0","safari":"17.4.0","samsung":"24.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor","root":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":false,"enforceStrictMode":false,"dynamicImport":true,"generateLetDeclarations":true,"topLevelAwait":true},"externalDependencies":[]},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"version":"7.17.2","helpers":true,"useESModules":false,"corejs":false},"externalDependencies":[]},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-async-generator-functions","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-class-properties","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true},"externalDependencies":[]},{"key":"transform-react-jsx","visitor":{"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXFragment":{"exit":[null]},"JSXElement":{"exit":[null]},"JSXAttribute":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false},"externalDependencies":[]},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-nullish-coalescing-operator","visitor":{"LogicalExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-optional-chaining","visitor":{"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-optional-catch-binding","visitor":{"CatchClause":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-class-properties","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-async-generator-functions","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-logical-assignment-operators","visitor":{"AssignmentExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]}],"presets":[],"generatorOpts":{"filename":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/server/routes/avatar/utils.ts","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"server/routes/avatar/utils.ts","inputSourceMap":{"version":3,"file":"server/routes/avatar/utils.ts","sourceRoot":"","sources":["server/routes/avatar/utils.ts"],"names":[],"mappings":"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","sourcesContent":["import type { ServerResponse } from 'http';\n\nimport { hashLoginToken } from '@rocket.chat/account-utils';\nimport type { IIncomingMessage, IUpload } from '@rocket.chat/core-typings';\nimport { Users } from '@rocket.chat/models';\nimport type { NextFunction } from 'connect';\nimport { Cookies } from 'meteor/ostrio:cookies';\nimport sharp from 'sharp';\nimport { throttle } from 'underscore';\n\nimport { FileUpload } from '../../../app/file-upload/server';\nimport { settings } from '../../../app/settings/server';\nimport { getAvatarColor } from '../../../app/utils/lib/getAvatarColor';\n\nconst FALLBACK_LAST_MODIFIED = 'Thu, 01 Jan 2015 00:00:00 GMT';\n\nconst cookie = new Cookies();\n\nexport const MAX_SVG_AVATAR_SIZE = 1024;\nexport const MIN_SVG_AVATAR_SIZE = 16;\n\nexport const serveAvatarFile = (file: IUpload, req: IIncomingMessage, res: ServerResponse, next: NextFunction) => {\n\tres.setHeader('Content-Security-Policy', \"default-src 'none'\");\n\tconst reqModifiedHeader = req.headers['if-modified-since'];\n\n\tif (reqModifiedHeader && reqModifiedHeader === file.uploadedAt?.toUTCString()) {\n\t\tres.setHeader('Last-Modified', reqModifiedHeader);\n\t\tres.writeHead(304);\n\t\tres.end();\n\t\treturn;\n\t}\n\n\tif (file.uploadedAt) {\n\t\tres.setHeader('Last-Modified', file.uploadedAt?.toUTCString());\n\t}\n\n\tif (file.type) {\n\t\tres.setHeader('Content-Type', file.type);\n\t}\n\n\tif (file.size) {\n\t\tres.setHeader('Content-Length', file.size);\n\t}\n\n\treturn FileUpload.get(file, req, res, next);\n};\n\nexport const getAvatarSizeFromRequest = (req: IIncomingMessage) => {\n\tconst requestSize = req.query.size && parseInt(req.query.size);\n\treturn Math.min(Math.max(requestSize, MIN_SVG_AVATAR_SIZE), MAX_SVG_AVATAR_SIZE);\n};\nexport const serveSvgAvatarInRequestedFormat = ({\n\tnameOrUsername,\n\treq,\n\tres,\n}: {\n\tnameOrUsername: string;\n\treq: IIncomingMessage;\n\tres: ServerResponse;\n}) => {\n\tconst size = getAvatarSizeFromRequest(req);\n\tconst avatar = renderSVGLetters(nameOrUsername, size);\n\tres.setHeader('Last-Modified', FALLBACK_LAST_MODIFIED);\n\n\tconst { format } = req.query;\n\n\tif (['png', 'jpg', 'jpeg'].includes(format)) {\n\t\tres.setHeader('Content-Type', `image/${format}`);\n\t\tsharp(Buffer.from(avatar)).toFormat(format).pipe(res);\n\t\treturn;\n\t}\n\tres.setHeader('Content-Type', 'image/svg+xml');\n\n\tres.write(avatar);\n\tres.end();\n};\n\nexport const wasFallbackModified = (reqModifiedHeader?: string) => {\n\tif (!reqModifiedHeader || reqModifiedHeader !== FALLBACK_LAST_MODIFIED) {\n\t\treturn true;\n\t}\n\treturn false;\n};\n\nasync function isUserAuthenticated({ headers, query }: Pick<IIncomingMessage, 'headers' | 'query'>) {\n\tlet { rc_uid, rc_token } = query;\n\n\tif (!rc_uid && headers.cookie) {\n\t\trc_uid = cookie.get('rc_uid', headers.cookie);\n\t\trc_token = cookie.get('rc_token', headers.cookie);\n\t}\n\n\tif (rc_uid == null || rc_token == null) {\n\t\treturn false;\n\t}\n\n\tconst userFound = await Users.findOneByIdAndLoginToken(rc_uid, hashLoginToken(rc_token), { projection: { _id: 1 } }); // TODO memoize find\n\n\treturn !!userFound;\n}\n\nconst warnUnauthenticatedAccess = throttle(() => {\n\tconsole.warn('The server detected an unauthenticated access to an user avatar. This type of request will soon be blocked by default.');\n}, 60000 * 30); // 30 minutes\n\nexport async function userCanAccessAvatar({ headers = {}, query = {} }: IIncomingMessage) {\n\tif (!settings.get('Accounts_AvatarBlockUnauthenticatedAccess')) {\n\t\treturn true;\n\t}\n\n\tconst isAuthenticated = await isUserAuthenticated({ headers, query });\n\tif (!isAuthenticated) {\n\t\twarnUnauthenticatedAccess();\n\t}\n\n\treturn isAuthenticated;\n}\n\nconst getFirstLetter = (name: string) =>\n\tname\n\t\t.replace(/[^A-Za-z0-9]/g, '')\n\t\t.substr(0, 1)\n\t\t.toUpperCase();\n\nexport const renderSVGLetters = (username: string, viewSize = 200) => {\n\tlet color = '';\n\tlet initials = '';\n\n\tif (username === '?') {\n\t\tcolor = '#000';\n\t\tinitials = username;\n\t} else {\n\t\tcolor = getAvatarColor(username);\n\t\tinitials = getFirstLetter(username);\n\t}\n\n\tconst fontSize = viewSize / 1.6;\n\n\treturn `<svg xmlns=\\\"http://www.w3.org/2000/svg\\\" viewBox=\\\"0 0 ${viewSize} ${viewSize}\\\">\\n<rect width=\\\"100%\\\" height=\\\"100%\\\" fill=\\\"${color}\\\"/>\\n<text x=\\\"50%\\\" y=\\\"50%\\\" dy=\\\"0.36em\\\" text-anchor=\\\"middle\\\" pointer-events=\\\"none\\\" fill=\\\"#ffffff\\\" font-family=\\\"'Helvetica', 'Arial', 'Lucida Grande', 'sans-serif'\\\" font-size=\"${fontSize}\">\\n${initials}\\n</text>\\n</svg>`;\n};\n\nconst getCacheTime = (cacheTime: number) => cacheTime || settings.get('Accounts_AvatarCacheTime');\n\nexport function setCacheAndDispositionHeaders(req: IIncomingMessage, res: ServerResponse) {\n\tconst cacheTime = getCacheTime(req.query.cacheTime);\n\tres.setHeader('Cache-Control', `public, max-age=${cacheTime}`);\n\tres.setHeader('Content-Disposition', 'inline');\n}\n"]}}},"code":"!module.wrapAsync(async function (module, __reifyWaitForDeps__, __reify_async_result__) {\n  \"use strict\";\n  try {\n    module.export({\n      MAX_SVG_AVATAR_SIZE: () => MAX_SVG_AVATAR_SIZE,\n      MIN_SVG_AVATAR_SIZE: () => MIN_SVG_AVATAR_SIZE,\n      serveAvatarFile: () => serveAvatarFile,\n      getAvatarSizeFromRequest: () => getAvatarSizeFromRequest,\n      serveSvgAvatarInRequestedFormat: () => serveSvgAvatarInRequestedFormat,\n      wasFallbackModified: () => wasFallbackModified,\n      userCanAccessAvatar: () => userCanAccessAvatar,\n      renderSVGLetters: () => renderSVGLetters,\n      setCacheAndDispositionHeaders: () => setCacheAndDispositionHeaders\n    });\n    let hashLoginToken;\n    module.link(\"@rocket.chat/account-utils\", {\n      hashLoginToken(v) {\n        hashLoginToken = v;\n      }\n    }, 0);\n    let Users;\n    module.link(\"@rocket.chat/models\", {\n      Users(v) {\n        Users = v;\n      }\n    }, 1);\n    let Cookies;\n    module.link(\"meteor/ostrio:cookies\", {\n      Cookies(v) {\n        Cookies = v;\n      }\n    }, 2);\n    let sharp;\n    module.link(\"sharp\", {\n      default(v) {\n        sharp = v;\n      }\n    }, 3);\n    let throttle;\n    module.link(\"underscore\", {\n      throttle(v) {\n        throttle = v;\n      }\n    }, 4);\n    let FileUpload;\n    module.link(\"../../../app/file-upload/server\", {\n      FileUpload(v) {\n        FileUpload = v;\n      }\n    }, 5);\n    let settings;\n    module.link(\"../../../app/settings/server\", {\n      settings(v) {\n        settings = v;\n      }\n    }, 6);\n    let getAvatarColor;\n    module.link(\"../../../app/utils/lib/getAvatarColor\", {\n      getAvatarColor(v) {\n        getAvatarColor = v;\n      }\n    }, 7);\n    if (__reifyWaitForDeps__()) (await __reifyWaitForDeps__())();\n    const FALLBACK_LAST_MODIFIED = 'Thu, 01 Jan 2015 00:00:00 GMT';\n    const cookie = new Cookies();\n    const MAX_SVG_AVATAR_SIZE = 1024;\n    const MIN_SVG_AVATAR_SIZE = 16;\n    const serveAvatarFile = (file, req, res, next) => {\n      var _file$uploadedAt;\n      res.setHeader('Content-Security-Policy', \"default-src 'none'\");\n      const reqModifiedHeader = req.headers['if-modified-since'];\n      if (reqModifiedHeader && reqModifiedHeader === ((_file$uploadedAt = file.uploadedAt) === null || _file$uploadedAt === void 0 ? void 0 : _file$uploadedAt.toUTCString())) {\n        res.setHeader('Last-Modified', reqModifiedHeader);\n        res.writeHead(304);\n        res.end();\n        return;\n      }\n      if (file.uploadedAt) {\n        var _file$uploadedAt2;\n        res.setHeader('Last-Modified', (_file$uploadedAt2 = file.uploadedAt) === null || _file$uploadedAt2 === void 0 ? void 0 : _file$uploadedAt2.toUTCString());\n      }\n      if (file.type) {\n        res.setHeader('Content-Type', file.type);\n      }\n      if (file.size) {\n        res.setHeader('Content-Length', file.size);\n      }\n      return FileUpload.get(file, req, res, next);\n    };\n    const getAvatarSizeFromRequest = req => {\n      const requestSize = req.query.size && parseInt(req.query.size);\n      return Math.min(Math.max(requestSize, MIN_SVG_AVATAR_SIZE), MAX_SVG_AVATAR_SIZE);\n    };\n    const serveSvgAvatarInRequestedFormat = _ref => {\n      let {\n        nameOrUsername,\n        req,\n        res\n      } = _ref;\n      const size = getAvatarSizeFromRequest(req);\n      const avatar = renderSVGLetters(nameOrUsername, size);\n      res.setHeader('Last-Modified', FALLBACK_LAST_MODIFIED);\n      const {\n        format\n      } = req.query;\n      if (['png', 'jpg', 'jpeg'].includes(format)) {\n        res.setHeader('Content-Type', \"image/\".concat(format));\n        sharp(Buffer.from(avatar)).toFormat(format).pipe(res);\n        return;\n      }\n      res.setHeader('Content-Type', 'image/svg+xml');\n      res.write(avatar);\n      res.end();\n    };\n    const wasFallbackModified = reqModifiedHeader => {\n      if (!reqModifiedHeader || reqModifiedHeader !== FALLBACK_LAST_MODIFIED) {\n        return true;\n      }\n      return false;\n    };\n    async function isUserAuthenticated(_ref2) {\n      let {\n        headers,\n        query\n      } = _ref2;\n      let {\n        rc_uid,\n        rc_token\n      } = query;\n      if (!rc_uid && headers.cookie) {\n        rc_uid = cookie.get('rc_uid', headers.cookie);\n        rc_token = cookie.get('rc_token', headers.cookie);\n      }\n      if (rc_uid == null || rc_token == null) {\n        return false;\n      }\n      const userFound = await Users.findOneByIdAndLoginToken(rc_uid, hashLoginToken(rc_token), {\n        projection: {\n          _id: 1\n        }\n      }); // TODO memoize find\n      return !!userFound;\n    }\n    const warnUnauthenticatedAccess = throttle(() => {\n      console.warn('The server detected an unauthenticated access to an user avatar. This type of request will soon be blocked by default.');\n    }, 60000 * 30); // 30 minutes\n    async function userCanAccessAvatar(_ref3) {\n      let {\n        headers = {},\n        query = {}\n      } = _ref3;\n      if (!settings.get('Accounts_AvatarBlockUnauthenticatedAccess')) {\n        return true;\n      }\n      const isAuthenticated = await isUserAuthenticated({\n        headers,\n        query\n      });\n      if (!isAuthenticated) {\n        warnUnauthenticatedAccess();\n      }\n      return isAuthenticated;\n    }\n    const getFirstLetter = name => name.replace(/[^A-Za-z0-9]/g, '').substr(0, 1).toUpperCase();\n    const renderSVGLetters = function (username) {\n      let viewSize = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : 200;\n      let color = '';\n      let initials = '';\n      if (username === '?') {\n        color = '#000';\n        initials = username;\n      } else {\n        color = getAvatarColor(username);\n        initials = getFirstLetter(username);\n      }\n      const fontSize = viewSize / 1.6;\n      return \"<svg xmlns=\\\"http://www.w3.org/2000/svg\\\" viewBox=\\\"0 0 \".concat(viewSize, \" \").concat(viewSize, \"\\\">\\n<rect width=\\\"100%\\\" height=\\\"100%\\\" fill=\\\"\").concat(color, \"\\\"/>\\n<text x=\\\"50%\\\" y=\\\"50%\\\" dy=\\\"0.36em\\\" text-anchor=\\\"middle\\\" pointer-events=\\\"none\\\" fill=\\\"#ffffff\\\" font-family=\\\"'Helvetica', 'Arial', 'Lucida Grande', 'sans-serif'\\\" font-size=\\\"\").concat(fontSize, \"\\\">\\n\").concat(initials, \"\\n</text>\\n</svg>\");\n    };\n    const getCacheTime = cacheTime => cacheTime || settings.get('Accounts_AvatarCacheTime');\n    function setCacheAndDispositionHeaders(req, res) {\n      const cacheTime = getCacheTime(req.query.cacheTime);\n      res.setHeader('Cache-Control', \"public, max-age=\".concat(cacheTime));\n      res.setHeader('Content-Disposition', 'inline');\n    }\n    __reify_async_result__();\n  } catch (_reifyError) {\n    return __reify_async_result__(_reifyError);\n  }\n  __reify_async_result__()\n}, {\n  self: this,\n  async: false\n});","map":{"version":3,"names":["module","export","MAX_SVG_AVATAR_SIZE","MIN_SVG_AVATAR_SIZE","serveAvatarFile","getAvatarSizeFromRequest","serveSvgAvatarInRequestedFormat","wasFallbackModified","userCanAccessAvatar","renderSVGLetters","setCacheAndDispositionHeaders","hashLoginToken","link","v","Users","Cookies","sharp","default","throttle","FileUpload","settings","getAvatarColor","__reifyWaitForDeps__","FALLBACK_LAST_MODIFIED","cookie","file","req","res","next","_file$uploadedAt","setHeader","reqModifiedHeader","headers","uploadedAt","toUTCString","writeHead","end","_file$uploadedAt2","type","size","get","requestSize","query","parseInt","Math","min","max","_ref","nameOrUsername","avatar","format","includes","concat","Buffer","from","toFormat","pipe","write","isUserAuthenticated","_ref2","rc_uid","rc_token","userFound","findOneByIdAndLoginToken","projection","_id","warnUnauthenticatedAccess","console","warn","_ref3","isAuthenticated","getFirstLetter","name","replace","substr","toUpperCase","username","viewSize","arguments","length","undefined","color","initials","fontSize","getCacheTime","cacheTime","__reify_async_result__","_reifyError","self","async"],"sources":["server/routes/avatar/utils.ts"],"sourcesContent":["import type { ServerResponse } from 'http';\n\nimport { hashLoginToken } from '@rocket.chat/account-utils';\nimport type { IIncomingMessage, IUpload } from '@rocket.chat/core-typings';\nimport { Users } from '@rocket.chat/models';\nimport type { NextFunction } from 'connect';\nimport { Cookies } from 'meteor/ostrio:cookies';\nimport sharp from 'sharp';\nimport { throttle } from 'underscore';\n\nimport { FileUpload } from '../../../app/file-upload/server';\nimport { settings } from '../../../app/settings/server';\nimport { getAvatarColor } from '../../../app/utils/lib/getAvatarColor';\n\nconst FALLBACK_LAST_MODIFIED = 'Thu, 01 Jan 2015 00:00:00 GMT';\n\nconst cookie = new Cookies();\n\nexport const MAX_SVG_AVATAR_SIZE = 1024;\nexport const MIN_SVG_AVATAR_SIZE = 16;\n\nexport const serveAvatarFile = (file: IUpload, req: IIncomingMessage, res: ServerResponse, next: NextFunction) => {\n\tres.setHeader('Content-Security-Policy', \"default-src 'none'\");\n\tconst reqModifiedHeader = req.headers['if-modified-since'];\n\n\tif (reqModifiedHeader && reqModifiedHeader === file.uploadedAt?.toUTCString()) {\n\t\tres.setHeader('Last-Modified', reqModifiedHeader);\n\t\tres.writeHead(304);\n\t\tres.end();\n\t\treturn;\n\t}\n\n\tif (file.uploadedAt) {\n\t\tres.setHeader('Last-Modified', file.uploadedAt?.toUTCString());\n\t}\n\n\tif (file.type) {\n\t\tres.setHeader('Content-Type', file.type);\n\t}\n\n\tif (file.size) {\n\t\tres.setHeader('Content-Length', file.size);\n\t}\n\n\treturn FileUpload.get(file, req, res, next);\n};\n\nexport const getAvatarSizeFromRequest = (req: IIncomingMessage) => {\n\tconst requestSize = req.query.size && parseInt(req.query.size);\n\treturn Math.min(Math.max(requestSize, MIN_SVG_AVATAR_SIZE), MAX_SVG_AVATAR_SIZE);\n};\nexport const serveSvgAvatarInRequestedFormat = ({\n\tnameOrUsername,\n\treq,\n\tres,\n}: {\n\tnameOrUsername: string;\n\treq: IIncomingMessage;\n\tres: ServerResponse;\n}) => {\n\tconst size = getAvatarSizeFromRequest(req);\n\tconst avatar = renderSVGLetters(nameOrUsername, size);\n\tres.setHeader('Last-Modified', FALLBACK_LAST_MODIFIED);\n\n\tconst { format } = req.query;\n\n\tif (['png', 'jpg', 'jpeg'].includes(format)) {\n\t\tres.setHeader('Content-Type', `image/${format}`);\n\t\tsharp(Buffer.from(avatar)).toFormat(format).pipe(res);\n\t\treturn;\n\t}\n\tres.setHeader('Content-Type', 'image/svg+xml');\n\n\tres.write(avatar);\n\tres.end();\n};\n\nexport const wasFallbackModified = (reqModifiedHeader?: string) => {\n\tif (!reqModifiedHeader || reqModifiedHeader !== FALLBACK_LAST_MODIFIED) {\n\t\treturn true;\n\t}\n\treturn false;\n};\n\nasync function isUserAuthenticated({ headers, query }: Pick<IIncomingMessage, 'headers' | 'query'>) {\n\tlet { rc_uid, rc_token } = query;\n\n\tif (!rc_uid && headers.cookie) {\n\t\trc_uid = cookie.get('rc_uid', headers.cookie);\n\t\trc_token = cookie.get('rc_token', headers.cookie);\n\t}\n\n\tif (rc_uid == null || rc_token == null) {\n\t\treturn false;\n\t}\n\n\tconst userFound = await Users.findOneByIdAndLoginToken(rc_uid, hashLoginToken(rc_token), { projection: { _id: 1 } }); // TODO memoize find\n\n\treturn !!userFound;\n}\n\nconst warnUnauthenticatedAccess = throttle(() => {\n\tconsole.warn('The server detected an unauthenticated access to an user avatar. This type of request will soon be blocked by default.');\n}, 60000 * 30); // 30 minutes\n\nexport async function userCanAccessAvatar({ headers = {}, query = {} }: IIncomingMessage) {\n\tif (!settings.get('Accounts_AvatarBlockUnauthenticatedAccess')) {\n\t\treturn true;\n\t}\n\n\tconst isAuthenticated = await isUserAuthenticated({ headers, query });\n\tif (!isAuthenticated) {\n\t\twarnUnauthenticatedAccess();\n\t}\n\n\treturn isAuthenticated;\n}\n\nconst getFirstLetter = (name: string) =>\n\tname\n\t\t.replace(/[^A-Za-z0-9]/g, '')\n\t\t.substr(0, 1)\n\t\t.toUpperCase();\n\nexport const renderSVGLetters = (username: string, viewSize = 200) => {\n\tlet color = '';\n\tlet initials = '';\n\n\tif (username === '?') {\n\t\tcolor = '#000';\n\t\tinitials = username;\n\t} else {\n\t\tcolor = getAvatarColor(username);\n\t\tinitials = getFirstLetter(username);\n\t}\n\n\tconst fontSize = viewSize / 1.6;\n\n\treturn `<svg xmlns=\\\"http://www.w3.org/2000/svg\\\" viewBox=\\\"0 0 ${viewSize} ${viewSize}\\\">\\n<rect width=\\\"100%\\\" height=\\\"100%\\\" fill=\\\"${color}\\\"/>\\n<text x=\\\"50%\\\" y=\\\"50%\\\" dy=\\\"0.36em\\\" text-anchor=\\\"middle\\\" pointer-events=\\\"none\\\" fill=\\\"#ffffff\\\" font-family=\\\"'Helvetica', 'Arial', 'Lucida Grande', 'sans-serif'\\\" font-size=\"${fontSize}\">\\n${initials}\\n</text>\\n</svg>`;\n};\n\nconst getCacheTime = (cacheTime: number) => cacheTime || settings.get('Accounts_AvatarCacheTime');\n\nexport function setCacheAndDispositionHeaders(req: IIncomingMessage, res: ServerResponse) {\n\tconst cacheTime = getCacheTime(req.query.cacheTime);\n\tres.setHeader('Cache-Control', `public, max-age=${cacheTime}`);\n\tres.setHeader('Content-Disposition', 'inline');\n}\n"],"mappings":"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","ignoreList":[]},"sourceType":"module","externalDependencies":{},"hash":"2cc06203126c6f8cdf9d4cca3aaf92333579f4c3"}
