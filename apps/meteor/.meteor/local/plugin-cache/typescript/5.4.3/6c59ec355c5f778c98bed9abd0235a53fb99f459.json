{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/app/reactions/client/methods/setReaction.ts","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","topLevelAwait","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"web.browser.legacy"},"sourceFileName":"app/reactions/client/methods/setReaction.ts","filename":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/app/reactions/client/methods/setReaction.ts","inputSourceMap":{"version":3,"file":"app/reactions/client/methods/setReaction.ts","sourceRoot":"","sources":["app/reactions/client/methods/setReaction.ts"],"names":[],"mappings":"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","sourcesContent":["import type { IMessage, IRoom } from '@rocket.chat/core-typings';\nimport type { ServerMethods } from '@rocket.chat/ddp-client';\nimport { Meteor } from 'meteor/meteor';\n\nimport { roomCoordinator } from '../../../../client/lib/rooms/roomCoordinator';\nimport { emoji } from '../../../emoji/client';\nimport { Messages, ChatRoom, Subscriptions } from '../../../models/client';\n\nMeteor.methods<ServerMethods>({\n\tasync setReaction(reaction, messageId) {\n\t\tif (!Meteor.userId()) {\n\t\t\tthrow new Meteor.Error(203, 'User_logged_out');\n\t\t}\n\n\t\tconst user = Meteor.user();\n\n\t\tif (!user?.username) {\n\t\t\treturn false;\n\t\t}\n\n\t\tconst message: IMessage | undefined = Messages.findOne({ _id: messageId });\n\t\tif (!message) {\n\t\t\treturn false;\n\t\t}\n\n\t\tconst room: IRoom | undefined = ChatRoom.findOne({ _id: message.rid });\n\t\tif (!room) {\n\t\t\treturn false;\n\t\t}\n\n\t\tif (message.private) {\n\t\t\treturn false;\n\t\t}\n\n\t\tif (!emoji.list[reaction]) {\n\t\t\treturn false;\n\t\t}\n\n\t\tif (roomCoordinator.readOnly(room._id, user)) {\n\t\t\treturn false;\n\t\t}\n\n\t\tif (!Subscriptions.findOne({ rid: message.rid })) {\n\t\t\treturn false;\n\t\t}\n\n\t\tif (message.reactions?.[reaction] && message.reactions[reaction].usernames.indexOf(user.username) !== -1) {\n\t\t\tmessage.reactions[reaction].usernames.splice(message.reactions[reaction].usernames.indexOf(user.username), 1);\n\n\t\t\tif (message.reactions[reaction].usernames.length === 0) {\n\t\t\t\tdelete message.reactions[reaction];\n\t\t\t}\n\n\t\t\tif (!message.reactions || typeof message.reactions !== 'object' || Object.keys(message.reactions).length === 0) {\n\t\t\t\tdelete message.reactions;\n\t\t\t\tMessages.update({ _id: messageId }, { $unset: { reactions: 1 } });\n\t\t\t} else {\n\t\t\t\tMessages.update({ _id: messageId }, { $set: { reactions: message.reactions } });\n\t\t\t}\n\t\t} else {\n\t\t\tif (!message.reactions) {\n\t\t\t\tmessage.reactions = {};\n\t\t\t}\n\t\t\tif (!message.reactions[reaction]) {\n\t\t\t\tmessage.reactions[reaction] = {\n\t\t\t\t\tusernames: [],\n\t\t\t\t};\n\t\t\t}\n\t\t\tmessage.reactions[reaction].usernames.push(user.username);\n\n\t\t\tMessages.update({ _id: messageId }, { $set: { reactions: message.reactions } });\n\t\t}\n\t},\n});\n"]},"targets":{"android":"125.0.0","chrome":"125.0.0","edge":"125.0.0","firefox":"115.0.0","ie":"10.0.0","ios":"17.4.0","opera":"110.0.0","opera_mobile":"80.0.0","safari":"17.4.0","samsung":"24.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor","root":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":true,"enforceStrictMode":false,"dynamicImport":true},"externalDependencies":[]},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"version":"7.17.2","helpers":true,"useESModules":false,"corejs":false},"externalDependencies":[]},{"key":"proposal-class-properties","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true},"externalDependencies":[]},{"key":"base$0$3","visitor":{"FunctionExpression":{"exit":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"base$0$4","visitor":{"ForInStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-react-jsx","visitor":{"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXFragment":{"exit":[null]},"JSXElement":{"exit":[null]},"JSXAttribute":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false},"externalDependencies":[]},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-nullish-coalescing-operator","visitor":{"LogicalExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-optional-chaining","visitor":{"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-optional-catch-binding","visitor":{"CatchClause":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-class-properties","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-async-generator-functions","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-logical-assignment-operators","visitor":{"AssignmentExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-arrow-functions","visitor":{"ArrowFunctionExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-block-scoped-functions","visitor":{"BlockStatement":{"enter":[null]},"SwitchCase":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-block-scoping","visitor":{"VariableDeclaration":{"enter":[null,null]},"BlockStatement":{"enter":[null]},"SwitchCase":{"enter":[null]},"ClassDeclaration":{"enter":[null]},"DoWhileStatement":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForStatement":{"enter":[null]},"WhileStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-classes","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"ClassDeclaration":{"enter":[null]},"ClassExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"loose":true},"externalDependencies":[]},{"key":"transform-computed-properties","visitor":{"ObjectExpression":{"exit":[null]},"_exploded":true,"_verified":true},"options":{"loose":true},"externalDependencies":[]},{"key":"transform-destructuring","visitor":{"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"VariableDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"transform-for-of","visitor":{"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"loose":true},"externalDependencies":[]},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-object-super","visitor":{"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true,"DoWhileStatement":{"exit":[null]},"ForInStatement":{"exit":[null]},"ForStatement":{"exit":[null]},"WhileStatement":{"exit":[null]},"ForOfStatement":{"exit":[null]}},"options":{},"externalDependencies":[]},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"transform-shorthand-properties","visitor":{"ObjectMethod":{"enter":[null]},"ObjectProperty":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-spread","visitor":{"ArrayExpression":{"enter":[null]},"CallExpression":{"enter":[null]},"NewExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-sticky-regex","visitor":{"RegExpLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"loose":true},"externalDependencies":[]},{"key":"transform-typeof-symbol","visitor":{"UnaryExpression":{"enter":[null]},"_exploded":true,"_verified":true,"BlockStatement":{"enter":[null]},"CatchClause":{"enter":[null]},"DoWhileStatement":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForStatement":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"Program":{"enter":[null]},"ObjectMethod":{"enter":[null]},"SwitchStatement":{"enter":[null]},"WhileStatement":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]},"ForOfStatement":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"StaticBlock":{"enter":[null]},"TSModuleBlock":{"enter":[null]},"AssignmentPattern":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectPattern":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"transform-unicode-regex","visitor":{"RegExpLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-property-literals","visitor":{"ObjectProperty":{"exit":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-regenerator","visitor":{"ObjectMethod":{"enter":[null],"exit":[null]},"ClassMethod":{"enter":[null],"exit":[null]},"ClassPrivateMethod":{"enter":[null],"exit":[null]},"FunctionDeclaration":{"exit":[null]},"FunctionExpression":{"exit":[null]},"ArrowFunctionExpression":{"exit":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]}],"presets":[],"generatorOpts":{"filename":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/app/reactions/client/methods/setReaction.ts","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"app/reactions/client/methods/setReaction.ts","inputSourceMap":{"version":3,"file":"app/reactions/client/methods/setReaction.ts","sourceRoot":"","sources":["app/reactions/client/methods/setReaction.ts"],"names":[],"mappings":"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","sourcesContent":["import type { IMessage, IRoom } from '@rocket.chat/core-typings';\nimport type { ServerMethods } from '@rocket.chat/ddp-client';\nimport { Meteor } from 'meteor/meteor';\n\nimport { roomCoordinator } from '../../../../client/lib/rooms/roomCoordinator';\nimport { emoji } from '../../../emoji/client';\nimport { Messages, ChatRoom, Subscriptions } from '../../../models/client';\n\nMeteor.methods<ServerMethods>({\n\tasync setReaction(reaction, messageId) {\n\t\tif (!Meteor.userId()) {\n\t\t\tthrow new Meteor.Error(203, 'User_logged_out');\n\t\t}\n\n\t\tconst user = Meteor.user();\n\n\t\tif (!user?.username) {\n\t\t\treturn false;\n\t\t}\n\n\t\tconst message: IMessage | undefined = Messages.findOne({ _id: messageId });\n\t\tif (!message) {\n\t\t\treturn false;\n\t\t}\n\n\t\tconst room: IRoom | undefined = ChatRoom.findOne({ _id: message.rid });\n\t\tif (!room) {\n\t\t\treturn false;\n\t\t}\n\n\t\tif (message.private) {\n\t\t\treturn false;\n\t\t}\n\n\t\tif (!emoji.list[reaction]) {\n\t\t\treturn false;\n\t\t}\n\n\t\tif (roomCoordinator.readOnly(room._id, user)) {\n\t\t\treturn false;\n\t\t}\n\n\t\tif (!Subscriptions.findOne({ rid: message.rid })) {\n\t\t\treturn false;\n\t\t}\n\n\t\tif (message.reactions?.[reaction] && message.reactions[reaction].usernames.indexOf(user.username) !== -1) {\n\t\t\tmessage.reactions[reaction].usernames.splice(message.reactions[reaction].usernames.indexOf(user.username), 1);\n\n\t\t\tif (message.reactions[reaction].usernames.length === 0) {\n\t\t\t\tdelete message.reactions[reaction];\n\t\t\t}\n\n\t\t\tif (!message.reactions || typeof message.reactions !== 'object' || Object.keys(message.reactions).length === 0) {\n\t\t\t\tdelete message.reactions;\n\t\t\t\tMessages.update({ _id: messageId }, { $unset: { reactions: 1 } });\n\t\t\t} else {\n\t\t\t\tMessages.update({ _id: messageId }, { $set: { reactions: message.reactions } });\n\t\t\t}\n\t\t} else {\n\t\t\tif (!message.reactions) {\n\t\t\t\tmessage.reactions = {};\n\t\t\t}\n\t\t\tif (!message.reactions[reaction]) {\n\t\t\t\tmessage.reactions[reaction] = {\n\t\t\t\t\tusernames: [],\n\t\t\t\t};\n\t\t\t}\n\t\t\tmessage.reactions[reaction].usernames.push(user.username);\n\n\t\t\tMessages.update({ _id: messageId }, { $set: { reactions: message.reactions } });\n\t\t}\n\t},\n});\n"]}}},"code":"var _regeneratorRuntime;\nmodule.link(\"@babel/runtime/regenerator\", {\n  default: function (v) {\n    _regeneratorRuntime = v;\n  }\n}, 0);\nvar _typeof;\nmodule.link(\"@babel/runtime/helpers/typeof\", {\n  default: function (v) {\n    _typeof = v;\n  }\n}, 1);\nvar Meteor;\nmodule.link(\"meteor/meteor\", {\n  Meteor: function (v) {\n    Meteor = v;\n  }\n}, 0);\nvar roomCoordinator;\nmodule.link(\"../../../../client/lib/rooms/roomCoordinator\", {\n  roomCoordinator: function (v) {\n    roomCoordinator = v;\n  }\n}, 1);\nvar emoji;\nmodule.link(\"../../../emoji/client\", {\n  emoji: function (v) {\n    emoji = v;\n  }\n}, 2);\nvar Messages, ChatRoom, Subscriptions;\nmodule.link(\"../../../models/client\", {\n  Messages: function (v) {\n    Messages = v;\n  },\n  ChatRoom: function (v) {\n    ChatRoom = v;\n  },\n  Subscriptions: function (v) {\n    Subscriptions = v;\n  }\n}, 3);\nMeteor.methods({\n  setReaction: function () {\n    function _callee(reaction, messageId) {\n      var _message$reactions;\n      var user, message, room;\n      return _regeneratorRuntime.async(function () {\n        function _callee$(_context) {\n          while (1) switch (_context.prev = _context.next) {\n            case 0:\n              if (Meteor.userId()) {\n                _context.next = 2;\n                break;\n              }\n              throw new Meteor.Error(203, 'User_logged_out');\n            case 2:\n              user = Meteor.user();\n              if (user !== null && user !== void 0 && user.username) {\n                _context.next = 5;\n                break;\n              }\n              return _context.abrupt(\"return\", false);\n            case 5:\n              message = Messages.findOne({\n                _id: messageId\n              });\n              if (message) {\n                _context.next = 8;\n                break;\n              }\n              return _context.abrupt(\"return\", false);\n            case 8:\n              room = ChatRoom.findOne({\n                _id: message.rid\n              });\n              if (room) {\n                _context.next = 11;\n                break;\n              }\n              return _context.abrupt(\"return\", false);\n            case 11:\n              if (!message.private) {\n                _context.next = 13;\n                break;\n              }\n              return _context.abrupt(\"return\", false);\n            case 13:\n              if (emoji.list[reaction]) {\n                _context.next = 15;\n                break;\n              }\n              return _context.abrupt(\"return\", false);\n            case 15:\n              if (!roomCoordinator.readOnly(room._id, user)) {\n                _context.next = 17;\n                break;\n              }\n              return _context.abrupt(\"return\", false);\n            case 17:\n              if (Subscriptions.findOne({\n                rid: message.rid\n              })) {\n                _context.next = 19;\n                break;\n              }\n              return _context.abrupt(\"return\", false);\n            case 19:\n              if ((_message$reactions = message.reactions) !== null && _message$reactions !== void 0 && _message$reactions[reaction] && message.reactions[reaction].usernames.indexOf(user.username) !== -1) {\n                message.reactions[reaction].usernames.splice(message.reactions[reaction].usernames.indexOf(user.username), 1);\n                if (message.reactions[reaction].usernames.length === 0) {\n                  delete message.reactions[reaction];\n                }\n                if (!message.reactions || _typeof(message.reactions) !== 'object' || Object.keys(message.reactions).length === 0) {\n                  delete message.reactions;\n                  Messages.update({\n                    _id: messageId\n                  }, {\n                    $unset: {\n                      reactions: 1\n                    }\n                  });\n                } else {\n                  Messages.update({\n                    _id: messageId\n                  }, {\n                    $set: {\n                      reactions: message.reactions\n                    }\n                  });\n                }\n              } else {\n                if (!message.reactions) {\n                  message.reactions = {};\n                }\n                if (!message.reactions[reaction]) {\n                  message.reactions[reaction] = {\n                    usernames: []\n                  };\n                }\n                message.reactions[reaction].usernames.push(user.username);\n                Messages.update({\n                  _id: messageId\n                }, {\n                  $set: {\n                    reactions: message.reactions\n                  }\n                });\n              }\n            case 20:\n            case \"end\":\n              return _context.stop();\n          }\n        }\n        return _callee$;\n      }(), null, null, null, Promise);\n    }\n    return _callee;\n  }()\n});","map":{"version":3,"names":["_regeneratorRuntime","module","link","default","v","_typeof","Meteor","roomCoordinator","emoji","Messages","ChatRoom","Subscriptions","methods","setReaction","_callee","reaction","messageId","_message$reactions","user","message","room","async","_callee$","_context","prev","next","userId","Error","username","abrupt","findOne","_id","rid","private","list","readOnly","reactions","usernames","indexOf","splice","length","Object","keys","update","$unset","$set","push","stop","Promise"],"sources":["app/reactions/client/methods/setReaction.ts"],"sourcesContent":["import type { IMessage, IRoom } from '@rocket.chat/core-typings';\nimport type { ServerMethods } from '@rocket.chat/ddp-client';\nimport { Meteor } from 'meteor/meteor';\n\nimport { roomCoordinator } from '../../../../client/lib/rooms/roomCoordinator';\nimport { emoji } from '../../../emoji/client';\nimport { Messages, ChatRoom, Subscriptions } from '../../../models/client';\n\nMeteor.methods<ServerMethods>({\n\tasync setReaction(reaction, messageId) {\n\t\tif (!Meteor.userId()) {\n\t\t\tthrow new Meteor.Error(203, 'User_logged_out');\n\t\t}\n\n\t\tconst user = Meteor.user();\n\n\t\tif (!user?.username) {\n\t\t\treturn false;\n\t\t}\n\n\t\tconst message: IMessage | undefined = Messages.findOne({ _id: messageId });\n\t\tif (!message) {\n\t\t\treturn false;\n\t\t}\n\n\t\tconst room: IRoom | undefined = ChatRoom.findOne({ _id: message.rid });\n\t\tif (!room) {\n\t\t\treturn false;\n\t\t}\n\n\t\tif (message.private) {\n\t\t\treturn false;\n\t\t}\n\n\t\tif (!emoji.list[reaction]) {\n\t\t\treturn false;\n\t\t}\n\n\t\tif (roomCoordinator.readOnly(room._id, user)) {\n\t\t\treturn false;\n\t\t}\n\n\t\tif (!Subscriptions.findOne({ rid: message.rid })) {\n\t\t\treturn false;\n\t\t}\n\n\t\tif (message.reactions?.[reaction] && message.reactions[reaction].usernames.indexOf(user.username) !== -1) {\n\t\t\tmessage.reactions[reaction].usernames.splice(message.reactions[reaction].usernames.indexOf(user.username), 1);\n\n\t\t\tif (message.reactions[reaction].usernames.length === 0) {\n\t\t\t\tdelete message.reactions[reaction];\n\t\t\t}\n\n\t\t\tif (!message.reactions || typeof message.reactions !== 'object' || Object.keys(message.reactions).length === 0) {\n\t\t\t\tdelete message.reactions;\n\t\t\t\tMessages.update({ _id: messageId }, { $unset: { reactions: 1 } });\n\t\t\t} else {\n\t\t\t\tMessages.update({ _id: messageId }, { $set: { reactions: message.reactions } });\n\t\t\t}\n\t\t} else {\n\t\t\tif (!message.reactions) {\n\t\t\t\tmessage.reactions = {};\n\t\t\t}\n\t\t\tif (!message.reactions[reaction]) {\n\t\t\t\tmessage.reactions[reaction] = {\n\t\t\t\t\tusernames: [],\n\t\t\t\t};\n\t\t\t}\n\t\t\tmessage.reactions[reaction].usernames.push(user.username);\n\n\t\t\tMessages.update({ _id: messageId }, { $set: { reactions: message.reactions } });\n\t\t}\n\t},\n});\n"],"mappings":"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","ignoreList":[]},"sourceType":"module","externalDependencies":{},"hash":"6c59ec355c5f778c98bed9abd0235a53fb99f459"}
