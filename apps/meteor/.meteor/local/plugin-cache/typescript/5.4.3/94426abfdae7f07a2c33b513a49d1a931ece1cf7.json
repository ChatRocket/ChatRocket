{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/client/views/marketplace/hooks/useInstallApp.tsx","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","topLevelAwait","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"web.browser.legacy"},"sourceFileName":"client/views/marketplace/hooks/useInstallApp.tsx","filename":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/client/views/marketplace/hooks/useInstallApp.tsx","inputSourceMap":{"version":3,"file":"client/views/marketplace/hooks/useInstallApp.tsx","sourceRoot":"","sources":["client/views/marketplace/hooks/useInstallApp.tsx"],"names":[],"mappings":"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","sourcesContent":["import type { App, AppPermission } from '@rocket.chat/core-typings';\nimport { useRouter, useSetModal, useUpload } from '@rocket.chat/ui-contexts';\nimport { useMutation } from '@tanstack/react-query';\nimport React, { useCallback, useState } from 'react';\n\nimport { AppClientOrchestratorInstance } from '../../../apps/orchestrator';\nimport { useAppsReload } from '../../../contexts/hooks/useAppsReload';\nimport AppPermissionsReviewModal from '../AppPermissionsReviewModal';\nimport AppUpdateModal from '../AppUpdateModal';\nimport { handleAPIError } from '../helpers/handleAPIError';\nimport { handleInstallError } from '../helpers/handleInstallError';\nimport { getManifestFromZippedApp } from '../lib/getManifestFromZippedApp';\nimport { useAppsCountQuery } from './useAppsCountQuery';\n\nexport const useInstallApp = (file: File): { install: () => void; isInstalling: boolean } => {\n\tconst reloadAppsList = useAppsReload();\n\tconst setModal = useSetModal();\n\n\tconst router = useRouter();\n\n\tconst appCountQuery = useAppsCountQuery('private');\n\n\tconst uploadAppEndpoint = useUpload('/apps');\n\tconst uploadUpdateEndpoint = useUpload('/apps/update');\n\n\tconst [isInstalling, setInstalling] = useState(false);\n\n\tconst { mutate: sendFile } = useMutation(\n\t\t['apps/installPrivateApp'],\n\t\t({ permissionsGranted, appFile, appId }: { permissionsGranted: AppPermission[]; appFile: File; appId?: string }) => {\n\t\t\tconst fileData = new FormData();\n\t\t\tfileData.append('app', appFile, appFile.name);\n\t\t\tfileData.append('permissions', JSON.stringify(permissionsGranted));\n\n\t\t\tif (appId) {\n\t\t\t\treturn uploadUpdateEndpoint(fileData);\n\t\t\t}\n\n\t\t\treturn uploadAppEndpoint(fileData) as any;\n\t\t},\n\t\t{\n\t\t\tonSuccess: (data: { app: App }) => {\n\t\t\t\trouter.navigate({\n\t\t\t\t\tname: 'marketplace',\n\t\t\t\t\tparams: {\n\t\t\t\t\t\tcontext: 'private',\n\t\t\t\t\t\tpage: 'info',\n\t\t\t\t\t\tid: data.app.id,\n\t\t\t\t\t},\n\t\t\t\t});\n\t\t\t},\n\t\t\tonError: (e) => {\n\t\t\t\thandleAPIError(e);\n\t\t\t},\n\t\t\tonSettled: () => {\n\t\t\t\tsetInstalling(false);\n\t\t\t\tsetModal(null);\n\t\t\t\treloadAppsList();\n\t\t\t},\n\t\t},\n\t);\n\n\tconst cancelAction = useCallback(() => {\n\t\tsetInstalling(false);\n\t\tsetModal(null);\n\t}, [setInstalling, setModal]);\n\n\tconst isAppInstalled = async (appId: string) => {\n\t\ttry {\n\t\t\tconst app = await AppClientOrchestratorInstance.getApp(appId);\n\t\t\treturn !!app || false;\n\t\t} catch (e) {\n\t\t\treturn false;\n\t\t}\n\t};\n\n\tconst handleAppPermissionsReview = async (permissions: AppPermission[], appFile: File, appId?: string) => {\n\t\tsetModal(\n\t\t\t<AppPermissionsReviewModal\n\t\t\t\tappPermissions={permissions}\n\t\t\t\tonCancel={cancelAction}\n\t\t\t\tonConfirm={(permissionsGranted) => sendFile({ permissionsGranted, appFile, appId })}\n\t\t\t/>,\n\t\t);\n\t};\n\n\tconst uploadFile = async (appFile: File, { id, permissions }: { id: string; permissions: AppPermission[] }) => {\n\t\tconst isInstalled = await isAppInstalled(id);\n\n\t\tif (isInstalled) {\n\t\t\treturn setModal(<AppUpdateModal cancel={cancelAction} confirm={() => handleAppPermissionsReview(permissions, appFile, id)} />);\n\t\t}\n\n\t\tawait handleAppPermissionsReview(permissions, appFile);\n\t};\n\n\tconst extractManifestFromAppFile = async (appFile: File) => {\n\t\ttry {\n\t\t\treturn getManifestFromZippedApp(appFile);\n\t\t} catch (error) {\n\t\t\thandleInstallError(error as Error);\n\t\t}\n\t};\n\n\tconst install = async () => {\n\t\tsetInstalling(true);\n\n\t\tif (!appCountQuery.data) {\n\t\t\treturn cancelAction();\n\t\t}\n\n\t\tconst appFile = file;\n\n\t\tif (!appFile) {\n\t\t\treturn cancelAction();\n\t\t}\n\n\t\tconst manifest = await extractManifestFromAppFile(appFile);\n\n\t\tif (!manifest) {\n\t\t\treturn cancelAction();\n\t\t}\n\n\t\treturn uploadFile(appFile, manifest);\n\t};\n\n\treturn { install, isInstalling };\n};\n"]},"targets":{"android":"125.0.0","chrome":"125.0.0","edge":"125.0.0","firefox":"115.0.0","ie":"10.0.0","ios":"17.4.0","opera":"110.0.0","opera_mobile":"80.0.0","safari":"17.4.0","samsung":"24.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor","root":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":true,"enforceStrictMode":false,"dynamicImport":true},"externalDependencies":[]},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"version":"7.17.2","helpers":true,"useESModules":false,"corejs":false},"externalDependencies":[]},{"key":"proposal-class-properties","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true},"externalDependencies":[]},{"key":"base$0$3","visitor":{"FunctionExpression":{"exit":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"base$0$4","visitor":{"ForInStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-react-jsx","visitor":{"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXFragment":{"exit":[null]},"JSXElement":{"exit":[null]},"JSXAttribute":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false},"externalDependencies":[]},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-nullish-coalescing-operator","visitor":{"LogicalExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-optional-chaining","visitor":{"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-optional-catch-binding","visitor":{"CatchClause":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-class-properties","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-async-generator-functions","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-logical-assignment-operators","visitor":{"AssignmentExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-arrow-functions","visitor":{"ArrowFunctionExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-block-scoped-functions","visitor":{"BlockStatement":{"enter":[null]},"SwitchCase":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-block-scoping","visitor":{"VariableDeclaration":{"enter":[null,null]},"BlockStatement":{"enter":[null]},"SwitchCase":{"enter":[null]},"ClassDeclaration":{"enter":[null]},"DoWhileStatement":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForStatement":{"enter":[null]},"WhileStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-classes","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"ClassDeclaration":{"enter":[null]},"ClassExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"loose":true},"externalDependencies":[]},{"key":"transform-computed-properties","visitor":{"ObjectExpression":{"exit":[null]},"_exploded":true,"_verified":true},"options":{"loose":true},"externalDependencies":[]},{"key":"transform-destructuring","visitor":{"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"VariableDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"transform-for-of","visitor":{"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"loose":true},"externalDependencies":[]},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-object-super","visitor":{"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true,"DoWhileStatement":{"exit":[null]},"ForInStatement":{"exit":[null]},"ForStatement":{"exit":[null]},"WhileStatement":{"exit":[null]},"ForOfStatement":{"exit":[null]}},"options":{},"externalDependencies":[]},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"transform-shorthand-properties","visitor":{"ObjectMethod":{"enter":[null]},"ObjectProperty":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-spread","visitor":{"ArrayExpression":{"enter":[null]},"CallExpression":{"enter":[null]},"NewExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-sticky-regex","visitor":{"RegExpLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"loose":true},"externalDependencies":[]},{"key":"transform-typeof-symbol","visitor":{"UnaryExpression":{"enter":[null]},"_exploded":true,"_verified":true,"BlockStatement":{"enter":[null]},"CatchClause":{"enter":[null]},"DoWhileStatement":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForStatement":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"Program":{"enter":[null]},"ObjectMethod":{"enter":[null]},"SwitchStatement":{"enter":[null]},"WhileStatement":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]},"ForOfStatement":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"StaticBlock":{"enter":[null]},"TSModuleBlock":{"enter":[null]},"AssignmentPattern":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectPattern":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"transform-unicode-regex","visitor":{"RegExpLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-property-literals","visitor":{"ObjectProperty":{"exit":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-regenerator","visitor":{"ObjectMethod":{"enter":[null],"exit":[null]},"ClassMethod":{"enter":[null],"exit":[null]},"ClassPrivateMethod":{"enter":[null],"exit":[null]},"FunctionDeclaration":{"exit":[null]},"FunctionExpression":{"exit":[null]},"ArrowFunctionExpression":{"exit":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]}],"presets":[],"generatorOpts":{"filename":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/client/views/marketplace/hooks/useInstallApp.tsx","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"client/views/marketplace/hooks/useInstallApp.tsx","inputSourceMap":{"version":3,"file":"client/views/marketplace/hooks/useInstallApp.tsx","sourceRoot":"","sources":["client/views/marketplace/hooks/useInstallApp.tsx"],"names":[],"mappings":"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","sourcesContent":["import type { App, AppPermission } from '@rocket.chat/core-typings';\nimport { useRouter, useSetModal, useUpload } from '@rocket.chat/ui-contexts';\nimport { useMutation } from '@tanstack/react-query';\nimport React, { useCallback, useState } from 'react';\n\nimport { AppClientOrchestratorInstance } from '../../../apps/orchestrator';\nimport { useAppsReload } from '../../../contexts/hooks/useAppsReload';\nimport AppPermissionsReviewModal from '../AppPermissionsReviewModal';\nimport AppUpdateModal from '../AppUpdateModal';\nimport { handleAPIError } from '../helpers/handleAPIError';\nimport { handleInstallError } from '../helpers/handleInstallError';\nimport { getManifestFromZippedApp } from '../lib/getManifestFromZippedApp';\nimport { useAppsCountQuery } from './useAppsCountQuery';\n\nexport const useInstallApp = (file: File): { install: () => void; isInstalling: boolean } => {\n\tconst reloadAppsList = useAppsReload();\n\tconst setModal = useSetModal();\n\n\tconst router = useRouter();\n\n\tconst appCountQuery = useAppsCountQuery('private');\n\n\tconst uploadAppEndpoint = useUpload('/apps');\n\tconst uploadUpdateEndpoint = useUpload('/apps/update');\n\n\tconst [isInstalling, setInstalling] = useState(false);\n\n\tconst { mutate: sendFile } = useMutation(\n\t\t['apps/installPrivateApp'],\n\t\t({ permissionsGranted, appFile, appId }: { permissionsGranted: AppPermission[]; appFile: File; appId?: string }) => {\n\t\t\tconst fileData = new FormData();\n\t\t\tfileData.append('app', appFile, appFile.name);\n\t\t\tfileData.append('permissions', JSON.stringify(permissionsGranted));\n\n\t\t\tif (appId) {\n\t\t\t\treturn uploadUpdateEndpoint(fileData);\n\t\t\t}\n\n\t\t\treturn uploadAppEndpoint(fileData) as any;\n\t\t},\n\t\t{\n\t\t\tonSuccess: (data: { app: App }) => {\n\t\t\t\trouter.navigate({\n\t\t\t\t\tname: 'marketplace',\n\t\t\t\t\tparams: {\n\t\t\t\t\t\tcontext: 'private',\n\t\t\t\t\t\tpage: 'info',\n\t\t\t\t\t\tid: data.app.id,\n\t\t\t\t\t},\n\t\t\t\t});\n\t\t\t},\n\t\t\tonError: (e) => {\n\t\t\t\thandleAPIError(e);\n\t\t\t},\n\t\t\tonSettled: () => {\n\t\t\t\tsetInstalling(false);\n\t\t\t\tsetModal(null);\n\t\t\t\treloadAppsList();\n\t\t\t},\n\t\t},\n\t);\n\n\tconst cancelAction = useCallback(() => {\n\t\tsetInstalling(false);\n\t\tsetModal(null);\n\t}, [setInstalling, setModal]);\n\n\tconst isAppInstalled = async (appId: string) => {\n\t\ttry {\n\t\t\tconst app = await AppClientOrchestratorInstance.getApp(appId);\n\t\t\treturn !!app || false;\n\t\t} catch (e) {\n\t\t\treturn false;\n\t\t}\n\t};\n\n\tconst handleAppPermissionsReview = async (permissions: AppPermission[], appFile: File, appId?: string) => {\n\t\tsetModal(\n\t\t\t<AppPermissionsReviewModal\n\t\t\t\tappPermissions={permissions}\n\t\t\t\tonCancel={cancelAction}\n\t\t\t\tonConfirm={(permissionsGranted) => sendFile({ permissionsGranted, appFile, appId })}\n\t\t\t/>,\n\t\t);\n\t};\n\n\tconst uploadFile = async (appFile: File, { id, permissions }: { id: string; permissions: AppPermission[] }) => {\n\t\tconst isInstalled = await isAppInstalled(id);\n\n\t\tif (isInstalled) {\n\t\t\treturn setModal(<AppUpdateModal cancel={cancelAction} confirm={() => handleAppPermissionsReview(permissions, appFile, id)} />);\n\t\t}\n\n\t\tawait handleAppPermissionsReview(permissions, appFile);\n\t};\n\n\tconst extractManifestFromAppFile = async (appFile: File) => {\n\t\ttry {\n\t\t\treturn getManifestFromZippedApp(appFile);\n\t\t} catch (error) {\n\t\t\thandleInstallError(error as Error);\n\t\t}\n\t};\n\n\tconst install = async () => {\n\t\tsetInstalling(true);\n\n\t\tif (!appCountQuery.data) {\n\t\t\treturn cancelAction();\n\t\t}\n\n\t\tconst appFile = file;\n\n\t\tif (!appFile) {\n\t\t\treturn cancelAction();\n\t\t}\n\n\t\tconst manifest = await extractManifestFromAppFile(appFile);\n\n\t\tif (!manifest) {\n\t\t\treturn cancelAction();\n\t\t}\n\n\t\treturn uploadFile(appFile, manifest);\n\t};\n\n\treturn { install, isInstalling };\n};\n"]}}},"code":"var _regeneratorRuntime;\nmodule.link(\"@babel/runtime/regenerator\", {\n  default: function (v) {\n    _regeneratorRuntime = v;\n  }\n}, 0);\nvar _slicedToArray;\nmodule.link(\"@babel/runtime/helpers/slicedToArray\", {\n  default: function (v) {\n    _slicedToArray = v;\n  }\n}, 1);\nmodule.export({\n  useInstallApp: function () {\n    return useInstallApp;\n  }\n});\nvar useRouter, useSetModal, useUpload;\nmodule.link(\"@rocket.chat/ui-contexts\", {\n  useRouter: function (v) {\n    useRouter = v;\n  },\n  useSetModal: function (v) {\n    useSetModal = v;\n  },\n  useUpload: function (v) {\n    useUpload = v;\n  }\n}, 0);\nvar useMutation;\nmodule.link(\"@tanstack/react-query\", {\n  useMutation: function (v) {\n    useMutation = v;\n  }\n}, 1);\nvar React, useCallback, useState;\nmodule.link(\"react\", {\n  \"default\": function (v) {\n    React = v;\n  },\n  useCallback: function (v) {\n    useCallback = v;\n  },\n  useState: function (v) {\n    useState = v;\n  }\n}, 2);\nvar AppClientOrchestratorInstance;\nmodule.link(\"../../../apps/orchestrator\", {\n  AppClientOrchestratorInstance: function (v) {\n    AppClientOrchestratorInstance = v;\n  }\n}, 3);\nvar useAppsReload;\nmodule.link(\"../../../contexts/hooks/useAppsReload\", {\n  useAppsReload: function (v) {\n    useAppsReload = v;\n  }\n}, 4);\nvar AppPermissionsReviewModal;\nmodule.link(\"../AppPermissionsReviewModal\", {\n  \"default\": function (v) {\n    AppPermissionsReviewModal = v;\n  }\n}, 5);\nvar AppUpdateModal;\nmodule.link(\"../AppUpdateModal\", {\n  \"default\": function (v) {\n    AppUpdateModal = v;\n  }\n}, 6);\nvar handleAPIError;\nmodule.link(\"../helpers/handleAPIError\", {\n  handleAPIError: function (v) {\n    handleAPIError = v;\n  }\n}, 7);\nvar handleInstallError;\nmodule.link(\"../helpers/handleInstallError\", {\n  handleInstallError: function (v) {\n    handleInstallError = v;\n  }\n}, 8);\nvar getManifestFromZippedApp;\nmodule.link(\"../lib/getManifestFromZippedApp\", {\n  getManifestFromZippedApp: function (v) {\n    getManifestFromZippedApp = v;\n  }\n}, 9);\nvar useAppsCountQuery;\nmodule.link(\"./useAppsCountQuery\", {\n  useAppsCountQuery: function (v) {\n    useAppsCountQuery = v;\n  }\n}, 10);\nvar useInstallApp = function (file) {\n  var reloadAppsList = useAppsReload();\n  var setModal = useSetModal();\n  var router = useRouter();\n  var appCountQuery = useAppsCountQuery('private');\n  var uploadAppEndpoint = useUpload('/apps');\n  var uploadUpdateEndpoint = useUpload('/apps/update');\n  var _useState = useState(false),\n    _useState2 = _slicedToArray(_useState, 2),\n    isInstalling = _useState2[0],\n    setInstalling = _useState2[1];\n  var _useMutation = useMutation(['apps/installPrivateApp'], function (_ref) {\n      var permissionsGranted = _ref.permissionsGranted,\n        appFile = _ref.appFile,\n        appId = _ref.appId;\n      var fileData = new FormData();\n      fileData.append('app', appFile, appFile.name);\n      fileData.append('permissions', JSON.stringify(permissionsGranted));\n      if (appId) {\n        return uploadUpdateEndpoint(fileData);\n      }\n      return uploadAppEndpoint(fileData);\n    }, {\n      onSuccess: function (data) {\n        router.navigate({\n          name: 'marketplace',\n          params: {\n            context: 'private',\n            page: 'info',\n            id: data.app.id\n          }\n        });\n      },\n      onError: function (e) {\n        handleAPIError(e);\n      },\n      onSettled: function () {\n        setInstalling(false);\n        setModal(null);\n        reloadAppsList();\n      }\n    }),\n    sendFile = _useMutation.mutate;\n  var cancelAction = useCallback(function () {\n    setInstalling(false);\n    setModal(null);\n  }, [setInstalling, setModal]);\n  var isAppInstalled = function () {\n    function _callee(appId) {\n      var app;\n      return _regeneratorRuntime.async(function () {\n        function _callee$(_context) {\n          while (1) switch (_context.prev = _context.next) {\n            case 0:\n              _context.prev = 0;\n              _context.next = 3;\n              return _regeneratorRuntime.awrap(AppClientOrchestratorInstance.getApp(appId));\n            case 3:\n              app = _context.sent;\n              return _context.abrupt(\"return\", !!app || false);\n            case 7:\n              _context.prev = 7;\n              _context.t0 = _context[\"catch\"](0);\n              return _context.abrupt(\"return\", false);\n            case 10:\n            case \"end\":\n              return _context.stop();\n          }\n        }\n        return _callee$;\n      }(), null, null, [[0, 7]], Promise);\n    }\n    return _callee;\n  }();\n  var handleAppPermissionsReview = function () {\n    function _callee2(permissions, appFile, appId) {\n      return _regeneratorRuntime.async(function () {\n        function _callee2$(_context2) {\n          while (1) switch (_context2.prev = _context2.next) {\n            case 0:\n              setModal( /*#__PURE__*/React.createElement(AppPermissionsReviewModal, {\n                appPermissions: permissions,\n                onCancel: cancelAction,\n                onConfirm: function (permissionsGranted) {\n                  return sendFile({\n                    permissionsGranted: permissionsGranted,\n                    appFile: appFile,\n                    appId: appId\n                  });\n                }\n              }));\n            case 1:\n            case \"end\":\n              return _context2.stop();\n          }\n        }\n        return _callee2$;\n      }(), null, null, null, Promise);\n    }\n    return _callee2;\n  }();\n  var uploadFile = function () {\n    function _callee3(appFile, _ref2) {\n      var id, permissions, isInstalled;\n      return _regeneratorRuntime.async(function () {\n        function _callee3$(_context3) {\n          while (1) switch (_context3.prev = _context3.next) {\n            case 0:\n              id = _ref2.id, permissions = _ref2.permissions;\n              _context3.next = 3;\n              return _regeneratorRuntime.awrap(isAppInstalled(id));\n            case 3:\n              isInstalled = _context3.sent;\n              if (!isInstalled) {\n                _context3.next = 6;\n                break;\n              }\n              return _context3.abrupt(\"return\", setModal( /*#__PURE__*/React.createElement(AppUpdateModal, {\n                cancel: cancelAction,\n                confirm: function () {\n                  return handleAppPermissionsReview(permissions, appFile, id);\n                }\n              })));\n            case 6:\n              _context3.next = 8;\n              return _regeneratorRuntime.awrap(handleAppPermissionsReview(permissions, appFile));\n            case 8:\n            case \"end\":\n              return _context3.stop();\n          }\n        }\n        return _callee3$;\n      }(), null, null, null, Promise);\n    }\n    return _callee3;\n  }();\n  var extractManifestFromAppFile = function () {\n    function _callee4(appFile) {\n      return _regeneratorRuntime.async(function () {\n        function _callee4$(_context4) {\n          while (1) switch (_context4.prev = _context4.next) {\n            case 0:\n              _context4.prev = 0;\n              return _context4.abrupt(\"return\", getManifestFromZippedApp(appFile));\n            case 4:\n              _context4.prev = 4;\n              _context4.t0 = _context4[\"catch\"](0);\n              handleInstallError(_context4.t0);\n            case 7:\n            case \"end\":\n              return _context4.stop();\n          }\n        }\n        return _callee4$;\n      }(), null, null, [[0, 4]], Promise);\n    }\n    return _callee4;\n  }();\n  var install = function () {\n    function _callee5() {\n      var appFile, manifest;\n      return _regeneratorRuntime.async(function () {\n        function _callee5$(_context5) {\n          while (1) switch (_context5.prev = _context5.next) {\n            case 0:\n              setInstalling(true);\n              if (appCountQuery.data) {\n                _context5.next = 3;\n                break;\n              }\n              return _context5.abrupt(\"return\", cancelAction());\n            case 3:\n              appFile = file;\n              if (appFile) {\n                _context5.next = 6;\n                break;\n              }\n              return _context5.abrupt(\"return\", cancelAction());\n            case 6:\n              _context5.next = 8;\n              return _regeneratorRuntime.awrap(extractManifestFromAppFile(appFile));\n            case 8:\n              manifest = _context5.sent;\n              if (manifest) {\n                _context5.next = 11;\n                break;\n              }\n              return _context5.abrupt(\"return\", cancelAction());\n            case 11:\n              return _context5.abrupt(\"return\", uploadFile(appFile, manifest));\n            case 12:\n            case \"end\":\n              return _context5.stop();\n          }\n        }\n        return _callee5$;\n      }(), null, null, null, Promise);\n    }\n    return _callee5;\n  }();\n  return {\n    install: install,\n    isInstalling: isInstalling\n  };\n};","map":{"version":3,"names":["_regeneratorRuntime","module","link","default","v","_slicedToArray","export","useInstallApp","useRouter","useSetModal","useUpload","useMutation","React","useCallback","useState","AppClientOrchestratorInstance","useAppsReload","AppPermissionsReviewModal","AppUpdateModal","handleAPIError","handleInstallError","getManifestFromZippedApp","useAppsCountQuery","file","reloadAppsList","setModal","router","appCountQuery","uploadAppEndpoint","uploadUpdateEndpoint","_useState","_useState2","isInstalling","setInstalling","_useMutation","_ref","permissionsGranted","appFile","appId","fileData","FormData","append","name","JSON","stringify","onSuccess","data","navigate","params","context","page","id","app","onError","e","onSettled","sendFile","mutate","cancelAction","isAppInstalled","_callee","async","_callee$","_context","prev","next","awrap","getApp","sent","abrupt","t0","stop","Promise","handleAppPermissionsReview","_callee2","permissions","_callee2$","_context2","createElement","appPermissions","onCancel","onConfirm","uploadFile","_callee3","_ref2","isInstalled","_callee3$","_context3","cancel","confirm","extractManifestFromAppFile","_callee4","_callee4$","_context4","install","_callee5","manifest","_callee5$","_context5"],"sources":["client/views/marketplace/hooks/useInstallApp.tsx"],"sourcesContent":["import type { App, AppPermission } from '@rocket.chat/core-typings';\nimport { useRouter, useSetModal, useUpload } from '@rocket.chat/ui-contexts';\nimport { useMutation } from '@tanstack/react-query';\nimport React, { useCallback, useState } from 'react';\n\nimport { AppClientOrchestratorInstance } from '../../../apps/orchestrator';\nimport { useAppsReload } from '../../../contexts/hooks/useAppsReload';\nimport AppPermissionsReviewModal from '../AppPermissionsReviewModal';\nimport AppUpdateModal from '../AppUpdateModal';\nimport { handleAPIError } from '../helpers/handleAPIError';\nimport { handleInstallError } from '../helpers/handleInstallError';\nimport { getManifestFromZippedApp } from '../lib/getManifestFromZippedApp';\nimport { useAppsCountQuery } from './useAppsCountQuery';\n\nexport const useInstallApp = (file: File): { install: () => void; isInstalling: boolean } => {\n\tconst reloadAppsList = useAppsReload();\n\tconst setModal = useSetModal();\n\n\tconst router = useRouter();\n\n\tconst appCountQuery = useAppsCountQuery('private');\n\n\tconst uploadAppEndpoint = useUpload('/apps');\n\tconst uploadUpdateEndpoint = useUpload('/apps/update');\n\n\tconst [isInstalling, setInstalling] = useState(false);\n\n\tconst { mutate: sendFile } = useMutation(\n\t\t['apps/installPrivateApp'],\n\t\t({ permissionsGranted, appFile, appId }: { permissionsGranted: AppPermission[]; appFile: File; appId?: string }) => {\n\t\t\tconst fileData = new FormData();\n\t\t\tfileData.append('app', appFile, appFile.name);\n\t\t\tfileData.append('permissions', JSON.stringify(permissionsGranted));\n\n\t\t\tif (appId) {\n\t\t\t\treturn uploadUpdateEndpoint(fileData);\n\t\t\t}\n\n\t\t\treturn uploadAppEndpoint(fileData) as any;\n\t\t},\n\t\t{\n\t\t\tonSuccess: (data: { app: App }) => {\n\t\t\t\trouter.navigate({\n\t\t\t\t\tname: 'marketplace',\n\t\t\t\t\tparams: {\n\t\t\t\t\t\tcontext: 'private',\n\t\t\t\t\t\tpage: 'info',\n\t\t\t\t\t\tid: data.app.id,\n\t\t\t\t\t},\n\t\t\t\t});\n\t\t\t},\n\t\t\tonError: (e) => {\n\t\t\t\thandleAPIError(e);\n\t\t\t},\n\t\t\tonSettled: () => {\n\t\t\t\tsetInstalling(false);\n\t\t\t\tsetModal(null);\n\t\t\t\treloadAppsList();\n\t\t\t},\n\t\t},\n\t);\n\n\tconst cancelAction = useCallback(() => {\n\t\tsetInstalling(false);\n\t\tsetModal(null);\n\t}, [setInstalling, setModal]);\n\n\tconst isAppInstalled = async (appId: string) => {\n\t\ttry {\n\t\t\tconst app = await AppClientOrchestratorInstance.getApp(appId);\n\t\t\treturn !!app || false;\n\t\t} catch (e) {\n\t\t\treturn false;\n\t\t}\n\t};\n\n\tconst handleAppPermissionsReview = async (permissions: AppPermission[], appFile: File, appId?: string) => {\n\t\tsetModal(\n\t\t\t<AppPermissionsReviewModal\n\t\t\t\tappPermissions={permissions}\n\t\t\t\tonCancel={cancelAction}\n\t\t\t\tonConfirm={(permissionsGranted) => sendFile({ permissionsGranted, appFile, appId })}\n\t\t\t/>,\n\t\t);\n\t};\n\n\tconst uploadFile = async (appFile: File, { id, permissions }: { id: string; permissions: AppPermission[] }) => {\n\t\tconst isInstalled = await isAppInstalled(id);\n\n\t\tif (isInstalled) {\n\t\t\treturn setModal(<AppUpdateModal cancel={cancelAction} confirm={() => handleAppPermissionsReview(permissions, appFile, id)} />);\n\t\t}\n\n\t\tawait handleAppPermissionsReview(permissions, appFile);\n\t};\n\n\tconst extractManifestFromAppFile = async (appFile: File) => {\n\t\ttry {\n\t\t\treturn getManifestFromZippedApp(appFile);\n\t\t} catch (error) {\n\t\t\thandleInstallError(error as Error);\n\t\t}\n\t};\n\n\tconst install = async () => {\n\t\tsetInstalling(true);\n\n\t\tif (!appCountQuery.data) {\n\t\t\treturn cancelAction();\n\t\t}\n\n\t\tconst appFile = file;\n\n\t\tif (!appFile) {\n\t\t\treturn cancelAction();\n\t\t}\n\n\t\tconst manifest = await extractManifestFromAppFile(appFile);\n\n\t\tif (!manifest) {\n\t\t\treturn cancelAction();\n\t\t}\n\n\t\treturn uploadFile(appFile, manifest);\n\t};\n\n\treturn { install, isInstalling };\n};\n"],"mappings":"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","ignoreList":[]},"sourceType":"module","externalDependencies":{},"hash":"94426abfdae7f07a2c33b513a49d1a931ece1cf7"}
