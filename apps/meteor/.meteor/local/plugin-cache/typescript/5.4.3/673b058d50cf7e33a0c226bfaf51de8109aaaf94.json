{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/client/lib/RoomManager.ts","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","topLevelAwait","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"web.browser.legacy"},"sourceFileName":"client/lib/RoomManager.ts","filename":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/client/lib/RoomManager.ts","inputSourceMap":{"version":3,"file":"client/lib/RoomManager.ts","sourceRoot":"","sources":["client/lib/RoomManager.ts"],"names":[],"mappings":"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","sourcesContent":["import type { IRoom } from '@rocket.chat/core-typings';\nimport { Emitter } from '@rocket.chat/emitter';\nimport { useSyncExternalStore } from 'use-sync-external-store/shim';\n\nimport { RoomHistoryManager } from '../../app/ui-utils/client/lib/RoomHistoryManager';\nimport { getConfig } from './utils/getConfig';\n\nconst debug = !!(getConfig('debug') || getConfig('debug-RoomStore'));\n\nclass RoomStore extends Emitter<{\n\tchanged: undefined;\n}> {\n\tlastTime?: Date;\n\n\tscroll?: number;\n\n\tlm?: Date;\n\n\tatBottom = true;\n\n\tconstructor(readonly rid: string) {\n\t\tsuper();\n\n\t\tdebug && this.on('changed', () => console.log(`RoomStore ${this.rid} changed`, this));\n\t}\n\n\tupdate({ scroll, lastTime, atBottom }: { scroll?: number; lastTime?: Date; atBottom?: boolean }): void {\n\t\tif (scroll !== undefined) {\n\t\t\tthis.scroll = scroll;\n\t\t}\n\t\tif (lastTime !== undefined) {\n\t\t\tthis.lastTime = lastTime;\n\t\t}\n\n\t\tif (atBottom !== undefined) {\n\t\t\tthis.atBottom = atBottom;\n\t\t}\n\t\tif (scroll || lastTime) {\n\t\t\tthis.emit('changed');\n\t\t}\n\t}\n}\n\nconst debugRoomManager = !!(getConfig('debug') || getConfig('debug-RoomManager'));\nexport const RoomManager = new (class RoomManager extends Emitter<{\n\tchanged: IRoom['_id'] | undefined;\n\topened: IRoom['_id'];\n\tclosed: IRoom['_id'];\n\tback: IRoom['_id'];\n\tremoved: IRoom['_id'];\n}> {\n\tprivate rid: IRoom['_id'] | undefined;\n\n\tpublic lastRid: IRoom['_id'] | undefined;\n\n\tprivate rooms: Map<IRoom['_id'], RoomStore> = new Map();\n\n\tprivate parentRid?: IRoom['_id'] | undefined;\n\n\tconstructor() {\n\t\tsuper();\n\t\tdebugRoomManager &&\n\t\t\tthis.on('opened', (rid) => {\n\t\t\t\tconsole.log('room opened ->', rid);\n\t\t\t});\n\n\t\tdebugRoomManager &&\n\t\t\tthis.on('back', (rid) => {\n\t\t\t\tconsole.log('room moved to back ->', rid);\n\t\t\t});\n\n\t\tdebugRoomManager &&\n\t\t\tthis.on('closed', (rid) => {\n\t\t\t\tconsole.log('room close ->', rid);\n\t\t\t});\n\t}\n\n\tget lastOpened(): IRoom['_id'] | undefined {\n\t\treturn this.lastRid;\n\t}\n\n\tget opened(): IRoom['_id'] | undefined {\n\t\treturn this.parentRid ?? this.rid;\n\t}\n\n\tget openedSecondLevel(): IRoom['_id'] | undefined {\n\t\tif (!this.parentRid) {\n\t\t\treturn undefined;\n\t\t}\n\t\treturn this.rid;\n\t}\n\n\tvisitedRooms(): IRoom['_id'][] {\n\t\treturn [...this.rooms.keys()];\n\t}\n\n\tback(rid: IRoom['_id']): void {\n\t\tif (rid === this.rid) {\n\t\t\tthis.lastRid = rid;\n\t\t\tthis.rid = undefined;\n\t\t\tthis.emit('back', rid);\n\t\t\tthis.emit('changed', this.rid);\n\t\t}\n\t}\n\n\tgetMore(rid: IRoom['_id']): void {\n\t\tRoomHistoryManager.getMore(rid);\n\t}\n\n\tclose(rid: IRoom['_id']): void {\n\t\tif (this.rooms.has(rid)) {\n\t\t\tthis.rooms.delete(rid);\n\t\t\tthis.emit('closed', rid);\n\t\t}\n\t\tthis.emit('changed', this.rid);\n\t}\n\n\tprivate _open(rid: IRoom['_id'], parent?: IRoom['_id']): void {\n\t\tif (rid === this.rid) {\n\t\t\treturn;\n\t\t}\n\t\tthis.back(rid);\n\t\tif (!this.rooms.has(rid)) {\n\t\t\tthis.rooms.set(rid, new RoomStore(rid));\n\t\t}\n\t\tthis.rid = rid;\n\t\tthis.parentRid = parent;\n\t\tthis.emit('opened', this.rid);\n\t\tthis.emit('changed', this.rid);\n\t}\n\n\topen(rid: IRoom['_id']): void {\n\t\tthis._open(rid);\n\t}\n\n\topenSecondLevel(parentId: IRoom['_id'], rid: IRoom['_id']): void {\n\t\tthis._open(rid, parentId);\n\t}\n\n\tgetStore(rid: IRoom['_id']): RoomStore | undefined {\n\t\treturn this.rooms.get(rid);\n\t}\n})();\n\nconst subscribeOpenedRoom = [\n\t(callback: () => void): (() => void) => RoomManager.on('changed', callback),\n\t(): IRoom['_id'] | undefined => RoomManager.opened,\n] as const;\n\nconst subscribeOpenedSecondLevelRoom = [\n\t(callback: () => void): (() => void) => RoomManager.on('changed', callback),\n\t(): IRoom['_id'] | undefined => RoomManager.openedSecondLevel,\n] as const;\n\nexport const useOpenedRoom = (): IRoom['_id'] | undefined => useSyncExternalStore(...subscribeOpenedRoom);\n\nexport const useSecondLevelOpenedRoom = (): IRoom['_id'] | undefined => useSyncExternalStore(...subscribeOpenedSecondLevelRoom);\n"]},"targets":{"android":"125.0.0","chrome":"125.0.0","edge":"125.0.0","firefox":"115.0.0","ie":"10.0.0","ios":"17.4.0","opera":"110.0.0","opera_mobile":"80.0.0","safari":"17.4.0","samsung":"24.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor","root":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":true,"enforceStrictMode":false,"dynamicImport":true},"externalDependencies":[]},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"version":"7.17.2","helpers":true,"useESModules":false,"corejs":false},"externalDependencies":[]},{"key":"proposal-class-properties","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true},"externalDependencies":[]},{"key":"base$0$3","visitor":{"FunctionExpression":{"exit":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"base$0$4","visitor":{"ForInStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-react-jsx","visitor":{"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXFragment":{"exit":[null]},"JSXElement":{"exit":[null]},"JSXAttribute":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false},"externalDependencies":[]},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-nullish-coalescing-operator","visitor":{"LogicalExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-optional-chaining","visitor":{"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-optional-catch-binding","visitor":{"CatchClause":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-class-properties","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-async-generator-functions","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-logical-assignment-operators","visitor":{"AssignmentExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-arrow-functions","visitor":{"ArrowFunctionExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-block-scoped-functions","visitor":{"BlockStatement":{"enter":[null]},"SwitchCase":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-block-scoping","visitor":{"VariableDeclaration":{"enter":[null,null]},"BlockStatement":{"enter":[null]},"SwitchCase":{"enter":[null]},"ClassDeclaration":{"enter":[null]},"DoWhileStatement":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForStatement":{"enter":[null]},"WhileStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-classes","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"ClassDeclaration":{"enter":[null]},"ClassExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"loose":true},"externalDependencies":[]},{"key":"transform-computed-properties","visitor":{"ObjectExpression":{"exit":[null]},"_exploded":true,"_verified":true},"options":{"loose":true},"externalDependencies":[]},{"key":"transform-destructuring","visitor":{"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"VariableDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"transform-for-of","visitor":{"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"loose":true},"externalDependencies":[]},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-object-super","visitor":{"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true,"DoWhileStatement":{"exit":[null]},"ForInStatement":{"exit":[null]},"ForStatement":{"exit":[null]},"WhileStatement":{"exit":[null]},"ForOfStatement":{"exit":[null]}},"options":{},"externalDependencies":[]},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"transform-shorthand-properties","visitor":{"ObjectMethod":{"enter":[null]},"ObjectProperty":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-spread","visitor":{"ArrayExpression":{"enter":[null]},"CallExpression":{"enter":[null]},"NewExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-sticky-regex","visitor":{"RegExpLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"loose":true},"externalDependencies":[]},{"key":"transform-typeof-symbol","visitor":{"UnaryExpression":{"enter":[null]},"_exploded":true,"_verified":true,"BlockStatement":{"enter":[null]},"CatchClause":{"enter":[null]},"DoWhileStatement":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForStatement":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"Program":{"enter":[null]},"ObjectMethod":{"enter":[null]},"SwitchStatement":{"enter":[null]},"WhileStatement":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]},"ForOfStatement":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"StaticBlock":{"enter":[null]},"TSModuleBlock":{"enter":[null]},"AssignmentPattern":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectPattern":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"transform-unicode-regex","visitor":{"RegExpLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-property-literals","visitor":{"ObjectProperty":{"exit":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-regenerator","visitor":{"ObjectMethod":{"enter":[null],"exit":[null]},"ClassMethod":{"enter":[null],"exit":[null]},"ClassPrivateMethod":{"enter":[null],"exit":[null]},"FunctionDeclaration":{"exit":[null]},"FunctionExpression":{"exit":[null]},"ArrowFunctionExpression":{"exit":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]}],"presets":[],"generatorOpts":{"filename":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/client/lib/RoomManager.ts","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"client/lib/RoomManager.ts","inputSourceMap":{"version":3,"file":"client/lib/RoomManager.ts","sourceRoot":"","sources":["client/lib/RoomManager.ts"],"names":[],"mappings":"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","sourcesContent":["import type { IRoom } from '@rocket.chat/core-typings';\nimport { Emitter } from '@rocket.chat/emitter';\nimport { useSyncExternalStore } from 'use-sync-external-store/shim';\n\nimport { RoomHistoryManager } from '../../app/ui-utils/client/lib/RoomHistoryManager';\nimport { getConfig } from './utils/getConfig';\n\nconst debug = !!(getConfig('debug') || getConfig('debug-RoomStore'));\n\nclass RoomStore extends Emitter<{\n\tchanged: undefined;\n}> {\n\tlastTime?: Date;\n\n\tscroll?: number;\n\n\tlm?: Date;\n\n\tatBottom = true;\n\n\tconstructor(readonly rid: string) {\n\t\tsuper();\n\n\t\tdebug && this.on('changed', () => console.log(`RoomStore ${this.rid} changed`, this));\n\t}\n\n\tupdate({ scroll, lastTime, atBottom }: { scroll?: number; lastTime?: Date; atBottom?: boolean }): void {\n\t\tif (scroll !== undefined) {\n\t\t\tthis.scroll = scroll;\n\t\t}\n\t\tif (lastTime !== undefined) {\n\t\t\tthis.lastTime = lastTime;\n\t\t}\n\n\t\tif (atBottom !== undefined) {\n\t\t\tthis.atBottom = atBottom;\n\t\t}\n\t\tif (scroll || lastTime) {\n\t\t\tthis.emit('changed');\n\t\t}\n\t}\n}\n\nconst debugRoomManager = !!(getConfig('debug') || getConfig('debug-RoomManager'));\nexport const RoomManager = new (class RoomManager extends Emitter<{\n\tchanged: IRoom['_id'] | undefined;\n\topened: IRoom['_id'];\n\tclosed: IRoom['_id'];\n\tback: IRoom['_id'];\n\tremoved: IRoom['_id'];\n}> {\n\tprivate rid: IRoom['_id'] | undefined;\n\n\tpublic lastRid: IRoom['_id'] | undefined;\n\n\tprivate rooms: Map<IRoom['_id'], RoomStore> = new Map();\n\n\tprivate parentRid?: IRoom['_id'] | undefined;\n\n\tconstructor() {\n\t\tsuper();\n\t\tdebugRoomManager &&\n\t\t\tthis.on('opened', (rid) => {\n\t\t\t\tconsole.log('room opened ->', rid);\n\t\t\t});\n\n\t\tdebugRoomManager &&\n\t\t\tthis.on('back', (rid) => {\n\t\t\t\tconsole.log('room moved to back ->', rid);\n\t\t\t});\n\n\t\tdebugRoomManager &&\n\t\t\tthis.on('closed', (rid) => {\n\t\t\t\tconsole.log('room close ->', rid);\n\t\t\t});\n\t}\n\n\tget lastOpened(): IRoom['_id'] | undefined {\n\t\treturn this.lastRid;\n\t}\n\n\tget opened(): IRoom['_id'] | undefined {\n\t\treturn this.parentRid ?? this.rid;\n\t}\n\n\tget openedSecondLevel(): IRoom['_id'] | undefined {\n\t\tif (!this.parentRid) {\n\t\t\treturn undefined;\n\t\t}\n\t\treturn this.rid;\n\t}\n\n\tvisitedRooms(): IRoom['_id'][] {\n\t\treturn [...this.rooms.keys()];\n\t}\n\n\tback(rid: IRoom['_id']): void {\n\t\tif (rid === this.rid) {\n\t\t\tthis.lastRid = rid;\n\t\t\tthis.rid = undefined;\n\t\t\tthis.emit('back', rid);\n\t\t\tthis.emit('changed', this.rid);\n\t\t}\n\t}\n\n\tgetMore(rid: IRoom['_id']): void {\n\t\tRoomHistoryManager.getMore(rid);\n\t}\n\n\tclose(rid: IRoom['_id']): void {\n\t\tif (this.rooms.has(rid)) {\n\t\t\tthis.rooms.delete(rid);\n\t\t\tthis.emit('closed', rid);\n\t\t}\n\t\tthis.emit('changed', this.rid);\n\t}\n\n\tprivate _open(rid: IRoom['_id'], parent?: IRoom['_id']): void {\n\t\tif (rid === this.rid) {\n\t\t\treturn;\n\t\t}\n\t\tthis.back(rid);\n\t\tif (!this.rooms.has(rid)) {\n\t\t\tthis.rooms.set(rid, new RoomStore(rid));\n\t\t}\n\t\tthis.rid = rid;\n\t\tthis.parentRid = parent;\n\t\tthis.emit('opened', this.rid);\n\t\tthis.emit('changed', this.rid);\n\t}\n\n\topen(rid: IRoom['_id']): void {\n\t\tthis._open(rid);\n\t}\n\n\topenSecondLevel(parentId: IRoom['_id'], rid: IRoom['_id']): void {\n\t\tthis._open(rid, parentId);\n\t}\n\n\tgetStore(rid: IRoom['_id']): RoomStore | undefined {\n\t\treturn this.rooms.get(rid);\n\t}\n})();\n\nconst subscribeOpenedRoom = [\n\t(callback: () => void): (() => void) => RoomManager.on('changed', callback),\n\t(): IRoom['_id'] | undefined => RoomManager.opened,\n] as const;\n\nconst subscribeOpenedSecondLevelRoom = [\n\t(callback: () => void): (() => void) => RoomManager.on('changed', callback),\n\t(): IRoom['_id'] | undefined => RoomManager.openedSecondLevel,\n] as const;\n\nexport const useOpenedRoom = (): IRoom['_id'] | undefined => useSyncExternalStore(...subscribeOpenedRoom);\n\nexport const useSecondLevelOpenedRoom = (): IRoom['_id'] | undefined => useSyncExternalStore(...subscribeOpenedSecondLevelRoom);\n"]}}},"code":"var _toConsumableArray;\nmodule.link(\"@babel/runtime/helpers/toConsumableArray\", {\n  default: function (v) {\n    _toConsumableArray = v;\n  }\n}, 0);\nvar _createClass;\nmodule.link(\"@babel/runtime/helpers/createClass\", {\n  default: function (v) {\n    _createClass = v;\n  }\n}, 1);\nvar _inheritsLoose;\nmodule.link(\"@babel/runtime/helpers/inheritsLoose\", {\n  default: function (v) {\n    _inheritsLoose = v;\n  }\n}, 2);\nmodule.export({\n  RoomManager: function () {\n    return RoomManager;\n  },\n  useOpenedRoom: function () {\n    return useOpenedRoom;\n  },\n  useSecondLevelOpenedRoom: function () {\n    return useSecondLevelOpenedRoom;\n  }\n});\nvar Emitter;\nmodule.link(\"@rocket.chat/emitter\", {\n  Emitter: function (v) {\n    Emitter = v;\n  }\n}, 0);\nvar useSyncExternalStore;\nmodule.link(\"use-sync-external-store/shim\", {\n  useSyncExternalStore: function (v) {\n    useSyncExternalStore = v;\n  }\n}, 1);\nvar RoomHistoryManager;\nmodule.link(\"../../app/ui-utils/client/lib/RoomHistoryManager\", {\n  RoomHistoryManager: function (v) {\n    RoomHistoryManager = v;\n  }\n}, 2);\nvar getConfig;\nmodule.link(\"./utils/getConfig\", {\n  getConfig: function (v) {\n    getConfig = v;\n  }\n}, 3);\nvar debug = !!(getConfig('debug') || getConfig('debug-RoomStore'));\nvar RoomStore = /*#__PURE__*/function (_Emitter) {\n  function RoomStore(rid) {\n    var _this;\n    _this = _Emitter.call(this) || this;\n    _this.rid = void 0;\n    _this.lastTime = void 0;\n    _this.scroll = void 0;\n    _this.lm = void 0;\n    _this.atBottom = true;\n    _this.rid = rid;\n    debug && _this.on('changed', function () {\n      return console.log(\"RoomStore \" + _this.rid + \" changed\", _this);\n    });\n    return _this;\n  }\n  _inheritsLoose(RoomStore, _Emitter);\n  var _proto = RoomStore.prototype;\n  _proto.update = function () {\n    function update(_ref) {\n      var scroll = _ref.scroll,\n        lastTime = _ref.lastTime,\n        atBottom = _ref.atBottom;\n      if (scroll !== undefined) {\n        this.scroll = scroll;\n      }\n      if (lastTime !== undefined) {\n        this.lastTime = lastTime;\n      }\n      if (atBottom !== undefined) {\n        this.atBottom = atBottom;\n      }\n      if (scroll || lastTime) {\n        this.emit('changed');\n      }\n    }\n    return update;\n  }();\n  return RoomStore;\n}(Emitter);\nvar debugRoomManager = !!(getConfig('debug') || getConfig('debug-RoomManager'));\nvar RoomManager = new ( /*#__PURE__*/function (_Emitter2) {\n  function RoomManager() {\n    var _this2;\n    _this2 = _Emitter2.call(this) || this;\n    _this2.rid = void 0;\n    _this2.lastRid = void 0;\n    _this2.rooms = new Map();\n    _this2.parentRid = void 0;\n    debugRoomManager && _this2.on('opened', function (rid) {\n      console.log('room opened ->', rid);\n    });\n    debugRoomManager && _this2.on('back', function (rid) {\n      console.log('room moved to back ->', rid);\n    });\n    debugRoomManager && _this2.on('closed', function (rid) {\n      console.log('room close ->', rid);\n    });\n    return _this2;\n  }\n  _inheritsLoose(RoomManager, _Emitter2);\n  var _proto2 = RoomManager.prototype;\n  _proto2.visitedRooms = function () {\n    function visitedRooms() {\n      return _toConsumableArray(this.rooms.keys());\n    }\n    return visitedRooms;\n  }();\n  _proto2.back = function () {\n    function back(rid) {\n      if (rid === this.rid) {\n        this.lastRid = rid;\n        this.rid = undefined;\n        this.emit('back', rid);\n        this.emit('changed', this.rid);\n      }\n    }\n    return back;\n  }();\n  _proto2.getMore = function () {\n    function getMore(rid) {\n      RoomHistoryManager.getMore(rid);\n    }\n    return getMore;\n  }();\n  _proto2.close = function () {\n    function close(rid) {\n      if (this.rooms.has(rid)) {\n        this.rooms.delete(rid);\n        this.emit('closed', rid);\n      }\n      this.emit('changed', this.rid);\n    }\n    return close;\n  }();\n  _proto2._open = function () {\n    function _open(rid, parent) {\n      if (rid === this.rid) {\n        return;\n      }\n      this.back(rid);\n      if (!this.rooms.has(rid)) {\n        this.rooms.set(rid, new RoomStore(rid));\n      }\n      this.rid = rid;\n      this.parentRid = parent;\n      this.emit('opened', this.rid);\n      this.emit('changed', this.rid);\n    }\n    return _open;\n  }();\n  _proto2.open = function () {\n    function open(rid) {\n      this._open(rid);\n    }\n    return open;\n  }();\n  _proto2.openSecondLevel = function () {\n    function openSecondLevel(parentId, rid) {\n      this._open(rid, parentId);\n    }\n    return openSecondLevel;\n  }();\n  _proto2.getStore = function () {\n    function getStore(rid) {\n      return this.rooms.get(rid);\n    }\n    return getStore;\n  }();\n  return _createClass(RoomManager, [{\n    key: \"lastOpened\",\n    get: function () {\n      return this.lastRid;\n    }\n  }, {\n    key: \"opened\",\n    get: function () {\n      var _this$parentRid;\n      return (_this$parentRid = this.parentRid) !== null && _this$parentRid !== void 0 ? _this$parentRid : this.rid;\n    }\n  }, {\n    key: \"openedSecondLevel\",\n    get: function () {\n      if (!this.parentRid) {\n        return undefined;\n      }\n      return this.rid;\n    }\n  }]);\n}(Emitter))();\nvar subscribeOpenedRoom = [function (callback) {\n  return RoomManager.on('changed', callback);\n}, function () {\n  return RoomManager.opened;\n}];\nvar subscribeOpenedSecondLevelRoom = [function (callback) {\n  return RoomManager.on('changed', callback);\n}, function () {\n  return RoomManager.openedSecondLevel;\n}];\nvar useOpenedRoom = function () {\n  return useSyncExternalStore.apply(void 0, subscribeOpenedRoom);\n};\nvar useSecondLevelOpenedRoom = function () {\n  return useSyncExternalStore.apply(void 0, subscribeOpenedSecondLevelRoom);\n};","map":{"version":3,"names":["_toConsumableArray","module","link","default","v","_createClass","_inheritsLoose","export","RoomManager","useOpenedRoom","useSecondLevelOpenedRoom","Emitter","useSyncExternalStore","RoomHistoryManager","getConfig","debug","RoomStore","_Emitter","rid","_this","call","lastTime","scroll","lm","atBottom","on","console","log","_proto","prototype","update","_ref","undefined","emit","debugRoomManager","_Emitter2","_this2","lastRid","rooms","Map","parentRid","_proto2","visitedRooms","keys","back","getMore","close","has","delete","_open","parent","set","open","openSecondLevel","parentId","getStore","get","key","_this$parentRid","subscribeOpenedRoom","callback","opened","subscribeOpenedSecondLevelRoom","openedSecondLevel","apply"],"sources":["client/lib/RoomManager.ts"],"sourcesContent":["import type { IRoom } from '@rocket.chat/core-typings';\nimport { Emitter } from '@rocket.chat/emitter';\nimport { useSyncExternalStore } from 'use-sync-external-store/shim';\n\nimport { RoomHistoryManager } from '../../app/ui-utils/client/lib/RoomHistoryManager';\nimport { getConfig } from './utils/getConfig';\n\nconst debug = !!(getConfig('debug') || getConfig('debug-RoomStore'));\n\nclass RoomStore extends Emitter<{\n\tchanged: undefined;\n}> {\n\tlastTime?: Date;\n\n\tscroll?: number;\n\n\tlm?: Date;\n\n\tatBottom = true;\n\n\tconstructor(readonly rid: string) {\n\t\tsuper();\n\n\t\tdebug && this.on('changed', () => console.log(`RoomStore ${this.rid} changed`, this));\n\t}\n\n\tupdate({ scroll, lastTime, atBottom }: { scroll?: number; lastTime?: Date; atBottom?: boolean }): void {\n\t\tif (scroll !== undefined) {\n\t\t\tthis.scroll = scroll;\n\t\t}\n\t\tif (lastTime !== undefined) {\n\t\t\tthis.lastTime = lastTime;\n\t\t}\n\n\t\tif (atBottom !== undefined) {\n\t\t\tthis.atBottom = atBottom;\n\t\t}\n\t\tif (scroll || lastTime) {\n\t\t\tthis.emit('changed');\n\t\t}\n\t}\n}\n\nconst debugRoomManager = !!(getConfig('debug') || getConfig('debug-RoomManager'));\nexport const RoomManager = new (class RoomManager extends Emitter<{\n\tchanged: IRoom['_id'] | undefined;\n\topened: IRoom['_id'];\n\tclosed: IRoom['_id'];\n\tback: IRoom['_id'];\n\tremoved: IRoom['_id'];\n}> {\n\tprivate rid: IRoom['_id'] | undefined;\n\n\tpublic lastRid: IRoom['_id'] | undefined;\n\n\tprivate rooms: Map<IRoom['_id'], RoomStore> = new Map();\n\n\tprivate parentRid?: IRoom['_id'] | undefined;\n\n\tconstructor() {\n\t\tsuper();\n\t\tdebugRoomManager &&\n\t\t\tthis.on('opened', (rid) => {\n\t\t\t\tconsole.log('room opened ->', rid);\n\t\t\t});\n\n\t\tdebugRoomManager &&\n\t\t\tthis.on('back', (rid) => {\n\t\t\t\tconsole.log('room moved to back ->', rid);\n\t\t\t});\n\n\t\tdebugRoomManager &&\n\t\t\tthis.on('closed', (rid) => {\n\t\t\t\tconsole.log('room close ->', rid);\n\t\t\t});\n\t}\n\n\tget lastOpened(): IRoom['_id'] | undefined {\n\t\treturn this.lastRid;\n\t}\n\n\tget opened(): IRoom['_id'] | undefined {\n\t\treturn this.parentRid ?? this.rid;\n\t}\n\n\tget openedSecondLevel(): IRoom['_id'] | undefined {\n\t\tif (!this.parentRid) {\n\t\t\treturn undefined;\n\t\t}\n\t\treturn this.rid;\n\t}\n\n\tvisitedRooms(): IRoom['_id'][] {\n\t\treturn [...this.rooms.keys()];\n\t}\n\n\tback(rid: IRoom['_id']): void {\n\t\tif (rid === this.rid) {\n\t\t\tthis.lastRid = rid;\n\t\t\tthis.rid = undefined;\n\t\t\tthis.emit('back', rid);\n\t\t\tthis.emit('changed', this.rid);\n\t\t}\n\t}\n\n\tgetMore(rid: IRoom['_id']): void {\n\t\tRoomHistoryManager.getMore(rid);\n\t}\n\n\tclose(rid: IRoom['_id']): void {\n\t\tif (this.rooms.has(rid)) {\n\t\t\tthis.rooms.delete(rid);\n\t\t\tthis.emit('closed', rid);\n\t\t}\n\t\tthis.emit('changed', this.rid);\n\t}\n\n\tprivate _open(rid: IRoom['_id'], parent?: IRoom['_id']): void {\n\t\tif (rid === this.rid) {\n\t\t\treturn;\n\t\t}\n\t\tthis.back(rid);\n\t\tif (!this.rooms.has(rid)) {\n\t\t\tthis.rooms.set(rid, new RoomStore(rid));\n\t\t}\n\t\tthis.rid = rid;\n\t\tthis.parentRid = parent;\n\t\tthis.emit('opened', this.rid);\n\t\tthis.emit('changed', this.rid);\n\t}\n\n\topen(rid: IRoom['_id']): void {\n\t\tthis._open(rid);\n\t}\n\n\topenSecondLevel(parentId: IRoom['_id'], rid: IRoom['_id']): void {\n\t\tthis._open(rid, parentId);\n\t}\n\n\tgetStore(rid: IRoom['_id']): RoomStore | undefined {\n\t\treturn this.rooms.get(rid);\n\t}\n})();\n\nconst subscribeOpenedRoom = [\n\t(callback: () => void): (() => void) => RoomManager.on('changed', callback),\n\t(): IRoom['_id'] | undefined => RoomManager.opened,\n] as const;\n\nconst subscribeOpenedSecondLevelRoom = [\n\t(callback: () => void): (() => void) => RoomManager.on('changed', callback),\n\t(): IRoom['_id'] | undefined => RoomManager.openedSecondLevel,\n] as const;\n\nexport const useOpenedRoom = (): IRoom['_id'] | undefined => useSyncExternalStore(...subscribeOpenedRoom);\n\nexport const useSecondLevelOpenedRoom = (): IRoom['_id'] | undefined => useSyncExternalStore(...subscribeOpenedSecondLevelRoom);\n"],"mappings":"AACA,IAAAA,kBAAkB;AAAAC,MAAM,CAAAC,IAAA,2CAAuB;EAAAC,OAAA,WAAAA,CAAAC,CAAA;IAAAJ,kBAAA,GAAAI,CAAA;EAAA;AAAA;AAAA,IAAAC,YAAA;AAAAJ,MAAA,CAAAC,IAAA;EAAAC,OAAA,WAAAA,CAAAC,CAAA;IAAAC,YAAA,GAAAD,CAAA;EAAA;AAAA;AAAA,IAAAE,cAAA;AAAAL,MAAA,CAAAC,IAAA;EAAAC,OAAA,WAAAA,CAAAC,CAAA;IAAAE,cAAA,GAAAF,CAAA;EAAA;AAAA;AAA/CH,MAAA,CAAOM,MAAE;EAAAC,WAAe,WAAAA,CAAA;IAAA,OAAAA,WAAuB;EAAA;EAAAC,aAAA,WAAAA,CAAA;IAAA,OAAAA,aAAA;EAAA;EAAAC,wBAAA,WAAAA,CAAA;IAAA,OAAAA,wBAAA;EAAA;AAAA;AAAA,IAAAC,OAAA;AAAAV,MAAA,CAAAC,IAAA;EAAAS,OAAA,WAAAA,CAAAP,CAAA;IAAAO,OAAA,GAAAP,CAAA;EAAA;AAAA;AAAA,IAAAQ,oBAAA;AAAAX,MAAA,CAAAC,IAAA;EAAAU,oBAAA,WAAAA,CAAAR,CAAA;IAAAQ,oBAAA,GAAAR,CAAA;EAAA;AAAA;AAAA,IAAAS,kBAAA;AAAAZ,MAAA,CAAAC,IAAA;EAAAW,kBAAA,WAAAA,CAAAT,CAAA;IAAAS,kBAAA,GAAAT,CAAA;EAAA;AAAA;AAAA,IAAAU,SAAA;AAAAb,MAAA,CAAAC,IAAA;EAAAY,SAAA,WAAAA,CAAAV,CAAA;IAAAU,SAAA,GAAAV,CAAA;EAAA;AAAA;AAM/C,IAAMW,KAAK,GAAG,CAAC,EAAED,SAAS,CAAC,OAAO,CAAC,IAAIA,SAAS,CAAC,iBAAiB,CAAC,CAAC;AAAC,IAE/DE,SAAU,0BAAAC,QAAA;EAWf,SAAAD,UAAqBE,GAAW;IAAA,IAAAC,KAAA;IAC/BA,KAAA,GAAAF,QAAA,CAAAG,IAAA,KAAK,CAAE;IAACD,KAAA,CADYD,GAAA;IAAAC,KAAA,CARrBE,QAAQ;IAAAF,KAAA,CAERG,MAAM;IAAAH,KAAA,CAENI,EAAE;IAAAJ,KAAA,CAEFK,QAAQ,GAAG,IAAI;IAEML,KAAA,CAAAD,GAAG,GAAHA,GAAG;IAGvBH,KAAK,IAAII,KAAA,CAAKM,EAAE,CAAC,SAAS,EAAE;MAAA,OAAMC,OAAO,CAACC,GAAG,gBAAcR,KAAA,CAAKD,GAAG,eAAAC,KAAgB,CAAC;IAAA,EAAC;IAAC,OAAAA,KAAA;EACvF;EAACb,cAAA,CAAAU,SAAA,EAAAC,QAAA;EAAA,IAAAW,MAAA,GAAAZ,SAAA,CAAAa,SAAA;EAAAD,MAAA,CAEDE,MAAM;IAAN,SAAAA,OAAAC,IAAA,EAA+F;MAAA,IAAtFT,MAAM,GAAAS,IAAA,CAANT,MAAM;QAAED,QAAQ,GAAAU,IAAA,CAARV,QAAQ;QAAEG,QAAQ,GAAAO,IAAA,CAARP,QAAQ;MAClC,IAAIF,MAAM,KAAKU,SAAS,EAAE;QACzB,IAAI,CAACV,MAAM,GAAGA,MAAM;MACrB;MACA,IAAID,QAAQ,KAAKW,SAAS,EAAE;QAC3B,IAAI,CAACX,QAAQ,GAAGA,QAAQ;MACzB;MAEA,IAAIG,QAAQ,KAAKQ,SAAS,EAAE;QAC3B,IAAI,CAACR,QAAQ,GAAGA,QAAQ;MACzB;MACA,IAAIF,MAAM,IAAID,QAAQ,EAAE;QACvB,IAAI,CAACY,IAAI,CAAC,SAAS,CAAC;MACrB;IACD;IAAC,OAAAH,MAAA;EAAA;EAAA,OAAAd,SAAA;AAAA,EA/BsBL,OAEtB;AAgCF,IAAMuB,gBAAgB,GAAG,CAAC,EAAEpB,SAAS,CAAC,OAAO,CAAC,IAAIA,SAAS,CAAC,mBAAmB,CAAC,CAAC;AAC1E,IAAMN,WAAW,GAAG,6BAAA2B,SAAA;EAe1B,SAAA3B,YAAA;IAAA,IAAA4B,MAAA;IACCA,MAAA,GAAAD,SAAA,CAAAf,IAAA,KAAK,CAAE;IAACgB,MAAA,CATDlB,GAAG;IAAAkB,MAAA,CAEJC,OAAO;IAAAD,MAAA,CAENE,KAAK,GAAiC,IAAIC,GAAG,EAAE;IAAAH,MAAA,CAE/CI,SAAS;IAIhBN,gBAAgB,IACfE,MAAA,CAAKX,EAAE,CAAC,QAAQ,EAAE,UAACP,GAAG,EAAI;MACzBQ,OAAO,CAACC,GAAG,CAAC,gBAAgB,EAAET,GAAG,CAAC;IACnC,CAAC,CAAC;IAEHgB,gBAAgB,IACfE,MAAA,CAAKX,EAAE,CAAC,MAAM,EAAE,UAACP,GAAG,EAAI;MACvBQ,OAAO,CAACC,GAAG,CAAC,uBAAuB,EAAET,GAAG,CAAC;IAC1C,CAAC,CAAC;IAEHgB,gBAAgB,IACfE,MAAA,CAAKX,EAAE,CAAC,QAAQ,EAAE,UAACP,GAAG,EAAI;MACzBQ,OAAO,CAACC,GAAG,CAAC,eAAe,EAAET,GAAG,CAAC;IAClC,CAAC,CAAC;IAAC,OAAAkB,MAAA;EACL;EAAC9B,cAAA,CAAAE,WAAA,EAAA2B,SAAA;EAAA,IAAAM,OAAA,GAAAjC,WAAA,CAAAqB,SAAA;EAAAY,OAAA,CAiBDC,YAAY;IAAZ,SAAAA,aAAA,EAAY;MACX,OAAA1C,kBAAA,CAAW,IAAI,CAACsC,KAAK,CAACK,IAAI,EAAE;IAC7B;IAAC,OAAAD,YAAA;EAAA;EAAAD,OAAA,CAEDG,IAAI;IAAJ,SAAAA,KAAK1B,GAAiB;MACrB,IAAIA,GAAG,KAAK,IAAI,CAACA,GAAG,EAAE;QACrB,IAAI,CAACmB,OAAO,GAAGnB,GAAG;QAClB,IAAI,CAACA,GAAG,GAAGc,SAAS;QACpB,IAAI,CAACC,IAAI,CAAC,MAAM,EAAEf,GAAG,CAAC;QACtB,IAAI,CAACe,IAAI,CAAC,SAAS,EAAE,IAAI,CAACf,GAAG,CAAC;MAC/B;IACD;IAAC,OAAA0B,IAAA;EAAA;EAAAH,OAAA,CAEDI,OAAO;IAAP,SAAAA,QAAQ3B,GAAiB;MACxBL,kBAAkB,CAACgC,OAAO,CAAC3B,GAAG,CAAC;IAChC;IAAC,OAAA2B,OAAA;EAAA;EAAAJ,OAAA,CAEDK,KAAK;IAAL,SAAAA,MAAM5B,GAAiB;MACtB,IAAI,IAAI,CAACoB,KAAK,CAACS,GAAG,CAAC7B,GAAG,CAAC,EAAE;QACxB,IAAI,CAACoB,KAAK,CAACU,MAAM,CAAC9B,GAAG,CAAC;QACtB,IAAI,CAACe,IAAI,CAAC,QAAQ,EAAEf,GAAG,CAAC;MACzB;MACA,IAAI,CAACe,IAAI,CAAC,SAAS,EAAE,IAAI,CAACf,GAAG,CAAC;IAC/B;IAAC,OAAA4B,KAAA;EAAA;EAAAL,OAAA,CAEOQ,KAAK;IAAL,SAAAA,MAAM/B,GAAiB,EAAEgC,MAAqB;MACrD,IAAIhC,GAAG,KAAK,IAAI,CAACA,GAAG,EAAE;QACrB;MACD;MACA,IAAI,CAAC0B,IAAI,CAAC1B,GAAG,CAAC;MACd,IAAI,CAAC,IAAI,CAACoB,KAAK,CAACS,GAAG,CAAC7B,GAAG,CAAC,EAAE;QACzB,IAAI,CAACoB,KAAK,CAACa,GAAG,CAACjC,GAAG,EAAE,IAAIF,SAAS,CAACE,GAAG,CAAC,CAAC;MACxC;MACA,IAAI,CAACA,GAAG,GAAGA,GAAG;MACd,IAAI,CAACsB,SAAS,GAAGU,MAAM;MACvB,IAAI,CAACjB,IAAI,CAAC,QAAQ,EAAE,IAAI,CAACf,GAAG,CAAC;MAC7B,IAAI,CAACe,IAAI,CAAC,SAAS,EAAE,IAAI,CAACf,GAAG,CAAC;IAC/B;IAAC,OAAA+B,KAAA;EAAA;EAAAR,OAAA,CAEDW,IAAI;IAAJ,SAAAA,KAAKlC,GAAiB;MACrB,IAAI,CAAC+B,KAAK,CAAC/B,GAAG,CAAC;IAChB;IAAC,OAAAkC,IAAA;EAAA;EAAAX,OAAA,CAEDY,eAAe;IAAf,SAAAA,gBAAgBC,QAAsB,EAAEpC,GAAiB;MACxD,IAAI,CAAC+B,KAAK,CAAC/B,GAAG,EAAEoC,QAAQ,CAAC;IAC1B;IAAC,OAAAD,eAAA;EAAA;EAAAZ,OAAA,CAEDc,QAAQ;IAAR,SAAAA,SAASrC,GAAiB;MACzB,OAAO,IAAI,CAACoB,KAAK,CAACkB,GAAG,CAACtC,GAAG,CAAC;IAC3B;IAAC,OAAAqC,QAAA;EAAA;EAAA,OAAAlD,YAAA,CAAAG,WAAA;IAAAiD,GAAA;IAAAD,GAAA,EAhED,SAAAA,CAAA,EAAc;MACb,OAAO,IAAI,CAACnB,OAAO;IACpB;EAAC;IAAAoB,GAAA;IAAAD,GAAA,EAED,SAAAA,CAAA,EAAU;MAAA,IAAAE,eAAA;MACT,QAAAA,eAAA,GAAO,IAAI,CAAClB,SAAS,cAAAkB,eAAA,cAAAA,eAAA,GAAI,IAAI,CAACxC,GAAG;IAClC;EAAC;IAAAuC,GAAA;IAAAD,GAAA,EAED,SAAAA,CAAA,EAAqB;MACpB,IAAI,CAAC,IAAI,CAAChB,SAAS,EAAE;QACpB,OAAOR,SAAS;MACjB;MACA,OAAO,IAAI,CAACd,GAAG;IAChB;EAAC;AAAA,EA9CwDP,OAMxD,GA4FA,CAAE;AAEJ,IAAMgD,mBAAmB,GAAG,CAC3B,UAACC,QAAoB;EAAA,OAAmBpD,WAAW,CAACiB,EAAE,CAAC,SAAS,EAAEmC,QAAQ,CAAC;AAAA,GAC3E;EAAA,OAAgCpD,WAAW,CAACqD,MAAM;AAAA,EACzC;AAEV,IAAMC,8BAA8B,GAAG,CACtC,UAACF,QAAoB;EAAA,OAAmBpD,WAAW,CAACiB,EAAE,CAAC,SAAS,EAAEmC,QAAQ,CAAC;AAAA,GAC3E;EAAA,OAAgCpD,WAAW,CAACuD,iBAAiB;AAAA,EACpD;AAEH,IAAMtD,aAAa,GAAG,SAAAA,CAAA;EAAA,OAAgCG,oBAAoB,CAAAoD,KAAA,SAAIL,mBAAmB,CAAC;AAAA;AAElG,IAAMjD,wBAAwB,GAAG,SAAAA,CAAA;EAAA,OAAgCE,oBAAoB,CAAAoD,KAAA,SAAIF,8BAA8B,CAAC;AAAA","ignoreList":[]},"sourceType":"module","externalDependencies":{},"hash":"673b058d50cf7e33a0c226bfaf51de8109aaaf94"}
