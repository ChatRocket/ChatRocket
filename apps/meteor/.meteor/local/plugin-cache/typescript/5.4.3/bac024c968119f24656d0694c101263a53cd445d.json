{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/ee/server/api/sessions.ts","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","topLevelAwait","objectRestSpread","objectRestSpread","asyncGenerators","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"os.osx.arm64"},"sourceFileName":"ee/server/api/sessions.ts","filename":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/ee/server/api/sessions.ts","inputSourceMap":{"version":3,"file":"ee/server/api/sessions.ts","sourceRoot":"","sources":["ee/server/api/sessions.ts"],"names":[],"mappings":"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","sourcesContent":["import { api } from '@rocket.chat/core-services';\nimport type { IUser, ISession, DeviceManagementSession, DeviceManagementPopulatedSession } from '@rocket.chat/core-typings';\nimport { License } from '@rocket.chat/license';\nimport { Users, Sessions } from '@rocket.chat/models';\nimport type { PaginatedResult, PaginatedRequest } from '@rocket.chat/rest-typings';\nimport { escapeRegExp } from '@rocket.chat/string-helpers';\nimport Ajv from 'ajv';\n\nimport { API } from '../../../app/api/server/api';\nimport { getPaginationItems } from '../../../app/api/server/helpers/getPaginationItems';\n\nconst ajv = new Ajv({ coerceTypes: true });\n\ntype SessionsProps = {\n\tsessionId: string;\n};\n\nconst isSessionsProps = ajv.compile<SessionsProps>({\n\ttype: 'object',\n\tproperties: {\n\t\tsessionId: {\n\t\t\ttype: 'string',\n\t\t},\n\t},\n\trequired: ['sessionId'],\n\tadditionalProperties: false,\n});\n\ntype SessionsPaginateProps = PaginatedRequest<{\n\tfilter?: string;\n}>;\n\nconst isSessionsPaginateProps = ajv.compile<SessionsPaginateProps>({\n\ttype: 'object',\n\tproperties: {\n\t\toffset: {\n\t\t\ttype: 'number',\n\t\t},\n\t\tcount: {\n\t\t\ttype: 'number',\n\t\t},\n\t\tfilter: {\n\t\t\ttype: 'string',\n\t\t},\n\t\tsort: {\n\t\t\ttype: 'string',\n\t\t},\n\t},\n\trequired: [],\n\tadditionalProperties: false,\n});\n\nconst validateSortKeys = (sortKeys: string[]): boolean => {\n\tconst validSortKeys = ['loginAt', 'device.name', 'device.os.name', 'device.os.version', '_user.name', '_user.username'];\n\n\treturn sortKeys.every((s) => validSortKeys.includes(s));\n};\n\ndeclare module '@rocket.chat/rest-typings' {\n\t// eslint-disable-next-line @typescript-eslint/naming-convention\n\tinterface Endpoints {\n\t\t'/v1/sessions/list': {\n\t\t\tGET: (params: SessionsPaginateProps) => PaginatedResult<{ sessions: Array<DeviceManagementSession> }>;\n\t\t};\n\t\t'/v1/sessions/info': {\n\t\t\tGET: (params: SessionsProps) => DeviceManagementSession;\n\t\t};\n\t\t'/v1/sessions/logout.me': {\n\t\t\tPOST: (params: SessionsProps) => Pick<ISession, 'sessionId'>;\n\t\t};\n\t\t'/v1/sessions/list.all': {\n\t\t\tGET: (params: SessionsPaginateProps) => PaginatedResult<{ sessions: Array<DeviceManagementPopulatedSession> }>;\n\t\t};\n\t\t'/v1/sessions/info.admin': {\n\t\t\tGET: (params: SessionsProps) => DeviceManagementPopulatedSession;\n\t\t};\n\t\t'/v1/sessions/logout': {\n\t\t\tPOST: (params: SessionsProps) => Pick<ISession, 'sessionId'>;\n\t\t};\n\t}\n}\n\nAPI.v1.addRoute(\n\t'sessions/list',\n\t{ authRequired: true, validateParams: isSessionsPaginateProps },\n\t{\n\t\tasync get() {\n\t\t\tif (!License.hasModule('device-management')) {\n\t\t\t\treturn API.v1.forbidden();\n\t\t\t}\n\n\t\t\tconst { offset, count } = await getPaginationItems(this.queryParams);\n\t\t\tconst { sort = { loginAt: -1 } } = await this.parseJsonQuery();\n\t\t\tconst search = escapeRegExp(this.queryParams?.filter || '');\n\n\t\t\tif (!validateSortKeys(Object.keys(sort))) {\n\t\t\t\treturn API.v1.failure('error-invalid-sort-keys');\n\t\t\t}\n\n\t\t\tconst sessions = await Sessions.aggregateSessionsByUserId({ uid: this.userId, search, sort, offset, count });\n\t\t\treturn API.v1.success(sessions);\n\t\t},\n\t},\n);\n\nAPI.v1.addRoute(\n\t'sessions/info',\n\t{ authRequired: true, validateParams: isSessionsProps },\n\t{\n\t\tasync get() {\n\t\t\tif (!License.hasModule('device-management')) {\n\t\t\t\treturn API.v1.forbidden();\n\t\t\t}\n\n\t\t\tconst { sessionId } = this.queryParams;\n\t\t\tconst sessions = await Sessions.findOneBySessionIdAndUserId(sessionId, this.userId);\n\t\t\tif (!sessions) {\n\t\t\t\treturn API.v1.notFound('Session not found');\n\t\t\t}\n\t\t\treturn API.v1.success(sessions);\n\t\t},\n\t},\n);\n\nAPI.v1.addRoute(\n\t'sessions/logout.me',\n\t{ authRequired: true, validateParams: isSessionsProps },\n\t{\n\t\tasync post() {\n\t\t\tif (!License.hasModule('device-management')) {\n\t\t\t\treturn API.v1.forbidden();\n\t\t\t}\n\n\t\t\tconst { sessionId } = this.bodyParams;\n\t\t\tconst sessionObj = await Sessions.findOneBySessionIdAndUserId(sessionId, this.userId);\n\n\t\t\tif (!sessionObj?.loginToken) {\n\t\t\t\treturn API.v1.notFound('Session not found');\n\t\t\t}\n\n\t\t\tawait Promise.all([\n\t\t\t\tUsers.unsetOneLoginToken(this.userId, sessionObj.loginToken),\n\t\t\t\tSessions.logoutByloginTokenAndUserId({ loginToken: sessionObj.loginToken, userId: this.userId }),\n\t\t\t]);\n\n\t\t\treturn API.v1.success({ sessionId });\n\t\t},\n\t},\n);\n\nAPI.v1.addRoute(\n\t'sessions/list.all',\n\t{ authRequired: true, twoFactorRequired: true, validateParams: isSessionsPaginateProps, permissionsRequired: ['view-device-management'] },\n\t{\n\t\tasync get() {\n\t\t\tif (!License.hasModule('device-management')) {\n\t\t\t\treturn API.v1.forbidden();\n\t\t\t}\n\n\t\t\tconst { offset, count } = await getPaginationItems(this.queryParams);\n\t\t\tconst { sort = { loginAt: -1 } } = await this.parseJsonQuery();\n\t\t\tconst filter = escapeRegExp(this.queryParams?.filter || '');\n\n\t\t\tif (!validateSortKeys(Object.keys(sort))) {\n\t\t\t\treturn API.v1.failure('error-invalid-sort-keys');\n\t\t\t}\n\n\t\t\tconst search: string[] = [];\n\n\t\t\tif (filter) {\n\t\t\t\tsearch.push(filter);\n\n\t\t\t\tsearch.push(\n\t\t\t\t\t...(await Users.findActiveByUsernameOrNameRegexWithExceptionsAndConditions<Pick<IUser, '_id'>>(\n\t\t\t\t\t\t{ $regex: filter, $options: 'i' },\n\t\t\t\t\t\t[],\n\t\t\t\t\t\t{},\n\t\t\t\t\t\t{ projection: { _id: 1 }, limit: 5 },\n\t\t\t\t\t)\n\t\t\t\t\t\t.map((el) => el._id)\n\t\t\t\t\t\t.toArray()),\n\t\t\t\t);\n\t\t\t}\n\n\t\t\tconst sessions = await Sessions.aggregateSessionsAndPopulate({ search: search.join('|'), sort, offset, count });\n\t\t\treturn API.v1.success(sessions);\n\t\t},\n\t},\n);\n\nAPI.v1.addRoute(\n\t'sessions/info.admin',\n\t{ authRequired: true, twoFactorRequired: true, validateParams: isSessionsProps, permissionsRequired: ['view-device-management'] },\n\t{\n\t\tasync get() {\n\t\t\tif (!License.hasModule('device-management')) {\n\t\t\t\treturn API.v1.forbidden();\n\t\t\t}\n\n\t\t\tconst sessionId = this.queryParams?.sessionId as string;\n\t\t\tconst { sessions } = await Sessions.aggregateSessionsAndPopulate({ search: sessionId, count: 1 });\n\t\t\tif (!sessions?.length) {\n\t\t\t\treturn API.v1.notFound('Session not found');\n\t\t\t}\n\t\t\treturn API.v1.success(sessions[0]);\n\t\t},\n\t},\n);\n\nAPI.v1.addRoute(\n\t'sessions/logout',\n\t{ authRequired: true, twoFactorRequired: true, validateParams: isSessionsProps, permissionsRequired: ['logout-device-management'] },\n\t{\n\t\tasync post() {\n\t\t\tif (!License.hasModule('device-management')) {\n\t\t\t\treturn API.v1.forbidden();\n\t\t\t}\n\n\t\t\tconst { sessionId } = this.bodyParams;\n\t\t\tconst sessionObj = await Sessions.findOneBySessionId(sessionId);\n\n\t\t\tif (!sessionObj?.loginToken) {\n\t\t\t\treturn API.v1.notFound('Session not found');\n\t\t\t}\n\n\t\t\tawait api.broadcast('user.forceLogout', sessionObj.userId);\n\n\t\t\tawait Promise.all([\n\t\t\t\tUsers.unsetOneLoginToken(sessionObj.userId, sessionObj.loginToken),\n\t\t\t\tSessions.logoutByloginTokenAndUserId({ loginToken: sessionObj.loginToken, userId: sessionObj.userId, logoutBy: this.userId }),\n\t\t\t]);\n\n\t\t\treturn API.v1.success({ sessionId });\n\t\t},\n\t},\n);\n"]},"targets":{"android":"125.0.0","chrome":"125.0.0","edge":"125.0.0","firefox":"115.0.0","ie":"10.0.0","ios":"17.4.0","opera":"110.0.0","opera_mobile":"80.0.0","safari":"17.4.0","samsung":"24.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor","root":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":false,"enforceStrictMode":false,"dynamicImport":true,"generateLetDeclarations":true,"topLevelAwait":true},"externalDependencies":[]},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"version":"7.17.2","helpers":true,"useESModules":false,"corejs":false},"externalDependencies":[]},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-async-generator-functions","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-class-properties","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true},"externalDependencies":[]},{"key":"transform-react-jsx","visitor":{"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXFragment":{"exit":[null]},"JSXElement":{"exit":[null]},"JSXAttribute":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false},"externalDependencies":[]},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-nullish-coalescing-operator","visitor":{"LogicalExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-optional-chaining","visitor":{"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-optional-catch-binding","visitor":{"CatchClause":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-class-properties","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-async-generator-functions","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-logical-assignment-operators","visitor":{"AssignmentExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]}],"presets":[],"generatorOpts":{"filename":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/ee/server/api/sessions.ts","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"ee/server/api/sessions.ts","inputSourceMap":{"version":3,"file":"ee/server/api/sessions.ts","sourceRoot":"","sources":["ee/server/api/sessions.ts"],"names":[],"mappings":"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","sourcesContent":["import { api } from '@rocket.chat/core-services';\nimport type { IUser, ISession, DeviceManagementSession, DeviceManagementPopulatedSession } from '@rocket.chat/core-typings';\nimport { License } from '@rocket.chat/license';\nimport { Users, Sessions } from '@rocket.chat/models';\nimport type { PaginatedResult, PaginatedRequest } from '@rocket.chat/rest-typings';\nimport { escapeRegExp } from '@rocket.chat/string-helpers';\nimport Ajv from 'ajv';\n\nimport { API } from '../../../app/api/server/api';\nimport { getPaginationItems } from '../../../app/api/server/helpers/getPaginationItems';\n\nconst ajv = new Ajv({ coerceTypes: true });\n\ntype SessionsProps = {\n\tsessionId: string;\n};\n\nconst isSessionsProps = ajv.compile<SessionsProps>({\n\ttype: 'object',\n\tproperties: {\n\t\tsessionId: {\n\t\t\ttype: 'string',\n\t\t},\n\t},\n\trequired: ['sessionId'],\n\tadditionalProperties: false,\n});\n\ntype SessionsPaginateProps = PaginatedRequest<{\n\tfilter?: string;\n}>;\n\nconst isSessionsPaginateProps = ajv.compile<SessionsPaginateProps>({\n\ttype: 'object',\n\tproperties: {\n\t\toffset: {\n\t\t\ttype: 'number',\n\t\t},\n\t\tcount: {\n\t\t\ttype: 'number',\n\t\t},\n\t\tfilter: {\n\t\t\ttype: 'string',\n\t\t},\n\t\tsort: {\n\t\t\ttype: 'string',\n\t\t},\n\t},\n\trequired: [],\n\tadditionalProperties: false,\n});\n\nconst validateSortKeys = (sortKeys: string[]): boolean => {\n\tconst validSortKeys = ['loginAt', 'device.name', 'device.os.name', 'device.os.version', '_user.name', '_user.username'];\n\n\treturn sortKeys.every((s) => validSortKeys.includes(s));\n};\n\ndeclare module '@rocket.chat/rest-typings' {\n\t// eslint-disable-next-line @typescript-eslint/naming-convention\n\tinterface Endpoints {\n\t\t'/v1/sessions/list': {\n\t\t\tGET: (params: SessionsPaginateProps) => PaginatedResult<{ sessions: Array<DeviceManagementSession> }>;\n\t\t};\n\t\t'/v1/sessions/info': {\n\t\t\tGET: (params: SessionsProps) => DeviceManagementSession;\n\t\t};\n\t\t'/v1/sessions/logout.me': {\n\t\t\tPOST: (params: SessionsProps) => Pick<ISession, 'sessionId'>;\n\t\t};\n\t\t'/v1/sessions/list.all': {\n\t\t\tGET: (params: SessionsPaginateProps) => PaginatedResult<{ sessions: Array<DeviceManagementPopulatedSession> }>;\n\t\t};\n\t\t'/v1/sessions/info.admin': {\n\t\t\tGET: (params: SessionsProps) => DeviceManagementPopulatedSession;\n\t\t};\n\t\t'/v1/sessions/logout': {\n\t\t\tPOST: (params: SessionsProps) => Pick<ISession, 'sessionId'>;\n\t\t};\n\t}\n}\n\nAPI.v1.addRoute(\n\t'sessions/list',\n\t{ authRequired: true, validateParams: isSessionsPaginateProps },\n\t{\n\t\tasync get() {\n\t\t\tif (!License.hasModule('device-management')) {\n\t\t\t\treturn API.v1.forbidden();\n\t\t\t}\n\n\t\t\tconst { offset, count } = await getPaginationItems(this.queryParams);\n\t\t\tconst { sort = { loginAt: -1 } } = await this.parseJsonQuery();\n\t\t\tconst search = escapeRegExp(this.queryParams?.filter || '');\n\n\t\t\tif (!validateSortKeys(Object.keys(sort))) {\n\t\t\t\treturn API.v1.failure('error-invalid-sort-keys');\n\t\t\t}\n\n\t\t\tconst sessions = await Sessions.aggregateSessionsByUserId({ uid: this.userId, search, sort, offset, count });\n\t\t\treturn API.v1.success(sessions);\n\t\t},\n\t},\n);\n\nAPI.v1.addRoute(\n\t'sessions/info',\n\t{ authRequired: true, validateParams: isSessionsProps },\n\t{\n\t\tasync get() {\n\t\t\tif (!License.hasModule('device-management')) {\n\t\t\t\treturn API.v1.forbidden();\n\t\t\t}\n\n\t\t\tconst { sessionId } = this.queryParams;\n\t\t\tconst sessions = await Sessions.findOneBySessionIdAndUserId(sessionId, this.userId);\n\t\t\tif (!sessions) {\n\t\t\t\treturn API.v1.notFound('Session not found');\n\t\t\t}\n\t\t\treturn API.v1.success(sessions);\n\t\t},\n\t},\n);\n\nAPI.v1.addRoute(\n\t'sessions/logout.me',\n\t{ authRequired: true, validateParams: isSessionsProps },\n\t{\n\t\tasync post() {\n\t\t\tif (!License.hasModule('device-management')) {\n\t\t\t\treturn API.v1.forbidden();\n\t\t\t}\n\n\t\t\tconst { sessionId } = this.bodyParams;\n\t\t\tconst sessionObj = await Sessions.findOneBySessionIdAndUserId(sessionId, this.userId);\n\n\t\t\tif (!sessionObj?.loginToken) {\n\t\t\t\treturn API.v1.notFound('Session not found');\n\t\t\t}\n\n\t\t\tawait Promise.all([\n\t\t\t\tUsers.unsetOneLoginToken(this.userId, sessionObj.loginToken),\n\t\t\t\tSessions.logoutByloginTokenAndUserId({ loginToken: sessionObj.loginToken, userId: this.userId }),\n\t\t\t]);\n\n\t\t\treturn API.v1.success({ sessionId });\n\t\t},\n\t},\n);\n\nAPI.v1.addRoute(\n\t'sessions/list.all',\n\t{ authRequired: true, twoFactorRequired: true, validateParams: isSessionsPaginateProps, permissionsRequired: ['view-device-management'] },\n\t{\n\t\tasync get() {\n\t\t\tif (!License.hasModule('device-management')) {\n\t\t\t\treturn API.v1.forbidden();\n\t\t\t}\n\n\t\t\tconst { offset, count } = await getPaginationItems(this.queryParams);\n\t\t\tconst { sort = { loginAt: -1 } } = await this.parseJsonQuery();\n\t\t\tconst filter = escapeRegExp(this.queryParams?.filter || '');\n\n\t\t\tif (!validateSortKeys(Object.keys(sort))) {\n\t\t\t\treturn API.v1.failure('error-invalid-sort-keys');\n\t\t\t}\n\n\t\t\tconst search: string[] = [];\n\n\t\t\tif (filter) {\n\t\t\t\tsearch.push(filter);\n\n\t\t\t\tsearch.push(\n\t\t\t\t\t...(await Users.findActiveByUsernameOrNameRegexWithExceptionsAndConditions<Pick<IUser, '_id'>>(\n\t\t\t\t\t\t{ $regex: filter, $options: 'i' },\n\t\t\t\t\t\t[],\n\t\t\t\t\t\t{},\n\t\t\t\t\t\t{ projection: { _id: 1 }, limit: 5 },\n\t\t\t\t\t)\n\t\t\t\t\t\t.map((el) => el._id)\n\t\t\t\t\t\t.toArray()),\n\t\t\t\t);\n\t\t\t}\n\n\t\t\tconst sessions = await Sessions.aggregateSessionsAndPopulate({ search: search.join('|'), sort, offset, count });\n\t\t\treturn API.v1.success(sessions);\n\t\t},\n\t},\n);\n\nAPI.v1.addRoute(\n\t'sessions/info.admin',\n\t{ authRequired: true, twoFactorRequired: true, validateParams: isSessionsProps, permissionsRequired: ['view-device-management'] },\n\t{\n\t\tasync get() {\n\t\t\tif (!License.hasModule('device-management')) {\n\t\t\t\treturn API.v1.forbidden();\n\t\t\t}\n\n\t\t\tconst sessionId = this.queryParams?.sessionId as string;\n\t\t\tconst { sessions } = await Sessions.aggregateSessionsAndPopulate({ search: sessionId, count: 1 });\n\t\t\tif (!sessions?.length) {\n\t\t\t\treturn API.v1.notFound('Session not found');\n\t\t\t}\n\t\t\treturn API.v1.success(sessions[0]);\n\t\t},\n\t},\n);\n\nAPI.v1.addRoute(\n\t'sessions/logout',\n\t{ authRequired: true, twoFactorRequired: true, validateParams: isSessionsProps, permissionsRequired: ['logout-device-management'] },\n\t{\n\t\tasync post() {\n\t\t\tif (!License.hasModule('device-management')) {\n\t\t\t\treturn API.v1.forbidden();\n\t\t\t}\n\n\t\t\tconst { sessionId } = this.bodyParams;\n\t\t\tconst sessionObj = await Sessions.findOneBySessionId(sessionId);\n\n\t\t\tif (!sessionObj?.loginToken) {\n\t\t\t\treturn API.v1.notFound('Session not found');\n\t\t\t}\n\n\t\t\tawait api.broadcast('user.forceLogout', sessionObj.userId);\n\n\t\t\tawait Promise.all([\n\t\t\t\tUsers.unsetOneLoginToken(sessionObj.userId, sessionObj.loginToken),\n\t\t\t\tSessions.logoutByloginTokenAndUserId({ loginToken: sessionObj.loginToken, userId: sessionObj.userId, logoutBy: this.userId }),\n\t\t\t]);\n\n\t\t\treturn API.v1.success({ sessionId });\n\t\t},\n\t},\n);\n"]}}},"code":"!module.wrapAsync(async function (module, __reifyWaitForDeps__, __reify_async_result__) {\n  \"use strict\";\n  try {\n    let api;\n    module.link(\"@rocket.chat/core-services\", {\n      api(v) {\n        api = v;\n      }\n    }, 0);\n    let License;\n    module.link(\"@rocket.chat/license\", {\n      License(v) {\n        License = v;\n      }\n    }, 1);\n    let Users, Sessions;\n    module.link(\"@rocket.chat/models\", {\n      Users(v) {\n        Users = v;\n      },\n      Sessions(v) {\n        Sessions = v;\n      }\n    }, 2);\n    let escapeRegExp;\n    module.link(\"@rocket.chat/string-helpers\", {\n      escapeRegExp(v) {\n        escapeRegExp = v;\n      }\n    }, 3);\n    let Ajv;\n    module.link(\"ajv\", {\n      default(v) {\n        Ajv = v;\n      }\n    }, 4);\n    let API;\n    module.link(\"../../../app/api/server/api\", {\n      API(v) {\n        API = v;\n      }\n    }, 5);\n    let getPaginationItems;\n    module.link(\"../../../app/api/server/helpers/getPaginationItems\", {\n      getPaginationItems(v) {\n        getPaginationItems = v;\n      }\n    }, 6);\n    if (__reifyWaitForDeps__()) (await __reifyWaitForDeps__())();\n    const ajv = new Ajv({\n      coerceTypes: true\n    });\n    const isSessionsProps = ajv.compile({\n      type: 'object',\n      properties: {\n        sessionId: {\n          type: 'string'\n        }\n      },\n      required: ['sessionId'],\n      additionalProperties: false\n    });\n    const isSessionsPaginateProps = ajv.compile({\n      type: 'object',\n      properties: {\n        offset: {\n          type: 'number'\n        },\n        count: {\n          type: 'number'\n        },\n        filter: {\n          type: 'string'\n        },\n        sort: {\n          type: 'string'\n        }\n      },\n      required: [],\n      additionalProperties: false\n    });\n    const validateSortKeys = sortKeys => {\n      const validSortKeys = ['loginAt', 'device.name', 'device.os.name', 'device.os.version', '_user.name', '_user.username'];\n      return sortKeys.every(s => validSortKeys.includes(s));\n    };\n    API.v1.addRoute('sessions/list', {\n      authRequired: true,\n      validateParams: isSessionsPaginateProps\n    }, {\n      async get() {\n        var _this$queryParams;\n        if (!License.hasModule('device-management')) {\n          return API.v1.forbidden();\n        }\n        const {\n          offset,\n          count\n        } = await getPaginationItems(this.queryParams);\n        const {\n          sort = {\n            loginAt: -1\n          }\n        } = await this.parseJsonQuery();\n        const search = escapeRegExp(((_this$queryParams = this.queryParams) === null || _this$queryParams === void 0 ? void 0 : _this$queryParams.filter) || '');\n        if (!validateSortKeys(Object.keys(sort))) {\n          return API.v1.failure('error-invalid-sort-keys');\n        }\n        const sessions = await Sessions.aggregateSessionsByUserId({\n          uid: this.userId,\n          search,\n          sort,\n          offset,\n          count\n        });\n        return API.v1.success(sessions);\n      }\n    });\n    API.v1.addRoute('sessions/info', {\n      authRequired: true,\n      validateParams: isSessionsProps\n    }, {\n      async get() {\n        if (!License.hasModule('device-management')) {\n          return API.v1.forbidden();\n        }\n        const {\n          sessionId\n        } = this.queryParams;\n        const sessions = await Sessions.findOneBySessionIdAndUserId(sessionId, this.userId);\n        if (!sessions) {\n          return API.v1.notFound('Session not found');\n        }\n        return API.v1.success(sessions);\n      }\n    });\n    API.v1.addRoute('sessions/logout.me', {\n      authRequired: true,\n      validateParams: isSessionsProps\n    }, {\n      async post() {\n        if (!License.hasModule('device-management')) {\n          return API.v1.forbidden();\n        }\n        const {\n          sessionId\n        } = this.bodyParams;\n        const sessionObj = await Sessions.findOneBySessionIdAndUserId(sessionId, this.userId);\n        if (!(sessionObj !== null && sessionObj !== void 0 && sessionObj.loginToken)) {\n          return API.v1.notFound('Session not found');\n        }\n        await Promise.all([Users.unsetOneLoginToken(this.userId, sessionObj.loginToken), Sessions.logoutByloginTokenAndUserId({\n          loginToken: sessionObj.loginToken,\n          userId: this.userId\n        })]);\n        return API.v1.success({\n          sessionId\n        });\n      }\n    });\n    API.v1.addRoute('sessions/list.all', {\n      authRequired: true,\n      twoFactorRequired: true,\n      validateParams: isSessionsPaginateProps,\n      permissionsRequired: ['view-device-management']\n    }, {\n      async get() {\n        var _this$queryParams2;\n        if (!License.hasModule('device-management')) {\n          return API.v1.forbidden();\n        }\n        const {\n          offset,\n          count\n        } = await getPaginationItems(this.queryParams);\n        const {\n          sort = {\n            loginAt: -1\n          }\n        } = await this.parseJsonQuery();\n        const filter = escapeRegExp(((_this$queryParams2 = this.queryParams) === null || _this$queryParams2 === void 0 ? void 0 : _this$queryParams2.filter) || '');\n        if (!validateSortKeys(Object.keys(sort))) {\n          return API.v1.failure('error-invalid-sort-keys');\n        }\n        const search = [];\n        if (filter) {\n          search.push(filter);\n          search.push(...(await Users.findActiveByUsernameOrNameRegexWithExceptionsAndConditions({\n            $regex: filter,\n            $options: 'i'\n          }, [], {}, {\n            projection: {\n              _id: 1\n            },\n            limit: 5\n          }).map(el => el._id).toArray()));\n        }\n        const sessions = await Sessions.aggregateSessionsAndPopulate({\n          search: search.join('|'),\n          sort,\n          offset,\n          count\n        });\n        return API.v1.success(sessions);\n      }\n    });\n    API.v1.addRoute('sessions/info.admin', {\n      authRequired: true,\n      twoFactorRequired: true,\n      validateParams: isSessionsProps,\n      permissionsRequired: ['view-device-management']\n    }, {\n      async get() {\n        var _this$queryParams3;\n        if (!License.hasModule('device-management')) {\n          return API.v1.forbidden();\n        }\n        const sessionId = (_this$queryParams3 = this.queryParams) === null || _this$queryParams3 === void 0 ? void 0 : _this$queryParams3.sessionId;\n        const {\n          sessions\n        } = await Sessions.aggregateSessionsAndPopulate({\n          search: sessionId,\n          count: 1\n        });\n        if (!(sessions !== null && sessions !== void 0 && sessions.length)) {\n          return API.v1.notFound('Session not found');\n        }\n        return API.v1.success(sessions[0]);\n      }\n    });\n    API.v1.addRoute('sessions/logout', {\n      authRequired: true,\n      twoFactorRequired: true,\n      validateParams: isSessionsProps,\n      permissionsRequired: ['logout-device-management']\n    }, {\n      async post() {\n        if (!License.hasModule('device-management')) {\n          return API.v1.forbidden();\n        }\n        const {\n          sessionId\n        } = this.bodyParams;\n        const sessionObj = await Sessions.findOneBySessionId(sessionId);\n        if (!(sessionObj !== null && sessionObj !== void 0 && sessionObj.loginToken)) {\n          return API.v1.notFound('Session not found');\n        }\n        await api.broadcast('user.forceLogout', sessionObj.userId);\n        await Promise.all([Users.unsetOneLoginToken(sessionObj.userId, sessionObj.loginToken), Sessions.logoutByloginTokenAndUserId({\n          loginToken: sessionObj.loginToken,\n          userId: sessionObj.userId,\n          logoutBy: this.userId\n        })]);\n        return API.v1.success({\n          sessionId\n        });\n      }\n    });\n    __reify_async_result__();\n  } catch (_reifyError) {\n    return __reify_async_result__(_reifyError);\n  }\n  __reify_async_result__()\n}, {\n  self: this,\n  async: false\n});","map":{"version":3,"names":["api","module","link","v","License","Users","Sessions","escapeRegExp","Ajv","default","API","getPaginationItems","__reifyWaitForDeps__","ajv","coerceTypes","isSessionsProps","compile","type","properties","sessionId","required","additionalProperties","isSessionsPaginateProps","offset","count","filter","sort","validateSortKeys","sortKeys","validSortKeys","every","s","includes","v1","addRoute","authRequired","validateParams","get","_this$queryParams","hasModule","forbidden","queryParams","loginAt","parseJsonQuery","search","Object","keys","failure","sessions","aggregateSessionsByUserId","uid","userId","success","findOneBySessionIdAndUserId","notFound","post","bodyParams","sessionObj","loginToken","Promise","all","unsetOneLoginToken","logoutByloginTokenAndUserId","twoFactorRequired","permissionsRequired","_this$queryParams2","push","findActiveByUsernameOrNameRegexWithExceptionsAndConditions","$regex","$options","projection","_id","limit","map","el","toArray","aggregateSessionsAndPopulate","join","_this$queryParams3","length","findOneBySessionId","broadcast","logoutBy","__reify_async_result__","_reifyError","self","async"],"sources":["ee/server/api/sessions.ts"],"sourcesContent":["import { api } from '@rocket.chat/core-services';\nimport type { IUser, ISession, DeviceManagementSession, DeviceManagementPopulatedSession } from '@rocket.chat/core-typings';\nimport { License } from '@rocket.chat/license';\nimport { Users, Sessions } from '@rocket.chat/models';\nimport type { PaginatedResult, PaginatedRequest } from '@rocket.chat/rest-typings';\nimport { escapeRegExp } from '@rocket.chat/string-helpers';\nimport Ajv from 'ajv';\n\nimport { API } from '../../../app/api/server/api';\nimport { getPaginationItems } from '../../../app/api/server/helpers/getPaginationItems';\n\nconst ajv = new Ajv({ coerceTypes: true });\n\ntype SessionsProps = {\n\tsessionId: string;\n};\n\nconst isSessionsProps = ajv.compile<SessionsProps>({\n\ttype: 'object',\n\tproperties: {\n\t\tsessionId: {\n\t\t\ttype: 'string',\n\t\t},\n\t},\n\trequired: ['sessionId'],\n\tadditionalProperties: false,\n});\n\ntype SessionsPaginateProps = PaginatedRequest<{\n\tfilter?: string;\n}>;\n\nconst isSessionsPaginateProps = ajv.compile<SessionsPaginateProps>({\n\ttype: 'object',\n\tproperties: {\n\t\toffset: {\n\t\t\ttype: 'number',\n\t\t},\n\t\tcount: {\n\t\t\ttype: 'number',\n\t\t},\n\t\tfilter: {\n\t\t\ttype: 'string',\n\t\t},\n\t\tsort: {\n\t\t\ttype: 'string',\n\t\t},\n\t},\n\trequired: [],\n\tadditionalProperties: false,\n});\n\nconst validateSortKeys = (sortKeys: string[]): boolean => {\n\tconst validSortKeys = ['loginAt', 'device.name', 'device.os.name', 'device.os.version', '_user.name', '_user.username'];\n\n\treturn sortKeys.every((s) => validSortKeys.includes(s));\n};\n\ndeclare module '@rocket.chat/rest-typings' {\n\t// eslint-disable-next-line @typescript-eslint/naming-convention\n\tinterface Endpoints {\n\t\t'/v1/sessions/list': {\n\t\t\tGET: (params: SessionsPaginateProps) => PaginatedResult<{ sessions: Array<DeviceManagementSession> }>;\n\t\t};\n\t\t'/v1/sessions/info': {\n\t\t\tGET: (params: SessionsProps) => DeviceManagementSession;\n\t\t};\n\t\t'/v1/sessions/logout.me': {\n\t\t\tPOST: (params: SessionsProps) => Pick<ISession, 'sessionId'>;\n\t\t};\n\t\t'/v1/sessions/list.all': {\n\t\t\tGET: (params: SessionsPaginateProps) => PaginatedResult<{ sessions: Array<DeviceManagementPopulatedSession> }>;\n\t\t};\n\t\t'/v1/sessions/info.admin': {\n\t\t\tGET: (params: SessionsProps) => DeviceManagementPopulatedSession;\n\t\t};\n\t\t'/v1/sessions/logout': {\n\t\t\tPOST: (params: SessionsProps) => Pick<ISession, 'sessionId'>;\n\t\t};\n\t}\n}\n\nAPI.v1.addRoute(\n\t'sessions/list',\n\t{ authRequired: true, validateParams: isSessionsPaginateProps },\n\t{\n\t\tasync get() {\n\t\t\tif (!License.hasModule('device-management')) {\n\t\t\t\treturn API.v1.forbidden();\n\t\t\t}\n\n\t\t\tconst { offset, count } = await getPaginationItems(this.queryParams);\n\t\t\tconst { sort = { loginAt: -1 } } = await this.parseJsonQuery();\n\t\t\tconst search = escapeRegExp(this.queryParams?.filter || '');\n\n\t\t\tif (!validateSortKeys(Object.keys(sort))) {\n\t\t\t\treturn API.v1.failure('error-invalid-sort-keys');\n\t\t\t}\n\n\t\t\tconst sessions = await Sessions.aggregateSessionsByUserId({ uid: this.userId, search, sort, offset, count });\n\t\t\treturn API.v1.success(sessions);\n\t\t},\n\t},\n);\n\nAPI.v1.addRoute(\n\t'sessions/info',\n\t{ authRequired: true, validateParams: isSessionsProps },\n\t{\n\t\tasync get() {\n\t\t\tif (!License.hasModule('device-management')) {\n\t\t\t\treturn API.v1.forbidden();\n\t\t\t}\n\n\t\t\tconst { sessionId } = this.queryParams;\n\t\t\tconst sessions = await Sessions.findOneBySessionIdAndUserId(sessionId, this.userId);\n\t\t\tif (!sessions) {\n\t\t\t\treturn API.v1.notFound('Session not found');\n\t\t\t}\n\t\t\treturn API.v1.success(sessions);\n\t\t},\n\t},\n);\n\nAPI.v1.addRoute(\n\t'sessions/logout.me',\n\t{ authRequired: true, validateParams: isSessionsProps },\n\t{\n\t\tasync post() {\n\t\t\tif (!License.hasModule('device-management')) {\n\t\t\t\treturn API.v1.forbidden();\n\t\t\t}\n\n\t\t\tconst { sessionId } = this.bodyParams;\n\t\t\tconst sessionObj = await Sessions.findOneBySessionIdAndUserId(sessionId, this.userId);\n\n\t\t\tif (!sessionObj?.loginToken) {\n\t\t\t\treturn API.v1.notFound('Session not found');\n\t\t\t}\n\n\t\t\tawait Promise.all([\n\t\t\t\tUsers.unsetOneLoginToken(this.userId, sessionObj.loginToken),\n\t\t\t\tSessions.logoutByloginTokenAndUserId({ loginToken: sessionObj.loginToken, userId: this.userId }),\n\t\t\t]);\n\n\t\t\treturn API.v1.success({ sessionId });\n\t\t},\n\t},\n);\n\nAPI.v1.addRoute(\n\t'sessions/list.all',\n\t{ authRequired: true, twoFactorRequired: true, validateParams: isSessionsPaginateProps, permissionsRequired: ['view-device-management'] },\n\t{\n\t\tasync get() {\n\t\t\tif (!License.hasModule('device-management')) {\n\t\t\t\treturn API.v1.forbidden();\n\t\t\t}\n\n\t\t\tconst { offset, count } = await getPaginationItems(this.queryParams);\n\t\t\tconst { sort = { loginAt: -1 } } = await this.parseJsonQuery();\n\t\t\tconst filter = escapeRegExp(this.queryParams?.filter || '');\n\n\t\t\tif (!validateSortKeys(Object.keys(sort))) {\n\t\t\t\treturn API.v1.failure('error-invalid-sort-keys');\n\t\t\t}\n\n\t\t\tconst search: string[] = [];\n\n\t\t\tif (filter) {\n\t\t\t\tsearch.push(filter);\n\n\t\t\t\tsearch.push(\n\t\t\t\t\t...(await Users.findActiveByUsernameOrNameRegexWithExceptionsAndConditions<Pick<IUser, '_id'>>(\n\t\t\t\t\t\t{ $regex: filter, $options: 'i' },\n\t\t\t\t\t\t[],\n\t\t\t\t\t\t{},\n\t\t\t\t\t\t{ projection: { _id: 1 }, limit: 5 },\n\t\t\t\t\t)\n\t\t\t\t\t\t.map((el) => el._id)\n\t\t\t\t\t\t.toArray()),\n\t\t\t\t);\n\t\t\t}\n\n\t\t\tconst sessions = await Sessions.aggregateSessionsAndPopulate({ search: search.join('|'), sort, offset, count });\n\t\t\treturn API.v1.success(sessions);\n\t\t},\n\t},\n);\n\nAPI.v1.addRoute(\n\t'sessions/info.admin',\n\t{ authRequired: true, twoFactorRequired: true, validateParams: isSessionsProps, permissionsRequired: ['view-device-management'] },\n\t{\n\t\tasync get() {\n\t\t\tif (!License.hasModule('device-management')) {\n\t\t\t\treturn API.v1.forbidden();\n\t\t\t}\n\n\t\t\tconst sessionId = this.queryParams?.sessionId as string;\n\t\t\tconst { sessions } = await Sessions.aggregateSessionsAndPopulate({ search: sessionId, count: 1 });\n\t\t\tif (!sessions?.length) {\n\t\t\t\treturn API.v1.notFound('Session not found');\n\t\t\t}\n\t\t\treturn API.v1.success(sessions[0]);\n\t\t},\n\t},\n);\n\nAPI.v1.addRoute(\n\t'sessions/logout',\n\t{ authRequired: true, twoFactorRequired: true, validateParams: isSessionsProps, permissionsRequired: ['logout-device-management'] },\n\t{\n\t\tasync post() {\n\t\t\tif (!License.hasModule('device-management')) {\n\t\t\t\treturn API.v1.forbidden();\n\t\t\t}\n\n\t\t\tconst { sessionId } = this.bodyParams;\n\t\t\tconst sessionObj = await Sessions.findOneBySessionId(sessionId);\n\n\t\t\tif (!sessionObj?.loginToken) {\n\t\t\t\treturn API.v1.notFound('Session not found');\n\t\t\t}\n\n\t\t\tawait api.broadcast('user.forceLogout', sessionObj.userId);\n\n\t\t\tawait Promise.all([\n\t\t\t\tUsers.unsetOneLoginToken(sessionObj.userId, sessionObj.loginToken),\n\t\t\t\tSessions.logoutByloginTokenAndUserId({ loginToken: sessionObj.loginToken, userId: sessionObj.userId, logoutBy: this.userId }),\n\t\t\t]);\n\n\t\t\treturn API.v1.success({ sessionId });\n\t\t},\n\t},\n);\n"],"mappings":"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","ignoreList":[]},"sourceType":"module","externalDependencies":{},"hash":"bac024c968119f24656d0694c101263a53cd445d"}
