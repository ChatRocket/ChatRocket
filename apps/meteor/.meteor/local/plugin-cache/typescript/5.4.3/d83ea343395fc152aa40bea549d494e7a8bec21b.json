{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/ee/app/license/server/startup.ts","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","topLevelAwait","objectRestSpread","objectRestSpread","asyncGenerators","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"os.osx.arm64"},"sourceFileName":"ee/app/license/server/startup.ts","filename":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/ee/app/license/server/startup.ts","inputSourceMap":{"version":3,"file":"ee/app/license/server/startup.ts","sourceRoot":"","sources":["ee/app/license/server/startup.ts"],"names":[],"mappings":"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","sourcesContent":["import { api } from '@rocket.chat/core-services';\nimport type { LicenseLimitKind } from '@rocket.chat/core-typings';\nimport { applyLicense, applyLicenseOrRemove, License } from '@rocket.chat/license';\nimport { Subscriptions, Users, Settings, LivechatVisitors } from '@rocket.chat/models';\nimport { wrapExceptions } from '@rocket.chat/tools';\nimport moment from 'moment';\n\nimport { getAppCount } from './lib/getAppCount';\nimport { syncWorkspace } from '../../../../app/cloud/server/functions/syncWorkspace';\nimport { notifyOnSettingChangedById } from '../../../../app/lib/server/lib/notifyListener';\nimport { settings } from '../../../../app/settings/server';\nimport { callbacks } from '../../../../lib/callbacks';\n\nexport const startLicense = async () => {\n\tsettings.watch<string>('Site_Url', (value) => {\n\t\tif (value) {\n\t\t\tvoid License.setWorkspaceUrl(value);\n\t\t}\n\t});\n\n\tLicense.onValidateLicense(async () => {\n\t\t(await Settings.updateValueById('Enterprise_License', License.encryptedLicense)).modifiedCount &&\n\t\t\tvoid notifyOnSettingChangedById('Enterprise_License');\n\n\t\t(await Settings.updateValueById('Enterprise_License_Status', 'Valid')).modifiedCount &&\n\t\t\tvoid notifyOnSettingChangedById('Enterprise_License_Status');\n\t});\n\n\tLicense.onInvalidateLicense(async () => {\n\t\t(await Settings.updateValueById('Enterprise_License_Status', 'Invalid')).modifiedCount &&\n\t\t\tvoid notifyOnSettingChangedById('Enterprise_License_Status');\n\t});\n\n\tLicense.onRemoveLicense(async () => {\n\t\t(await Settings.updateValueById('Enterprise_License', '')).modifiedCount &&\n\t\t\tvoid notifyOnSettingChangedById('Enterprise_License_Status');\n\n\t\t(await Settings.updateValueById('Enterprise_License_Status', 'Invalid')).modifiedCount &&\n\t\t\tvoid notifyOnSettingChangedById('Enterprise_License_Status');\n\t});\n\n\t/**\n\t * This is a debounced function that will sync the workspace data to the cloud.\n\t * it caches the context, waits for a second and then syncs the data.\n\t */\n\n\tconst syncByTriggerDebounced = (() => {\n\t\tlet timeout: NodeJS.Timeout | undefined;\n\t\tconst contexts: Set<string> = new Set();\n\t\treturn async (context: string) => {\n\t\t\tcontexts.add(context);\n\t\t\tif (timeout) {\n\t\t\t\tclearTimeout(timeout);\n\t\t\t}\n\n\t\t\ttimeout = setTimeout(() => {\n\t\t\t\ttimeout = undefined;\n\t\t\t\tvoid syncByTrigger([...contexts]);\n\t\t\t\tcontexts.clear();\n\t\t\t}, 1000);\n\t\t};\n\t})();\n\n\tconst syncByTrigger = async (contexts: string[]) => {\n\t\tif (!License.encryptedLicense) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst existingData = wrapExceptions(() => JSON.parse(settings.get<string>('Enterprise_License_Data'))).catch(() => ({})) ?? {};\n\n\t\tconst date = new Date();\n\n\t\tconst day = date.getDate();\n\t\tconst month = date.getMonth() + 1;\n\t\tconst year = date.getFullYear();\n\n\t\tconst period = `${year}-${month}-${day}`;\n\n\t\tconst [, , signed] = License.encryptedLicense.split('.');\n\n\t\t// Check if this sync has already been done. Based on License, behavior.\n\n\t\tif ([...contexts.values()].every((context) => existingData.signed === signed && existingData[context] === period)) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst obj = Object.fromEntries(contexts.map((context) => [context, period]));\n\n\t\t(\n\t\t\tawait Settings.updateValueById(\n\t\t\t\t'Enterprise_License_Data',\n\t\t\t\tJSON.stringify({\n\t\t\t\t\t...(existingData.signed === signed && existingData),\n\t\t\t\t\t...existingData,\n\t\t\t\t\t...obj,\n\t\t\t\t\tsigned,\n\t\t\t\t}),\n\t\t\t)\n\t\t).modifiedCount && void notifyOnSettingChangedById('Enterprise_License_Data');\n\n\t\ttry {\n\t\t\tawait syncWorkspace();\n\t\t} catch (error) {\n\t\t\tconsole.error(error);\n\t\t}\n\t};\n\n\tLicense.setLicenseLimitCounter('activeUsers', () => Users.getActiveLocalUserCount());\n\tLicense.setLicenseLimitCounter('guestUsers', () => Users.getActiveLocalGuestCount());\n\tLicense.setLicenseLimitCounter('roomsPerGuest', async (context) => (context?.userId ? Subscriptions.countByUserId(context.userId) : 0));\n\tLicense.setLicenseLimitCounter('privateApps', () => getAppCount('private'));\n\tLicense.setLicenseLimitCounter('marketplaceApps', () => getAppCount('marketplace'));\n\tLicense.setLicenseLimitCounter('monthlyActiveContacts', () => LivechatVisitors.countVisitorsOnPeriod(moment.utc().format('YYYY-MM')));\n\n\treturn new Promise<void>((resolve) => {\n\t\t// When settings are loaded, apply the current license if there is one.\n\t\tsettings.onReady(async () => {\n\t\t\timport('./airGappedRestrictions');\n\t\t\tif (!(await applyLicense(settings.get<string>('Enterprise_License') ?? '', false))) {\n\t\t\t\t// License from the envvar is always treated as new, because it would have been saved on the setting if it was already in use.\n\t\t\t\tif (process.env.ROCKETCHAT_LICENSE && !License.hasValidLicense()) {\n\t\t\t\t\tawait applyLicense(process.env.ROCKETCHAT_LICENSE, true);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// After the current license is already loaded, watch the setting value to react to new licenses being applied.\n\t\t\tsettings.change<string>('Enterprise_License', (license) => applyLicenseOrRemove(license, true));\n\n\t\t\tcallbacks.add('workspaceLicenseRemoved', () => License.remove());\n\n\t\t\tcallbacks.add('workspaceLicenseChanged', (updatedLicense) => applyLicense(updatedLicense, true));\n\n\t\t\tLicense.onInstall(async () => void api.broadcast('license.actions', {} as Record<Partial<LicenseLimitKind>, boolean>));\n\n\t\t\tLicense.onInvalidate(async () => void api.broadcast('license.actions', {} as Record<Partial<LicenseLimitKind>, boolean>));\n\n\t\t\tLicense.onBehaviorTriggered('prevent_action', (context) => syncByTriggerDebounced(`prevent_action_${context.limit}`));\n\n\t\t\tLicense.onBehaviorTriggered('start_fair_policy', async (context) => syncByTriggerDebounced(`start_fair_policy_${context.limit}`));\n\n\t\t\tLicense.onBehaviorTriggered('disable_modules', async (context) => syncByTriggerDebounced(`disable_modules_${context.limit}`));\n\n\t\t\tLicense.onChange(() => api.broadcast('license.sync'));\n\n\t\t\tLicense.onBehaviorToggled('prevent_action', (context) => {\n\t\t\t\tif (!context.limit) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\tvoid api.broadcast('license.actions', {\n\t\t\t\t\t[context.limit]: true,\n\t\t\t\t} as Record<Partial<LicenseLimitKind>, boolean>);\n\t\t\t});\n\n\t\t\tLicense.onBehaviorToggled('allow_action', (context) => {\n\t\t\t\tif (!context.limit) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\tvoid api.broadcast('license.actions', {\n\t\t\t\t\t[context.limit]: false,\n\t\t\t\t} as Record<Partial<LicenseLimitKind>, boolean>);\n\t\t\t});\n\t\t\tresolve();\n\t\t});\n\t});\n};\n"]},"targets":{"android":"125.0.0","chrome":"125.0.0","edge":"125.0.0","firefox":"115.0.0","ie":"10.0.0","ios":"17.4.0","opera":"110.0.0","opera_mobile":"80.0.0","safari":"17.4.0","samsung":"24.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor","root":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":false,"enforceStrictMode":false,"dynamicImport":true,"generateLetDeclarations":true,"topLevelAwait":true},"externalDependencies":[]},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"version":"7.17.2","helpers":true,"useESModules":false,"corejs":false},"externalDependencies":[]},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-async-generator-functions","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-class-properties","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true},"externalDependencies":[]},{"key":"transform-react-jsx","visitor":{"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXFragment":{"exit":[null]},"JSXElement":{"exit":[null]},"JSXAttribute":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false},"externalDependencies":[]},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-nullish-coalescing-operator","visitor":{"LogicalExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-optional-chaining","visitor":{"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-optional-catch-binding","visitor":{"CatchClause":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-class-properties","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-async-generator-functions","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-logical-assignment-operators","visitor":{"AssignmentExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]}],"presets":[],"generatorOpts":{"filename":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/ee/app/license/server/startup.ts","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"ee/app/license/server/startup.ts","inputSourceMap":{"version":3,"file":"ee/app/license/server/startup.ts","sourceRoot":"","sources":["ee/app/license/server/startup.ts"],"names":[],"mappings":"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","sourcesContent":["import { api } from '@rocket.chat/core-services';\nimport type { LicenseLimitKind } from '@rocket.chat/core-typings';\nimport { applyLicense, applyLicenseOrRemove, License } from '@rocket.chat/license';\nimport { Subscriptions, Users, Settings, LivechatVisitors } from '@rocket.chat/models';\nimport { wrapExceptions } from '@rocket.chat/tools';\nimport moment from 'moment';\n\nimport { getAppCount } from './lib/getAppCount';\nimport { syncWorkspace } from '../../../../app/cloud/server/functions/syncWorkspace';\nimport { notifyOnSettingChangedById } from '../../../../app/lib/server/lib/notifyListener';\nimport { settings } from '../../../../app/settings/server';\nimport { callbacks } from '../../../../lib/callbacks';\n\nexport const startLicense = async () => {\n\tsettings.watch<string>('Site_Url', (value) => {\n\t\tif (value) {\n\t\t\tvoid License.setWorkspaceUrl(value);\n\t\t}\n\t});\n\n\tLicense.onValidateLicense(async () => {\n\t\t(await Settings.updateValueById('Enterprise_License', License.encryptedLicense)).modifiedCount &&\n\t\t\tvoid notifyOnSettingChangedById('Enterprise_License');\n\n\t\t(await Settings.updateValueById('Enterprise_License_Status', 'Valid')).modifiedCount &&\n\t\t\tvoid notifyOnSettingChangedById('Enterprise_License_Status');\n\t});\n\n\tLicense.onInvalidateLicense(async () => {\n\t\t(await Settings.updateValueById('Enterprise_License_Status', 'Invalid')).modifiedCount &&\n\t\t\tvoid notifyOnSettingChangedById('Enterprise_License_Status');\n\t});\n\n\tLicense.onRemoveLicense(async () => {\n\t\t(await Settings.updateValueById('Enterprise_License', '')).modifiedCount &&\n\t\t\tvoid notifyOnSettingChangedById('Enterprise_License_Status');\n\n\t\t(await Settings.updateValueById('Enterprise_License_Status', 'Invalid')).modifiedCount &&\n\t\t\tvoid notifyOnSettingChangedById('Enterprise_License_Status');\n\t});\n\n\t/**\n\t * This is a debounced function that will sync the workspace data to the cloud.\n\t * it caches the context, waits for a second and then syncs the data.\n\t */\n\n\tconst syncByTriggerDebounced = (() => {\n\t\tlet timeout: NodeJS.Timeout | undefined;\n\t\tconst contexts: Set<string> = new Set();\n\t\treturn async (context: string) => {\n\t\t\tcontexts.add(context);\n\t\t\tif (timeout) {\n\t\t\t\tclearTimeout(timeout);\n\t\t\t}\n\n\t\t\ttimeout = setTimeout(() => {\n\t\t\t\ttimeout = undefined;\n\t\t\t\tvoid syncByTrigger([...contexts]);\n\t\t\t\tcontexts.clear();\n\t\t\t}, 1000);\n\t\t};\n\t})();\n\n\tconst syncByTrigger = async (contexts: string[]) => {\n\t\tif (!License.encryptedLicense) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst existingData = wrapExceptions(() => JSON.parse(settings.get<string>('Enterprise_License_Data'))).catch(() => ({})) ?? {};\n\n\t\tconst date = new Date();\n\n\t\tconst day = date.getDate();\n\t\tconst month = date.getMonth() + 1;\n\t\tconst year = date.getFullYear();\n\n\t\tconst period = `${year}-${month}-${day}`;\n\n\t\tconst [, , signed] = License.encryptedLicense.split('.');\n\n\t\t// Check if this sync has already been done. Based on License, behavior.\n\n\t\tif ([...contexts.values()].every((context) => existingData.signed === signed && existingData[context] === period)) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst obj = Object.fromEntries(contexts.map((context) => [context, period]));\n\n\t\t(\n\t\t\tawait Settings.updateValueById(\n\t\t\t\t'Enterprise_License_Data',\n\t\t\t\tJSON.stringify({\n\t\t\t\t\t...(existingData.signed === signed && existingData),\n\t\t\t\t\t...existingData,\n\t\t\t\t\t...obj,\n\t\t\t\t\tsigned,\n\t\t\t\t}),\n\t\t\t)\n\t\t).modifiedCount && void notifyOnSettingChangedById('Enterprise_License_Data');\n\n\t\ttry {\n\t\t\tawait syncWorkspace();\n\t\t} catch (error) {\n\t\t\tconsole.error(error);\n\t\t}\n\t};\n\n\tLicense.setLicenseLimitCounter('activeUsers', () => Users.getActiveLocalUserCount());\n\tLicense.setLicenseLimitCounter('guestUsers', () => Users.getActiveLocalGuestCount());\n\tLicense.setLicenseLimitCounter('roomsPerGuest', async (context) => (context?.userId ? Subscriptions.countByUserId(context.userId) : 0));\n\tLicense.setLicenseLimitCounter('privateApps', () => getAppCount('private'));\n\tLicense.setLicenseLimitCounter('marketplaceApps', () => getAppCount('marketplace'));\n\tLicense.setLicenseLimitCounter('monthlyActiveContacts', () => LivechatVisitors.countVisitorsOnPeriod(moment.utc().format('YYYY-MM')));\n\n\treturn new Promise<void>((resolve) => {\n\t\t// When settings are loaded, apply the current license if there is one.\n\t\tsettings.onReady(async () => {\n\t\t\timport('./airGappedRestrictions');\n\t\t\tif (!(await applyLicense(settings.get<string>('Enterprise_License') ?? '', false))) {\n\t\t\t\t// License from the envvar is always treated as new, because it would have been saved on the setting if it was already in use.\n\t\t\t\tif (process.env.ROCKETCHAT_LICENSE && !License.hasValidLicense()) {\n\t\t\t\t\tawait applyLicense(process.env.ROCKETCHAT_LICENSE, true);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// After the current license is already loaded, watch the setting value to react to new licenses being applied.\n\t\t\tsettings.change<string>('Enterprise_License', (license) => applyLicenseOrRemove(license, true));\n\n\t\t\tcallbacks.add('workspaceLicenseRemoved', () => License.remove());\n\n\t\t\tcallbacks.add('workspaceLicenseChanged', (updatedLicense) => applyLicense(updatedLicense, true));\n\n\t\t\tLicense.onInstall(async () => void api.broadcast('license.actions', {} as Record<Partial<LicenseLimitKind>, boolean>));\n\n\t\t\tLicense.onInvalidate(async () => void api.broadcast('license.actions', {} as Record<Partial<LicenseLimitKind>, boolean>));\n\n\t\t\tLicense.onBehaviorTriggered('prevent_action', (context) => syncByTriggerDebounced(`prevent_action_${context.limit}`));\n\n\t\t\tLicense.onBehaviorTriggered('start_fair_policy', async (context) => syncByTriggerDebounced(`start_fair_policy_${context.limit}`));\n\n\t\t\tLicense.onBehaviorTriggered('disable_modules', async (context) => syncByTriggerDebounced(`disable_modules_${context.limit}`));\n\n\t\t\tLicense.onChange(() => api.broadcast('license.sync'));\n\n\t\t\tLicense.onBehaviorToggled('prevent_action', (context) => {\n\t\t\t\tif (!context.limit) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\tvoid api.broadcast('license.actions', {\n\t\t\t\t\t[context.limit]: true,\n\t\t\t\t} as Record<Partial<LicenseLimitKind>, boolean>);\n\t\t\t});\n\n\t\t\tLicense.onBehaviorToggled('allow_action', (context) => {\n\t\t\t\tif (!context.limit) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\tvoid api.broadcast('license.actions', {\n\t\t\t\t\t[context.limit]: false,\n\t\t\t\t} as Record<Partial<LicenseLimitKind>, boolean>);\n\t\t\t});\n\t\t\tresolve();\n\t\t});\n\t});\n};\n"]}}},"code":"!module.wrapAsync(async function (module, __reifyWaitForDeps__, __reify_async_result__) {\n  \"use strict\";\n  try {\n    let _objectSpread;\n    module.link(\"@babel/runtime/helpers/objectSpread2\", {\n      default(v) {\n        _objectSpread = v;\n      }\n    }, 0);\n    module.export({\n      startLicense: () => startLicense\n    });\n    let api;\n    module.link(\"@rocket.chat/core-services\", {\n      api(v) {\n        api = v;\n      }\n    }, 0);\n    let applyLicense, applyLicenseOrRemove, License;\n    module.link(\"@rocket.chat/license\", {\n      applyLicense(v) {\n        applyLicense = v;\n      },\n      applyLicenseOrRemove(v) {\n        applyLicenseOrRemove = v;\n      },\n      License(v) {\n        License = v;\n      }\n    }, 1);\n    let Subscriptions, Users, Settings, LivechatVisitors;\n    module.link(\"@rocket.chat/models\", {\n      Subscriptions(v) {\n        Subscriptions = v;\n      },\n      Users(v) {\n        Users = v;\n      },\n      Settings(v) {\n        Settings = v;\n      },\n      LivechatVisitors(v) {\n        LivechatVisitors = v;\n      }\n    }, 2);\n    let wrapExceptions;\n    module.link(\"@rocket.chat/tools\", {\n      wrapExceptions(v) {\n        wrapExceptions = v;\n      }\n    }, 3);\n    let moment;\n    module.link(\"moment\", {\n      default(v) {\n        moment = v;\n      }\n    }, 4);\n    let getAppCount;\n    module.link(\"./lib/getAppCount\", {\n      getAppCount(v) {\n        getAppCount = v;\n      }\n    }, 5);\n    let syncWorkspace;\n    module.link(\"../../../../app/cloud/server/functions/syncWorkspace\", {\n      syncWorkspace(v) {\n        syncWorkspace = v;\n      }\n    }, 6);\n    let notifyOnSettingChangedById;\n    module.link(\"../../../../app/lib/server/lib/notifyListener\", {\n      notifyOnSettingChangedById(v) {\n        notifyOnSettingChangedById = v;\n      }\n    }, 7);\n    let settings;\n    module.link(\"../../../../app/settings/server\", {\n      settings(v) {\n        settings = v;\n      }\n    }, 8);\n    let callbacks;\n    module.link(\"../../../../lib/callbacks\", {\n      callbacks(v) {\n        callbacks = v;\n      }\n    }, 9);\n    if (__reifyWaitForDeps__()) (await __reifyWaitForDeps__())();\n    const startLicense = async () => {\n      settings.watch('Site_Url', value => {\n        if (value) {\n          void License.setWorkspaceUrl(value);\n        }\n      });\n      License.onValidateLicense(async () => {\n        (await Settings.updateValueById('Enterprise_License', License.encryptedLicense)).modifiedCount && void notifyOnSettingChangedById('Enterprise_License');\n        (await Settings.updateValueById('Enterprise_License_Status', 'Valid')).modifiedCount && void notifyOnSettingChangedById('Enterprise_License_Status');\n      });\n      License.onInvalidateLicense(async () => {\n        (await Settings.updateValueById('Enterprise_License_Status', 'Invalid')).modifiedCount && void notifyOnSettingChangedById('Enterprise_License_Status');\n      });\n      License.onRemoveLicense(async () => {\n        (await Settings.updateValueById('Enterprise_License', '')).modifiedCount && void notifyOnSettingChangedById('Enterprise_License_Status');\n        (await Settings.updateValueById('Enterprise_License_Status', 'Invalid')).modifiedCount && void notifyOnSettingChangedById('Enterprise_License_Status');\n      });\n      /**\n       * This is a debounced function that will sync the workspace data to the cloud.\n       * it caches the context, waits for a second and then syncs the data.\n       */\n      const syncByTriggerDebounced = (() => {\n        let timeout;\n        const contexts = new Set();\n        return async context => {\n          contexts.add(context);\n          if (timeout) {\n            clearTimeout(timeout);\n          }\n          timeout = setTimeout(() => {\n            timeout = undefined;\n            void syncByTrigger([...contexts]);\n            contexts.clear();\n          }, 1000);\n        };\n      })();\n      const syncByTrigger = async contexts => {\n        var _wrapExceptions$catch;\n        if (!License.encryptedLicense) {\n          return;\n        }\n        const existingData = (_wrapExceptions$catch = wrapExceptions(() => JSON.parse(settings.get('Enterprise_License_Data'))).catch(() => ({}))) !== null && _wrapExceptions$catch !== void 0 ? _wrapExceptions$catch : {};\n        const date = new Date();\n        const day = date.getDate();\n        const month = date.getMonth() + 1;\n        const year = date.getFullYear();\n        const period = \"\".concat(year, \"-\").concat(month, \"-\").concat(day);\n        const [,, signed] = License.encryptedLicense.split('.');\n        // Check if this sync has already been done. Based on License, behavior.\n        if ([...contexts.values()].every(context => existingData.signed === signed && existingData[context] === period)) {\n          return;\n        }\n        const obj = Object.fromEntries(contexts.map(context => [context, period]));\n        (await Settings.updateValueById('Enterprise_License_Data', JSON.stringify(_objectSpread(_objectSpread(_objectSpread(_objectSpread({}, existingData.signed === signed && existingData), existingData), obj), {}, {\n          signed\n        })))).modifiedCount && void notifyOnSettingChangedById('Enterprise_License_Data');\n        try {\n          await syncWorkspace();\n        } catch (error) {\n          console.error(error);\n        }\n      };\n      License.setLicenseLimitCounter('activeUsers', () => Users.getActiveLocalUserCount());\n      License.setLicenseLimitCounter('guestUsers', () => Users.getActiveLocalGuestCount());\n      License.setLicenseLimitCounter('roomsPerGuest', async context => context !== null && context !== void 0 && context.userId ? Subscriptions.countByUserId(context.userId) : 0);\n      License.setLicenseLimitCounter('privateApps', () => getAppCount('private'));\n      License.setLicenseLimitCounter('marketplaceApps', () => getAppCount('marketplace'));\n      License.setLicenseLimitCounter('monthlyActiveContacts', () => LivechatVisitors.countVisitorsOnPeriod(moment.utc().format('YYYY-MM')));\n      return new Promise(resolve => {\n        // When settings are loaded, apply the current license if there is one.\n        settings.onReady(async () => {\n          var _settings$get;\n          module.dynamicImport('./airGappedRestrictions');\n          if (!(await applyLicense((_settings$get = settings.get('Enterprise_License')) !== null && _settings$get !== void 0 ? _settings$get : '', false))) {\n            // License from the envvar is always treated as new, because it would have been saved on the setting if it was already in use.\n            if (process.env.ROCKETCHAT_LICENSE && !License.hasValidLicense()) {\n              await applyLicense(process.env.ROCKETCHAT_LICENSE, true);\n            }\n          }\n          // After the current license is already loaded, watch the setting value to react to new licenses being applied.\n          settings.change('Enterprise_License', license => applyLicenseOrRemove(license, true));\n          callbacks.add('workspaceLicenseRemoved', () => License.remove());\n          callbacks.add('workspaceLicenseChanged', updatedLicense => applyLicense(updatedLicense, true));\n          License.onInstall(async () => void api.broadcast('license.actions', {}));\n          License.onInvalidate(async () => void api.broadcast('license.actions', {}));\n          License.onBehaviorTriggered('prevent_action', context => syncByTriggerDebounced(\"prevent_action_\".concat(context.limit)));\n          License.onBehaviorTriggered('start_fair_policy', async context => syncByTriggerDebounced(\"start_fair_policy_\".concat(context.limit)));\n          License.onBehaviorTriggered('disable_modules', async context => syncByTriggerDebounced(\"disable_modules_\".concat(context.limit)));\n          License.onChange(() => api.broadcast('license.sync'));\n          License.onBehaviorToggled('prevent_action', context => {\n            if (!context.limit) {\n              return;\n            }\n            void api.broadcast('license.actions', {\n              [context.limit]: true\n            });\n          });\n          License.onBehaviorToggled('allow_action', context => {\n            if (!context.limit) {\n              return;\n            }\n            void api.broadcast('license.actions', {\n              [context.limit]: false\n            });\n          });\n          resolve();\n        });\n      });\n    };\n    __reify_async_result__();\n  } catch (_reifyError) {\n    return __reify_async_result__(_reifyError);\n  }\n  __reify_async_result__()\n}, {\n  self: this,\n  async: false\n});","map":{"version":3,"names":["_objectSpread","module","link","default","v","export","startLicense","api","applyLicense","applyLicenseOrRemove","License","Subscriptions","Users","Settings","LivechatVisitors","wrapExceptions","moment","getAppCount","syncWorkspace","notifyOnSettingChangedById","settings","callbacks","__reifyWaitForDeps__","watch","value","setWorkspaceUrl","onValidateLicense","updateValueById","encryptedLicense","modifiedCount","onInvalidateLicense","onRemoveLicense","syncByTriggerDebounced","timeout","contexts","Set","context","add","clearTimeout","setTimeout","undefined","syncByTrigger","clear","_wrapExceptions$catch","existingData","JSON","parse","get","catch","date","Date","day","getDate","month","getMonth","year","getFullYear","period","concat","signed","split","values","every","obj","Object","fromEntries","map","stringify","error","console","setLicenseLimitCounter","getActiveLocalUserCount","getActiveLocalGuestCount","userId","countByUserId","countVisitorsOnPeriod","utc","format","Promise","resolve","onReady","_settings$get","dynamicImport","process","env","ROCKETCHAT_LICENSE","hasValidLicense","change","license","remove","updatedLicense","onInstall","broadcast","onInvalidate","onBehaviorTriggered","limit","onChange","onBehaviorToggled","__reify_async_result__","_reifyError","self","async"],"sources":["ee/app/license/server/startup.ts"],"sourcesContent":["import { api } from '@rocket.chat/core-services';\nimport type { LicenseLimitKind } from '@rocket.chat/core-typings';\nimport { applyLicense, applyLicenseOrRemove, License } from '@rocket.chat/license';\nimport { Subscriptions, Users, Settings, LivechatVisitors } from '@rocket.chat/models';\nimport { wrapExceptions } from '@rocket.chat/tools';\nimport moment from 'moment';\n\nimport { getAppCount } from './lib/getAppCount';\nimport { syncWorkspace } from '../../../../app/cloud/server/functions/syncWorkspace';\nimport { notifyOnSettingChangedById } from '../../../../app/lib/server/lib/notifyListener';\nimport { settings } from '../../../../app/settings/server';\nimport { callbacks } from '../../../../lib/callbacks';\n\nexport const startLicense = async () => {\n\tsettings.watch<string>('Site_Url', (value) => {\n\t\tif (value) {\n\t\t\tvoid License.setWorkspaceUrl(value);\n\t\t}\n\t});\n\n\tLicense.onValidateLicense(async () => {\n\t\t(await Settings.updateValueById('Enterprise_License', License.encryptedLicense)).modifiedCount &&\n\t\t\tvoid notifyOnSettingChangedById('Enterprise_License');\n\n\t\t(await Settings.updateValueById('Enterprise_License_Status', 'Valid')).modifiedCount &&\n\t\t\tvoid notifyOnSettingChangedById('Enterprise_License_Status');\n\t});\n\n\tLicense.onInvalidateLicense(async () => {\n\t\t(await Settings.updateValueById('Enterprise_License_Status', 'Invalid')).modifiedCount &&\n\t\t\tvoid notifyOnSettingChangedById('Enterprise_License_Status');\n\t});\n\n\tLicense.onRemoveLicense(async () => {\n\t\t(await Settings.updateValueById('Enterprise_License', '')).modifiedCount &&\n\t\t\tvoid notifyOnSettingChangedById('Enterprise_License_Status');\n\n\t\t(await Settings.updateValueById('Enterprise_License_Status', 'Invalid')).modifiedCount &&\n\t\t\tvoid notifyOnSettingChangedById('Enterprise_License_Status');\n\t});\n\n\t/**\n\t * This is a debounced function that will sync the workspace data to the cloud.\n\t * it caches the context, waits for a second and then syncs the data.\n\t */\n\n\tconst syncByTriggerDebounced = (() => {\n\t\tlet timeout: NodeJS.Timeout | undefined;\n\t\tconst contexts: Set<string> = new Set();\n\t\treturn async (context: string) => {\n\t\t\tcontexts.add(context);\n\t\t\tif (timeout) {\n\t\t\t\tclearTimeout(timeout);\n\t\t\t}\n\n\t\t\ttimeout = setTimeout(() => {\n\t\t\t\ttimeout = undefined;\n\t\t\t\tvoid syncByTrigger([...contexts]);\n\t\t\t\tcontexts.clear();\n\t\t\t}, 1000);\n\t\t};\n\t})();\n\n\tconst syncByTrigger = async (contexts: string[]) => {\n\t\tif (!License.encryptedLicense) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst existingData = wrapExceptions(() => JSON.parse(settings.get<string>('Enterprise_License_Data'))).catch(() => ({})) ?? {};\n\n\t\tconst date = new Date();\n\n\t\tconst day = date.getDate();\n\t\tconst month = date.getMonth() + 1;\n\t\tconst year = date.getFullYear();\n\n\t\tconst period = `${year}-${month}-${day}`;\n\n\t\tconst [, , signed] = License.encryptedLicense.split('.');\n\n\t\t// Check if this sync has already been done. Based on License, behavior.\n\n\t\tif ([...contexts.values()].every((context) => existingData.signed === signed && existingData[context] === period)) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst obj = Object.fromEntries(contexts.map((context) => [context, period]));\n\n\t\t(\n\t\t\tawait Settings.updateValueById(\n\t\t\t\t'Enterprise_License_Data',\n\t\t\t\tJSON.stringify({\n\t\t\t\t\t...(existingData.signed === signed && existingData),\n\t\t\t\t\t...existingData,\n\t\t\t\t\t...obj,\n\t\t\t\t\tsigned,\n\t\t\t\t}),\n\t\t\t)\n\t\t).modifiedCount && void notifyOnSettingChangedById('Enterprise_License_Data');\n\n\t\ttry {\n\t\t\tawait syncWorkspace();\n\t\t} catch (error) {\n\t\t\tconsole.error(error);\n\t\t}\n\t};\n\n\tLicense.setLicenseLimitCounter('activeUsers', () => Users.getActiveLocalUserCount());\n\tLicense.setLicenseLimitCounter('guestUsers', () => Users.getActiveLocalGuestCount());\n\tLicense.setLicenseLimitCounter('roomsPerGuest', async (context) => (context?.userId ? Subscriptions.countByUserId(context.userId) : 0));\n\tLicense.setLicenseLimitCounter('privateApps', () => getAppCount('private'));\n\tLicense.setLicenseLimitCounter('marketplaceApps', () => getAppCount('marketplace'));\n\tLicense.setLicenseLimitCounter('monthlyActiveContacts', () => LivechatVisitors.countVisitorsOnPeriod(moment.utc().format('YYYY-MM')));\n\n\treturn new Promise<void>((resolve) => {\n\t\t// When settings are loaded, apply the current license if there is one.\n\t\tsettings.onReady(async () => {\n\t\t\timport('./airGappedRestrictions');\n\t\t\tif (!(await applyLicense(settings.get<string>('Enterprise_License') ?? '', false))) {\n\t\t\t\t// License from the envvar is always treated as new, because it would have been saved on the setting if it was already in use.\n\t\t\t\tif (process.env.ROCKETCHAT_LICENSE && !License.hasValidLicense()) {\n\t\t\t\t\tawait applyLicense(process.env.ROCKETCHAT_LICENSE, true);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// After the current license is already loaded, watch the setting value to react to new licenses being applied.\n\t\t\tsettings.change<string>('Enterprise_License', (license) => applyLicenseOrRemove(license, true));\n\n\t\t\tcallbacks.add('workspaceLicenseRemoved', () => License.remove());\n\n\t\t\tcallbacks.add('workspaceLicenseChanged', (updatedLicense) => applyLicense(updatedLicense, true));\n\n\t\t\tLicense.onInstall(async () => void api.broadcast('license.actions', {} as Record<Partial<LicenseLimitKind>, boolean>));\n\n\t\t\tLicense.onInvalidate(async () => void api.broadcast('license.actions', {} as Record<Partial<LicenseLimitKind>, boolean>));\n\n\t\t\tLicense.onBehaviorTriggered('prevent_action', (context) => syncByTriggerDebounced(`prevent_action_${context.limit}`));\n\n\t\t\tLicense.onBehaviorTriggered('start_fair_policy', async (context) => syncByTriggerDebounced(`start_fair_policy_${context.limit}`));\n\n\t\t\tLicense.onBehaviorTriggered('disable_modules', async (context) => syncByTriggerDebounced(`disable_modules_${context.limit}`));\n\n\t\t\tLicense.onChange(() => api.broadcast('license.sync'));\n\n\t\t\tLicense.onBehaviorToggled('prevent_action', (context) => {\n\t\t\t\tif (!context.limit) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\tvoid api.broadcast('license.actions', {\n\t\t\t\t\t[context.limit]: true,\n\t\t\t\t} as Record<Partial<LicenseLimitKind>, boolean>);\n\t\t\t});\n\n\t\t\tLicense.onBehaviorToggled('allow_action', (context) => {\n\t\t\t\tif (!context.limit) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\tvoid api.broadcast('license.actions', {\n\t\t\t\t\t[context.limit]: false,\n\t\t\t\t} as Record<Partial<LicenseLimitKind>, boolean>);\n\t\t\t});\n\t\t\tresolve();\n\t\t});\n\t});\n};\n"],"mappings":"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","ignoreList":[]},"sourceType":"module","externalDependencies":{},"hash":"d83ea343395fc152aa40bea549d494e7a8bec21b"}
