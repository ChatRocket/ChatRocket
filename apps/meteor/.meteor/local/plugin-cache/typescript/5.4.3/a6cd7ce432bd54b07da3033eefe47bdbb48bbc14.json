{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/ee/server/apps/communication/rest.ts","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","topLevelAwait","objectRestSpread","objectRestSpread","asyncGenerators","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"os.osx.arm64"},"sourceFileName":"ee/server/apps/communication/rest.ts","filename":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/ee/server/apps/communication/rest.ts","inputSourceMap":{"version":3,"file":"ee/server/apps/communication/rest.ts","sourceRoot":"","sources":["ee/server/apps/communication/rest.ts"],"names":[],"mappings":"AAAA,OAAO,EAAE,SAAS,EAAE,cAAc,EAAE,MAAM,+CAA+C,CAAC;AAG1F,OAAO,EAAE,qBAAqB,EAAE,MAAM,yCAAyC,CAAC;AAEhF,OAAO,EAAE,OAAO,EAAE,MAAM,sBAAsB,CAAC;AAC/C,OAAO,EAAE,QAAQ,EAAE,KAAK,EAAE,MAAM,qBAAqB,CAAC;AACtD,OAAO,EAAE,WAAW,IAAI,KAAK,EAAE,MAAM,2BAA2B,CAAC;AACjE,OAAO,EAAE,MAAM,EAAE,MAAM,eAAe,CAAC;AAGvC,OAAO,EAAE,GAAG,EAAE,MAAM,4BAA4B,CAAC;AACjD,OAAO,EAAE,kBAAkB,EAAE,MAAM,uDAAuD,CAAC;AAC3F,OAAO,EAAE,iBAAiB,EAAE,MAAM,kDAAkD,CAAC;AACrF,OAAO,EAAE,uBAAuB,EAAE,gCAAgC,EAAE,MAAM,8BAA8B,CAAC;AACzG,OAAO,EAAE,oBAAoB,EAAE,MAAM,yDAAyD,CAAC;AAC/F,OAAO,EAAE,QAAQ,EAAE,MAAM,iCAAiC,CAAC;AAC3D,OAAO,EAAE,IAAI,EAAE,MAAM,uCAAuC,CAAC;AAC7D,OAAO,EAAE,IAAI,EAAE,MAAM,6BAA6B,CAAC;AACnD,OAAO,EAAE,oBAAoB,EAAE,MAAM,6CAA6C,CAAC;AACnF,OAAO,EAAE,YAAY,EAAE,MAAM,0CAA0C,CAAC;AACxE,OAAO,EAAE,wBAAwB,EAAE,MAAM,4CAA4C,CAAC;AACtF,OAAO,EAAE,cAAc,EAAE,MAAM,+BAA+B,CAAC;AAC/D,OAAO,EAAE,gBAAgB,EAAE,MAAM,2BAA2B,CAAC;AAE7D,OAAO,EAAE,IAAI,EAAE,MAAM,iBAAiB,CAAC;AACvC,OAAO,EAAE,oBAAoB,EAAE,MAAM,kCAAkC,CAAC;AACxE,OAAO,EAAE,gBAAgB,EAAE,MAAM,8BAA8B,CAAC;AAEhE,MAAM,iBAAiB,GAAG,IAAI,CAAC,OAAO,CAAC;AACvC,MAAM,+BAA+B,GAAG,IAAI,CAAC,qBAAqB,CAAC,OAAO,CAAC,MAAM,EAAE,EAAE,CAAC,CAAC;AACvF,MAAM,iBAAiB,GAAG,GAAwB,EAAE,CAAC,CAAC;IACrD,uBAAuB,EAAE,+BAA+B;CACxD,CAAC,CAAC;AAEH,MAAM,aAAa,GAAG,IAAI,GAAG,CAAC,CAAC,KAAK,EAAE,cAAc,CAAC,CAAC,CAAC;AAEvD,MAAM,OAAO,WAAW;IAChB,GAAG,CAAoB;IAEvB,KAAK,CAAwB;IAE7B,QAAQ,CAAa;IAE5B,YAAY,IAA2B,EAAE,OAAmB;QAC3D,IAAI,CAAC,KAAK,GAAG,IAAI,CAAC;QAClB,IAAI,CAAC,QAAQ,GAAG,OAAO,CAAC;QACxB,KAAK,IAAI,CAAC,OAAO,EAAE,CAAC;IACrB,CAAC;IAED,KAAK,CAAC,OAAO;QACZ,IAAI,CAAC,GAAG,GAAG,IAAI,GAAG,CAAC,QAAQ,CAAC;YAC3B,OAAO,EAAE,MAAM;YACf,cAAc,EAAE,IAAI;YACpB,UAAU,EAAE,KAAK;YACjB,UAAU,EAAE,KAAK;YACjB,IAAI,EAAE,GAAG,CAAC,WAAW,EAAE;SACvB,CAAC,CAAC;QACH,IAAI,CAAC,mBAAmB,EAAE,CAAC;IAC5B,CAAC;IAED,mBAAmB;QAClB,MAAM,YAAY,GAAG,IAAI,CAAC,KAAK,CAAC;QAChC,MAAM,OAAO,GAAG,IAAI,CAAC,QAAQ,CAAC;QAE9B,MAAM,WAAW,GAAG,CAAC,OAAe,EAAE,CAAM,EAAE,EAAE;YAC/C,uEAAuE;YACvE,sCAAsC;YACtC,IAAI,CAAC,CAAC,CAAC,cAAc,CAAC,UAAU,CAAC,EAAE,CAAC;gBACnC,YAAY,CAAC,mBAAmB,EAAE,CAAC,IAAI,CAAC,OAAO,EAAE,CAAC,CAAC,OAAO,CAAC,CAAC;gBAC5D,OAAO,GAAG,CAAC,EAAE,CAAC,aAAa,CAAC,iCAAiC,CAAC,CAAC;YAChE,CAAC;YAED,YAAY,CAAC,mBAAmB,EAAE,CAAC,KAAK,CAAC,OAAO,EAAE,CAAC,CAAC,QAAQ,CAAC,IAAI,CAAC,CAAC;YAEnE,IAAI,CAAC,CAAC,QAAQ,CAAC,UAAU,IAAI,GAAG,IAAI,CAAC,CAAC,QAAQ,CAAC,UAAU,IAAI,GAAG,EAAE,CAAC;gBAClE,OAAO,GAAG,CAAC,EAAE,CAAC,aAAa,EAAE,CAAC;YAC/B,CAAC;YAED,IAAI,CAAC,CAAC,QAAQ,CAAC,UAAU,KAAK,GAAG,EAAE,CAAC;gBACnC,OAAO,GAAG,CAAC,EAAE,CAAC,QAAQ,EAAE,CAAC;YAC1B,CAAC;YAED,OAAO,GAAG,CAAC,EAAE,CAAC,OAAO,EAAE,CAAC;QACzB,CAAC,CAAC;QAEF,IAAI,CAAC,GAAG,CAAC,QAAQ,CAAC,eAAe,EAAE,GAAG,oBAAoB,CAAC,IAAI,CAAC,CAAC,CAAC;QAClE,IAAI,CAAC,GAAG,CAAC,QAAQ,CAAC,OAAO,EAAE,GAAG,gBAAgB,CAAC,IAAI,CAAC,CAAC,CAAC;QAEtD,IAAI,CAAC,GAAG,CAAC,QAAQ,CAChB,mBAAmB,EACnB,EAAE,YAAY,EAAE,IAAI,EAAE,EACtB;YACC,KAAK,CAAC,GAAG;gBACR,MAAM,OAAO,GAAG,YAAY,CAAC,iBAAiB,EAAE,CAAC;gBACjD,MAAM,WAAW,GAAG,QAAQ,CAAC,GAAG,CAAC,oBAAoB,CAAC,CAAC;gBACvD,MAAM,EAAE,MAAM,EAAE,KAAK,EAAE,UAAU,EAAE,GAAG,IAAI,CAAC,WAAW,CAAC;gBAEvD,OAAO,GAAG,CAAC,EAAE,CAAC,OAAO,CAAC;oBACrB,GAAG,EAAE,GAAG,OAAO,SAAS,KAAK,iBAAiB,UAAU,IAAI,MAAM,gBAAgB,WAAW,sBAAsB,iBAAiB,EAAE;iBACtI,CAAC,CAAC;YACJ,CAAC;SACD,CACD,CAAC;QAEF,IAAI,CAAC,GAAG,CAAC,QAAQ,CAChB,aAAa,EACb,EAAE,YAAY,EAAE,IAAI,EAAE,EACtB;YACC,KAAK,CAAC,GAAG;gBACR,MAAM,OAAO,GAAG,YAAY,CAAC,iBAAiB,EAAE,CAAC;gBAEjD,qCAAqC;gBACrC,MAAM,OAAO,GAAG,iBAAiB,EAAE,CAAC;gBACpC,MAAM,KAAK,GAAG,MAAM,uBAAuB,EAAE,CAAC;gBAC9C,IAAI,KAAK,EAAE,CAAC;oBACX,OAAO,CAAC,aAAa,GAAG,UAAU,KAAK,EAAE,CAAC;gBAC3C,CAAC;gBAED,IAAI,MAAM,CAAC;gBACX,IAAI,CAAC;oBACJ,MAAM,OAAO,GAAG,MAAM,KAAK,CAAC,GAAG,OAAO,UAAU,EAAE;wBACjD,OAAO;wBACP,MAAM,EAAE;4BACP,GAAG,CAAC,IAAI,CAAC,WAAW,CAAC,WAAW,KAAK,OAAO,IAAI,EAAE,SAAS,EAAE,IAAI,CAAC,IAAI,CAAC,GAAG,EAAE,CAAC;yBAC7E;qBACD,CAAC,CAAC;oBAEH,IAAI,OAAO,CAAC,MAAM,KAAK,GAAG,EAAE,CAAC;wBAC5B,YAAY,CAAC,mBAAmB,EAAE,CAAC,KAAK,CAAC,kCAAkC,EAAE,MAAM,OAAO,CAAC,IAAI,EAAE,CAAC,CAAC;wBACnG,OAAO,GAAG,CAAC,EAAE,CAAC,OAAO,CAAC,EAAE,KAAK,EAAE,qBAAqB,EAAE,CAAC,CAAC;oBACzD,CAAC;oBAED,IAAI,OAAO,CAAC,MAAM,KAAK,GAAG,EAAE,CAAC;wBAC5B,YAAY,CAAC,mBAAmB,EAAE,CAAC,KAAK,CAAC,yBAAyB,EAAE,MAAM,OAAO,CAAC,IAAI,EAAE,CAAC,CAAC;wBAC1F,OAAO,GAAG,CAAC,EAAE,CAAC,OAAO,EAAE,CAAC;oBACzB,CAAC;oBACD,MAAM,GAAG,MAAM,OAAO,CAAC,IAAI,EAAE,CAAC;oBAE9B,IAAI,CAAC,OAAO,CAAC,EAAE,EAAE,CAAC;wBACjB,MAAM,IAAI,KAAK,CAAC,MAAM,CAAC,KAAK,CAAC,CAAC;oBAC/B,CAAC;gBACF,CAAC;gBAAC,OAAO,CAAC,EAAE,CAAC;oBACZ,OAAO,WAAW,CAAC,2EAA2E,EAAE,CAAC,CAAC,CAAC;gBACpG,CAAC;gBAED,OAAO,GAAG,CAAC,EAAE,CAAC,OAAO,CAAC,MAAM,CAAC,CAAC;YAC/B,CAAC;SACD,CACD,CAAC;QAEF,IAAI,CAAC,GAAG,CAAC,QAAQ,CAChB,YAAY,EACZ,EAAE,YAAY,EAAE,IAAI,EAAE,EACtB;YACC,KAAK,CAAC,GAAG;gBACR,MAAM,OAAO,GAAG,YAAY,CAAC,iBAAiB,EAAE,CAAC;gBAEjD,MAAM,OAAO,GAAG,iBAAiB,EAAE,CAAC;gBACpC,MAAM,KAAK,GAAG,MAAM,uBAAuB,EAAE,CAAC;gBAC9C,IAAI,KAAK,EAAE,CAAC;oBACX,OAAO,CAAC,aAAa,GAAG,UAAU,KAAK,EAAE,CAAC;gBAC3C,CAAC;gBAED,IAAI,MAAM,CAAC;gBACX,IAAI,CAAC;oBACJ,MAAM,OAAO,GAAG,MAAM,KAAK,CAAC,GAAG,OAAO,gBAAgB,EAAE,EAAE,OAAO,EAAE,CAAC,CAAC;oBACrE,IAAI,OAAO,CAAC,MAAM,KAAK,GAAG,EAAE,CAAC;wBAC5B,YAAY,CAAC,mBAAmB,EAAE,CAAC,KAAK,CAAC,yBAAyB,EAAE,MAAM,OAAO,CAAC,IAAI,EAAE,CAAC,CAAC;wBAC1F,OAAO,GAAG,CAAC,EAAE,CAAC,OAAO,EAAE,CAAC;oBACzB,CAAC;oBACD,MAAM,GAAG,MAAM,OAAO,CAAC,IAAI,EAAE,CAAC;gBAC/B,CAAC;gBAAC,OAAO,CAAM,EAAE,CAAC;oBACjB,OAAO,WAAW,CAAC,2EAA2E,EAAE,CAAC,CAAC,CAAC;gBACpG,CAAC;gBAED,OAAO,GAAG,CAAC,EAAE,CAAC,OAAO,CAAC,MAAM,CAAC,CAAC;YAC/B,CAAC;SACD,CACD,CAAC;QAEF,IAAI,CAAC,GAAG,CAAC,QAAQ,CAChB,kBAAkB,EAClB,EAAE,YAAY,EAAE,IAAI,EAAE,EACtB;YACC,KAAK,CAAC,GAAG;gBACR,MAAM,OAAO,GAAG,YAAY,CAAC,iBAAiB,EAAE,CAAC;gBAEjD,MAAM,WAAW,GAAG,QAAQ,CAAC,GAAG,CAAC,oBAAoB,CAAC,CAAC;gBAEvD,IAAI,CAAC,IAAI,CAAC,WAAW,CAAC,YAAY,IAAI,CAAC,aAAa,CAAC,GAAG,CAAC,IAAI,CAAC,WAAW,CAAC,YAAY,CAAC,EAAE,CAAC;oBACzF,OAAO,GAAG,CAAC,EAAE,CAAC,OAAO,CAAC,EAAE,KAAK,EAAE,uBAAuB,EAAE,CAAC,CAAC;gBAC3D,CAAC;gBAED,MAAM,QAAQ,GAAG,MAAM,gCAAgC,CAAC,sBAAsB,CAAC,CAAC;gBAChF,IAAI,CAAC,QAAQ,CAAC,KAAK,EAAE,CAAC;oBACrB,OAAO,GAAG,CAAC,EAAE,CAAC,OAAO,CAAC,EAAE,KAAK,EAAE,cAAc,EAAE,CAAC,CAAC;gBAClD,CAAC;gBAED,MAAM,cAAc,GAAG,IAAI,CAAC,WAAW,CAAC,OAAO,KAAK,MAAM,CAAC,CAAC,CAAC,mBAAmB,CAAC,CAAC,CAAC,WAAW,CAAC;gBAE/F,MAAM,KAAK,GAAG,MAAM,KAAK,CAAC,uBAAuB,EAAE,CAAC;gBAEpD,OAAO,GAAG,CAAC,EAAE,CAAC,OAAO,CAAC;oBACrB,GAAG,EAAE,GAAG,OAAO,SAAS,IAAI,CAAC,WAAW,CAAC,KAAK,IAC7C,IAAI,CAAC,WAAW,CAAC,YAAY,KAAK,KAAK,CAAC,CAAC,CAAC,IAAI,CAAC,WAAW,CAAC,YAAY,CAAC,CAAC,CAAC,cAC3E,gBAAgB,WAAW,UAAU,QAAQ,CAAC,KAAK,UAAU,KAAK,EAAE;iBACpE,CAAC,CAAC;YACJ,CAAC;SACD,CACD,CAAC;QAEF,IAAI,CAAC,GAAG,CAAC,QAAQ,CAChB,WAAW,EACX,EAAE,YAAY,EAAE,IAAI,EAAE,EACtB;YACC,KAAK,CAAC,GAAG;gBACR,MAAM,IAAI,GAAG,MAAM,OAAO,CAAC,GAAG,EAAE,CAAC;gBACjC,MAAM,SAAS,GAAG,MAAM,OAAO,CAAC,GAAG,CAAC,IAAI,CAAC,GAAG,CAAC,wBAAwB,CAAC,CAAC,CAAC;gBACxE,OAAO,GAAG,CAAC,EAAE,CAAC,OAAO,CAAC,EAAE,IAAI,EAAE,SAAS,EAAE,CAAC,CAAC;YAC5C,CAAC;SACD,CACD,CAAC;QAEF,yDAAyD;QACzD,IAAI,CAAC,GAAG,CAAC,QAAQ,CAChB,EAAE,EACF,EAAE,YAAY,EAAE,IAAI,EAAE,mBAAmB,EAAE,CAAC,aAAa,CAAC,EAAE,EAC5D;YACC,KAAK,CAAC,GAAG;gBACR,MAAM,OAAO,GAAG,YAAY,CAAC,iBAAiB,EAAE,CAAC;gBAEjD,qCAAqC;gBACrC,IAAI,aAAa,IAAI,IAAI,CAAC,WAAW,IAAI,IAAI,CAAC,WAAW,CAAC,WAAW,EAAE,CAAC;oBACvE,oBAAoB,CAAC,QAAQ,CAAC,IAAI,CAAC,OAAO,CAAC,KAAK,EAAE,OAAO,EAAE,IAAI,CAAC,QAAQ,EAAE,6CAA6C,CAAC,CAAC;oBAEzH,MAAM,OAAO,GAAG,iBAAiB,EAAE,CAAC;oBACpC,MAAM,KAAK,GAAG,MAAM,uBAAuB,EAAE,CAAC;oBAC9C,IAAI,KAAK,EAAE,CAAC;wBACX,OAAO,CAAC,aAAa,GAAG,UAAU,KAAK,EAAE,CAAC;oBAC3C,CAAC;oBAED,IAAI,MAAM,CAAC;oBACX,IAAI,CAAC;wBACJ,MAAM,OAAO,GAAG,MAAM,KAAK,CAAC,GAAG,OAAO,UAAU,EAAE,EAAE,OAAO,EAAE,CAAC,CAAC;wBAC/D,IAAI,OAAO,CAAC,MAAM,KAAK,GAAG,EAAE,CAAC;4BAC5B,YAAY,CAAC,mBAAmB,EAAE,CAAC,KAAK,CAAC,yBAAyB,EAAE,MAAM,OAAO,CAAC,IAAI,EAAE,CAAC,CAAC;4BAC1F,OAAO,GAAG,CAAC,EAAE,CAAC,OAAO,EAAE,CAAC;wBACzB,CAAC;wBACD,MAAM,GAAG,MAAM,OAAO,CAAC,IAAI,EAAE,CAAC;oBAC/B,CAAC;oBAAC,OAAO,CAAC,EAAE,CAAC;wBACZ,OAAO,WAAW,CAAC,2EAA2E,EAAE,CAAC,CAAC,CAAC;oBACpG,CAAC;oBAED,OAAO,GAAG,CAAC,EAAE,CAAC,OAAO,CAAC,MAAM,CAAC,CAAC;gBAC/B,CAAC;gBAED,IAAI,YAAY,IAAI,IAAI,CAAC,WAAW,IAAI,IAAI,CAAC,WAAW,CAAC,UAAU,EAAE,CAAC;oBACrE,oBAAoB,CAAC,QAAQ,CAAC,IAAI,CAAC,OAAO,CAAC,KAAK,EAAE,OAAO,EAAE,IAAI,CAAC,QAAQ,EAAE,kDAAkD,CAAC,CAAC;oBAC9H,MAAM,OAAO,GAAG,iBAAiB,EAAE,CAAC;oBACpC,MAAM,KAAK,GAAG,MAAM,uBAAuB,EAAE,CAAC;oBAC9C,IAAI,KAAK,EAAE,CAAC;wBACX,OAAO,CAAC,aAAa,GAAG,UAAU,KAAK,EAAE,CAAC;oBAC3C,CAAC;oBAED,IAAI,MAAM,CAAC;oBACX,IAAI,CAAC;wBACJ,MAAM,OAAO,GAAG,MAAM,KAAK,CAAC,GAAG,OAAO,gBAAgB,EAAE,EAAE,OAAO,EAAE,CAAC,CAAC;wBACrE,IAAI,OAAO,CAAC,MAAM,KAAK,GAAG,EAAE,CAAC;4BAC5B,YAAY,CAAC,mBAAmB,EAAE,CAAC,KAAK,CAAC,yBAAyB,EAAE,MAAM,OAAO,CAAC,IAAI,EAAE,CAAC,CAAC;4BAC1F,OAAO,GAAG,CAAC,EAAE,CAAC,OAAO,EAAE,CAAC;wBACzB,CAAC;wBACD,MAAM,GAAG,MAAM,OAAO,CAAC,IAAI,EAAE,CAAC;oBAC/B,CAAC;oBAAC,OAAO,CAAM,EAAE,CAAC;wBACjB,YAAY,CAAC,mBAAmB,EAAE,CAAC,KAAK,CAAC,oDAAoD,EAAE,CAAC,CAAC,CAAC;wBAClG,OAAO,GAAG,CAAC,EAAE,CAAC,aAAa,EAAE,CAAC;oBAC/B,CAAC;oBAED,OAAO,GAAG,CAAC,EAAE,CAAC,OAAO,CAAC,MAAM,CAAC,CAAC;gBAC/B,CAAC;gBAED,IACC,kBAAkB,IAAI,IAAI,CAAC,WAAW;oBACtC,OAAO,IAAI,IAAI,CAAC,WAAW;oBAC3B,IAAI,CAAC,WAAW,CAAC,gBAAgB;oBACjC,IAAI,CAAC,WAAW,CAAC,KAAK,EACrB,CAAC;oBACF,oBAAoB,CAAC,QAAQ,CAAC,IAAI,CAAC,OAAO,CAAC,KAAK,EAAE,OAAO,EAAE,IAAI,CAAC,QAAQ,EAAE,mDAAmD,CAAC,CAAC;oBAC/H,MAAM,WAAW,GAAG,QAAQ,CAAC,GAAG,CAAC,oBAAoB,CAAC,CAAC;oBAEvD,IAAI,CAAC,IAAI,CAAC,WAAW,CAAC,YAAY,IAAI,CAAC,aAAa,CAAC,GAAG,CAAC,IAAI,CAAC,WAAW,CAAC,YAAY,CAAC,EAAE,CAAC;wBACzF,OAAO,GAAG,CAAC,EAAE,CAAC,OAAO,CAAC,EAAE,KAAK,EAAE,uBAAuB,EAAE,CAAC,CAAC;oBAC3D,CAAC;oBAED,MAAM,KAAK,GAAG,MAAM,gCAAgC,CAAC,sBAAsB,CAAC,CAAC;oBAC7E,IAAI,CAAC,KAAK,EAAE,CAAC;wBACZ,OAAO,GAAG,CAAC,EAAE,CAAC,OAAO,CAAC,EAAE,KAAK,EAAE,cAAc,EAAE,CAAC,CAAC;oBAClD,CAAC;oBAED,MAAM,cAAc,GAAG,IAAI,CAAC,WAAW,CAAC,OAAO,KAAK,MAAM,CAAC,CAAC,CAAC,mBAAmB,CAAC,CAAC,CAAC,WAAW,CAAC;oBAE/F,MAAM,KAAK,GAAG,MAAM,KAAK,CAAC,uBAAuB,EAAE,CAAC;oBAEpD,OAAO,GAAG,CAAC,EAAE,CAAC,OAAO,CAAC;wBACrB,GAAG,EAAE,GAAG,OAAO,SAAS,IAAI,CAAC,WAAW,CAAC,KAAK,IAC7C,IAAI,CAAC,WAAW,CAAC,YAAY,KAAK,KAAK,CAAC,CAAC,CAAC,IAAI,CAAC,WAAW,CAAC,YAAY,CAAC,CAAC,CAAC,cAC3E,gBAAgB,WAAW,UAAU,KAAK,CAAC,KAAK,UAAU,KAAK,EAAE;qBACjE,CAAC,CAAC;gBACJ,CAAC;gBACD,oBAAoB,CAAC,QAAQ,CAAC,IAAI,CAAC,OAAO,CAAC,KAAK,EAAE,OAAO,EAAE,IAAI,CAAC,QAAQ,EAAE,qDAAqD,CAAC,CAAC;gBAEjI,MAAM,WAAW,GAAG,MAAM,OAAO,CAAC,GAAG,EAAE,CAAC;gBACxC,MAAM,IAAI,GAAG,MAAM,OAAO,CAAC,GAAG,CAAC,WAAW,CAAC,GAAG,CAAC,wBAAwB,CAAC,CAAC,CAAC;gBAE1E,OAAO,GAAG,CAAC,EAAE,CAAC,OAAO,CAAC,EAAE,IAAI,EAAE,CAAC,CAAC;YACjC,CAAC;YACD,KAAK,CAAC,IAAI;gBACT,IAAI,IAAI,CAAC;gBACT,IAAI,eAAe,CAAC;gBACpB,IAAI,kBAAkB,CAAC;gBAEvB,IAAI,IAAI,CAAC,UAAU,CAAC,GAAG,EAAE,CAAC;oBACzB,IAAI,CAAC;wBACJ,MAAM,QAAQ,GAAG,MAAM,KAAK,CAAC,IAAI,CAAC,UAAU,CAAC,GAAG,CAAC,CAAC;wBAElD,IAAI,QAAQ,CAAC,MAAM,KAAK,GAAG,IAAI,QAAQ,CAAC,OAAO,CAAC,GAAG,CAAC,cAAc,CAAC,KAAK,iBAAiB,EAAE,CAAC;4BAC3F,OAAO,GAAG,CAAC,EAAE,CAAC,OAAO,CAAC;gCACrB,KAAK,EAAE,6DAA6D;6BACpE,CAAC,CAAC;wBACJ,CAAC;wBAED,IAAI,GAAG,MAAM,QAAQ,CAAC,MAAM,EAAE,CAAC;oBAChC,CAAC;oBAAC,OAAO,CAAM,EAAE,CAAC;wBACjB,YAAY,CAAC,mBAAmB,EAAE,CAAC,KAAK,CAAC,iCAAiC,EAAE,CAAC,CAAC,QAAQ,CAAC,IAAI,CAAC,CAAC;wBAC7F,OAAO,GAAG,CAAC,EAAE,CAAC,aAAa,EAAE,CAAC;oBAC/B,CAAC;gBACF,CAAC;qBAAM,IAAI,OAAO,IAAI,IAAI,CAAC,UAAU,IAAI,IAAI,CAAC,UAAU,CAAC,KAAK,IAAI,IAAI,CAAC,UAAU,CAAC,WAAW,IAAI,IAAI,CAAC,UAAU,CAAC,OAAO,EAAE,CAAC;oBAC1H,MAAM,OAAO,GAAG,YAAY,CAAC,iBAAiB,EAAE,CAAC;oBAEjD,MAAM,OAAO,GAAG,iBAAiB,EAAE,CAAC;oBACpC,IAAI,CAAC;wBACJ,MAAM,aAAa,GAAG,MAAM,uBAAuB,CAAC,IAAI,EAAE,sBAAsB,EAAE,KAAK,CAAC,CAAC;wBACzF,MAAM,gBAAgB,GAAG,MAAM,uBAAuB,EAAE,CAAC;wBAEzD,MAAM,CAAC,gBAAgB,EAAE,mBAAmB,CAAC,GAAG,MAAM,OAAO,CAAC,GAAG,CAAC;4BACjE,KAAK,CAAC,GAAG,OAAO,YAAY,IAAI,CAAC,UAAU,CAAC,KAAK,aAAa,IAAI,CAAC,UAAU,CAAC,OAAO,UAAU,aAAa,EAAE,EAAE;gCAC/G,OAAO;6BACP,CAAC;4BACF,KAAK,CAAC,GAAG,OAAO,YAAY,IAAI,CAAC,UAAU,CAAC,KAAK,eAAe,IAAI,CAAC,UAAU,CAAC,OAAO,EAAE,EAAE;gCAC1F,OAAO,EAAE;oCACR,aAAa,EAAE,UAAU,gBAAgB,EAAE;oCAC3C,GAAG,OAAO;iCACV;6BACD,CAAC;yBACF,CAAC,CAAC;wBAEH,IAAI,gBAAgB,CAAC,OAAO,CAAC,GAAG,CAAC,cAAc,CAAC,KAAK,iBAAiB,EAAE,CAAC;4BACxE,MAAM,IAAI,KAAK,CAAC,6DAA6D,CAAC,CAAC;wBAChF,CAAC;wBAED,IAAI,GAAG,MAAM,CAAC,IAAI,CAAC,MAAM,gBAAgB,CAAC,WAAW,EAAE,CAAC,CAAC;wBACzD,eAAe,GAAG,CAAC,MAAM,mBAAmB,CAAC,IAAI,EAAE,CAAQ,CAAC;wBAC5D,kBAAkB,GAAG,IAAI,CAAC,UAAU,CAAC,kBAAkB,CAAC;oBACzD,CAAC;oBAAC,OAAO,GAAQ,EAAE,CAAC;wBACnB,OAAO,GAAG,CAAC,EAAE,CAAC,OAAO,CAAC,GAAG,CAAC,OAAO,CAAC,CAAC;oBACpC,CAAC;gBACF,CAAC;qBAAM,CAAC;oBACP,MAAM,GAAG,GAAG,MAAM,iBAAiB,CAClC;wBACC,OAAO,EAAE,IAAI,CAAC,OAAO;qBACrB,EACD,EAAE,KAAK,EAAE,KAAK,EAAE,SAAS,EAAE,QAAQ,CAAC,GAAG,CAAC,wBAAwB,CAAC,EAAE,CACnE,CAAC;oBAEF,MAAM,EAAE,MAAM,EAAE,QAAQ,EAAE,GAAG,GAAG,CAAC;oBAEjC,IAAI,GAAG,GAAG,CAAC,UAAU,CAAC;oBACtB,kBAAkB,GAAG,CAAC,GAAG,EAAE;wBAC1B,IAAI,CAAC;4BACJ,MAAM,WAAW,GAAG,IAAI,CAAC,KAAK,CAAC,QAAQ,EAAE,WAAW,IAAI,EAAE,CAAC,CAAC;4BAC5D,OAAO,WAAW,CAAC,MAAM,CAAC,CAAC,CAAC,WAAW,CAAC,CAAC,CAAC,SAAS,CAAC;wBACrD,CAAC;wBAAC,MAAM,CAAC;4BACR,OAAO,SAAS,CAAC;wBAClB,CAAC;oBACF,CAAC,CAAC,EAAE,CAAC;gBACN,CAAC;gBAED,IAAI,CAAC,IAAI,EAAE,CAAC;oBACX,OAAO,GAAG,CAAC,EAAE,CAAC,OAAO,CAAC,EAAE,KAAK,EAAE,+CAA+C,EAAE,CAAC,CAAC;gBACnF,CAAC;gBAED,oDAAoD;gBACpD,IAAI,CAAC,eAAe,IAAI,YAAY,CAAC,mCAAmC,EAAE,EAAE,CAAC;oBAC5E,OAAO,GAAG,CAAC,EAAE,CAAC,aAAa,CAAC,8BAA8B,CAAC,CAAC;gBAC7D,CAAC;gBAED,MAAM,IAAI,GAAG,YAAY;oBACxB,EAAE,aAAa,EAAE;oBACjB,EAAE,GAAG,CAAC,OAAO,CAAC;oBACd,EAAE,YAAY,CAAC,MAAM,MAAM,CAAC,SAAS,EAAE,CAAC,CAAC;gBAE1C,MAAM,GAAG,GAAG,MAAM,OAAO,CAAC,GAAG,CAAC,IAAI,EAAE,EAAE,eAAe,EAAE,kBAAkB,EAAE,MAAM,EAAE,KAAK,EAAE,IAAI,EAAE,CAAC,CAAC;gBAClG,MAAM,IAAI,GAAsC,GAAG,CAAC,UAAU,EAAE,CAAC;gBAEjE,IAAI,GAAG,CAAC,eAAe,EAAE,EAAE,CAAC;oBAC3B,OAAO,GAAG,CAAC,EAAE,CAAC,OAAO,CAAC,EAAE,MAAM,EAAE,eAAe,EAAE,QAAQ,EAAE,CAAC,GAAG,CAAC,eAAe,EAAE,CAAC,EAAE,CAAC,CAAC;gBACvF,CAAC;gBAED,IAAI,GAAG,CAAC,eAAe,EAAE,EAAE,CAAC;oBAC3B,OAAO,GAAG,CAAC,EAAE,CAAC,OAAO,CAAC;wBACrB,MAAM,EAAE,gBAAgB;wBACxB,QAAQ,EAAE,CAAE,GAAG,CAAC,eAAe,EAA0B,CAAC,OAAO,CAAC;wBAClE,OAAO,EAAE,EAAE,QAAQ,EAAG,GAAG,CAAC,eAAe,EAA0B,CAAC,QAAQ,EAAE;qBAC9E,CAAC,CAAC;gBACJ,CAAC;gBAED,IAAI,CAAC,MAAM,GAAG,MAAM,GAAG,CAAC,MAAM,EAAE,CAAC,SAAS,EAAE,CAAC;gBAE7C,KAAK,gBAAgB,CAAC,YAAY,CAAC,iBAAiB,EAAY,EAAE,SAAS,EAAE,IAAI,CAAC,CAAC;gBAEnF,IAAI,MAAM,YAAY,CAAC,GAAG,CAAC,MAAM,EAAE,CAAC,cAAc,EAAE,CAAC,EAAE,CAAC;oBACvD,MAAM,OAAO,GAAG,MAAM,OAAO,CAAC,MAAM,CAAC,IAAI,CAAC,EAAE,CAAC,CAAC;oBAC9C,IAAI,CAAC,MAAM,GAAG,OAAO,CAAC,CAAC,CAAC,SAAS,CAAC,YAAY,CAAC,CAAC,CAAC,IAAI,CAAC,MAAM,CAAC;gBAC9D,CAAC;gBAED,KAAK,YAAY,CAAC,WAAW,EAAE,CAAC,QAAQ,CAAC,IAAI,CAAC,EAAE,CAAC,CAAC;gBAElD,OAAO,GAAG,CAAC,EAAE,CAAC,OAAO,CAAC;oBACrB,GAAG,EAAE,IAAI;oBACT,WAAW,EAAE,GAAG,CAAC,wBAAwB,EAAE;oBAC3C,iBAAiB,EAAE,GAAG,CAAC,0BAA0B,EAAE;iBACnD,CAAC,CAAC;YACJ,CAAC;SACD,CACD,CAAC;QAEF,IAAI,CAAC,GAAG,CAAC,QAAQ,CAChB,yBAAyB,EACzB,EAAE,YAAY,EAAE,IAAI,EAAE,EACtB;YACC,KAAK,CAAC,GAAG;gBACR,IAAI,CAAC,IAAI,CAAC,WAAW,CAAC,KAAK,EAAE,CAAC;oBAC7B,OAAO,GAAG,CAAC,EAAE,CAAC,OAAO,CAAC,EAAE,KAAK,EAAE,qEAAqE,EAAE,CAAC,CAAC;gBACzG,CAAC;gBAED,MAAM,OAAO,GAAG,YAAY,CAAC,iBAAiB,EAAE,CAAC;gBACjD,MAAM,WAAW,GAAG,QAAQ,CAAC,GAAG,CAAS,oBAAoB,CAAC,CAAC;gBAE/D,MAAM,SAAS,GAAG;oBACjB,EAAE,EAAE,IAAI,CAAC,IAAI,CAAC,GAAG;oBACjB,QAAQ,EAAE,IAAI,CAAC,IAAI,CAAC,QAAQ;oBAC5B,IAAI,EAAE,IAAI,CAAC,IAAI,CAAC,IAAI;oBACpB,QAAQ,EAAE,IAAI,CAAC,IAAI,CAAC,QAAQ;oBAC5B,MAAM,EAAE,IAAI,CAAC,IAAI,EAAE,MAAM,EAAE,GAAG,CAAC,CAAC,CAAC,EAAE,EAAE,CAAC,CAAC,CAAC,OAAO,CAAC;iBAChD,CAAC;gBAEF,IAAI,MAAM,GAKJ,EAAE,CAAC;gBACT,IAAI,CAAC;oBACJ,MAAM,SAAS,GAAG,MAAM,KAAK,CAAC,gBAAgB,CAAC,CAAC,OAAO,CAAC,EAAE,SAAS,EAAE;wBACpE,UAAU,EAAE;4BACX,QAAQ,EAAE,CAAC;4BACX,IAAI,EAAE,CAAC;4BACP,QAAQ,EAAE,CAAC;yBACX;qBACD,CAAC,CAAC,OAAO,EAAE,CAAC;oBAEb,MAAM,GAAG,SAAS,CAAC,GAAG,CAAC,CAAC,CAAC,EAAE,EAAE;wBAC5B,OAAO;4BACN,EAAE,EAAE,CAAC,CAAC,GAAG;4BACT,QAAQ,EAAE,CAAC,CAAC,QAAQ;4BACpB,IAAI,EAAE,CAAC,CAAC,IAAI;4BACZ,QAAQ,EAAE,CAAC,CAAC,QAAQ;yBACpB,CAAC;oBACH,CAAC,CAAC,CAAC;gBACJ,CAAC;gBAAC,OAAO,CAAC,EAAE,CAAC;oBACZ,YAAY,CAAC,mBAAmB,EAAE,CAAC,KAAK,CAAC,0DAA0D,EAAE,CAAC,CAAC,CAAC;gBACzG,CAAC;gBAED,MAAM,WAAW,GAAG,IAAI,eAAe,EAAE,CAAC;gBAC1C,WAAW,CAAC,GAAG,CAAC,aAAa,EAAE,WAAW,CAAC,CAAC;gBAC5C,WAAW,CAAC,GAAG,CAAC,kBAAkB,EAAE,+BAA+B,CAAC,CAAC;gBACrE,WAAW,CAAC,GAAG,CAAC,WAAW,EAAE,MAAM,CAAC,IAAI,CAAC,IAAI,CAAC,SAAS,CAAC,SAAS,CAAC,CAAC,CAAC,QAAQ,CAAC,QAAQ,CAAC,CAAC,CAAC;gBACxF,WAAW,CAAC,GAAG,CAAC,QAAQ,EAAE,MAAM,CAAC,IAAI,CAAC,IAAI,CAAC,SAAS,CAAC,MAAM,CAAC,CAAC,CAAC,QAAQ,CAAC,QAAQ,CAAC,CAAC,CAAC;gBAElF,OAAO,GAAG,CAAC,EAAE,CAAC,OAAO,CAAC;oBACrB,GAAG,EAAE,GAAG,OAAO,SAAS,IAAI,CAAC,WAAW,CAAC,KAAK,kBAAkB,WAAW,CAAC,QAAQ,EAAE,EAAE;iBACxF,CAAC,CAAC;YACJ,CAAC;SACD,CACD,CAAC;QAEF,IAAI,CAAC,GAAG,CAAC,QAAQ,CAChB,oBAAoB,EACpB,EAAE,YAAY,EAAE,KAAK,EAAE,EACvB;YACC,GAAG;gBACF,MAAM,kBAAkB,GAAG,YAAY,CAAC,qBAAqB,EAAE,CAAC;gBAEhE,OAAO,GAAG,CAAC,EAAE,CAAC,OAAO,CAAC,EAAE,kBAAkB,EAAE,CAAC,CAAC;YAC/C,CAAC;SACD,CACD,CAAC;QAEF,IAAI,CAAC,GAAG,CAAC,QAAQ,CAChB,WAAW,EACX,EAAE,YAAY,EAAE,KAAK,EAAE,EACvB;YACC,KAAK,CAAC,GAAG;gBACR,MAAM,IAAI,GAAG,CAAC,MAAM,OAAO,CAAC,GAAG,EAAE,CAAC,CAAC,GAAG,CAAC,CAAC,GAAG,EAAE,EAAE,CAAC,CAAC;oBAChD,EAAE,EAAE,GAAG,CAAC,KAAK,EAAE;oBACf,SAAS,EAAE,GAAG,CAAC,cAAc,EAAE,CAAC,eAAe;iBAC/C,CAAC,CAAC,CAAC;gBAEJ,OAAO,GAAG,CAAC,EAAE,CAAC,OAAO,CAAC,EAAE,IAAI,EAAE,CAAC,CAAC;YACjC,CAAC;SACD,CACD,CAAC;QAEF,IAAI,CAAC,GAAG,CAAC,QAAQ,CAChB,wBAAwB,EACxB,EAAE,YAAY,EAAE,IAAI,EAAE,EACtB;YACC,IAAI;gBACH,IACC,CAAC,IAAI,CAAC,UAAU,CAAC,iBAAiB;oBAClC,CAAC,IAAI,CAAC,UAAU,CAAC,KAAK;oBACtB,CAAC,CAAC,8BAA8B,EAAE,8BAA8B,CAAC,CAAC,QAAQ,CAAC,IAAI,CAAC,UAAU,CAAC,KAAK,CAAC,EAChG,CAAC;oBACF,OAAO,GAAG,CAAC,EAAE,CAAC,OAAO,CAAC,EAAE,KAAK,EAAE,+CAA+C,EAAE,CAAC,CAAC;gBACnF,CAAC;gBAED,IAAI,CAAC;oBACJ,MAAM,EAAE,KAAK,EAAE,iBAAiB,EAAE,GAAG,IAAI,CAAC,UAAU,CAAC;oBACrD,MAAM,MAAM,GAAG,CAAC,IAAI,CAAC,UAAU,EAAE,EAAE,iBAAiB,EAA0B,CAAA,CAAC,sBAAsB,CAAC,KAAK,EAAE,iBAAiB,CAAC,CAAC;oBAEhI,OAAO,GAAG,CAAC,EAAE,CAAC,OAAO,CAAC,EAAE,MAAM,EAAE,CAAC,CAAC;gBACnC,CAAC;gBAAC,OAAO,CAAM,EAAE,CAAC;oBACjB,YAAY,CAAC,mBAAmB,EAAE,CAAC,KAAK,CAAC,gDAAgD,CAAC,CAAC,QAAQ,CAAC,IAAI,EAAE,CAAC,CAAC;oBAC5G,OAAO,GAAG,CAAC,EAAE,CAAC,aAAa,EAAE,CAAC;gBAC/B,CAAC;YACF,CAAC;SACD,CACD,CAAC;QAEF,IAAI,CAAC,GAAG,CAAC,QAAQ,CAChB,kBAAkB,EAClB,EAAE,YAAY,EAAE,IAAI,EAAE,mBAAmB,EAAE,CAAC,aAAa,CAAC,EAAE,EAC5D;YACC,KAAK,CAAC,GAAG;gBACR,MAAM,OAAO,GAAG,YAAY,CAAC,iBAAiB,EAAE,CAAC;gBAEjD,MAAM,OAAO,GAAwB,EAAE,CAAC;gBACxC,MAAM,KAAK,GAAG,MAAM,uBAAuB,EAAE,CAAC;gBAC9C,IAAI,KAAK,EAAE,CAAC;oBACX,OAAO,CAAC,aAAa,GAAG,UAAU,KAAK,EAAE,CAAC;gBAC3C,CAAC;gBAED,IAAI,MAAM,CAAC;gBACX,IAAI,CAAC;oBACJ,MAAM,OAAO,GAAG,MAAM,KAAK,CAAC,GAAG,OAAO,eAAe,IAAI,CAAC,SAAS,CAAC,EAAE,OAAO,EAAE,EAAE,OAAO,EAAE,CAAC,CAAC;oBAC5F,IAAI,OAAO,CAAC,MAAM,KAAK,GAAG,EAAE,CAAC;wBAC5B,YAAY,CAAC,mBAAmB,EAAE,CAAC,KAAK,CAAC,uDAAuD,EAAE,MAAM,OAAO,CAAC,IAAI,EAAE,CAAC,CAAC;wBACxH,OAAO,GAAG,CAAC,EAAE,CAAC,OAAO,EAAE,CAAC;oBACzB,CAAC;oBACD,MAAM,GAAG,MAAM,OAAO,CAAC,IAAI,EAAE,CAAC;gBAC/B,CAAC;gBAAC,OAAO,CAAM,EAAE,CAAC;oBACjB,YAAY,CAAC,mBAAmB,EAAE,CAAC,KAAK,CAAC,uDAAuD,EAAE,CAAC,CAAC,QAAQ,CAAC,IAAI,CAAC,CAAC;oBACnH,OAAO,GAAG,CAAC,EAAE,CAAC,aAAa,EAAE,CAAC;gBAC/B,CAAC;gBAED,OAAO,GAAG,CAAC,EAAE,CAAC,OAAO,CAAC,EAAE,IAAI,EAAE,MAAM,EAAE,CAAC,CAAC;YACzC,CAAC;SACD,CACD,CAAC;QAEF,IAAI,CAAC,GAAG,CAAC,QAAQ,CAChB,eAAe,EACf,EAAE,YAAY,EAAE,IAAI,EAAE,EACtB;YACC,KAAK,CAAC,GAAG;gBACR,MAAM,OAAO,GAAG,YAAY,CAAC,iBAAiB,EAAE,CAAC;gBAEjD,MAAM,OAAO,GAAG,iBAAiB,EAAE,CAAC;gBACpC,MAAM,KAAK,GAAG,MAAM,uBAAuB,EAAE,CAAC;gBAC9C,IAAI,KAAK,EAAE,CAAC;oBACX,OAAO,CAAC,aAAa,GAAG,UAAU,KAAK,EAAE,CAAC;gBAC3C,CAAC;gBAED,IAAI,MAAM,CAAC;gBACX,IAAI,CAAC;oBACJ,MAAM,OAAO,GAAG,MAAM,KAAK,CAAC,GAAG,OAAO,mBAAmB,EAAE,EAAE,OAAO,EAAE,CAAC,CAAC;oBACxE,IAAI,OAAO,CAAC,MAAM,KAAK,GAAG,EAAE,CAAC;wBAC5B,YAAY,CAAC,mBAAmB,EAAE,CAAC,KAAK,CAAC,uDAAuD,EAAE,MAAM,OAAO,CAAC,IAAI,EAAE,CAAC,CAAC;wBACxH,OAAO,GAAG,CAAC,EAAE,CAAC,OAAO,EAAE,CAAC;oBACzB,CAAC;oBACD,MAAM,GAAG,MAAM,OAAO,CAAC,IAAI,EAAE,CAAC;gBAC/B,CAAC;gBAAC,OAAO,CAAC,EAAE,CAAC;oBACZ,OAAO,WAAW,CAAC,2EAA2E,EAAE,CAAC,CAAC,CAAC;gBACpG,CAAC;gBAED,OAAO,GAAG,CAAC,EAAE,CAAC,OAAO,CAAC,MAAM,CAAC,CAAC;YAC/B,CAAC;SACD,CACD,CAAC;QAEF,IAAI,CAAC,GAAG,CAAC,QAAQ,CAChB,KAAK,EACL,EAAE,YAAY,EAAE,IAAI,EAAE,mBAAmB,EAAE,CAAC,aAAa,CAAC,EAAE,EAC5D;YACC,KAAK,CAAC,GAAG;gBACR,IAAI,IAAI,CAAC,WAAW,CAAC,WAAW,IAAI,IAAI,CAAC,WAAW,CAAC,OAAO,EAAE,CAAC;oBAC9D,MAAM,OAAO,GAAG,YAAY,CAAC,iBAAiB,EAAE,CAAC;oBAEjD,MAAM,OAAO,GAAwB,EAAE,CAAC,CAAC,mDAAmD;oBAC5F,MAAM,KAAK,GAAG,MAAM,uBAAuB,EAAE,CAAC;oBAC9C,IAAI,KAAK,EAAE,CAAC;wBACX,OAAO,CAAC,aAAa,GAAG,UAAU,KAAK,EAAE,CAAC;oBAC3C,CAAC;oBAED,IAAI,MAAW,CAAC;oBAChB,IAAI,CAAC;wBACJ,MAAM,OAAO,GAAG,MAAM,KAAK,CAAC,GAAG,OAAO,YAAY,IAAI,CAAC,SAAS,CAAC,EAAE,eAAe,IAAI,CAAC,WAAW,CAAC,OAAO,EAAE,EAAE,EAAE,OAAO,EAAE,CAAC,CAAC;wBAC3H,IAAI,OAAO,CAAC,MAAM,KAAK,GAAG,EAAE,CAAC;4BAC5B,YAAY,CAAC,mBAAmB,EAAE,CAAC,KAAK,CAAC,yDAAyD,EAAE,MAAM,OAAO,CAAC,IAAI,EAAE,CAAC,CAAC;4BAC1H,OAAO,GAAG,CAAC,EAAE,CAAC,OAAO,EAAE,CAAC;wBACzB,CAAC;wBACD,MAAM,GAAG,MAAM,OAAO,CAAC,IAAI,EAAE,CAAC;oBAC/B,CAAC;oBAAC,OAAO,CAAC,EAAE,CAAC;wBACZ,OAAO,WAAW,CAAC,2EAA2E,EAAE,CAAC,CAAC,CAAC;oBACpG,CAAC;oBAED,OAAO,GAAG,CAAC,EAAE,CAAC,OAAO,CAAC,EAAE,GAAG,EAAE,MAAM,CAAC,CAAC,CAAC,EAAE,CAAC,CAAC;gBAC3C,CAAC;gBAED,IAAI,IAAI,CAAC,WAAW,CAAC,WAAW,IAAI,IAAI,CAAC,WAAW,CAAC,MAAM,IAAI,IAAI,CAAC,WAAW,CAAC,UAAU,EAAE,CAAC;oBAC5F,MAAM,OAAO,GAAG,YAAY,CAAC,iBAAiB,EAAE,CAAC;oBAEjD,MAAM,OAAO,GAAG,iBAAiB,EAAE,CAAC;oBACpC,MAAM,KAAK,GAAG,MAAM,uBAAuB,EAAE,CAAC;oBAC9C,IAAI,KAAK,EAAE,CAAC;wBACX,OAAO,CAAC,aAAa,GAAG,UAAU,KAAK,EAAE,CAAC;oBAC3C,CAAC;oBAED,IAAI,MAAM,CAAC;oBACX,IAAI,CAAC;wBACJ,MAAM,OAAO,GAAG,MAAM,KAAK,CAAC,GAAG,OAAO,YAAY,IAAI,CAAC,SAAS,CAAC,EAAE,sBAAsB,IAAI,CAAC,WAAW,CAAC,UAAU,EAAE,EAAE;4BACvH,OAAO;yBACP,CAAC,CAAC;wBACH,IAAI,OAAO,CAAC,MAAM,KAAK,GAAG,EAAE,CAAC;4BAC5B,YAAY,CAAC,mBAAmB,EAAE,CAAC,KAAK,CAAC,yDAAyD,EAAE,MAAM,OAAO,CAAC,IAAI,EAAE,CAAC,CAAC;4BAC1H,OAAO,GAAG,CAAC,EAAE,CAAC,OAAO,EAAE,CAAC;wBACzB,CAAC;wBACD,MAAM,GAAG,MAAM,OAAO,CAAC,IAAI,EAAE,CAAC;oBAC/B,CAAC;oBAAC,OAAO,CAAC,EAAE,CAAC;wBACZ,OAAO,WAAW,CAAC,2EAA2E,EAAE,CAAC,CAAC,CAAC;oBACpG,CAAC;oBAED,OAAO,GAAG,CAAC,EAAE,CAAC,OAAO,CAAC,EAAE,GAAG,EAAE,MAAM,EAAE,CAAC,CAAC;gBACxC,CAAC;gBACD,MAAM,GAAG,GAAG,OAAO,CAAC,UAAU,CAAC,IAAI,CAAC,SAAS,CAAC,EAAE,CAAC,CAAC;gBAClD,IAAI,CAAC,GAAG,EAAE,CAAC;oBACV,OAAO,GAAG,CAAC,EAAE,CAAC,QAAQ,CAAC,8BAA8B,IAAI,CAAC,SAAS,CAAC,EAAE,EAAE,CAAC,CAAC;gBAC3E,CAAC;gBAED,OAAO,GAAG,CAAC,EAAE,CAAC,OAAO,CAAC;oBACrB,GAAG,EAAE,wBAAwB,CAAC,GAAG,CAAC;iBAClC,CAAC,CAAC;YACJ,CAAC;YACD,KAAK,CAAC,IAAI;gBACT,IAAI,IAAI,CAAC;gBACT,IAAI,kBAAkB,CAAC;gBACvB,IAAI,kBAAkB,GAAG,KAAK,CAAC;gBAE/B,IAAI,IAAI,CAAC,UAAU,CAAC,GAAG,EAAE,CAAC;oBACzB,MAAM,QAAQ,GAAG,MAAM,KAAK,CAAC,IAAI,CAAC,UAAU,CAAC,GAAG,CAAC,CAAC;oBAElD,IAAI,QAAQ,CAAC,MAAM,KAAK,GAAG,IAAI,QAAQ,CAAC,OAAO,CAAC,GAAG,CAAC,cAAc,CAAC,KAAK,iBAAiB,EAAE,CAAC;wBAC3F,OAAO,GAAG,CAAC,EAAE,CAAC,OAAO,CAAC;4BACrB,KAAK,EAAE,6DAA6D;yBACpE,CAAC,CAAC;oBACJ,CAAC;oBAED,IAAI,GAAG,MAAM,CAAC,IAAI,CAAC,MAAM,QAAQ,CAAC,WAAW,EAAE,CAAC,CAAC;gBAClD,CAAC;qBAAM,IAAI,IAAI,CAAC,UAAU,CAAC,KAAK,IAAI,IAAI,CAAC,UAAU,CAAC,WAAW,IAAI,IAAI,CAAC,UAAU,CAAC,OAAO,EAAE,CAAC;oBAC5F,MAAM,OAAO,GAAG,YAAY,CAAC,iBAAiB,EAAE,CAAC;oBAEjD,MAAM,OAAO,GAAG,iBAAiB,EAAE,CAAC;oBACpC,MAAM,KAAK,GAAG,MAAM,uBAAuB,CAAC,IAAI,EAAE,sBAAsB,EAAE,KAAK,CAAC,CAAC;oBAEjF,IAAI,CAAC;wBACJ,MAAM,QAAQ,GAAG,MAAM,KAAK,CAC3B,GAAG,OAAO,YAAY,IAAI,CAAC,UAAU,CAAC,KAAK,aAAa,IAAI,CAAC,UAAU,CAAC,OAAO,UAAU,KAAK,EAAE,EAChG;4BACC,OAAO;yBACP,CACD,CAAC;wBAEF,IAAI,QAAQ,CAAC,MAAM,KAAK,GAAG,EAAE,CAAC;4BAC7B,YAAY,CAAC,mBAAmB,EAAE,CAAC,KAAK,CAAC,6CAA6C,EAAE,MAAM,QAAQ,CAAC,IAAI,EAAE,CAAC,CAAC;4BAC/G,OAAO,GAAG,CAAC,EAAE,CAAC,OAAO,EAAE,CAAC;wBACzB,CAAC;wBAED,IAAI,QAAQ,CAAC,OAAO,CAAC,GAAG,CAAC,cAAc,CAAC,KAAK,iBAAiB,EAAE,CAAC;4BAChE,OAAO,GAAG,CAAC,EAAE,CAAC,OAAO,CAAC;gCACrB,KAAK,EAAE,6DAA6D;6BACpE,CAAC,CAAC;wBACJ,CAAC;wBAED,IAAI,GAAG,MAAM,CAAC,IAAI,CAAC,MAAM,QAAQ,CAAC,WAAW,EAAE,CAAC,CAAC;oBAClD,CAAC;oBAAC,OAAO,CAAM,EAAE,CAAC;wBACjB,YAAY,CAAC,mBAAmB,EAAE,CAAC,KAAK,CAAC,6CAA6C,EAAE,CAAC,CAAC,QAAQ,CAAC,IAAI,CAAC,CAAC;wBACzG,OAAO,GAAG,CAAC,EAAE,CAAC,aAAa,EAAE,CAAC;oBAC/B,CAAC;gBACF,CAAC;qBAAM,CAAC;oBACP,kBAAkB,GAAG,IAAI,CAAC;oBAE1B,MAAM,GAAG,GAAG,MAAM,iBAAiB,CAClC;wBACC,OAAO,EAAE,IAAI,CAAC,OAAO;qBACrB,EACD,EAAE,KAAK,EAAE,KAAK,EAAE,SAAS,EAAE,QAAQ,CAAC,GAAG,CAAC,wBAAwB,CAAC,EAAE,CACnE,CAAC;oBAEF,MAAM,EAAE,MAAM,EAAE,QAAQ,EAAE,GAAG,GAAG,CAAC;oBAEjC,IAAI,GAAG,GAAG,CAAC,UAAU,CAAC;oBACtB,kBAAkB,GAAG,CAAC,GAAG,EAAE;wBAC1B,IAAI,CAAC;4BACJ,MAAM,WAAW,GAAG,IAAI,CAAC,KAAK,CAAC,QAAQ,EAAE,WAAW,IAAI,EAAE,CAAC,CAAC;4BAC5D,OAAO,WAAW,CAAC,MAAM,CAAC,CAAC,CAAC,WAAW,CAAC,CAAC,CAAC,SAAS,CAAC;wBACrD,CAAC;wBAAC,MAAM,CAAC;4BACR,OAAO,SAAS,CAAC;wBAClB,CAAC;oBACF,CAAC,CAAC,EAAE,CAAC;gBACN,CAAC;gBAED,IAAI,CAAC,IAAI,EAAE,CAAC;oBACX,OAAO,GAAG,CAAC,EAAE,CAAC,OAAO,CAAC,EAAE,KAAK,EAAE,+CAA+C,EAAE,CAAC,CAAC;gBACnF,CAAC;gBAED,IAAI,kBAAkB,IAAI,YAAY,CAAC,mCAAmC,EAAE,EAAE,CAAC;oBAC9E,OAAO,GAAG,CAAC,EAAE,CAAC,aAAa,CAAC,8BAA8B,CAAC,CAAC;gBAC7D,CAAC;gBAED,MAAM,IAAI,GAAG,YAAY;oBACxB,EAAE,aAAa,EAAE;oBACjB,EAAE,GAAG,CAAC,OAAO,CAAC;oBACd,EAAE,YAAY,CAAC,MAAM,MAAM,CAAC,SAAS,EAAE,CAAC,CAAC;gBAE1C,MAAM,GAAG,GAAG,MAAM,OAAO,CAAC,MAAM,CAAC,IAAI,EAAE,kBAAkB,EAAE,EAAE,IAAI,EAAE,OAAO,EAAE,IAAI,EAAE,CAAC,CAAC;gBACpF,MAAM,IAAI,GAAsC,GAAG,CAAC,UAAU,EAAE,CAAC;gBAEjE,IAAI,GAAG,CAAC,eAAe,EAAE,EAAE,CAAC;oBAC3B,OAAO,GAAG,CAAC,EAAE,CAAC,OAAO,CAAC,EAAE,MAAM,EAAE,eAAe,EAAE,QAAQ,EAAE,CAAC,GAAG,CAAC,eAAe,EAAE,CAAC,EAAE,CAAC,CAAC;gBACvF,CAAC;gBAED,IAAI,GAAG,CAAC,eAAe,EAAE,EAAE,CAAC;oBAC3B,OAAO,GAAG,CAAC,EAAE,CAAC,OAAO,CAAC;wBACrB,MAAM,EAAE,gBAAgB;wBACxB,QAAQ,EAAE,CAAE,GAAG,CAAC,eAAe,EAA0B,CAAC,OAAO,CAAC;wBAClE,OAAO,EAAE,EAAE,QAAQ,EAAG,GAAG,CAAC,eAAe,EAA0B,CAAC,QAAQ,EAAE;qBAC9E,CAAC,CAAC;gBACJ,CAAC;gBAED,IAAI,CAAC,MAAM,GAAG,MAAM,GAAG,CAAC,MAAM,EAAE,CAAC,SAAS,EAAE,CAAC;gBAE7C,KAAK,gBAAgB,CAAC,YAAY,CAAC,iBAAiB,EAAY,EAAE,QAAQ,EAAE,IAAI,CAAC,CAAC;gBAElF,KAAK,YAAY,CAAC,WAAW,EAAE,CAAC,UAAU,CAAC,IAAI,CAAC,EAAE,CAAC,CAAC;gBAEpD,OAAO,GAAG,CAAC,EAAE,CAAC,OAAO,CAAC;oBACrB,GAAG,EAAE,IAAI;oBACT,WAAW,EAAE,GAAG,CAAC,wBAAwB,EAAE;oBAC3C,iBAAiB,EAAE,GAAG,CAAC,0BAA0B,EAAE;iBACnD,CAAC,CAAC;YACJ,CAAC;YACD,KAAK,CAAC,MAAM;gBACX,MAAM,GAAG,GAAG,OAAO,CAAC,UAAU,CAAC,IAAI,CAAC,SAAS,CAAC,EAAE,CAAC,CAAC;gBAElD,IAAI,CAAC,GAAG,EAAE,CAAC;oBACV,OAAO,GAAG,CAAC,EAAE,CAAC,QAAQ,CAAC,8BAA8B,IAAI,CAAC,SAAS,CAAC,EAAE,EAAE,CAAC,CAAC;gBAC3E,CAAC;gBAED,MAAM,IAAI,GAAG,YAAY;oBACxB,EAAE,aAAa,EAAE;oBACjB,EAAE,GAAG,CAAC,OAAO,CAAC;qBACb,YAAY,CAAC,MAAM,MAAM,CAAC,SAAS,EAAE,CAAC,CAAC;gBAEzC,MAAM,IAAI,GAAsC,GAAG,CAAC,OAAO,EAAE,CAAC;gBAC9D,IAAI,CAAC;oBACJ,MAAM,OAAO,CAAC,MAAM,CAAC,GAAG,CAAC,KAAK,EAAE,EAAE,EAAE,IAAI,EAAE,CAAC,CAAC;oBAC5C,IAAI,CAAC,MAAM,GAAG,SAAS,CAAC,QAAQ,CAAC;gBAClC,CAAC;gBAAC,OAAO,CAAC,EAAE,CAAC;oBACZ,IAAI,CAAC,MAAM,GAAG,MAAM,GAAG,CAAC,SAAS,EAAE,CAAC;oBACpC,OAAO,GAAG,CAAC,EAAE,CAAC,OAAO,CAAC,EAAE,GAAG,EAAE,IAAI,EAAE,CAAC,CAAC;gBACtC,CAAC;gBAED,KAAK,gBAAgB,CAAC,YAAY,CAAC,iBAAiB,EAAY,EAAE,WAAW,EAAE,IAAI,CAAC,CAAC;gBAErF,OAAO,GAAG,CAAC,EAAE,CAAC,OAAO,CAAC,EAAE,GAAG,EAAE,IAAI,EAAE,CAAC,CAAC;YACtC,CAAC;SACD,CACD,CAAC;QAEF,IAAI,CAAC,GAAG,CAAC,QAAQ,CAChB,cAAc,EACd,EAAE,YAAY,EAAE,IAAI,EAAE,EACtB;YACC,KAAK,CAAC,GAAG;gBACR,MAAM,OAAO,GAAG,YAAY,CAAC,iBAAiB,EAAE,CAAC;gBAEjD,MAAM,OAAO,GAAwB,EAAE,CAAC,CAAC,mDAAmD;gBAC5F,MAAM,KAAK,GAAG,MAAM,uBAAuB,EAAE,CAAC;gBAC9C,IAAI,KAAK,EAAE,CAAC;oBACX,OAAO,CAAC,aAAa,GAAG,UAAU,KAAK,EAAE,CAAC;gBAC3C,CAAC;gBAED,IAAI,MAAM,CAAC;gBACX,IAAI,UAAU,CAAC;gBACf,IAAI,CAAC;oBACJ,MAAM,OAAO,GAAG,MAAM,KAAK,CAAC,GAAG,OAAO,YAAY,IAAI,CAAC,SAAS,CAAC,EAAE,EAAE,EAAE,EAAE,OAAO,EAAE,CAAC,CAAC;oBACpF,UAAU,GAAG,OAAO,CAAC,MAAM,CAAC;oBAC5B,MAAM,GAAG,MAAM,OAAO,CAAC,IAAI,EAAE,CAAC;oBAE9B,IAAI,CAAC,OAAO,CAAC,EAAE,EAAE,CAAC;wBACjB,MAAM,IAAI,KAAK,CAAC,MAAM,CAAC,KAAK,CAAC,CAAC;oBAC/B,CAAC;gBACF,CAAC;gBAAC,OAAO,CAAC,EAAE,CAAC;oBACZ,OAAO,WAAW,CAAC,2EAA2E,EAAE,CAAC,CAAC,CAAC;gBACpG,CAAC;gBAED,IAAI,CAAC,MAAM,IAAI,UAAU,KAAK,GAAG,EAAE,CAAC;oBACnC,YAAY,CAAC,mBAAmB,EAAE,CAAC,KAAK,CAAC,sDAAsD,EAAE,MAAM,CAAC,CAAC;oBACzG,OAAO,GAAG,CAAC,EAAE,CAAC,OAAO,EAAE,CAAC;gBACzB,CAAC;gBAED,OAAO,GAAG,CAAC,EAAE,CAAC,OAAO,CAAC,EAAE,IAAI,EAAE,MAAM,EAAE,CAAC,CAAC;YACzC,CAAC;SACD,CACD,CAAC;QAEF,IAAI,CAAC,GAAG,CAAC,QAAQ,CAChB,eAAe,EACf,EAAE,YAAY,EAAE,IAAI,EAAE,EACtB;YACC,KAAK,CAAC,IAAI;gBACT,MAAM,EAAE,KAAK,EAAE,OAAO,EAAE,UAAU,EAAE,OAAO,EAAE,GAAG,IAAI,CAAC,UAAU,CAAC;gBAChE,MAAM,YAAY,GAAG,QAAQ,CAAC,GAAG,CAAS,UAAU,CAAC,CAAC;gBAEtD,MAAM,KAAK,GAAG,IAAI,MAAM,CAAC,MAAM,EAAE,IAAI,CAAC,CAAC;gBACvC,MAAM,gBAAgB,GAAG,YAAY,CAAC,OAAO,CAAC,KAAK,EAAE,EAAE,CAAC,CAAC;gBACzD,MAAM,SAAS,GAAG,GAAG,gBAAgB,6BAA6B,KAAK,IAAI,UAAU,WAAW,CAAC;gBAEjG,IAAI,CAAC;oBACJ,MAAM,IAAI,GAAiE,KAAK,EAAE,EAAE,SAAS,EAAE,EAAE,EAAE;wBAClG,OAAO;4BACN,GAAG,EAAE,IAAI,CAAC,CAAC,CAAC,2BAA2B,EAAE;gCACxC,UAAU,EAAE,SAAS,CAAC,IAAI,IAAI,EAAE;gCAChC,QAAQ,EAAE,OAAO,IAAI,EAAE;gCACvB,SAAS,EAAE,IAAI,IAAI,CAAC,IAAI,CAAC,QAAQ,EAAE;gCACnC,OAAO,EAAE,OAAO,IAAI,EAAE;gCACtB,UAAU,EAAE,SAAS;gCACrB,aAAa,EAAE,EAAE,WAAW,EAAE,KAAK,EAAE;6BACrC,CAAC;yBACF,CAAC;oBACH,CAAC,CAAC;oBAEF,MAAM,oBAAoB,CAAC,EAAE,IAAI,EAAE,CAAC,CAAC;oBAErC,OAAO,GAAG,CAAC,EAAE,CAAC,OAAO,EAAE,CAAC;gBACzB,CAAC;gBAAC,OAAO,CAAC,EAAE,CAAC;oBACZ,YAAY,CAAC,mBAAmB,EAAE,CAAC,KAAK,CAAC,4DAA4D,EAAE,CAAC,CAAC,CAAC;oBAC1G,OAAO,GAAG,CAAC,EAAE,CAAC,OAAO,EAAE,CAAC;gBACzB,CAAC;YACF,CAAC;SACD,CACD,CAAC;QAEF,IAAI,CAAC,GAAG,CAAC,QAAQ,CAChB,UAAU,EACV,EAAE,YAAY,EAAE,IAAI,EAAE,mBAAmB,EAAE,CAAC,aAAa,CAAC,EAAE,EAC5D;YACC,KAAK,CAAC,IAAI;gBACT,MAAM,OAAO,GAAG,YAAY,CAAC,iBAAiB,EAAE,CAAC;gBAEjD,MAAM,OAAO,GAAG,iBAAiB,EAAE,CAAC;gBACpC,MAAM,KAAK,GAAG,MAAM,uBAAuB,EAAE,CAAC;gBAC9C,IAAI,KAAK,EAAE,CAAC;oBACX,OAAO,CAAC,aAAa,GAAG,UAAU,KAAK,EAAE,CAAC;gBAC3C,CAAC;gBAED,MAAM,kBAAkB,GAAG,MAAM,QAAQ,CAAC,WAAW,CAAC,oBAAoB,CAAC,CAAC;gBAC5E,IAAI,CAAC,kBAAkB,EAAE,CAAC;oBACzB,OAAO,GAAG,CAAC,EAAE,CAAC,OAAO,CAAC,uBAAuB,CAAC,CAAC;gBAChD,CAAC;gBAED,IAAI,MAAM,CAAC;gBACX,IAAI,UAAU,CAAC;gBACf,IAAI,CAAC;oBACJ,MAAM,OAAO,GAAG,MAAM,KAAK,CAAC,GAAG,OAAO,kBAAkB,kBAAkB,CAAC,KAAK,SAAS,IAAI,CAAC,SAAS,CAAC,EAAE,EAAE,EAAE,EAAE,OAAO,EAAE,CAAC,CAAC;oBAC3H,UAAU,GAAG,OAAO,CAAC,MAAM,CAAC;oBAC5B,MAAM,GAAG,MAAM,OAAO,CAAC,IAAI,EAAE,CAAC;oBAE9B,IAAI,CAAC,OAAO,CAAC,EAAE,EAAE,CAAC;wBACjB,MAAM,IAAI,KAAK,CAAC,MAAM,CAAC,KAAK,CAAC,CAAC;oBAC/B,CAAC;gBACF,CAAC;gBAAC,OAAO,CAAM,EAAE,CAAC;oBACjB,YAAY,CAAC,mBAAmB,EAAE,CAAC,KAAK,CAAC,6CAA6C,EAAE,CAAC,CAAC,CAAC;oBAC3F,OAAO,GAAG,CAAC,EAAE,CAAC,aAAa,EAAE,CAAC;gBAC/B,CAAC;gBAED,IAAI,UAAU,KAAK,GAAG,EAAE,CAAC;oBACxB,YAAY,CAAC,mBAAmB,EAAE,CAAC,KAAK,CAAC,6CAA6C,EAAE,MAAM,CAAC,CAAC;oBAChG,OAAO,GAAG,CAAC,EAAE,CAAC,OAAO,EAAE,CAAC;gBACzB,CAAC;gBAED,MAAM,IAAI,CAAC,yBAAyB,CAAC,CAAC,MAAM,CAAC,CAAC,CAAC;gBAE/C,OAAO,GAAG,CAAC,EAAE,CAAC,OAAO,CAAC,EAAE,GAAG,EAAE,MAAM,EAAE,CAAC,CAAC;YACxC,CAAC;SACD,CACD,CAAC;QAEF,IAAI,CAAC,GAAG,CAAC,QAAQ,CAChB,UAAU,EACV,EAAE,YAAY,EAAE,KAAK,EAAE,EACvB;YACC,GAAG;gBACF,MAAM,GAAG,GAAG,OAAO,CAAC,UAAU,CAAC,IAAI,CAAC,SAAS,CAAC,EAAE,CAAC,CAAC;gBAClD,IAAI,CAAC,GAAG,EAAE,CAAC;oBACV,OAAO,GAAG,CAAC,EAAE,CAAC,QAAQ,CAAC,8BAA8B,IAAI,CAAC,SAAS,CAAC,EAAE,EAAE,CAAC,CAAC;gBAC3E,CAAC;gBAED,MAAM,IAAI,GAAG,GAAG,CAAC,OAAO,EAAE,CAAC;gBAC3B,IAAI,CAAC,IAAI,EAAE,eAAe,EAAE,CAAC;oBAC5B,OAAO,GAAG,CAAC,EAAE,CAAC,QAAQ,CAAC,8BAA8B,IAAI,CAAC,SAAS,CAAC,EAAE,EAAE,CAAC,CAAC;gBAC3E,CAAC;gBAED,MAAM,SAAS,GAAG,IAAI,CAAC,eAAe,CAAC,KAAK,CAAC,UAAU,CAAC,CAAC;gBAEzD,MAAM,GAAG,GAAG,MAAM,CAAC,IAAI,CAAC,SAAS,CAAC,CAAC,CAAC,EAAE,QAAQ,CAAC,CAAC;gBAEhD,OAAO;oBACN,UAAU,EAAE,GAAG;oBACf,OAAO,EAAE;wBACR,gBAAgB,EAAE,GAAG,CAAC,MAAM;wBAC5B,cAAc,EAAE,SAAS,CAAC,CAAC,CAAC,CAAC,OAAO,CAAC,OAAO,EAAE,EAAE,CAAC;qBACjD;oBACD,IAAI,EAAE,GAAG;iBACT,CAAC;YACH,CAAC;SACD,CACD,CAAC;QAEF,IAAI,CAAC,GAAG,CAAC,QAAQ,CAChB,iBAAiB,EACjB,EAAE,YAAY,EAAE,KAAK,EAAE,EACvB;YACC,KAAK,CAAC,GAAG;gBACR,MAAM,OAAO,GAAG,YAAY,CAAC,iBAAiB,EAAE,CAAC;gBACjD,MAAM,KAAK,GAAG,IAAI,CAAC,SAAS,CAAC,EAAE,CAAC;gBAChC,MAAM,OAAO,GAAG,iBAAiB,EAAE,CAAC;gBAEpC,IAAI,CAAC;oBACJ,MAAM,OAAO,GAAG,MAAM,KAAK,CAAC,GAAG,OAAO,YAAY,KAAK,cAAc,EAAE,EAAE,OAAO,EAAE,CAAC,CAAC;oBACpF,MAAM,IAAI,GAAG,MAAM,OAAO,CAAC,IAAI,EAAE,CAAC;oBAElC,OAAO,GAAG,CAAC,EAAE,CAAC,OAAO,CAAC;wBACrB,WAAW,EAAE,IAAI;qBACjB,CAAC,CAAC;gBACJ,CAAC;gBAAC,OAAO,CAAM,EAAE,CAAC;oBACjB,YAAY,CAAC,mBAAmB,EAAE,CAAC,KAAK,CAAC,qDAAqD,EAAE,CAAC,CAAC,OAAO,CAAC,CAAC;oBAC3G,OAAO,GAAG,CAAC,EAAE,CAAC,OAAO,CAAC,CAAC,CAAC,OAAO,CAAC,CAAC;gBAClC,CAAC;YACF,CAAC;SACD,CACD,CAAC;QAEF,IAAI,CAAC,GAAG,CAAC,QAAQ,CAChB,eAAe,EACf,EAAE,YAAY,EAAE,KAAK,EAAE,EACvB;YACC,GAAG;gBACF,MAAM,GAAG,GAAG,OAAO,CAAC,UAAU,CAAC,IAAI,CAAC,SAAS,CAAC,EAAE,CAAC,CAAC;gBAElD,IAAI,GAAG,EAAE,CAAC;oBACT,MAAM,SAAS,GAAG,GAAG,CAAC,cAAc,EAAE,CAAC,eAAe,IAAI,EAAE,CAAC;oBAE7D,OAAO,GAAG,CAAC,EAAE,CAAC,OAAO,CAAC,EAAE,SAAS,EAAE,CAAC,CAAC;gBACtC,CAAC;gBACD,OAAO,GAAG,CAAC,EAAE,CAAC,QAAQ,CAAC,8BAA8B,IAAI,CAAC,SAAS,CAAC,EAAE,EAAE,CAAC,CAAC;YAC3E,CAAC;SACD,CACD,CAAC;QAEF,IAAI,CAAC,GAAG,CAAC,QAAQ,CAChB,UAAU,EACV,EAAE,YAAY,EAAE,IAAI,EAAE,mBAAmB,EAAE,CAAC,aAAa,CAAC,EAAE,EAC5D;YACC,KAAK,CAAC,GAAG;gBACR,MAAM,GAAG,GAAG,OAAO,CAAC,UAAU,CAAC,IAAI,CAAC,SAAS,CAAC,EAAE,CAAC,CAAC;gBAElD,IAAI,GAAG,EAAE,CAAC;oBACT,MAAM,EAAE,MAAM,EAAE,KAAK,EAAE,GAAG,MAAM,kBAAkB,CAAC,IAAI,CAAC,WAAW,CAAC,CAAC;oBACrE,MAAM,EAAE,IAAI,EAAE,MAAM,EAAE,KAAK,EAAE,GAAG,MAAM,IAAI,CAAC,cAAc,EAAE,CAAC;oBAE5D,MAAM,QAAQ,GAAG,MAAM,CAAC,MAAM,CAAC,EAAE,EAAE,KAAK,EAAE,EAAE,KAAK,EAAE,GAAG,CAAC,KAAK,EAAE,EAAE,CAAC,CAAC;oBAClE,MAAM,OAAO,GAAG;wBACf,IAAI,EAAE,IAAI,IAAI,EAAE,UAAU,EAAE,CAAC,CAAC,EAAE;wBAChC,IAAI,EAAE,MAAM;wBACZ,KAAK,EAAE,KAAK;wBACZ,MAAM;qBACN,CAAC;oBAEF,MAAM,IAAI,GAAG,MAAM,YAAY,EAAE,aAAa,EAAE,EAAE,IAAI,CAAC,QAAQ,EAAE,OAAO,CAAC,CAAC;oBAE1E,OAAO,GAAG,CAAC,EAAE,CAAC,OAAO,CAAC,EAAE,IAAI,EAAE,CAAC,CAAC;gBACjC,CAAC;gBACD,OAAO,GAAG,CAAC,EAAE,CAAC,QAAQ,CAAC,8BAA8B,IAAI,CAAC,SAAS,CAAC,EAAE,EAAE,CAAC,CAAC;YAC3E,CAAC;SACD,CACD,CAAC;QAEF,IAAI,CAAC,GAAG,CAAC,QAAQ,CAChB,cAAc,EACd,EAAE,YAAY,EAAE,IAAI,EAAE,mBAAmB,EAAE,CAAC,aAAa,CAAC,EAAE,EAC5D;YACC,GAAG;gBACF,MAAM,GAAG,GAAG,OAAO,CAAC,UAAU,CAAC,IAAI,CAAC,SAAS,CAAC,EAAE,CAAC,CAAC;gBAElD,IAAI,GAAG,EAAE,CAAC;oBACT,MAAM,QAAQ,GAAG,MAAM,CAAC,MAAM,CAAC,EAAE,EAAE,GAAG,CAAC,cAAc,EAAE,CAAC,QAAQ,CAAC,CAAC;oBAElE,MAAM,CAAC,IAAI,CAAC,QAAQ,CAAC,CAAC,OAAO,CAAC,CAAC,CAAC,EAAE,EAAE;wBACnC,IAAI,QAAQ,CAAC,CAAC,CAAC,CAAC,MAAM,EAAE,CAAC;4BACxB,OAAO,QAAQ,CAAC,CAAC,CAAC,CAAC;wBACpB,CAAC;oBACF,CAAC,CAAC,CAAC;oBAEH,OAAO,GAAG,CAAC,EAAE,CAAC,OAAO,CAAC,EAAE,QAAQ,EAAE,CAAC,CAAC;gBACrC,CAAC;gBACD,OAAO,GAAG,CAAC,EAAE,CAAC,QAAQ,CAAC,8BAA8B,IAAI,CAAC,SAAS,CAAC,EAAE,EAAE,CAAC,CAAC;YAC3E,CAAC;YACD,KAAK,CAAC,IAAI;gBACT,IAAI,CAAC,IAAI,CAAC,UAAU,EAAE,QAAQ,EAAE,CAAC;oBAChC,OAAO,GAAG,CAAC,EAAE,CAAC,OAAO,CAAC,yCAAyC,CAAC,CAAC;gBAClE,CAAC;gBAED,MAAM,GAAG,GAAG,OAAO,CAAC,UAAU,CAAC,IAAI,CAAC,SAAS,CAAC,EAAE,CAAC,CAAC;gBAElD,IAAI,CAAC,GAAG,EAAE,CAAC;oBACV,OAAO,GAAG,CAAC,EAAE,CAAC,QAAQ,CAAC,8BAA8B,IAAI,CAAC,SAAS,CAAC,EAAE,EAAE,CAAC,CAAC;gBAC3E,CAAC;gBAED,MAAM,EAAE,QAAQ,EAAE,GAAG,GAAG,CAAC,cAAc,EAAE,CAAC;gBAE1C,MAAM,OAAO,GAAG,EAAE,CAAC;gBAEnB,IAAI,KAAK,EAAE,MAAM,CAAC,IAAI,IAAI,CAAC,UAAU,CAAC,QAAQ,EAAE,CAAC;oBAChD,IAAI,QAAQ,CAAC,CAAC,CAAC,EAAE,CAAC,IAAI,QAAQ,CAAC,CAAC,CAAC,EAAE,CAAC,CAAC,KAAK,KAAK,CAAC,CAAC,KAAK,EAAE,CAAC;wBACxD,MAAM,OAAO,CAAC,kBAAkB,EAAE,CAAC,gBAAgB,CAAC,IAAI,CAAC,SAAS,CAAC,EAAE,EAAE,CAAC,CAAC,CAAC;wBAC1E,YAAY;wBACZ,OAAO,CAAC,IAAI,CAAC,CAAC,CAAC,CAAC;oBACjB,CAAC;gBACF,CAAC;gBAED,OAAO,GAAG,CAAC,EAAE,CAAC,OAAO,CAAC,EAAE,OAAO,EAAE,CAAC,CAAC;YACpC,CAAC;SACD,CACD,CAAC;QAEF,IAAI,CAAC,GAAG,CAAC,QAAQ,CAChB,yBAAyB,EACzB,EAAE,YAAY,EAAE,IAAI,EAAE,mBAAmB,EAAE,CAAC,aAAa,CAAC,EAAE,EAC5D;YACC,GAAG;gBACF,IAAI,CAAC;oBACJ,MAAM,OAAO,GAAG,OAAO,CAAC,kBAAkB,EAAE,CAAC,aAAa,CAAC,IAAI,CAAC,SAAS,CAAC,EAAE,EAAE,IAAI,CAAC,SAAS,CAAC,SAAS,CAAC,CAAC;oBAExG,OAAO,GAAG,CAAC,EAAE,CAAC,OAAO,CAAC,EAAE,OAAO,EAAE,CAAC,CAAC;gBACpC,CAAC;gBAAC,OAAO,CAAM,EAAE,CAAC;oBACjB,IAAI,CAAC,CAAC,OAAO,CAAC,QAAQ,CAAC,kBAAkB,CAAC,EAAE,CAAC;wBAC5C,OAAO,GAAG,CAAC,EAAE,CAAC,QAAQ,CAAC,8CAA8C,IAAI,CAAC,SAAS,CAAC,SAAS,GAAG,CAAC,CAAC;oBACnG,CAAC;oBACD,IAAI,CAAC,CAAC,OAAO,CAAC,QAAQ,CAAC,cAAc,CAAC,EAAE,CAAC;wBACxC,OAAO,GAAG,CAAC,EAAE,CAAC,QAAQ,CAAC,8BAA8B,IAAI,CAAC,SAAS,CAAC,EAAE,EAAE,CAAC,CAAC;oBAC3E,CAAC;oBACD,OAAO,GAAG,CAAC,EAAE,CAAC,OAAO,CAAC,CAAC,CAAC,OAAO,CAAC,CAAC;gBAClC,CAAC;YACF,CAAC;YACD,KAAK,CAAC,IAAI;gBACT,IAAI,CAAC,IAAI,CAAC,UAAU,CAAC,OAAO,EAAE,CAAC;oBAC9B,OAAO,GAAG,CAAC,EAAE,CAAC,OAAO,CAAC,0DAA0D,CAAC,CAAC;gBACnF,CAAC;gBAED,IAAI,CAAC;oBACJ,MAAM,OAAO,CAAC,kBAAkB,EAAE,CAAC,gBAAgB,CAAC,IAAI,CAAC,SAAS,CAAC,EAAE,EAAE,IAAI,CAAC,UAAU,CAAC,OAAO,CAAC,CAAC;oBAEhG,OAAO,GAAG,CAAC,EAAE,CAAC,OAAO,EAAE,CAAC;gBACzB,CAAC;gBAAC,OAAO,CAAM,EAAE,CAAC;oBACjB,IAAI,CAAC,CAAC,OAAO,CAAC,QAAQ,CAAC,kBAAkB,CAAC,EAAE,CAAC;wBAC5C,OAAO,GAAG,CAAC,EAAE,CAAC,QAAQ,CAAC,8CAA8C,IAAI,CAAC,SAAS,CAAC,SAAS,GAAG,CAAC,CAAC;oBACnG,CAAC;oBACD,IAAI,CAAC,CAAC,OAAO,CAAC,QAAQ,CAAC,cAAc,CAAC,EAAE,CAAC;wBACxC,OAAO,GAAG,CAAC,EAAE,CAAC,QAAQ,CAAC,8BAA8B,IAAI,CAAC,SAAS,CAAC,EAAE,EAAE,CAAC,CAAC;oBAC3E,CAAC;oBACD,OAAO,GAAG,CAAC,EAAE,CAAC,OAAO,CAAC,CAAC,CAAC,OAAO,CAAC,CAAC;gBAClC,CAAC;YACF,CAAC;SACD,CACD,CAAC;QAEF,IAAI,CAAC,GAAG,CAAC,QAAQ,CAChB,UAAU,EACV,EAAE,YAAY,EAAE,IAAI,EAAE,mBAAmB,EAAE,CAAC,aAAa,CAAC,EAAE,EAC5D;YACC,GAAG;gBACF,MAAM,GAAG,GAAG,OAAO,CAAC,UAAU,CAAC,IAAI,CAAC,SAAS,CAAC,EAAE,CAAC,CAAC;gBAElD,IAAI,GAAG,EAAE,CAAC;oBACT,OAAO,GAAG,CAAC,EAAE,CAAC,OAAO,CAAC;wBACrB,IAAI,EAAG,OAA+B,CAAC,UAAU,CAAC,QAAQ,CAAC,IAAI,CAAC,SAAS,CAAC,EAAE,CAAC,EAAE,iHAAiH;qBAChM,CAAC,CAAC;gBACJ,CAAC;gBACD,OAAO,GAAG,CAAC,EAAE,CAAC,QAAQ,CAAC,8BAA8B,IAAI,CAAC,SAAS,CAAC,EAAE,EAAE,CAAC,CAAC;YAC3E,CAAC;SACD,CACD,CAAC;QAEF,IAAI,CAAC,GAAG,CAAC,QAAQ,CAChB,YAAY,EACZ,EAAE,YAAY,EAAE,IAAI,EAAE,mBAAmB,EAAE,CAAC,aAAa,CAAC,EAAE,EAC5D;YACC,GAAG;gBACF,MAAM,GAAG,GAAG,OAAO,CAAC,UAAU,CAAC,IAAI,CAAC,SAAS,CAAC,EAAE,CAAC,CAAC;gBAElD,IAAI,GAAG,EAAE,CAAC;oBACT,OAAO,GAAG,CAAC,EAAE,CAAC,OAAO,CAAC,EAAE,MAAM,EAAE,GAAG,CAAC,SAAS,EAAE,EAAE,CAAC,CAAC;gBACpD,CAAC;gBACD,OAAO,GAAG,CAAC,EAAE,CAAC,QAAQ,CAAC,8BAA8B,IAAI,CAAC,SAAS,CAAC,EAAE,EAAE,CAAC,CAAC;YAC3E,CAAC;YACD,KAAK,CAAC,IAAI;gBACT,MAAM,EAAE,EAAE,EAAE,KAAK,EAAE,GAAG,IAAI,CAAC,SAAS,CAAC;gBACrC,MAAM,EAAE,MAAM,EAAE,GAAG,IAAI,CAAC,UAAU,CAAC;gBAEnC,IAAI,CAAC,MAAM,IAAI,OAAO,MAAM,KAAK,QAAQ,EAAE,CAAC;oBAC3C,OAAO,GAAG,CAAC,EAAE,CAAC,OAAO,CAAC,kEAAkE,CAAC,CAAC;gBAC3F,CAAC;gBAED,MAAM,GAAG,GAAG,OAAO,CAAC,UAAU,CAAC,KAAK,CAAC,CAAC;gBACtC,IAAI,CAAC,GAAG,EAAE,CAAC;oBACV,OAAO,GAAG,CAAC,EAAE,CAAC,QAAQ,CAAC,8BAA8B,KAAK,EAAE,CAAC,CAAC;gBAC/D,CAAC;gBAED,MAAM,SAAS,GAAG,GAAG,CAAC,cAAc,EAAE,CAAC;gBACvC,MAAM,EAAE,kBAAkB,EAAE,eAAe,EAAE,GAAG,SAAS,CAAC;gBAE1D,IAAI,CAAC,OAAO,CAAC,eAAe,EAAE,IAAI,kBAAkB,KAAK,qBAAqB,CAAC,WAAW,EAAE,CAAC;oBAC5F,IAAI,CAAC;wBACJ,MAAM,OAAO,GAAG,YAAY,CAAC,iBAAiB,EAAY,CAAC;wBAC3D,MAAM,OAAO,GAAG,iBAAiB,EAAE,CAAC;wBACpC,MAAM,EAAE,OAAO,EAAE,GAAG,GAAG,CAAC,OAAO,EAAE,CAAC;wBAElC,MAAM,cAAc,CAAC;4BACpB,OAAO;4BACP,OAAO;4BACP,KAAK;4BACL,OAAO;4BACP,eAAe;4BACf,MAAM;4BACN,MAAM,EAAE,YAAY,CAAC,mBAAmB,EAAE;yBAC1C,CAAC,CAAC;oBACJ,CAAC;oBAAC,OAAO,KAAU,EAAE,CAAC;wBACrB,OAAO,GAAG,CAAC,EAAE,CAAC,OAAO,CAAC,KAAK,CAAC,OAAO,CAAC,CAAC;oBACtC,CAAC;gBACF,CAAC;gBAED,IAAI,cAAc,CAAC,SAAS,CAAC,MAAM,CAAC,IAAI,CAAC,CAAC,MAAM,YAAY,CAAC,SAAS,CAAC,CAAC,EAAE,CAAC;oBAC1E,OAAO,GAAG,CAAC,EAAE,CAAC,OAAO,CAAC,kCAAkC,CAAC,CAAC;gBAC3D,CAAC;gBAED,MAAM,MAAM,GAAG,MAAM,OAAO,CAAC,YAAY,CAAC,GAAG,CAAC,KAAK,EAAE,EAAE,MAAM,CAAC,CAAC;gBAC/D,OAAO,GAAG,CAAC,EAAE,CAAC,OAAO,CAAC,EAAE,MAAM,EAAE,MAAM,CAAC,SAAS,EAAE,EAAE,CAAC,CAAC;YACvD,CAAC;SACD,CACD,CAAC;QAEF,IAAI,CAAC,GAAG,CAAC,QAAQ,CAChB,aAAa,EACb,EAAE,YAAY,EAAE,IAAI,EAAE,EACtB;YACC,KAAK,CAAC,GAAG;gBACR,MAAM,OAAO,GAAG,YAAY,CAAC,iBAAiB,EAAE,CAAC;gBACjD,MAAM,EAAE,KAAK,EAAE,CAAC,GAAG,EAAE,EAAE,IAAI,GAAG,EAAE,EAAE,KAAK,GAAG,EAAE,EAAE,MAAM,GAAG,CAAC,EAAE,GAAG,IAAI,CAAC,WAAW,CAAC;gBAC9E,MAAM,OAAO,GAAG,iBAAiB,EAAE,CAAC;gBAEpC,MAAM,KAAK,GAAG,MAAM,uBAAuB,EAAE,CAAC;gBAC9C,IAAI,KAAK,EAAE,CAAC;oBACX,OAAO,CAAC,aAAa,GAAG,UAAU,KAAK,EAAE,CAAC;gBAC3C,CAAC;gBAED,IAAI,CAAC;oBACJ,MAAM,OAAO,GAAG,MAAM,KAAK,CAAC,GAAG,OAAO,yBAAyB,KAAK,MAAM,CAAC,SAAS,IAAI,UAAU,KAAK,WAAW,MAAM,EAAE,EAAE;wBAC3H,OAAO;qBACP,CAAC,CAAC;oBACH,MAAM,MAAM,GAAG,MAAM,OAAO,CAAC,IAAI,EAAE,CAAC;oBAEpC,IAAI,CAAC,OAAO,CAAC,EAAE,EAAE,CAAC;wBACjB,MAAM,IAAI,KAAK,CAAC,MAAM,CAAC,KAAK,CAAC,CAAC;oBAC/B,CAAC;oBACD,OAAO,GAAG,CAAC,EAAE,CAAC,OAAO,CAAC,MAAM,CAAC,CAAC;gBAC/B,CAAC;gBAAC,OAAO,CAAM,EAAE,CAAC;oBACjB,YAAY,CAAC,mBAAmB,EAAE,CAAC,KAAK,CAAC,+DAA+D,EAAE,CAAC,CAAC,OAAO,CAAC,CAAC;oBAErH,OAAO,GAAG,CAAC,EAAE,CAAC,OAAO,CAAC,CAAC,CAAC,OAAO,CAAC,CAAC;gBAClC,CAAC;YACF,CAAC;SACD,CACD,CAAC;QAEF,IAAI,CAAC,GAAG,CAAC,QAAQ,CAChB,mBAAmB,EACnB,EAAE,YAAY,EAAE,IAAI,EAAE,EACtB;YACC,KAAK,CAAC,GAAG;gBACR,MAAM,OAAO,GAAG,YAAY,CAAC,iBAAiB,EAAE,CAAC;gBACjD,MAAM,OAAO,GAAG,iBAAiB,EAAE,CAAC;gBAEpC,MAAM,KAAK,GAAG,MAAM,uBAAuB,EAAE,CAAC;gBAC9C,IAAI,KAAK,EAAE,CAAC;oBACX,OAAO,CAAC,aAAa,GAAG,UAAU,KAAK,EAAE,CAAC;gBAC3C,CAAC;gBAED,IAAI,CAAC;oBACJ,MAAM,OAAO,GAAG,MAAM,KAAK,CAAC,GAAG,OAAO,uBAAuB,EAAE,EAAE,OAAO,EAAE,CAAC,CAAC;oBAC5E,MAAM,MAAM,GAAG,MAAM,OAAO,CAAC,IAAI,EAAE,CAAC;oBACpC,IAAI,CAAC,OAAO,CAAC,EAAE,EAAE,CAAC;wBACjB,MAAM,IAAI,KAAK,CAAC,MAAM,CAAC,KAAK,CAAC,CAAC;oBAC/B,CAAC;oBACD,OAAO,GAAG,CAAC,EAAE,CAAC,OAAO,CAAC,MAAM,CAAC,CAAC;gBAC/B,CAAC;gBAAC,OAAO,CAAM,EAAE,CAAC;oBACjB,YAAY,CAAC,mBAAmB,EAAE,CAAC,KAAK,CAAC,uDAAuD,EAAE,CAAC,CAAC,OAAO,CAAC,CAAC;oBAE7G,OAAO,GAAG,CAAC,EAAE,CAAC,OAAO,CAAC,CAAC,CAAC,OAAO,CAAC,CAAC;gBAClC,CAAC;YACF,CAAC;SACD,CACD,CAAC;QAEF,IAAI,CAAC,GAAG,CAAC,QAAQ,CAChB,wBAAwB,EACxB,EAAE,YAAY,EAAE,IAAI,EAAE,EACtB;YACC,KAAK,CAAC,IAAI;gBACT,MAAM,OAAO,GAAG,YAAY,CAAC,iBAAiB,EAAE,CAAC;gBACjD,MAAM,OAAO,GAAG,iBAAiB,EAAE,CAAC;gBAEpC,MAAM,KAAK,GAAG,MAAM,uBAAuB,EAAE,CAAC;gBAC9C,IAAI,KAAK,EAAE,CAAC;oBACX,OAAO,CAAC,aAAa,GAAG,UAAU,KAAK,EAAE,CAAC;gBAC3C,CAAC;gBAED,MAAM,EAAE,cAAc,EAAE,GAAG,IAAI,CAAC,UAAU,CAAC;gBAE3C,IAAI,CAAC;oBACJ,MAAM,OAAO,GAAG,MAAM,KAAK,CAAC,GAAG,OAAO,4BAA4B,EAAE;wBACnE,MAAM,EAAE,MAAM;wBACd,OAAO;wBACP,IAAI,EAAE,EAAE,GAAG,EAAE,cAAc,EAAE;qBAC7B,CAAC,CAAC;oBACH,MAAM,MAAM,GAAG,MAAM,OAAO,CAAC,IAAI,EAAE,CAAC;oBAEpC,IAAI,CAAC,OAAO,CAAC,EAAE,EAAE,CAAC;wBACjB,MAAM,IAAI,KAAK,CAAC,MAAM,CAAC,KAAK,CAAC,CAAC;oBAC/B,CAAC;oBAED,OAAO,GAAG,CAAC,EAAE,CAAC,OAAO,CAAC,MAAM,CAAC,CAAC;gBAC/B,CAAC;gBAAC,OAAO,CAAM,EAAE,CAAC;oBACjB,YAAY,CAAC,mBAAmB,EAAE,CAAC,KAAK,CAAC,oCAAoC,EAAE,CAAC,CAAC,OAAO,CAAC,CAAC;oBAE1F,OAAO,GAAG,CAAC,EAAE,CAAC,OAAO,CAAC,CAAC,CAAC,OAAO,CAAC,CAAC;gBAClC,CAAC;YACF,CAAC;SACD,CACD,CAAC;IACH,CAAC;CACD","sourcesContent":["import { AppStatus, AppStatusUtils } from '@rocket.chat/apps-engine/definition/AppStatus';\nimport type { IAppInfo } from '@rocket.chat/apps-engine/definition/metadata';\nimport type { AppManager } from '@rocket.chat/apps-engine/server/AppManager';\nimport { AppInstallationSource } from '@rocket.chat/apps-engine/server/storage';\nimport type { IUser, IMessage } from '@rocket.chat/core-typings';\nimport { License } from '@rocket.chat/license';\nimport { Settings, Users } from '@rocket.chat/models';\nimport { serverFetch as fetch } from '@rocket.chat/server-fetch';\nimport { Meteor } from 'meteor/meteor';\n\nimport type { APIClass } from '../../../../app/api/server';\nimport { API } from '../../../../app/api/server';\nimport { getPaginationItems } from '../../../../app/api/server/helpers/getPaginationItems';\nimport { getUploadFormData } from '../../../../app/api/server/lib/getUploadFormData';\nimport { getWorkspaceAccessToken, getWorkspaceAccessTokenWithScope } from '../../../../app/cloud/server';\nimport { apiDeprecationLogger } from '../../../../app/lib/server/lib/deprecationWarningLogger';\nimport { settings } from '../../../../app/settings/server';\nimport { Info } from '../../../../app/utils/rocketchat.info';\nimport { i18n } from '../../../../server/lib/i18n';\nimport { sendMessagesToAdmins } from '../../../../server/lib/sendMessagesToAdmins';\nimport { canEnableApp } from '../../../app/license/server/canEnableApp';\nimport { formatAppInstanceForRest } from '../../../lib/misc/formatAppInstanceForRest';\nimport { appEnableCheck } from '../marketplace/appEnableCheck';\nimport { notifyAppInstall } from '../marketplace/appInstall';\nimport type { AppServerOrchestrator } from '../orchestrator';\nimport { Apps } from '../orchestrator';\nimport { actionButtonsHandler } from './endpoints/actionButtonsHandler';\nimport { appsCountHandler } from './endpoints/appsCountHandler';\n\nconst rocketChatVersion = Info.version;\nconst appsEngineVersionForMarketplace = Info.marketplaceApiVersion.replace(/-.*/g, '');\nconst getDefaultHeaders = (): Record<string, any> => ({\n\t'X-Apps-Engine-Version': appsEngineVersionForMarketplace,\n});\n\nconst purchaseTypes = new Set(['buy', 'subscription']);\n\nexport class AppsRestApi {\n\tpublic api: APIClass<'/apps'>;\n\n\tpublic _orch: AppServerOrchestrator;\n\n\tpublic _manager: AppManager;\n\n\tconstructor(orch: AppServerOrchestrator, manager: AppManager) {\n\t\tthis._orch = orch;\n\t\tthis._manager = manager;\n\t\tvoid this.loadAPI();\n\t}\n\n\tasync loadAPI() {\n\t\tthis.api = new API.ApiClass({\n\t\t\tversion: 'apps',\n\t\t\tuseDefaultAuth: true,\n\t\t\tprettyJson: false,\n\t\t\tenableCors: false,\n\t\t\tauth: API.getUserAuth(),\n\t\t});\n\t\tthis.addManagementRoutes();\n\t}\n\n\taddManagementRoutes() {\n\t\tconst orchestrator = this._orch;\n\t\tconst manager = this._manager;\n\n\t\tconst handleError = (message: string, e: any) => {\n\t\t\t// when there is no `response` field in the error, it means the request\n\t\t\t// couldn't even make it to the server\n\t\t\tif (!e.hasOwnProperty('response')) {\n\t\t\t\torchestrator.getRocketChatLogger().warn(message, e.message);\n\t\t\t\treturn API.v1.internalError('Could not reach the Marketplace');\n\t\t\t}\n\n\t\t\torchestrator.getRocketChatLogger().error(message, e.response.data);\n\n\t\t\tif (e.response.statusCode >= 500 && e.response.statusCode <= 599) {\n\t\t\t\treturn API.v1.internalError();\n\t\t\t}\n\n\t\t\tif (e.response.statusCode === 404) {\n\t\t\t\treturn API.v1.notFound();\n\t\t\t}\n\n\t\t\treturn API.v1.failure();\n\t\t};\n\n\t\tthis.api.addRoute('actionButtons', ...actionButtonsHandler(this));\n\t\tthis.api.addRoute('count', ...appsCountHandler(this));\n\n\t\tthis.api.addRoute(\n\t\t\t'incompatibleModal',\n\t\t\t{ authRequired: true },\n\t\t\t{\n\t\t\t\tasync get() {\n\t\t\t\t\tconst baseUrl = orchestrator.getMarketplaceUrl();\n\t\t\t\t\tconst workspaceId = settings.get('Cloud_Workspace_Id');\n\t\t\t\t\tconst { action, appId, appVersion } = this.queryParams;\n\n\t\t\t\t\treturn API.v1.success({\n\t\t\t\t\t\turl: `${baseUrl}/apps/${appId}/incompatible/${appVersion}/${action}?workspaceId=${workspaceId}&rocketChatVersion=${rocketChatVersion}`,\n\t\t\t\t\t});\n\t\t\t\t},\n\t\t\t},\n\t\t);\n\n\t\tthis.api.addRoute(\n\t\t\t'marketplace',\n\t\t\t{ authRequired: true },\n\t\t\t{\n\t\t\t\tasync get() {\n\t\t\t\t\tconst baseUrl = orchestrator.getMarketplaceUrl();\n\n\t\t\t\t\t// Gets the Apps from the marketplace\n\t\t\t\t\tconst headers = getDefaultHeaders();\n\t\t\t\t\tconst token = await getWorkspaceAccessToken();\n\t\t\t\t\tif (token) {\n\t\t\t\t\t\theaders.Authorization = `Bearer ${token}`;\n\t\t\t\t\t}\n\n\t\t\t\t\tlet result;\n\t\t\t\t\ttry {\n\t\t\t\t\t\tconst request = await fetch(`${baseUrl}/v1/apps`, {\n\t\t\t\t\t\t\theaders,\n\t\t\t\t\t\t\tparams: {\n\t\t\t\t\t\t\t\t...(this.queryParams.isAdminUser === 'false' && { endUserID: this.user._id }),\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t});\n\n\t\t\t\t\t\tif (request.status === 426) {\n\t\t\t\t\t\t\torchestrator.getRocketChatLogger().error('Workspace out of support window:', await request.json());\n\t\t\t\t\t\t\treturn API.v1.failure({ error: 'unsupported version' });\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tif (request.status !== 200) {\n\t\t\t\t\t\t\torchestrator.getRocketChatLogger().error('Error getting the Apps:', await request.json());\n\t\t\t\t\t\t\treturn API.v1.failure();\n\t\t\t\t\t\t}\n\t\t\t\t\t\tresult = await request.json();\n\n\t\t\t\t\t\tif (!request.ok) {\n\t\t\t\t\t\t\tthrow new Error(result.error);\n\t\t\t\t\t\t}\n\t\t\t\t\t} catch (e) {\n\t\t\t\t\t\treturn handleError('Unable to access Marketplace. Does the server has access to the internet?', e);\n\t\t\t\t\t}\n\n\t\t\t\t\treturn API.v1.success(result);\n\t\t\t\t},\n\t\t\t},\n\t\t);\n\n\t\tthis.api.addRoute(\n\t\t\t'categories',\n\t\t\t{ authRequired: true },\n\t\t\t{\n\t\t\t\tasync get() {\n\t\t\t\t\tconst baseUrl = orchestrator.getMarketplaceUrl();\n\n\t\t\t\t\tconst headers = getDefaultHeaders();\n\t\t\t\t\tconst token = await getWorkspaceAccessToken();\n\t\t\t\t\tif (token) {\n\t\t\t\t\t\theaders.Authorization = `Bearer ${token}`;\n\t\t\t\t\t}\n\n\t\t\t\t\tlet result;\n\t\t\t\t\ttry {\n\t\t\t\t\t\tconst request = await fetch(`${baseUrl}/v1/categories`, { headers });\n\t\t\t\t\t\tif (request.status !== 200) {\n\t\t\t\t\t\t\torchestrator.getRocketChatLogger().error('Error getting the Apps:', await request.json());\n\t\t\t\t\t\t\treturn API.v1.failure();\n\t\t\t\t\t\t}\n\t\t\t\t\t\tresult = await request.json();\n\t\t\t\t\t} catch (e: any) {\n\t\t\t\t\t\treturn handleError('Unable to access Marketplace. Does the server has access to the internet?', e);\n\t\t\t\t\t}\n\n\t\t\t\t\treturn API.v1.success(result);\n\t\t\t\t},\n\t\t\t},\n\t\t);\n\n\t\tthis.api.addRoute(\n\t\t\t'buildExternalUrl',\n\t\t\t{ authRequired: true },\n\t\t\t{\n\t\t\t\tasync get() {\n\t\t\t\t\tconst baseUrl = orchestrator.getMarketplaceUrl();\n\n\t\t\t\t\tconst workspaceId = settings.get('Cloud_Workspace_Id');\n\n\t\t\t\t\tif (!this.queryParams.purchaseType || !purchaseTypes.has(this.queryParams.purchaseType)) {\n\t\t\t\t\t\treturn API.v1.failure({ error: 'Invalid purchase type' });\n\t\t\t\t\t}\n\n\t\t\t\t\tconst response = await getWorkspaceAccessTokenWithScope('marketplace:purchase');\n\t\t\t\t\tif (!response.token) {\n\t\t\t\t\t\treturn API.v1.failure({ error: 'Unauthorized' });\n\t\t\t\t\t}\n\n\t\t\t\t\tconst subscribeRoute = this.queryParams.details === 'true' ? 'subscribe/details' : 'subscribe';\n\n\t\t\t\t\tconst seats = await Users.getActiveLocalUserCount();\n\n\t\t\t\t\treturn API.v1.success({\n\t\t\t\t\t\turl: `${baseUrl}/apps/${this.queryParams.appId}/${\n\t\t\t\t\t\t\tthis.queryParams.purchaseType === 'buy' ? this.queryParams.purchaseType : subscribeRoute\n\t\t\t\t\t\t}?workspaceId=${workspaceId}&token=${response.token}&seats=${seats}`,\n\t\t\t\t\t});\n\t\t\t\t},\n\t\t\t},\n\t\t);\n\n\t\tthis.api.addRoute(\n\t\t\t'installed',\n\t\t\t{ authRequired: true },\n\t\t\t{\n\t\t\t\tasync get() {\n\t\t\t\t\tconst apps = await manager.get();\n\t\t\t\t\tconst formatted = await Promise.all(apps.map(formatAppInstanceForRest));\n\t\t\t\t\treturn API.v1.success({ apps: formatted });\n\t\t\t\t},\n\t\t\t},\n\t\t);\n\n\t\t// WE NEED TO MOVE EACH ENDPOINT HANDLER TO IT'S OWN FILE\n\t\tthis.api.addRoute(\n\t\t\t'',\n\t\t\t{ authRequired: true, permissionsRequired: ['manage-apps'] },\n\t\t\t{\n\t\t\t\tasync get() {\n\t\t\t\t\tconst baseUrl = orchestrator.getMarketplaceUrl();\n\n\t\t\t\t\t// Gets the Apps from the marketplace\n\t\t\t\t\tif ('marketplace' in this.queryParams && this.queryParams.marketplace) {\n\t\t\t\t\t\tapiDeprecationLogger.endpoint(this.request.route, '7.0.0', this.response, 'Use /apps/marketplace to get the apps list.');\n\n\t\t\t\t\t\tconst headers = getDefaultHeaders();\n\t\t\t\t\t\tconst token = await getWorkspaceAccessToken();\n\t\t\t\t\t\tif (token) {\n\t\t\t\t\t\t\theaders.Authorization = `Bearer ${token}`;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tlet result;\n\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\tconst request = await fetch(`${baseUrl}/v1/apps`, { headers });\n\t\t\t\t\t\t\tif (request.status !== 200) {\n\t\t\t\t\t\t\t\torchestrator.getRocketChatLogger().error('Error getting the Apps:', await request.json());\n\t\t\t\t\t\t\t\treturn API.v1.failure();\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tresult = await request.json();\n\t\t\t\t\t\t} catch (e) {\n\t\t\t\t\t\t\treturn handleError('Unable to access Marketplace. Does the server has access to the internet?', e);\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\treturn API.v1.success(result);\n\t\t\t\t\t}\n\n\t\t\t\t\tif ('categories' in this.queryParams && this.queryParams.categories) {\n\t\t\t\t\t\tapiDeprecationLogger.endpoint(this.request.route, '7.0.0', this.response, 'Use /apps/categories to get the categories list.');\n\t\t\t\t\t\tconst headers = getDefaultHeaders();\n\t\t\t\t\t\tconst token = await getWorkspaceAccessToken();\n\t\t\t\t\t\tif (token) {\n\t\t\t\t\t\t\theaders.Authorization = `Bearer ${token}`;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tlet result;\n\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\tconst request = await fetch(`${baseUrl}/v1/categories`, { headers });\n\t\t\t\t\t\t\tif (request.status !== 200) {\n\t\t\t\t\t\t\t\torchestrator.getRocketChatLogger().error('Error getting the Apps:', await request.json());\n\t\t\t\t\t\t\t\treturn API.v1.failure();\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tresult = await request.json();\n\t\t\t\t\t\t} catch (e: any) {\n\t\t\t\t\t\t\torchestrator.getRocketChatLogger().error('Error getting the categories from the Marketplace:', e);\n\t\t\t\t\t\t\treturn API.v1.internalError();\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\treturn API.v1.success(result);\n\t\t\t\t\t}\n\n\t\t\t\t\tif (\n\t\t\t\t\t\t'buildExternalUrl' in this.queryParams &&\n\t\t\t\t\t\t'appId' in this.queryParams &&\n\t\t\t\t\t\tthis.queryParams.buildExternalUrl &&\n\t\t\t\t\t\tthis.queryParams.appId\n\t\t\t\t\t) {\n\t\t\t\t\t\tapiDeprecationLogger.endpoint(this.request.route, '7.0.0', this.response, 'Use /apps/buildExternalUrl to get the modal URLs.');\n\t\t\t\t\t\tconst workspaceId = settings.get('Cloud_Workspace_Id');\n\n\t\t\t\t\t\tif (!this.queryParams.purchaseType || !purchaseTypes.has(this.queryParams.purchaseType)) {\n\t\t\t\t\t\t\treturn API.v1.failure({ error: 'Invalid purchase type' });\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tconst token = await getWorkspaceAccessTokenWithScope('marketplace:purchase');\n\t\t\t\t\t\tif (!token) {\n\t\t\t\t\t\t\treturn API.v1.failure({ error: 'Unauthorized' });\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tconst subscribeRoute = this.queryParams.details === 'true' ? 'subscribe/details' : 'subscribe';\n\n\t\t\t\t\t\tconst seats = await Users.getActiveLocalUserCount();\n\n\t\t\t\t\t\treturn API.v1.success({\n\t\t\t\t\t\t\turl: `${baseUrl}/apps/${this.queryParams.appId}/${\n\t\t\t\t\t\t\t\tthis.queryParams.purchaseType === 'buy' ? this.queryParams.purchaseType : subscribeRoute\n\t\t\t\t\t\t\t}?workspaceId=${workspaceId}&token=${token.token}&seats=${seats}`,\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t\tapiDeprecationLogger.endpoint(this.request.route, '7.0.0', this.response, 'Use /apps/installed to get the installed apps list.');\n\n\t\t\t\t\tconst proxiedApps = await manager.get();\n\t\t\t\t\tconst apps = await Promise.all(proxiedApps.map(formatAppInstanceForRest));\n\n\t\t\t\t\treturn API.v1.success({ apps });\n\t\t\t\t},\n\t\t\t\tasync post() {\n\t\t\t\t\tlet buff;\n\t\t\t\t\tlet marketplaceInfo;\n\t\t\t\t\tlet permissionsGranted;\n\n\t\t\t\t\tif (this.bodyParams.url) {\n\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\tconst response = await fetch(this.bodyParams.url);\n\n\t\t\t\t\t\t\tif (response.status !== 200 || response.headers.get('content-type') !== 'application/zip') {\n\t\t\t\t\t\t\t\treturn API.v1.failure({\n\t\t\t\t\t\t\t\t\terror: 'Invalid url. It doesn\\'t exist or is not \"application/zip\".',\n\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\tbuff = await response.buffer();\n\t\t\t\t\t\t} catch (e: any) {\n\t\t\t\t\t\t\torchestrator.getRocketChatLogger().error('Error getting the app from url:', e.response.data);\n\t\t\t\t\t\t\treturn API.v1.internalError();\n\t\t\t\t\t\t}\n\t\t\t\t\t} else if ('appId' in this.bodyParams && this.bodyParams.appId && this.bodyParams.marketplace && this.bodyParams.version) {\n\t\t\t\t\t\tconst baseUrl = orchestrator.getMarketplaceUrl();\n\n\t\t\t\t\t\tconst headers = getDefaultHeaders();\n\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\tconst downloadToken = await getWorkspaceAccessToken(true, 'marketplace:download', false);\n\t\t\t\t\t\t\tconst marketplaceToken = await getWorkspaceAccessToken();\n\n\t\t\t\t\t\t\tconst [downloadResponse, marketplaceResponse] = await Promise.all([\n\t\t\t\t\t\t\t\tfetch(`${baseUrl}/v2/apps/${this.bodyParams.appId}/download/${this.bodyParams.version}?token=${downloadToken}`, {\n\t\t\t\t\t\t\t\t\theaders,\n\t\t\t\t\t\t\t\t}),\n\t\t\t\t\t\t\t\tfetch(`${baseUrl}/v1/apps/${this.bodyParams.appId}?appVersion=${this.bodyParams.version}`, {\n\t\t\t\t\t\t\t\t\theaders: {\n\t\t\t\t\t\t\t\t\t\tAuthorization: `Bearer ${marketplaceToken}`,\n\t\t\t\t\t\t\t\t\t\t...headers,\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t}),\n\t\t\t\t\t\t\t]);\n\n\t\t\t\t\t\t\tif (downloadResponse.headers.get('content-type') !== 'application/zip') {\n\t\t\t\t\t\t\t\tthrow new Error('Invalid url. It doesn\\'t exist or is not \"application/zip\".');\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\tbuff = Buffer.from(await downloadResponse.arrayBuffer());\n\t\t\t\t\t\t\tmarketplaceInfo = (await marketplaceResponse.json()) as any;\n\t\t\t\t\t\t\tpermissionsGranted = this.bodyParams.permissionsGranted;\n\t\t\t\t\t\t} catch (err: any) {\n\t\t\t\t\t\t\treturn API.v1.failure(err.message);\n\t\t\t\t\t\t}\n\t\t\t\t\t} else {\n\t\t\t\t\t\tconst app = await getUploadFormData(\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\trequest: this.request,\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t{ field: 'app', sizeLimit: settings.get('FileUpload_MaxFileSize') },\n\t\t\t\t\t\t);\n\n\t\t\t\t\t\tconst { fields: formData } = app;\n\n\t\t\t\t\t\tbuff = app.fileBuffer;\n\t\t\t\t\t\tpermissionsGranted = (() => {\n\t\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\t\tconst permissions = JSON.parse(formData?.permissions || '');\n\t\t\t\t\t\t\t\treturn permissions.length ? permissions : undefined;\n\t\t\t\t\t\t\t} catch {\n\t\t\t\t\t\t\t\treturn undefined;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t})();\n\t\t\t\t\t}\n\n\t\t\t\t\tif (!buff) {\n\t\t\t\t\t\treturn API.v1.failure({ error: 'Failed to get a file to install for the App. ' });\n\t\t\t\t\t}\n\n\t\t\t\t\t// Used mostly in Cloud hosting for security reasons\n\t\t\t\t\tif (!marketplaceInfo && orchestrator.shouldDisablePrivateAppInstallation()) {\n\t\t\t\t\t\treturn API.v1.internalError('private_app_install_disabled');\n\t\t\t\t\t}\n\n\t\t\t\t\tconst user = orchestrator\n\t\t\t\t\t\t?.getConverters()\n\t\t\t\t\t\t?.get('users')\n\t\t\t\t\t\t?.convertToApp(await Meteor.userAsync());\n\n\t\t\t\t\tconst aff = await manager.add(buff, { marketplaceInfo, permissionsGranted, enable: false, user });\n\t\t\t\t\tconst info: IAppInfo & { status?: AppStatus } = aff.getAppInfo();\n\n\t\t\t\t\tif (aff.hasStorageError()) {\n\t\t\t\t\t\treturn API.v1.failure({ status: 'storage_error', messages: [aff.getStorageError()] });\n\t\t\t\t\t}\n\n\t\t\t\t\tif (aff.hasAppUserError()) {\n\t\t\t\t\t\treturn API.v1.failure({\n\t\t\t\t\t\t\tstatus: 'app_user_error',\n\t\t\t\t\t\t\tmessages: [(aff.getAppUserError() as Record<string, any>).message],\n\t\t\t\t\t\t\tpayload: { username: (aff.getAppUserError() as Record<string, any>).username },\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\n\t\t\t\t\tinfo.status = await aff.getApp().getStatus();\n\n\t\t\t\t\tvoid notifyAppInstall(orchestrator.getMarketplaceUrl() as string, 'install', info);\n\n\t\t\t\t\tif (await canEnableApp(aff.getApp().getStorageItem())) {\n\t\t\t\t\t\tconst success = await manager.enable(info.id);\n\t\t\t\t\t\tinfo.status = success ? AppStatus.AUTO_ENABLED : info.status;\n\t\t\t\t\t}\n\n\t\t\t\t\tvoid orchestrator.getNotifier().appAdded(info.id);\n\n\t\t\t\t\treturn API.v1.success({\n\t\t\t\t\t\tapp: info,\n\t\t\t\t\t\timplemented: aff.getImplementedInferfaces(),\n\t\t\t\t\t\tlicenseValidation: aff.getLicenseValidationResult(),\n\t\t\t\t\t});\n\t\t\t\t},\n\t\t\t},\n\t\t);\n\n\t\tthis.api.addRoute(\n\t\t\t'buildExternalAppRequest',\n\t\t\t{ authRequired: true },\n\t\t\t{\n\t\t\t\tasync get() {\n\t\t\t\t\tif (!this.queryParams.appId) {\n\t\t\t\t\t\treturn API.v1.failure({ error: 'Invalid request. Please ensure an appId is attached to the request.' });\n\t\t\t\t\t}\n\n\t\t\t\t\tconst baseUrl = orchestrator.getMarketplaceUrl();\n\t\t\t\t\tconst workspaceId = settings.get<string>('Cloud_Workspace_Id');\n\n\t\t\t\t\tconst requester = {\n\t\t\t\t\t\tid: this.user._id,\n\t\t\t\t\t\tusername: this.user.username,\n\t\t\t\t\t\tname: this.user.name,\n\t\t\t\t\t\tnickname: this.user.nickname,\n\t\t\t\t\t\temails: this.user?.emails?.map((e) => e.address),\n\t\t\t\t\t};\n\n\t\t\t\t\tlet admins: {\n\t\t\t\t\t\tid: string;\n\t\t\t\t\t\tusername?: string;\n\t\t\t\t\t\tname?: string;\n\t\t\t\t\t\tnickname?: string;\n\t\t\t\t\t}[] = [];\n\t\t\t\t\ttry {\n\t\t\t\t\t\tconst adminsRaw = await Users.findUsersInRoles(['admin'], undefined, {\n\t\t\t\t\t\t\tprojection: {\n\t\t\t\t\t\t\t\tusername: 1,\n\t\t\t\t\t\t\t\tname: 1,\n\t\t\t\t\t\t\t\tnickname: 1,\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t}).toArray();\n\n\t\t\t\t\t\tadmins = adminsRaw.map((a) => {\n\t\t\t\t\t\t\treturn {\n\t\t\t\t\t\t\t\tid: a._id,\n\t\t\t\t\t\t\t\tusername: a.username,\n\t\t\t\t\t\t\t\tname: a.name,\n\t\t\t\t\t\t\t\tnickname: a.nickname,\n\t\t\t\t\t\t\t};\n\t\t\t\t\t\t});\n\t\t\t\t\t} catch (e) {\n\t\t\t\t\t\torchestrator.getRocketChatLogger().error('Error getting the admins to request an app be installed:', e);\n\t\t\t\t\t}\n\n\t\t\t\t\tconst queryParams = new URLSearchParams();\n\t\t\t\t\tqueryParams.set('workspaceId', workspaceId);\n\t\t\t\t\tqueryParams.set('frameworkVersion', appsEngineVersionForMarketplace);\n\t\t\t\t\tqueryParams.set('requester', Buffer.from(JSON.stringify(requester)).toString('base64'));\n\t\t\t\t\tqueryParams.set('admins', Buffer.from(JSON.stringify(admins)).toString('base64'));\n\n\t\t\t\t\treturn API.v1.success({\n\t\t\t\t\t\turl: `${baseUrl}/apps/${this.queryParams.appId}/requestAccess?${queryParams.toString()}`,\n\t\t\t\t\t});\n\t\t\t\t},\n\t\t\t},\n\t\t);\n\n\t\tthis.api.addRoute(\n\t\t\t'externalComponents',\n\t\t\t{ authRequired: false },\n\t\t\t{\n\t\t\t\tget() {\n\t\t\t\t\tconst externalComponents = orchestrator.getProvidedComponents();\n\n\t\t\t\t\treturn API.v1.success({ externalComponents });\n\t\t\t\t},\n\t\t\t},\n\t\t);\n\n\t\tthis.api.addRoute(\n\t\t\t'languages',\n\t\t\t{ authRequired: false },\n\t\t\t{\n\t\t\t\tasync get() {\n\t\t\t\t\tconst apps = (await manager.get()).map((prl) => ({\n\t\t\t\t\t\tid: prl.getID(),\n\t\t\t\t\t\tlanguages: prl.getStorageItem().languageContent,\n\t\t\t\t\t}));\n\n\t\t\t\t\treturn API.v1.success({ apps });\n\t\t\t\t},\n\t\t\t},\n\t\t);\n\n\t\tthis.api.addRoute(\n\t\t\t'externalComponentEvent',\n\t\t\t{ authRequired: true },\n\t\t\t{\n\t\t\t\tpost() {\n\t\t\t\t\tif (\n\t\t\t\t\t\t!this.bodyParams.externalComponent ||\n\t\t\t\t\t\t!this.bodyParams.event ||\n\t\t\t\t\t\t!['IPostExternalComponentOpened', 'IPostExternalComponentClosed'].includes(this.bodyParams.event)\n\t\t\t\t\t) {\n\t\t\t\t\t\treturn API.v1.failure({ error: 'Event and externalComponent must be provided.' });\n\t\t\t\t\t}\n\n\t\t\t\t\ttry {\n\t\t\t\t\t\tconst { event, externalComponent } = this.bodyParams;\n\t\t\t\t\t\tconst result = (Apps.getBridges()?.getListenerBridge() as Record<string, any>).externalComponentEvent(event, externalComponent);\n\n\t\t\t\t\t\treturn API.v1.success({ result });\n\t\t\t\t\t} catch (e: any) {\n\t\t\t\t\t\torchestrator.getRocketChatLogger().error(`Error triggering external components' events ${e.response.data}`);\n\t\t\t\t\t\treturn API.v1.internalError();\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t},\n\t\t);\n\n\t\tthis.api.addRoute(\n\t\t\t'bundles/:id/apps',\n\t\t\t{ authRequired: true, permissionsRequired: ['manage-apps'] },\n\t\t\t{\n\t\t\t\tasync get() {\n\t\t\t\t\tconst baseUrl = orchestrator.getMarketplaceUrl();\n\n\t\t\t\t\tconst headers: Record<string, any> = {};\n\t\t\t\t\tconst token = await getWorkspaceAccessToken();\n\t\t\t\t\tif (token) {\n\t\t\t\t\t\theaders.Authorization = `Bearer ${token}`;\n\t\t\t\t\t}\n\n\t\t\t\t\tlet result;\n\t\t\t\t\ttry {\n\t\t\t\t\t\tconst request = await fetch(`${baseUrl}/v1/bundles/${this.urlParams.id}/apps`, { headers });\n\t\t\t\t\t\tif (request.status !== 200) {\n\t\t\t\t\t\t\torchestrator.getRocketChatLogger().error(\"Error getting the Bundle's Apps from the Marketplace:\", await request.json());\n\t\t\t\t\t\t\treturn API.v1.failure();\n\t\t\t\t\t\t}\n\t\t\t\t\t\tresult = await request.json();\n\t\t\t\t\t} catch (e: any) {\n\t\t\t\t\t\torchestrator.getRocketChatLogger().error(\"Error getting the Bundle's Apps from the Marketplace:\", e.response.data);\n\t\t\t\t\t\treturn API.v1.internalError();\n\t\t\t\t\t}\n\n\t\t\t\t\treturn API.v1.success({ apps: result });\n\t\t\t\t},\n\t\t\t},\n\t\t);\n\n\t\tthis.api.addRoute(\n\t\t\t'featured-apps',\n\t\t\t{ authRequired: true },\n\t\t\t{\n\t\t\t\tasync get() {\n\t\t\t\t\tconst baseUrl = orchestrator.getMarketplaceUrl();\n\n\t\t\t\t\tconst headers = getDefaultHeaders();\n\t\t\t\t\tconst token = await getWorkspaceAccessToken();\n\t\t\t\t\tif (token) {\n\t\t\t\t\t\theaders.Authorization = `Bearer ${token}`;\n\t\t\t\t\t}\n\n\t\t\t\t\tlet result;\n\t\t\t\t\ttry {\n\t\t\t\t\t\tconst request = await fetch(`${baseUrl}/v1/featured-apps`, { headers });\n\t\t\t\t\t\tif (request.status !== 200) {\n\t\t\t\t\t\t\torchestrator.getRocketChatLogger().error('Error getting the Featured Apps from the Marketplace:', await request.json());\n\t\t\t\t\t\t\treturn API.v1.failure();\n\t\t\t\t\t\t}\n\t\t\t\t\t\tresult = await request.json();\n\t\t\t\t\t} catch (e) {\n\t\t\t\t\t\treturn handleError('Unable to access Marketplace. Does the server has access to the internet?', e);\n\t\t\t\t\t}\n\n\t\t\t\t\treturn API.v1.success(result);\n\t\t\t\t},\n\t\t\t},\n\t\t);\n\n\t\tthis.api.addRoute(\n\t\t\t':id',\n\t\t\t{ authRequired: true, permissionsRequired: ['manage-apps'] },\n\t\t\t{\n\t\t\t\tasync get() {\n\t\t\t\t\tif (this.queryParams.marketplace && this.queryParams.version) {\n\t\t\t\t\t\tconst baseUrl = orchestrator.getMarketplaceUrl();\n\n\t\t\t\t\t\tconst headers: Record<string, any> = {}; // DO NOT ATTACH THE FRAMEWORK/ENGINE VERSION HERE.\n\t\t\t\t\t\tconst token = await getWorkspaceAccessToken();\n\t\t\t\t\t\tif (token) {\n\t\t\t\t\t\t\theaders.Authorization = `Bearer ${token}`;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tlet result: any;\n\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\tconst request = await fetch(`${baseUrl}/v1/apps/${this.urlParams.id}?appVersion=${this.queryParams.version}`, { headers });\n\t\t\t\t\t\t\tif (request.status !== 200) {\n\t\t\t\t\t\t\t\torchestrator.getRocketChatLogger().error('Error getting the App information from the Marketplace:', await request.json());\n\t\t\t\t\t\t\t\treturn API.v1.failure();\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tresult = await request.json();\n\t\t\t\t\t\t} catch (e) {\n\t\t\t\t\t\t\treturn handleError('Unable to access Marketplace. Does the server has access to the internet?', e);\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\treturn API.v1.success({ app: result[0] });\n\t\t\t\t\t}\n\n\t\t\t\t\tif (this.queryParams.marketplace && this.queryParams.update && this.queryParams.appVersion) {\n\t\t\t\t\t\tconst baseUrl = orchestrator.getMarketplaceUrl();\n\n\t\t\t\t\t\tconst headers = getDefaultHeaders();\n\t\t\t\t\t\tconst token = await getWorkspaceAccessToken();\n\t\t\t\t\t\tif (token) {\n\t\t\t\t\t\t\theaders.Authorization = `Bearer ${token}`;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tlet result;\n\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\tconst request = await fetch(`${baseUrl}/v1/apps/${this.urlParams.id}/latest?appVersion=${this.queryParams.appVersion}`, {\n\t\t\t\t\t\t\t\theaders,\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\tif (request.status !== 200) {\n\t\t\t\t\t\t\t\torchestrator.getRocketChatLogger().error('Error getting the App update info from the Marketplace:', await request.json());\n\t\t\t\t\t\t\t\treturn API.v1.failure();\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tresult = await request.json();\n\t\t\t\t\t\t} catch (e) {\n\t\t\t\t\t\t\treturn handleError('Unable to access Marketplace. Does the server has access to the internet?', e);\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\treturn API.v1.success({ app: result });\n\t\t\t\t\t}\n\t\t\t\t\tconst app = manager.getOneById(this.urlParams.id);\n\t\t\t\t\tif (!app) {\n\t\t\t\t\t\treturn API.v1.notFound(`No App found by the id of: ${this.urlParams.id}`);\n\t\t\t\t\t}\n\n\t\t\t\t\treturn API.v1.success({\n\t\t\t\t\t\tapp: formatAppInstanceForRest(app),\n\t\t\t\t\t});\n\t\t\t\t},\n\t\t\t\tasync post() {\n\t\t\t\t\tlet buff;\n\t\t\t\t\tlet permissionsGranted;\n\t\t\t\t\tlet isPrivateAppUpload = false;\n\n\t\t\t\t\tif (this.bodyParams.url) {\n\t\t\t\t\t\tconst response = await fetch(this.bodyParams.url);\n\n\t\t\t\t\t\tif (response.status !== 200 || response.headers.get('content-type') !== 'application/zip') {\n\t\t\t\t\t\t\treturn API.v1.failure({\n\t\t\t\t\t\t\t\terror: 'Invalid url. It doesn\\'t exist or is not \"application/zip\".',\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tbuff = Buffer.from(await response.arrayBuffer());\n\t\t\t\t\t} else if (this.bodyParams.appId && this.bodyParams.marketplace && this.bodyParams.version) {\n\t\t\t\t\t\tconst baseUrl = orchestrator.getMarketplaceUrl();\n\n\t\t\t\t\t\tconst headers = getDefaultHeaders();\n\t\t\t\t\t\tconst token = await getWorkspaceAccessToken(true, 'marketplace:download', false);\n\n\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\tconst response = await fetch(\n\t\t\t\t\t\t\t\t`${baseUrl}/v2/apps/${this.bodyParams.appId}/download/${this.bodyParams.version}?token=${token}`,\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\theaders,\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t);\n\n\t\t\t\t\t\t\tif (response.status !== 200) {\n\t\t\t\t\t\t\t\torchestrator.getRocketChatLogger().error('Error getting the App from the Marketplace:', await response.text());\n\t\t\t\t\t\t\t\treturn API.v1.failure();\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\tif (response.headers.get('content-type') !== 'application/zip') {\n\t\t\t\t\t\t\t\treturn API.v1.failure({\n\t\t\t\t\t\t\t\t\terror: 'Invalid url. It doesn\\'t exist or is not \"application/zip\".',\n\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\tbuff = Buffer.from(await response.arrayBuffer());\n\t\t\t\t\t\t} catch (e: any) {\n\t\t\t\t\t\t\torchestrator.getRocketChatLogger().error('Error getting the App from the Marketplace:', e.response.data);\n\t\t\t\t\t\t\treturn API.v1.internalError();\n\t\t\t\t\t\t}\n\t\t\t\t\t} else {\n\t\t\t\t\t\tisPrivateAppUpload = true;\n\n\t\t\t\t\t\tconst app = await getUploadFormData(\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\trequest: this.request,\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t{ field: 'app', sizeLimit: settings.get('FileUpload_MaxFileSize') },\n\t\t\t\t\t\t);\n\n\t\t\t\t\t\tconst { fields: formData } = app;\n\n\t\t\t\t\t\tbuff = app.fileBuffer;\n\t\t\t\t\t\tpermissionsGranted = (() => {\n\t\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\t\tconst permissions = JSON.parse(formData?.permissions || '');\n\t\t\t\t\t\t\t\treturn permissions.length ? permissions : undefined;\n\t\t\t\t\t\t\t} catch {\n\t\t\t\t\t\t\t\treturn undefined;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t})();\n\t\t\t\t\t}\n\n\t\t\t\t\tif (!buff) {\n\t\t\t\t\t\treturn API.v1.failure({ error: 'Failed to get a file to install for the App. ' });\n\t\t\t\t\t}\n\n\t\t\t\t\tif (isPrivateAppUpload && orchestrator.shouldDisablePrivateAppInstallation()) {\n\t\t\t\t\t\treturn API.v1.internalError('private_app_install_disabled');\n\t\t\t\t\t}\n\n\t\t\t\t\tconst user = orchestrator\n\t\t\t\t\t\t?.getConverters()\n\t\t\t\t\t\t?.get('users')\n\t\t\t\t\t\t?.convertToApp(await Meteor.userAsync());\n\n\t\t\t\t\tconst aff = await manager.update(buff, permissionsGranted, { user, loadApp: true });\n\t\t\t\t\tconst info: IAppInfo & { status?: AppStatus } = aff.getAppInfo();\n\n\t\t\t\t\tif (aff.hasStorageError()) {\n\t\t\t\t\t\treturn API.v1.failure({ status: 'storage_error', messages: [aff.getStorageError()] });\n\t\t\t\t\t}\n\n\t\t\t\t\tif (aff.hasAppUserError()) {\n\t\t\t\t\t\treturn API.v1.failure({\n\t\t\t\t\t\t\tstatus: 'app_user_error',\n\t\t\t\t\t\t\tmessages: [(aff.getAppUserError() as Record<string, any>).message],\n\t\t\t\t\t\t\tpayload: { username: (aff.getAppUserError() as Record<string, any>).username },\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\n\t\t\t\t\tinfo.status = await aff.getApp().getStatus();\n\n\t\t\t\t\tvoid notifyAppInstall(orchestrator.getMarketplaceUrl() as string, 'update', info);\n\n\t\t\t\t\tvoid orchestrator.getNotifier().appUpdated(info.id);\n\n\t\t\t\t\treturn API.v1.success({\n\t\t\t\t\t\tapp: info,\n\t\t\t\t\t\timplemented: aff.getImplementedInferfaces(),\n\t\t\t\t\t\tlicenseValidation: aff.getLicenseValidationResult(),\n\t\t\t\t\t});\n\t\t\t\t},\n\t\t\t\tasync delete() {\n\t\t\t\t\tconst prl = manager.getOneById(this.urlParams.id);\n\n\t\t\t\t\tif (!prl) {\n\t\t\t\t\t\treturn API.v1.notFound(`No App found by the id of: ${this.urlParams.id}`);\n\t\t\t\t\t}\n\n\t\t\t\t\tconst user = orchestrator\n\t\t\t\t\t\t?.getConverters()\n\t\t\t\t\t\t?.get('users')\n\t\t\t\t\t\t.convertToApp(await Meteor.userAsync());\n\n\t\t\t\t\tconst info: IAppInfo & { status?: AppStatus } = prl.getInfo();\n\t\t\t\t\ttry {\n\t\t\t\t\t\tawait manager.remove(prl.getID(), { user });\n\t\t\t\t\t\tinfo.status = AppStatus.DISABLED;\n\t\t\t\t\t} catch (e) {\n\t\t\t\t\t\tinfo.status = await prl.getStatus();\n\t\t\t\t\t\treturn API.v1.failure({ app: info });\n\t\t\t\t\t}\n\n\t\t\t\t\tvoid notifyAppInstall(orchestrator.getMarketplaceUrl() as string, 'uninstall', info);\n\n\t\t\t\t\treturn API.v1.success({ app: info });\n\t\t\t\t},\n\t\t\t},\n\t\t);\n\n\t\tthis.api.addRoute(\n\t\t\t':id/versions',\n\t\t\t{ authRequired: true },\n\t\t\t{\n\t\t\t\tasync get() {\n\t\t\t\t\tconst baseUrl = orchestrator.getMarketplaceUrl();\n\n\t\t\t\t\tconst headers: Record<string, any> = {}; // DO NOT ATTACH THE FRAMEWORK/ENGINE VERSION HERE.\n\t\t\t\t\tconst token = await getWorkspaceAccessToken();\n\t\t\t\t\tif (token) {\n\t\t\t\t\t\theaders.Authorization = `Bearer ${token}`;\n\t\t\t\t\t}\n\n\t\t\t\t\tlet result;\n\t\t\t\t\tlet statusCode;\n\t\t\t\t\ttry {\n\t\t\t\t\t\tconst request = await fetch(`${baseUrl}/v1/apps/${this.urlParams.id}`, { headers });\n\t\t\t\t\t\tstatusCode = request.status;\n\t\t\t\t\t\tresult = await request.json();\n\n\t\t\t\t\t\tif (!request.ok) {\n\t\t\t\t\t\t\tthrow new Error(result.error);\n\t\t\t\t\t\t}\n\t\t\t\t\t} catch (e) {\n\t\t\t\t\t\treturn handleError('Unable to access Marketplace. Does the server has access to the internet?', e);\n\t\t\t\t\t}\n\n\t\t\t\t\tif (!result || statusCode !== 200) {\n\t\t\t\t\t\torchestrator.getRocketChatLogger().error('Error getting the App versions from the Marketplace:', result);\n\t\t\t\t\t\treturn API.v1.failure();\n\t\t\t\t\t}\n\n\t\t\t\t\treturn API.v1.success({ apps: result });\n\t\t\t\t},\n\t\t\t},\n\t\t);\n\n\t\tthis.api.addRoute(\n\t\t\t'notify-admins',\n\t\t\t{ authRequired: true },\n\t\t\t{\n\t\t\t\tasync post() {\n\t\t\t\t\tconst { appId, appName, appVersion, message } = this.bodyParams;\n\t\t\t\t\tconst workspaceUrl = settings.get<string>('Site_Url');\n\n\t\t\t\t\tconst regex = new RegExp('\\\\/$', 'gm');\n\t\t\t\t\tconst safeWorkspaceUrl = workspaceUrl.replace(regex, '');\n\t\t\t\t\tconst learnMore = `${safeWorkspaceUrl}/marketplace/explore/info/${appId}/${appVersion}/requests`;\n\n\t\t\t\t\ttry {\n\t\t\t\t\t\tconst msgs: (params: { adminUser: IUser }) => Promise<Partial<IMessage>> = async ({ adminUser }) => {\n\t\t\t\t\t\t\treturn {\n\t\t\t\t\t\t\t\tmsg: i18n.t('App_Request_Admin_Message', {\n\t\t\t\t\t\t\t\t\tadmin_name: adminUser.name || '',\n\t\t\t\t\t\t\t\t\tapp_name: appName || '',\n\t\t\t\t\t\t\t\t\tuser_name: `@${this.user.username}`,\n\t\t\t\t\t\t\t\t\tmessage: message || '',\n\t\t\t\t\t\t\t\t\tlearn_more: learnMore,\n\t\t\t\t\t\t\t\t\tinterpolation: { escapeValue: false },\n\t\t\t\t\t\t\t\t}),\n\t\t\t\t\t\t\t};\n\t\t\t\t\t\t};\n\n\t\t\t\t\t\tawait sendMessagesToAdmins({ msgs });\n\n\t\t\t\t\t\treturn API.v1.success();\n\t\t\t\t\t} catch (e) {\n\t\t\t\t\t\torchestrator.getRocketChatLogger().error('Error when notifying admins that an user requested an app:', e);\n\t\t\t\t\t\treturn API.v1.failure();\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t},\n\t\t);\n\n\t\tthis.api.addRoute(\n\t\t\t':id/sync',\n\t\t\t{ authRequired: true, permissionsRequired: ['manage-apps'] },\n\t\t\t{\n\t\t\t\tasync post() {\n\t\t\t\t\tconst baseUrl = orchestrator.getMarketplaceUrl();\n\n\t\t\t\t\tconst headers = getDefaultHeaders();\n\t\t\t\t\tconst token = await getWorkspaceAccessToken();\n\t\t\t\t\tif (token) {\n\t\t\t\t\t\theaders.Authorization = `Bearer ${token}`;\n\t\t\t\t\t}\n\n\t\t\t\t\tconst workspaceIdSetting = await Settings.findOneById('Cloud_Workspace_Id');\n\t\t\t\t\tif (!workspaceIdSetting) {\n\t\t\t\t\t\treturn API.v1.failure('No workspace id found');\n\t\t\t\t\t}\n\n\t\t\t\t\tlet result;\n\t\t\t\t\tlet statusCode;\n\t\t\t\t\ttry {\n\t\t\t\t\t\tconst request = await fetch(`${baseUrl}/v1/workspaces/${workspaceIdSetting.value}/apps/${this.urlParams.id}`, { headers });\n\t\t\t\t\t\tstatusCode = request.status;\n\t\t\t\t\t\tresult = await request.json();\n\n\t\t\t\t\t\tif (!request.ok) {\n\t\t\t\t\t\t\tthrow new Error(result.error);\n\t\t\t\t\t\t}\n\t\t\t\t\t} catch (e: any) {\n\t\t\t\t\t\torchestrator.getRocketChatLogger().error('Error syncing the App from the Marketplace:', e);\n\t\t\t\t\t\treturn API.v1.internalError();\n\t\t\t\t\t}\n\n\t\t\t\t\tif (statusCode !== 200) {\n\t\t\t\t\t\torchestrator.getRocketChatLogger().error('Error syncing the App from the Marketplace:', result);\n\t\t\t\t\t\treturn API.v1.failure();\n\t\t\t\t\t}\n\n\t\t\t\t\tawait Apps.updateAppsMarketplaceInfo([result]);\n\n\t\t\t\t\treturn API.v1.success({ app: result });\n\t\t\t\t},\n\t\t\t},\n\t\t);\n\n\t\tthis.api.addRoute(\n\t\t\t':id/icon',\n\t\t\t{ authRequired: false },\n\t\t\t{\n\t\t\t\tget() {\n\t\t\t\t\tconst prl = manager.getOneById(this.urlParams.id);\n\t\t\t\t\tif (!prl) {\n\t\t\t\t\t\treturn API.v1.notFound(`No App found by the id of: ${this.urlParams.id}`);\n\t\t\t\t\t}\n\n\t\t\t\t\tconst info = prl.getInfo();\n\t\t\t\t\tif (!info?.iconFileContent) {\n\t\t\t\t\t\treturn API.v1.notFound(`No App found by the id of: ${this.urlParams.id}`);\n\t\t\t\t\t}\n\n\t\t\t\t\tconst imageData = info.iconFileContent.split(';base64,');\n\n\t\t\t\t\tconst buf = Buffer.from(imageData[1], 'base64');\n\n\t\t\t\t\treturn {\n\t\t\t\t\t\tstatusCode: 200,\n\t\t\t\t\t\theaders: {\n\t\t\t\t\t\t\t'Content-Length': buf.length,\n\t\t\t\t\t\t\t'Content-Type': imageData[0].replace('data:', ''),\n\t\t\t\t\t\t},\n\t\t\t\t\t\tbody: buf,\n\t\t\t\t\t};\n\t\t\t\t},\n\t\t\t},\n\t\t);\n\n\t\tthis.api.addRoute(\n\t\t\t':id/screenshots',\n\t\t\t{ authRequired: false },\n\t\t\t{\n\t\t\t\tasync get() {\n\t\t\t\t\tconst baseUrl = orchestrator.getMarketplaceUrl();\n\t\t\t\t\tconst appId = this.urlParams.id;\n\t\t\t\t\tconst headers = getDefaultHeaders();\n\n\t\t\t\t\ttry {\n\t\t\t\t\t\tconst request = await fetch(`${baseUrl}/v1/apps/${appId}/screenshots`, { headers });\n\t\t\t\t\t\tconst data = await request.json();\n\n\t\t\t\t\t\treturn API.v1.success({\n\t\t\t\t\t\t\tscreenshots: data,\n\t\t\t\t\t\t});\n\t\t\t\t\t} catch (e: any) {\n\t\t\t\t\t\torchestrator.getRocketChatLogger().error('Error getting the screenshots from the Marketplace:', e.message);\n\t\t\t\t\t\treturn API.v1.failure(e.message);\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t},\n\t\t);\n\n\t\tthis.api.addRoute(\n\t\t\t':id/languages',\n\t\t\t{ authRequired: false },\n\t\t\t{\n\t\t\t\tget() {\n\t\t\t\t\tconst prl = manager.getOneById(this.urlParams.id);\n\n\t\t\t\t\tif (prl) {\n\t\t\t\t\t\tconst languages = prl.getStorageItem().languageContent || {};\n\n\t\t\t\t\t\treturn API.v1.success({ languages });\n\t\t\t\t\t}\n\t\t\t\t\treturn API.v1.notFound(`No App found by the id of: ${this.urlParams.id}`);\n\t\t\t\t},\n\t\t\t},\n\t\t);\n\n\t\tthis.api.addRoute(\n\t\t\t':id/logs',\n\t\t\t{ authRequired: true, permissionsRequired: ['manage-apps'] },\n\t\t\t{\n\t\t\t\tasync get() {\n\t\t\t\t\tconst prl = manager.getOneById(this.urlParams.id);\n\n\t\t\t\t\tif (prl) {\n\t\t\t\t\t\tconst { offset, count } = await getPaginationItems(this.queryParams);\n\t\t\t\t\t\tconst { sort, fields, query } = await this.parseJsonQuery();\n\n\t\t\t\t\t\tconst ourQuery = Object.assign({}, query, { appId: prl.getID() });\n\t\t\t\t\t\tconst options = {\n\t\t\t\t\t\t\tsort: sort || { _updatedAt: -1 },\n\t\t\t\t\t\t\tskip: offset,\n\t\t\t\t\t\t\tlimit: count,\n\t\t\t\t\t\t\tfields,\n\t\t\t\t\t\t};\n\n\t\t\t\t\t\tconst logs = await orchestrator?.getLogStorage()?.find(ourQuery, options);\n\n\t\t\t\t\t\treturn API.v1.success({ logs });\n\t\t\t\t\t}\n\t\t\t\t\treturn API.v1.notFound(`No App found by the id of: ${this.urlParams.id}`);\n\t\t\t\t},\n\t\t\t},\n\t\t);\n\n\t\tthis.api.addRoute(\n\t\t\t':id/settings',\n\t\t\t{ authRequired: true, permissionsRequired: ['manage-apps'] },\n\t\t\t{\n\t\t\t\tget() {\n\t\t\t\t\tconst prl = manager.getOneById(this.urlParams.id);\n\n\t\t\t\t\tif (prl) {\n\t\t\t\t\t\tconst settings = Object.assign({}, prl.getStorageItem().settings);\n\n\t\t\t\t\t\tObject.keys(settings).forEach((k) => {\n\t\t\t\t\t\t\tif (settings[k].hidden) {\n\t\t\t\t\t\t\t\tdelete settings[k];\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t});\n\n\t\t\t\t\t\treturn API.v1.success({ settings });\n\t\t\t\t\t}\n\t\t\t\t\treturn API.v1.notFound(`No App found by the id of: ${this.urlParams.id}`);\n\t\t\t\t},\n\t\t\t\tasync post() {\n\t\t\t\t\tif (!this.bodyParams?.settings) {\n\t\t\t\t\t\treturn API.v1.failure('The settings to update must be present.');\n\t\t\t\t\t}\n\n\t\t\t\t\tconst prl = manager.getOneById(this.urlParams.id);\n\n\t\t\t\t\tif (!prl) {\n\t\t\t\t\t\treturn API.v1.notFound(`No App found by the id of: ${this.urlParams.id}`);\n\t\t\t\t\t}\n\n\t\t\t\t\tconst { settings } = prl.getStorageItem();\n\n\t\t\t\t\tconst updated = [];\n\n\t\t\t\t\tfor await (const s of this.bodyParams.settings) {\n\t\t\t\t\t\tif (settings[s.id] && settings[s.id].value !== s.value) {\n\t\t\t\t\t\t\tawait manager.getSettingsManager().updateAppSetting(this.urlParams.id, s);\n\t\t\t\t\t\t\t// Updating?\n\t\t\t\t\t\t\tupdated.push(s);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\treturn API.v1.success({ updated });\n\t\t\t\t},\n\t\t\t},\n\t\t);\n\n\t\tthis.api.addRoute(\n\t\t\t':id/settings/:settingId',\n\t\t\t{ authRequired: true, permissionsRequired: ['manage-apps'] },\n\t\t\t{\n\t\t\t\tget() {\n\t\t\t\t\ttry {\n\t\t\t\t\t\tconst setting = manager.getSettingsManager().getAppSetting(this.urlParams.id, this.urlParams.settingId);\n\n\t\t\t\t\t\treturn API.v1.success({ setting });\n\t\t\t\t\t} catch (e: any) {\n\t\t\t\t\t\tif (e.message.includes('No setting found')) {\n\t\t\t\t\t\t\treturn API.v1.notFound(`No Setting found on the App by the id of: \"${this.urlParams.settingId}\"`);\n\t\t\t\t\t\t}\n\t\t\t\t\t\tif (e.message.includes('No App found')) {\n\t\t\t\t\t\t\treturn API.v1.notFound(`No App found by the id of: ${this.urlParams.id}`);\n\t\t\t\t\t\t}\n\t\t\t\t\t\treturn API.v1.failure(e.message);\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\tasync post() {\n\t\t\t\t\tif (!this.bodyParams.setting) {\n\t\t\t\t\t\treturn API.v1.failure('Setting to update to must be present on the posted body.');\n\t\t\t\t\t}\n\n\t\t\t\t\ttry {\n\t\t\t\t\t\tawait manager.getSettingsManager().updateAppSetting(this.urlParams.id, this.bodyParams.setting);\n\n\t\t\t\t\t\treturn API.v1.success();\n\t\t\t\t\t} catch (e: any) {\n\t\t\t\t\t\tif (e.message.includes('No setting found')) {\n\t\t\t\t\t\t\treturn API.v1.notFound(`No Setting found on the App by the id of: \"${this.urlParams.settingId}\"`);\n\t\t\t\t\t\t}\n\t\t\t\t\t\tif (e.message.includes('No App found')) {\n\t\t\t\t\t\t\treturn API.v1.notFound(`No App found by the id of: ${this.urlParams.id}`);\n\t\t\t\t\t\t}\n\t\t\t\t\t\treturn API.v1.failure(e.message);\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t},\n\t\t);\n\n\t\tthis.api.addRoute(\n\t\t\t':id/apis',\n\t\t\t{ authRequired: true, permissionsRequired: ['manage-apps'] },\n\t\t\t{\n\t\t\t\tget() {\n\t\t\t\t\tconst prl = manager.getOneById(this.urlParams.id);\n\n\t\t\t\t\tif (prl) {\n\t\t\t\t\t\treturn API.v1.success({\n\t\t\t\t\t\t\tapis: (manager as Record<string, any>).apiManager.listApis(this.urlParams.id), // TODO: this is accessing a private property from the manager, we should expose a method to get the list of APIs\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t\treturn API.v1.notFound(`No App found by the id of: ${this.urlParams.id}`);\n\t\t\t\t},\n\t\t\t},\n\t\t);\n\n\t\tthis.api.addRoute(\n\t\t\t':id/status',\n\t\t\t{ authRequired: true, permissionsRequired: ['manage-apps'] },\n\t\t\t{\n\t\t\t\tget() {\n\t\t\t\t\tconst prl = manager.getOneById(this.urlParams.id);\n\n\t\t\t\t\tif (prl) {\n\t\t\t\t\t\treturn API.v1.success({ status: prl.getStatus() });\n\t\t\t\t\t}\n\t\t\t\t\treturn API.v1.notFound(`No App found by the id of: ${this.urlParams.id}`);\n\t\t\t\t},\n\t\t\t\tasync post() {\n\t\t\t\t\tconst { id: appId } = this.urlParams;\n\t\t\t\t\tconst { status } = this.bodyParams;\n\n\t\t\t\t\tif (!status || typeof status !== 'string') {\n\t\t\t\t\t\treturn API.v1.failure('Invalid status provided, it must be \"status\" field and a string.');\n\t\t\t\t\t}\n\n\t\t\t\t\tconst prl = manager.getOneById(appId);\n\t\t\t\t\tif (!prl) {\n\t\t\t\t\t\treturn API.v1.notFound(`No App found by the id of: ${appId}`);\n\t\t\t\t\t}\n\n\t\t\t\t\tconst storedApp = prl.getStorageItem();\n\t\t\t\t\tconst { installationSource, marketplaceInfo } = storedApp;\n\n\t\t\t\t\tif (!License.hasValidLicense() && installationSource === AppInstallationSource.MARKETPLACE) {\n\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\tconst baseUrl = orchestrator.getMarketplaceUrl() as string;\n\t\t\t\t\t\t\tconst headers = getDefaultHeaders();\n\t\t\t\t\t\t\tconst { version } = prl.getInfo();\n\n\t\t\t\t\t\t\tawait appEnableCheck({\n\t\t\t\t\t\t\t\tbaseUrl,\n\t\t\t\t\t\t\t\theaders,\n\t\t\t\t\t\t\t\tappId,\n\t\t\t\t\t\t\t\tversion,\n\t\t\t\t\t\t\t\tmarketplaceInfo,\n\t\t\t\t\t\t\t\tstatus,\n\t\t\t\t\t\t\t\tlogger: orchestrator.getRocketChatLogger(),\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t} catch (error: any) {\n\t\t\t\t\t\t\treturn API.v1.failure(error.message);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\tif (AppStatusUtils.isEnabled(status) && !(await canEnableApp(storedApp))) {\n\t\t\t\t\t\treturn API.v1.failure('Enabled apps have been maxed out');\n\t\t\t\t\t}\n\n\t\t\t\t\tconst result = await manager.changeStatus(prl.getID(), status);\n\t\t\t\t\treturn API.v1.success({ status: result.getStatus() });\n\t\t\t\t},\n\t\t\t},\n\t\t);\n\n\t\tthis.api.addRoute(\n\t\t\t'app-request',\n\t\t\t{ authRequired: true },\n\t\t\t{\n\t\t\t\tasync get() {\n\t\t\t\t\tconst baseUrl = orchestrator.getMarketplaceUrl();\n\t\t\t\t\tconst { appId, q = '', sort = '', limit = 25, offset = 0 } = this.queryParams;\n\t\t\t\t\tconst headers = getDefaultHeaders();\n\n\t\t\t\t\tconst token = await getWorkspaceAccessToken();\n\t\t\t\t\tif (token) {\n\t\t\t\t\t\theaders.Authorization = `Bearer ${token}`;\n\t\t\t\t\t}\n\n\t\t\t\t\ttry {\n\t\t\t\t\t\tconst request = await fetch(`${baseUrl}/v1/app-request?appId=${appId}&q=${q}&sort=${sort}&limit=${limit}&offset=${offset}`, {\n\t\t\t\t\t\t\theaders,\n\t\t\t\t\t\t});\n\t\t\t\t\t\tconst result = await request.json();\n\n\t\t\t\t\t\tif (!request.ok) {\n\t\t\t\t\t\t\tthrow new Error(result.error);\n\t\t\t\t\t\t}\n\t\t\t\t\t\treturn API.v1.success(result);\n\t\t\t\t\t} catch (e: any) {\n\t\t\t\t\t\torchestrator.getRocketChatLogger().error('Error getting all non sent app requests from the Marketplace:', e.message);\n\n\t\t\t\t\t\treturn API.v1.failure(e.message);\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t},\n\t\t);\n\n\t\tthis.api.addRoute(\n\t\t\t'app-request/stats',\n\t\t\t{ authRequired: true },\n\t\t\t{\n\t\t\t\tasync get() {\n\t\t\t\t\tconst baseUrl = orchestrator.getMarketplaceUrl();\n\t\t\t\t\tconst headers = getDefaultHeaders();\n\n\t\t\t\t\tconst token = await getWorkspaceAccessToken();\n\t\t\t\t\tif (token) {\n\t\t\t\t\t\theaders.Authorization = `Bearer ${token}`;\n\t\t\t\t\t}\n\n\t\t\t\t\ttry {\n\t\t\t\t\t\tconst request = await fetch(`${baseUrl}/v1/app-request/stats`, { headers });\n\t\t\t\t\t\tconst result = await request.json();\n\t\t\t\t\t\tif (!request.ok) {\n\t\t\t\t\t\t\tthrow new Error(result.error);\n\t\t\t\t\t\t}\n\t\t\t\t\t\treturn API.v1.success(result);\n\t\t\t\t\t} catch (e: any) {\n\t\t\t\t\t\torchestrator.getRocketChatLogger().error('Error getting the app requests stats from marketplace', e.message);\n\n\t\t\t\t\t\treturn API.v1.failure(e.message);\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t},\n\t\t);\n\n\t\tthis.api.addRoute(\n\t\t\t'app-request/markAsSeen',\n\t\t\t{ authRequired: true },\n\t\t\t{\n\t\t\t\tasync post() {\n\t\t\t\t\tconst baseUrl = orchestrator.getMarketplaceUrl();\n\t\t\t\t\tconst headers = getDefaultHeaders();\n\n\t\t\t\t\tconst token = await getWorkspaceAccessToken();\n\t\t\t\t\tif (token) {\n\t\t\t\t\t\theaders.Authorization = `Bearer ${token}`;\n\t\t\t\t\t}\n\n\t\t\t\t\tconst { unseenRequests } = this.bodyParams;\n\n\t\t\t\t\ttry {\n\t\t\t\t\t\tconst request = await fetch(`${baseUrl}/v1/app-request/markAsSeen`, {\n\t\t\t\t\t\t\tmethod: 'POST',\n\t\t\t\t\t\t\theaders,\n\t\t\t\t\t\t\tbody: { ids: unseenRequests },\n\t\t\t\t\t\t});\n\t\t\t\t\t\tconst result = await request.json();\n\n\t\t\t\t\t\tif (!request.ok) {\n\t\t\t\t\t\t\tthrow new Error(result.error);\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\treturn API.v1.success(result);\n\t\t\t\t\t} catch (e: any) {\n\t\t\t\t\t\torchestrator.getRocketChatLogger().error('Error marking app requests as seen', e.message);\n\n\t\t\t\t\t\treturn API.v1.failure(e.message);\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t},\n\t\t);\n\t}\n}\n"]},"targets":{"android":"125.0.0","chrome":"125.0.0","edge":"125.0.0","firefox":"115.0.0","ie":"10.0.0","ios":"17.4.0","opera":"110.0.0","opera_mobile":"80.0.0","safari":"17.4.0","samsung":"24.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor","root":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":false,"enforceStrictMode":false,"dynamicImport":true,"generateLetDeclarations":true,"topLevelAwait":true},"externalDependencies":[]},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"version":"7.17.2","helpers":true,"useESModules":false,"corejs":false},"externalDependencies":[]},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-async-generator-functions","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-class-properties","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true},"externalDependencies":[]},{"key":"transform-react-jsx","visitor":{"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXFragment":{"exit":[null]},"JSXElement":{"exit":[null]},"JSXAttribute":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false},"externalDependencies":[]},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-nullish-coalescing-operator","visitor":{"LogicalExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-optional-chaining","visitor":{"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-optional-catch-binding","visitor":{"CatchClause":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-class-properties","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-async-generator-functions","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-logical-assignment-operators","visitor":{"AssignmentExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]}],"presets":[],"generatorOpts":{"filename":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/ee/server/apps/communication/rest.ts","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"ee/server/apps/communication/rest.ts","inputSourceMap":{"version":3,"file":"ee/server/apps/communication/rest.ts","sourceRoot":"","sources":["ee/server/apps/communication/rest.ts"],"names":[],"mappings":"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","sourcesContent":["import { AppStatus, AppStatusUtils } from '@rocket.chat/apps-engine/definition/AppStatus';\nimport type { IAppInfo } from '@rocket.chat/apps-engine/definition/metadata';\nimport type { AppManager } from '@rocket.chat/apps-engine/server/AppManager';\nimport { AppInstallationSource } from '@rocket.chat/apps-engine/server/storage';\nimport type { IUser, IMessage } from '@rocket.chat/core-typings';\nimport { License } from '@rocket.chat/license';\nimport { Settings, Users } from '@rocket.chat/models';\nimport { serverFetch as fetch } from '@rocket.chat/server-fetch';\nimport { Meteor } from 'meteor/meteor';\n\nimport type { APIClass } from '../../../../app/api/server';\nimport { API } from '../../../../app/api/server';\nimport { getPaginationItems } from '../../../../app/api/server/helpers/getPaginationItems';\nimport { getUploadFormData } from '../../../../app/api/server/lib/getUploadFormData';\nimport { getWorkspaceAccessToken, getWorkspaceAccessTokenWithScope } from '../../../../app/cloud/server';\nimport { apiDeprecationLogger } from '../../../../app/lib/server/lib/deprecationWarningLogger';\nimport { settings } from '../../../../app/settings/server';\nimport { Info } from '../../../../app/utils/rocketchat.info';\nimport { i18n } from '../../../../server/lib/i18n';\nimport { sendMessagesToAdmins } from '../../../../server/lib/sendMessagesToAdmins';\nimport { canEnableApp } from '../../../app/license/server/canEnableApp';\nimport { formatAppInstanceForRest } from '../../../lib/misc/formatAppInstanceForRest';\nimport { appEnableCheck } from '../marketplace/appEnableCheck';\nimport { notifyAppInstall } from '../marketplace/appInstall';\nimport type { AppServerOrchestrator } from '../orchestrator';\nimport { Apps } from '../orchestrator';\nimport { actionButtonsHandler } from './endpoints/actionButtonsHandler';\nimport { appsCountHandler } from './endpoints/appsCountHandler';\n\nconst rocketChatVersion = Info.version;\nconst appsEngineVersionForMarketplace = Info.marketplaceApiVersion.replace(/-.*/g, '');\nconst getDefaultHeaders = (): Record<string, any> => ({\n\t'X-Apps-Engine-Version': appsEngineVersionForMarketplace,\n});\n\nconst purchaseTypes = new Set(['buy', 'subscription']);\n\nexport class AppsRestApi {\n\tpublic api: APIClass<'/apps'>;\n\n\tpublic _orch: AppServerOrchestrator;\n\n\tpublic _manager: AppManager;\n\n\tconstructor(orch: AppServerOrchestrator, manager: AppManager) {\n\t\tthis._orch = orch;\n\t\tthis._manager = manager;\n\t\tvoid this.loadAPI();\n\t}\n\n\tasync loadAPI() {\n\t\tthis.api = new API.ApiClass({\n\t\t\tversion: 'apps',\n\t\t\tuseDefaultAuth: true,\n\t\t\tprettyJson: false,\n\t\t\tenableCors: false,\n\t\t\tauth: API.getUserAuth(),\n\t\t});\n\t\tthis.addManagementRoutes();\n\t}\n\n\taddManagementRoutes() {\n\t\tconst orchestrator = this._orch;\n\t\tconst manager = this._manager;\n\n\t\tconst handleError = (message: string, e: any) => {\n\t\t\t// when there is no `response` field in the error, it means the request\n\t\t\t// couldn't even make it to the server\n\t\t\tif (!e.hasOwnProperty('response')) {\n\t\t\t\torchestrator.getRocketChatLogger().warn(message, e.message);\n\t\t\t\treturn API.v1.internalError('Could not reach the Marketplace');\n\t\t\t}\n\n\t\t\torchestrator.getRocketChatLogger().error(message, e.response.data);\n\n\t\t\tif (e.response.statusCode >= 500 && e.response.statusCode <= 599) {\n\t\t\t\treturn API.v1.internalError();\n\t\t\t}\n\n\t\t\tif (e.response.statusCode === 404) {\n\t\t\t\treturn API.v1.notFound();\n\t\t\t}\n\n\t\t\treturn API.v1.failure();\n\t\t};\n\n\t\tthis.api.addRoute('actionButtons', ...actionButtonsHandler(this));\n\t\tthis.api.addRoute('count', ...appsCountHandler(this));\n\n\t\tthis.api.addRoute(\n\t\t\t'incompatibleModal',\n\t\t\t{ authRequired: true },\n\t\t\t{\n\t\t\t\tasync get() {\n\t\t\t\t\tconst baseUrl = orchestrator.getMarketplaceUrl();\n\t\t\t\t\tconst workspaceId = settings.get('Cloud_Workspace_Id');\n\t\t\t\t\tconst { action, appId, appVersion } = this.queryParams;\n\n\t\t\t\t\treturn API.v1.success({\n\t\t\t\t\t\turl: `${baseUrl}/apps/${appId}/incompatible/${appVersion}/${action}?workspaceId=${workspaceId}&rocketChatVersion=${rocketChatVersion}`,\n\t\t\t\t\t});\n\t\t\t\t},\n\t\t\t},\n\t\t);\n\n\t\tthis.api.addRoute(\n\t\t\t'marketplace',\n\t\t\t{ authRequired: true },\n\t\t\t{\n\t\t\t\tasync get() {\n\t\t\t\t\tconst baseUrl = orchestrator.getMarketplaceUrl();\n\n\t\t\t\t\t// Gets the Apps from the marketplace\n\t\t\t\t\tconst headers = getDefaultHeaders();\n\t\t\t\t\tconst token = await getWorkspaceAccessToken();\n\t\t\t\t\tif (token) {\n\t\t\t\t\t\theaders.Authorization = `Bearer ${token}`;\n\t\t\t\t\t}\n\n\t\t\t\t\tlet result;\n\t\t\t\t\ttry {\n\t\t\t\t\t\tconst request = await fetch(`${baseUrl}/v1/apps`, {\n\t\t\t\t\t\t\theaders,\n\t\t\t\t\t\t\tparams: {\n\t\t\t\t\t\t\t\t...(this.queryParams.isAdminUser === 'false' && { endUserID: this.user._id }),\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t});\n\n\t\t\t\t\t\tif (request.status === 426) {\n\t\t\t\t\t\t\torchestrator.getRocketChatLogger().error('Workspace out of support window:', await request.json());\n\t\t\t\t\t\t\treturn API.v1.failure({ error: 'unsupported version' });\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tif (request.status !== 200) {\n\t\t\t\t\t\t\torchestrator.getRocketChatLogger().error('Error getting the Apps:', await request.json());\n\t\t\t\t\t\t\treturn API.v1.failure();\n\t\t\t\t\t\t}\n\t\t\t\t\t\tresult = await request.json();\n\n\t\t\t\t\t\tif (!request.ok) {\n\t\t\t\t\t\t\tthrow new Error(result.error);\n\t\t\t\t\t\t}\n\t\t\t\t\t} catch (e) {\n\t\t\t\t\t\treturn handleError('Unable to access Marketplace. Does the server has access to the internet?', e);\n\t\t\t\t\t}\n\n\t\t\t\t\treturn API.v1.success(result);\n\t\t\t\t},\n\t\t\t},\n\t\t);\n\n\t\tthis.api.addRoute(\n\t\t\t'categories',\n\t\t\t{ authRequired: true },\n\t\t\t{\n\t\t\t\tasync get() {\n\t\t\t\t\tconst baseUrl = orchestrator.getMarketplaceUrl();\n\n\t\t\t\t\tconst headers = getDefaultHeaders();\n\t\t\t\t\tconst token = await getWorkspaceAccessToken();\n\t\t\t\t\tif (token) {\n\t\t\t\t\t\theaders.Authorization = `Bearer ${token}`;\n\t\t\t\t\t}\n\n\t\t\t\t\tlet result;\n\t\t\t\t\ttry {\n\t\t\t\t\t\tconst request = await fetch(`${baseUrl}/v1/categories`, { headers });\n\t\t\t\t\t\tif (request.status !== 200) {\n\t\t\t\t\t\t\torchestrator.getRocketChatLogger().error('Error getting the Apps:', await request.json());\n\t\t\t\t\t\t\treturn API.v1.failure();\n\t\t\t\t\t\t}\n\t\t\t\t\t\tresult = await request.json();\n\t\t\t\t\t} catch (e: any) {\n\t\t\t\t\t\treturn handleError('Unable to access Marketplace. Does the server has access to the internet?', e);\n\t\t\t\t\t}\n\n\t\t\t\t\treturn API.v1.success(result);\n\t\t\t\t},\n\t\t\t},\n\t\t);\n\n\t\tthis.api.addRoute(\n\t\t\t'buildExternalUrl',\n\t\t\t{ authRequired: true },\n\t\t\t{\n\t\t\t\tasync get() {\n\t\t\t\t\tconst baseUrl = orchestrator.getMarketplaceUrl();\n\n\t\t\t\t\tconst workspaceId = settings.get('Cloud_Workspace_Id');\n\n\t\t\t\t\tif (!this.queryParams.purchaseType || !purchaseTypes.has(this.queryParams.purchaseType)) {\n\t\t\t\t\t\treturn API.v1.failure({ error: 'Invalid purchase type' });\n\t\t\t\t\t}\n\n\t\t\t\t\tconst response = await getWorkspaceAccessTokenWithScope('marketplace:purchase');\n\t\t\t\t\tif (!response.token) {\n\t\t\t\t\t\treturn API.v1.failure({ error: 'Unauthorized' });\n\t\t\t\t\t}\n\n\t\t\t\t\tconst subscribeRoute = this.queryParams.details === 'true' ? 'subscribe/details' : 'subscribe';\n\n\t\t\t\t\tconst seats = await Users.getActiveLocalUserCount();\n\n\t\t\t\t\treturn API.v1.success({\n\t\t\t\t\t\turl: `${baseUrl}/apps/${this.queryParams.appId}/${\n\t\t\t\t\t\t\tthis.queryParams.purchaseType === 'buy' ? this.queryParams.purchaseType : subscribeRoute\n\t\t\t\t\t\t}?workspaceId=${workspaceId}&token=${response.token}&seats=${seats}`,\n\t\t\t\t\t});\n\t\t\t\t},\n\t\t\t},\n\t\t);\n\n\t\tthis.api.addRoute(\n\t\t\t'installed',\n\t\t\t{ authRequired: true },\n\t\t\t{\n\t\t\t\tasync get() {\n\t\t\t\t\tconst apps = await manager.get();\n\t\t\t\t\tconst formatted = await Promise.all(apps.map(formatAppInstanceForRest));\n\t\t\t\t\treturn API.v1.success({ apps: formatted });\n\t\t\t\t},\n\t\t\t},\n\t\t);\n\n\t\t// WE NEED TO MOVE EACH ENDPOINT HANDLER TO IT'S OWN FILE\n\t\tthis.api.addRoute(\n\t\t\t'',\n\t\t\t{ authRequired: true, permissionsRequired: ['manage-apps'] },\n\t\t\t{\n\t\t\t\tasync get() {\n\t\t\t\t\tconst baseUrl = orchestrator.getMarketplaceUrl();\n\n\t\t\t\t\t// Gets the Apps from the marketplace\n\t\t\t\t\tif ('marketplace' in this.queryParams && this.queryParams.marketplace) {\n\t\t\t\t\t\tapiDeprecationLogger.endpoint(this.request.route, '7.0.0', this.response, 'Use /apps/marketplace to get the apps list.');\n\n\t\t\t\t\t\tconst headers = getDefaultHeaders();\n\t\t\t\t\t\tconst token = await getWorkspaceAccessToken();\n\t\t\t\t\t\tif (token) {\n\t\t\t\t\t\t\theaders.Authorization = `Bearer ${token}`;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tlet result;\n\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\tconst request = await fetch(`${baseUrl}/v1/apps`, { headers });\n\t\t\t\t\t\t\tif (request.status !== 200) {\n\t\t\t\t\t\t\t\torchestrator.getRocketChatLogger().error('Error getting the Apps:', await request.json());\n\t\t\t\t\t\t\t\treturn API.v1.failure();\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tresult = await request.json();\n\t\t\t\t\t\t} catch (e) {\n\t\t\t\t\t\t\treturn handleError('Unable to access Marketplace. Does the server has access to the internet?', e);\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\treturn API.v1.success(result);\n\t\t\t\t\t}\n\n\t\t\t\t\tif ('categories' in this.queryParams && this.queryParams.categories) {\n\t\t\t\t\t\tapiDeprecationLogger.endpoint(this.request.route, '7.0.0', this.response, 'Use /apps/categories to get the categories list.');\n\t\t\t\t\t\tconst headers = getDefaultHeaders();\n\t\t\t\t\t\tconst token = await getWorkspaceAccessToken();\n\t\t\t\t\t\tif (token) {\n\t\t\t\t\t\t\theaders.Authorization = `Bearer ${token}`;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tlet result;\n\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\tconst request = await fetch(`${baseUrl}/v1/categories`, { headers });\n\t\t\t\t\t\t\tif (request.status !== 200) {\n\t\t\t\t\t\t\t\torchestrator.getRocketChatLogger().error('Error getting the Apps:', await request.json());\n\t\t\t\t\t\t\t\treturn API.v1.failure();\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tresult = await request.json();\n\t\t\t\t\t\t} catch (e: any) {\n\t\t\t\t\t\t\torchestrator.getRocketChatLogger().error('Error getting the categories from the Marketplace:', e);\n\t\t\t\t\t\t\treturn API.v1.internalError();\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\treturn API.v1.success(result);\n\t\t\t\t\t}\n\n\t\t\t\t\tif (\n\t\t\t\t\t\t'buildExternalUrl' in this.queryParams &&\n\t\t\t\t\t\t'appId' in this.queryParams &&\n\t\t\t\t\t\tthis.queryParams.buildExternalUrl &&\n\t\t\t\t\t\tthis.queryParams.appId\n\t\t\t\t\t) {\n\t\t\t\t\t\tapiDeprecationLogger.endpoint(this.request.route, '7.0.0', this.response, 'Use /apps/buildExternalUrl to get the modal URLs.');\n\t\t\t\t\t\tconst workspaceId = settings.get('Cloud_Workspace_Id');\n\n\t\t\t\t\t\tif (!this.queryParams.purchaseType || !purchaseTypes.has(this.queryParams.purchaseType)) {\n\t\t\t\t\t\t\treturn API.v1.failure({ error: 'Invalid purchase type' });\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tconst token = await getWorkspaceAccessTokenWithScope('marketplace:purchase');\n\t\t\t\t\t\tif (!token) {\n\t\t\t\t\t\t\treturn API.v1.failure({ error: 'Unauthorized' });\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tconst subscribeRoute = this.queryParams.details === 'true' ? 'subscribe/details' : 'subscribe';\n\n\t\t\t\t\t\tconst seats = await Users.getActiveLocalUserCount();\n\n\t\t\t\t\t\treturn API.v1.success({\n\t\t\t\t\t\t\turl: `${baseUrl}/apps/${this.queryParams.appId}/${\n\t\t\t\t\t\t\t\tthis.queryParams.purchaseType === 'buy' ? this.queryParams.purchaseType : subscribeRoute\n\t\t\t\t\t\t\t}?workspaceId=${workspaceId}&token=${token.token}&seats=${seats}`,\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t\tapiDeprecationLogger.endpoint(this.request.route, '7.0.0', this.response, 'Use /apps/installed to get the installed apps list.');\n\n\t\t\t\t\tconst proxiedApps = await manager.get();\n\t\t\t\t\tconst apps = await Promise.all(proxiedApps.map(formatAppInstanceForRest));\n\n\t\t\t\t\treturn API.v1.success({ apps });\n\t\t\t\t},\n\t\t\t\tasync post() {\n\t\t\t\t\tlet buff;\n\t\t\t\t\tlet marketplaceInfo;\n\t\t\t\t\tlet permissionsGranted;\n\n\t\t\t\t\tif (this.bodyParams.url) {\n\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\tconst response = await fetch(this.bodyParams.url);\n\n\t\t\t\t\t\t\tif (response.status !== 200 || response.headers.get('content-type') !== 'application/zip') {\n\t\t\t\t\t\t\t\treturn API.v1.failure({\n\t\t\t\t\t\t\t\t\terror: 'Invalid url. It doesn\\'t exist or is not \"application/zip\".',\n\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\tbuff = await response.buffer();\n\t\t\t\t\t\t} catch (e: any) {\n\t\t\t\t\t\t\torchestrator.getRocketChatLogger().error('Error getting the app from url:', e.response.data);\n\t\t\t\t\t\t\treturn API.v1.internalError();\n\t\t\t\t\t\t}\n\t\t\t\t\t} else if ('appId' in this.bodyParams && this.bodyParams.appId && this.bodyParams.marketplace && this.bodyParams.version) {\n\t\t\t\t\t\tconst baseUrl = orchestrator.getMarketplaceUrl();\n\n\t\t\t\t\t\tconst headers = getDefaultHeaders();\n\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\tconst downloadToken = await getWorkspaceAccessToken(true, 'marketplace:download', false);\n\t\t\t\t\t\t\tconst marketplaceToken = await getWorkspaceAccessToken();\n\n\t\t\t\t\t\t\tconst [downloadResponse, marketplaceResponse] = await Promise.all([\n\t\t\t\t\t\t\t\tfetch(`${baseUrl}/v2/apps/${this.bodyParams.appId}/download/${this.bodyParams.version}?token=${downloadToken}`, {\n\t\t\t\t\t\t\t\t\theaders,\n\t\t\t\t\t\t\t\t}),\n\t\t\t\t\t\t\t\tfetch(`${baseUrl}/v1/apps/${this.bodyParams.appId}?appVersion=${this.bodyParams.version}`, {\n\t\t\t\t\t\t\t\t\theaders: {\n\t\t\t\t\t\t\t\t\t\tAuthorization: `Bearer ${marketplaceToken}`,\n\t\t\t\t\t\t\t\t\t\t...headers,\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t}),\n\t\t\t\t\t\t\t]);\n\n\t\t\t\t\t\t\tif (downloadResponse.headers.get('content-type') !== 'application/zip') {\n\t\t\t\t\t\t\t\tthrow new Error('Invalid url. It doesn\\'t exist or is not \"application/zip\".');\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\tbuff = Buffer.from(await downloadResponse.arrayBuffer());\n\t\t\t\t\t\t\tmarketplaceInfo = (await marketplaceResponse.json()) as any;\n\t\t\t\t\t\t\tpermissionsGranted = this.bodyParams.permissionsGranted;\n\t\t\t\t\t\t} catch (err: any) {\n\t\t\t\t\t\t\treturn API.v1.failure(err.message);\n\t\t\t\t\t\t}\n\t\t\t\t\t} else {\n\t\t\t\t\t\tconst app = await getUploadFormData(\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\trequest: this.request,\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t{ field: 'app', sizeLimit: settings.get('FileUpload_MaxFileSize') },\n\t\t\t\t\t\t);\n\n\t\t\t\t\t\tconst { fields: formData } = app;\n\n\t\t\t\t\t\tbuff = app.fileBuffer;\n\t\t\t\t\t\tpermissionsGranted = (() => {\n\t\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\t\tconst permissions = JSON.parse(formData?.permissions || '');\n\t\t\t\t\t\t\t\treturn permissions.length ? permissions : undefined;\n\t\t\t\t\t\t\t} catch {\n\t\t\t\t\t\t\t\treturn undefined;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t})();\n\t\t\t\t\t}\n\n\t\t\t\t\tif (!buff) {\n\t\t\t\t\t\treturn API.v1.failure({ error: 'Failed to get a file to install for the App. ' });\n\t\t\t\t\t}\n\n\t\t\t\t\t// Used mostly in Cloud hosting for security reasons\n\t\t\t\t\tif (!marketplaceInfo && orchestrator.shouldDisablePrivateAppInstallation()) {\n\t\t\t\t\t\treturn API.v1.internalError('private_app_install_disabled');\n\t\t\t\t\t}\n\n\t\t\t\t\tconst user = orchestrator\n\t\t\t\t\t\t?.getConverters()\n\t\t\t\t\t\t?.get('users')\n\t\t\t\t\t\t?.convertToApp(await Meteor.userAsync());\n\n\t\t\t\t\tconst aff = await manager.add(buff, { marketplaceInfo, permissionsGranted, enable: false, user });\n\t\t\t\t\tconst info: IAppInfo & { status?: AppStatus } = aff.getAppInfo();\n\n\t\t\t\t\tif (aff.hasStorageError()) {\n\t\t\t\t\t\treturn API.v1.failure({ status: 'storage_error', messages: [aff.getStorageError()] });\n\t\t\t\t\t}\n\n\t\t\t\t\tif (aff.hasAppUserError()) {\n\t\t\t\t\t\treturn API.v1.failure({\n\t\t\t\t\t\t\tstatus: 'app_user_error',\n\t\t\t\t\t\t\tmessages: [(aff.getAppUserError() as Record<string, any>).message],\n\t\t\t\t\t\t\tpayload: { username: (aff.getAppUserError() as Record<string, any>).username },\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\n\t\t\t\t\tinfo.status = await aff.getApp().getStatus();\n\n\t\t\t\t\tvoid notifyAppInstall(orchestrator.getMarketplaceUrl() as string, 'install', info);\n\n\t\t\t\t\tif (await canEnableApp(aff.getApp().getStorageItem())) {\n\t\t\t\t\t\tconst success = await manager.enable(info.id);\n\t\t\t\t\t\tinfo.status = success ? AppStatus.AUTO_ENABLED : info.status;\n\t\t\t\t\t}\n\n\t\t\t\t\tvoid orchestrator.getNotifier().appAdded(info.id);\n\n\t\t\t\t\treturn API.v1.success({\n\t\t\t\t\t\tapp: info,\n\t\t\t\t\t\timplemented: aff.getImplementedInferfaces(),\n\t\t\t\t\t\tlicenseValidation: aff.getLicenseValidationResult(),\n\t\t\t\t\t});\n\t\t\t\t},\n\t\t\t},\n\t\t);\n\n\t\tthis.api.addRoute(\n\t\t\t'buildExternalAppRequest',\n\t\t\t{ authRequired: true },\n\t\t\t{\n\t\t\t\tasync get() {\n\t\t\t\t\tif (!this.queryParams.appId) {\n\t\t\t\t\t\treturn API.v1.failure({ error: 'Invalid request. Please ensure an appId is attached to the request.' });\n\t\t\t\t\t}\n\n\t\t\t\t\tconst baseUrl = orchestrator.getMarketplaceUrl();\n\t\t\t\t\tconst workspaceId = settings.get<string>('Cloud_Workspace_Id');\n\n\t\t\t\t\tconst requester = {\n\t\t\t\t\t\tid: this.user._id,\n\t\t\t\t\t\tusername: this.user.username,\n\t\t\t\t\t\tname: this.user.name,\n\t\t\t\t\t\tnickname: this.user.nickname,\n\t\t\t\t\t\temails: this.user?.emails?.map((e) => e.address),\n\t\t\t\t\t};\n\n\t\t\t\t\tlet admins: {\n\t\t\t\t\t\tid: string;\n\t\t\t\t\t\tusername?: string;\n\t\t\t\t\t\tname?: string;\n\t\t\t\t\t\tnickname?: string;\n\t\t\t\t\t}[] = [];\n\t\t\t\t\ttry {\n\t\t\t\t\t\tconst adminsRaw = await Users.findUsersInRoles(['admin'], undefined, {\n\t\t\t\t\t\t\tprojection: {\n\t\t\t\t\t\t\t\tusername: 1,\n\t\t\t\t\t\t\t\tname: 1,\n\t\t\t\t\t\t\t\tnickname: 1,\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t}).toArray();\n\n\t\t\t\t\t\tadmins = adminsRaw.map((a) => {\n\t\t\t\t\t\t\treturn {\n\t\t\t\t\t\t\t\tid: a._id,\n\t\t\t\t\t\t\t\tusername: a.username,\n\t\t\t\t\t\t\t\tname: a.name,\n\t\t\t\t\t\t\t\tnickname: a.nickname,\n\t\t\t\t\t\t\t};\n\t\t\t\t\t\t});\n\t\t\t\t\t} catch (e) {\n\t\t\t\t\t\torchestrator.getRocketChatLogger().error('Error getting the admins to request an app be installed:', e);\n\t\t\t\t\t}\n\n\t\t\t\t\tconst queryParams = new URLSearchParams();\n\t\t\t\t\tqueryParams.set('workspaceId', workspaceId);\n\t\t\t\t\tqueryParams.set('frameworkVersion', appsEngineVersionForMarketplace);\n\t\t\t\t\tqueryParams.set('requester', Buffer.from(JSON.stringify(requester)).toString('base64'));\n\t\t\t\t\tqueryParams.set('admins', Buffer.from(JSON.stringify(admins)).toString('base64'));\n\n\t\t\t\t\treturn API.v1.success({\n\t\t\t\t\t\turl: `${baseUrl}/apps/${this.queryParams.appId}/requestAccess?${queryParams.toString()}`,\n\t\t\t\t\t});\n\t\t\t\t},\n\t\t\t},\n\t\t);\n\n\t\tthis.api.addRoute(\n\t\t\t'externalComponents',\n\t\t\t{ authRequired: false },\n\t\t\t{\n\t\t\t\tget() {\n\t\t\t\t\tconst externalComponents = orchestrator.getProvidedComponents();\n\n\t\t\t\t\treturn API.v1.success({ externalComponents });\n\t\t\t\t},\n\t\t\t},\n\t\t);\n\n\t\tthis.api.addRoute(\n\t\t\t'languages',\n\t\t\t{ authRequired: false },\n\t\t\t{\n\t\t\t\tasync get() {\n\t\t\t\t\tconst apps = (await manager.get()).map((prl) => ({\n\t\t\t\t\t\tid: prl.getID(),\n\t\t\t\t\t\tlanguages: prl.getStorageItem().languageContent,\n\t\t\t\t\t}));\n\n\t\t\t\t\treturn API.v1.success({ apps });\n\t\t\t\t},\n\t\t\t},\n\t\t);\n\n\t\tthis.api.addRoute(\n\t\t\t'externalComponentEvent',\n\t\t\t{ authRequired: true },\n\t\t\t{\n\t\t\t\tpost() {\n\t\t\t\t\tif (\n\t\t\t\t\t\t!this.bodyParams.externalComponent ||\n\t\t\t\t\t\t!this.bodyParams.event ||\n\t\t\t\t\t\t!['IPostExternalComponentOpened', 'IPostExternalComponentClosed'].includes(this.bodyParams.event)\n\t\t\t\t\t) {\n\t\t\t\t\t\treturn API.v1.failure({ error: 'Event and externalComponent must be provided.' });\n\t\t\t\t\t}\n\n\t\t\t\t\ttry {\n\t\t\t\t\t\tconst { event, externalComponent } = this.bodyParams;\n\t\t\t\t\t\tconst result = (Apps.getBridges()?.getListenerBridge() as Record<string, any>).externalComponentEvent(event, externalComponent);\n\n\t\t\t\t\t\treturn API.v1.success({ result });\n\t\t\t\t\t} catch (e: any) {\n\t\t\t\t\t\torchestrator.getRocketChatLogger().error(`Error triggering external components' events ${e.response.data}`);\n\t\t\t\t\t\treturn API.v1.internalError();\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t},\n\t\t);\n\n\t\tthis.api.addRoute(\n\t\t\t'bundles/:id/apps',\n\t\t\t{ authRequired: true, permissionsRequired: ['manage-apps'] },\n\t\t\t{\n\t\t\t\tasync get() {\n\t\t\t\t\tconst baseUrl = orchestrator.getMarketplaceUrl();\n\n\t\t\t\t\tconst headers: Record<string, any> = {};\n\t\t\t\t\tconst token = await getWorkspaceAccessToken();\n\t\t\t\t\tif (token) {\n\t\t\t\t\t\theaders.Authorization = `Bearer ${token}`;\n\t\t\t\t\t}\n\n\t\t\t\t\tlet result;\n\t\t\t\t\ttry {\n\t\t\t\t\t\tconst request = await fetch(`${baseUrl}/v1/bundles/${this.urlParams.id}/apps`, { headers });\n\t\t\t\t\t\tif (request.status !== 200) {\n\t\t\t\t\t\t\torchestrator.getRocketChatLogger().error(\"Error getting the Bundle's Apps from the Marketplace:\", await request.json());\n\t\t\t\t\t\t\treturn API.v1.failure();\n\t\t\t\t\t\t}\n\t\t\t\t\t\tresult = await request.json();\n\t\t\t\t\t} catch (e: any) {\n\t\t\t\t\t\torchestrator.getRocketChatLogger().error(\"Error getting the Bundle's Apps from the Marketplace:\", e.response.data);\n\t\t\t\t\t\treturn API.v1.internalError();\n\t\t\t\t\t}\n\n\t\t\t\t\treturn API.v1.success({ apps: result });\n\t\t\t\t},\n\t\t\t},\n\t\t);\n\n\t\tthis.api.addRoute(\n\t\t\t'featured-apps',\n\t\t\t{ authRequired: true },\n\t\t\t{\n\t\t\t\tasync get() {\n\t\t\t\t\tconst baseUrl = orchestrator.getMarketplaceUrl();\n\n\t\t\t\t\tconst headers = getDefaultHeaders();\n\t\t\t\t\tconst token = await getWorkspaceAccessToken();\n\t\t\t\t\tif (token) {\n\t\t\t\t\t\theaders.Authorization = `Bearer ${token}`;\n\t\t\t\t\t}\n\n\t\t\t\t\tlet result;\n\t\t\t\t\ttry {\n\t\t\t\t\t\tconst request = await fetch(`${baseUrl}/v1/featured-apps`, { headers });\n\t\t\t\t\t\tif (request.status !== 200) {\n\t\t\t\t\t\t\torchestrator.getRocketChatLogger().error('Error getting the Featured Apps from the Marketplace:', await request.json());\n\t\t\t\t\t\t\treturn API.v1.failure();\n\t\t\t\t\t\t}\n\t\t\t\t\t\tresult = await request.json();\n\t\t\t\t\t} catch (e) {\n\t\t\t\t\t\treturn handleError('Unable to access Marketplace. Does the server has access to the internet?', e);\n\t\t\t\t\t}\n\n\t\t\t\t\treturn API.v1.success(result);\n\t\t\t\t},\n\t\t\t},\n\t\t);\n\n\t\tthis.api.addRoute(\n\t\t\t':id',\n\t\t\t{ authRequired: true, permissionsRequired: ['manage-apps'] },\n\t\t\t{\n\t\t\t\tasync get() {\n\t\t\t\t\tif (this.queryParams.marketplace && this.queryParams.version) {\n\t\t\t\t\t\tconst baseUrl = orchestrator.getMarketplaceUrl();\n\n\t\t\t\t\t\tconst headers: Record<string, any> = {}; // DO NOT ATTACH THE FRAMEWORK/ENGINE VERSION HERE.\n\t\t\t\t\t\tconst token = await getWorkspaceAccessToken();\n\t\t\t\t\t\tif (token) {\n\t\t\t\t\t\t\theaders.Authorization = `Bearer ${token}`;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tlet result: any;\n\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\tconst request = await fetch(`${baseUrl}/v1/apps/${this.urlParams.id}?appVersion=${this.queryParams.version}`, { headers });\n\t\t\t\t\t\t\tif (request.status !== 200) {\n\t\t\t\t\t\t\t\torchestrator.getRocketChatLogger().error('Error getting the App information from the Marketplace:', await request.json());\n\t\t\t\t\t\t\t\treturn API.v1.failure();\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tresult = await request.json();\n\t\t\t\t\t\t} catch (e) {\n\t\t\t\t\t\t\treturn handleError('Unable to access Marketplace. Does the server has access to the internet?', e);\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\treturn API.v1.success({ app: result[0] });\n\t\t\t\t\t}\n\n\t\t\t\t\tif (this.queryParams.marketplace && this.queryParams.update && this.queryParams.appVersion) {\n\t\t\t\t\t\tconst baseUrl = orchestrator.getMarketplaceUrl();\n\n\t\t\t\t\t\tconst headers = getDefaultHeaders();\n\t\t\t\t\t\tconst token = await getWorkspaceAccessToken();\n\t\t\t\t\t\tif (token) {\n\t\t\t\t\t\t\theaders.Authorization = `Bearer ${token}`;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tlet result;\n\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\tconst request = await fetch(`${baseUrl}/v1/apps/${this.urlParams.id}/latest?appVersion=${this.queryParams.appVersion}`, {\n\t\t\t\t\t\t\t\theaders,\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\tif (request.status !== 200) {\n\t\t\t\t\t\t\t\torchestrator.getRocketChatLogger().error('Error getting the App update info from the Marketplace:', await request.json());\n\t\t\t\t\t\t\t\treturn API.v1.failure();\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tresult = await request.json();\n\t\t\t\t\t\t} catch (e) {\n\t\t\t\t\t\t\treturn handleError('Unable to access Marketplace. Does the server has access to the internet?', e);\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\treturn API.v1.success({ app: result });\n\t\t\t\t\t}\n\t\t\t\t\tconst app = manager.getOneById(this.urlParams.id);\n\t\t\t\t\tif (!app) {\n\t\t\t\t\t\treturn API.v1.notFound(`No App found by the id of: ${this.urlParams.id}`);\n\t\t\t\t\t}\n\n\t\t\t\t\treturn API.v1.success({\n\t\t\t\t\t\tapp: formatAppInstanceForRest(app),\n\t\t\t\t\t});\n\t\t\t\t},\n\t\t\t\tasync post() {\n\t\t\t\t\tlet buff;\n\t\t\t\t\tlet permissionsGranted;\n\t\t\t\t\tlet isPrivateAppUpload = false;\n\n\t\t\t\t\tif (this.bodyParams.url) {\n\t\t\t\t\t\tconst response = await fetch(this.bodyParams.url);\n\n\t\t\t\t\t\tif (response.status !== 200 || response.headers.get('content-type') !== 'application/zip') {\n\t\t\t\t\t\t\treturn API.v1.failure({\n\t\t\t\t\t\t\t\terror: 'Invalid url. It doesn\\'t exist or is not \"application/zip\".',\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tbuff = Buffer.from(await response.arrayBuffer());\n\t\t\t\t\t} else if (this.bodyParams.appId && this.bodyParams.marketplace && this.bodyParams.version) {\n\t\t\t\t\t\tconst baseUrl = orchestrator.getMarketplaceUrl();\n\n\t\t\t\t\t\tconst headers = getDefaultHeaders();\n\t\t\t\t\t\tconst token = await getWorkspaceAccessToken(true, 'marketplace:download', false);\n\n\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\tconst response = await fetch(\n\t\t\t\t\t\t\t\t`${baseUrl}/v2/apps/${this.bodyParams.appId}/download/${this.bodyParams.version}?token=${token}`,\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\theaders,\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t);\n\n\t\t\t\t\t\t\tif (response.status !== 200) {\n\t\t\t\t\t\t\t\torchestrator.getRocketChatLogger().error('Error getting the App from the Marketplace:', await response.text());\n\t\t\t\t\t\t\t\treturn API.v1.failure();\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\tif (response.headers.get('content-type') !== 'application/zip') {\n\t\t\t\t\t\t\t\treturn API.v1.failure({\n\t\t\t\t\t\t\t\t\terror: 'Invalid url. It doesn\\'t exist or is not \"application/zip\".',\n\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\tbuff = Buffer.from(await response.arrayBuffer());\n\t\t\t\t\t\t} catch (e: any) {\n\t\t\t\t\t\t\torchestrator.getRocketChatLogger().error('Error getting the App from the Marketplace:', e.response.data);\n\t\t\t\t\t\t\treturn API.v1.internalError();\n\t\t\t\t\t\t}\n\t\t\t\t\t} else {\n\t\t\t\t\t\tisPrivateAppUpload = true;\n\n\t\t\t\t\t\tconst app = await getUploadFormData(\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\trequest: this.request,\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t{ field: 'app', sizeLimit: settings.get('FileUpload_MaxFileSize') },\n\t\t\t\t\t\t);\n\n\t\t\t\t\t\tconst { fields: formData } = app;\n\n\t\t\t\t\t\tbuff = app.fileBuffer;\n\t\t\t\t\t\tpermissionsGranted = (() => {\n\t\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\t\tconst permissions = JSON.parse(formData?.permissions || '');\n\t\t\t\t\t\t\t\treturn permissions.length ? permissions : undefined;\n\t\t\t\t\t\t\t} catch {\n\t\t\t\t\t\t\t\treturn undefined;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t})();\n\t\t\t\t\t}\n\n\t\t\t\t\tif (!buff) {\n\t\t\t\t\t\treturn API.v1.failure({ error: 'Failed to get a file to install for the App. ' });\n\t\t\t\t\t}\n\n\t\t\t\t\tif (isPrivateAppUpload && orchestrator.shouldDisablePrivateAppInstallation()) {\n\t\t\t\t\t\treturn API.v1.internalError('private_app_install_disabled');\n\t\t\t\t\t}\n\n\t\t\t\t\tconst user = orchestrator\n\t\t\t\t\t\t?.getConverters()\n\t\t\t\t\t\t?.get('users')\n\t\t\t\t\t\t?.convertToApp(await Meteor.userAsync());\n\n\t\t\t\t\tconst aff = await manager.update(buff, permissionsGranted, { user, loadApp: true });\n\t\t\t\t\tconst info: IAppInfo & { status?: AppStatus } = aff.getAppInfo();\n\n\t\t\t\t\tif (aff.hasStorageError()) {\n\t\t\t\t\t\treturn API.v1.failure({ status: 'storage_error', messages: [aff.getStorageError()] });\n\t\t\t\t\t}\n\n\t\t\t\t\tif (aff.hasAppUserError()) {\n\t\t\t\t\t\treturn API.v1.failure({\n\t\t\t\t\t\t\tstatus: 'app_user_error',\n\t\t\t\t\t\t\tmessages: [(aff.getAppUserError() as Record<string, any>).message],\n\t\t\t\t\t\t\tpayload: { username: (aff.getAppUserError() as Record<string, any>).username },\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\n\t\t\t\t\tinfo.status = await aff.getApp().getStatus();\n\n\t\t\t\t\tvoid notifyAppInstall(orchestrator.getMarketplaceUrl() as string, 'update', info);\n\n\t\t\t\t\tvoid orchestrator.getNotifier().appUpdated(info.id);\n\n\t\t\t\t\treturn API.v1.success({\n\t\t\t\t\t\tapp: info,\n\t\t\t\t\t\timplemented: aff.getImplementedInferfaces(),\n\t\t\t\t\t\tlicenseValidation: aff.getLicenseValidationResult(),\n\t\t\t\t\t});\n\t\t\t\t},\n\t\t\t\tasync delete() {\n\t\t\t\t\tconst prl = manager.getOneById(this.urlParams.id);\n\n\t\t\t\t\tif (!prl) {\n\t\t\t\t\t\treturn API.v1.notFound(`No App found by the id of: ${this.urlParams.id}`);\n\t\t\t\t\t}\n\n\t\t\t\t\tconst user = orchestrator\n\t\t\t\t\t\t?.getConverters()\n\t\t\t\t\t\t?.get('users')\n\t\t\t\t\t\t.convertToApp(await Meteor.userAsync());\n\n\t\t\t\t\tconst info: IAppInfo & { status?: AppStatus } = prl.getInfo();\n\t\t\t\t\ttry {\n\t\t\t\t\t\tawait manager.remove(prl.getID(), { user });\n\t\t\t\t\t\tinfo.status = AppStatus.DISABLED;\n\t\t\t\t\t} catch (e) {\n\t\t\t\t\t\tinfo.status = await prl.getStatus();\n\t\t\t\t\t\treturn API.v1.failure({ app: info });\n\t\t\t\t\t}\n\n\t\t\t\t\tvoid notifyAppInstall(orchestrator.getMarketplaceUrl() as string, 'uninstall', info);\n\n\t\t\t\t\treturn API.v1.success({ app: info });\n\t\t\t\t},\n\t\t\t},\n\t\t);\n\n\t\tthis.api.addRoute(\n\t\t\t':id/versions',\n\t\t\t{ authRequired: true },\n\t\t\t{\n\t\t\t\tasync get() {\n\t\t\t\t\tconst baseUrl = orchestrator.getMarketplaceUrl();\n\n\t\t\t\t\tconst headers: Record<string, any> = {}; // DO NOT ATTACH THE FRAMEWORK/ENGINE VERSION HERE.\n\t\t\t\t\tconst token = await getWorkspaceAccessToken();\n\t\t\t\t\tif (token) {\n\t\t\t\t\t\theaders.Authorization = `Bearer ${token}`;\n\t\t\t\t\t}\n\n\t\t\t\t\tlet result;\n\t\t\t\t\tlet statusCode;\n\t\t\t\t\ttry {\n\t\t\t\t\t\tconst request = await fetch(`${baseUrl}/v1/apps/${this.urlParams.id}`, { headers });\n\t\t\t\t\t\tstatusCode = request.status;\n\t\t\t\t\t\tresult = await request.json();\n\n\t\t\t\t\t\tif (!request.ok) {\n\t\t\t\t\t\t\tthrow new Error(result.error);\n\t\t\t\t\t\t}\n\t\t\t\t\t} catch (e) {\n\t\t\t\t\t\treturn handleError('Unable to access Marketplace. Does the server has access to the internet?', e);\n\t\t\t\t\t}\n\n\t\t\t\t\tif (!result || statusCode !== 200) {\n\t\t\t\t\t\torchestrator.getRocketChatLogger().error('Error getting the App versions from the Marketplace:', result);\n\t\t\t\t\t\treturn API.v1.failure();\n\t\t\t\t\t}\n\n\t\t\t\t\treturn API.v1.success({ apps: result });\n\t\t\t\t},\n\t\t\t},\n\t\t);\n\n\t\tthis.api.addRoute(\n\t\t\t'notify-admins',\n\t\t\t{ authRequired: true },\n\t\t\t{\n\t\t\t\tasync post() {\n\t\t\t\t\tconst { appId, appName, appVersion, message } = this.bodyParams;\n\t\t\t\t\tconst workspaceUrl = settings.get<string>('Site_Url');\n\n\t\t\t\t\tconst regex = new RegExp('\\\\/$', 'gm');\n\t\t\t\t\tconst safeWorkspaceUrl = workspaceUrl.replace(regex, '');\n\t\t\t\t\tconst learnMore = `${safeWorkspaceUrl}/marketplace/explore/info/${appId}/${appVersion}/requests`;\n\n\t\t\t\t\ttry {\n\t\t\t\t\t\tconst msgs: (params: { adminUser: IUser }) => Promise<Partial<IMessage>> = async ({ adminUser }) => {\n\t\t\t\t\t\t\treturn {\n\t\t\t\t\t\t\t\tmsg: i18n.t('App_Request_Admin_Message', {\n\t\t\t\t\t\t\t\t\tadmin_name: adminUser.name || '',\n\t\t\t\t\t\t\t\t\tapp_name: appName || '',\n\t\t\t\t\t\t\t\t\tuser_name: `@${this.user.username}`,\n\t\t\t\t\t\t\t\t\tmessage: message || '',\n\t\t\t\t\t\t\t\t\tlearn_more: learnMore,\n\t\t\t\t\t\t\t\t\tinterpolation: { escapeValue: false },\n\t\t\t\t\t\t\t\t}),\n\t\t\t\t\t\t\t};\n\t\t\t\t\t\t};\n\n\t\t\t\t\t\tawait sendMessagesToAdmins({ msgs });\n\n\t\t\t\t\t\treturn API.v1.success();\n\t\t\t\t\t} catch (e) {\n\t\t\t\t\t\torchestrator.getRocketChatLogger().error('Error when notifying admins that an user requested an app:', e);\n\t\t\t\t\t\treturn API.v1.failure();\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t},\n\t\t);\n\n\t\tthis.api.addRoute(\n\t\t\t':id/sync',\n\t\t\t{ authRequired: true, permissionsRequired: ['manage-apps'] },\n\t\t\t{\n\t\t\t\tasync post() {\n\t\t\t\t\tconst baseUrl = orchestrator.getMarketplaceUrl();\n\n\t\t\t\t\tconst headers = getDefaultHeaders();\n\t\t\t\t\tconst token = await getWorkspaceAccessToken();\n\t\t\t\t\tif (token) {\n\t\t\t\t\t\theaders.Authorization = `Bearer ${token}`;\n\t\t\t\t\t}\n\n\t\t\t\t\tconst workspaceIdSetting = await Settings.findOneById('Cloud_Workspace_Id');\n\t\t\t\t\tif (!workspaceIdSetting) {\n\t\t\t\t\t\treturn API.v1.failure('No workspace id found');\n\t\t\t\t\t}\n\n\t\t\t\t\tlet result;\n\t\t\t\t\tlet statusCode;\n\t\t\t\t\ttry {\n\t\t\t\t\t\tconst request = await fetch(`${baseUrl}/v1/workspaces/${workspaceIdSetting.value}/apps/${this.urlParams.id}`, { headers });\n\t\t\t\t\t\tstatusCode = request.status;\n\t\t\t\t\t\tresult = await request.json();\n\n\t\t\t\t\t\tif (!request.ok) {\n\t\t\t\t\t\t\tthrow new Error(result.error);\n\t\t\t\t\t\t}\n\t\t\t\t\t} catch (e: any) {\n\t\t\t\t\t\torchestrator.getRocketChatLogger().error('Error syncing the App from the Marketplace:', e);\n\t\t\t\t\t\treturn API.v1.internalError();\n\t\t\t\t\t}\n\n\t\t\t\t\tif (statusCode !== 200) {\n\t\t\t\t\t\torchestrator.getRocketChatLogger().error('Error syncing the App from the Marketplace:', result);\n\t\t\t\t\t\treturn API.v1.failure();\n\t\t\t\t\t}\n\n\t\t\t\t\tawait Apps.updateAppsMarketplaceInfo([result]);\n\n\t\t\t\t\treturn API.v1.success({ app: result });\n\t\t\t\t},\n\t\t\t},\n\t\t);\n\n\t\tthis.api.addRoute(\n\t\t\t':id/icon',\n\t\t\t{ authRequired: false },\n\t\t\t{\n\t\t\t\tget() {\n\t\t\t\t\tconst prl = manager.getOneById(this.urlParams.id);\n\t\t\t\t\tif (!prl) {\n\t\t\t\t\t\treturn API.v1.notFound(`No App found by the id of: ${this.urlParams.id}`);\n\t\t\t\t\t}\n\n\t\t\t\t\tconst info = prl.getInfo();\n\t\t\t\t\tif (!info?.iconFileContent) {\n\t\t\t\t\t\treturn API.v1.notFound(`No App found by the id of: ${this.urlParams.id}`);\n\t\t\t\t\t}\n\n\t\t\t\t\tconst imageData = info.iconFileContent.split(';base64,');\n\n\t\t\t\t\tconst buf = Buffer.from(imageData[1], 'base64');\n\n\t\t\t\t\treturn {\n\t\t\t\t\t\tstatusCode: 200,\n\t\t\t\t\t\theaders: {\n\t\t\t\t\t\t\t'Content-Length': buf.length,\n\t\t\t\t\t\t\t'Content-Type': imageData[0].replace('data:', ''),\n\t\t\t\t\t\t},\n\t\t\t\t\t\tbody: buf,\n\t\t\t\t\t};\n\t\t\t\t},\n\t\t\t},\n\t\t);\n\n\t\tthis.api.addRoute(\n\t\t\t':id/screenshots',\n\t\t\t{ authRequired: false },\n\t\t\t{\n\t\t\t\tasync get() {\n\t\t\t\t\tconst baseUrl = orchestrator.getMarketplaceUrl();\n\t\t\t\t\tconst appId = this.urlParams.id;\n\t\t\t\t\tconst headers = getDefaultHeaders();\n\n\t\t\t\t\ttry {\n\t\t\t\t\t\tconst request = await fetch(`${baseUrl}/v1/apps/${appId}/screenshots`, { headers });\n\t\t\t\t\t\tconst data = await request.json();\n\n\t\t\t\t\t\treturn API.v1.success({\n\t\t\t\t\t\t\tscreenshots: data,\n\t\t\t\t\t\t});\n\t\t\t\t\t} catch (e: any) {\n\t\t\t\t\t\torchestrator.getRocketChatLogger().error('Error getting the screenshots from the Marketplace:', e.message);\n\t\t\t\t\t\treturn API.v1.failure(e.message);\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t},\n\t\t);\n\n\t\tthis.api.addRoute(\n\t\t\t':id/languages',\n\t\t\t{ authRequired: false },\n\t\t\t{\n\t\t\t\tget() {\n\t\t\t\t\tconst prl = manager.getOneById(this.urlParams.id);\n\n\t\t\t\t\tif (prl) {\n\t\t\t\t\t\tconst languages = prl.getStorageItem().languageContent || {};\n\n\t\t\t\t\t\treturn API.v1.success({ languages });\n\t\t\t\t\t}\n\t\t\t\t\treturn API.v1.notFound(`No App found by the id of: ${this.urlParams.id}`);\n\t\t\t\t},\n\t\t\t},\n\t\t);\n\n\t\tthis.api.addRoute(\n\t\t\t':id/logs',\n\t\t\t{ authRequired: true, permissionsRequired: ['manage-apps'] },\n\t\t\t{\n\t\t\t\tasync get() {\n\t\t\t\t\tconst prl = manager.getOneById(this.urlParams.id);\n\n\t\t\t\t\tif (prl) {\n\t\t\t\t\t\tconst { offset, count } = await getPaginationItems(this.queryParams);\n\t\t\t\t\t\tconst { sort, fields, query } = await this.parseJsonQuery();\n\n\t\t\t\t\t\tconst ourQuery = Object.assign({}, query, { appId: prl.getID() });\n\t\t\t\t\t\tconst options = {\n\t\t\t\t\t\t\tsort: sort || { _updatedAt: -1 },\n\t\t\t\t\t\t\tskip: offset,\n\t\t\t\t\t\t\tlimit: count,\n\t\t\t\t\t\t\tfields,\n\t\t\t\t\t\t};\n\n\t\t\t\t\t\tconst logs = await orchestrator?.getLogStorage()?.find(ourQuery, options);\n\n\t\t\t\t\t\treturn API.v1.success({ logs });\n\t\t\t\t\t}\n\t\t\t\t\treturn API.v1.notFound(`No App found by the id of: ${this.urlParams.id}`);\n\t\t\t\t},\n\t\t\t},\n\t\t);\n\n\t\tthis.api.addRoute(\n\t\t\t':id/settings',\n\t\t\t{ authRequired: true, permissionsRequired: ['manage-apps'] },\n\t\t\t{\n\t\t\t\tget() {\n\t\t\t\t\tconst prl = manager.getOneById(this.urlParams.id);\n\n\t\t\t\t\tif (prl) {\n\t\t\t\t\t\tconst settings = Object.assign({}, prl.getStorageItem().settings);\n\n\t\t\t\t\t\tObject.keys(settings).forEach((k) => {\n\t\t\t\t\t\t\tif (settings[k].hidden) {\n\t\t\t\t\t\t\t\tdelete settings[k];\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t});\n\n\t\t\t\t\t\treturn API.v1.success({ settings });\n\t\t\t\t\t}\n\t\t\t\t\treturn API.v1.notFound(`No App found by the id of: ${this.urlParams.id}`);\n\t\t\t\t},\n\t\t\t\tasync post() {\n\t\t\t\t\tif (!this.bodyParams?.settings) {\n\t\t\t\t\t\treturn API.v1.failure('The settings to update must be present.');\n\t\t\t\t\t}\n\n\t\t\t\t\tconst prl = manager.getOneById(this.urlParams.id);\n\n\t\t\t\t\tif (!prl) {\n\t\t\t\t\t\treturn API.v1.notFound(`No App found by the id of: ${this.urlParams.id}`);\n\t\t\t\t\t}\n\n\t\t\t\t\tconst { settings } = prl.getStorageItem();\n\n\t\t\t\t\tconst updated = [];\n\n\t\t\t\t\tfor await (const s of this.bodyParams.settings) {\n\t\t\t\t\t\tif (settings[s.id] && settings[s.id].value !== s.value) {\n\t\t\t\t\t\t\tawait manager.getSettingsManager().updateAppSetting(this.urlParams.id, s);\n\t\t\t\t\t\t\t// Updating?\n\t\t\t\t\t\t\tupdated.push(s);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\treturn API.v1.success({ updated });\n\t\t\t\t},\n\t\t\t},\n\t\t);\n\n\t\tthis.api.addRoute(\n\t\t\t':id/settings/:settingId',\n\t\t\t{ authRequired: true, permissionsRequired: ['manage-apps'] },\n\t\t\t{\n\t\t\t\tget() {\n\t\t\t\t\ttry {\n\t\t\t\t\t\tconst setting = manager.getSettingsManager().getAppSetting(this.urlParams.id, this.urlParams.settingId);\n\n\t\t\t\t\t\treturn API.v1.success({ setting });\n\t\t\t\t\t} catch (e: any) {\n\t\t\t\t\t\tif (e.message.includes('No setting found')) {\n\t\t\t\t\t\t\treturn API.v1.notFound(`No Setting found on the App by the id of: \"${this.urlParams.settingId}\"`);\n\t\t\t\t\t\t}\n\t\t\t\t\t\tif (e.message.includes('No App found')) {\n\t\t\t\t\t\t\treturn API.v1.notFound(`No App found by the id of: ${this.urlParams.id}`);\n\t\t\t\t\t\t}\n\t\t\t\t\t\treturn API.v1.failure(e.message);\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\tasync post() {\n\t\t\t\t\tif (!this.bodyParams.setting) {\n\t\t\t\t\t\treturn API.v1.failure('Setting to update to must be present on the posted body.');\n\t\t\t\t\t}\n\n\t\t\t\t\ttry {\n\t\t\t\t\t\tawait manager.getSettingsManager().updateAppSetting(this.urlParams.id, this.bodyParams.setting);\n\n\t\t\t\t\t\treturn API.v1.success();\n\t\t\t\t\t} catch (e: any) {\n\t\t\t\t\t\tif (e.message.includes('No setting found')) {\n\t\t\t\t\t\t\treturn API.v1.notFound(`No Setting found on the App by the id of: \"${this.urlParams.settingId}\"`);\n\t\t\t\t\t\t}\n\t\t\t\t\t\tif (e.message.includes('No App found')) {\n\t\t\t\t\t\t\treturn API.v1.notFound(`No App found by the id of: ${this.urlParams.id}`);\n\t\t\t\t\t\t}\n\t\t\t\t\t\treturn API.v1.failure(e.message);\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t},\n\t\t);\n\n\t\tthis.api.addRoute(\n\t\t\t':id/apis',\n\t\t\t{ authRequired: true, permissionsRequired: ['manage-apps'] },\n\t\t\t{\n\t\t\t\tget() {\n\t\t\t\t\tconst prl = manager.getOneById(this.urlParams.id);\n\n\t\t\t\t\tif (prl) {\n\t\t\t\t\t\treturn API.v1.success({\n\t\t\t\t\t\t\tapis: (manager as Record<string, any>).apiManager.listApis(this.urlParams.id), // TODO: this is accessing a private property from the manager, we should expose a method to get the list of APIs\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t\treturn API.v1.notFound(`No App found by the id of: ${this.urlParams.id}`);\n\t\t\t\t},\n\t\t\t},\n\t\t);\n\n\t\tthis.api.addRoute(\n\t\t\t':id/status',\n\t\t\t{ authRequired: true, permissionsRequired: ['manage-apps'] },\n\t\t\t{\n\t\t\t\tget() {\n\t\t\t\t\tconst prl = manager.getOneById(this.urlParams.id);\n\n\t\t\t\t\tif (prl) {\n\t\t\t\t\t\treturn API.v1.success({ status: prl.getStatus() });\n\t\t\t\t\t}\n\t\t\t\t\treturn API.v1.notFound(`No App found by the id of: ${this.urlParams.id}`);\n\t\t\t\t},\n\t\t\t\tasync post() {\n\t\t\t\t\tconst { id: appId } = this.urlParams;\n\t\t\t\t\tconst { status } = this.bodyParams;\n\n\t\t\t\t\tif (!status || typeof status !== 'string') {\n\t\t\t\t\t\treturn API.v1.failure('Invalid status provided, it must be \"status\" field and a string.');\n\t\t\t\t\t}\n\n\t\t\t\t\tconst prl = manager.getOneById(appId);\n\t\t\t\t\tif (!prl) {\n\t\t\t\t\t\treturn API.v1.notFound(`No App found by the id of: ${appId}`);\n\t\t\t\t\t}\n\n\t\t\t\t\tconst storedApp = prl.getStorageItem();\n\t\t\t\t\tconst { installationSource, marketplaceInfo } = storedApp;\n\n\t\t\t\t\tif (!License.hasValidLicense() && installationSource === AppInstallationSource.MARKETPLACE) {\n\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\tconst baseUrl = orchestrator.getMarketplaceUrl() as string;\n\t\t\t\t\t\t\tconst headers = getDefaultHeaders();\n\t\t\t\t\t\t\tconst { version } = prl.getInfo();\n\n\t\t\t\t\t\t\tawait appEnableCheck({\n\t\t\t\t\t\t\t\tbaseUrl,\n\t\t\t\t\t\t\t\theaders,\n\t\t\t\t\t\t\t\tappId,\n\t\t\t\t\t\t\t\tversion,\n\t\t\t\t\t\t\t\tmarketplaceInfo,\n\t\t\t\t\t\t\t\tstatus,\n\t\t\t\t\t\t\t\tlogger: orchestrator.getRocketChatLogger(),\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t} catch (error: any) {\n\t\t\t\t\t\t\treturn API.v1.failure(error.message);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\tif (AppStatusUtils.isEnabled(status) && !(await canEnableApp(storedApp))) {\n\t\t\t\t\t\treturn API.v1.failure('Enabled apps have been maxed out');\n\t\t\t\t\t}\n\n\t\t\t\t\tconst result = await manager.changeStatus(prl.getID(), status);\n\t\t\t\t\treturn API.v1.success({ status: result.getStatus() });\n\t\t\t\t},\n\t\t\t},\n\t\t);\n\n\t\tthis.api.addRoute(\n\t\t\t'app-request',\n\t\t\t{ authRequired: true },\n\t\t\t{\n\t\t\t\tasync get() {\n\t\t\t\t\tconst baseUrl = orchestrator.getMarketplaceUrl();\n\t\t\t\t\tconst { appId, q = '', sort = '', limit = 25, offset = 0 } = this.queryParams;\n\t\t\t\t\tconst headers = getDefaultHeaders();\n\n\t\t\t\t\tconst token = await getWorkspaceAccessToken();\n\t\t\t\t\tif (token) {\n\t\t\t\t\t\theaders.Authorization = `Bearer ${token}`;\n\t\t\t\t\t}\n\n\t\t\t\t\ttry {\n\t\t\t\t\t\tconst request = await fetch(`${baseUrl}/v1/app-request?appId=${appId}&q=${q}&sort=${sort}&limit=${limit}&offset=${offset}`, {\n\t\t\t\t\t\t\theaders,\n\t\t\t\t\t\t});\n\t\t\t\t\t\tconst result = await request.json();\n\n\t\t\t\t\t\tif (!request.ok) {\n\t\t\t\t\t\t\tthrow new Error(result.error);\n\t\t\t\t\t\t}\n\t\t\t\t\t\treturn API.v1.success(result);\n\t\t\t\t\t} catch (e: any) {\n\t\t\t\t\t\torchestrator.getRocketChatLogger().error('Error getting all non sent app requests from the Marketplace:', e.message);\n\n\t\t\t\t\t\treturn API.v1.failure(e.message);\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t},\n\t\t);\n\n\t\tthis.api.addRoute(\n\t\t\t'app-request/stats',\n\t\t\t{ authRequired: true },\n\t\t\t{\n\t\t\t\tasync get() {\n\t\t\t\t\tconst baseUrl = orchestrator.getMarketplaceUrl();\n\t\t\t\t\tconst headers = getDefaultHeaders();\n\n\t\t\t\t\tconst token = await getWorkspaceAccessToken();\n\t\t\t\t\tif (token) {\n\t\t\t\t\t\theaders.Authorization = `Bearer ${token}`;\n\t\t\t\t\t}\n\n\t\t\t\t\ttry {\n\t\t\t\t\t\tconst request = await fetch(`${baseUrl}/v1/app-request/stats`, { headers });\n\t\t\t\t\t\tconst result = await request.json();\n\t\t\t\t\t\tif (!request.ok) {\n\t\t\t\t\t\t\tthrow new Error(result.error);\n\t\t\t\t\t\t}\n\t\t\t\t\t\treturn API.v1.success(result);\n\t\t\t\t\t} catch (e: any) {\n\t\t\t\t\t\torchestrator.getRocketChatLogger().error('Error getting the app requests stats from marketplace', e.message);\n\n\t\t\t\t\t\treturn API.v1.failure(e.message);\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t},\n\t\t);\n\n\t\tthis.api.addRoute(\n\t\t\t'app-request/markAsSeen',\n\t\t\t{ authRequired: true },\n\t\t\t{\n\t\t\t\tasync post() {\n\t\t\t\t\tconst baseUrl = orchestrator.getMarketplaceUrl();\n\t\t\t\t\tconst headers = getDefaultHeaders();\n\n\t\t\t\t\tconst token = await getWorkspaceAccessToken();\n\t\t\t\t\tif (token) {\n\t\t\t\t\t\theaders.Authorization = `Bearer ${token}`;\n\t\t\t\t\t}\n\n\t\t\t\t\tconst { unseenRequests } = this.bodyParams;\n\n\t\t\t\t\ttry {\n\t\t\t\t\t\tconst request = await fetch(`${baseUrl}/v1/app-request/markAsSeen`, {\n\t\t\t\t\t\t\tmethod: 'POST',\n\t\t\t\t\t\t\theaders,\n\t\t\t\t\t\t\tbody: { ids: unseenRequests },\n\t\t\t\t\t\t});\n\t\t\t\t\t\tconst result = await request.json();\n\n\t\t\t\t\t\tif (!request.ok) {\n\t\t\t\t\t\t\tthrow new Error(result.error);\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\treturn API.v1.success(result);\n\t\t\t\t\t} catch (e: any) {\n\t\t\t\t\t\torchestrator.getRocketChatLogger().error('Error marking app requests as seen', e.message);\n\n\t\t\t\t\t\treturn API.v1.failure(e.message);\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t},\n\t\t);\n\t}\n}\n"]}}},"code":"!module.wrapAsync(async function (module, __reifyWaitForDeps__, __reify_async_result__) {\n  \"use strict\";\n  try {\n    let _objectSpread;\n    module.link(\"@babel/runtime/helpers/objectSpread2\", {\n      default(v) {\n        _objectSpread = v;\n      }\n    }, 0);\n    let _asyncIterator;\n    module.link(\"@babel/runtime/helpers/asyncIterator\", {\n      default(v) {\n        _asyncIterator = v;\n      }\n    }, 1);\n    module.export({\n      AppsRestApi: () => AppsRestApi\n    });\n    let AppStatus, AppStatusUtils;\n    module.link(\"@rocket.chat/apps-engine/definition/AppStatus\", {\n      AppStatus(v) {\n        AppStatus = v;\n      },\n      AppStatusUtils(v) {\n        AppStatusUtils = v;\n      }\n    }, 0);\n    let AppInstallationSource;\n    module.link(\"@rocket.chat/apps-engine/server/storage\", {\n      AppInstallationSource(v) {\n        AppInstallationSource = v;\n      }\n    }, 1);\n    let License;\n    module.link(\"@rocket.chat/license\", {\n      License(v) {\n        License = v;\n      }\n    }, 2);\n    let Settings, Users;\n    module.link(\"@rocket.chat/models\", {\n      Settings(v) {\n        Settings = v;\n      },\n      Users(v) {\n        Users = v;\n      }\n    }, 3);\n    let fetch;\n    module.link(\"@rocket.chat/server-fetch\", {\n      serverFetch(v) {\n        fetch = v;\n      }\n    }, 4);\n    let Meteor;\n    module.link(\"meteor/meteor\", {\n      Meteor(v) {\n        Meteor = v;\n      }\n    }, 5);\n    let API;\n    module.link(\"../../../../app/api/server\", {\n      API(v) {\n        API = v;\n      }\n    }, 6);\n    let getPaginationItems;\n    module.link(\"../../../../app/api/server/helpers/getPaginationItems\", {\n      getPaginationItems(v) {\n        getPaginationItems = v;\n      }\n    }, 7);\n    let getUploadFormData;\n    module.link(\"../../../../app/api/server/lib/getUploadFormData\", {\n      getUploadFormData(v) {\n        getUploadFormData = v;\n      }\n    }, 8);\n    let getWorkspaceAccessToken, getWorkspaceAccessTokenWithScope;\n    module.link(\"../../../../app/cloud/server\", {\n      getWorkspaceAccessToken(v) {\n        getWorkspaceAccessToken = v;\n      },\n      getWorkspaceAccessTokenWithScope(v) {\n        getWorkspaceAccessTokenWithScope = v;\n      }\n    }, 9);\n    let apiDeprecationLogger;\n    module.link(\"../../../../app/lib/server/lib/deprecationWarningLogger\", {\n      apiDeprecationLogger(v) {\n        apiDeprecationLogger = v;\n      }\n    }, 10);\n    let settings;\n    module.link(\"../../../../app/settings/server\", {\n      settings(v) {\n        settings = v;\n      }\n    }, 11);\n    let Info;\n    module.link(\"../../../../app/utils/rocketchat.info\", {\n      Info(v) {\n        Info = v;\n      }\n    }, 12);\n    let i18n;\n    module.link(\"../../../../server/lib/i18n\", {\n      i18n(v) {\n        i18n = v;\n      }\n    }, 13);\n    let sendMessagesToAdmins;\n    module.link(\"../../../../server/lib/sendMessagesToAdmins\", {\n      sendMessagesToAdmins(v) {\n        sendMessagesToAdmins = v;\n      }\n    }, 14);\n    let canEnableApp;\n    module.link(\"../../../app/license/server/canEnableApp\", {\n      canEnableApp(v) {\n        canEnableApp = v;\n      }\n    }, 15);\n    let formatAppInstanceForRest;\n    module.link(\"../../../lib/misc/formatAppInstanceForRest\", {\n      formatAppInstanceForRest(v) {\n        formatAppInstanceForRest = v;\n      }\n    }, 16);\n    let appEnableCheck;\n    module.link(\"../marketplace/appEnableCheck\", {\n      appEnableCheck(v) {\n        appEnableCheck = v;\n      }\n    }, 17);\n    let notifyAppInstall;\n    module.link(\"../marketplace/appInstall\", {\n      notifyAppInstall(v) {\n        notifyAppInstall = v;\n      }\n    }, 18);\n    let Apps;\n    module.link(\"../orchestrator\", {\n      Apps(v) {\n        Apps = v;\n      }\n    }, 19);\n    let actionButtonsHandler;\n    module.link(\"./endpoints/actionButtonsHandler\", {\n      actionButtonsHandler(v) {\n        actionButtonsHandler = v;\n      }\n    }, 20);\n    let appsCountHandler;\n    module.link(\"./endpoints/appsCountHandler\", {\n      appsCountHandler(v) {\n        appsCountHandler = v;\n      }\n    }, 21);\n    if (__reifyWaitForDeps__()) (await __reifyWaitForDeps__())();\n    const rocketChatVersion = Info.version;\n    const appsEngineVersionForMarketplace = Info.marketplaceApiVersion.replace(/-.*/g, '');\n    const getDefaultHeaders = () => ({\n      'X-Apps-Engine-Version': appsEngineVersionForMarketplace\n    });\n    const purchaseTypes = new Set(['buy', 'subscription']);\n    class AppsRestApi {\n      constructor(orch, manager) {\n        this.api = void 0;\n        this._orch = void 0;\n        this._manager = void 0;\n        this._orch = orch;\n        this._manager = manager;\n        void this.loadAPI();\n      }\n      async loadAPI() {\n        this.api = new API.ApiClass({\n          version: 'apps',\n          useDefaultAuth: true,\n          prettyJson: false,\n          enableCors: false,\n          auth: API.getUserAuth()\n        });\n        this.addManagementRoutes();\n      }\n      addManagementRoutes() {\n        const orchestrator = this._orch;\n        const manager = this._manager;\n        const handleError = (message, e) => {\n          // when there is no `response` field in the error, it means the request\n          // couldn't even make it to the server\n          if (!e.hasOwnProperty('response')) {\n            orchestrator.getRocketChatLogger().warn(message, e.message);\n            return API.v1.internalError('Could not reach the Marketplace');\n          }\n          orchestrator.getRocketChatLogger().error(message, e.response.data);\n          if (e.response.statusCode >= 500 && e.response.statusCode <= 599) {\n            return API.v1.internalError();\n          }\n          if (e.response.statusCode === 404) {\n            return API.v1.notFound();\n          }\n          return API.v1.failure();\n        };\n        this.api.addRoute('actionButtons', ...actionButtonsHandler(this));\n        this.api.addRoute('count', ...appsCountHandler(this));\n        this.api.addRoute('incompatibleModal', {\n          authRequired: true\n        }, {\n          async get() {\n            const baseUrl = orchestrator.getMarketplaceUrl();\n            const workspaceId = settings.get('Cloud_Workspace_Id');\n            const {\n              action,\n              appId,\n              appVersion\n            } = this.queryParams;\n            return API.v1.success({\n              url: \"\".concat(baseUrl, \"/apps/\").concat(appId, \"/incompatible/\").concat(appVersion, \"/\").concat(action, \"?workspaceId=\").concat(workspaceId, \"&rocketChatVersion=\").concat(rocketChatVersion)\n            });\n          }\n        });\n        this.api.addRoute('marketplace', {\n          authRequired: true\n        }, {\n          async get() {\n            const baseUrl = orchestrator.getMarketplaceUrl();\n            // Gets the Apps from the marketplace\n            const headers = getDefaultHeaders();\n            const token = await getWorkspaceAccessToken();\n            if (token) {\n              headers.Authorization = \"Bearer \".concat(token);\n            }\n            let result;\n            try {\n              const request = await fetch(\"\".concat(baseUrl, \"/v1/apps\"), {\n                headers,\n                params: _objectSpread({}, this.queryParams.isAdminUser === 'false' && {\n                  endUserID: this.user._id\n                })\n              });\n              if (request.status === 426) {\n                orchestrator.getRocketChatLogger().error('Workspace out of support window:', await request.json());\n                return API.v1.failure({\n                  error: 'unsupported version'\n                });\n              }\n              if (request.status !== 200) {\n                orchestrator.getRocketChatLogger().error('Error getting the Apps:', await request.json());\n                return API.v1.failure();\n              }\n              result = await request.json();\n              if (!request.ok) {\n                throw new Error(result.error);\n              }\n            } catch (e) {\n              return handleError('Unable to access Marketplace. Does the server has access to the internet?', e);\n            }\n            return API.v1.success(result);\n          }\n        });\n        this.api.addRoute('categories', {\n          authRequired: true\n        }, {\n          async get() {\n            const baseUrl = orchestrator.getMarketplaceUrl();\n            const headers = getDefaultHeaders();\n            const token = await getWorkspaceAccessToken();\n            if (token) {\n              headers.Authorization = \"Bearer \".concat(token);\n            }\n            let result;\n            try {\n              const request = await fetch(\"\".concat(baseUrl, \"/v1/categories\"), {\n                headers\n              });\n              if (request.status !== 200) {\n                orchestrator.getRocketChatLogger().error('Error getting the Apps:', await request.json());\n                return API.v1.failure();\n              }\n              result = await request.json();\n            } catch (e) {\n              return handleError('Unable to access Marketplace. Does the server has access to the internet?', e);\n            }\n            return API.v1.success(result);\n          }\n        });\n        this.api.addRoute('buildExternalUrl', {\n          authRequired: true\n        }, {\n          async get() {\n            const baseUrl = orchestrator.getMarketplaceUrl();\n            const workspaceId = settings.get('Cloud_Workspace_Id');\n            if (!this.queryParams.purchaseType || !purchaseTypes.has(this.queryParams.purchaseType)) {\n              return API.v1.failure({\n                error: 'Invalid purchase type'\n              });\n            }\n            const response = await getWorkspaceAccessTokenWithScope('marketplace:purchase');\n            if (!response.token) {\n              return API.v1.failure({\n                error: 'Unauthorized'\n              });\n            }\n            const subscribeRoute = this.queryParams.details === 'true' ? 'subscribe/details' : 'subscribe';\n            const seats = await Users.getActiveLocalUserCount();\n            return API.v1.success({\n              url: \"\".concat(baseUrl, \"/apps/\").concat(this.queryParams.appId, \"/\").concat(this.queryParams.purchaseType === 'buy' ? this.queryParams.purchaseType : subscribeRoute, \"?workspaceId=\").concat(workspaceId, \"&token=\").concat(response.token, \"&seats=\").concat(seats)\n            });\n          }\n        });\n        this.api.addRoute('installed', {\n          authRequired: true\n        }, {\n          async get() {\n            const apps = await manager.get();\n            const formatted = await Promise.all(apps.map(formatAppInstanceForRest));\n            return API.v1.success({\n              apps: formatted\n            });\n          }\n        });\n        // WE NEED TO MOVE EACH ENDPOINT HANDLER TO IT'S OWN FILE\n        this.api.addRoute('', {\n          authRequired: true,\n          permissionsRequired: ['manage-apps']\n        }, {\n          async get() {\n            const baseUrl = orchestrator.getMarketplaceUrl();\n            // Gets the Apps from the marketplace\n            if ('marketplace' in this.queryParams && this.queryParams.marketplace) {\n              apiDeprecationLogger.endpoint(this.request.route, '7.0.0', this.response, 'Use /apps/marketplace to get the apps list.');\n              const headers = getDefaultHeaders();\n              const token = await getWorkspaceAccessToken();\n              if (token) {\n                headers.Authorization = \"Bearer \".concat(token);\n              }\n              let result;\n              try {\n                const request = await fetch(\"\".concat(baseUrl, \"/v1/apps\"), {\n                  headers\n                });\n                if (request.status !== 200) {\n                  orchestrator.getRocketChatLogger().error('Error getting the Apps:', await request.json());\n                  return API.v1.failure();\n                }\n                result = await request.json();\n              } catch (e) {\n                return handleError('Unable to access Marketplace. Does the server has access to the internet?', e);\n              }\n              return API.v1.success(result);\n            }\n            if ('categories' in this.queryParams && this.queryParams.categories) {\n              apiDeprecationLogger.endpoint(this.request.route, '7.0.0', this.response, 'Use /apps/categories to get the categories list.');\n              const headers = getDefaultHeaders();\n              const token = await getWorkspaceAccessToken();\n              if (token) {\n                headers.Authorization = \"Bearer \".concat(token);\n              }\n              let result;\n              try {\n                const request = await fetch(\"\".concat(baseUrl, \"/v1/categories\"), {\n                  headers\n                });\n                if (request.status !== 200) {\n                  orchestrator.getRocketChatLogger().error('Error getting the Apps:', await request.json());\n                  return API.v1.failure();\n                }\n                result = await request.json();\n              } catch (e) {\n                orchestrator.getRocketChatLogger().error('Error getting the categories from the Marketplace:', e);\n                return API.v1.internalError();\n              }\n              return API.v1.success(result);\n            }\n            if ('buildExternalUrl' in this.queryParams && 'appId' in this.queryParams && this.queryParams.buildExternalUrl && this.queryParams.appId) {\n              apiDeprecationLogger.endpoint(this.request.route, '7.0.0', this.response, 'Use /apps/buildExternalUrl to get the modal URLs.');\n              const workspaceId = settings.get('Cloud_Workspace_Id');\n              if (!this.queryParams.purchaseType || !purchaseTypes.has(this.queryParams.purchaseType)) {\n                return API.v1.failure({\n                  error: 'Invalid purchase type'\n                });\n              }\n              const token = await getWorkspaceAccessTokenWithScope('marketplace:purchase');\n              if (!token) {\n                return API.v1.failure({\n                  error: 'Unauthorized'\n                });\n              }\n              const subscribeRoute = this.queryParams.details === 'true' ? 'subscribe/details' : 'subscribe';\n              const seats = await Users.getActiveLocalUserCount();\n              return API.v1.success({\n                url: \"\".concat(baseUrl, \"/apps/\").concat(this.queryParams.appId, \"/\").concat(this.queryParams.purchaseType === 'buy' ? this.queryParams.purchaseType : subscribeRoute, \"?workspaceId=\").concat(workspaceId, \"&token=\").concat(token.token, \"&seats=\").concat(seats)\n              });\n            }\n            apiDeprecationLogger.endpoint(this.request.route, '7.0.0', this.response, 'Use /apps/installed to get the installed apps list.');\n            const proxiedApps = await manager.get();\n            const apps = await Promise.all(proxiedApps.map(formatAppInstanceForRest));\n            return API.v1.success({\n              apps\n            });\n          },\n          async post() {\n            var _orchestrator$getConv, _orchestrator$getConv2;\n            let buff;\n            let marketplaceInfo;\n            let permissionsGranted;\n            if (this.bodyParams.url) {\n              try {\n                const response = await fetch(this.bodyParams.url);\n                if (response.status !== 200 || response.headers.get('content-type') !== 'application/zip') {\n                  return API.v1.failure({\n                    error: 'Invalid url. It doesn\\'t exist or is not \"application/zip\".'\n                  });\n                }\n                buff = await response.buffer();\n              } catch (e) {\n                orchestrator.getRocketChatLogger().error('Error getting the app from url:', e.response.data);\n                return API.v1.internalError();\n              }\n            } else if ('appId' in this.bodyParams && this.bodyParams.appId && this.bodyParams.marketplace && this.bodyParams.version) {\n              const baseUrl = orchestrator.getMarketplaceUrl();\n              const headers = getDefaultHeaders();\n              try {\n                const downloadToken = await getWorkspaceAccessToken(true, 'marketplace:download', false);\n                const marketplaceToken = await getWorkspaceAccessToken();\n                const [downloadResponse, marketplaceResponse] = await Promise.all([fetch(\"\".concat(baseUrl, \"/v2/apps/\").concat(this.bodyParams.appId, \"/download/\").concat(this.bodyParams.version, \"?token=\").concat(downloadToken), {\n                  headers\n                }), fetch(\"\".concat(baseUrl, \"/v1/apps/\").concat(this.bodyParams.appId, \"?appVersion=\").concat(this.bodyParams.version), {\n                  headers: _objectSpread({\n                    Authorization: \"Bearer \".concat(marketplaceToken)\n                  }, headers)\n                })]);\n                if (downloadResponse.headers.get('content-type') !== 'application/zip') {\n                  throw new Error('Invalid url. It doesn\\'t exist or is not \"application/zip\".');\n                }\n                buff = Buffer.from(await downloadResponse.arrayBuffer());\n                marketplaceInfo = await marketplaceResponse.json();\n                permissionsGranted = this.bodyParams.permissionsGranted;\n              } catch (err) {\n                return API.v1.failure(err.message);\n              }\n            } else {\n              const app = await getUploadFormData({\n                request: this.request\n              }, {\n                field: 'app',\n                sizeLimit: settings.get('FileUpload_MaxFileSize')\n              });\n              const {\n                fields: formData\n              } = app;\n              buff = app.fileBuffer;\n              permissionsGranted = (() => {\n                try {\n                  const permissions = JSON.parse((formData === null || formData === void 0 ? void 0 : formData.permissions) || '');\n                  return permissions.length ? permissions : undefined;\n                } catch (_unused) {\n                  return undefined;\n                }\n              })();\n            }\n            if (!buff) {\n              return API.v1.failure({\n                error: 'Failed to get a file to install for the App. '\n              });\n            }\n            // Used mostly in Cloud hosting for security reasons\n            if (!marketplaceInfo && orchestrator.shouldDisablePrivateAppInstallation()) {\n              return API.v1.internalError('private_app_install_disabled');\n            }\n            const user = orchestrator === null || orchestrator === void 0 ? void 0 : (_orchestrator$getConv = orchestrator.getConverters()) === null || _orchestrator$getConv === void 0 ? void 0 : (_orchestrator$getConv2 = _orchestrator$getConv.get('users')) === null || _orchestrator$getConv2 === void 0 ? void 0 : _orchestrator$getConv2.convertToApp(await Meteor.userAsync());\n            const aff = await manager.add(buff, {\n              marketplaceInfo,\n              permissionsGranted,\n              enable: false,\n              user\n            });\n            const info = aff.getAppInfo();\n            if (aff.hasStorageError()) {\n              return API.v1.failure({\n                status: 'storage_error',\n                messages: [aff.getStorageError()]\n              });\n            }\n            if (aff.hasAppUserError()) {\n              return API.v1.failure({\n                status: 'app_user_error',\n                messages: [aff.getAppUserError().message],\n                payload: {\n                  username: aff.getAppUserError().username\n                }\n              });\n            }\n            info.status = await aff.getApp().getStatus();\n            void notifyAppInstall(orchestrator.getMarketplaceUrl(), 'install', info);\n            if (await canEnableApp(aff.getApp().getStorageItem())) {\n              const success = await manager.enable(info.id);\n              info.status = success ? AppStatus.AUTO_ENABLED : info.status;\n            }\n            void orchestrator.getNotifier().appAdded(info.id);\n            return API.v1.success({\n              app: info,\n              implemented: aff.getImplementedInferfaces(),\n              licenseValidation: aff.getLicenseValidationResult()\n            });\n          }\n        });\n        this.api.addRoute('buildExternalAppRequest', {\n          authRequired: true\n        }, {\n          async get() {\n            var _this$user, _this$user$emails;\n            if (!this.queryParams.appId) {\n              return API.v1.failure({\n                error: 'Invalid request. Please ensure an appId is attached to the request.'\n              });\n            }\n            const baseUrl = orchestrator.getMarketplaceUrl();\n            const workspaceId = settings.get('Cloud_Workspace_Id');\n            const requester = {\n              id: this.user._id,\n              username: this.user.username,\n              name: this.user.name,\n              nickname: this.user.nickname,\n              emails: (_this$user = this.user) === null || _this$user === void 0 ? void 0 : (_this$user$emails = _this$user.emails) === null || _this$user$emails === void 0 ? void 0 : _this$user$emails.map(e => e.address)\n            };\n            let admins = [];\n            try {\n              const adminsRaw = await Users.findUsersInRoles(['admin'], undefined, {\n                projection: {\n                  username: 1,\n                  name: 1,\n                  nickname: 1\n                }\n              }).toArray();\n              admins = adminsRaw.map(a => {\n                return {\n                  id: a._id,\n                  username: a.username,\n                  name: a.name,\n                  nickname: a.nickname\n                };\n              });\n            } catch (e) {\n              orchestrator.getRocketChatLogger().error('Error getting the admins to request an app be installed:', e);\n            }\n            const queryParams = new URLSearchParams();\n            queryParams.set('workspaceId', workspaceId);\n            queryParams.set('frameworkVersion', appsEngineVersionForMarketplace);\n            queryParams.set('requester', Buffer.from(JSON.stringify(requester)).toString('base64'));\n            queryParams.set('admins', Buffer.from(JSON.stringify(admins)).toString('base64'));\n            return API.v1.success({\n              url: \"\".concat(baseUrl, \"/apps/\").concat(this.queryParams.appId, \"/requestAccess?\").concat(queryParams.toString())\n            });\n          }\n        });\n        this.api.addRoute('externalComponents', {\n          authRequired: false\n        }, {\n          get() {\n            const externalComponents = orchestrator.getProvidedComponents();\n            return API.v1.success({\n              externalComponents\n            });\n          }\n        });\n        this.api.addRoute('languages', {\n          authRequired: false\n        }, {\n          async get() {\n            const apps = (await manager.get()).map(prl => ({\n              id: prl.getID(),\n              languages: prl.getStorageItem().languageContent\n            }));\n            return API.v1.success({\n              apps\n            });\n          }\n        });\n        this.api.addRoute('externalComponentEvent', {\n          authRequired: true\n        }, {\n          post() {\n            if (!this.bodyParams.externalComponent || !this.bodyParams.event || !['IPostExternalComponentOpened', 'IPostExternalComponentClosed'].includes(this.bodyParams.event)) {\n              return API.v1.failure({\n                error: 'Event and externalComponent must be provided.'\n              });\n            }\n            try {\n              var _Apps$getBridges;\n              const {\n                event,\n                externalComponent\n              } = this.bodyParams;\n              const result = ((_Apps$getBridges = Apps.getBridges()) === null || _Apps$getBridges === void 0 ? void 0 : _Apps$getBridges.getListenerBridge()).externalComponentEvent(event, externalComponent);\n              return API.v1.success({\n                result\n              });\n            } catch (e) {\n              orchestrator.getRocketChatLogger().error(\"Error triggering external components' events \".concat(e.response.data));\n              return API.v1.internalError();\n            }\n          }\n        });\n        this.api.addRoute('bundles/:id/apps', {\n          authRequired: true,\n          permissionsRequired: ['manage-apps']\n        }, {\n          async get() {\n            const baseUrl = orchestrator.getMarketplaceUrl();\n            const headers = {};\n            const token = await getWorkspaceAccessToken();\n            if (token) {\n              headers.Authorization = \"Bearer \".concat(token);\n            }\n            let result;\n            try {\n              const request = await fetch(\"\".concat(baseUrl, \"/v1/bundles/\").concat(this.urlParams.id, \"/apps\"), {\n                headers\n              });\n              if (request.status !== 200) {\n                orchestrator.getRocketChatLogger().error(\"Error getting the Bundle's Apps from the Marketplace:\", await request.json());\n                return API.v1.failure();\n              }\n              result = await request.json();\n            } catch (e) {\n              orchestrator.getRocketChatLogger().error(\"Error getting the Bundle's Apps from the Marketplace:\", e.response.data);\n              return API.v1.internalError();\n            }\n            return API.v1.success({\n              apps: result\n            });\n          }\n        });\n        this.api.addRoute('featured-apps', {\n          authRequired: true\n        }, {\n          async get() {\n            const baseUrl = orchestrator.getMarketplaceUrl();\n            const headers = getDefaultHeaders();\n            const token = await getWorkspaceAccessToken();\n            if (token) {\n              headers.Authorization = \"Bearer \".concat(token);\n            }\n            let result;\n            try {\n              const request = await fetch(\"\".concat(baseUrl, \"/v1/featured-apps\"), {\n                headers\n              });\n              if (request.status !== 200) {\n                orchestrator.getRocketChatLogger().error('Error getting the Featured Apps from the Marketplace:', await request.json());\n                return API.v1.failure();\n              }\n              result = await request.json();\n            } catch (e) {\n              return handleError('Unable to access Marketplace. Does the server has access to the internet?', e);\n            }\n            return API.v1.success(result);\n          }\n        });\n        this.api.addRoute(':id', {\n          authRequired: true,\n          permissionsRequired: ['manage-apps']\n        }, {\n          async get() {\n            if (this.queryParams.marketplace && this.queryParams.version) {\n              const baseUrl = orchestrator.getMarketplaceUrl();\n              const headers = {}; // DO NOT ATTACH THE FRAMEWORK/ENGINE VERSION HERE.\n              const token = await getWorkspaceAccessToken();\n              if (token) {\n                headers.Authorization = \"Bearer \".concat(token);\n              }\n              let result;\n              try {\n                const request = await fetch(\"\".concat(baseUrl, \"/v1/apps/\").concat(this.urlParams.id, \"?appVersion=\").concat(this.queryParams.version), {\n                  headers\n                });\n                if (request.status !== 200) {\n                  orchestrator.getRocketChatLogger().error('Error getting the App information from the Marketplace:', await request.json());\n                  return API.v1.failure();\n                }\n                result = await request.json();\n              } catch (e) {\n                return handleError('Unable to access Marketplace. Does the server has access to the internet?', e);\n              }\n              return API.v1.success({\n                app: result[0]\n              });\n            }\n            if (this.queryParams.marketplace && this.queryParams.update && this.queryParams.appVersion) {\n              const baseUrl = orchestrator.getMarketplaceUrl();\n              const headers = getDefaultHeaders();\n              const token = await getWorkspaceAccessToken();\n              if (token) {\n                headers.Authorization = \"Bearer \".concat(token);\n              }\n              let result;\n              try {\n                const request = await fetch(\"\".concat(baseUrl, \"/v1/apps/\").concat(this.urlParams.id, \"/latest?appVersion=\").concat(this.queryParams.appVersion), {\n                  headers\n                });\n                if (request.status !== 200) {\n                  orchestrator.getRocketChatLogger().error('Error getting the App update info from the Marketplace:', await request.json());\n                  return API.v1.failure();\n                }\n                result = await request.json();\n              } catch (e) {\n                return handleError('Unable to access Marketplace. Does the server has access to the internet?', e);\n              }\n              return API.v1.success({\n                app: result\n              });\n            }\n            const app = manager.getOneById(this.urlParams.id);\n            if (!app) {\n              return API.v1.notFound(\"No App found by the id of: \".concat(this.urlParams.id));\n            }\n            return API.v1.success({\n              app: formatAppInstanceForRest(app)\n            });\n          },\n          async post() {\n            var _orchestrator$getConv3, _orchestrator$getConv4;\n            let buff;\n            let permissionsGranted;\n            let isPrivateAppUpload = false;\n            if (this.bodyParams.url) {\n              const response = await fetch(this.bodyParams.url);\n              if (response.status !== 200 || response.headers.get('content-type') !== 'application/zip') {\n                return API.v1.failure({\n                  error: 'Invalid url. It doesn\\'t exist or is not \"application/zip\".'\n                });\n              }\n              buff = Buffer.from(await response.arrayBuffer());\n            } else if (this.bodyParams.appId && this.bodyParams.marketplace && this.bodyParams.version) {\n              const baseUrl = orchestrator.getMarketplaceUrl();\n              const headers = getDefaultHeaders();\n              const token = await getWorkspaceAccessToken(true, 'marketplace:download', false);\n              try {\n                const response = await fetch(\"\".concat(baseUrl, \"/v2/apps/\").concat(this.bodyParams.appId, \"/download/\").concat(this.bodyParams.version, \"?token=\").concat(token), {\n                  headers\n                });\n                if (response.status !== 200) {\n                  orchestrator.getRocketChatLogger().error('Error getting the App from the Marketplace:', await response.text());\n                  return API.v1.failure();\n                }\n                if (response.headers.get('content-type') !== 'application/zip') {\n                  return API.v1.failure({\n                    error: 'Invalid url. It doesn\\'t exist or is not \"application/zip\".'\n                  });\n                }\n                buff = Buffer.from(await response.arrayBuffer());\n              } catch (e) {\n                orchestrator.getRocketChatLogger().error('Error getting the App from the Marketplace:', e.response.data);\n                return API.v1.internalError();\n              }\n            } else {\n              isPrivateAppUpload = true;\n              const app = await getUploadFormData({\n                request: this.request\n              }, {\n                field: 'app',\n                sizeLimit: settings.get('FileUpload_MaxFileSize')\n              });\n              const {\n                fields: formData\n              } = app;\n              buff = app.fileBuffer;\n              permissionsGranted = (() => {\n                try {\n                  const permissions = JSON.parse((formData === null || formData === void 0 ? void 0 : formData.permissions) || '');\n                  return permissions.length ? permissions : undefined;\n                } catch (_unused2) {\n                  return undefined;\n                }\n              })();\n            }\n            if (!buff) {\n              return API.v1.failure({\n                error: 'Failed to get a file to install for the App. '\n              });\n            }\n            if (isPrivateAppUpload && orchestrator.shouldDisablePrivateAppInstallation()) {\n              return API.v1.internalError('private_app_install_disabled');\n            }\n            const user = orchestrator === null || orchestrator === void 0 ? void 0 : (_orchestrator$getConv3 = orchestrator.getConverters()) === null || _orchestrator$getConv3 === void 0 ? void 0 : (_orchestrator$getConv4 = _orchestrator$getConv3.get('users')) === null || _orchestrator$getConv4 === void 0 ? void 0 : _orchestrator$getConv4.convertToApp(await Meteor.userAsync());\n            const aff = await manager.update(buff, permissionsGranted, {\n              user,\n              loadApp: true\n            });\n            const info = aff.getAppInfo();\n            if (aff.hasStorageError()) {\n              return API.v1.failure({\n                status: 'storage_error',\n                messages: [aff.getStorageError()]\n              });\n            }\n            if (aff.hasAppUserError()) {\n              return API.v1.failure({\n                status: 'app_user_error',\n                messages: [aff.getAppUserError().message],\n                payload: {\n                  username: aff.getAppUserError().username\n                }\n              });\n            }\n            info.status = await aff.getApp().getStatus();\n            void notifyAppInstall(orchestrator.getMarketplaceUrl(), 'update', info);\n            void orchestrator.getNotifier().appUpdated(info.id);\n            return API.v1.success({\n              app: info,\n              implemented: aff.getImplementedInferfaces(),\n              licenseValidation: aff.getLicenseValidationResult()\n            });\n          },\n          async delete() {\n            var _orchestrator$getConv5;\n            const prl = manager.getOneById(this.urlParams.id);\n            if (!prl) {\n              return API.v1.notFound(\"No App found by the id of: \".concat(this.urlParams.id));\n            }\n            const user = orchestrator === null || orchestrator === void 0 ? void 0 : (_orchestrator$getConv5 = orchestrator.getConverters()) === null || _orchestrator$getConv5 === void 0 ? void 0 : _orchestrator$getConv5.get('users').convertToApp(await Meteor.userAsync());\n            const info = prl.getInfo();\n            try {\n              await manager.remove(prl.getID(), {\n                user\n              });\n              info.status = AppStatus.DISABLED;\n            } catch (e) {\n              info.status = await prl.getStatus();\n              return API.v1.failure({\n                app: info\n              });\n            }\n            void notifyAppInstall(orchestrator.getMarketplaceUrl(), 'uninstall', info);\n            return API.v1.success({\n              app: info\n            });\n          }\n        });\n        this.api.addRoute(':id/versions', {\n          authRequired: true\n        }, {\n          async get() {\n            const baseUrl = orchestrator.getMarketplaceUrl();\n            const headers = {}; // DO NOT ATTACH THE FRAMEWORK/ENGINE VERSION HERE.\n            const token = await getWorkspaceAccessToken();\n            if (token) {\n              headers.Authorization = \"Bearer \".concat(token);\n            }\n            let result;\n            let statusCode;\n            try {\n              const request = await fetch(\"\".concat(baseUrl, \"/v1/apps/\").concat(this.urlParams.id), {\n                headers\n              });\n              statusCode = request.status;\n              result = await request.json();\n              if (!request.ok) {\n                throw new Error(result.error);\n              }\n            } catch (e) {\n              return handleError('Unable to access Marketplace. Does the server has access to the internet?', e);\n            }\n            if (!result || statusCode !== 200) {\n              orchestrator.getRocketChatLogger().error('Error getting the App versions from the Marketplace:', result);\n              return API.v1.failure();\n            }\n            return API.v1.success({\n              apps: result\n            });\n          }\n        });\n        this.api.addRoute('notify-admins', {\n          authRequired: true\n        }, {\n          async post() {\n            const {\n              appId,\n              appName,\n              appVersion,\n              message\n            } = this.bodyParams;\n            const workspaceUrl = settings.get('Site_Url');\n            const regex = new RegExp('\\\\/$', 'gm');\n            const safeWorkspaceUrl = workspaceUrl.replace(regex, '');\n            const learnMore = \"\".concat(safeWorkspaceUrl, \"/marketplace/explore/info/\").concat(appId, \"/\").concat(appVersion, \"/requests\");\n            try {\n              const msgs = async _ref => {\n                let {\n                  adminUser\n                } = _ref;\n                return {\n                  msg: i18n.t('App_Request_Admin_Message', {\n                    admin_name: adminUser.name || '',\n                    app_name: appName || '',\n                    user_name: \"@\".concat(this.user.username),\n                    message: message || '',\n                    learn_more: learnMore,\n                    interpolation: {\n                      escapeValue: false\n                    }\n                  })\n                };\n              };\n              await sendMessagesToAdmins({\n                msgs\n              });\n              return API.v1.success();\n            } catch (e) {\n              orchestrator.getRocketChatLogger().error('Error when notifying admins that an user requested an app:', e);\n              return API.v1.failure();\n            }\n          }\n        });\n        this.api.addRoute(':id/sync', {\n          authRequired: true,\n          permissionsRequired: ['manage-apps']\n        }, {\n          async post() {\n            const baseUrl = orchestrator.getMarketplaceUrl();\n            const headers = getDefaultHeaders();\n            const token = await getWorkspaceAccessToken();\n            if (token) {\n              headers.Authorization = \"Bearer \".concat(token);\n            }\n            const workspaceIdSetting = await Settings.findOneById('Cloud_Workspace_Id');\n            if (!workspaceIdSetting) {\n              return API.v1.failure('No workspace id found');\n            }\n            let result;\n            let statusCode;\n            try {\n              const request = await fetch(\"\".concat(baseUrl, \"/v1/workspaces/\").concat(workspaceIdSetting.value, \"/apps/\").concat(this.urlParams.id), {\n                headers\n              });\n              statusCode = request.status;\n              result = await request.json();\n              if (!request.ok) {\n                throw new Error(result.error);\n              }\n            } catch (e) {\n              orchestrator.getRocketChatLogger().error('Error syncing the App from the Marketplace:', e);\n              return API.v1.internalError();\n            }\n            if (statusCode !== 200) {\n              orchestrator.getRocketChatLogger().error('Error syncing the App from the Marketplace:', result);\n              return API.v1.failure();\n            }\n            await Apps.updateAppsMarketplaceInfo([result]);\n            return API.v1.success({\n              app: result\n            });\n          }\n        });\n        this.api.addRoute(':id/icon', {\n          authRequired: false\n        }, {\n          get() {\n            const prl = manager.getOneById(this.urlParams.id);\n            if (!prl) {\n              return API.v1.notFound(\"No App found by the id of: \".concat(this.urlParams.id));\n            }\n            const info = prl.getInfo();\n            if (!(info !== null && info !== void 0 && info.iconFileContent)) {\n              return API.v1.notFound(\"No App found by the id of: \".concat(this.urlParams.id));\n            }\n            const imageData = info.iconFileContent.split(';base64,');\n            const buf = Buffer.from(imageData[1], 'base64');\n            return {\n              statusCode: 200,\n              headers: {\n                'Content-Length': buf.length,\n                'Content-Type': imageData[0].replace('data:', '')\n              },\n              body: buf\n            };\n          }\n        });\n        this.api.addRoute(':id/screenshots', {\n          authRequired: false\n        }, {\n          async get() {\n            const baseUrl = orchestrator.getMarketplaceUrl();\n            const appId = this.urlParams.id;\n            const headers = getDefaultHeaders();\n            try {\n              const request = await fetch(\"\".concat(baseUrl, \"/v1/apps/\").concat(appId, \"/screenshots\"), {\n                headers\n              });\n              const data = await request.json();\n              return API.v1.success({\n                screenshots: data\n              });\n            } catch (e) {\n              orchestrator.getRocketChatLogger().error('Error getting the screenshots from the Marketplace:', e.message);\n              return API.v1.failure(e.message);\n            }\n          }\n        });\n        this.api.addRoute(':id/languages', {\n          authRequired: false\n        }, {\n          get() {\n            const prl = manager.getOneById(this.urlParams.id);\n            if (prl) {\n              const languages = prl.getStorageItem().languageContent || {};\n              return API.v1.success({\n                languages\n              });\n            }\n            return API.v1.notFound(\"No App found by the id of: \".concat(this.urlParams.id));\n          }\n        });\n        this.api.addRoute(':id/logs', {\n          authRequired: true,\n          permissionsRequired: ['manage-apps']\n        }, {\n          async get() {\n            const prl = manager.getOneById(this.urlParams.id);\n            if (prl) {\n              var _orchestrator$getLogS;\n              const {\n                offset,\n                count\n              } = await getPaginationItems(this.queryParams);\n              const {\n                sort,\n                fields,\n                query\n              } = await this.parseJsonQuery();\n              const ourQuery = Object.assign({}, query, {\n                appId: prl.getID()\n              });\n              const options = {\n                sort: sort || {\n                  _updatedAt: -1\n                },\n                skip: offset,\n                limit: count,\n                fields\n              };\n              const logs = await (orchestrator === null || orchestrator === void 0 ? void 0 : (_orchestrator$getLogS = orchestrator.getLogStorage()) === null || _orchestrator$getLogS === void 0 ? void 0 : _orchestrator$getLogS.find(ourQuery, options));\n              return API.v1.success({\n                logs\n              });\n            }\n            return API.v1.notFound(\"No App found by the id of: \".concat(this.urlParams.id));\n          }\n        });\n        this.api.addRoute(':id/settings', {\n          authRequired: true,\n          permissionsRequired: ['manage-apps']\n        }, {\n          get() {\n            const prl = manager.getOneById(this.urlParams.id);\n            if (prl) {\n              const settings = Object.assign({}, prl.getStorageItem().settings);\n              Object.keys(settings).forEach(k => {\n                if (settings[k].hidden) {\n                  delete settings[k];\n                }\n              });\n              return API.v1.success({\n                settings\n              });\n            }\n            return API.v1.notFound(\"No App found by the id of: \".concat(this.urlParams.id));\n          },\n          async post() {\n            var _this$bodyParams;\n            if (!((_this$bodyParams = this.bodyParams) !== null && _this$bodyParams !== void 0 && _this$bodyParams.settings)) {\n              return API.v1.failure('The settings to update must be present.');\n            }\n            const prl = manager.getOneById(this.urlParams.id);\n            if (!prl) {\n              return API.v1.notFound(\"No App found by the id of: \".concat(this.urlParams.id));\n            }\n            const {\n              settings\n            } = prl.getStorageItem();\n            const updated = [];\n            var _iteratorAbruptCompletion = false;\n            var _didIteratorError = false;\n            var _iteratorError;\n            try {\n              for (var _iterator = _asyncIterator(this.bodyParams.settings), _step; _iteratorAbruptCompletion = !(_step = await _iterator.next()).done; _iteratorAbruptCompletion = false) {\n                const s = _step.value;\n                {\n                  if (settings[s.id] && settings[s.id].value !== s.value) {\n                    await manager.getSettingsManager().updateAppSetting(this.urlParams.id, s);\n                    // Updating?\n                    updated.push(s);\n                  }\n                }\n              }\n            } catch (err) {\n              _didIteratorError = true;\n              _iteratorError = err;\n            } finally {\n              try {\n                if (_iteratorAbruptCompletion && _iterator.return != null) {\n                  await _iterator.return();\n                }\n              } finally {\n                if (_didIteratorError) {\n                  throw _iteratorError;\n                }\n              }\n            }\n            return API.v1.success({\n              updated\n            });\n          }\n        });\n        this.api.addRoute(':id/settings/:settingId', {\n          authRequired: true,\n          permissionsRequired: ['manage-apps']\n        }, {\n          get() {\n            try {\n              const setting = manager.getSettingsManager().getAppSetting(this.urlParams.id, this.urlParams.settingId);\n              return API.v1.success({\n                setting\n              });\n            } catch (e) {\n              if (e.message.includes('No setting found')) {\n                return API.v1.notFound(\"No Setting found on the App by the id of: \\\"\".concat(this.urlParams.settingId, \"\\\"\"));\n              }\n              if (e.message.includes('No App found')) {\n                return API.v1.notFound(\"No App found by the id of: \".concat(this.urlParams.id));\n              }\n              return API.v1.failure(e.message);\n            }\n          },\n          async post() {\n            if (!this.bodyParams.setting) {\n              return API.v1.failure('Setting to update to must be present on the posted body.');\n            }\n            try {\n              await manager.getSettingsManager().updateAppSetting(this.urlParams.id, this.bodyParams.setting);\n              return API.v1.success();\n            } catch (e) {\n              if (e.message.includes('No setting found')) {\n                return API.v1.notFound(\"No Setting found on the App by the id of: \\\"\".concat(this.urlParams.settingId, \"\\\"\"));\n              }\n              if (e.message.includes('No App found')) {\n                return API.v1.notFound(\"No App found by the id of: \".concat(this.urlParams.id));\n              }\n              return API.v1.failure(e.message);\n            }\n          }\n        });\n        this.api.addRoute(':id/apis', {\n          authRequired: true,\n          permissionsRequired: ['manage-apps']\n        }, {\n          get() {\n            const prl = manager.getOneById(this.urlParams.id);\n            if (prl) {\n              return API.v1.success({\n                apis: manager.apiManager.listApis(this.urlParams.id) // TODO: this is accessing a private property from the manager, we should expose a method to get the list of APIs\n              });\n            }\n            return API.v1.notFound(\"No App found by the id of: \".concat(this.urlParams.id));\n          }\n        });\n        this.api.addRoute(':id/status', {\n          authRequired: true,\n          permissionsRequired: ['manage-apps']\n        }, {\n          get() {\n            const prl = manager.getOneById(this.urlParams.id);\n            if (prl) {\n              return API.v1.success({\n                status: prl.getStatus()\n              });\n            }\n            return API.v1.notFound(\"No App found by the id of: \".concat(this.urlParams.id));\n          },\n          async post() {\n            const {\n              id: appId\n            } = this.urlParams;\n            const {\n              status\n            } = this.bodyParams;\n            if (!status || typeof status !== 'string') {\n              return API.v1.failure('Invalid status provided, it must be \"status\" field and a string.');\n            }\n            const prl = manager.getOneById(appId);\n            if (!prl) {\n              return API.v1.notFound(\"No App found by the id of: \".concat(appId));\n            }\n            const storedApp = prl.getStorageItem();\n            const {\n              installationSource,\n              marketplaceInfo\n            } = storedApp;\n            if (!License.hasValidLicense() && installationSource === AppInstallationSource.MARKETPLACE) {\n              try {\n                const baseUrl = orchestrator.getMarketplaceUrl();\n                const headers = getDefaultHeaders();\n                const {\n                  version\n                } = prl.getInfo();\n                await appEnableCheck({\n                  baseUrl,\n                  headers,\n                  appId,\n                  version,\n                  marketplaceInfo,\n                  status,\n                  logger: orchestrator.getRocketChatLogger()\n                });\n              } catch (error) {\n                return API.v1.failure(error.message);\n              }\n            }\n            if (AppStatusUtils.isEnabled(status) && !(await canEnableApp(storedApp))) {\n              return API.v1.failure('Enabled apps have been maxed out');\n            }\n            const result = await manager.changeStatus(prl.getID(), status);\n            return API.v1.success({\n              status: result.getStatus()\n            });\n          }\n        });\n        this.api.addRoute('app-request', {\n          authRequired: true\n        }, {\n          async get() {\n            const baseUrl = orchestrator.getMarketplaceUrl();\n            const {\n              appId,\n              q = '',\n              sort = '',\n              limit = 25,\n              offset = 0\n            } = this.queryParams;\n            const headers = getDefaultHeaders();\n            const token = await getWorkspaceAccessToken();\n            if (token) {\n              headers.Authorization = \"Bearer \".concat(token);\n            }\n            try {\n              const request = await fetch(\"\".concat(baseUrl, \"/v1/app-request?appId=\").concat(appId, \"&q=\").concat(q, \"&sort=\").concat(sort, \"&limit=\").concat(limit, \"&offset=\").concat(offset), {\n                headers\n              });\n              const result = await request.json();\n              if (!request.ok) {\n                throw new Error(result.error);\n              }\n              return API.v1.success(result);\n            } catch (e) {\n              orchestrator.getRocketChatLogger().error('Error getting all non sent app requests from the Marketplace:', e.message);\n              return API.v1.failure(e.message);\n            }\n          }\n        });\n        this.api.addRoute('app-request/stats', {\n          authRequired: true\n        }, {\n          async get() {\n            const baseUrl = orchestrator.getMarketplaceUrl();\n            const headers = getDefaultHeaders();\n            const token = await getWorkspaceAccessToken();\n            if (token) {\n              headers.Authorization = \"Bearer \".concat(token);\n            }\n            try {\n              const request = await fetch(\"\".concat(baseUrl, \"/v1/app-request/stats\"), {\n                headers\n              });\n              const result = await request.json();\n              if (!request.ok) {\n                throw new Error(result.error);\n              }\n              return API.v1.success(result);\n            } catch (e) {\n              orchestrator.getRocketChatLogger().error('Error getting the app requests stats from marketplace', e.message);\n              return API.v1.failure(e.message);\n            }\n          }\n        });\n        this.api.addRoute('app-request/markAsSeen', {\n          authRequired: true\n        }, {\n          async post() {\n            const baseUrl = orchestrator.getMarketplaceUrl();\n            const headers = getDefaultHeaders();\n            const token = await getWorkspaceAccessToken();\n            if (token) {\n              headers.Authorization = \"Bearer \".concat(token);\n            }\n            const {\n              unseenRequests\n            } = this.bodyParams;\n            try {\n              const request = await fetch(\"\".concat(baseUrl, \"/v1/app-request/markAsSeen\"), {\n                method: 'POST',\n                headers,\n                body: {\n                  ids: unseenRequests\n                }\n              });\n              const result = await request.json();\n              if (!request.ok) {\n                throw new Error(result.error);\n              }\n              return API.v1.success(result);\n            } catch (e) {\n              orchestrator.getRocketChatLogger().error('Error marking app requests as seen', e.message);\n              return API.v1.failure(e.message);\n            }\n          }\n        });\n      }\n    }\n    __reify_async_result__();\n  } catch (_reifyError) {\n    return __reify_async_result__(_reifyError);\n  }\n  __reify_async_result__()\n}, {\n  self: this,\n  async: false\n});","map":{"version":3,"names":["_objectSpread","module","link","default","v","_asyncIterator","export","AppsRestApi","AppStatus","AppStatusUtils","AppInstallationSource","License","Settings","Users","fetch","serverFetch","Meteor","API","getPaginationItems","getUploadFormData","getWorkspaceAccessToken","getWorkspaceAccessTokenWithScope","apiDeprecationLogger","settings","Info","i18n","sendMessagesToAdmins","canEnableApp","formatAppInstanceForRest","appEnableCheck","notifyAppInstall","Apps","actionButtonsHandler","appsCountHandler","__reifyWaitForDeps__","rocketChatVersion","version","appsEngineVersionForMarketplace","marketplaceApiVersion","replace","getDefaultHeaders","purchaseTypes","Set","constructor","orch","manager","api","_orch","_manager","loadAPI","ApiClass","useDefaultAuth","prettyJson","enableCors","auth","getUserAuth","addManagementRoutes","orchestrator","handleError","message","e","hasOwnProperty","getRocketChatLogger","warn","v1","internalError","error","response","data","statusCode","notFound","failure","addRoute","authRequired","get","baseUrl","getMarketplaceUrl","workspaceId","action","appId","appVersion","queryParams","success","url","concat","headers","token","Authorization","result","request","params","isAdminUser","endUserID","user","_id","status","json","ok","Error","purchaseType","has","subscribeRoute","details","seats","getActiveLocalUserCount","apps","formatted","Promise","all","map","permissionsRequired","marketplace","endpoint","route","categories","buildExternalUrl","proxiedApps","post","_orchestrator$getConv","_orchestrator$getConv2","buff","marketplaceInfo","permissionsGranted","bodyParams","buffer","downloadToken","marketplaceToken","downloadResponse","marketplaceResponse","Buffer","from","arrayBuffer","err","app","field","sizeLimit","fields","formData","fileBuffer","permissions","JSON","parse","length","undefined","_unused","shouldDisablePrivateAppInstallation","getConverters","convertToApp","userAsync","aff","add","enable","info","getAppInfo","hasStorageError","messages","getStorageError","hasAppUserError","getAppUserError","payload","username","getApp","getStatus","getStorageItem","id","AUTO_ENABLED","getNotifier","appAdded","implemented","getImplementedInferfaces","licenseValidation","getLicenseValidationResult","_this$user","_this$user$emails","requester","name","nickname","emails","address","admins","adminsRaw","findUsersInRoles","projection","toArray","a","URLSearchParams","set","stringify","toString","externalComponents","getProvidedComponents","prl","getID","languages","languageContent","externalComponent","event","includes","_Apps$getBridges","getBridges","getListenerBridge","externalComponentEvent","urlParams","update","getOneById","_orchestrator$getConv3","_orchestrator$getConv4","isPrivateAppUpload","text","_unused2","loadApp","appUpdated","delete","_orchestrator$getConv5","getInfo","remove","DISABLED","appName","workspaceUrl","regex","RegExp","safeWorkspaceUrl","learnMore","msgs","_ref","adminUser","msg","t","admin_name","app_name","user_name","learn_more","interpolation","escapeValue","workspaceIdSetting","findOneById","value","updateAppsMarketplaceInfo","iconFileContent","imageData","split","buf","body","screenshots","_orchestrator$getLogS","offset","count","sort","query","parseJsonQuery","ourQuery","Object","assign","options","_updatedAt","skip","limit","logs","getLogStorage","find","keys","forEach","k","hidden","_this$bodyParams","updated","_iteratorAbruptCompletion","_didIteratorError","_iteratorError","_iterator","_step","next","done","s","getSettingsManager","updateAppSetting","push","return","setting","getAppSetting","settingId","apis","apiManager","listApis","storedApp","installationSource","hasValidLicense","MARKETPLACE","logger","isEnabled","changeStatus","q","unseenRequests","method","ids","__reify_async_result__","_reifyError","self","async"],"sources":["ee/server/apps/communication/rest.ts"],"sourcesContent":["import { AppStatus, AppStatusUtils } from '@rocket.chat/apps-engine/definition/AppStatus';\nimport type { IAppInfo } from '@rocket.chat/apps-engine/definition/metadata';\nimport type { AppManager } from '@rocket.chat/apps-engine/server/AppManager';\nimport { AppInstallationSource } from '@rocket.chat/apps-engine/server/storage';\nimport type { IUser, IMessage } from '@rocket.chat/core-typings';\nimport { License } from '@rocket.chat/license';\nimport { Settings, Users } from '@rocket.chat/models';\nimport { serverFetch as fetch } from '@rocket.chat/server-fetch';\nimport { Meteor } from 'meteor/meteor';\n\nimport type { APIClass } from '../../../../app/api/server';\nimport { API } from '../../../../app/api/server';\nimport { getPaginationItems } from '../../../../app/api/server/helpers/getPaginationItems';\nimport { getUploadFormData } from '../../../../app/api/server/lib/getUploadFormData';\nimport { getWorkspaceAccessToken, getWorkspaceAccessTokenWithScope } from '../../../../app/cloud/server';\nimport { apiDeprecationLogger } from '../../../../app/lib/server/lib/deprecationWarningLogger';\nimport { settings } from '../../../../app/settings/server';\nimport { Info } from '../../../../app/utils/rocketchat.info';\nimport { i18n } from '../../../../server/lib/i18n';\nimport { sendMessagesToAdmins } from '../../../../server/lib/sendMessagesToAdmins';\nimport { canEnableApp } from '../../../app/license/server/canEnableApp';\nimport { formatAppInstanceForRest } from '../../../lib/misc/formatAppInstanceForRest';\nimport { appEnableCheck } from '../marketplace/appEnableCheck';\nimport { notifyAppInstall } from '../marketplace/appInstall';\nimport type { AppServerOrchestrator } from '../orchestrator';\nimport { Apps } from '../orchestrator';\nimport { actionButtonsHandler } from './endpoints/actionButtonsHandler';\nimport { appsCountHandler } from './endpoints/appsCountHandler';\n\nconst rocketChatVersion = Info.version;\nconst appsEngineVersionForMarketplace = Info.marketplaceApiVersion.replace(/-.*/g, '');\nconst getDefaultHeaders = (): Record<string, any> => ({\n\t'X-Apps-Engine-Version': appsEngineVersionForMarketplace,\n});\n\nconst purchaseTypes = new Set(['buy', 'subscription']);\n\nexport class AppsRestApi {\n\tpublic api: APIClass<'/apps'>;\n\n\tpublic _orch: AppServerOrchestrator;\n\n\tpublic _manager: AppManager;\n\n\tconstructor(orch: AppServerOrchestrator, manager: AppManager) {\n\t\tthis._orch = orch;\n\t\tthis._manager = manager;\n\t\tvoid this.loadAPI();\n\t}\n\n\tasync loadAPI() {\n\t\tthis.api = new API.ApiClass({\n\t\t\tversion: 'apps',\n\t\t\tuseDefaultAuth: true,\n\t\t\tprettyJson: false,\n\t\t\tenableCors: false,\n\t\t\tauth: API.getUserAuth(),\n\t\t});\n\t\tthis.addManagementRoutes();\n\t}\n\n\taddManagementRoutes() {\n\t\tconst orchestrator = this._orch;\n\t\tconst manager = this._manager;\n\n\t\tconst handleError = (message: string, e: any) => {\n\t\t\t// when there is no `response` field in the error, it means the request\n\t\t\t// couldn't even make it to the server\n\t\t\tif (!e.hasOwnProperty('response')) {\n\t\t\t\torchestrator.getRocketChatLogger().warn(message, e.message);\n\t\t\t\treturn API.v1.internalError('Could not reach the Marketplace');\n\t\t\t}\n\n\t\t\torchestrator.getRocketChatLogger().error(message, e.response.data);\n\n\t\t\tif (e.response.statusCode >= 500 && e.response.statusCode <= 599) {\n\t\t\t\treturn API.v1.internalError();\n\t\t\t}\n\n\t\t\tif (e.response.statusCode === 404) {\n\t\t\t\treturn API.v1.notFound();\n\t\t\t}\n\n\t\t\treturn API.v1.failure();\n\t\t};\n\n\t\tthis.api.addRoute('actionButtons', ...actionButtonsHandler(this));\n\t\tthis.api.addRoute('count', ...appsCountHandler(this));\n\n\t\tthis.api.addRoute(\n\t\t\t'incompatibleModal',\n\t\t\t{ authRequired: true },\n\t\t\t{\n\t\t\t\tasync get() {\n\t\t\t\t\tconst baseUrl = orchestrator.getMarketplaceUrl();\n\t\t\t\t\tconst workspaceId = settings.get('Cloud_Workspace_Id');\n\t\t\t\t\tconst { action, appId, appVersion } = this.queryParams;\n\n\t\t\t\t\treturn API.v1.success({\n\t\t\t\t\t\turl: `${baseUrl}/apps/${appId}/incompatible/${appVersion}/${action}?workspaceId=${workspaceId}&rocketChatVersion=${rocketChatVersion}`,\n\t\t\t\t\t});\n\t\t\t\t},\n\t\t\t},\n\t\t);\n\n\t\tthis.api.addRoute(\n\t\t\t'marketplace',\n\t\t\t{ authRequired: true },\n\t\t\t{\n\t\t\t\tasync get() {\n\t\t\t\t\tconst baseUrl = orchestrator.getMarketplaceUrl();\n\n\t\t\t\t\t// Gets the Apps from the marketplace\n\t\t\t\t\tconst headers = getDefaultHeaders();\n\t\t\t\t\tconst token = await getWorkspaceAccessToken();\n\t\t\t\t\tif (token) {\n\t\t\t\t\t\theaders.Authorization = `Bearer ${token}`;\n\t\t\t\t\t}\n\n\t\t\t\t\tlet result;\n\t\t\t\t\ttry {\n\t\t\t\t\t\tconst request = await fetch(`${baseUrl}/v1/apps`, {\n\t\t\t\t\t\t\theaders,\n\t\t\t\t\t\t\tparams: {\n\t\t\t\t\t\t\t\t...(this.queryParams.isAdminUser === 'false' && { endUserID: this.user._id }),\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t});\n\n\t\t\t\t\t\tif (request.status === 426) {\n\t\t\t\t\t\t\torchestrator.getRocketChatLogger().error('Workspace out of support window:', await request.json());\n\t\t\t\t\t\t\treturn API.v1.failure({ error: 'unsupported version' });\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tif (request.status !== 200) {\n\t\t\t\t\t\t\torchestrator.getRocketChatLogger().error('Error getting the Apps:', await request.json());\n\t\t\t\t\t\t\treturn API.v1.failure();\n\t\t\t\t\t\t}\n\t\t\t\t\t\tresult = await request.json();\n\n\t\t\t\t\t\tif (!request.ok) {\n\t\t\t\t\t\t\tthrow new Error(result.error);\n\t\t\t\t\t\t}\n\t\t\t\t\t} catch (e) {\n\t\t\t\t\t\treturn handleError('Unable to access Marketplace. Does the server has access to the internet?', e);\n\t\t\t\t\t}\n\n\t\t\t\t\treturn API.v1.success(result);\n\t\t\t\t},\n\t\t\t},\n\t\t);\n\n\t\tthis.api.addRoute(\n\t\t\t'categories',\n\t\t\t{ authRequired: true },\n\t\t\t{\n\t\t\t\tasync get() {\n\t\t\t\t\tconst baseUrl = orchestrator.getMarketplaceUrl();\n\n\t\t\t\t\tconst headers = getDefaultHeaders();\n\t\t\t\t\tconst token = await getWorkspaceAccessToken();\n\t\t\t\t\tif (token) {\n\t\t\t\t\t\theaders.Authorization = `Bearer ${token}`;\n\t\t\t\t\t}\n\n\t\t\t\t\tlet result;\n\t\t\t\t\ttry {\n\t\t\t\t\t\tconst request = await fetch(`${baseUrl}/v1/categories`, { headers });\n\t\t\t\t\t\tif (request.status !== 200) {\n\t\t\t\t\t\t\torchestrator.getRocketChatLogger().error('Error getting the Apps:', await request.json());\n\t\t\t\t\t\t\treturn API.v1.failure();\n\t\t\t\t\t\t}\n\t\t\t\t\t\tresult = await request.json();\n\t\t\t\t\t} catch (e: any) {\n\t\t\t\t\t\treturn handleError('Unable to access Marketplace. Does the server has access to the internet?', e);\n\t\t\t\t\t}\n\n\t\t\t\t\treturn API.v1.success(result);\n\t\t\t\t},\n\t\t\t},\n\t\t);\n\n\t\tthis.api.addRoute(\n\t\t\t'buildExternalUrl',\n\t\t\t{ authRequired: true },\n\t\t\t{\n\t\t\t\tasync get() {\n\t\t\t\t\tconst baseUrl = orchestrator.getMarketplaceUrl();\n\n\t\t\t\t\tconst workspaceId = settings.get('Cloud_Workspace_Id');\n\n\t\t\t\t\tif (!this.queryParams.purchaseType || !purchaseTypes.has(this.queryParams.purchaseType)) {\n\t\t\t\t\t\treturn API.v1.failure({ error: 'Invalid purchase type' });\n\t\t\t\t\t}\n\n\t\t\t\t\tconst response = await getWorkspaceAccessTokenWithScope('marketplace:purchase');\n\t\t\t\t\tif (!response.token) {\n\t\t\t\t\t\treturn API.v1.failure({ error: 'Unauthorized' });\n\t\t\t\t\t}\n\n\t\t\t\t\tconst subscribeRoute = this.queryParams.details === 'true' ? 'subscribe/details' : 'subscribe';\n\n\t\t\t\t\tconst seats = await Users.getActiveLocalUserCount();\n\n\t\t\t\t\treturn API.v1.success({\n\t\t\t\t\t\turl: `${baseUrl}/apps/${this.queryParams.appId}/${\n\t\t\t\t\t\t\tthis.queryParams.purchaseType === 'buy' ? this.queryParams.purchaseType : subscribeRoute\n\t\t\t\t\t\t}?workspaceId=${workspaceId}&token=${response.token}&seats=${seats}`,\n\t\t\t\t\t});\n\t\t\t\t},\n\t\t\t},\n\t\t);\n\n\t\tthis.api.addRoute(\n\t\t\t'installed',\n\t\t\t{ authRequired: true },\n\t\t\t{\n\t\t\t\tasync get() {\n\t\t\t\t\tconst apps = await manager.get();\n\t\t\t\t\tconst formatted = await Promise.all(apps.map(formatAppInstanceForRest));\n\t\t\t\t\treturn API.v1.success({ apps: formatted });\n\t\t\t\t},\n\t\t\t},\n\t\t);\n\n\t\t// WE NEED TO MOVE EACH ENDPOINT HANDLER TO IT'S OWN FILE\n\t\tthis.api.addRoute(\n\t\t\t'',\n\t\t\t{ authRequired: true, permissionsRequired: ['manage-apps'] },\n\t\t\t{\n\t\t\t\tasync get() {\n\t\t\t\t\tconst baseUrl = orchestrator.getMarketplaceUrl();\n\n\t\t\t\t\t// Gets the Apps from the marketplace\n\t\t\t\t\tif ('marketplace' in this.queryParams && this.queryParams.marketplace) {\n\t\t\t\t\t\tapiDeprecationLogger.endpoint(this.request.route, '7.0.0', this.response, 'Use /apps/marketplace to get the apps list.');\n\n\t\t\t\t\t\tconst headers = getDefaultHeaders();\n\t\t\t\t\t\tconst token = await getWorkspaceAccessToken();\n\t\t\t\t\t\tif (token) {\n\t\t\t\t\t\t\theaders.Authorization = `Bearer ${token}`;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tlet result;\n\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\tconst request = await fetch(`${baseUrl}/v1/apps`, { headers });\n\t\t\t\t\t\t\tif (request.status !== 200) {\n\t\t\t\t\t\t\t\torchestrator.getRocketChatLogger().error('Error getting the Apps:', await request.json());\n\t\t\t\t\t\t\t\treturn API.v1.failure();\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tresult = await request.json();\n\t\t\t\t\t\t} catch (e) {\n\t\t\t\t\t\t\treturn handleError('Unable to access Marketplace. Does the server has access to the internet?', e);\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\treturn API.v1.success(result);\n\t\t\t\t\t}\n\n\t\t\t\t\tif ('categories' in this.queryParams && this.queryParams.categories) {\n\t\t\t\t\t\tapiDeprecationLogger.endpoint(this.request.route, '7.0.0', this.response, 'Use /apps/categories to get the categories list.');\n\t\t\t\t\t\tconst headers = getDefaultHeaders();\n\t\t\t\t\t\tconst token = await getWorkspaceAccessToken();\n\t\t\t\t\t\tif (token) {\n\t\t\t\t\t\t\theaders.Authorization = `Bearer ${token}`;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tlet result;\n\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\tconst request = await fetch(`${baseUrl}/v1/categories`, { headers });\n\t\t\t\t\t\t\tif (request.status !== 200) {\n\t\t\t\t\t\t\t\torchestrator.getRocketChatLogger().error('Error getting the Apps:', await request.json());\n\t\t\t\t\t\t\t\treturn API.v1.failure();\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tresult = await request.json();\n\t\t\t\t\t\t} catch (e: any) {\n\t\t\t\t\t\t\torchestrator.getRocketChatLogger().error('Error getting the categories from the Marketplace:', e);\n\t\t\t\t\t\t\treturn API.v1.internalError();\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\treturn API.v1.success(result);\n\t\t\t\t\t}\n\n\t\t\t\t\tif (\n\t\t\t\t\t\t'buildExternalUrl' in this.queryParams &&\n\t\t\t\t\t\t'appId' in this.queryParams &&\n\t\t\t\t\t\tthis.queryParams.buildExternalUrl &&\n\t\t\t\t\t\tthis.queryParams.appId\n\t\t\t\t\t) {\n\t\t\t\t\t\tapiDeprecationLogger.endpoint(this.request.route, '7.0.0', this.response, 'Use /apps/buildExternalUrl to get the modal URLs.');\n\t\t\t\t\t\tconst workspaceId = settings.get('Cloud_Workspace_Id');\n\n\t\t\t\t\t\tif (!this.queryParams.purchaseType || !purchaseTypes.has(this.queryParams.purchaseType)) {\n\t\t\t\t\t\t\treturn API.v1.failure({ error: 'Invalid purchase type' });\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tconst token = await getWorkspaceAccessTokenWithScope('marketplace:purchase');\n\t\t\t\t\t\tif (!token) {\n\t\t\t\t\t\t\treturn API.v1.failure({ error: 'Unauthorized' });\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tconst subscribeRoute = this.queryParams.details === 'true' ? 'subscribe/details' : 'subscribe';\n\n\t\t\t\t\t\tconst seats = await Users.getActiveLocalUserCount();\n\n\t\t\t\t\t\treturn API.v1.success({\n\t\t\t\t\t\t\turl: `${baseUrl}/apps/${this.queryParams.appId}/${\n\t\t\t\t\t\t\t\tthis.queryParams.purchaseType === 'buy' ? this.queryParams.purchaseType : subscribeRoute\n\t\t\t\t\t\t\t}?workspaceId=${workspaceId}&token=${token.token}&seats=${seats}`,\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t\tapiDeprecationLogger.endpoint(this.request.route, '7.0.0', this.response, 'Use /apps/installed to get the installed apps list.');\n\n\t\t\t\t\tconst proxiedApps = await manager.get();\n\t\t\t\t\tconst apps = await Promise.all(proxiedApps.map(formatAppInstanceForRest));\n\n\t\t\t\t\treturn API.v1.success({ apps });\n\t\t\t\t},\n\t\t\t\tasync post() {\n\t\t\t\t\tlet buff;\n\t\t\t\t\tlet marketplaceInfo;\n\t\t\t\t\tlet permissionsGranted;\n\n\t\t\t\t\tif (this.bodyParams.url) {\n\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\tconst response = await fetch(this.bodyParams.url);\n\n\t\t\t\t\t\t\tif (response.status !== 200 || response.headers.get('content-type') !== 'application/zip') {\n\t\t\t\t\t\t\t\treturn API.v1.failure({\n\t\t\t\t\t\t\t\t\terror: 'Invalid url. It doesn\\'t exist or is not \"application/zip\".',\n\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\tbuff = await response.buffer();\n\t\t\t\t\t\t} catch (e: any) {\n\t\t\t\t\t\t\torchestrator.getRocketChatLogger().error('Error getting the app from url:', e.response.data);\n\t\t\t\t\t\t\treturn API.v1.internalError();\n\t\t\t\t\t\t}\n\t\t\t\t\t} else if ('appId' in this.bodyParams && this.bodyParams.appId && this.bodyParams.marketplace && this.bodyParams.version) {\n\t\t\t\t\t\tconst baseUrl = orchestrator.getMarketplaceUrl();\n\n\t\t\t\t\t\tconst headers = getDefaultHeaders();\n\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\tconst downloadToken = await getWorkspaceAccessToken(true, 'marketplace:download', false);\n\t\t\t\t\t\t\tconst marketplaceToken = await getWorkspaceAccessToken();\n\n\t\t\t\t\t\t\tconst [downloadResponse, marketplaceResponse] = await Promise.all([\n\t\t\t\t\t\t\t\tfetch(`${baseUrl}/v2/apps/${this.bodyParams.appId}/download/${this.bodyParams.version}?token=${downloadToken}`, {\n\t\t\t\t\t\t\t\t\theaders,\n\t\t\t\t\t\t\t\t}),\n\t\t\t\t\t\t\t\tfetch(`${baseUrl}/v1/apps/${this.bodyParams.appId}?appVersion=${this.bodyParams.version}`, {\n\t\t\t\t\t\t\t\t\theaders: {\n\t\t\t\t\t\t\t\t\t\tAuthorization: `Bearer ${marketplaceToken}`,\n\t\t\t\t\t\t\t\t\t\t...headers,\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t}),\n\t\t\t\t\t\t\t]);\n\n\t\t\t\t\t\t\tif (downloadResponse.headers.get('content-type') !== 'application/zip') {\n\t\t\t\t\t\t\t\tthrow new Error('Invalid url. It doesn\\'t exist or is not \"application/zip\".');\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\tbuff = Buffer.from(await downloadResponse.arrayBuffer());\n\t\t\t\t\t\t\tmarketplaceInfo = (await marketplaceResponse.json()) as any;\n\t\t\t\t\t\t\tpermissionsGranted = this.bodyParams.permissionsGranted;\n\t\t\t\t\t\t} catch (err: any) {\n\t\t\t\t\t\t\treturn API.v1.failure(err.message);\n\t\t\t\t\t\t}\n\t\t\t\t\t} else {\n\t\t\t\t\t\tconst app = await getUploadFormData(\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\trequest: this.request,\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t{ field: 'app', sizeLimit: settings.get('FileUpload_MaxFileSize') },\n\t\t\t\t\t\t);\n\n\t\t\t\t\t\tconst { fields: formData } = app;\n\n\t\t\t\t\t\tbuff = app.fileBuffer;\n\t\t\t\t\t\tpermissionsGranted = (() => {\n\t\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\t\tconst permissions = JSON.parse(formData?.permissions || '');\n\t\t\t\t\t\t\t\treturn permissions.length ? permissions : undefined;\n\t\t\t\t\t\t\t} catch {\n\t\t\t\t\t\t\t\treturn undefined;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t})();\n\t\t\t\t\t}\n\n\t\t\t\t\tif (!buff) {\n\t\t\t\t\t\treturn API.v1.failure({ error: 'Failed to get a file to install for the App. ' });\n\t\t\t\t\t}\n\n\t\t\t\t\t// Used mostly in Cloud hosting for security reasons\n\t\t\t\t\tif (!marketplaceInfo && orchestrator.shouldDisablePrivateAppInstallation()) {\n\t\t\t\t\t\treturn API.v1.internalError('private_app_install_disabled');\n\t\t\t\t\t}\n\n\t\t\t\t\tconst user = orchestrator\n\t\t\t\t\t\t?.getConverters()\n\t\t\t\t\t\t?.get('users')\n\t\t\t\t\t\t?.convertToApp(await Meteor.userAsync());\n\n\t\t\t\t\tconst aff = await manager.add(buff, { marketplaceInfo, permissionsGranted, enable: false, user });\n\t\t\t\t\tconst info: IAppInfo & { status?: AppStatus } = aff.getAppInfo();\n\n\t\t\t\t\tif (aff.hasStorageError()) {\n\t\t\t\t\t\treturn API.v1.failure({ status: 'storage_error', messages: [aff.getStorageError()] });\n\t\t\t\t\t}\n\n\t\t\t\t\tif (aff.hasAppUserError()) {\n\t\t\t\t\t\treturn API.v1.failure({\n\t\t\t\t\t\t\tstatus: 'app_user_error',\n\t\t\t\t\t\t\tmessages: [(aff.getAppUserError() as Record<string, any>).message],\n\t\t\t\t\t\t\tpayload: { username: (aff.getAppUserError() as Record<string, any>).username },\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\n\t\t\t\t\tinfo.status = await aff.getApp().getStatus();\n\n\t\t\t\t\tvoid notifyAppInstall(orchestrator.getMarketplaceUrl() as string, 'install', info);\n\n\t\t\t\t\tif (await canEnableApp(aff.getApp().getStorageItem())) {\n\t\t\t\t\t\tconst success = await manager.enable(info.id);\n\t\t\t\t\t\tinfo.status = success ? AppStatus.AUTO_ENABLED : info.status;\n\t\t\t\t\t}\n\n\t\t\t\t\tvoid orchestrator.getNotifier().appAdded(info.id);\n\n\t\t\t\t\treturn API.v1.success({\n\t\t\t\t\t\tapp: info,\n\t\t\t\t\t\timplemented: aff.getImplementedInferfaces(),\n\t\t\t\t\t\tlicenseValidation: aff.getLicenseValidationResult(),\n\t\t\t\t\t});\n\t\t\t\t},\n\t\t\t},\n\t\t);\n\n\t\tthis.api.addRoute(\n\t\t\t'buildExternalAppRequest',\n\t\t\t{ authRequired: true },\n\t\t\t{\n\t\t\t\tasync get() {\n\t\t\t\t\tif (!this.queryParams.appId) {\n\t\t\t\t\t\treturn API.v1.failure({ error: 'Invalid request. Please ensure an appId is attached to the request.' });\n\t\t\t\t\t}\n\n\t\t\t\t\tconst baseUrl = orchestrator.getMarketplaceUrl();\n\t\t\t\t\tconst workspaceId = settings.get<string>('Cloud_Workspace_Id');\n\n\t\t\t\t\tconst requester = {\n\t\t\t\t\t\tid: this.user._id,\n\t\t\t\t\t\tusername: this.user.username,\n\t\t\t\t\t\tname: this.user.name,\n\t\t\t\t\t\tnickname: this.user.nickname,\n\t\t\t\t\t\temails: this.user?.emails?.map((e) => e.address),\n\t\t\t\t\t};\n\n\t\t\t\t\tlet admins: {\n\t\t\t\t\t\tid: string;\n\t\t\t\t\t\tusername?: string;\n\t\t\t\t\t\tname?: string;\n\t\t\t\t\t\tnickname?: string;\n\t\t\t\t\t}[] = [];\n\t\t\t\t\ttry {\n\t\t\t\t\t\tconst adminsRaw = await Users.findUsersInRoles(['admin'], undefined, {\n\t\t\t\t\t\t\tprojection: {\n\t\t\t\t\t\t\t\tusername: 1,\n\t\t\t\t\t\t\t\tname: 1,\n\t\t\t\t\t\t\t\tnickname: 1,\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t}).toArray();\n\n\t\t\t\t\t\tadmins = adminsRaw.map((a) => {\n\t\t\t\t\t\t\treturn {\n\t\t\t\t\t\t\t\tid: a._id,\n\t\t\t\t\t\t\t\tusername: a.username,\n\t\t\t\t\t\t\t\tname: a.name,\n\t\t\t\t\t\t\t\tnickname: a.nickname,\n\t\t\t\t\t\t\t};\n\t\t\t\t\t\t});\n\t\t\t\t\t} catch (e) {\n\t\t\t\t\t\torchestrator.getRocketChatLogger().error('Error getting the admins to request an app be installed:', e);\n\t\t\t\t\t}\n\n\t\t\t\t\tconst queryParams = new URLSearchParams();\n\t\t\t\t\tqueryParams.set('workspaceId', workspaceId);\n\t\t\t\t\tqueryParams.set('frameworkVersion', appsEngineVersionForMarketplace);\n\t\t\t\t\tqueryParams.set('requester', Buffer.from(JSON.stringify(requester)).toString('base64'));\n\t\t\t\t\tqueryParams.set('admins', Buffer.from(JSON.stringify(admins)).toString('base64'));\n\n\t\t\t\t\treturn API.v1.success({\n\t\t\t\t\t\turl: `${baseUrl}/apps/${this.queryParams.appId}/requestAccess?${queryParams.toString()}`,\n\t\t\t\t\t});\n\t\t\t\t},\n\t\t\t},\n\t\t);\n\n\t\tthis.api.addRoute(\n\t\t\t'externalComponents',\n\t\t\t{ authRequired: false },\n\t\t\t{\n\t\t\t\tget() {\n\t\t\t\t\tconst externalComponents = orchestrator.getProvidedComponents();\n\n\t\t\t\t\treturn API.v1.success({ externalComponents });\n\t\t\t\t},\n\t\t\t},\n\t\t);\n\n\t\tthis.api.addRoute(\n\t\t\t'languages',\n\t\t\t{ authRequired: false },\n\t\t\t{\n\t\t\t\tasync get() {\n\t\t\t\t\tconst apps = (await manager.get()).map((prl) => ({\n\t\t\t\t\t\tid: prl.getID(),\n\t\t\t\t\t\tlanguages: prl.getStorageItem().languageContent,\n\t\t\t\t\t}));\n\n\t\t\t\t\treturn API.v1.success({ apps });\n\t\t\t\t},\n\t\t\t},\n\t\t);\n\n\t\tthis.api.addRoute(\n\t\t\t'externalComponentEvent',\n\t\t\t{ authRequired: true },\n\t\t\t{\n\t\t\t\tpost() {\n\t\t\t\t\tif (\n\t\t\t\t\t\t!this.bodyParams.externalComponent ||\n\t\t\t\t\t\t!this.bodyParams.event ||\n\t\t\t\t\t\t!['IPostExternalComponentOpened', 'IPostExternalComponentClosed'].includes(this.bodyParams.event)\n\t\t\t\t\t) {\n\t\t\t\t\t\treturn API.v1.failure({ error: 'Event and externalComponent must be provided.' });\n\t\t\t\t\t}\n\n\t\t\t\t\ttry {\n\t\t\t\t\t\tconst { event, externalComponent } = this.bodyParams;\n\t\t\t\t\t\tconst result = (Apps.getBridges()?.getListenerBridge() as Record<string, any>).externalComponentEvent(event, externalComponent);\n\n\t\t\t\t\t\treturn API.v1.success({ result });\n\t\t\t\t\t} catch (e: any) {\n\t\t\t\t\t\torchestrator.getRocketChatLogger().error(`Error triggering external components' events ${e.response.data}`);\n\t\t\t\t\t\treturn API.v1.internalError();\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t},\n\t\t);\n\n\t\tthis.api.addRoute(\n\t\t\t'bundles/:id/apps',\n\t\t\t{ authRequired: true, permissionsRequired: ['manage-apps'] },\n\t\t\t{\n\t\t\t\tasync get() {\n\t\t\t\t\tconst baseUrl = orchestrator.getMarketplaceUrl();\n\n\t\t\t\t\tconst headers: Record<string, any> = {};\n\t\t\t\t\tconst token = await getWorkspaceAccessToken();\n\t\t\t\t\tif (token) {\n\t\t\t\t\t\theaders.Authorization = `Bearer ${token}`;\n\t\t\t\t\t}\n\n\t\t\t\t\tlet result;\n\t\t\t\t\ttry {\n\t\t\t\t\t\tconst request = await fetch(`${baseUrl}/v1/bundles/${this.urlParams.id}/apps`, { headers });\n\t\t\t\t\t\tif (request.status !== 200) {\n\t\t\t\t\t\t\torchestrator.getRocketChatLogger().error(\"Error getting the Bundle's Apps from the Marketplace:\", await request.json());\n\t\t\t\t\t\t\treturn API.v1.failure();\n\t\t\t\t\t\t}\n\t\t\t\t\t\tresult = await request.json();\n\t\t\t\t\t} catch (e: any) {\n\t\t\t\t\t\torchestrator.getRocketChatLogger().error(\"Error getting the Bundle's Apps from the Marketplace:\", e.response.data);\n\t\t\t\t\t\treturn API.v1.internalError();\n\t\t\t\t\t}\n\n\t\t\t\t\treturn API.v1.success({ apps: result });\n\t\t\t\t},\n\t\t\t},\n\t\t);\n\n\t\tthis.api.addRoute(\n\t\t\t'featured-apps',\n\t\t\t{ authRequired: true },\n\t\t\t{\n\t\t\t\tasync get() {\n\t\t\t\t\tconst baseUrl = orchestrator.getMarketplaceUrl();\n\n\t\t\t\t\tconst headers = getDefaultHeaders();\n\t\t\t\t\tconst token = await getWorkspaceAccessToken();\n\t\t\t\t\tif (token) {\n\t\t\t\t\t\theaders.Authorization = `Bearer ${token}`;\n\t\t\t\t\t}\n\n\t\t\t\t\tlet result;\n\t\t\t\t\ttry {\n\t\t\t\t\t\tconst request = await fetch(`${baseUrl}/v1/featured-apps`, { headers });\n\t\t\t\t\t\tif (request.status !== 200) {\n\t\t\t\t\t\t\torchestrator.getRocketChatLogger().error('Error getting the Featured Apps from the Marketplace:', await request.json());\n\t\t\t\t\t\t\treturn API.v1.failure();\n\t\t\t\t\t\t}\n\t\t\t\t\t\tresult = await request.json();\n\t\t\t\t\t} catch (e) {\n\t\t\t\t\t\treturn handleError('Unable to access Marketplace. Does the server has access to the internet?', e);\n\t\t\t\t\t}\n\n\t\t\t\t\treturn API.v1.success(result);\n\t\t\t\t},\n\t\t\t},\n\t\t);\n\n\t\tthis.api.addRoute(\n\t\t\t':id',\n\t\t\t{ authRequired: true, permissionsRequired: ['manage-apps'] },\n\t\t\t{\n\t\t\t\tasync get() {\n\t\t\t\t\tif (this.queryParams.marketplace && this.queryParams.version) {\n\t\t\t\t\t\tconst baseUrl = orchestrator.getMarketplaceUrl();\n\n\t\t\t\t\t\tconst headers: Record<string, any> = {}; // DO NOT ATTACH THE FRAMEWORK/ENGINE VERSION HERE.\n\t\t\t\t\t\tconst token = await getWorkspaceAccessToken();\n\t\t\t\t\t\tif (token) {\n\t\t\t\t\t\t\theaders.Authorization = `Bearer ${token}`;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tlet result: any;\n\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\tconst request = await fetch(`${baseUrl}/v1/apps/${this.urlParams.id}?appVersion=${this.queryParams.version}`, { headers });\n\t\t\t\t\t\t\tif (request.status !== 200) {\n\t\t\t\t\t\t\t\torchestrator.getRocketChatLogger().error('Error getting the App information from the Marketplace:', await request.json());\n\t\t\t\t\t\t\t\treturn API.v1.failure();\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tresult = await request.json();\n\t\t\t\t\t\t} catch (e) {\n\t\t\t\t\t\t\treturn handleError('Unable to access Marketplace. Does the server has access to the internet?', e);\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\treturn API.v1.success({ app: result[0] });\n\t\t\t\t\t}\n\n\t\t\t\t\tif (this.queryParams.marketplace && this.queryParams.update && this.queryParams.appVersion) {\n\t\t\t\t\t\tconst baseUrl = orchestrator.getMarketplaceUrl();\n\n\t\t\t\t\t\tconst headers = getDefaultHeaders();\n\t\t\t\t\t\tconst token = await getWorkspaceAccessToken();\n\t\t\t\t\t\tif (token) {\n\t\t\t\t\t\t\theaders.Authorization = `Bearer ${token}`;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tlet result;\n\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\tconst request = await fetch(`${baseUrl}/v1/apps/${this.urlParams.id}/latest?appVersion=${this.queryParams.appVersion}`, {\n\t\t\t\t\t\t\t\theaders,\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\tif (request.status !== 200) {\n\t\t\t\t\t\t\t\torchestrator.getRocketChatLogger().error('Error getting the App update info from the Marketplace:', await request.json());\n\t\t\t\t\t\t\t\treturn API.v1.failure();\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tresult = await request.json();\n\t\t\t\t\t\t} catch (e) {\n\t\t\t\t\t\t\treturn handleError('Unable to access Marketplace. Does the server has access to the internet?', e);\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\treturn API.v1.success({ app: result });\n\t\t\t\t\t}\n\t\t\t\t\tconst app = manager.getOneById(this.urlParams.id);\n\t\t\t\t\tif (!app) {\n\t\t\t\t\t\treturn API.v1.notFound(`No App found by the id of: ${this.urlParams.id}`);\n\t\t\t\t\t}\n\n\t\t\t\t\treturn API.v1.success({\n\t\t\t\t\t\tapp: formatAppInstanceForRest(app),\n\t\t\t\t\t});\n\t\t\t\t},\n\t\t\t\tasync post() {\n\t\t\t\t\tlet buff;\n\t\t\t\t\tlet permissionsGranted;\n\t\t\t\t\tlet isPrivateAppUpload = false;\n\n\t\t\t\t\tif (this.bodyParams.url) {\n\t\t\t\t\t\tconst response = await fetch(this.bodyParams.url);\n\n\t\t\t\t\t\tif (response.status !== 200 || response.headers.get('content-type') !== 'application/zip') {\n\t\t\t\t\t\t\treturn API.v1.failure({\n\t\t\t\t\t\t\t\terror: 'Invalid url. It doesn\\'t exist or is not \"application/zip\".',\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tbuff = Buffer.from(await response.arrayBuffer());\n\t\t\t\t\t} else if (this.bodyParams.appId && this.bodyParams.marketplace && this.bodyParams.version) {\n\t\t\t\t\t\tconst baseUrl = orchestrator.getMarketplaceUrl();\n\n\t\t\t\t\t\tconst headers = getDefaultHeaders();\n\t\t\t\t\t\tconst token = await getWorkspaceAccessToken(true, 'marketplace:download', false);\n\n\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\tconst response = await fetch(\n\t\t\t\t\t\t\t\t`${baseUrl}/v2/apps/${this.bodyParams.appId}/download/${this.bodyParams.version}?token=${token}`,\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\theaders,\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t);\n\n\t\t\t\t\t\t\tif (response.status !== 200) {\n\t\t\t\t\t\t\t\torchestrator.getRocketChatLogger().error('Error getting the App from the Marketplace:', await response.text());\n\t\t\t\t\t\t\t\treturn API.v1.failure();\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\tif (response.headers.get('content-type') !== 'application/zip') {\n\t\t\t\t\t\t\t\treturn API.v1.failure({\n\t\t\t\t\t\t\t\t\terror: 'Invalid url. It doesn\\'t exist or is not \"application/zip\".',\n\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\tbuff = Buffer.from(await response.arrayBuffer());\n\t\t\t\t\t\t} catch (e: any) {\n\t\t\t\t\t\t\torchestrator.getRocketChatLogger().error('Error getting the App from the Marketplace:', e.response.data);\n\t\t\t\t\t\t\treturn API.v1.internalError();\n\t\t\t\t\t\t}\n\t\t\t\t\t} else {\n\t\t\t\t\t\tisPrivateAppUpload = true;\n\n\t\t\t\t\t\tconst app = await getUploadFormData(\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\trequest: this.request,\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t{ field: 'app', sizeLimit: settings.get('FileUpload_MaxFileSize') },\n\t\t\t\t\t\t);\n\n\t\t\t\t\t\tconst { fields: formData } = app;\n\n\t\t\t\t\t\tbuff = app.fileBuffer;\n\t\t\t\t\t\tpermissionsGranted = (() => {\n\t\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\t\tconst permissions = JSON.parse(formData?.permissions || '');\n\t\t\t\t\t\t\t\treturn permissions.length ? permissions : undefined;\n\t\t\t\t\t\t\t} catch {\n\t\t\t\t\t\t\t\treturn undefined;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t})();\n\t\t\t\t\t}\n\n\t\t\t\t\tif (!buff) {\n\t\t\t\t\t\treturn API.v1.failure({ error: 'Failed to get a file to install for the App. ' });\n\t\t\t\t\t}\n\n\t\t\t\t\tif (isPrivateAppUpload && orchestrator.shouldDisablePrivateAppInstallation()) {\n\t\t\t\t\t\treturn API.v1.internalError('private_app_install_disabled');\n\t\t\t\t\t}\n\n\t\t\t\t\tconst user = orchestrator\n\t\t\t\t\t\t?.getConverters()\n\t\t\t\t\t\t?.get('users')\n\t\t\t\t\t\t?.convertToApp(await Meteor.userAsync());\n\n\t\t\t\t\tconst aff = await manager.update(buff, permissionsGranted, { user, loadApp: true });\n\t\t\t\t\tconst info: IAppInfo & { status?: AppStatus } = aff.getAppInfo();\n\n\t\t\t\t\tif (aff.hasStorageError()) {\n\t\t\t\t\t\treturn API.v1.failure({ status: 'storage_error', messages: [aff.getStorageError()] });\n\t\t\t\t\t}\n\n\t\t\t\t\tif (aff.hasAppUserError()) {\n\t\t\t\t\t\treturn API.v1.failure({\n\t\t\t\t\t\t\tstatus: 'app_user_error',\n\t\t\t\t\t\t\tmessages: [(aff.getAppUserError() as Record<string, any>).message],\n\t\t\t\t\t\t\tpayload: { username: (aff.getAppUserError() as Record<string, any>).username },\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\n\t\t\t\t\tinfo.status = await aff.getApp().getStatus();\n\n\t\t\t\t\tvoid notifyAppInstall(orchestrator.getMarketplaceUrl() as string, 'update', info);\n\n\t\t\t\t\tvoid orchestrator.getNotifier().appUpdated(info.id);\n\n\t\t\t\t\treturn API.v1.success({\n\t\t\t\t\t\tapp: info,\n\t\t\t\t\t\timplemented: aff.getImplementedInferfaces(),\n\t\t\t\t\t\tlicenseValidation: aff.getLicenseValidationResult(),\n\t\t\t\t\t});\n\t\t\t\t},\n\t\t\t\tasync delete() {\n\t\t\t\t\tconst prl = manager.getOneById(this.urlParams.id);\n\n\t\t\t\t\tif (!prl) {\n\t\t\t\t\t\treturn API.v1.notFound(`No App found by the id of: ${this.urlParams.id}`);\n\t\t\t\t\t}\n\n\t\t\t\t\tconst user = orchestrator\n\t\t\t\t\t\t?.getConverters()\n\t\t\t\t\t\t?.get('users')\n\t\t\t\t\t\t.convertToApp(await Meteor.userAsync());\n\n\t\t\t\t\tconst info: IAppInfo & { status?: AppStatus } = prl.getInfo();\n\t\t\t\t\ttry {\n\t\t\t\t\t\tawait manager.remove(prl.getID(), { user });\n\t\t\t\t\t\tinfo.status = AppStatus.DISABLED;\n\t\t\t\t\t} catch (e) {\n\t\t\t\t\t\tinfo.status = await prl.getStatus();\n\t\t\t\t\t\treturn API.v1.failure({ app: info });\n\t\t\t\t\t}\n\n\t\t\t\t\tvoid notifyAppInstall(orchestrator.getMarketplaceUrl() as string, 'uninstall', info);\n\n\t\t\t\t\treturn API.v1.success({ app: info });\n\t\t\t\t},\n\t\t\t},\n\t\t);\n\n\t\tthis.api.addRoute(\n\t\t\t':id/versions',\n\t\t\t{ authRequired: true },\n\t\t\t{\n\t\t\t\tasync get() {\n\t\t\t\t\tconst baseUrl = orchestrator.getMarketplaceUrl();\n\n\t\t\t\t\tconst headers: Record<string, any> = {}; // DO NOT ATTACH THE FRAMEWORK/ENGINE VERSION HERE.\n\t\t\t\t\tconst token = await getWorkspaceAccessToken();\n\t\t\t\t\tif (token) {\n\t\t\t\t\t\theaders.Authorization = `Bearer ${token}`;\n\t\t\t\t\t}\n\n\t\t\t\t\tlet result;\n\t\t\t\t\tlet statusCode;\n\t\t\t\t\ttry {\n\t\t\t\t\t\tconst request = await fetch(`${baseUrl}/v1/apps/${this.urlParams.id}`, { headers });\n\t\t\t\t\t\tstatusCode = request.status;\n\t\t\t\t\t\tresult = await request.json();\n\n\t\t\t\t\t\tif (!request.ok) {\n\t\t\t\t\t\t\tthrow new Error(result.error);\n\t\t\t\t\t\t}\n\t\t\t\t\t} catch (e) {\n\t\t\t\t\t\treturn handleError('Unable to access Marketplace. Does the server has access to the internet?', e);\n\t\t\t\t\t}\n\n\t\t\t\t\tif (!result || statusCode !== 200) {\n\t\t\t\t\t\torchestrator.getRocketChatLogger().error('Error getting the App versions from the Marketplace:', result);\n\t\t\t\t\t\treturn API.v1.failure();\n\t\t\t\t\t}\n\n\t\t\t\t\treturn API.v1.success({ apps: result });\n\t\t\t\t},\n\t\t\t},\n\t\t);\n\n\t\tthis.api.addRoute(\n\t\t\t'notify-admins',\n\t\t\t{ authRequired: true },\n\t\t\t{\n\t\t\t\tasync post() {\n\t\t\t\t\tconst { appId, appName, appVersion, message } = this.bodyParams;\n\t\t\t\t\tconst workspaceUrl = settings.get<string>('Site_Url');\n\n\t\t\t\t\tconst regex = new RegExp('\\\\/$', 'gm');\n\t\t\t\t\tconst safeWorkspaceUrl = workspaceUrl.replace(regex, '');\n\t\t\t\t\tconst learnMore = `${safeWorkspaceUrl}/marketplace/explore/info/${appId}/${appVersion}/requests`;\n\n\t\t\t\t\ttry {\n\t\t\t\t\t\tconst msgs: (params: { adminUser: IUser }) => Promise<Partial<IMessage>> = async ({ adminUser }) => {\n\t\t\t\t\t\t\treturn {\n\t\t\t\t\t\t\t\tmsg: i18n.t('App_Request_Admin_Message', {\n\t\t\t\t\t\t\t\t\tadmin_name: adminUser.name || '',\n\t\t\t\t\t\t\t\t\tapp_name: appName || '',\n\t\t\t\t\t\t\t\t\tuser_name: `@${this.user.username}`,\n\t\t\t\t\t\t\t\t\tmessage: message || '',\n\t\t\t\t\t\t\t\t\tlearn_more: learnMore,\n\t\t\t\t\t\t\t\t\tinterpolation: { escapeValue: false },\n\t\t\t\t\t\t\t\t}),\n\t\t\t\t\t\t\t};\n\t\t\t\t\t\t};\n\n\t\t\t\t\t\tawait sendMessagesToAdmins({ msgs });\n\n\t\t\t\t\t\treturn API.v1.success();\n\t\t\t\t\t} catch (e) {\n\t\t\t\t\t\torchestrator.getRocketChatLogger().error('Error when notifying admins that an user requested an app:', e);\n\t\t\t\t\t\treturn API.v1.failure();\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t},\n\t\t);\n\n\t\tthis.api.addRoute(\n\t\t\t':id/sync',\n\t\t\t{ authRequired: true, permissionsRequired: ['manage-apps'] },\n\t\t\t{\n\t\t\t\tasync post() {\n\t\t\t\t\tconst baseUrl = orchestrator.getMarketplaceUrl();\n\n\t\t\t\t\tconst headers = getDefaultHeaders();\n\t\t\t\t\tconst token = await getWorkspaceAccessToken();\n\t\t\t\t\tif (token) {\n\t\t\t\t\t\theaders.Authorization = `Bearer ${token}`;\n\t\t\t\t\t}\n\n\t\t\t\t\tconst workspaceIdSetting = await Settings.findOneById('Cloud_Workspace_Id');\n\t\t\t\t\tif (!workspaceIdSetting) {\n\t\t\t\t\t\treturn API.v1.failure('No workspace id found');\n\t\t\t\t\t}\n\n\t\t\t\t\tlet result;\n\t\t\t\t\tlet statusCode;\n\t\t\t\t\ttry {\n\t\t\t\t\t\tconst request = await fetch(`${baseUrl}/v1/workspaces/${workspaceIdSetting.value}/apps/${this.urlParams.id}`, { headers });\n\t\t\t\t\t\tstatusCode = request.status;\n\t\t\t\t\t\tresult = await request.json();\n\n\t\t\t\t\t\tif (!request.ok) {\n\t\t\t\t\t\t\tthrow new Error(result.error);\n\t\t\t\t\t\t}\n\t\t\t\t\t} catch (e: any) {\n\t\t\t\t\t\torchestrator.getRocketChatLogger().error('Error syncing the App from the Marketplace:', e);\n\t\t\t\t\t\treturn API.v1.internalError();\n\t\t\t\t\t}\n\n\t\t\t\t\tif (statusCode !== 200) {\n\t\t\t\t\t\torchestrator.getRocketChatLogger().error('Error syncing the App from the Marketplace:', result);\n\t\t\t\t\t\treturn API.v1.failure();\n\t\t\t\t\t}\n\n\t\t\t\t\tawait Apps.updateAppsMarketplaceInfo([result]);\n\n\t\t\t\t\treturn API.v1.success({ app: result });\n\t\t\t\t},\n\t\t\t},\n\t\t);\n\n\t\tthis.api.addRoute(\n\t\t\t':id/icon',\n\t\t\t{ authRequired: false },\n\t\t\t{\n\t\t\t\tget() {\n\t\t\t\t\tconst prl = manager.getOneById(this.urlParams.id);\n\t\t\t\t\tif (!prl) {\n\t\t\t\t\t\treturn API.v1.notFound(`No App found by the id of: ${this.urlParams.id}`);\n\t\t\t\t\t}\n\n\t\t\t\t\tconst info = prl.getInfo();\n\t\t\t\t\tif (!info?.iconFileContent) {\n\t\t\t\t\t\treturn API.v1.notFound(`No App found by the id of: ${this.urlParams.id}`);\n\t\t\t\t\t}\n\n\t\t\t\t\tconst imageData = info.iconFileContent.split(';base64,');\n\n\t\t\t\t\tconst buf = Buffer.from(imageData[1], 'base64');\n\n\t\t\t\t\treturn {\n\t\t\t\t\t\tstatusCode: 200,\n\t\t\t\t\t\theaders: {\n\t\t\t\t\t\t\t'Content-Length': buf.length,\n\t\t\t\t\t\t\t'Content-Type': imageData[0].replace('data:', ''),\n\t\t\t\t\t\t},\n\t\t\t\t\t\tbody: buf,\n\t\t\t\t\t};\n\t\t\t\t},\n\t\t\t},\n\t\t);\n\n\t\tthis.api.addRoute(\n\t\t\t':id/screenshots',\n\t\t\t{ authRequired: false },\n\t\t\t{\n\t\t\t\tasync get() {\n\t\t\t\t\tconst baseUrl = orchestrator.getMarketplaceUrl();\n\t\t\t\t\tconst appId = this.urlParams.id;\n\t\t\t\t\tconst headers = getDefaultHeaders();\n\n\t\t\t\t\ttry {\n\t\t\t\t\t\tconst request = await fetch(`${baseUrl}/v1/apps/${appId}/screenshots`, { headers });\n\t\t\t\t\t\tconst data = await request.json();\n\n\t\t\t\t\t\treturn API.v1.success({\n\t\t\t\t\t\t\tscreenshots: data,\n\t\t\t\t\t\t});\n\t\t\t\t\t} catch (e: any) {\n\t\t\t\t\t\torchestrator.getRocketChatLogger().error('Error getting the screenshots from the Marketplace:', e.message);\n\t\t\t\t\t\treturn API.v1.failure(e.message);\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t},\n\t\t);\n\n\t\tthis.api.addRoute(\n\t\t\t':id/languages',\n\t\t\t{ authRequired: false },\n\t\t\t{\n\t\t\t\tget() {\n\t\t\t\t\tconst prl = manager.getOneById(this.urlParams.id);\n\n\t\t\t\t\tif (prl) {\n\t\t\t\t\t\tconst languages = prl.getStorageItem().languageContent || {};\n\n\t\t\t\t\t\treturn API.v1.success({ languages });\n\t\t\t\t\t}\n\t\t\t\t\treturn API.v1.notFound(`No App found by the id of: ${this.urlParams.id}`);\n\t\t\t\t},\n\t\t\t},\n\t\t);\n\n\t\tthis.api.addRoute(\n\t\t\t':id/logs',\n\t\t\t{ authRequired: true, permissionsRequired: ['manage-apps'] },\n\t\t\t{\n\t\t\t\tasync get() {\n\t\t\t\t\tconst prl = manager.getOneById(this.urlParams.id);\n\n\t\t\t\t\tif (prl) {\n\t\t\t\t\t\tconst { offset, count } = await getPaginationItems(this.queryParams);\n\t\t\t\t\t\tconst { sort, fields, query } = await this.parseJsonQuery();\n\n\t\t\t\t\t\tconst ourQuery = Object.assign({}, query, { appId: prl.getID() });\n\t\t\t\t\t\tconst options = {\n\t\t\t\t\t\t\tsort: sort || { _updatedAt: -1 },\n\t\t\t\t\t\t\tskip: offset,\n\t\t\t\t\t\t\tlimit: count,\n\t\t\t\t\t\t\tfields,\n\t\t\t\t\t\t};\n\n\t\t\t\t\t\tconst logs = await orchestrator?.getLogStorage()?.find(ourQuery, options);\n\n\t\t\t\t\t\treturn API.v1.success({ logs });\n\t\t\t\t\t}\n\t\t\t\t\treturn API.v1.notFound(`No App found by the id of: ${this.urlParams.id}`);\n\t\t\t\t},\n\t\t\t},\n\t\t);\n\n\t\tthis.api.addRoute(\n\t\t\t':id/settings',\n\t\t\t{ authRequired: true, permissionsRequired: ['manage-apps'] },\n\t\t\t{\n\t\t\t\tget() {\n\t\t\t\t\tconst prl = manager.getOneById(this.urlParams.id);\n\n\t\t\t\t\tif (prl) {\n\t\t\t\t\t\tconst settings = Object.assign({}, prl.getStorageItem().settings);\n\n\t\t\t\t\t\tObject.keys(settings).forEach((k) => {\n\t\t\t\t\t\t\tif (settings[k].hidden) {\n\t\t\t\t\t\t\t\tdelete settings[k];\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t});\n\n\t\t\t\t\t\treturn API.v1.success({ settings });\n\t\t\t\t\t}\n\t\t\t\t\treturn API.v1.notFound(`No App found by the id of: ${this.urlParams.id}`);\n\t\t\t\t},\n\t\t\t\tasync post() {\n\t\t\t\t\tif (!this.bodyParams?.settings) {\n\t\t\t\t\t\treturn API.v1.failure('The settings to update must be present.');\n\t\t\t\t\t}\n\n\t\t\t\t\tconst prl = manager.getOneById(this.urlParams.id);\n\n\t\t\t\t\tif (!prl) {\n\t\t\t\t\t\treturn API.v1.notFound(`No App found by the id of: ${this.urlParams.id}`);\n\t\t\t\t\t}\n\n\t\t\t\t\tconst { settings } = prl.getStorageItem();\n\n\t\t\t\t\tconst updated = [];\n\n\t\t\t\t\tfor await (const s of this.bodyParams.settings) {\n\t\t\t\t\t\tif (settings[s.id] && settings[s.id].value !== s.value) {\n\t\t\t\t\t\t\tawait manager.getSettingsManager().updateAppSetting(this.urlParams.id, s);\n\t\t\t\t\t\t\t// Updating?\n\t\t\t\t\t\t\tupdated.push(s);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\treturn API.v1.success({ updated });\n\t\t\t\t},\n\t\t\t},\n\t\t);\n\n\t\tthis.api.addRoute(\n\t\t\t':id/settings/:settingId',\n\t\t\t{ authRequired: true, permissionsRequired: ['manage-apps'] },\n\t\t\t{\n\t\t\t\tget() {\n\t\t\t\t\ttry {\n\t\t\t\t\t\tconst setting = manager.getSettingsManager().getAppSetting(this.urlParams.id, this.urlParams.settingId);\n\n\t\t\t\t\t\treturn API.v1.success({ setting });\n\t\t\t\t\t} catch (e: any) {\n\t\t\t\t\t\tif (e.message.includes('No setting found')) {\n\t\t\t\t\t\t\treturn API.v1.notFound(`No Setting found on the App by the id of: \"${this.urlParams.settingId}\"`);\n\t\t\t\t\t\t}\n\t\t\t\t\t\tif (e.message.includes('No App found')) {\n\t\t\t\t\t\t\treturn API.v1.notFound(`No App found by the id of: ${this.urlParams.id}`);\n\t\t\t\t\t\t}\n\t\t\t\t\t\treturn API.v1.failure(e.message);\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\tasync post() {\n\t\t\t\t\tif (!this.bodyParams.setting) {\n\t\t\t\t\t\treturn API.v1.failure('Setting to update to must be present on the posted body.');\n\t\t\t\t\t}\n\n\t\t\t\t\ttry {\n\t\t\t\t\t\tawait manager.getSettingsManager().updateAppSetting(this.urlParams.id, this.bodyParams.setting);\n\n\t\t\t\t\t\treturn API.v1.success();\n\t\t\t\t\t} catch (e: any) {\n\t\t\t\t\t\tif (e.message.includes('No setting found')) {\n\t\t\t\t\t\t\treturn API.v1.notFound(`No Setting found on the App by the id of: \"${this.urlParams.settingId}\"`);\n\t\t\t\t\t\t}\n\t\t\t\t\t\tif (e.message.includes('No App found')) {\n\t\t\t\t\t\t\treturn API.v1.notFound(`No App found by the id of: ${this.urlParams.id}`);\n\t\t\t\t\t\t}\n\t\t\t\t\t\treturn API.v1.failure(e.message);\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t},\n\t\t);\n\n\t\tthis.api.addRoute(\n\t\t\t':id/apis',\n\t\t\t{ authRequired: true, permissionsRequired: ['manage-apps'] },\n\t\t\t{\n\t\t\t\tget() {\n\t\t\t\t\tconst prl = manager.getOneById(this.urlParams.id);\n\n\t\t\t\t\tif (prl) {\n\t\t\t\t\t\treturn API.v1.success({\n\t\t\t\t\t\t\tapis: (manager as Record<string, any>).apiManager.listApis(this.urlParams.id), // TODO: this is accessing a private property from the manager, we should expose a method to get the list of APIs\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t\treturn API.v1.notFound(`No App found by the id of: ${this.urlParams.id}`);\n\t\t\t\t},\n\t\t\t},\n\t\t);\n\n\t\tthis.api.addRoute(\n\t\t\t':id/status',\n\t\t\t{ authRequired: true, permissionsRequired: ['manage-apps'] },\n\t\t\t{\n\t\t\t\tget() {\n\t\t\t\t\tconst prl = manager.getOneById(this.urlParams.id);\n\n\t\t\t\t\tif (prl) {\n\t\t\t\t\t\treturn API.v1.success({ status: prl.getStatus() });\n\t\t\t\t\t}\n\t\t\t\t\treturn API.v1.notFound(`No App found by the id of: ${this.urlParams.id}`);\n\t\t\t\t},\n\t\t\t\tasync post() {\n\t\t\t\t\tconst { id: appId } = this.urlParams;\n\t\t\t\t\tconst { status } = this.bodyParams;\n\n\t\t\t\t\tif (!status || typeof status !== 'string') {\n\t\t\t\t\t\treturn API.v1.failure('Invalid status provided, it must be \"status\" field and a string.');\n\t\t\t\t\t}\n\n\t\t\t\t\tconst prl = manager.getOneById(appId);\n\t\t\t\t\tif (!prl) {\n\t\t\t\t\t\treturn API.v1.notFound(`No App found by the id of: ${appId}`);\n\t\t\t\t\t}\n\n\t\t\t\t\tconst storedApp = prl.getStorageItem();\n\t\t\t\t\tconst { installationSource, marketplaceInfo } = storedApp;\n\n\t\t\t\t\tif (!License.hasValidLicense() && installationSource === AppInstallationSource.MARKETPLACE) {\n\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\tconst baseUrl = orchestrator.getMarketplaceUrl() as string;\n\t\t\t\t\t\t\tconst headers = getDefaultHeaders();\n\t\t\t\t\t\t\tconst { version } = prl.getInfo();\n\n\t\t\t\t\t\t\tawait appEnableCheck({\n\t\t\t\t\t\t\t\tbaseUrl,\n\t\t\t\t\t\t\t\theaders,\n\t\t\t\t\t\t\t\tappId,\n\t\t\t\t\t\t\t\tversion,\n\t\t\t\t\t\t\t\tmarketplaceInfo,\n\t\t\t\t\t\t\t\tstatus,\n\t\t\t\t\t\t\t\tlogger: orchestrator.getRocketChatLogger(),\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t} catch (error: any) {\n\t\t\t\t\t\t\treturn API.v1.failure(error.message);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\tif (AppStatusUtils.isEnabled(status) && !(await canEnableApp(storedApp))) {\n\t\t\t\t\t\treturn API.v1.failure('Enabled apps have been maxed out');\n\t\t\t\t\t}\n\n\t\t\t\t\tconst result = await manager.changeStatus(prl.getID(), status);\n\t\t\t\t\treturn API.v1.success({ status: result.getStatus() });\n\t\t\t\t},\n\t\t\t},\n\t\t);\n\n\t\tthis.api.addRoute(\n\t\t\t'app-request',\n\t\t\t{ authRequired: true },\n\t\t\t{\n\t\t\t\tasync get() {\n\t\t\t\t\tconst baseUrl = orchestrator.getMarketplaceUrl();\n\t\t\t\t\tconst { appId, q = '', sort = '', limit = 25, offset = 0 } = this.queryParams;\n\t\t\t\t\tconst headers = getDefaultHeaders();\n\n\t\t\t\t\tconst token = await getWorkspaceAccessToken();\n\t\t\t\t\tif (token) {\n\t\t\t\t\t\theaders.Authorization = `Bearer ${token}`;\n\t\t\t\t\t}\n\n\t\t\t\t\ttry {\n\t\t\t\t\t\tconst request = await fetch(`${baseUrl}/v1/app-request?appId=${appId}&q=${q}&sort=${sort}&limit=${limit}&offset=${offset}`, {\n\t\t\t\t\t\t\theaders,\n\t\t\t\t\t\t});\n\t\t\t\t\t\tconst result = await request.json();\n\n\t\t\t\t\t\tif (!request.ok) {\n\t\t\t\t\t\t\tthrow new Error(result.error);\n\t\t\t\t\t\t}\n\t\t\t\t\t\treturn API.v1.success(result);\n\t\t\t\t\t} catch (e: any) {\n\t\t\t\t\t\torchestrator.getRocketChatLogger().error('Error getting all non sent app requests from the Marketplace:', e.message);\n\n\t\t\t\t\t\treturn API.v1.failure(e.message);\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t},\n\t\t);\n\n\t\tthis.api.addRoute(\n\t\t\t'app-request/stats',\n\t\t\t{ authRequired: true },\n\t\t\t{\n\t\t\t\tasync get() {\n\t\t\t\t\tconst baseUrl = orchestrator.getMarketplaceUrl();\n\t\t\t\t\tconst headers = getDefaultHeaders();\n\n\t\t\t\t\tconst token = await getWorkspaceAccessToken();\n\t\t\t\t\tif (token) {\n\t\t\t\t\t\theaders.Authorization = `Bearer ${token}`;\n\t\t\t\t\t}\n\n\t\t\t\t\ttry {\n\t\t\t\t\t\tconst request = await fetch(`${baseUrl}/v1/app-request/stats`, { headers });\n\t\t\t\t\t\tconst result = await request.json();\n\t\t\t\t\t\tif (!request.ok) {\n\t\t\t\t\t\t\tthrow new Error(result.error);\n\t\t\t\t\t\t}\n\t\t\t\t\t\treturn API.v1.success(result);\n\t\t\t\t\t} catch (e: any) {\n\t\t\t\t\t\torchestrator.getRocketChatLogger().error('Error getting the app requests stats from marketplace', e.message);\n\n\t\t\t\t\t\treturn API.v1.failure(e.message);\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t},\n\t\t);\n\n\t\tthis.api.addRoute(\n\t\t\t'app-request/markAsSeen',\n\t\t\t{ authRequired: true },\n\t\t\t{\n\t\t\t\tasync post() {\n\t\t\t\t\tconst baseUrl = orchestrator.getMarketplaceUrl();\n\t\t\t\t\tconst headers = getDefaultHeaders();\n\n\t\t\t\t\tconst token = await getWorkspaceAccessToken();\n\t\t\t\t\tif (token) {\n\t\t\t\t\t\theaders.Authorization = `Bearer ${token}`;\n\t\t\t\t\t}\n\n\t\t\t\t\tconst { unseenRequests } = this.bodyParams;\n\n\t\t\t\t\ttry {\n\t\t\t\t\t\tconst request = await fetch(`${baseUrl}/v1/app-request/markAsSeen`, {\n\t\t\t\t\t\t\tmethod: 'POST',\n\t\t\t\t\t\t\theaders,\n\t\t\t\t\t\t\tbody: { ids: unseenRequests },\n\t\t\t\t\t\t});\n\t\t\t\t\t\tconst result = await request.json();\n\n\t\t\t\t\t\tif (!request.ok) {\n\t\t\t\t\t\t\tthrow new Error(result.error);\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\treturn API.v1.success(result);\n\t\t\t\t\t} catch (e: any) {\n\t\t\t\t\t\torchestrator.getRocketChatLogger().error('Error marking app requests as seen', e.message);\n\n\t\t\t\t\t\treturn API.v1.failure(e.message);\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t},\n\t\t);\n\t}\n}\n"],"mappings":"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","ignoreList":[]},"sourceType":"module","externalDependencies":{},"hash":"a6cd7ce432bd54b07da3033eefe47bdbb48bbc14"}
