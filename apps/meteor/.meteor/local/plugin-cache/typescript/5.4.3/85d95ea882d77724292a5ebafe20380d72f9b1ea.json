{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/server/models/raw/VoipRoom.ts","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","topLevelAwait","objectRestSpread","objectRestSpread","asyncGenerators","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"os.osx.arm64"},"sourceFileName":"server/models/raw/VoipRoom.ts","filename":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/server/models/raw/VoipRoom.ts","inputSourceMap":{"version":3,"file":"server/models/raw/VoipRoom.ts","sourceRoot":"","sources":["server/models/raw/VoipRoom.ts"],"names":[],"mappings":"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","sourcesContent":["import { type IVoipRoomClosingInfo, type IVoipRoom, type RocketChatRecordDeleted, UserStatus } from '@rocket.chat/core-typings';\nimport { Logger } from '@rocket.chat/logger';\nimport type { FindPaginated, IVoipRoomModel } from '@rocket.chat/model-typings';\nimport { escapeRegExp } from '@rocket.chat/string-helpers';\nimport type { Collection, FindCursor, Db, Filter, FindOptions, UpdateResult, Document } from 'mongodb';\n\nimport { BaseRaw } from './BaseRaw';\n\nexport class VoipRoomRaw extends BaseRaw<IVoipRoom> implements IVoipRoomModel {\n\tconstructor(db: Db, trash?: Collection<RocketChatRecordDeleted<IVoipRoom>>) {\n\t\tsuper(db, 'room', trash);\n\t}\n\n\tlogger = new Logger('VoipRoomsRaw');\n\n\tasync findOneOpenByVisitorToken(visitorToken: string, options: FindOptions<IVoipRoom> = {}): Promise<IVoipRoom | null> {\n\t\tconst query: Filter<IVoipRoom> = {\n\t\t\t't': 'v',\n\t\t\t'open': true,\n\t\t\t'v.token': visitorToken,\n\t\t};\n\t\treturn this.findOne(query, options);\n\t}\n\n\tfindOpenByAgentId(agentId: string): FindCursor<IVoipRoom> {\n\t\treturn this.find({\n\t\t\t't': 'v',\n\t\t\t'open': true,\n\t\t\t'servedBy._id': agentId,\n\t\t});\n\t}\n\n\tasync findOneByAgentId(agentId: string): Promise<IVoipRoom | null> {\n\t\treturn this.findOne({\n\t\t\t't': 'v',\n\t\t\t'open': true,\n\t\t\t'servedBy._id': agentId,\n\t\t});\n\t}\n\n\tasync findOneVoipRoomById(id: string, options: FindOptions<IVoipRoom> = {}): Promise<IVoipRoom | null> {\n\t\tconst query: Filter<IVoipRoom> = {\n\t\t\tt: 'v',\n\t\t\t_id: id,\n\t\t};\n\t\treturn this.findOne(query, options);\n\t}\n\n\tasync findOneOpenByRoomIdAndVisitorToken(\n\t\troomId: string,\n\t\tvisitorToken: string,\n\t\toptions: FindOptions<IVoipRoom> = {},\n\t): Promise<IVoipRoom | null> {\n\t\tconst query: Filter<IVoipRoom> = {\n\t\t\t't': 'v',\n\t\t\t'_id': roomId,\n\t\t\t'open': true,\n\t\t\t'v.token': visitorToken,\n\t\t};\n\t\treturn this.findOne(query, options);\n\t}\n\n\tasync findOneByVisitorToken(visitorToken: string, options: FindOptions<IVoipRoom> = {}): Promise<IVoipRoom | null> {\n\t\tconst query: Filter<IVoipRoom> = {\n\t\t\t't': 'v',\n\t\t\t'v.token': visitorToken,\n\t\t};\n\t\treturn this.findOne(query, options);\n\t}\n\n\tasync findOneByIdAndVisitorToken(\n\t\t_id: IVoipRoom['_id'],\n\t\tvisitorToken: string,\n\t\toptions: FindOptions<IVoipRoom> = {},\n\t): Promise<IVoipRoom | null> {\n\t\tconst query: Filter<IVoipRoom> = {\n\t\t\t't': 'v',\n\t\t\t_id,\n\t\t\t'v.token': visitorToken,\n\t\t};\n\t\treturn this.findOne(query, options);\n\t}\n\n\tcloseByRoomId(roomId: IVoipRoom['_id'], closeInfo: IVoipRoomClosingInfo): Promise<Document | UpdateResult> {\n\t\tconst { closer, closedBy, closedAt, callDuration, serviceTimeDuration, ...extraData } = closeInfo;\n\n\t\treturn this.updateOne(\n\t\t\t{\n\t\t\t\t_id: roomId,\n\t\t\t\tt: 'v',\n\t\t\t},\n\t\t\t{\n\t\t\t\t$set: {\n\t\t\t\t\tcloser,\n\t\t\t\t\tclosedBy,\n\t\t\t\t\tclosedAt,\n\t\t\t\t\tcallDuration,\n\t\t\t\t\t'metrics.serviceTimeDuration': serviceTimeDuration,\n\t\t\t\t\t'v.status': UserStatus.OFFLINE,\n\t\t\t\t\t...extraData,\n\t\t\t\t},\n\t\t\t\t$unset: {\n\t\t\t\t\topen: 1,\n\t\t\t\t},\n\t\t\t},\n\t\t);\n\t}\n\n\tfindRoomsWithCriteria({\n\t\tagents,\n\t\topen,\n\t\tcreatedAt,\n\t\tclosedAt,\n\t\ttags,\n\t\tqueue,\n\t\tvisitorId,\n\t\tdirection,\n\t\troomName,\n\t\toptions = {},\n\t}: {\n\t\tagents?: string[];\n\t\topen?: boolean;\n\t\tcreatedAt?: { start?: string; end?: string };\n\t\tclosedAt?: { start?: string; end?: string };\n\t\ttags?: string[];\n\t\tqueue?: string;\n\t\tvisitorId?: string;\n\t\tdirection?: IVoipRoom['direction'];\n\t\troomName?: string;\n\t\toptions?: {\n\t\t\tsort?: FindOptions<IVoipRoom>['sort'];\n\t\t\tcount?: number;\n\t\t\tfields?: Record<string, unknown>;\n\t\t\toffset?: number;\n\t\t};\n\t}): FindPaginated<FindCursor<IVoipRoom>> {\n\t\tconst query: Filter<IVoipRoom> = {\n\t\t\tt: 'v',\n\t\t\t...(visitorId && visitorId !== 'undefined' && { 'v._id': visitorId }),\n\t\t\t...(agents && { $or: [{ 'servedBy._id': { $in: agents } }, { 'servedBy.username': { $in: agents } }] }),\n\t\t};\n\n\t\tif (open !== undefined) {\n\t\t\tquery.open = { $exists: open };\n\t\t}\n\t\tif (createdAt && Object.keys(createdAt).length) {\n\t\t\tquery.ts = {};\n\t\t\tif (createdAt.start) {\n\t\t\t\tquery.ts.$gte = new Date(createdAt.start);\n\t\t\t}\n\t\t\tif (createdAt.end) {\n\t\t\t\tquery.ts.$lte = new Date(createdAt.end);\n\t\t\t}\n\t\t}\n\t\tif (closedAt && Object.keys(closedAt).length) {\n\t\t\tquery.closedAt = {};\n\t\t\tif (closedAt.start) {\n\t\t\t\tquery.closedAt.$gte = new Date(closedAt.start);\n\t\t\t}\n\t\t\tif (closedAt.end) {\n\t\t\t\tquery.closedAt.$lte = new Date(closedAt.end);\n\t\t\t}\n\t\t}\n\t\tif (tags) {\n\t\t\tquery.tags = { $in: tags };\n\t\t}\n\t\tif (queue) {\n\t\t\tquery.queue = queue;\n\t\t}\n\t\tif (direction) {\n\t\t\tquery.direction = direction;\n\t\t}\n\t\tif (roomName) {\n\t\t\tquery.name = new RegExp(escapeRegExp(roomName), 'i');\n\t\t}\n\n\t\treturn this.findPaginated(query, {\n\t\t\tsort: options.sort || { name: 1 },\n\t\t\tskip: options.offset,\n\t\t\tlimit: options.count,\n\t\t});\n\t}\n}\n"]},"targets":{"android":"125.0.0","chrome":"125.0.0","edge":"125.0.0","firefox":"115.0.0","ie":"10.0.0","ios":"17.4.0","opera":"110.0.0","opera_mobile":"80.0.0","safari":"17.4.0","samsung":"24.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor","root":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":false,"enforceStrictMode":false,"dynamicImport":true,"generateLetDeclarations":true,"topLevelAwait":true},"externalDependencies":[]},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"version":"7.17.2","helpers":true,"useESModules":false,"corejs":false},"externalDependencies":[]},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-async-generator-functions","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-class-properties","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true},"externalDependencies":[]},{"key":"transform-react-jsx","visitor":{"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXFragment":{"exit":[null]},"JSXElement":{"exit":[null]},"JSXAttribute":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false},"externalDependencies":[]},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-nullish-coalescing-operator","visitor":{"LogicalExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-optional-chaining","visitor":{"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-optional-catch-binding","visitor":{"CatchClause":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-class-properties","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-async-generator-functions","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-logical-assignment-operators","visitor":{"AssignmentExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]}],"presets":[],"generatorOpts":{"filename":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/server/models/raw/VoipRoom.ts","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"server/models/raw/VoipRoom.ts","inputSourceMap":{"version":3,"file":"server/models/raw/VoipRoom.ts","sourceRoot":"","sources":["server/models/raw/VoipRoom.ts"],"names":[],"mappings":"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","sourcesContent":["import { type IVoipRoomClosingInfo, type IVoipRoom, type RocketChatRecordDeleted, UserStatus } from '@rocket.chat/core-typings';\nimport { Logger } from '@rocket.chat/logger';\nimport type { FindPaginated, IVoipRoomModel } from '@rocket.chat/model-typings';\nimport { escapeRegExp } from '@rocket.chat/string-helpers';\nimport type { Collection, FindCursor, Db, Filter, FindOptions, UpdateResult, Document } from 'mongodb';\n\nimport { BaseRaw } from './BaseRaw';\n\nexport class VoipRoomRaw extends BaseRaw<IVoipRoom> implements IVoipRoomModel {\n\tconstructor(db: Db, trash?: Collection<RocketChatRecordDeleted<IVoipRoom>>) {\n\t\tsuper(db, 'room', trash);\n\t}\n\n\tlogger = new Logger('VoipRoomsRaw');\n\n\tasync findOneOpenByVisitorToken(visitorToken: string, options: FindOptions<IVoipRoom> = {}): Promise<IVoipRoom | null> {\n\t\tconst query: Filter<IVoipRoom> = {\n\t\t\t't': 'v',\n\t\t\t'open': true,\n\t\t\t'v.token': visitorToken,\n\t\t};\n\t\treturn this.findOne(query, options);\n\t}\n\n\tfindOpenByAgentId(agentId: string): FindCursor<IVoipRoom> {\n\t\treturn this.find({\n\t\t\t't': 'v',\n\t\t\t'open': true,\n\t\t\t'servedBy._id': agentId,\n\t\t});\n\t}\n\n\tasync findOneByAgentId(agentId: string): Promise<IVoipRoom | null> {\n\t\treturn this.findOne({\n\t\t\t't': 'v',\n\t\t\t'open': true,\n\t\t\t'servedBy._id': agentId,\n\t\t});\n\t}\n\n\tasync findOneVoipRoomById(id: string, options: FindOptions<IVoipRoom> = {}): Promise<IVoipRoom | null> {\n\t\tconst query: Filter<IVoipRoom> = {\n\t\t\tt: 'v',\n\t\t\t_id: id,\n\t\t};\n\t\treturn this.findOne(query, options);\n\t}\n\n\tasync findOneOpenByRoomIdAndVisitorToken(\n\t\troomId: string,\n\t\tvisitorToken: string,\n\t\toptions: FindOptions<IVoipRoom> = {},\n\t): Promise<IVoipRoom | null> {\n\t\tconst query: Filter<IVoipRoom> = {\n\t\t\t't': 'v',\n\t\t\t'_id': roomId,\n\t\t\t'open': true,\n\t\t\t'v.token': visitorToken,\n\t\t};\n\t\treturn this.findOne(query, options);\n\t}\n\n\tasync findOneByVisitorToken(visitorToken: string, options: FindOptions<IVoipRoom> = {}): Promise<IVoipRoom | null> {\n\t\tconst query: Filter<IVoipRoom> = {\n\t\t\t't': 'v',\n\t\t\t'v.token': visitorToken,\n\t\t};\n\t\treturn this.findOne(query, options);\n\t}\n\n\tasync findOneByIdAndVisitorToken(\n\t\t_id: IVoipRoom['_id'],\n\t\tvisitorToken: string,\n\t\toptions: FindOptions<IVoipRoom> = {},\n\t): Promise<IVoipRoom | null> {\n\t\tconst query: Filter<IVoipRoom> = {\n\t\t\t't': 'v',\n\t\t\t_id,\n\t\t\t'v.token': visitorToken,\n\t\t};\n\t\treturn this.findOne(query, options);\n\t}\n\n\tcloseByRoomId(roomId: IVoipRoom['_id'], closeInfo: IVoipRoomClosingInfo): Promise<Document | UpdateResult> {\n\t\tconst { closer, closedBy, closedAt, callDuration, serviceTimeDuration, ...extraData } = closeInfo;\n\n\t\treturn this.updateOne(\n\t\t\t{\n\t\t\t\t_id: roomId,\n\t\t\t\tt: 'v',\n\t\t\t},\n\t\t\t{\n\t\t\t\t$set: {\n\t\t\t\t\tcloser,\n\t\t\t\t\tclosedBy,\n\t\t\t\t\tclosedAt,\n\t\t\t\t\tcallDuration,\n\t\t\t\t\t'metrics.serviceTimeDuration': serviceTimeDuration,\n\t\t\t\t\t'v.status': UserStatus.OFFLINE,\n\t\t\t\t\t...extraData,\n\t\t\t\t},\n\t\t\t\t$unset: {\n\t\t\t\t\topen: 1,\n\t\t\t\t},\n\t\t\t},\n\t\t);\n\t}\n\n\tfindRoomsWithCriteria({\n\t\tagents,\n\t\topen,\n\t\tcreatedAt,\n\t\tclosedAt,\n\t\ttags,\n\t\tqueue,\n\t\tvisitorId,\n\t\tdirection,\n\t\troomName,\n\t\toptions = {},\n\t}: {\n\t\tagents?: string[];\n\t\topen?: boolean;\n\t\tcreatedAt?: { start?: string; end?: string };\n\t\tclosedAt?: { start?: string; end?: string };\n\t\ttags?: string[];\n\t\tqueue?: string;\n\t\tvisitorId?: string;\n\t\tdirection?: IVoipRoom['direction'];\n\t\troomName?: string;\n\t\toptions?: {\n\t\t\tsort?: FindOptions<IVoipRoom>['sort'];\n\t\t\tcount?: number;\n\t\t\tfields?: Record<string, unknown>;\n\t\t\toffset?: number;\n\t\t};\n\t}): FindPaginated<FindCursor<IVoipRoom>> {\n\t\tconst query: Filter<IVoipRoom> = {\n\t\t\tt: 'v',\n\t\t\t...(visitorId && visitorId !== 'undefined' && { 'v._id': visitorId }),\n\t\t\t...(agents && { $or: [{ 'servedBy._id': { $in: agents } }, { 'servedBy.username': { $in: agents } }] }),\n\t\t};\n\n\t\tif (open !== undefined) {\n\t\t\tquery.open = { $exists: open };\n\t\t}\n\t\tif (createdAt && Object.keys(createdAt).length) {\n\t\t\tquery.ts = {};\n\t\t\tif (createdAt.start) {\n\t\t\t\tquery.ts.$gte = new Date(createdAt.start);\n\t\t\t}\n\t\t\tif (createdAt.end) {\n\t\t\t\tquery.ts.$lte = new Date(createdAt.end);\n\t\t\t}\n\t\t}\n\t\tif (closedAt && Object.keys(closedAt).length) {\n\t\t\tquery.closedAt = {};\n\t\t\tif (closedAt.start) {\n\t\t\t\tquery.closedAt.$gte = new Date(closedAt.start);\n\t\t\t}\n\t\t\tif (closedAt.end) {\n\t\t\t\tquery.closedAt.$lte = new Date(closedAt.end);\n\t\t\t}\n\t\t}\n\t\tif (tags) {\n\t\t\tquery.tags = { $in: tags };\n\t\t}\n\t\tif (queue) {\n\t\t\tquery.queue = queue;\n\t\t}\n\t\tif (direction) {\n\t\t\tquery.direction = direction;\n\t\t}\n\t\tif (roomName) {\n\t\t\tquery.name = new RegExp(escapeRegExp(roomName), 'i');\n\t\t}\n\n\t\treturn this.findPaginated(query, {\n\t\t\tsort: options.sort || { name: 1 },\n\t\t\tskip: options.offset,\n\t\t\tlimit: options.count,\n\t\t});\n\t}\n}\n"]}}},"code":"!module.wrapAsync(async function (module, __reifyWaitForDeps__, __reify_async_result__) {\n  \"use strict\";\n  try {\n    let _objectSpread;\n    module.link(\"@babel/runtime/helpers/objectSpread2\", {\n      default(v) {\n        _objectSpread = v;\n      }\n    }, 0);\n    let _objectWithoutProperties;\n    module.link(\"@babel/runtime/helpers/objectWithoutProperties\", {\n      default(v) {\n        _objectWithoutProperties = v;\n      }\n    }, 1);\n    const _excluded = [\"closer\", \"closedBy\", \"closedAt\", \"callDuration\", \"serviceTimeDuration\"];\n    module.export({\n      VoipRoomRaw: () => VoipRoomRaw\n    });\n    let UserStatus;\n    module.link(\"@rocket.chat/core-typings\", {\n      UserStatus(v) {\n        UserStatus = v;\n      }\n    }, 0);\n    let Logger;\n    module.link(\"@rocket.chat/logger\", {\n      Logger(v) {\n        Logger = v;\n      }\n    }, 1);\n    let escapeRegExp;\n    module.link(\"@rocket.chat/string-helpers\", {\n      escapeRegExp(v) {\n        escapeRegExp = v;\n      }\n    }, 2);\n    let BaseRaw;\n    module.link(\"./BaseRaw\", {\n      BaseRaw(v) {\n        BaseRaw = v;\n      }\n    }, 3);\n    if (__reifyWaitForDeps__()) (await __reifyWaitForDeps__())();\n    class VoipRoomRaw extends BaseRaw {\n      constructor(db, trash) {\n        super(db, 'room', trash);\n        this.logger = new Logger('VoipRoomsRaw');\n      }\n      async findOneOpenByVisitorToken(visitorToken) {\n        let options = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};\n        const query = {\n          't': 'v',\n          'open': true,\n          'v.token': visitorToken\n        };\n        return this.findOne(query, options);\n      }\n      findOpenByAgentId(agentId) {\n        return this.find({\n          't': 'v',\n          'open': true,\n          'servedBy._id': agentId\n        });\n      }\n      async findOneByAgentId(agentId) {\n        return this.findOne({\n          't': 'v',\n          'open': true,\n          'servedBy._id': agentId\n        });\n      }\n      async findOneVoipRoomById(id) {\n        let options = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};\n        const query = {\n          t: 'v',\n          _id: id\n        };\n        return this.findOne(query, options);\n      }\n      async findOneOpenByRoomIdAndVisitorToken(roomId, visitorToken) {\n        let options = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : {};\n        const query = {\n          't': 'v',\n          '_id': roomId,\n          'open': true,\n          'v.token': visitorToken\n        };\n        return this.findOne(query, options);\n      }\n      async findOneByVisitorToken(visitorToken) {\n        let options = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};\n        const query = {\n          't': 'v',\n          'v.token': visitorToken\n        };\n        return this.findOne(query, options);\n      }\n      async findOneByIdAndVisitorToken(_id, visitorToken) {\n        let options = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : {};\n        const query = {\n          't': 'v',\n          _id,\n          'v.token': visitorToken\n        };\n        return this.findOne(query, options);\n      }\n      closeByRoomId(roomId, closeInfo) {\n        const {\n            closer,\n            closedBy,\n            closedAt,\n            callDuration,\n            serviceTimeDuration\n          } = closeInfo,\n          extraData = _objectWithoutProperties(closeInfo, _excluded);\n        return this.updateOne({\n          _id: roomId,\n          t: 'v'\n        }, {\n          $set: _objectSpread({\n            closer,\n            closedBy,\n            closedAt,\n            callDuration,\n            'metrics.serviceTimeDuration': serviceTimeDuration,\n            'v.status': UserStatus.OFFLINE\n          }, extraData),\n          $unset: {\n            open: 1\n          }\n        });\n      }\n      findRoomsWithCriteria(_ref) {\n        let {\n          agents,\n          open,\n          createdAt,\n          closedAt,\n          tags,\n          queue,\n          visitorId,\n          direction,\n          roomName,\n          options = {}\n        } = _ref;\n        const query = _objectSpread(_objectSpread({\n          t: 'v'\n        }, visitorId && visitorId !== 'undefined' && {\n          'v._id': visitorId\n        }), agents && {\n          $or: [{\n            'servedBy._id': {\n              $in: agents\n            }\n          }, {\n            'servedBy.username': {\n              $in: agents\n            }\n          }]\n        });\n        if (open !== undefined) {\n          query.open = {\n            $exists: open\n          };\n        }\n        if (createdAt && Object.keys(createdAt).length) {\n          query.ts = {};\n          if (createdAt.start) {\n            query.ts.$gte = new Date(createdAt.start);\n          }\n          if (createdAt.end) {\n            query.ts.$lte = new Date(createdAt.end);\n          }\n        }\n        if (closedAt && Object.keys(closedAt).length) {\n          query.closedAt = {};\n          if (closedAt.start) {\n            query.closedAt.$gte = new Date(closedAt.start);\n          }\n          if (closedAt.end) {\n            query.closedAt.$lte = new Date(closedAt.end);\n          }\n        }\n        if (tags) {\n          query.tags = {\n            $in: tags\n          };\n        }\n        if (queue) {\n          query.queue = queue;\n        }\n        if (direction) {\n          query.direction = direction;\n        }\n        if (roomName) {\n          query.name = new RegExp(escapeRegExp(roomName), 'i');\n        }\n        return this.findPaginated(query, {\n          sort: options.sort || {\n            name: 1\n          },\n          skip: options.offset,\n          limit: options.count\n        });\n      }\n    }\n    __reify_async_result__();\n  } catch (_reifyError) {\n    return __reify_async_result__(_reifyError);\n  }\n  __reify_async_result__()\n}, {\n  self: this,\n  async: false\n});","map":{"version":3,"names":["_objectSpread","module","link","default","v","_objectWithoutProperties","_excluded","export","VoipRoomRaw","UserStatus","Logger","escapeRegExp","BaseRaw","__reifyWaitForDeps__","constructor","db","trash","logger","findOneOpenByVisitorToken","visitorToken","options","arguments","length","undefined","query","findOne","findOpenByAgentId","agentId","find","findOneByAgentId","findOneVoipRoomById","id","t","_id","findOneOpenByRoomIdAndVisitorToken","roomId","findOneByVisitorToken","findOneByIdAndVisitorToken","closeByRoomId","closeInfo","closer","closedBy","closedAt","callDuration","serviceTimeDuration","extraData","updateOne","$set","OFFLINE","$unset","open","findRoomsWithCriteria","_ref","agents","createdAt","tags","queue","visitorId","direction","roomName","$or","$in","$exists","Object","keys","ts","start","$gte","Date","end","$lte","name","RegExp","findPaginated","sort","skip","offset","limit","count","__reify_async_result__","_reifyError","self","async"],"sources":["server/models/raw/VoipRoom.ts"],"sourcesContent":["import { type IVoipRoomClosingInfo, type IVoipRoom, type RocketChatRecordDeleted, UserStatus } from '@rocket.chat/core-typings';\nimport { Logger } from '@rocket.chat/logger';\nimport type { FindPaginated, IVoipRoomModel } from '@rocket.chat/model-typings';\nimport { escapeRegExp } from '@rocket.chat/string-helpers';\nimport type { Collection, FindCursor, Db, Filter, FindOptions, UpdateResult, Document } from 'mongodb';\n\nimport { BaseRaw } from './BaseRaw';\n\nexport class VoipRoomRaw extends BaseRaw<IVoipRoom> implements IVoipRoomModel {\n\tconstructor(db: Db, trash?: Collection<RocketChatRecordDeleted<IVoipRoom>>) {\n\t\tsuper(db, 'room', trash);\n\t}\n\n\tlogger = new Logger('VoipRoomsRaw');\n\n\tasync findOneOpenByVisitorToken(visitorToken: string, options: FindOptions<IVoipRoom> = {}): Promise<IVoipRoom | null> {\n\t\tconst query: Filter<IVoipRoom> = {\n\t\t\t't': 'v',\n\t\t\t'open': true,\n\t\t\t'v.token': visitorToken,\n\t\t};\n\t\treturn this.findOne(query, options);\n\t}\n\n\tfindOpenByAgentId(agentId: string): FindCursor<IVoipRoom> {\n\t\treturn this.find({\n\t\t\t't': 'v',\n\t\t\t'open': true,\n\t\t\t'servedBy._id': agentId,\n\t\t});\n\t}\n\n\tasync findOneByAgentId(agentId: string): Promise<IVoipRoom | null> {\n\t\treturn this.findOne({\n\t\t\t't': 'v',\n\t\t\t'open': true,\n\t\t\t'servedBy._id': agentId,\n\t\t});\n\t}\n\n\tasync findOneVoipRoomById(id: string, options: FindOptions<IVoipRoom> = {}): Promise<IVoipRoom | null> {\n\t\tconst query: Filter<IVoipRoom> = {\n\t\t\tt: 'v',\n\t\t\t_id: id,\n\t\t};\n\t\treturn this.findOne(query, options);\n\t}\n\n\tasync findOneOpenByRoomIdAndVisitorToken(\n\t\troomId: string,\n\t\tvisitorToken: string,\n\t\toptions: FindOptions<IVoipRoom> = {},\n\t): Promise<IVoipRoom | null> {\n\t\tconst query: Filter<IVoipRoom> = {\n\t\t\t't': 'v',\n\t\t\t'_id': roomId,\n\t\t\t'open': true,\n\t\t\t'v.token': visitorToken,\n\t\t};\n\t\treturn this.findOne(query, options);\n\t}\n\n\tasync findOneByVisitorToken(visitorToken: string, options: FindOptions<IVoipRoom> = {}): Promise<IVoipRoom | null> {\n\t\tconst query: Filter<IVoipRoom> = {\n\t\t\t't': 'v',\n\t\t\t'v.token': visitorToken,\n\t\t};\n\t\treturn this.findOne(query, options);\n\t}\n\n\tasync findOneByIdAndVisitorToken(\n\t\t_id: IVoipRoom['_id'],\n\t\tvisitorToken: string,\n\t\toptions: FindOptions<IVoipRoom> = {},\n\t): Promise<IVoipRoom | null> {\n\t\tconst query: Filter<IVoipRoom> = {\n\t\t\t't': 'v',\n\t\t\t_id,\n\t\t\t'v.token': visitorToken,\n\t\t};\n\t\treturn this.findOne(query, options);\n\t}\n\n\tcloseByRoomId(roomId: IVoipRoom['_id'], closeInfo: IVoipRoomClosingInfo): Promise<Document | UpdateResult> {\n\t\tconst { closer, closedBy, closedAt, callDuration, serviceTimeDuration, ...extraData } = closeInfo;\n\n\t\treturn this.updateOne(\n\t\t\t{\n\t\t\t\t_id: roomId,\n\t\t\t\tt: 'v',\n\t\t\t},\n\t\t\t{\n\t\t\t\t$set: {\n\t\t\t\t\tcloser,\n\t\t\t\t\tclosedBy,\n\t\t\t\t\tclosedAt,\n\t\t\t\t\tcallDuration,\n\t\t\t\t\t'metrics.serviceTimeDuration': serviceTimeDuration,\n\t\t\t\t\t'v.status': UserStatus.OFFLINE,\n\t\t\t\t\t...extraData,\n\t\t\t\t},\n\t\t\t\t$unset: {\n\t\t\t\t\topen: 1,\n\t\t\t\t},\n\t\t\t},\n\t\t);\n\t}\n\n\tfindRoomsWithCriteria({\n\t\tagents,\n\t\topen,\n\t\tcreatedAt,\n\t\tclosedAt,\n\t\ttags,\n\t\tqueue,\n\t\tvisitorId,\n\t\tdirection,\n\t\troomName,\n\t\toptions = {},\n\t}: {\n\t\tagents?: string[];\n\t\topen?: boolean;\n\t\tcreatedAt?: { start?: string; end?: string };\n\t\tclosedAt?: { start?: string; end?: string };\n\t\ttags?: string[];\n\t\tqueue?: string;\n\t\tvisitorId?: string;\n\t\tdirection?: IVoipRoom['direction'];\n\t\troomName?: string;\n\t\toptions?: {\n\t\t\tsort?: FindOptions<IVoipRoom>['sort'];\n\t\t\tcount?: number;\n\t\t\tfields?: Record<string, unknown>;\n\t\t\toffset?: number;\n\t\t};\n\t}): FindPaginated<FindCursor<IVoipRoom>> {\n\t\tconst query: Filter<IVoipRoom> = {\n\t\t\tt: 'v',\n\t\t\t...(visitorId && visitorId !== 'undefined' && { 'v._id': visitorId }),\n\t\t\t...(agents && { $or: [{ 'servedBy._id': { $in: agents } }, { 'servedBy.username': { $in: agents } }] }),\n\t\t};\n\n\t\tif (open !== undefined) {\n\t\t\tquery.open = { $exists: open };\n\t\t}\n\t\tif (createdAt && Object.keys(createdAt).length) {\n\t\t\tquery.ts = {};\n\t\t\tif (createdAt.start) {\n\t\t\t\tquery.ts.$gte = new Date(createdAt.start);\n\t\t\t}\n\t\t\tif (createdAt.end) {\n\t\t\t\tquery.ts.$lte = new Date(createdAt.end);\n\t\t\t}\n\t\t}\n\t\tif (closedAt && Object.keys(closedAt).length) {\n\t\t\tquery.closedAt = {};\n\t\t\tif (closedAt.start) {\n\t\t\t\tquery.closedAt.$gte = new Date(closedAt.start);\n\t\t\t}\n\t\t\tif (closedAt.end) {\n\t\t\t\tquery.closedAt.$lte = new Date(closedAt.end);\n\t\t\t}\n\t\t}\n\t\tif (tags) {\n\t\t\tquery.tags = { $in: tags };\n\t\t}\n\t\tif (queue) {\n\t\t\tquery.queue = queue;\n\t\t}\n\t\tif (direction) {\n\t\t\tquery.direction = direction;\n\t\t}\n\t\tif (roomName) {\n\t\t\tquery.name = new RegExp(escapeRegExp(roomName), 'i');\n\t\t}\n\n\t\treturn this.findPaginated(query, {\n\t\t\tsort: options.sort || { name: 1 },\n\t\t\tskip: options.offset,\n\t\t\tlimit: options.count,\n\t\t});\n\t}\n}\n"],"mappings":"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","ignoreList":[]},"sourceType":"module","externalDependencies":{},"hash":"85d95ea882d77724292a5ebafe20380d72f9b1ea"}
