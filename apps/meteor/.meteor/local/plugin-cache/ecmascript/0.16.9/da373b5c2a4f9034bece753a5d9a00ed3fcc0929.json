{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/ee/server/apps/orchestrator.js","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","topLevelAwait","objectRestSpread","objectRestSpread","asyncGenerators","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"os.osx.arm64"},"sourceFileName":"ee/server/apps/orchestrator.js","filename":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/ee/server/apps/orchestrator.js","targets":{"android":"125.0.0","chrome":"125.0.0","edge":"125.0.0","firefox":"115.0.0","ie":"10.0.0","ios":"17.4.0","opera":"110.0.0","opera_mobile":"80.0.0","safari":"17.4.0","samsung":"24.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor","root":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":false,"enforceStrictMode":false,"dynamicImport":true,"generateLetDeclarations":true,"topLevelAwait":true},"externalDependencies":[]},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"version":"7.17.2","helpers":true,"useESModules":false,"corejs":false},"externalDependencies":[]},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-async-generator-functions","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-class-properties","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true},"externalDependencies":[]},{"key":"transform-react-jsx","visitor":{"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXFragment":{"exit":[null]},"JSXElement":{"exit":[null]},"JSXAttribute":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false},"externalDependencies":[]},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-nullish-coalescing-operator","visitor":{"LogicalExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-optional-chaining","visitor":{"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-optional-catch-binding","visitor":{"CatchClause":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-class-properties","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-async-generator-functions","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-logical-assignment-operators","visitor":{"AssignmentExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]}],"presets":[],"generatorOpts":{"filename":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/ee/server/apps/orchestrator.js","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"ee/server/apps/orchestrator.js"}},"code":"!module.wrapAsync(async function (module, __reifyWaitForDeps__, __reify_async_result__) {\n  \"use strict\";\n  try {\n    let _asyncIterator;\n    module.link(\"@babel/runtime/helpers/asyncIterator\", {\n      default(v) {\n        _asyncIterator = v;\n      }\n    }, 0);\n    module.export({\n      AppServerOrchestrator: () => AppServerOrchestrator,\n      Apps: () => Apps\n    });\n    let registerOrchestrator;\n    module.link(\"@rocket.chat/apps\", {\n      registerOrchestrator(v) {\n        registerOrchestrator = v;\n      }\n    }, 0);\n    let EssentialAppDisabledException;\n    module.link(\"@rocket.chat/apps-engine/definition/exceptions\", {\n      EssentialAppDisabledException(v) {\n        EssentialAppDisabledException = v;\n      }\n    }, 1);\n    let AppManager;\n    module.link(\"@rocket.chat/apps-engine/server/AppManager\", {\n      AppManager(v) {\n        AppManager = v;\n      }\n    }, 2);\n    let Logger;\n    module.link(\"@rocket.chat/logger\", {\n      Logger(v) {\n        Logger = v;\n      }\n    }, 3);\n    let AppLogs, AppsModel, AppsPersistence;\n    module.link(\"@rocket.chat/models\", {\n      AppLogs(v) {\n        AppLogs = v;\n      },\n      Apps(v) {\n        AppsModel = v;\n      },\n      AppsPersistence(v) {\n        AppsPersistence = v;\n      }\n    }, 4);\n    let Meteor;\n    module.link(\"meteor/meteor\", {\n      Meteor(v) {\n        Meteor = v;\n      }\n    }, 5);\n    let RealAppBridges;\n    module.link(\"../../../app/apps/server/bridges\", {\n      RealAppBridges(v) {\n        RealAppBridges = v;\n      }\n    }, 6);\n    let AppMessagesConverter, AppRoomsConverter, AppSettingsConverter, AppUsersConverter, AppVideoConferencesConverter, AppDepartmentsConverter, AppUploadsConverter, AppVisitorsConverter, AppRolesConverter;\n    module.link(\"../../../app/apps/server/converters\", {\n      AppMessagesConverter(v) {\n        AppMessagesConverter = v;\n      },\n      AppRoomsConverter(v) {\n        AppRoomsConverter = v;\n      },\n      AppSettingsConverter(v) {\n        AppSettingsConverter = v;\n      },\n      AppUsersConverter(v) {\n        AppUsersConverter = v;\n      },\n      AppVideoConferencesConverter(v) {\n        AppVideoConferencesConverter = v;\n      },\n      AppDepartmentsConverter(v) {\n        AppDepartmentsConverter = v;\n      },\n      AppUploadsConverter(v) {\n        AppUploadsConverter = v;\n      },\n      AppVisitorsConverter(v) {\n        AppVisitorsConverter = v;\n      },\n      AppRolesConverter(v) {\n        AppRolesConverter = v;\n      }\n    }, 7);\n    let AppThreadsConverter;\n    module.link(\"../../../app/apps/server/converters/threads\", {\n      AppThreadsConverter(v) {\n        AppThreadsConverter = v;\n      }\n    }, 8);\n    let settings;\n    module.link(\"../../../app/settings/server\", {\n      settings(v) {\n        settings = v;\n      }\n    }, 9);\n    let canEnableApp;\n    module.link(\"../../app/license/server/canEnableApp\", {\n      canEnableApp(v) {\n        canEnableApp = v;\n      }\n    }, 10);\n    let AppServerNotifier, AppsRestApi, AppUIKitInteractionApi;\n    module.link(\"./communication\", {\n      AppServerNotifier(v) {\n        AppServerNotifier = v;\n      },\n      AppsRestApi(v) {\n        AppsRestApi = v;\n      },\n      AppUIKitInteractionApi(v) {\n        AppUIKitInteractionApi = v;\n      }\n    }, 11);\n    let AppRealLogStorage, AppRealStorage, ConfigurableAppSourceStorage;\n    module.link(\"./storage\", {\n      AppRealLogStorage(v) {\n        AppRealLogStorage = v;\n      },\n      AppRealStorage(v) {\n        AppRealStorage = v;\n      },\n      ConfigurableAppSourceStorage(v) {\n        ConfigurableAppSourceStorage = v;\n      }\n    }, 12);\n    if (__reifyWaitForDeps__()) (await __reifyWaitForDeps__())();\n    function isTesting() {\n      return process.env.TEST_MODE === 'true';\n    }\n    const DISABLED_PRIVATE_APP_INSTALLATION = ['yes', 'true'].includes(String(process.env.DISABLE_PRIVATE_APP_INSTALLATION).toLowerCase());\n    let appsSourceStorageType;\n    let appsSourceStorageFilesystemPath;\n    class AppServerOrchestrator {\n      constructor() {\n        this._isInitialized = false;\n      }\n      initialize() {\n        if (this._isInitialized) {\n          return;\n        }\n        this._rocketchatLogger = new Logger('Rocket.Chat Apps');\n        if (typeof process.env.OVERWRITE_INTERNAL_MARKETPLACE_URL === 'string' && process.env.OVERWRITE_INTERNAL_MARKETPLACE_URL !== '') {\n          this._marketplaceUrl = process.env.OVERWRITE_INTERNAL_MARKETPLACE_URL;\n        } else {\n          this._marketplaceUrl = 'https://marketplace.rocket.chat';\n        }\n        this._model = AppsModel;\n        this._logModel = AppLogs;\n        this._persistModel = AppsPersistence;\n        this._storage = new AppRealStorage(this._model);\n        this._logStorage = new AppRealLogStorage(this._logModel);\n        this._appSourceStorage = new ConfigurableAppSourceStorage(appsSourceStorageType, appsSourceStorageFilesystemPath);\n        this._converters = new Map();\n        this._converters.set('messages', new AppMessagesConverter(this));\n        this._converters.set('rooms', new AppRoomsConverter(this));\n        this._converters.set('settings', new AppSettingsConverter(this));\n        this._converters.set('users', new AppUsersConverter(this));\n        this._converters.set('visitors', new AppVisitorsConverter(this));\n        this._converters.set('departments', new AppDepartmentsConverter(this));\n        this._converters.set('uploads', new AppUploadsConverter(this));\n        this._converters.set('videoConferences', new AppVideoConferencesConverter());\n        this._converters.set('threads', new AppThreadsConverter(this));\n        this._converters.set('roles', new AppRolesConverter(this));\n        this._bridges = new RealAppBridges(this);\n        this._manager = new AppManager({\n          metadataStorage: this._storage,\n          logStorage: this._logStorage,\n          bridges: this._bridges,\n          sourceStorage: this._appSourceStorage\n        });\n        this._communicators = new Map();\n        this._communicators.set('notifier', new AppServerNotifier(this));\n        this._communicators.set('restapi', new AppsRestApi(this, this._manager));\n        this._communicators.set('uikit', new AppUIKitInteractionApi(this));\n        this._isInitialized = true;\n      }\n      getModel() {\n        return this._model;\n      }\n\n      /**\n       * @returns {AppsPersistenceModel}\n       */\n      getPersistenceModel() {\n        return this._persistModel;\n      }\n      getStorage() {\n        return this._storage;\n      }\n      getLogStorage() {\n        return this._logStorage;\n      }\n      getConverters() {\n        return this._converters;\n      }\n      getBridges() {\n        return this._bridges;\n      }\n      getNotifier() {\n        return this._communicators.get('notifier');\n      }\n      getManager() {\n        return this._manager;\n      }\n      getProvidedComponents() {\n        return this._manager.getExternalComponentManager().getProvidedComponents();\n      }\n      getAppSourceStorage() {\n        return this._appSourceStorage;\n      }\n      isInitialized() {\n        return this._isInitialized;\n      }\n      isLoaded() {\n        return this.getManager().areAppsLoaded();\n      }\n      isDebugging() {\n        return !isTesting();\n      }\n      shouldDisablePrivateAppInstallation() {\n        return DISABLED_PRIVATE_APP_INSTALLATION;\n      }\n\n      /**\n       * @returns {Logger}\n       */\n      getRocketChatLogger() {\n        return this._rocketchatLogger;\n      }\n      debugLog() {\n        if (this.isDebugging()) {\n          this.getRocketChatLogger().debug(...arguments);\n        }\n      }\n      getMarketplaceUrl() {\n        return this._marketplaceUrl;\n      }\n      async load() {\n        // Don't try to load it again if it has\n        // already been loaded\n        if (this.isLoaded()) {\n          return;\n        }\n        await this.getManager().load();\n\n        // Before enabling each app we verify if there is still room for it\n        const apps = await this.getManager().get();\n\n        // This needs to happen sequentially to keep track of app limits\n        var _iteratorAbruptCompletion = false;\n        var _didIteratorError = false;\n        var _iteratorError;\n        try {\n          for (var _iterator = _asyncIterator(apps), _step; _iteratorAbruptCompletion = !(_step = await _iterator.next()).done; _iteratorAbruptCompletion = false) {\n            const app = _step.value;\n            {\n              try {\n                await canEnableApp(app.getStorageItem());\n                await this.getManager().loadOne(app.getID(), true);\n              } catch (error) {\n                this._rocketchatLogger.warn(\"App \\\"\".concat(app.getInfo().name, \"\\\" could not be enabled: \"), error.message);\n              }\n            }\n          }\n        } catch (err) {\n          _didIteratorError = true;\n          _iteratorError = err;\n        } finally {\n          try {\n            if (_iteratorAbruptCompletion && _iterator.return != null) {\n              await _iterator.return();\n            }\n          } finally {\n            if (_didIteratorError) {\n              throw _iteratorError;\n            }\n          }\n        }\n        await this.getBridges().getSchedulerBridge().startScheduler();\n        const appCount = (await this.getManager().get({\n          enabled: true\n        })).length;\n        this._rocketchatLogger.info(\"Loaded the Apps Framework and loaded a total of \".concat(appCount, \" Apps!\"));\n      }\n      async migratePrivateApps() {\n        const apps = await this.getManager().get({\n          installationSource: 'private'\n        });\n        await Promise.all(apps.map(app => this.getManager().migrate(app.getID())));\n        await Promise.all(apps.map(app => this.getNotifier().appUpdated(app.getID())));\n      }\n      async disableMarketplaceApps() {\n        const apps = await this.getManager().get({\n          installationSource: 'marketplace'\n        });\n        await Promise.all(apps.map(app => this.getManager().disable(app.getID())));\n      }\n      async unload() {\n        // Don't try to unload it if it's already been\n        // unlaoded or wasn't unloaded to start with\n        if (!this.isLoaded()) {\n          return;\n        }\n        return this._manager.unload().then(() => this._rocketchatLogger.info('Unloaded the Apps Framework.')).catch(err => this._rocketchatLogger.error({\n          msg: 'Failed to unload the Apps Framework!',\n          err\n        }));\n      }\n      async updateAppsMarketplaceInfo() {\n        let apps = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : [];\n        if (!this.isLoaded()) {\n          return;\n        }\n        return this._manager.updateAppsMarketplaceInfo(apps).then(() => this._manager.get());\n      }\n      async installedApps() {\n        let filter = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {};\n        if (!this.isLoaded()) {\n          return;\n        }\n        return this._manager.get(filter);\n      }\n      async triggerEvent(event) {\n        if (!this.isLoaded()) {\n          return;\n        }\n        for (var _len = arguments.length, payload = new Array(_len > 1 ? _len - 1 : 0), _key = 1; _key < _len; _key++) {\n          payload[_key - 1] = arguments[_key];\n        }\n        return this.getBridges().getListenerBridge().handleEvent(event, ...payload).catch(error => {\n          if (error instanceof EssentialAppDisabledException) {\n            throw new Meteor.Error('error-essential-app-disabled');\n          }\n          throw error;\n        });\n      }\n    }\n    const Apps = new AppServerOrchestrator();\n    registerOrchestrator(Apps);\n    settings.watch('Apps_Framework_Source_Package_Storage_Type', value => {\n      if (!Apps.isInitialized()) {\n        appsSourceStorageType = value;\n      } else {\n        Apps.getAppSourceStorage().setStorage(value);\n      }\n    });\n    settings.watch('Apps_Framework_Source_Package_Storage_FileSystem_Path', value => {\n      if (!Apps.isInitialized()) {\n        appsSourceStorageFilesystemPath = value;\n      } else {\n        Apps.getAppSourceStorage().setFileSystemStoragePath(value);\n      }\n    });\n    __reify_async_result__();\n  } catch (_reifyError) {\n    return __reify_async_result__(_reifyError);\n  }\n  __reify_async_result__()\n}, {\n  self: this,\n  async: false\n});","map":{"version":3,"names":["_asyncIterator","module","link","default","v","export","AppServerOrchestrator","Apps","registerOrchestrator","EssentialAppDisabledException","AppManager","Logger","AppLogs","AppsModel","AppsPersistence","Meteor","RealAppBridges","AppMessagesConverter","AppRoomsConverter","AppSettingsConverter","AppUsersConverter","AppVideoConferencesConverter","AppDepartmentsConverter","AppUploadsConverter","AppVisitorsConverter","AppRolesConverter","AppThreadsConverter","settings","canEnableApp","AppServerNotifier","AppsRestApi","AppUIKitInteractionApi","AppRealLogStorage","AppRealStorage","ConfigurableAppSourceStorage","__reifyWaitForDeps__","isTesting","process","env","TEST_MODE","DISABLED_PRIVATE_APP_INSTALLATION","includes","String","DISABLE_PRIVATE_APP_INSTALLATION","toLowerCase","appsSourceStorageType","appsSourceStorageFilesystemPath","constructor","_isInitialized","initialize","_rocketchatLogger","OVERWRITE_INTERNAL_MARKETPLACE_URL","_marketplaceUrl","_model","_logModel","_persistModel","_storage","_logStorage","_appSourceStorage","_converters","Map","set","_bridges","_manager","metadataStorage","logStorage","bridges","sourceStorage","_communicators","getModel","getPersistenceModel","getStorage","getLogStorage","getConverters","getBridges","getNotifier","get","getManager","getProvidedComponents","getExternalComponentManager","getAppSourceStorage","isInitialized","isLoaded","areAppsLoaded","isDebugging","shouldDisablePrivateAppInstallation","getRocketChatLogger","debugLog","debug","arguments","getMarketplaceUrl","load","apps","_iteratorAbruptCompletion","_didIteratorError","_iteratorError","_iterator","_step","next","done","app","value","getStorageItem","loadOne","getID","error","warn","concat","getInfo","name","message","err","return","getSchedulerBridge","startScheduler","appCount","enabled","length","info","migratePrivateApps","installationSource","Promise","all","map","migrate","appUpdated","disableMarketplaceApps","disable","unload","then","catch","msg","updateAppsMarketplaceInfo","undefined","installedApps","filter","triggerEvent","event","_len","payload","Array","_key","getListenerBridge","handleEvent","Error","watch","setStorage","setFileSystemStoragePath","__reify_async_result__","_reifyError","self","async"],"sources":["ee/server/apps/orchestrator.js"],"sourcesContent":["import { registerOrchestrator } from '@rocket.chat/apps';\nimport { EssentialAppDisabledException } from '@rocket.chat/apps-engine/definition/exceptions';\nimport { AppManager } from '@rocket.chat/apps-engine/server/AppManager';\nimport { Logger } from '@rocket.chat/logger';\nimport { AppLogs, Apps as AppsModel, AppsPersistence } from '@rocket.chat/models';\nimport { Meteor } from 'meteor/meteor';\n\nimport { RealAppBridges } from '../../../app/apps/server/bridges';\nimport {\n\tAppMessagesConverter,\n\tAppRoomsConverter,\n\tAppSettingsConverter,\n\tAppUsersConverter,\n\tAppVideoConferencesConverter,\n\tAppDepartmentsConverter,\n\tAppUploadsConverter,\n\tAppVisitorsConverter,\n\tAppRolesConverter,\n} from '../../../app/apps/server/converters';\nimport { AppThreadsConverter } from '../../../app/apps/server/converters/threads';\nimport { settings } from '../../../app/settings/server';\nimport { canEnableApp } from '../../app/license/server/canEnableApp';\nimport { AppServerNotifier, AppsRestApi, AppUIKitInteractionApi } from './communication';\nimport { AppRealLogStorage, AppRealStorage, ConfigurableAppSourceStorage } from './storage';\n\nfunction isTesting() {\n\treturn process.env.TEST_MODE === 'true';\n}\n\nconst DISABLED_PRIVATE_APP_INSTALLATION = ['yes', 'true'].includes(String(process.env.DISABLE_PRIVATE_APP_INSTALLATION).toLowerCase());\n\nlet appsSourceStorageType;\nlet appsSourceStorageFilesystemPath;\n\nexport class AppServerOrchestrator {\n\tconstructor() {\n\t\tthis._isInitialized = false;\n\t}\n\n\tinitialize() {\n\t\tif (this._isInitialized) {\n\t\t\treturn;\n\t\t}\n\n\t\tthis._rocketchatLogger = new Logger('Rocket.Chat Apps');\n\n\t\tif (typeof process.env.OVERWRITE_INTERNAL_MARKETPLACE_URL === 'string' && process.env.OVERWRITE_INTERNAL_MARKETPLACE_URL !== '') {\n\t\t\tthis._marketplaceUrl = process.env.OVERWRITE_INTERNAL_MARKETPLACE_URL;\n\t\t} else {\n\t\t\tthis._marketplaceUrl = 'https://marketplace.rocket.chat';\n\t\t}\n\n\t\tthis._model = AppsModel;\n\t\tthis._logModel = AppLogs;\n\t\tthis._persistModel = AppsPersistence;\n\t\tthis._storage = new AppRealStorage(this._model);\n\t\tthis._logStorage = new AppRealLogStorage(this._logModel);\n\t\tthis._appSourceStorage = new ConfigurableAppSourceStorage(appsSourceStorageType, appsSourceStorageFilesystemPath);\n\n\t\tthis._converters = new Map();\n\t\tthis._converters.set('messages', new AppMessagesConverter(this));\n\t\tthis._converters.set('rooms', new AppRoomsConverter(this));\n\t\tthis._converters.set('settings', new AppSettingsConverter(this));\n\t\tthis._converters.set('users', new AppUsersConverter(this));\n\t\tthis._converters.set('visitors', new AppVisitorsConverter(this));\n\t\tthis._converters.set('departments', new AppDepartmentsConverter(this));\n\t\tthis._converters.set('uploads', new AppUploadsConverter(this));\n\t\tthis._converters.set('videoConferences', new AppVideoConferencesConverter());\n\t\tthis._converters.set('threads', new AppThreadsConverter(this));\n\t\tthis._converters.set('roles', new AppRolesConverter(this));\n\n\t\tthis._bridges = new RealAppBridges(this);\n\n\t\tthis._manager = new AppManager({\n\t\t\tmetadataStorage: this._storage,\n\t\t\tlogStorage: this._logStorage,\n\t\t\tbridges: this._bridges,\n\t\t\tsourceStorage: this._appSourceStorage,\n\t\t});\n\n\t\tthis._communicators = new Map();\n\t\tthis._communicators.set('notifier', new AppServerNotifier(this));\n\t\tthis._communicators.set('restapi', new AppsRestApi(this, this._manager));\n\t\tthis._communicators.set('uikit', new AppUIKitInteractionApi(this));\n\n\t\tthis._isInitialized = true;\n\t}\n\n\tgetModel() {\n\t\treturn this._model;\n\t}\n\n\t/**\n\t * @returns {AppsPersistenceModel}\n\t */\n\tgetPersistenceModel() {\n\t\treturn this._persistModel;\n\t}\n\n\tgetStorage() {\n\t\treturn this._storage;\n\t}\n\n\tgetLogStorage() {\n\t\treturn this._logStorage;\n\t}\n\n\tgetConverters() {\n\t\treturn this._converters;\n\t}\n\n\tgetBridges() {\n\t\treturn this._bridges;\n\t}\n\n\tgetNotifier() {\n\t\treturn this._communicators.get('notifier');\n\t}\n\n\tgetManager() {\n\t\treturn this._manager;\n\t}\n\n\tgetProvidedComponents() {\n\t\treturn this._manager.getExternalComponentManager().getProvidedComponents();\n\t}\n\n\tgetAppSourceStorage() {\n\t\treturn this._appSourceStorage;\n\t}\n\n\tisInitialized() {\n\t\treturn this._isInitialized;\n\t}\n\n\tisLoaded() {\n\t\treturn this.getManager().areAppsLoaded();\n\t}\n\n\tisDebugging() {\n\t\treturn !isTesting();\n\t}\n\n\tshouldDisablePrivateAppInstallation() {\n\t\treturn DISABLED_PRIVATE_APP_INSTALLATION;\n\t}\n\n\t/**\n\t * @returns {Logger}\n\t */\n\tgetRocketChatLogger() {\n\t\treturn this._rocketchatLogger;\n\t}\n\n\tdebugLog(...args) {\n\t\tif (this.isDebugging()) {\n\t\t\tthis.getRocketChatLogger().debug(...args);\n\t\t}\n\t}\n\n\tgetMarketplaceUrl() {\n\t\treturn this._marketplaceUrl;\n\t}\n\n\tasync load() {\n\t\t// Don't try to load it again if it has\n\t\t// already been loaded\n\t\tif (this.isLoaded()) {\n\t\t\treturn;\n\t\t}\n\n\t\tawait this.getManager().load();\n\n\t\t// Before enabling each app we verify if there is still room for it\n\t\tconst apps = await this.getManager().get();\n\n\t\t// This needs to happen sequentially to keep track of app limits\n\t\tfor await (const app of apps) {\n\t\t\ttry {\n\t\t\t\tawait canEnableApp(app.getStorageItem());\n\n\t\t\t\tawait this.getManager().loadOne(app.getID(), true);\n\t\t\t} catch (error) {\n\t\t\t\tthis._rocketchatLogger.warn(`App \"${app.getInfo().name}\" could not be enabled: `, error.message);\n\t\t\t}\n\t\t}\n\n\t\tawait this.getBridges().getSchedulerBridge().startScheduler();\n\n\t\tconst appCount = (await this.getManager().get({ enabled: true })).length;\n\n\t\tthis._rocketchatLogger.info(`Loaded the Apps Framework and loaded a total of ${appCount} Apps!`);\n\t}\n\n\tasync migratePrivateApps() {\n\t\tconst apps = await this.getManager().get({ installationSource: 'private' });\n\n\t\tawait Promise.all(apps.map((app) => this.getManager().migrate(app.getID())));\n\t\tawait Promise.all(apps.map((app) => this.getNotifier().appUpdated(app.getID())));\n\t}\n\n\tasync disableMarketplaceApps() {\n\t\tconst apps = await this.getManager().get({ installationSource: 'marketplace' });\n\n\t\tawait Promise.all(apps.map((app) => this.getManager().disable(app.getID())));\n\t}\n\n\tasync unload() {\n\t\t// Don't try to unload it if it's already been\n\t\t// unlaoded or wasn't unloaded to start with\n\t\tif (!this.isLoaded()) {\n\t\t\treturn;\n\t\t}\n\n\t\treturn this._manager\n\t\t\t.unload()\n\t\t\t.then(() => this._rocketchatLogger.info('Unloaded the Apps Framework.'))\n\t\t\t.catch((err) => this._rocketchatLogger.error({ msg: 'Failed to unload the Apps Framework!', err }));\n\t}\n\n\tasync updateAppsMarketplaceInfo(apps = []) {\n\t\tif (!this.isLoaded()) {\n\t\t\treturn;\n\t\t}\n\n\t\treturn this._manager.updateAppsMarketplaceInfo(apps).then(() => this._manager.get());\n\t}\n\n\tasync installedApps(filter = {}) {\n\t\tif (!this.isLoaded()) {\n\t\t\treturn;\n\t\t}\n\n\t\treturn this._manager.get(filter);\n\t}\n\n\tasync triggerEvent(event, ...payload) {\n\t\tif (!this.isLoaded()) {\n\t\t\treturn;\n\t\t}\n\n\t\treturn this.getBridges()\n\t\t\t.getListenerBridge()\n\t\t\t.handleEvent(event, ...payload)\n\t\t\t.catch((error) => {\n\t\t\t\tif (error instanceof EssentialAppDisabledException) {\n\t\t\t\t\tthrow new Meteor.Error('error-essential-app-disabled');\n\t\t\t\t}\n\n\t\t\t\tthrow error;\n\t\t\t});\n\t}\n}\n\nexport const Apps = new AppServerOrchestrator();\nregisterOrchestrator(Apps);\n\nsettings.watch('Apps_Framework_Source_Package_Storage_Type', (value) => {\n\tif (!Apps.isInitialized()) {\n\t\tappsSourceStorageType = value;\n\t} else {\n\t\tApps.getAppSourceStorage().setStorage(value);\n\t}\n});\n\nsettings.watch('Apps_Framework_Source_Package_Storage_FileSystem_Path', (value) => {\n\tif (!Apps.isInitialized()) {\n\t\tappsSourceStorageFilesystemPath = value;\n\t} else {\n\t\tApps.getAppSourceStorage().setFileSystemStoragePath(value);\n\t}\n});\n"],"mappings":"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","ignoreList":[]},"sourceType":"module","externalDependencies":{},"hash":"da373b5c2a4f9034bece753a5d9a00ed3fcc0929"}
