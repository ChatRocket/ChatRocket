{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/server/configuration/accounts_meld.js","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","topLevelAwait","objectRestSpread","objectRestSpread","asyncGenerators","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"os.osx.arm64"},"sourceFileName":"server/configuration/accounts_meld.js","filename":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/server/configuration/accounts_meld.js","targets":{"android":"125.0.0","chrome":"125.0.0","edge":"125.0.0","firefox":"115.0.0","ie":"10.0.0","ios":"17.4.0","opera":"110.0.0","opera_mobile":"80.0.0","safari":"17.4.0","samsung":"24.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor","root":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":false,"enforceStrictMode":false,"dynamicImport":true,"generateLetDeclarations":true,"topLevelAwait":true},"externalDependencies":[]},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"version":"7.17.2","helpers":true,"useESModules":false,"corejs":false},"externalDependencies":[]},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-async-generator-functions","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-class-properties","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true},"externalDependencies":[]},{"key":"transform-react-jsx","visitor":{"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXFragment":{"exit":[null]},"JSXElement":{"exit":[null]},"JSXAttribute":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false},"externalDependencies":[]},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-nullish-coalescing-operator","visitor":{"LogicalExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-optional-chaining","visitor":{"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-optional-catch-binding","visitor":{"CatchClause":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-class-properties","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-async-generator-functions","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-logical-assignment-operators","visitor":{"AssignmentExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]}],"presets":[],"generatorOpts":{"filename":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/server/configuration/accounts_meld.js","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"server/configuration/accounts_meld.js"}},"code":"!module.wrapAsync(async function (module, __reifyWaitForDeps__, __reify_async_result__) {\n  \"use strict\";\n  try {\n    module.export({\n      configureAccounts: () => configureAccounts\n    });\n    let Users;\n    module.link(\"@rocket.chat/models\", {\n      Users(v) {\n        Users = v;\n      }\n    }, 0);\n    let Accounts;\n    module.link(\"meteor/accounts-base\", {\n      Accounts(v) {\n        Accounts = v;\n      }\n    }, 1);\n    let _;\n    module.link(\"underscore\", {\n      default(v) {\n        _ = v;\n      }\n    }, 2);\n    if (__reifyWaitForDeps__()) (await __reifyWaitForDeps__())();\n    async function configureAccounts() {\n      const orig_updateOrCreateUserFromExternalService = Accounts.updateOrCreateUserFromExternalService;\n      Accounts.updateOrCreateUserFromExternalService = async function (serviceName) {\n        let serviceData = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};\n        const services = ['facebook', 'github', 'gitlab', 'google', 'meteor-developer', 'linkedin', 'twitter', 'apple'];\n        for (var _len = arguments.length, args = new Array(_len > 2 ? _len - 2 : 0), _key = 2; _key < _len; _key++) {\n          args[_key - 2] = arguments[_key];\n        }\n        if (services.includes(serviceName) === false && serviceData._OAuthCustom !== true) {\n          return orig_updateOrCreateUserFromExternalService.apply(this, [serviceName, serviceData, ...args]);\n        }\n        if (serviceName === 'meteor-developer') {\n          if (Array.isArray(serviceData.emails)) {\n            const primaryEmail = serviceData.emails.sort(a => a.primary !== true).filter(item => item.verified === true)[0];\n            serviceData.email = primaryEmail && primaryEmail.address;\n          }\n        }\n        if (serviceName === 'linkedin') {\n          serviceData.email = serviceData.emailAddress;\n        }\n        if (serviceData.email) {\n          var _user$services, _user$services$servic;\n          const user = await Users.findOneByEmailAddress(serviceData.email);\n          if (user != null && ((_user$services = user.services) === null || _user$services === void 0 ? void 0 : (_user$services$servic = _user$services[serviceName]) === null || _user$services$servic === void 0 ? void 0 : _user$services$servic.id) !== serviceData.id) {\n            var _user$services2;\n            const findQuery = {\n              address: serviceData.email,\n              verified: true\n            };\n            if ((_user$services2 = user.services) !== null && _user$services2 !== void 0 && _user$services2.password && !_.findWhere(user.emails, findQuery)) {\n              await Users.resetPasswordAndSetRequirePasswordChange(user._id, true, 'This_email_has_already_been_used_and_has_not_been_verified__Please_change_your_password');\n            }\n            await Users.setServiceId(user._id, serviceName, serviceData.id);\n            await Users.setEmailVerified(user._id, serviceData.email);\n          }\n        }\n        return orig_updateOrCreateUserFromExternalService.apply(this, [serviceName, serviceData, ...args]);\n      };\n    }\n    __reify_async_result__();\n  } catch (_reifyError) {\n    return __reify_async_result__(_reifyError);\n  }\n  __reify_async_result__()\n}, {\n  self: this,\n  async: false\n});","map":{"version":3,"names":["module","export","configureAccounts","Users","link","v","Accounts","_","default","__reifyWaitForDeps__","orig_updateOrCreateUserFromExternalService","updateOrCreateUserFromExternalService","serviceName","serviceData","arguments","length","undefined","services","_len","args","Array","_key","includes","_OAuthCustom","apply","isArray","emails","primaryEmail","sort","a","primary","filter","item","verified","email","address","emailAddress","_user$services","_user$services$servic","user","findOneByEmailAddress","id","_user$services2","findQuery","password","findWhere","resetPasswordAndSetRequirePasswordChange","_id","setServiceId","setEmailVerified","__reify_async_result__","_reifyError","self","async"],"sources":["server/configuration/accounts_meld.js"],"sourcesContent":["import { Users } from '@rocket.chat/models';\nimport { Accounts } from 'meteor/accounts-base';\nimport _ from 'underscore';\n\nexport async function configureAccounts() {\n\tconst orig_updateOrCreateUserFromExternalService = Accounts.updateOrCreateUserFromExternalService;\n\tAccounts.updateOrCreateUserFromExternalService = async function (serviceName, serviceData = {}, ...args /* , options*/) {\n\t\tconst services = ['facebook', 'github', 'gitlab', 'google', 'meteor-developer', 'linkedin', 'twitter', 'apple'];\n\n\t\tif (services.includes(serviceName) === false && serviceData._OAuthCustom !== true) {\n\t\t\treturn orig_updateOrCreateUserFromExternalService.apply(this, [serviceName, serviceData, ...args]);\n\t\t}\n\n\t\tif (serviceName === 'meteor-developer') {\n\t\t\tif (Array.isArray(serviceData.emails)) {\n\t\t\t\tconst primaryEmail = serviceData.emails.sort((a) => a.primary !== true).filter((item) => item.verified === true)[0];\n\t\t\t\tserviceData.email = primaryEmail && primaryEmail.address;\n\t\t\t}\n\t\t}\n\n\t\tif (serviceName === 'linkedin') {\n\t\t\tserviceData.email = serviceData.emailAddress;\n\t\t}\n\n\t\tif (serviceData.email) {\n\t\t\tconst user = await Users.findOneByEmailAddress(serviceData.email);\n\t\t\tif (user != null && user.services?.[serviceName]?.id !== serviceData.id) {\n\t\t\t\tconst findQuery = {\n\t\t\t\t\taddress: serviceData.email,\n\t\t\t\t\tverified: true,\n\t\t\t\t};\n\n\t\t\t\tif (user.services?.password && !_.findWhere(user.emails, findQuery)) {\n\t\t\t\t\tawait Users.resetPasswordAndSetRequirePasswordChange(\n\t\t\t\t\t\tuser._id,\n\t\t\t\t\t\ttrue,\n\t\t\t\t\t\t'This_email_has_already_been_used_and_has_not_been_verified__Please_change_your_password',\n\t\t\t\t\t);\n\t\t\t\t}\n\n\t\t\t\tawait Users.setServiceId(user._id, serviceName, serviceData.id);\n\t\t\t\tawait Users.setEmailVerified(user._id, serviceData.email);\n\t\t\t}\n\t\t}\n\n\t\treturn orig_updateOrCreateUserFromExternalService.apply(this, [serviceName, serviceData, ...args]);\n\t};\n}\n"],"mappings":"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","ignoreList":[]},"sourceType":"module","externalDependencies":{},"hash":"724855598bf769e3e52ce71fae704ff786167ae4"}
