{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/app/irc/server/irc-bridge/index.js","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","topLevelAwait","objectRestSpread","objectRestSpread","asyncGenerators","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"os.osx.arm64"},"sourceFileName":"app/irc/server/irc-bridge/index.js","filename":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/app/irc/server/irc-bridge/index.js","targets":{"android":"125.0.0","chrome":"125.0.0","edge":"125.0.0","firefox":"115.0.0","ie":"10.0.0","ios":"17.4.0","opera":"110.0.0","opera_mobile":"80.0.0","safari":"17.4.0","samsung":"24.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor","root":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":false,"enforceStrictMode":false,"dynamicImport":true,"generateLetDeclarations":true,"topLevelAwait":true},"externalDependencies":[]},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"version":"7.17.2","helpers":true,"useESModules":false,"corejs":false},"externalDependencies":[]},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-async-generator-functions","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-class-properties","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true},"externalDependencies":[]},{"key":"transform-react-jsx","visitor":{"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXFragment":{"exit":[null]},"JSXElement":{"exit":[null]},"JSXAttribute":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false},"externalDependencies":[]},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-nullish-coalescing-operator","visitor":{"LogicalExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-optional-chaining","visitor":{"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-optional-catch-binding","visitor":{"CatchClause":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-class-properties","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-async-generator-functions","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-logical-assignment-operators","visitor":{"AssignmentExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]}],"presets":[],"generatorOpts":{"filename":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/app/irc/server/irc-bridge/index.js","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"app/irc/server/irc-bridge/index.js"}},"code":"!module.wrapAsync(async function (module, __reifyWaitForDeps__, __reify_async_result__) {\n  \"use strict\";\n  try {\n    let Logger;\n    module.link(\"@rocket.chat/logger\", {\n      Logger(v) {\n        Logger = v;\n      }\n    }, 0);\n    let Settings;\n    module.link(\"@rocket.chat/models\", {\n      Settings(v) {\n        Settings = v;\n      }\n    }, 1);\n    let moment;\n    module.link(\"moment\", {\n      default(v) {\n        moment = v;\n      }\n    }, 2);\n    let Queue;\n    module.link(\"queue-fifo\", {\n      default(v) {\n        Queue = v;\n      }\n    }, 3);\n    let callbacks;\n    module.link(\"../../../../lib/callbacks\", {\n      callbacks(v) {\n        callbacks = v;\n      }\n    }, 4);\n    let afterLeaveRoomCallback;\n    module.link(\"../../../../lib/callbacks/afterLeaveRoomCallback\", {\n      afterLeaveRoomCallback(v) {\n        afterLeaveRoomCallback = v;\n      }\n    }, 5);\n    let afterLogoutCleanUpCallback;\n    module.link(\"../../../../lib/callbacks/afterLogoutCleanUpCallback\", {\n      afterLogoutCleanUpCallback(v) {\n        afterLogoutCleanUpCallback = v;\n      }\n    }, 6);\n    let withThrottling;\n    module.link(\"../../../../lib/utils/highOrderFunctions\", {\n      withThrottling(v) {\n        withThrottling = v;\n      }\n    }, 7);\n    let updateAuditedBySystem;\n    module.link(\"../../../../server/settings/lib/auditedSettingUpdates\", {\n      updateAuditedBySystem(v) {\n        updateAuditedBySystem = v;\n      }\n    }, 8);\n    let notifyOnSettingChangedById;\n    module.link(\"../../../lib/server/lib/notifyListener\", {\n      notifyOnSettingChangedById(v) {\n        notifyOnSettingChangedById = v;\n      }\n    }, 9);\n    let servers;\n    module.link(\"../servers\", {\n      \"*\"(v) {\n        servers = v;\n      }\n    }, 10);\n    let localCommandHandlers;\n    module.link(\"./localHandlers\", {\n      \"*\"(v) {\n        localCommandHandlers = v;\n      }\n    }, 11);\n    let peerCommandHandlers;\n    module.link(\"./peerHandlers\", {\n      \"*\"(v) {\n        peerCommandHandlers = v;\n      }\n    }, 12);\n    if (__reifyWaitForDeps__()) (await __reifyWaitForDeps__())();\n    const logger = new Logger('IRC Bridge');\n    const queueLogger = logger.section('Queue');\n    let removed = false;\n    const updateLastPing = withThrottling({\n      wait: 10_000\n    })(() => {\n      if (removed) {\n        return;\n      }\n      void (async () => {\n        const updatedValue = await updateAuditedBySystem({\n          reason: 'updateLastPing'\n        })(Settings.updateValueById, 'IRC_Bridge_Last_Ping', new Date(), {\n          upsert: true\n        });\n        if (updatedValue.modifiedCount || updatedValue.upsertedCount) {\n          void notifyOnSettingChangedById('IRC_Bridge_Last_Ping');\n        }\n      })();\n    });\n    class Bridge {\n      constructor(config) {\n        // General\n        this.config = config;\n\n        // Workaround for Rocket.Chat callbacks being called multiple times\n        this.loggedInUsers = [];\n\n        // Server\n        const Server = servers[this.config.server.protocol];\n        this.server = new Server(this.config);\n        this.setupPeerHandlers();\n        this.setupLocalHandlers();\n\n        // Command queue\n        this.queue = new Queue();\n        this.queueTimeout = 5;\n      }\n      async init() {\n        this.initTime = new Date();\n        removed = false;\n        this.loggedInUsers = [];\n        const lastPing = await Settings.findOneById('IRC_Bridge_Last_Ping');\n        if (lastPing) {\n          if (Math.abs(moment(lastPing.value).diff()) < 1000 * 30) {\n            this.log('Not trying to connect.');\n            this.remove();\n            return;\n          }\n        }\n        this.log('Connecting.');\n        updateLastPing();\n        this.server.register();\n        this.server.on('registered', () => {\n          this.logQueue('Starting...');\n          this.runQueue();\n        });\n      }\n      stop() {\n        this.server.disconnect();\n      }\n      remove() {\n        this.log('Removing current connection.');\n        removed = true;\n        this.server = null;\n        this.removeLocalHandlers();\n      }\n\n      /**\n       * Log helper\n       */\n      log(message) {\n        // TODO logger: debug?\n        logger.info(message);\n      }\n      logQueue(message) {\n        // TODO logger: debug?\n        queueLogger.info(message);\n      }\n\n      /**\n       *\n       *\n       * Queue\n       *\n       *\n       */\n      onMessageReceived(from, command) {\n        for (var _len = arguments.length, parameters = new Array(_len > 2 ? _len - 2 : 0), _key = 2; _key < _len; _key++) {\n          parameters[_key - 2] = arguments[_key];\n        }\n        this.queue.enqueue({\n          from,\n          command,\n          parameters\n        });\n      }\n      async runQueue() {\n        if (!this.server) {\n          return;\n        }\n        const lastResetTime = Settings.findOneById('IRC_Bridge_Reset_Time');\n        if (lastResetTime && lastResetTime.value > this.initTime) {\n          this.stop();\n          this.remove();\n          return;\n        }\n        updateLastPing();\n\n        // If it is empty, skip and keep the queue going\n        if (this.queue.isEmpty()) {\n          return setTimeout(this.runQueue.bind(this), this.queueTimeout);\n        }\n\n        // Get the command\n        const item = this.queue.dequeue();\n        this.logQueue(\"Processing \\\"\".concat(item.command, \"\\\" command from \\\"\").concat(item.from, \"\\\"\"));\n\n        // Handle the command accordingly\n        try {\n          // Handle the command accordingly\n          switch (item.from) {\n            case 'local':\n              if (!localCommandHandlers[item.command]) {\n                throw new Error(\"Could not find handler for local:\".concat(item.command));\n              }\n              await localCommandHandlers[item.command].apply(this, item.parameters);\n              break;\n            case 'peer':\n              if (!peerCommandHandlers[item.command]) {\n                throw new Error(\"Could not find handler for peer:\".concat(item.command));\n              }\n              await peerCommandHandlers[item.command].apply(this, item.parameters);\n              break;\n          }\n        } catch (e) {\n          this.logQueue(e);\n        }\n\n        // Keep the queue going\n        setTimeout(this.runQueue.bind(this), this.queueTimeout);\n      }\n\n      /**\n       *\n       *\n       * Peer\n       *\n       *\n       */\n      setupPeerHandlers() {\n        this.server.on('peerCommand', cmd => {\n          this.onMessageReceived('peer', cmd.identifier, cmd.args);\n        });\n      }\n\n      /**\n       *\n       *\n       * Local\n       *\n       *\n       */\n      setupLocalHandlers() {\n        // Auth\n        callbacks.add('afterValidateLogin', this.onMessageReceived.bind(this, 'local', 'onLogin'), callbacks.priority.LOW, 'irc-on-login');\n        callbacks.add('afterCreateUser', this.onMessageReceived.bind(this, 'local', 'onCreateUser'), callbacks.priority.LOW, 'irc-on-create-user');\n        // Joining rooms or channels\n        callbacks.add('afterCreateChannel', this.onMessageReceived.bind(this, 'local', 'onCreateRoom'), callbacks.priority.LOW, 'irc-on-create-channel');\n        callbacks.add('afterCreateRoom', this.onMessageReceived.bind(this, 'local', 'onCreateRoom'), callbacks.priority.LOW, 'irc-on-create-room');\n        callbacks.add('afterJoinRoom', this.onMessageReceived.bind(this, 'local', 'onJoinRoom'), callbacks.priority.LOW, 'irc-on-join-room');\n        // Leaving rooms or channels\n        afterLeaveRoomCallback.add(this.onMessageReceived.bind(this, 'local', 'onLeaveRoom'), callbacks.priority.LOW, 'irc-on-leave-room');\n        // Chatting\n        callbacks.add('afterSaveMessage', (message, _ref) => {\n          let {\n            room\n          } = _ref;\n          return this.onMessageReceived('local', 'onSaveMessage', message, room);\n        }, callbacks.priority.LOW, 'irc-on-save-message');\n        // Leaving\n        afterLogoutCleanUpCallback.add(this.onMessageReceived.bind(this, 'local', 'onLogout'), callbacks.priority.LOW, 'irc-on-logout');\n      }\n      removeLocalHandlers() {\n        callbacks.remove('afterValidateLogin', 'irc-on-login');\n        callbacks.remove('afterCreateUser', 'irc-on-create-user');\n        callbacks.remove('afterCreateChannel', 'irc-on-create-channel');\n        callbacks.remove('afterCreateRoom', 'irc-on-create-room');\n        callbacks.remove('afterJoinRoom', 'irc-on-join-room');\n        afterLeaveRoomCallback.remove('irc-on-leave-room');\n        callbacks.remove('afterSaveMessage', 'irc-on-save-message');\n        afterLogoutCleanUpCallback.remove('irc-on-logout');\n      }\n      sendCommand(command, parameters) {\n        this.server.emit('onReceiveFromLocal', command, parameters);\n      }\n    }\n    module.exportDefault(Bridge);\n    __reify_async_result__();\n  } catch (_reifyError) {\n    return __reify_async_result__(_reifyError);\n  }\n  __reify_async_result__()\n}, {\n  self: this,\n  async: false\n});","map":{"version":3,"names":["Logger","module","link","v","Settings","moment","default","Queue","callbacks","afterLeaveRoomCallback","afterLogoutCleanUpCallback","withThrottling","updateAuditedBySystem","notifyOnSettingChangedById","servers","*","localCommandHandlers","peerCommandHandlers","__reifyWaitForDeps__","logger","queueLogger","section","removed","updateLastPing","wait","updatedValue","reason","updateValueById","Date","upsert","modifiedCount","upsertedCount","Bridge","constructor","config","loggedInUsers","Server","server","protocol","setupPeerHandlers","setupLocalHandlers","queue","queueTimeout","init","initTime","lastPing","findOneById","Math","abs","value","diff","log","remove","register","on","logQueue","runQueue","stop","disconnect","removeLocalHandlers","message","info","onMessageReceived","from","command","_len","arguments","length","parameters","Array","_key","enqueue","lastResetTime","isEmpty","setTimeout","bind","item","dequeue","concat","Error","apply","e","cmd","identifier","args","add","priority","LOW","_ref","room","sendCommand","emit","exportDefault","__reify_async_result__","_reifyError","self","async"],"sources":["app/irc/server/irc-bridge/index.js"],"sourcesContent":["import { Logger } from '@rocket.chat/logger';\nimport { Settings } from '@rocket.chat/models';\nimport moment from 'moment';\nimport Queue from 'queue-fifo';\n\nimport { callbacks } from '../../../../lib/callbacks';\nimport { afterLeaveRoomCallback } from '../../../../lib/callbacks/afterLeaveRoomCallback';\nimport { afterLogoutCleanUpCallback } from '../../../../lib/callbacks/afterLogoutCleanUpCallback';\nimport { withThrottling } from '../../../../lib/utils/highOrderFunctions';\nimport { updateAuditedBySystem } from '../../../../server/settings/lib/auditedSettingUpdates';\nimport { notifyOnSettingChangedById } from '../../../lib/server/lib/notifyListener';\nimport * as servers from '../servers';\nimport * as localCommandHandlers from './localHandlers';\nimport * as peerCommandHandlers from './peerHandlers';\n\nconst logger = new Logger('IRC Bridge');\nconst queueLogger = logger.section('Queue');\n\nlet removed = false;\nconst updateLastPing = withThrottling({ wait: 10_000 })(() => {\n\tif (removed) {\n\t\treturn;\n\t}\n\n\tvoid (async () => {\n\t\tconst updatedValue = await updateAuditedBySystem({\n\t\t\treason: 'updateLastPing',\n\t\t})(Settings.updateValueById, 'IRC_Bridge_Last_Ping', new Date(), { upsert: true });\n\t\tif (updatedValue.modifiedCount || updatedValue.upsertedCount) {\n\t\t\tvoid notifyOnSettingChangedById('IRC_Bridge_Last_Ping');\n\t\t}\n\t})();\n});\n\nclass Bridge {\n\tconstructor(config) {\n\t\t// General\n\t\tthis.config = config;\n\n\t\t// Workaround for Rocket.Chat callbacks being called multiple times\n\t\tthis.loggedInUsers = [];\n\n\t\t// Server\n\t\tconst Server = servers[this.config.server.protocol];\n\n\t\tthis.server = new Server(this.config);\n\n\t\tthis.setupPeerHandlers();\n\t\tthis.setupLocalHandlers();\n\n\t\t// Command queue\n\t\tthis.queue = new Queue();\n\t\tthis.queueTimeout = 5;\n\t}\n\n\tasync init() {\n\t\tthis.initTime = new Date();\n\t\tremoved = false;\n\t\tthis.loggedInUsers = [];\n\n\t\tconst lastPing = await Settings.findOneById('IRC_Bridge_Last_Ping');\n\t\tif (lastPing) {\n\t\t\tif (Math.abs(moment(lastPing.value).diff()) < 1000 * 30) {\n\t\t\t\tthis.log('Not trying to connect.');\n\t\t\t\tthis.remove();\n\t\t\t\treturn;\n\t\t\t}\n\t\t}\n\n\t\tthis.log('Connecting.');\n\t\tupdateLastPing();\n\t\tthis.server.register();\n\n\t\tthis.server.on('registered', () => {\n\t\t\tthis.logQueue('Starting...');\n\n\t\t\tthis.runQueue();\n\t\t});\n\t}\n\n\tstop() {\n\t\tthis.server.disconnect();\n\t}\n\n\tremove() {\n\t\tthis.log('Removing current connection.');\n\t\tremoved = true;\n\t\tthis.server = null;\n\t\tthis.removeLocalHandlers();\n\t}\n\n\t/**\n\t * Log helper\n\t */\n\tlog(message) {\n\t\t// TODO logger: debug?\n\t\tlogger.info(message);\n\t}\n\n\tlogQueue(message) {\n\t\t// TODO logger: debug?\n\t\tqueueLogger.info(message);\n\t}\n\n\t/**\n\t *\n\t *\n\t * Queue\n\t *\n\t *\n\t */\n\tonMessageReceived(from, command, ...parameters) {\n\t\tthis.queue.enqueue({ from, command, parameters });\n\t}\n\n\tasync runQueue() {\n\t\tif (!this.server) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst lastResetTime = Settings.findOneById('IRC_Bridge_Reset_Time');\n\t\tif (lastResetTime && lastResetTime.value > this.initTime) {\n\t\t\tthis.stop();\n\t\t\tthis.remove();\n\t\t\treturn;\n\t\t}\n\n\t\tupdateLastPing();\n\n\t\t// If it is empty, skip and keep the queue going\n\t\tif (this.queue.isEmpty()) {\n\t\t\treturn setTimeout(this.runQueue.bind(this), this.queueTimeout);\n\t\t}\n\n\t\t// Get the command\n\t\tconst item = this.queue.dequeue();\n\n\t\tthis.logQueue(`Processing \"${item.command}\" command from \"${item.from}\"`);\n\n\t\t// Handle the command accordingly\n\t\ttry {\n\t\t\t// Handle the command accordingly\n\t\t\tswitch (item.from) {\n\t\t\t\tcase 'local':\n\t\t\t\t\tif (!localCommandHandlers[item.command]) {\n\t\t\t\t\t\tthrow new Error(`Could not find handler for local:${item.command}`);\n\t\t\t\t\t}\n\n\t\t\t\t\tawait localCommandHandlers[item.command].apply(this, item.parameters);\n\t\t\t\t\tbreak;\n\t\t\t\tcase 'peer':\n\t\t\t\t\tif (!peerCommandHandlers[item.command]) {\n\t\t\t\t\t\tthrow new Error(`Could not find handler for peer:${item.command}`);\n\t\t\t\t\t}\n\n\t\t\t\t\tawait peerCommandHandlers[item.command].apply(this, item.parameters);\n\t\t\t\t\tbreak;\n\t\t\t}\n\t\t} catch (e) {\n\t\t\tthis.logQueue(e);\n\t\t}\n\n\t\t// Keep the queue going\n\t\tsetTimeout(this.runQueue.bind(this), this.queueTimeout);\n\t}\n\n\t/**\n\t *\n\t *\n\t * Peer\n\t *\n\t *\n\t */\n\tsetupPeerHandlers() {\n\t\tthis.server.on('peerCommand', (cmd) => {\n\t\t\tthis.onMessageReceived('peer', cmd.identifier, cmd.args);\n\t\t});\n\t}\n\n\t/**\n\t *\n\t *\n\t * Local\n\t *\n\t *\n\t */\n\tsetupLocalHandlers() {\n\t\t// Auth\n\t\tcallbacks.add('afterValidateLogin', this.onMessageReceived.bind(this, 'local', 'onLogin'), callbacks.priority.LOW, 'irc-on-login');\n\t\tcallbacks.add(\n\t\t\t'afterCreateUser',\n\t\t\tthis.onMessageReceived.bind(this, 'local', 'onCreateUser'),\n\t\t\tcallbacks.priority.LOW,\n\t\t\t'irc-on-create-user',\n\t\t);\n\t\t// Joining rooms or channels\n\t\tcallbacks.add(\n\t\t\t'afterCreateChannel',\n\t\t\tthis.onMessageReceived.bind(this, 'local', 'onCreateRoom'),\n\t\t\tcallbacks.priority.LOW,\n\t\t\t'irc-on-create-channel',\n\t\t);\n\t\tcallbacks.add(\n\t\t\t'afterCreateRoom',\n\t\t\tthis.onMessageReceived.bind(this, 'local', 'onCreateRoom'),\n\t\t\tcallbacks.priority.LOW,\n\t\t\t'irc-on-create-room',\n\t\t);\n\t\tcallbacks.add('afterJoinRoom', this.onMessageReceived.bind(this, 'local', 'onJoinRoom'), callbacks.priority.LOW, 'irc-on-join-room');\n\t\t// Leaving rooms or channels\n\t\tafterLeaveRoomCallback.add(this.onMessageReceived.bind(this, 'local', 'onLeaveRoom'), callbacks.priority.LOW, 'irc-on-leave-room');\n\t\t// Chatting\n\t\tcallbacks.add(\n\t\t\t'afterSaveMessage',\n\t\t\t(message, { room }) => this.onMessageReceived('local', 'onSaveMessage', message, room),\n\t\t\tcallbacks.priority.LOW,\n\t\t\t'irc-on-save-message',\n\t\t);\n\t\t// Leaving\n\t\tafterLogoutCleanUpCallback.add(this.onMessageReceived.bind(this, 'local', 'onLogout'), callbacks.priority.LOW, 'irc-on-logout');\n\t}\n\n\tremoveLocalHandlers() {\n\t\tcallbacks.remove('afterValidateLogin', 'irc-on-login');\n\t\tcallbacks.remove('afterCreateUser', 'irc-on-create-user');\n\t\tcallbacks.remove('afterCreateChannel', 'irc-on-create-channel');\n\t\tcallbacks.remove('afterCreateRoom', 'irc-on-create-room');\n\t\tcallbacks.remove('afterJoinRoom', 'irc-on-join-room');\n\t\tafterLeaveRoomCallback.remove('irc-on-leave-room');\n\t\tcallbacks.remove('afterSaveMessage', 'irc-on-save-message');\n\t\tafterLogoutCleanUpCallback.remove('irc-on-logout');\n\t}\n\n\tsendCommand(command, parameters) {\n\t\tthis.server.emit('onReceiveFromLocal', command, parameters);\n\t}\n}\n\nexport default Bridge;\n"],"mappings":"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","ignoreList":[]},"sourceType":"module","externalDependencies":{},"hash":"3a589fd946b88d70acb4452d825445b7077cd7dd"}
