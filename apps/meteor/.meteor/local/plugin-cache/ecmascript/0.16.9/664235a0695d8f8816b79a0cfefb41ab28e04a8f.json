{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/packages/meteor-developer-oauth/meteor_developer_server.js","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","topLevelAwait","objectRestSpread","objectRestSpread","asyncGenerators","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"os.osx.arm64"},"sourceFileName":"packages/meteor-developer-oauth/meteor_developer_server.js","filename":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/packages/meteor-developer-oauth/meteor_developer_server.js","targets":{"android":"125.0.0","chrome":"125.0.0","edge":"125.0.0","firefox":"115.0.0","ie":"10.0.0","ios":"17.4.0","opera":"110.0.0","opera_mobile":"80.0.0","safari":"17.4.0","samsung":"24.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor","root":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":false,"enforceStrictMode":false,"dynamicImport":true,"generateLetDeclarations":true,"topLevelAwait":true},"externalDependencies":[]},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"version":"7.17.2","helpers":true,"useESModules":false,"corejs":false},"externalDependencies":[]},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-async-generator-functions","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-class-properties","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true},"externalDependencies":[]},{"key":"transform-react-jsx","visitor":{"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXFragment":{"exit":[null]},"JSXElement":{"exit":[null]},"JSXAttribute":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false},"externalDependencies":[]},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-nullish-coalescing-operator","visitor":{"LogicalExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-optional-chaining","visitor":{"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-optional-catch-binding","visitor":{"CatchClause":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-class-properties","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-async-generator-functions","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-logical-assignment-operators","visitor":{"AssignmentExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]}],"presets":[],"generatorOpts":{"filename":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/packages/meteor-developer-oauth/meteor_developer_server.js","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"packages/meteor-developer-oauth/meteor_developer_server.js"}},"code":"OAuth.registerService(\"meteor-developer\", 2, null, async query => {\n  const response = await getTokens(query);\n  const {\n    accessToken\n  } = response;\n  const identity = await getIdentity(accessToken);\n  const serviceData = {\n    accessToken: OAuth.sealSecret(accessToken),\n    expiresAt: +new Date() + 1000 * response.expiresIn\n  };\n  Object.assign(serviceData, identity);\n\n  // only set the token in serviceData if it's there. this ensures\n  // that we don't lose old ones (since we only get this on the first\n  // log in attempt)\n  if (response.refreshToken) serviceData.refreshToken = OAuth.sealSecret(response.refreshToken);\n  return {\n    serviceData,\n    options: {\n      profile: {\n        name: serviceData.username\n      }\n    }\n    // XXX use username for name until meteor accounts has a profile with a name\n  };\n});\n\n// returns an object containing:\n// - accessToken\n// - expiresIn: lifetime of token in seconds\n// - refreshToken, if this is the first authorization request and we got a\n//   refresh token from the server\nconst getTokens = async query => {\n  const config = await ServiceConfiguration.configurations.findOneAsync({\n    service: 'meteor-developer'\n  });\n  if (!config) {\n    throw new ServiceConfiguration.ConfigError();\n  }\n  const body = OAuth._addValuesToQueryParams({\n    grant_type: 'authorization_code',\n    code: query.code,\n    client_id: config.clientId,\n    client_secret: OAuth.openSecret(config.secret),\n    redirect_uri: OAuth._redirectUri('meteor-developer', config)\n  }).toString();\n  return OAuth._fetch(MeteorDeveloperAccounts._server + '/oauth2/token', 'POST', {\n    headers: {\n      Accept: 'application/json',\n      'Content-type': 'application/x-www-form-urlencoded'\n    },\n    body\n  }).then(data => data.json()).then(data => {\n    if (data.error) {\n      throw new Error('Failed to complete OAuth handshake with Meteor developer accounts. ' + (data ? data.error : 'No response data'));\n    }\n    return {\n      accessToken: data.access_token,\n      refreshToken: data.refresh_token,\n      expiresIn: data.expires_in\n    };\n  }).catch(err => {\n    throw Object.assign(new Error(\"Failed to complete OAuth handshake with Meteor developer accounts. \".concat(err.message)), {\n      response: err.response\n    });\n  });\n};\nconst getIdentity = async accessToken => {\n  return OAuth._fetch(\"\".concat(MeteorDeveloperAccounts._server, \"/api/v1/identity\"), 'GET', {\n    headers: {\n      Authorization: \"Bearer \".concat(accessToken)\n    }\n  }).then(data => data.json()).catch(err => {\n    throw Object.assign(new Error('Failed to fetch identity from Meteor developer accounts. ' + err.message), {\n      response: err.response\n    });\n  });\n};\nMeteorDeveloperAccounts.retrieveCredential = (credentialToken, credentialSecret) => OAuth.retrieveCredential(credentialToken, credentialSecret);","map":{"version":3,"names":["OAuth","registerService","query","response","getTokens","accessToken","identity","getIdentity","serviceData","sealSecret","expiresAt","Date","expiresIn","Object","assign","refreshToken","options","profile","name","username","config","ServiceConfiguration","configurations","findOneAsync","service","ConfigError","body","_addValuesToQueryParams","grant_type","code","client_id","clientId","client_secret","openSecret","secret","redirect_uri","_redirectUri","toString","_fetch","MeteorDeveloperAccounts","_server","headers","Accept","then","data","json","error","Error","access_token","refresh_token","expires_in","catch","err","concat","message","Authorization","retrieveCredential","credentialToken","credentialSecret"],"sources":["packages/meteor-developer-oauth/meteor_developer_server.js"],"sourcesContent":["OAuth.registerService(\"meteor-developer\", 2, null, async query => {\n  const response = await getTokens(query);\n  const { accessToken } = response;\n  const identity = await getIdentity(accessToken);\n\n  const serviceData = {\n    accessToken: OAuth.sealSecret(accessToken),\n    expiresAt: (+new Date) + (1000 * response.expiresIn)\n  };\n\n  Object.assign(serviceData, identity);\n\n  // only set the token in serviceData if it's there. this ensures\n  // that we don't lose old ones (since we only get this on the first\n  // log in attempt)\n  if (response.refreshToken)\n    serviceData.refreshToken = OAuth.sealSecret(response.refreshToken);\n\n  return {\n    serviceData,\n    options: {profile: {name: serviceData.username}}\n    // XXX use username for name until meteor accounts has a profile with a name\n  };\n});\n\n// returns an object containing:\n// - accessToken\n// - expiresIn: lifetime of token in seconds\n// - refreshToken, if this is the first authorization request and we got a\n//   refresh token from the server\nconst getTokens = async (query) => {\n  const config = await ServiceConfiguration.configurations.findOneAsync({\n    service: 'meteor-developer',\n  });\n  if (!config) {\n    throw new ServiceConfiguration.ConfigError();\n  }\n\n  const body = OAuth._addValuesToQueryParams({\n    grant_type: 'authorization_code',\n    code: query.code,\n    client_id: config.clientId,\n    client_secret: OAuth.openSecret(config.secret),\n    redirect_uri: OAuth._redirectUri('meteor-developer', config),\n  }).toString();\n\n  return OAuth._fetch(\n    MeteorDeveloperAccounts._server + '/oauth2/token',\n    'POST',\n    {\n      headers: {\n        Accept: 'application/json',\n        'Content-type': 'application/x-www-form-urlencoded',\n      },\n      body,\n    }\n  )\n    .then((data) => data.json())\n    .then((data) => {\n      if (data.error) {\n        throw new Error(\n          'Failed to complete OAuth handshake with Meteor developer accounts. ' +\n            (data ? data.error : 'No response data')\n        );\n      }\n      return {\n        accessToken: data.access_token,\n        refreshToken: data.refresh_token,\n        expiresIn: data.expires_in,\n      };\n    })\n    .catch((err) => {\n      throw Object.assign(\n        new Error(\n          `Failed to complete OAuth handshake with Meteor developer accounts. ${err.message}`\n        ),\n        { response: err.response }\n      );\n    });\n};\n\nconst getIdentity = async (accessToken) => {\n  return OAuth._fetch(\n    `${MeteorDeveloperAccounts._server}/api/v1/identity`,\n    'GET',\n    {\n      headers: { Authorization: `Bearer ${accessToken}` },\n    }\n  )\n    .then((data) => data.json())\n    .catch((err) => {\n      throw Object.assign(\n        new Error(\n          'Failed to fetch identity from Meteor developer accounts. ' +\n            err.message\n        ),\n        { response: err.response }\n      );\n    });\n};\n\nMeteorDeveloperAccounts.retrieveCredential =\n  (credentialToken, credentialSecret) =>\n    OAuth.retrieveCredential(credentialToken, credentialSecret);\n"],"mappings":"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","ignoreList":[]},"sourceType":"module","externalDependencies":{},"hash":"664235a0695d8f8816b79a0cfefb41ab28e04a8f"}
