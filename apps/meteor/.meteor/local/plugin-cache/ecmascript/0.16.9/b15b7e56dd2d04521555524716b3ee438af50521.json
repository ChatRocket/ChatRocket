{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/app/integrations/server/api/api.js","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","topLevelAwait","objectRestSpread","objectRestSpread","asyncGenerators","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"os.osx.arm64"},"sourceFileName":"app/integrations/server/api/api.js","filename":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/app/integrations/server/api/api.js","targets":{"android":"125.0.0","chrome":"125.0.0","edge":"125.0.0","firefox":"115.0.0","ie":"10.0.0","ios":"17.4.0","opera":"110.0.0","opera_mobile":"80.0.0","safari":"17.4.0","samsung":"24.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor","root":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":false,"enforceStrictMode":false,"dynamicImport":true,"generateLetDeclarations":true,"topLevelAwait":true},"externalDependencies":[]},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"version":"7.17.2","helpers":true,"useESModules":false,"corejs":false},"externalDependencies":[]},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-async-generator-functions","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-class-properties","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true},"externalDependencies":[]},{"key":"transform-react-jsx","visitor":{"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXFragment":{"exit":[null]},"JSXElement":{"exit":[null]},"JSXAttribute":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false},"externalDependencies":[]},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-nullish-coalescing-operator","visitor":{"LogicalExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-optional-chaining","visitor":{"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-optional-catch-binding","visitor":{"CatchClause":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-class-properties","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-async-generator-functions","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-logical-assignment-operators","visitor":{"AssignmentExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]}],"presets":[],"generatorOpts":{"filename":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/app/integrations/server/api/api.js","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"app/integrations/server/api/api.js"}},"code":"!module.wrapAsync(async function (module, __reifyWaitForDeps__, __reify_async_result__) {\n  \"use strict\";\n  try {\n    let Integrations, Users;\n    module.link(\"@rocket.chat/models\", {\n      Integrations(v) {\n        Integrations = v;\n      },\n      Users(v) {\n        Users = v;\n      }\n    }, 0);\n    let Random;\n    module.link(\"@rocket.chat/random\", {\n      Random(v) {\n        Random = v;\n      }\n    }, 1);\n    let _;\n    module.link(\"underscore\", {\n      default(v) {\n        _ = v;\n      }\n    }, 2);\n    let API, APIClass, defaultRateLimiterOptions;\n    module.link(\"../../../api/server\", {\n      API(v) {\n        API = v;\n      },\n      APIClass(v) {\n        APIClass = v;\n      },\n      defaultRateLimiterOptions(v) {\n        defaultRateLimiterOptions = v;\n      }\n    }, 3);\n    let processWebhookMessage;\n    module.link(\"../../../lib/server/functions/processWebhookMessage\", {\n      processWebhookMessage(v) {\n        processWebhookMessage = v;\n      }\n    }, 4);\n    let settings;\n    module.link(\"../../../settings/server\", {\n      settings(v) {\n        settings = v;\n      }\n    }, 5);\n    let IsolatedVMScriptEngine;\n    module.link(\"../lib/isolated-vm/isolated-vm\", {\n      IsolatedVMScriptEngine(v) {\n        IsolatedVMScriptEngine = v;\n      }\n    }, 6);\n    let incomingLogger;\n    module.link(\"../logger\", {\n      incomingLogger(v) {\n        incomingLogger = v;\n      }\n    }, 7);\n    let addOutgoingIntegration;\n    module.link(\"../methods/outgoing/addOutgoingIntegration\", {\n      addOutgoingIntegration(v) {\n        addOutgoingIntegration = v;\n      }\n    }, 8);\n    let deleteOutgoingIntegration;\n    module.link(\"../methods/outgoing/deleteOutgoingIntegration\", {\n      deleteOutgoingIntegration(v) {\n        deleteOutgoingIntegration = v;\n      }\n    }, 9);\n    if (__reifyWaitForDeps__()) (await __reifyWaitForDeps__())();\n    const ivmEngine = new IsolatedVMScriptEngine(true);\n\n    // eslint-disable-next-line no-unused-vars\n    function getEngine(_integration) {\n      return ivmEngine;\n    }\n    async function createIntegration(options, user) {\n      incomingLogger.info({\n        msg: 'Add integration',\n        integration: options.name\n      });\n      incomingLogger.debug({\n        options\n      });\n      switch (options.event) {\n        case 'newMessageOnChannel':\n          if (options.data == null) {\n            options.data = {};\n          }\n          if (options.data.channel_name != null && options.data.channel_name.indexOf('#') === -1) {\n            options.data.channel_name = \"#\".concat(options.data.channel_name);\n          }\n          return addOutgoingIntegration(user._id, {\n            username: 'rocket.cat',\n            urls: [options.target_url],\n            name: options.name,\n            channel: options.data.channel_name,\n            triggerWords: options.data.trigger_words\n          });\n        case 'newMessageToUser':\n          if (options.data.username.indexOf('@') === -1) {\n            options.data.username = \"@\".concat(options.data.username);\n          }\n          return addOutgoingIntegration(user._id, {\n            username: 'rocket.cat',\n            urls: [options.target_url],\n            name: options.name,\n            channel: options.data.username,\n            triggerWords: options.data.trigger_words\n          });\n      }\n      return API.v1.success();\n    }\n    async function removeIntegration(options, user) {\n      incomingLogger.info('Remove integration');\n      incomingLogger.debug({\n        options\n      });\n      const integrationToRemove = await Integrations.findOneByUrl(options.target_url);\n      if (!integrationToRemove) {\n        return API.v1.failure('integration-not-found');\n      }\n      await deleteOutgoingIntegration(integrationToRemove._id, user._id);\n      return API.v1.success();\n    }\n    async function executeIntegrationRest() {\n      incomingLogger.info({\n        msg: 'Post integration:',\n        integration: this.integration.name\n      });\n      incomingLogger.debug({\n        urlParams: this.urlParams,\n        bodyParams: this.bodyParams\n      });\n      if (this.integration.enabled !== true) {\n        return {\n          statusCode: 503,\n          body: 'Service Unavailable'\n        };\n      }\n      const defaultValues = {\n        channel: this.integration.channel,\n        alias: this.integration.alias,\n        avatar: this.integration.avatar,\n        emoji: this.integration.emoji\n      };\n      const scriptEngine = getEngine(this.integration);\n      if (scriptEngine.integrationHasValidScript(this.integration)) {\n        this.request.setEncoding('utf8');\n        const content_raw = this.request.read();\n        const request = {\n          url: {\n            hash: this.request._parsedUrl.hash,\n            search: this.request._parsedUrl.search,\n            query: this.queryParams,\n            pathname: this.request._parsedUrl.pathname,\n            path: this.request._parsedUrl.path\n          },\n          url_raw: this.request.url,\n          url_params: this.urlParams,\n          content: this.bodyParams,\n          content_raw,\n          headers: this.request.headers,\n          body: this.request.body,\n          user: {\n            _id: this.user._id,\n            name: this.user.name,\n            username: this.user.username\n          }\n        };\n        const result = await scriptEngine.processIncomingRequest({\n          integration: this.integration,\n          request\n        });\n        try {\n          if (!result) {\n            incomingLogger.debug({\n              msg: 'Process Incoming Request result of Trigger has no data',\n              integration: this.integration.name\n            });\n            return API.v1.success();\n          }\n          if (result && result.error) {\n            return API.v1.failure(result.error);\n          }\n          this.bodyParams = result && result.content;\n          this.scriptResponse = result.response;\n          if (result.user) {\n            this.user = result.user;\n          }\n          incomingLogger.debug({\n            msg: 'Process Incoming Request result of Trigger',\n            integration: this.integration.name,\n            result: this.bodyParams\n          });\n        } catch (err) {\n          incomingLogger.error({\n            msg: 'Error running Script in Trigger',\n            integration: this.integration.name,\n            script: this.integration.scriptCompiled,\n            err\n          });\n          return API.v1.failure('error-running-script');\n        }\n      }\n\n      // TODO: Turn this into an option on the integrations - no body means a success\n      // TODO: Temporary fix for https://github.com/RocketChat/Rocket.Chat/issues/7770 until the above is implemented\n      if (!this.bodyParams || _.isEmpty(this.bodyParams) && !this.integration.scriptEnabled) {\n        // return RocketChat.API.v1.failure('body-empty');\n        return API.v1.success();\n      }\n      if ((this.bodyParams.channel || this.bodyParams.roomId) && !this.integration.overrideDestinationChannelEnabled) {\n        return API.v1.failure('overriding destination channel is disabled for this integration');\n      }\n      this.bodyParams.bot = {\n        i: this.integration._id\n      };\n      try {\n        const message = await processWebhookMessage(this.bodyParams, this.user, defaultValues);\n        if (_.isEmpty(message)) {\n          return API.v1.failure('unknown-error');\n        }\n        if (this.scriptResponse) {\n          incomingLogger.debug({\n            msg: 'response',\n            response: this.scriptResponse\n          });\n        }\n        return API.v1.success(this.scriptResponse);\n      } catch ({\n        error,\n        message\n      }) {\n        return API.v1.failure(error || message);\n      }\n    }\n    function addIntegrationRest() {\n      return createIntegration(this.bodyParams, this.user);\n    }\n    async function removeIntegrationRest() {\n      return removeIntegration(this.bodyParams, this.user);\n    }\n    function integrationSampleRest() {\n      incomingLogger.info('Sample Integration');\n      return {\n        statusCode: 200,\n        body: [{\n          token: Random.id(24),\n          channel_id: Random.id(),\n          channel_name: 'general',\n          timestamp: new Date(),\n          user_id: Random.id(),\n          user_name: 'rocket.cat',\n          text: 'Sample text 1',\n          trigger_word: 'Sample'\n        }, {\n          token: Random.id(24),\n          channel_id: Random.id(),\n          channel_name: 'general',\n          timestamp: new Date(),\n          user_id: Random.id(),\n          user_name: 'rocket.cat',\n          text: 'Sample text 2',\n          trigger_word: 'Sample'\n        }, {\n          token: Random.id(24),\n          channel_id: Random.id(),\n          channel_name: 'general',\n          timestamp: new Date(),\n          user_id: Random.id(),\n          user_name: 'rocket.cat',\n          text: 'Sample text 3',\n          trigger_word: 'Sample'\n        }]\n      };\n    }\n    function integrationInfoRest() {\n      incomingLogger.info('Info integration');\n      return {\n        statusCode: 200,\n        body: {\n          success: true\n        }\n      };\n    }\n    class WebHookAPI extends APIClass {\n      /* Webhooks are not versioned, so we must not validate we know a version before adding a rate limiter */\n      shouldAddRateLimitToRoute(options) {\n        const {\n          rateLimiterOptions\n        } = options;\n        return (typeof rateLimiterOptions === 'object' || rateLimiterOptions === undefined) && !process.env.TEST_MODE && Boolean(defaultRateLimiterOptions.numRequestsAllowed && defaultRateLimiterOptions.intervalTimeInMS);\n      }\n      async shouldVerifyRateLimit( /* route */\n      ) {\n        return settings.get('API_Enable_Rate_Limiter') === true && (process.env.NODE_ENV !== 'development' || settings.get('API_Enable_Rate_Limiter_Dev') === true);\n      }\n\n      /*\n      There is only one generic route propagated to Restivus which has URL-path-parameters for the integration and the token.\n      Since the rate-limiter operates on absolute routes, we need to add a limiter to the absolute url before we can validate it\n      */\n      async enforceRateLimit(objectForRateLimitMatch, request, response, userId) {\n        const {\n          method,\n          url\n        } = request;\n        const route = url.replace(\"/\".concat(this.apiPath), '');\n        const nameRoute = this.getFullRouteName(route, [method.toLowerCase()]);\n        // We'll be creating rate limiters on demand (when validating for the first time).\n        // This is possible since *all* integration hooks should be rate limited the same way.\n        // This way, we'll not have to add new limiters as new integrations are added\n        if (!this.getRateLimiter(nameRoute)) {\n          this.addRateLimiterRuleForRoutes({\n            routes: [route],\n            rateLimiterOptions: defaultRateLimiterOptions,\n            endpoints: {\n              post: executeIntegrationRest,\n              get: executeIntegrationRest\n            }\n          });\n        }\n        const integrationForRateLimitMatch = objectForRateLimitMatch;\n        integrationForRateLimitMatch.route = nameRoute;\n        super.enforceRateLimit(integrationForRateLimitMatch, request, response, userId);\n      }\n    }\n    const Api = new WebHookAPI({\n      enableCors: true,\n      apiPath: 'hooks/',\n      auth: {\n        async user() {\n          const payloadKeys = Object.keys(this.bodyParams);\n          const payloadIsWrapped = this.bodyParams && this.bodyParams.payload && payloadKeys.length === 1;\n          if (payloadIsWrapped && this.request.headers['content-type'] === 'application/x-www-form-urlencoded') {\n            try {\n              this.bodyParams = JSON.parse(this.bodyParams.payload);\n            } catch ({\n              message\n            }) {\n              return {\n                error: {\n                  statusCode: 400,\n                  body: {\n                    success: false,\n                    error: message\n                  }\n                }\n              };\n            }\n          }\n          this.integration = await Integrations.findOne({\n            _id: this.request.params.integrationId,\n            token: decodeURIComponent(this.request.params.token)\n          });\n          if (!this.integration) {\n            incomingLogger.info(\"Invalid integration id \".concat(this.request.params.integrationId, \" or token \").concat(this.request.params.token));\n            return {\n              error: {\n                statusCode: 404,\n                body: {\n                  success: false,\n                  error: 'Invalid integration id or token provided.'\n                }\n              }\n            };\n          }\n          const user = await Users.findOne({\n            _id: this.integration.userId\n          });\n          return {\n            user\n          };\n        }\n      }\n    });\n    Api.addRoute(':integrationId/:userId/:token', {\n      authRequired: true\n    }, {\n      post: executeIntegrationRest,\n      get: executeIntegrationRest\n    });\n    Api.addRoute(':integrationId/:token', {\n      authRequired: true\n    }, {\n      post: executeIntegrationRest,\n      get: executeIntegrationRest\n    });\n    Api.addRoute('sample/:integrationId/:userId/:token', {\n      authRequired: true\n    }, {\n      get: integrationSampleRest\n    });\n    Api.addRoute('sample/:integrationId/:token', {\n      authRequired: true\n    }, {\n      get: integrationSampleRest\n    });\n    Api.addRoute('info/:integrationId/:userId/:token', {\n      authRequired: true\n    }, {\n      get: integrationInfoRest\n    });\n    Api.addRoute('info/:integrationId/:token', {\n      authRequired: true\n    }, {\n      get: integrationInfoRest\n    });\n    Api.addRoute('add/:integrationId/:userId/:token', {\n      authRequired: true\n    }, {\n      post: addIntegrationRest\n    });\n    Api.addRoute('add/:integrationId/:token', {\n      authRequired: true\n    }, {\n      post: addIntegrationRest\n    });\n    Api.addRoute('remove/:integrationId/:userId/:token', {\n      authRequired: true\n    }, {\n      post: removeIntegrationRest\n    });\n    Api.addRoute('remove/:integrationId/:token', {\n      authRequired: true\n    }, {\n      post: removeIntegrationRest\n    });\n    __reify_async_result__();\n  } catch (_reifyError) {\n    return __reify_async_result__(_reifyError);\n  }\n  __reify_async_result__()\n}, {\n  self: this,\n  async: false\n});","map":{"version":3,"names":["Integrations","Users","module","link","v","Random","_","default","API","APIClass","defaultRateLimiterOptions","processWebhookMessage","settings","IsolatedVMScriptEngine","incomingLogger","addOutgoingIntegration","deleteOutgoingIntegration","__reifyWaitForDeps__","ivmEngine","getEngine","_integration","createIntegration","options","user","info","msg","integration","name","debug","event","data","channel_name","indexOf","concat","_id","username","urls","target_url","channel","triggerWords","trigger_words","v1","success","removeIntegration","integrationToRemove","findOneByUrl","failure","executeIntegrationRest","urlParams","bodyParams","enabled","statusCode","body","defaultValues","alias","avatar","emoji","scriptEngine","integrationHasValidScript","request","setEncoding","content_raw","read","url","hash","_parsedUrl","search","query","queryParams","pathname","path","url_raw","url_params","content","headers","result","processIncomingRequest","error","scriptResponse","response","err","script","scriptCompiled","isEmpty","scriptEnabled","roomId","overrideDestinationChannelEnabled","bot","i","message","addIntegrationRest","removeIntegrationRest","integrationSampleRest","token","id","channel_id","timestamp","Date","user_id","user_name","text","trigger_word","integrationInfoRest","WebHookAPI","shouldAddRateLimitToRoute","rateLimiterOptions","undefined","process","env","TEST_MODE","Boolean","numRequestsAllowed","intervalTimeInMS","shouldVerifyRateLimit","get","NODE_ENV","enforceRateLimit","objectForRateLimitMatch","userId","method","route","replace","apiPath","nameRoute","getFullRouteName","toLowerCase","getRateLimiter","addRateLimiterRuleForRoutes","routes","endpoints","post","integrationForRateLimitMatch","Api","enableCors","auth","payloadKeys","Object","keys","payloadIsWrapped","payload","length","JSON","parse","findOne","params","integrationId","decodeURIComponent","addRoute","authRequired","__reify_async_result__","_reifyError","self","async"],"sources":["app/integrations/server/api/api.js"],"sourcesContent":["import { Integrations, Users } from '@rocket.chat/models';\nimport { Random } from '@rocket.chat/random';\nimport _ from 'underscore';\n\nimport { API, APIClass, defaultRateLimiterOptions } from '../../../api/server';\nimport { processWebhookMessage } from '../../../lib/server/functions/processWebhookMessage';\nimport { settings } from '../../../settings/server';\nimport { IsolatedVMScriptEngine } from '../lib/isolated-vm/isolated-vm';\nimport { incomingLogger } from '../logger';\nimport { addOutgoingIntegration } from '../methods/outgoing/addOutgoingIntegration';\nimport { deleteOutgoingIntegration } from '../methods/outgoing/deleteOutgoingIntegration';\n\nconst ivmEngine = new IsolatedVMScriptEngine(true);\n\n// eslint-disable-next-line no-unused-vars\nfunction getEngine(_integration) {\n\treturn ivmEngine;\n}\n\nasync function createIntegration(options, user) {\n\tincomingLogger.info({ msg: 'Add integration', integration: options.name });\n\tincomingLogger.debug({ options });\n\n\tswitch (options.event) {\n\t\tcase 'newMessageOnChannel':\n\t\t\tif (options.data == null) {\n\t\t\t\toptions.data = {};\n\t\t\t}\n\t\t\tif (options.data.channel_name != null && options.data.channel_name.indexOf('#') === -1) {\n\t\t\t\toptions.data.channel_name = `#${options.data.channel_name}`;\n\t\t\t}\n\t\t\treturn addOutgoingIntegration(user._id, {\n\t\t\t\tusername: 'rocket.cat',\n\t\t\t\turls: [options.target_url],\n\t\t\t\tname: options.name,\n\t\t\t\tchannel: options.data.channel_name,\n\t\t\t\ttriggerWords: options.data.trigger_words,\n\t\t\t});\n\t\tcase 'newMessageToUser':\n\t\t\tif (options.data.username.indexOf('@') === -1) {\n\t\t\t\toptions.data.username = `@${options.data.username}`;\n\t\t\t}\n\t\t\treturn addOutgoingIntegration(user._id, {\n\t\t\t\tusername: 'rocket.cat',\n\t\t\t\turls: [options.target_url],\n\t\t\t\tname: options.name,\n\t\t\t\tchannel: options.data.username,\n\t\t\t\ttriggerWords: options.data.trigger_words,\n\t\t\t});\n\t}\n\n\treturn API.v1.success();\n}\n\nasync function removeIntegration(options, user) {\n\tincomingLogger.info('Remove integration');\n\tincomingLogger.debug({ options });\n\n\tconst integrationToRemove = await Integrations.findOneByUrl(options.target_url);\n\tif (!integrationToRemove) {\n\t\treturn API.v1.failure('integration-not-found');\n\t}\n\n\tawait deleteOutgoingIntegration(integrationToRemove._id, user._id);\n\n\treturn API.v1.success();\n}\n\nasync function executeIntegrationRest() {\n\tincomingLogger.info({ msg: 'Post integration:', integration: this.integration.name });\n\tincomingLogger.debug({ urlParams: this.urlParams, bodyParams: this.bodyParams });\n\n\tif (this.integration.enabled !== true) {\n\t\treturn {\n\t\t\tstatusCode: 503,\n\t\t\tbody: 'Service Unavailable',\n\t\t};\n\t}\n\n\tconst defaultValues = {\n\t\tchannel: this.integration.channel,\n\t\talias: this.integration.alias,\n\t\tavatar: this.integration.avatar,\n\t\temoji: this.integration.emoji,\n\t};\n\n\tconst scriptEngine = getEngine(this.integration);\n\n\tif (scriptEngine.integrationHasValidScript(this.integration)) {\n\t\tthis.request.setEncoding('utf8');\n\t\tconst content_raw = this.request.read();\n\n\t\tconst request = {\n\t\t\turl: {\n\t\t\t\thash: this.request._parsedUrl.hash,\n\t\t\t\tsearch: this.request._parsedUrl.search,\n\t\t\t\tquery: this.queryParams,\n\t\t\t\tpathname: this.request._parsedUrl.pathname,\n\t\t\t\tpath: this.request._parsedUrl.path,\n\t\t\t},\n\t\t\turl_raw: this.request.url,\n\t\t\turl_params: this.urlParams,\n\t\t\tcontent: this.bodyParams,\n\t\t\tcontent_raw,\n\t\t\theaders: this.request.headers,\n\t\t\tbody: this.request.body,\n\t\t\tuser: {\n\t\t\t\t_id: this.user._id,\n\t\t\t\tname: this.user.name,\n\t\t\t\tusername: this.user.username,\n\t\t\t},\n\t\t};\n\n\t\tconst result = await scriptEngine.processIncomingRequest({\n\t\t\tintegration: this.integration,\n\t\t\trequest,\n\t\t});\n\n\t\ttry {\n\t\t\tif (!result) {\n\t\t\t\tincomingLogger.debug({\n\t\t\t\t\tmsg: 'Process Incoming Request result of Trigger has no data',\n\t\t\t\t\tintegration: this.integration.name,\n\t\t\t\t});\n\t\t\t\treturn API.v1.success();\n\t\t\t}\n\t\t\tif (result && result.error) {\n\t\t\t\treturn API.v1.failure(result.error);\n\t\t\t}\n\n\t\t\tthis.bodyParams = result && result.content;\n\t\t\tthis.scriptResponse = result.response;\n\t\t\tif (result.user) {\n\t\t\t\tthis.user = result.user;\n\t\t\t}\n\n\t\t\tincomingLogger.debug({\n\t\t\t\tmsg: 'Process Incoming Request result of Trigger',\n\t\t\t\tintegration: this.integration.name,\n\t\t\t\tresult: this.bodyParams,\n\t\t\t});\n\t\t} catch (err) {\n\t\t\tincomingLogger.error({\n\t\t\t\tmsg: 'Error running Script in Trigger',\n\t\t\t\tintegration: this.integration.name,\n\t\t\t\tscript: this.integration.scriptCompiled,\n\t\t\t\terr,\n\t\t\t});\n\t\t\treturn API.v1.failure('error-running-script');\n\t\t}\n\t}\n\n\t// TODO: Turn this into an option on the integrations - no body means a success\n\t// TODO: Temporary fix for https://github.com/RocketChat/Rocket.Chat/issues/7770 until the above is implemented\n\tif (!this.bodyParams || (_.isEmpty(this.bodyParams) && !this.integration.scriptEnabled)) {\n\t\t// return RocketChat.API.v1.failure('body-empty');\n\t\treturn API.v1.success();\n\t}\n\n\tif ((this.bodyParams.channel || this.bodyParams.roomId) && !this.integration.overrideDestinationChannelEnabled) {\n\t\treturn API.v1.failure('overriding destination channel is disabled for this integration');\n\t}\n\n\tthis.bodyParams.bot = { i: this.integration._id };\n\n\ttry {\n\t\tconst message = await processWebhookMessage(this.bodyParams, this.user, defaultValues);\n\t\tif (_.isEmpty(message)) {\n\t\t\treturn API.v1.failure('unknown-error');\n\t\t}\n\n\t\tif (this.scriptResponse) {\n\t\t\tincomingLogger.debug({ msg: 'response', response: this.scriptResponse });\n\t\t}\n\n\t\treturn API.v1.success(this.scriptResponse);\n\t} catch ({ error, message }) {\n\t\treturn API.v1.failure(error || message);\n\t}\n}\n\nfunction addIntegrationRest() {\n\treturn createIntegration(this.bodyParams, this.user);\n}\n\nasync function removeIntegrationRest() {\n\treturn removeIntegration(this.bodyParams, this.user);\n}\n\nfunction integrationSampleRest() {\n\tincomingLogger.info('Sample Integration');\n\treturn {\n\t\tstatusCode: 200,\n\t\tbody: [\n\t\t\t{\n\t\t\t\ttoken: Random.id(24),\n\t\t\t\tchannel_id: Random.id(),\n\t\t\t\tchannel_name: 'general',\n\t\t\t\ttimestamp: new Date(),\n\t\t\t\tuser_id: Random.id(),\n\t\t\t\tuser_name: 'rocket.cat',\n\t\t\t\ttext: 'Sample text 1',\n\t\t\t\ttrigger_word: 'Sample',\n\t\t\t},\n\t\t\t{\n\t\t\t\ttoken: Random.id(24),\n\t\t\t\tchannel_id: Random.id(),\n\t\t\t\tchannel_name: 'general',\n\t\t\t\ttimestamp: new Date(),\n\t\t\t\tuser_id: Random.id(),\n\t\t\t\tuser_name: 'rocket.cat',\n\t\t\t\ttext: 'Sample text 2',\n\t\t\t\ttrigger_word: 'Sample',\n\t\t\t},\n\t\t\t{\n\t\t\t\ttoken: Random.id(24),\n\t\t\t\tchannel_id: Random.id(),\n\t\t\t\tchannel_name: 'general',\n\t\t\t\ttimestamp: new Date(),\n\t\t\t\tuser_id: Random.id(),\n\t\t\t\tuser_name: 'rocket.cat',\n\t\t\t\ttext: 'Sample text 3',\n\t\t\t\ttrigger_word: 'Sample',\n\t\t\t},\n\t\t],\n\t};\n}\n\nfunction integrationInfoRest() {\n\tincomingLogger.info('Info integration');\n\treturn {\n\t\tstatusCode: 200,\n\t\tbody: {\n\t\t\tsuccess: true,\n\t\t},\n\t};\n}\n\nclass WebHookAPI extends APIClass {\n\t/* Webhooks are not versioned, so we must not validate we know a version before adding a rate limiter */\n\tshouldAddRateLimitToRoute(options) {\n\t\tconst { rateLimiterOptions } = options;\n\t\treturn (\n\t\t\t(typeof rateLimiterOptions === 'object' || rateLimiterOptions === undefined) &&\n\t\t\t!process.env.TEST_MODE &&\n\t\t\tBoolean(defaultRateLimiterOptions.numRequestsAllowed && defaultRateLimiterOptions.intervalTimeInMS)\n\t\t);\n\t}\n\n\tasync shouldVerifyRateLimit(/* route */) {\n\t\treturn (\n\t\t\tsettings.get('API_Enable_Rate_Limiter') === true &&\n\t\t\t(process.env.NODE_ENV !== 'development' || settings.get('API_Enable_Rate_Limiter_Dev') === true)\n\t\t);\n\t}\n\n\t/*\n\tThere is only one generic route propagated to Restivus which has URL-path-parameters for the integration and the token.\n\tSince the rate-limiter operates on absolute routes, we need to add a limiter to the absolute url before we can validate it\n\t*/\n\tasync enforceRateLimit(objectForRateLimitMatch, request, response, userId) {\n\t\tconst { method, url } = request;\n\t\tconst route = url.replace(`/${this.apiPath}`, '');\n\t\tconst nameRoute = this.getFullRouteName(route, [method.toLowerCase()]);\n\t\t// We'll be creating rate limiters on demand (when validating for the first time).\n\t\t// This is possible since *all* integration hooks should be rate limited the same way.\n\t\t// This way, we'll not have to add new limiters as new integrations are added\n\t\tif (!this.getRateLimiter(nameRoute)) {\n\t\t\tthis.addRateLimiterRuleForRoutes({\n\t\t\t\troutes: [route],\n\t\t\t\trateLimiterOptions: defaultRateLimiterOptions,\n\t\t\t\tendpoints: {\n\t\t\t\t\tpost: executeIntegrationRest,\n\t\t\t\t\tget: executeIntegrationRest,\n\t\t\t\t},\n\t\t\t});\n\t\t}\n\n\t\tconst integrationForRateLimitMatch = objectForRateLimitMatch;\n\t\tintegrationForRateLimitMatch.route = nameRoute;\n\n\t\tsuper.enforceRateLimit(integrationForRateLimitMatch, request, response, userId);\n\t}\n}\n\nconst Api = new WebHookAPI({\n\tenableCors: true,\n\tapiPath: 'hooks/',\n\tauth: {\n\t\tasync user() {\n\t\t\tconst payloadKeys = Object.keys(this.bodyParams);\n\t\t\tconst payloadIsWrapped = this.bodyParams && this.bodyParams.payload && payloadKeys.length === 1;\n\t\t\tif (payloadIsWrapped && this.request.headers['content-type'] === 'application/x-www-form-urlencoded') {\n\t\t\t\ttry {\n\t\t\t\t\tthis.bodyParams = JSON.parse(this.bodyParams.payload);\n\t\t\t\t} catch ({ message }) {\n\t\t\t\t\treturn {\n\t\t\t\t\t\terror: {\n\t\t\t\t\t\t\tstatusCode: 400,\n\t\t\t\t\t\t\tbody: {\n\t\t\t\t\t\t\t\tsuccess: false,\n\t\t\t\t\t\t\t\terror: message,\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t};\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tthis.integration = await Integrations.findOne({\n\t\t\t\t_id: this.request.params.integrationId,\n\t\t\t\ttoken: decodeURIComponent(this.request.params.token),\n\t\t\t});\n\n\t\t\tif (!this.integration) {\n\t\t\t\tincomingLogger.info(`Invalid integration id ${this.request.params.integrationId} or token ${this.request.params.token}`);\n\n\t\t\t\treturn {\n\t\t\t\t\terror: {\n\t\t\t\t\t\tstatusCode: 404,\n\t\t\t\t\t\tbody: {\n\t\t\t\t\t\t\tsuccess: false,\n\t\t\t\t\t\t\terror: 'Invalid integration id or token provided.',\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t};\n\t\t\t}\n\n\t\t\tconst user = await Users.findOne({\n\t\t\t\t_id: this.integration.userId,\n\t\t\t});\n\n\t\t\treturn { user };\n\t\t},\n\t},\n});\n\nApi.addRoute(\n\t':integrationId/:userId/:token',\n\t{ authRequired: true },\n\t{\n\t\tpost: executeIntegrationRest,\n\t\tget: executeIntegrationRest,\n\t},\n);\n\nApi.addRoute(\n\t':integrationId/:token',\n\t{ authRequired: true },\n\t{\n\t\tpost: executeIntegrationRest,\n\t\tget: executeIntegrationRest,\n\t},\n);\n\nApi.addRoute(\n\t'sample/:integrationId/:userId/:token',\n\t{ authRequired: true },\n\t{\n\t\tget: integrationSampleRest,\n\t},\n);\n\nApi.addRoute(\n\t'sample/:integrationId/:token',\n\t{ authRequired: true },\n\t{\n\t\tget: integrationSampleRest,\n\t},\n);\n\nApi.addRoute(\n\t'info/:integrationId/:userId/:token',\n\t{ authRequired: true },\n\t{\n\t\tget: integrationInfoRest,\n\t},\n);\n\nApi.addRoute(\n\t'info/:integrationId/:token',\n\t{ authRequired: true },\n\t{\n\t\tget: integrationInfoRest,\n\t},\n);\n\nApi.addRoute(\n\t'add/:integrationId/:userId/:token',\n\t{ authRequired: true },\n\t{\n\t\tpost: addIntegrationRest,\n\t},\n);\n\nApi.addRoute(\n\t'add/:integrationId/:token',\n\t{ authRequired: true },\n\t{\n\t\tpost: addIntegrationRest,\n\t},\n);\n\nApi.addRoute(\n\t'remove/:integrationId/:userId/:token',\n\t{ authRequired: true },\n\t{\n\t\tpost: removeIntegrationRest,\n\t},\n);\n\nApi.addRoute(\n\t'remove/:integrationId/:token',\n\t{ authRequired: true },\n\t{\n\t\tpost: removeIntegrationRest,\n\t},\n);\n"],"mappings":"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","ignoreList":[]},"sourceType":"module","externalDependencies":{},"hash":"b15b7e56dd2d04521555524716b3ee438af50521"}
