{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/packages/rocketchat:restivus/lib/auth.js","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","topLevelAwait","objectRestSpread","objectRestSpread","asyncGenerators","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"os.osx.arm64"},"sourceFileName":"packages/rocketchat:restivus/lib/auth.js","filename":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/packages/rocketchat:restivus/lib/auth.js","targets":{"android":"125.0.0","chrome":"125.0.0","edge":"125.0.0","firefox":"115.0.0","ie":"10.0.0","ios":"17.4.0","opera":"110.0.0","opera_mobile":"80.0.0","safari":"17.4.0","samsung":"24.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor","root":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":false,"enforceStrictMode":false,"dynamicImport":true,"generateLetDeclarations":true,"topLevelAwait":true},"externalDependencies":[]},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"version":"7.17.2","helpers":true,"useESModules":false,"corejs":false},"externalDependencies":[]},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-async-generator-functions","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-class-properties","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true},"externalDependencies":[]},{"key":"transform-react-jsx","visitor":{"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXFragment":{"exit":[null]},"JSXElement":{"exit":[null]},"JSXAttribute":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false},"externalDependencies":[]},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-nullish-coalescing-operator","visitor":{"LogicalExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-optional-chaining","visitor":{"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-optional-catch-binding","visitor":{"CatchClause":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-class-properties","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-async-generator-functions","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-logical-assignment-operators","visitor":{"AssignmentExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]}],"presets":[],"generatorOpts":{"filename":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/packages/rocketchat:restivus/lib/auth.js","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"packages/rocketchat:restivus/lib/auth.js"}},"code":"!module.wrapAsync(async function (module, __reifyWaitForDeps__, __reify_async_result__) {\n  \"use strict\";\n  try {\n    module.export({\n      Auth: () => Auth\n    });\n    let Accounts;\n    module.link(\"meteor/accounts-base\", {\n      Accounts(v) {\n        Accounts = v;\n      }\n    }, 0);\n    let check, Match;\n    module.link(\"meteor/check\", {\n      check(v) {\n        check = v;\n      },\n      Match(v) {\n        Match = v;\n      }\n    }, 1);\n    let Meteor;\n    module.link(\"meteor/meteor\", {\n      Meteor(v) {\n        Meteor = v;\n      }\n    }, 2);\n    let Users;\n    module.link(\"@rocket.chat/models\", {\n      Users(v) {\n        Users = v;\n      }\n    }, 3);\n    if (__reifyWaitForDeps__()) (await __reifyWaitForDeps__())();\n    /*\n      A valid user will have exactly one of the following identification fields: id, username, or email\n    */\n    const userValidator = Match.Where(function (user) {\n      check(user, {\n        id: Match.Optional(String),\n        username: Match.Optional(String),\n        email: Match.Optional(String)\n      });\n      if (Object.keys(user).length !== 1) {\n        throw new Match.Error('User must have exactly one identifier field');\n      }\n      return true;\n    });\n\n    /*\n      A password can be either in plain text or hashed\n    */\n    const passwordValidator = Match.OneOf(String, {\n      digest: String,\n      algorithm: String\n    });\n\n    /*\n      Return a MongoDB query selector for finding the given user\n    */\n    const getUserQuerySelector = function (user) {\n      if (user.id) {\n        return {\n          _id: user.id\n        };\n      }\n      if (user.username) {\n        return {\n          username: user.username\n        };\n      }\n      if (user.email) {\n        return {\n          'emails.address': user.email\n        };\n      }\n\n      // We shouldn't be here if the user object was properly validated\n      throw new Error('Cannot create selector from invalid user');\n    };\n\n    /*\n      Log a user in with their password\n    */\n    class Auth {\n      async loginWithPassword(user, password) {\n        if (!user || !password) {\n          throw new Meteor.Error(401, 'Unauthorized');\n        }\n\n        // Validate the login input types\n        check(user, userValidator);\n        check(password, passwordValidator);\n\n        // Retrieve the user from the database\n        const authenticatingUserSelector = getUserQuerySelector(user);\n        const authenticatingUser = await Users.findOne(authenticatingUserSelector);\n        if (!authenticatingUser) {\n          throw new Meteor.Error(401, 'Unauthorized');\n        }\n        if (!(authenticatingUser.services != null ? authenticatingUser.services.password : undefined)) {\n          throw new Meteor.Error(401, 'Unauthorized');\n        }\n\n        // Authenticate the user's password\n        const passwordVerification = await Accounts._checkPasswordAsync(authenticatingUser, password);\n        if (passwordVerification.error) {\n          throw new Meteor.Error(401, 'Unauthorized');\n        }\n\n        // Add a new auth token to the user's account\n        const authToken = Accounts._generateStampedLoginToken();\n        const hashedToken = Accounts._hashLoginToken(authToken.token);\n        Accounts._insertHashedLoginToken(authenticatingUser._id, {\n          hashedToken\n        });\n        return {\n          authToken: authToken.token,\n          userId: authenticatingUser._id\n        };\n      }\n    }\n    __reify_async_result__();\n  } catch (_reifyError) {\n    return __reify_async_result__(_reifyError);\n  }\n  __reify_async_result__()\n}, {\n  self: this,\n  async: false\n});","map":{"version":3,"names":["module","export","Auth","Accounts","link","v","check","Match","Meteor","Users","__reifyWaitForDeps__","userValidator","Where","user","id","Optional","String","username","email","Object","keys","length","Error","passwordValidator","OneOf","digest","algorithm","getUserQuerySelector","_id","loginWithPassword","password","authenticatingUserSelector","authenticatingUser","findOne","services","undefined","passwordVerification","_checkPasswordAsync","error","authToken","_generateStampedLoginToken","hashedToken","_hashLoginToken","token","_insertHashedLoginToken","userId","__reify_async_result__","_reifyError","self","async"],"sources":["packages/rocketchat:restivus/lib/auth.js"],"sourcesContent":["/*\n * decaffeinate suggestions:\n * DS207: Consider shorter variations of null checks\n * DS208: Avoid top-level this\n * Full docs: https://github.com/decaffeinate/decaffeinate/blob/main/docs/suggestions.md\n */\n\nimport { Accounts } from 'meteor/accounts-base';\nimport { check, Match } from 'meteor/check';\nimport { Meteor } from 'meteor/meteor';\nimport { Users } from '@rocket.chat/models';\n\n/*\n  A valid user will have exactly one of the following identification fields: id, username, or email\n*/\nconst userValidator = Match.Where(function (user) {\n\tcheck(user, {\n\t\tid: Match.Optional(String),\n\t\tusername: Match.Optional(String),\n\t\temail: Match.Optional(String),\n\t});\n\n\tif (Object.keys(user).length !== 1) {\n\t\tthrow new Match.Error('User must have exactly one identifier field');\n\t}\n\n\treturn true;\n});\n\n/*\n  A password can be either in plain text or hashed\n*/\nconst passwordValidator = Match.OneOf(String, {\n\tdigest: String,\n\talgorithm: String,\n});\n\n/*\n  Return a MongoDB query selector for finding the given user\n*/\nconst getUserQuerySelector = function (user) {\n\tif (user.id) {\n\t\treturn { _id: user.id };\n\t}\n\tif (user.username) {\n\t\treturn { username: user.username };\n\t}\n\tif (user.email) {\n\t\treturn { 'emails.address': user.email };\n\t}\n\n\t// We shouldn't be here if the user object was properly validated\n\tthrow new Error('Cannot create selector from invalid user');\n};\n\n/*\n  Log a user in with their password\n*/\nexport class Auth {\n\tasync loginWithPassword(user, password) {\n\t\tif (!user || !password) {\n\t\t\tthrow new Meteor.Error(401, 'Unauthorized');\n\t\t}\n\n\t\t// Validate the login input types\n\t\tcheck(user, userValidator);\n\t\tcheck(password, passwordValidator);\n\n\t\t// Retrieve the user from the database\n\t\tconst authenticatingUserSelector = getUserQuerySelector(user);\n\t\tconst authenticatingUser = await Users.findOne(authenticatingUserSelector);\n\n\t\tif (!authenticatingUser) {\n\t\t\tthrow new Meteor.Error(401, 'Unauthorized');\n\t\t}\n\t\tif (!(authenticatingUser.services != null ? authenticatingUser.services.password : undefined)) {\n\t\t\tthrow new Meteor.Error(401, 'Unauthorized');\n\t\t}\n\n\t\t// Authenticate the user's password\n\t\tconst passwordVerification = await Accounts._checkPasswordAsync(authenticatingUser, password);\n\t\tif (passwordVerification.error) {\n\t\t\tthrow new Meteor.Error(401, 'Unauthorized');\n\t\t}\n\n\t\t// Add a new auth token to the user's account\n\t\tconst authToken = Accounts._generateStampedLoginToken();\n\t\tconst hashedToken = Accounts._hashLoginToken(authToken.token);\n\t\tAccounts._insertHashedLoginToken(authenticatingUser._id, { hashedToken });\n\n\t\treturn { authToken: authToken.token, userId: authenticatingUser._id };\n\t}\n}\n"],"mappings":"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","ignoreList":[]},"sourceType":"module","externalDependencies":{},"hash":"c5ecb8f91153f5472ff41ecf0c052e095ed11deb"}
