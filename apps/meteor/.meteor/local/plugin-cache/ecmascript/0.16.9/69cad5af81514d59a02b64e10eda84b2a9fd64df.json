{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/app/lib/server/oauth/google.js","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","topLevelAwait","objectRestSpread","objectRestSpread","asyncGenerators","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"os.osx.arm64"},"sourceFileName":"app/lib/server/oauth/google.js","filename":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/app/lib/server/oauth/google.js","targets":{"android":"125.0.0","chrome":"125.0.0","edge":"125.0.0","firefox":"115.0.0","ie":"10.0.0","ios":"17.4.0","opera":"110.0.0","opera_mobile":"80.0.0","safari":"17.4.0","samsung":"24.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor","root":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":false,"enforceStrictMode":false,"dynamicImport":true,"generateLetDeclarations":true,"topLevelAwait":true},"externalDependencies":[]},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"version":"7.17.2","helpers":true,"useESModules":false,"corejs":false},"externalDependencies":[]},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-async-generator-functions","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-class-properties","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true},"externalDependencies":[]},{"key":"transform-react-jsx","visitor":{"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXFragment":{"exit":[null]},"JSXElement":{"exit":[null]},"JSXAttribute":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false},"externalDependencies":[]},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-nullish-coalescing-operator","visitor":{"LogicalExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-optional-chaining","visitor":{"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-optional-catch-binding","visitor":{"CatchClause":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-class-properties","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-async-generator-functions","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-logical-assignment-operators","visitor":{"AssignmentExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]}],"presets":[],"generatorOpts":{"filename":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/app/lib/server/oauth/google.js","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"app/lib/server/oauth/google.js"}},"code":"!module.wrapAsync(async function (module, __reifyWaitForDeps__, __reify_async_result__) {\n  \"use strict\";\n  try {\n    let fetch;\n    module.link(\"@rocket.chat/server-fetch\", {\n      serverFetch(v) {\n        fetch = v;\n      }\n    }, 0);\n    let Match, check;\n    module.link(\"meteor/check\", {\n      Match(v) {\n        Match = v;\n      },\n      check(v) {\n        check = v;\n      }\n    }, 1);\n    let Google;\n    module.link(\"meteor/google-oauth\", {\n      Google(v) {\n        Google = v;\n      }\n    }, 2);\n    let _;\n    module.link(\"underscore\", {\n      default(v) {\n        _ = v;\n      }\n    }, 3);\n    let registerAccessTokenService;\n    module.link(\"./oauth\", {\n      registerAccessTokenService(v) {\n        registerAccessTokenService = v;\n      }\n    }, 4);\n    if (__reifyWaitForDeps__()) (await __reifyWaitForDeps__())();\n    async function getIdentity(accessToken) {\n      try {\n        const request = await fetch('https://www.googleapis.com/oauth2/v1/userinfo', {\n          params: {\n            access_token: accessToken\n          }\n        });\n        if (!request.ok) {\n          throw new Error(await request.text());\n        }\n        return request.json();\n      } catch (err) {\n        throw _.extend(new Error(\"Failed to fetch identity from Google. \".concat(err.message)), {\n          response: err.message\n        });\n      }\n    }\n    async function getScopes(accessToken) {\n      try {\n        const request = await fetch('https://www.googleapis.com/oauth2/v1/tokeninfo', {\n          params: {\n            access_token: accessToken\n          }\n        });\n        if (!request.ok) {\n          throw new Error(await request.text());\n        }\n        return (await request.json()).scope.split(' ');\n      } catch (err) {\n        throw _.extend(new Error(\"Failed to fetch tokeninfo from Google. \".concat(err.message)), {\n          response: err.message\n        });\n      }\n    }\n    registerAccessTokenService('google', async options => {\n      check(options, Match.ObjectIncluding({\n        accessToken: String,\n        idToken: String,\n        expiresIn: Match.Integer,\n        scope: Match.Maybe(String),\n        identity: Match.Maybe(Object)\n      }));\n      const identity = await getIdentity(options.accessToken);\n      const serviceData = {\n        accessToken: options.accessToken,\n        idToken: options.idToken,\n        expiresAt: +new Date() + 1000 * parseInt(options.expiresIn, 10),\n        scope: options.scopes || (await getScopes(options.accessToken))\n      };\n      const fields = _.pick(identity, Google.whitelistedFields);\n      _.extend(serviceData, fields);\n\n      // only set the token in serviceData if it's there. this ensures\n      // that we don't lose old ones (since we only get this on the first\n      // log in attempt)\n      if (options.refreshToken) {\n        serviceData.refreshToken = options.refreshToken;\n      }\n      return {\n        serviceData,\n        options: {\n          profile: {\n            name: identity.name\n          }\n        }\n      };\n    });\n    __reify_async_result__();\n  } catch (_reifyError) {\n    return __reify_async_result__(_reifyError);\n  }\n  __reify_async_result__()\n}, {\n  self: this,\n  async: false\n});","map":{"version":3,"names":["fetch","module","link","serverFetch","v","Match","check","Google","_","default","registerAccessTokenService","__reifyWaitForDeps__","getIdentity","accessToken","request","params","access_token","ok","Error","text","json","err","extend","concat","message","response","getScopes","scope","split","options","ObjectIncluding","String","idToken","expiresIn","Integer","Maybe","identity","Object","serviceData","expiresAt","Date","parseInt","scopes","fields","pick","whitelistedFields","refreshToken","profile","name","__reify_async_result__","_reifyError","self","async"],"sources":["app/lib/server/oauth/google.js"],"sourcesContent":["import { serverFetch as fetch } from '@rocket.chat/server-fetch';\nimport { Match, check } from 'meteor/check';\nimport { Google } from 'meteor/google-oauth';\nimport _ from 'underscore';\n\nimport { registerAccessTokenService } from './oauth';\n\nasync function getIdentity(accessToken) {\n\ttry {\n\t\tconst request = await fetch('https://www.googleapis.com/oauth2/v1/userinfo', {\n\t\t\tparams: { access_token: accessToken },\n\t\t});\n\n\t\tif (!request.ok) {\n\t\t\tthrow new Error(await request.text());\n\t\t}\n\n\t\treturn request.json();\n\t} catch (err) {\n\t\tthrow _.extend(new Error(`Failed to fetch identity from Google. ${err.message}`), {\n\t\t\tresponse: err.message,\n\t\t});\n\t}\n}\n\nasync function getScopes(accessToken) {\n\ttry {\n\t\tconst request = await fetch('https://www.googleapis.com/oauth2/v1/tokeninfo', {\n\t\t\tparams: { access_token: accessToken },\n\t\t});\n\n\t\tif (!request.ok) {\n\t\t\tthrow new Error(await request.text());\n\t\t}\n\n\t\treturn (await request.json()).scope.split(' ');\n\t} catch (err) {\n\t\tthrow _.extend(new Error(`Failed to fetch tokeninfo from Google. ${err.message}`), {\n\t\t\tresponse: err.message,\n\t\t});\n\t}\n}\n\nregisterAccessTokenService('google', async (options) => {\n\tcheck(\n\t\toptions,\n\t\tMatch.ObjectIncluding({\n\t\t\taccessToken: String,\n\t\t\tidToken: String,\n\t\t\texpiresIn: Match.Integer,\n\t\t\tscope: Match.Maybe(String),\n\t\t\tidentity: Match.Maybe(Object),\n\t\t}),\n\t);\n\n\tconst identity = await getIdentity(options.accessToken);\n\n\tconst serviceData = {\n\t\taccessToken: options.accessToken,\n\t\tidToken: options.idToken,\n\t\texpiresAt: +new Date() + 1000 * parseInt(options.expiresIn, 10),\n\t\tscope: options.scopes || (await getScopes(options.accessToken)),\n\t};\n\n\tconst fields = _.pick(identity, Google.whitelistedFields);\n\t_.extend(serviceData, fields);\n\n\t// only set the token in serviceData if it's there. this ensures\n\t// that we don't lose old ones (since we only get this on the first\n\t// log in attempt)\n\tif (options.refreshToken) {\n\t\tserviceData.refreshToken = options.refreshToken;\n\t}\n\n\treturn {\n\t\tserviceData,\n\t\toptions: {\n\t\t\tprofile: {\n\t\t\t\tname: identity.name,\n\t\t\t},\n\t\t},\n\t};\n});\n"],"mappings":"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","ignoreList":[]},"sourceType":"module","externalDependencies":{},"hash":"69cad5af81514d59a02b64e10eda84b2a9fd64df"}
