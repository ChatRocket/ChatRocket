{"code":"function module(e,t,a){let n,r,p,l,s,i,o,u,c,d,k,m,A,f,h;a.export({useInstallApp:()=>y}),a.link(\"@rocket.chat/ui-contexts\",{useRouter(e){n=e},useSetModal(e){r=e},useUpload(e){p=e}},0),a.link(\"@tanstack/react-query\",{useMutation(e){l=e}},1),a.link(\"react\",{default(e){s=e},useCallback(e){i=e},useState(e){o=e}},2),a.link(\"../../../apps/orchestrator\",{AppClientOrchestratorInstance(e){u=e}},3),a.link(\"../../../contexts/hooks/useAppsReload\",{useAppsReload(e){c=e}},4),a.link(\"../AppPermissionsReviewModal\",{default(e){d=e}},5),a.link(\"../AppUpdateModal\",{default(e){k=e}},6),a.link(\"../helpers/handleAPIError\",{handleAPIError(e){m=e}},7),a.link(\"../helpers/handleInstallError\",{handleInstallError(e){A=e}},8),a.link(\"../lib/getManifestFromZippedApp\",{getManifestFromZippedApp(e){f=e}},9),a.link(\"./useAppsCountQuery\",{useAppsCountQuery(e){h=e}},10);let y=e=>{let t=c(),a=r(),y=n(),E=h(\"private\"),g=p(\"/apps\"),w=p(\"/apps/update\"),[C,I]=o(!1),{mutate:M}=l([\"apps/installPrivateApp\"],e=>{let{permissionsGranted:t,appFile:a,appId:n}=e,r=new FormData;return(r.append(\"app\",a,a.name),r.append(\"permissions\",JSON.stringify(t)),n)?w(r):g(r)},{onSuccess:e=>{y.navigate({name:\"marketplace\",params:{context:\"private\",page:\"info\",id:e.app.id}})},onError:e=>{m(e)},onSettled:()=>{I(!1),a(null),t()}}),v=i(()=>{I(!1),a(null)},[I,a]),P=async e=>{try{let t=await u.getApp(e);return!!t}catch(e){return!1}},S=async(e,t,n)=>{a(s.createElement(d,{appPermissions:e,onCancel:v,onConfirm:e=>M({permissionsGranted:e,appFile:t,appId:n})}))},x=async(e,t)=>{let{id:n,permissions:r}=t,p=await P(n);if(p)return a(s.createElement(k,{cancel:v,confirm:()=>S(r,e,n)}));await S(r,e)},R=async e=>{try{return f(e)}catch(e){A(e)}},F=async()=>{if(I(!0),!E.data||!e)return v();let t=await R(e);return t?x(e,t):v()};return{install:F,isInstalling:C}}}","map":"{\"version\":3,\"sources\":[\"client/views/marketplace/hooks/useInstallApp.tsx\",\"<anon>\"],\"sourcesContent\":[\"import type { App, AppPermission } from '@rocket.chat/core-typings';\\nimport { useRouter, useSetModal, useUpload } from '@rocket.chat/ui-contexts';\\nimport { useMutation } from '@tanstack/react-query';\\nimport React, { useCallback, useState } from 'react';\\n\\nimport { AppClientOrchestratorInstance } from '../../../apps/orchestrator';\\nimport { useAppsReload } from '../../../contexts/hooks/useAppsReload';\\nimport AppPermissionsReviewModal from '../AppPermissionsReviewModal';\\nimport AppUpdateModal from '../AppUpdateModal';\\nimport { handleAPIError } from '../helpers/handleAPIError';\\nimport { handleInstallError } from '../helpers/handleInstallError';\\nimport { getManifestFromZippedApp } from '../lib/getManifestFromZippedApp';\\nimport { useAppsCountQuery } from './useAppsCountQuery';\\n\\nexport const useInstallApp = (file: File): { install: () => void; isInstalling: boolean } => {\\n\\tconst reloadAppsList = useAppsReload();\\n\\tconst setModal = useSetModal();\\n\\n\\tconst router = useRouter();\\n\\n\\tconst appCountQuery = useAppsCountQuery('private');\\n\\n\\tconst uploadAppEndpoint = useUpload('/apps');\\n\\tconst uploadUpdateEndpoint = useUpload('/apps/update');\\n\\n\\tconst [isInstalling, setInstalling] = useState(false);\\n\\n\\tconst { mutate: sendFile } = useMutation(\\n\\t\\t['apps/installPrivateApp'],\\n\\t\\t({ permissionsGranted, appFile, appId }: { permissionsGranted: AppPermission[]; appFile: File; appId?: string }) => {\\n\\t\\t\\tconst fileData = new FormData();\\n\\t\\t\\tfileData.append('app', appFile, appFile.name);\\n\\t\\t\\tfileData.append('permissions', JSON.stringify(permissionsGranted));\\n\\n\\t\\t\\tif (appId) {\\n\\t\\t\\t\\treturn uploadUpdateEndpoint(fileData);\\n\\t\\t\\t}\\n\\n\\t\\t\\treturn uploadAppEndpoint(fileData) as any;\\n\\t\\t},\\n\\t\\t{\\n\\t\\t\\tonSuccess: (data: { app: App }) => {\\n\\t\\t\\t\\trouter.navigate({\\n\\t\\t\\t\\t\\tname: 'marketplace',\\n\\t\\t\\t\\t\\tparams: {\\n\\t\\t\\t\\t\\t\\tcontext: 'private',\\n\\t\\t\\t\\t\\t\\tpage: 'info',\\n\\t\\t\\t\\t\\t\\tid: data.app.id,\\n\\t\\t\\t\\t\\t},\\n\\t\\t\\t\\t});\\n\\t\\t\\t},\\n\\t\\t\\tonError: (e) => {\\n\\t\\t\\t\\thandleAPIError(e);\\n\\t\\t\\t},\\n\\t\\t\\tonSettled: () => {\\n\\t\\t\\t\\tsetInstalling(false);\\n\\t\\t\\t\\tsetModal(null);\\n\\t\\t\\t\\treloadAppsList();\\n\\t\\t\\t},\\n\\t\\t},\\n\\t);\\n\\n\\tconst cancelAction = useCallback(() => {\\n\\t\\tsetInstalling(false);\\n\\t\\tsetModal(null);\\n\\t}, [setInstalling, setModal]);\\n\\n\\tconst isAppInstalled = async (appId: string) => {\\n\\t\\ttry {\\n\\t\\t\\tconst app = await AppClientOrchestratorInstance.getApp(appId);\\n\\t\\t\\treturn !!app || false;\\n\\t\\t} catch (e) {\\n\\t\\t\\treturn false;\\n\\t\\t}\\n\\t};\\n\\n\\tconst handleAppPermissionsReview = async (permissions: AppPermission[], appFile: File, appId?: string) => {\\n\\t\\tsetModal(\\n\\t\\t\\t<AppPermissionsReviewModal\\n\\t\\t\\t\\tappPermissions={permissions}\\n\\t\\t\\t\\tonCancel={cancelAction}\\n\\t\\t\\t\\tonConfirm={(permissionsGranted) => sendFile({ permissionsGranted, appFile, appId })}\\n\\t\\t\\t/>,\\n\\t\\t);\\n\\t};\\n\\n\\tconst uploadFile = async (appFile: File, { id, permissions }: { id: string; permissions: AppPermission[] }) => {\\n\\t\\tconst isInstalled = await isAppInstalled(id);\\n\\n\\t\\tif (isInstalled) {\\n\\t\\t\\treturn setModal(<AppUpdateModal cancel={cancelAction} confirm={() => handleAppPermissionsReview(permissions, appFile, id)} />);\\n\\t\\t}\\n\\n\\t\\tawait handleAppPermissionsReview(permissions, appFile);\\n\\t};\\n\\n\\tconst extractManifestFromAppFile = async (appFile: File) => {\\n\\t\\ttry {\\n\\t\\t\\treturn getManifestFromZippedApp(appFile);\\n\\t\\t} catch (error) {\\n\\t\\t\\thandleInstallError(error as Error);\\n\\t\\t}\\n\\t};\\n\\n\\tconst install = async () => {\\n\\t\\tsetInstalling(true);\\n\\n\\t\\tif (!appCountQuery.data) {\\n\\t\\t\\treturn cancelAction();\\n\\t\\t}\\n\\n\\t\\tconst appFile = file;\\n\\n\\t\\tif (!appFile) {\\n\\t\\t\\treturn cancelAction();\\n\\t\\t}\\n\\n\\t\\tconst manifest = await extractManifestFromAppFile(appFile);\\n\\n\\t\\tif (!manifest) {\\n\\t\\t\\treturn cancelAction();\\n\\t\\t}\\n\\n\\t\\treturn uploadFile(appFile, manifest);\\n\\t};\\n\\n\\treturn { install, isInstalling };\\n};\\n\",null],\"names\":[\"useRouter\",\"useSetModal\",\"useUpload\",\"useMutation\",\"React\",\"useCallback\",\"useState\",\"AppClientOrchestratorInstance\",\"useAppsReload\",\"AppPermissionsReviewModal\",\"AppUpdateModal\",\"handleAPIError\",\"handleInstallError\",\"getManifestFromZippedApp\",\"useAppsCountQuery\",\"module\",\"export\",\"useInstallApp\",\"link\",\"v\",\"default\",\"file\",\"reloadAppsList\",\"setModal\",\"router\",\"appCountQuery\",\"uploadAppEndpoint\",\"uploadUpdateEndpoint\",\"isInstalling\",\"setInstalling\",\"mutate\",\"sendFile\",\"_ref\",\"permissionsGranted\",\"appFile\",\"appId\",\"fileData\",\"FormData\",\"append\",\"name\",\"JSON\",\"stringify\",\"onSuccess\",\"data\",\"navigate\",\"params\",\"context\",\"page\",\"id\",\"app\",\"onError\",\"e\",\"onSettled\",\"cancelAction\",\"isAppInstalled\",\"getApp\",\"handleAppPermissionsReview\",\"permissions\",\"createElement\",\"appPermissions\",\"onCancel\",\"onConfirm\",\"uploadFile\",\"_ref2\",\"isInstalled\",\"cancel\",\"confirm\",\"extractManifestFromAppFile\",\"error\",\"install\",\"manifest\"],\"mappings\":\"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\"}"}