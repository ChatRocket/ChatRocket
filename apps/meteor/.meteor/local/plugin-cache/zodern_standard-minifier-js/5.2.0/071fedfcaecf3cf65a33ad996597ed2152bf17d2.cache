{"code":"function module(e,t,o){let n,i,a,s,r,l,u,c,d,p,m,k,f;o.link(\"meteor/meteor\",{Meteor(e){n=e}},0),o.link(\"meteor/tracker\",{Tracker(e){i=e}},1),o.link(\"react\",{lazy(e){a=e}},2),o.link(\"../../../app/models/client\",{CachedChatSubscription(e){s=e}},3),o.link(\"../../../app/settings/client\",{settings(e){r=e}},4),o.link(\"../../../app/ui/client/lib/KonchatNotification\",{KonchatNotification(e){l=e}},5),o.link(\"../../../app/utils/client\",{getUserPreference(e){u=e}},6),o.link(\"../../../app/utils/client/lib/SDKClient\",{sdk(e){c=e}},7),o.link(\"../../lib/RoomManager\",{RoomManager(e){d=e}},8),o.link(\"../../lib/imperativeModal\",{imperativeModal(e){p=e}},9),o.link(\"../../lib/utils/fireGlobalEvent\",{fireGlobalEvent(e){m=e}},10),o.link(\"../../lib/utils/isLayoutEmbedded\",{isLayoutEmbedded(e){k=e}},11),o.link(\"../../providers/RouterProvider\",{router(e){f=e}},12);let y=a(()=>o.dynamicImport(\"../../views/outlookCalendar/OutlookCalendarEventModal\")),b=async e=>{let t=n.user();t&&\"busy\"!==t.status&&(f.getRouteParameters().name&&f.getRouteParameters().name===e.name||e.ls||!0!==e.alert||l.newRoom(e.rid))};n.startup(()=>{let e=async function(e){let t=n.user();if(!t||\"busy\"===t.status)return;let o=u(n.userId(),\"desktopNotificationRequireInteraction\"),i=new Notification(e.title,{body:e.text,tag:e.payload._id,silent:!0,requireInteraction:o});i.onclick=function(){this.close(),window.focus(),p.open({component:y,props:{id:e.payload._id,onClose:p.close,onCancel:p.close}})}};i.autorun(()=>{if(!n.userId()||!r.get(\"Outlook_Calendar_Enabled\")){c.stop(\"notify-user\",\"\".concat(n.userId(),\"/calendar\"));return}c.stream(\"notify-user\",[\"\".concat(n.userId(),\"/calendar\")],e)}),i.autorun(()=>{n.userId()&&(c.stream(\"notify-user\",[\"\".concat(n.userId(),\"/notification\")],e=>{let t=[\"channel\",\"group\",\"direct\"].includes(f.getRouteName())?d.opened:void 0,o=document.hasFocus(),i=t===e.payload.rid;m(\"notification\",{notification:e,fromOpenedRoom:i,hasFocus:o}),k()?!o&&i&&l.showDesktop(e):o&&i||l.showDesktop(e),function(e){let t=document.hasFocus(),o=d.opened===e,i=u(n.userId(),\"muteFocusedConversations\");k()?!t&&o&&l.newMessage(e):t&&o&&i||l.newMessage(e)}(e.payload.rid)}),s.on(\"changed\",e=>{b(e)}),c.stream(\"notify-user\",[\"\".concat(n.userId(),\"/subscriptions-changed\")],(e,t)=>{\"removed\"!==e&&b(t)}))})})}","map":"{\"version\":3,\"sources\":[\"client/startup/notifications/konchatNotifications.ts\",\"<anon>\"],\"sourcesContent\":[\"import type { AtLeast, ISubscription, IUser, ICalendarNotification } from '@rocket.chat/core-typings';\\nimport { Meteor } from 'meteor/meteor';\\nimport { Tracker } from 'meteor/tracker';\\nimport { lazy } from 'react';\\n\\nimport { CachedChatSubscription } from '../../../app/models/client';\\nimport { settings } from '../../../app/settings/client';\\nimport { KonchatNotification } from '../../../app/ui/client/lib/KonchatNotification';\\nimport { getUserPreference } from '../../../app/utils/client';\\nimport { sdk } from '../../../app/utils/client/lib/SDKClient';\\nimport { RoomManager } from '../../lib/RoomManager';\\nimport { imperativeModal } from '../../lib/imperativeModal';\\nimport { fireGlobalEvent } from '../../lib/utils/fireGlobalEvent';\\nimport { isLayoutEmbedded } from '../../lib/utils/isLayoutEmbedded';\\nimport { router } from '../../providers/RouterProvider';\\n\\nconst OutlookCalendarEventModal = lazy(() => import('../../views/outlookCalendar/OutlookCalendarEventModal'));\\n\\nconst notifyNewRoom = async (sub: AtLeast<ISubscription, 'rid'>): Promise<void> => {\\n\\tconst user = Meteor.user() as IUser | null;\\n\\tif (!user || user.status === 'busy') {\\n\\t\\treturn;\\n\\t}\\n\\n\\tif ((!router.getRouteParameters().name || router.getRouteParameters().name !== sub.name) && !sub.ls && sub.alert === true) {\\n\\t\\tKonchatNotification.newRoom(sub.rid);\\n\\t}\\n};\\n\\nfunction notifyNewMessageAudio(rid?: string): void {\\n\\t// This logic is duplicated in /client/startup/unread.coffee.\\n\\tconst hasFocus = document.hasFocus();\\n\\tconst messageIsInOpenedRoom = RoomManager.opened === rid;\\n\\tconst muteFocusedConversations = getUserPreference(Meteor.userId(), 'muteFocusedConversations');\\n\\n\\tif (isLayoutEmbedded()) {\\n\\t\\tif (!hasFocus && messageIsInOpenedRoom) {\\n\\t\\t\\t// Play a notification sound\\n\\t\\t\\tvoid KonchatNotification.newMessage(rid);\\n\\t\\t}\\n\\t} else if (!hasFocus || !messageIsInOpenedRoom || !muteFocusedConversations) {\\n\\t\\t// Play a notification sound\\n\\t\\tvoid KonchatNotification.newMessage(rid);\\n\\t}\\n}\\n\\nMeteor.startup(() => {\\n\\tconst notifyUserCalendar = async function (notification: ICalendarNotification): Promise<void> {\\n\\t\\tconst user = Meteor.user() as IUser | null;\\n\\t\\tif (!user || user.status === 'busy') {\\n\\t\\t\\treturn;\\n\\t\\t}\\n\\n\\t\\tconst requireInteraction = getUserPreference<boolean>(Meteor.userId(), 'desktopNotificationRequireInteraction');\\n\\n\\t\\tconst n = new Notification(notification.title, {\\n\\t\\t\\tbody: notification.text,\\n\\t\\t\\ttag: notification.payload._id,\\n\\t\\t\\tsilent: true,\\n\\t\\t\\trequireInteraction,\\n\\t\\t} as NotificationOptions);\\n\\n\\t\\tn.onclick = function () {\\n\\t\\t\\tthis.close();\\n\\t\\t\\twindow.focus();\\n\\t\\t\\timperativeModal.open({\\n\\t\\t\\t\\tcomponent: OutlookCalendarEventModal,\\n\\t\\t\\t\\tprops: { id: notification.payload._id, onClose: imperativeModal.close, onCancel: imperativeModal.close },\\n\\t\\t\\t});\\n\\t\\t};\\n\\t};\\n\\tTracker.autorun(() => {\\n\\t\\tif (!Meteor.userId() || !settings.get('Outlook_Calendar_Enabled')) {\\n\\t\\t\\tsdk.stop('notify-user', `${Meteor.userId()}/calendar`);\\n\\t\\t\\treturn;\\n\\t\\t}\\n\\n\\t\\tsdk.stream('notify-user', [`${Meteor.userId()}/calendar`], notifyUserCalendar);\\n\\t});\\n\\n\\tTracker.autorun(() => {\\n\\t\\tif (!Meteor.userId()) {\\n\\t\\t\\treturn;\\n\\t\\t}\\n\\n\\t\\tsdk.stream('notify-user', [`${Meteor.userId()}/notification`], (notification) => {\\n\\t\\t\\tconst openedRoomId = ['channel', 'group', 'direct'].includes(router.getRouteName()!) ? RoomManager.opened : undefined;\\n\\n\\t\\t\\t// This logic is duplicated in /client/startup/unread.coffee.\\n\\t\\t\\tconst hasFocus = document.hasFocus();\\n\\t\\t\\tconst messageIsInOpenedRoom = openedRoomId === notification.payload.rid;\\n\\n\\t\\t\\tfireGlobalEvent('notification', {\\n\\t\\t\\t\\tnotification,\\n\\t\\t\\t\\tfromOpenedRoom: messageIsInOpenedRoom,\\n\\t\\t\\t\\thasFocus,\\n\\t\\t\\t});\\n\\n\\t\\t\\tif (isLayoutEmbedded()) {\\n\\t\\t\\t\\tif (!hasFocus && messageIsInOpenedRoom) {\\n\\t\\t\\t\\t\\t// Show a notification.\\n\\t\\t\\t\\t\\tKonchatNotification.showDesktop(notification);\\n\\t\\t\\t\\t}\\n\\t\\t\\t} else if (!hasFocus || !messageIsInOpenedRoom) {\\n\\t\\t\\t\\t// Show a notification.\\n\\t\\t\\t\\tKonchatNotification.showDesktop(notification);\\n\\t\\t\\t}\\n\\n\\t\\t\\tnotifyNewMessageAudio(notification.payload.rid);\\n\\t\\t});\\n\\n\\t\\tCachedChatSubscription.on('changed', (sub): void => {\\n\\t\\t\\tvoid notifyNewRoom(sub);\\n\\t\\t});\\n\\n\\t\\tsdk.stream('notify-user', [`${Meteor.userId()}/subscriptions-changed`], (action, sub) => {\\n\\t\\t\\tif (action === 'removed') {\\n\\t\\t\\t\\treturn;\\n\\t\\t\\t}\\n\\t\\t\\tvoid notifyNewRoom(sub);\\n\\t\\t});\\n\\t});\\n});\\n\",null],\"names\":[\"Meteor\",\"Tracker\",\"lazy\",\"CachedChatSubscription\",\"settings\",\"KonchatNotification\",\"getUserPreference\",\"sdk\",\"RoomManager\",\"imperativeModal\",\"fireGlobalEvent\",\"isLayoutEmbedded\",\"router\",\"module\",\"link\",\"v\",\"OutlookCalendarEventModal\",\"dynamicImport\",\"notifyNewRoom\",\"sub\",\"user\",\"status\",\"getRouteParameters\",\"name\",\"ls\",\"alert\",\"newRoom\",\"rid\",\"startup\",\"notifyUserCalendar\",\"notification\",\"requireInteraction\",\"userId\",\"n\",\"Notification\",\"title\",\"body\",\"text\",\"tag\",\"payload\",\"_id\",\"silent\",\"onclick\",\"close\",\"window\",\"focus\",\"open\",\"component\",\"props\",\"id\",\"onClose\",\"onCancel\",\"autorun\",\"get\",\"stop\",\"concat\",\"stream\",\"openedRoomId\",\"includes\",\"getRouteName\",\"opened\",\"undefined\",\"hasFocus\",\"document\",\"messageIsInOpenedRoom\",\"fromOpenedRoom\",\"showDesktop\",\"notifyNewMessageAudio\",\"muteFocusedConversations\",\"newMessage\",\"on\",\"action\"],\"mappings\":\"2BACAA,EAAuCC,EAAAC,EAAAC,EAAAC,EAAAC,EAAAC,EAAAC,EAAAC,EAAAC,EAAAC,EAAAC,EAAAC,EAA9BC,EAAQC,IAAA,CAAM,gBAAgB,CAAAd,OAAAe,CAAA,EAAAf,EAAAe,CAAA,CAAA,EAAA,GAAAF,EAAAC,IAAA,CAAA,iBAAA,CAAAb,QAAAc,CAAA,EAAAd,EAAAc,CAAA,CAAA,EAAA,GAAAF,EAAAC,IAAA,CAAA,QAAA,CAAAZ,KAAAa,CAAA,EAAAb,EAAAa,CAAA,CAAA,EAAA,GAAAF,EAAAC,IAAA,CAAA,6BAAA,CAAAX,uBAAAY,CAAA,EAAAZ,EAAAY,CAAA,CAAA,EAAA,GAAAF,EAAAC,IAAA,CAAA,+BAAA,CAAAV,SAAAW,CAAA,EAAAX,EAAAW,CAAA,CAAA,EAAA,GAAAF,EAAAC,IAAA,CAAA,iDAAA,CAAAT,oBAAAU,CAAA,EAAAV,EAAAU,CAAA,CAAA,EAAA,GAAAF,EAAAC,IAAA,CAAA,4BAAA,CAAAR,kBAAAS,CAAA,EAAAT,EAAAS,CAAA,CAAA,EAAA,GAAAF,EAAAC,IAAA,CAAA,0CAAA,CAAAP,IAAAQ,CAAA,EAAAR,EAAAQ,CAAA,CAAA,EAAA,GAAAF,EAAAC,IAAA,CAAA,wBAAA,CAAAN,YAAAO,CAAA,EAAAP,EAAAO,CAAA,CAAA,EAAA,GAAAF,EAAAC,IAAA,CAAA,4BAAA,CAAAL,gBAAAM,CAAA,EAAAN,EAAAM,CAAA,CAAA,EAAA,GAAAF,EAAAC,IAAA,CAAA,kCAAA,CAAAJ,gBAAAK,CAAA,EAAAL,EAAAK,CAAA,CAAA,EAAA,IAAAF,EAAAC,IAAA,CAAA,mCAAA,CAAAH,iBAAAI,CAAA,EAAAJ,EAAAI,CAAA,CAAA,EAAA,IAAAF,EAAAC,IAAA,CAAA,iCAAA,CAAAF,OAAAG,CAAA,EAAAH,EAAAG,CAAA,CAAA,EAAA,IAevC,IAAMC,EAA4Bd,EAAK,IAAMW,EAAAI,aAAA,CAAO,0DAE9CC,EAAgB,MAAOC,IAC5B,IAAMC,EAAOpB,EAAOoB,IAAI,GACnBA,GAAQA,AAAgB,SAAhBA,EAAKC,MAAM,GAIlBT,EAAOU,kBAAkB,GAAGC,IAAI,EAAIX,EAAOU,kBAAkB,GAAGC,IAAI,GAAKJ,EAAII,IAAI,EAAMJ,EAAIK,EAAE,EAAIL,AAAc,CAAA,IAAdA,EAAIM,KAAK,EAC/GpB,EAAoBqB,OAAO,CAACP,EAAIQ,GAAG,EAErC,EAmBA3B,EAAO4B,OAAO,CAAC,KACd,IAAMC,EAAqB,eAAgBC,CAAmC,EAC7E,IAAMV,EAAOpB,EAAOoB,IAAI,GACxB,GAAI,CAACA,GAAQA,AAAgB,SAAhBA,EAAKC,MAAM,CACvB,OAGD,IAAMU,EAAqBzB,EAA2BN,EAAOgC,MAAM,GAAI,yCAEjEC,EAAI,IAAIC,aAAaJ,EAAaK,KAAK,CAAE,CAC9CC,KAAMN,EAAaO,IAAI,CACvBC,IAAKR,EAAaS,OAAO,CAACC,GAAG,CAC7BC,OAAQ,CAAA,EACRV,mBAAAA,GAGDE,CAAAA,EAAES,OAAO,CAAG,WACX,IAAI,CAACC,KAAK,GACVC,OAAOC,KAAK,GACZpC,EAAgBqC,IAAI,CAAC,CACpBC,UAAW/B,EACXgC,MAAO,CAAEC,GAAInB,EAAaS,OAAO,CAACC,GAAG,CAAEU,QAASzC,EAAgBkC,KAAK,CAAEQ,SAAU1C,EAAgBkC,KAAAA,AAAK,GAExG,CACD,EACA1C,EAAQmD,OAAO,CAAC,KACf,GAAI,CAACpD,EAAOgC,MAAM,IAAM,CAAC5B,EAASiD,GAAG,CAAC,4BAA6B,CAClE9C,EAAI+C,IAAI,CAAC,cAAa,GAAAC,MAAA,CAAKvD,EAAOgC,MAAM,GAAE,cAC1C,MACD,CAEAzB,EAAIiD,MAAM,CAAC,cAAe,CAAA,GAAAD,MAAA,CAAIvD,EAAOgC,MAAM,GAAE,aAAY,CAAEH,EAC5D,GAEA5B,EAAQmD,OAAO,CAAC,KACVpD,EAAOgC,MAAM,KAIlBzB,EAAIiD,MAAM,CAAC,cAAe,CAAA,GAAAD,MAAA,CAAIvD,EAAOgC,MAAM,GAAE,iBAAgB,CAAGF,IAC/D,IAAM2B,EAAe,CAAC,UAAW,QAAS,SAAS,CAACC,QAAQ,CAAC9C,EAAO+C,YAAY,IAAOnD,EAAYoD,MAAM,CAAGC,KAAAA,EAGtGC,EAAWC,SAASD,QAAQ,GAC5BE,EAAwBP,IAAiB3B,EAAaS,OAAO,CAACZ,GAAG,CAEvEjB,EAAgB,eAAgB,CAC/BoB,aAAAA,EACAmC,eAAgBD,EAChBF,SAAAA,IAGGnD,IACC,CAACmD,GAAYE,GAEhB3D,EAAoB6D,WAAW,CAACpC,GAEtBgC,GAAaE,GAExB3D,EAAoB6D,WAAW,CAACpC,GAGjCqC,AA/EH,SAA+BxC,CAAY,EAE1C,IAAMmC,EAAWC,SAASD,QAAQ,GAC5BE,EAAwBxD,EAAYoD,MAAM,GAAKjC,EAC/CyC,EAA2B9D,EAAkBN,EAAOgC,MAAM,GAAI,4BAEhErB,IACC,CAACmD,GAAYE,GAEX3D,EAAoBgE,UAAU,CAAC1C,GAE1BmC,GAAaE,GAA0BI,GAE7C/D,EAAoBgE,UAAU,CAAC1C,EAEtC,EAgEyBG,EAAaS,OAAO,CAACZ,GAAG,CAC/C,GAEAxB,EAAuBmE,EAAE,CAAC,UAAYnD,IAChCD,EAAcC,EACpB,GAEAZ,EAAIiD,MAAM,CAAC,cAAe,CAAA,GAAAD,MAAA,CAAIvD,EAAOgC,MAAM,GAAE,0BAAyB,CAAE,CAACuC,EAAQpD,KACjE,YAAXoD,GAGCrD,EAAcC,EACpB,GACD,EACD\"}"}