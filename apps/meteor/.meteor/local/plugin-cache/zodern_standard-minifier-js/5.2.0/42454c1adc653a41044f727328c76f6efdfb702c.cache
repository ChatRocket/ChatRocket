{"code":"function module(e,t,i){let o,n,l,r,a,s,c;i.link(\"meteor/meteor\",{Meteor(e){o=e}},0),i.link(\"meteor/tracker\",{Tracker(e){n=e}},1),i.link(\"../../app/models/client\",{ChatMessage(e){l=e},ChatSubscription(e){r=e}},2),i.link(\"../../app/ui-utils/client\",{LegacyRoomManager(e){a=e},upsertMessage(e){s=e}},3),i.link(\"../lib/utils/callWithErrorHandling\",{callWithErrorHandling(e){c=e}},4);let d=async function(e){let t=l.findOne({rid:e,_hidden:{$ne:!0},temp:{$exists:!1}},{sort:{ts:-1},limit:1});if(t)try{let i=await c(\"loadMissedMessages\",e,t.ts);if(i){let t=r.findOne({rid:e});await Promise.all(Array.from(i).map(e=>s({msg:e,subscription:t})))}}catch(e){console.error(e)}};o.startup(()=>{let e=!0;n.autorun(()=>{let{connected:t}=o.connection.status();!0===t&&!1===e&&a.openedRooms&&Object.keys(a.openedRooms).forEach(e=>{let t=a.openedRooms[e];t.rid&&d(t.rid)}),e=t})})}","map":"{\"version\":3,\"sources\":[\"client/startup/loadMissedMessages.ts\",\"<anon>\"],\"sourcesContent\":[\"import type { IRoom } from '@rocket.chat/core-typings';\\nimport { Meteor } from 'meteor/meteor';\\nimport { Tracker } from 'meteor/tracker';\\n\\nimport { ChatMessage, ChatSubscription } from '../../app/models/client';\\nimport { LegacyRoomManager, upsertMessage } from '../../app/ui-utils/client';\\nimport { callWithErrorHandling } from '../lib/utils/callWithErrorHandling';\\n\\nconst loadMissedMessages = async function (rid: IRoom['_id']): Promise<void> {\\n\\tconst lastMessage = ChatMessage.findOne({ rid, _hidden: { $ne: true }, temp: { $exists: false } }, { sort: { ts: -1 }, limit: 1 });\\n\\n\\tif (!lastMessage) {\\n\\t\\treturn;\\n\\t}\\n\\n\\ttry {\\n\\t\\tconst result = await callWithErrorHandling('loadMissedMessages', rid, lastMessage.ts);\\n\\t\\tif (result) {\\n\\t\\t\\tconst subscription = ChatSubscription.findOne({ rid });\\n\\t\\t\\tawait Promise.all(Array.from(result).map((msg) => upsertMessage({ msg, subscription })));\\n\\t\\t}\\n\\t} catch (error) {\\n\\t\\tconsole.error(error);\\n\\t}\\n};\\n\\nMeteor.startup(() => {\\n\\tlet connectionWasOnline = true;\\n\\tTracker.autorun(() => {\\n\\t\\tconst { connected } = Meteor.connection.status();\\n\\n\\t\\tif (connected === true && connectionWasOnline === false && LegacyRoomManager.openedRooms) {\\n\\t\\t\\tObject.keys(LegacyRoomManager.openedRooms).forEach((key) => {\\n\\t\\t\\t\\tconst value = LegacyRoomManager.openedRooms[key];\\n\\t\\t\\t\\tif (value.rid) {\\n\\t\\t\\t\\t\\tloadMissedMessages(value.rid);\\n\\t\\t\\t\\t}\\n\\t\\t\\t});\\n\\t\\t}\\n\\t\\tconnectionWasOnline = connected;\\n\\t});\\n});\\n\",null],\"names\":[\"Meteor\",\"Tracker\",\"ChatMessage\",\"ChatSubscription\",\"LegacyRoomManager\",\"upsertMessage\",\"callWithErrorHandling\",\"module\",\"link\",\"v\",\"loadMissedMessages\",\"rid\",\"lastMessage\",\"findOne\",\"_hidden\",\"$ne\",\"temp\",\"$exists\",\"sort\",\"ts\",\"limit\",\"result\",\"subscription\",\"Promise\",\"all\",\"Array\",\"from\",\"map\",\"msg\",\"error\",\"console\",\"startup\",\"connectionWasOnline\",\"autorun\",\"connected\",\"connection\",\"status\",\"openedRooms\",\"Object\",\"keys\",\"forEach\",\"key\",\"value\"],\"mappings\":\"2BACAA,EAAuCC,EAAAC,EAAAC,EAAAC,EAAAC,EAAAC,EAA9BC,EAAQC,IAAA,CAAM,gBAAgB,CAAAR,OAAAS,CAAA,EAAAT,EAAAS,CAAA,CAAA,EAAA,GAAAF,EAAAC,IAAA,CAAA,iBAAA,CAAAP,QAAAQ,CAAA,EAAAR,EAAAQ,CAAA,CAAA,EAAA,GAAAF,EAAAC,IAAA,CAAA,0BAAA,CAAAN,YAAAO,CAAA,EAAAP,EAAAO,CAAA,EAAAN,iBAAAM,CAAA,EAAAN,EAAAM,CAAA,CAAA,EAAA,GAAAF,EAAAC,IAAA,CAAA,4BAAA,CAAAJ,kBAAAK,CAAA,EAAAL,EAAAK,CAAA,EAAAJ,cAAAI,CAAA,EAAAJ,EAAAI,CAAA,CAAA,EAAA,GAAAF,EAAAC,IAAA,CAAA,qCAAA,CAAAF,sBAAAG,CAAA,EAAAH,EAAAG,CAAA,CAAA,EAAA,GAOvC,IAAMC,EAAqB,eAAgBC,CAAiB,EAC3D,IAAMC,EAAcV,EAAYW,OAAO,CAAC,CAAEF,IAAAA,EAAKG,QAAS,CAAEC,IAAK,CAAA,CAAI,EAAIC,KAAM,CAAEC,QAAS,CAAA,CAAK,CAAE,EAAI,CAAEC,KAAM,CAAEC,GAAI,EAAE,EAAIC,MAAO,CAAC,GAE/H,GAAKR,EAIL,GAAI,CACH,IAAMS,EAAS,MAAMf,EAAsB,qBAAsBK,EAAKC,EAAYO,EAAE,EACpF,GAAIE,EAAQ,CACX,IAAMC,EAAenB,EAAiBU,OAAO,CAAC,CAAEF,IAAAA,CAAG,EACnD,OAAMY,QAAQC,GAAG,CAACC,MAAMC,IAAI,CAACL,GAAQM,GAAG,CAAEC,GAAQvB,EAAc,CAAEuB,IAAAA,EAAKN,aAAAA,CAAY,IACpF,CACD,CAAE,MAAOO,EAAO,CACfC,QAAQD,KAAK,CAACA,EACf,CACD,EAEA7B,EAAO+B,OAAO,CAAC,KACd,IAAIC,EAAsB,CAAA,EAC1B/B,EAAQgC,OAAO,CAAC,KACf,GAAM,CAAEC,UAAAA,CAAAA,CAAW,CAAGlC,EAAOmC,UAAU,CAACC,MAAM,EAE5B,EAAA,IAAdF,GAAsBF,AAAwB,CAAA,IAAxBA,GAAiC5B,EAAkBiC,WAAW,EACvFC,OAAOC,IAAI,CAACnC,EAAkBiC,WAAW,EAAEG,OAAO,CAAEC,IACnD,IAAMC,EAAQtC,EAAkBiC,WAAW,CAACI,EAAI,AAC5CC,CAAAA,EAAM/B,GAAG,EACZD,EAAmBgC,EAAM/B,GAAG,CAE9B,GAEDqB,EAAsBE,CACvB,EACD\"}"}