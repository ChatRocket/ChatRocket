{"code":"function module(t,e,a){let n,i,s,m,o,l,r;a.export({processSlashCommand:()=>u}),a.link(\"@rocket.chat/random\",{Random(t){n=t}},0),a.link(\"@rocket.chat/string-helpers\",{escapeHTML(t){i=t}},1),a.link(\"../../../../app/authorization/client\",{hasAtLeastOnePermission(t){s=t}},2),a.link(\"../../../../app/settings/client\",{settings(t){m=t}},3),a.link(\"../../../../app/utils/client\",{slashCommands(t){o=t}},4),a.link(\"../../../../app/utils/client/lib/SDKClient\",{sdk(t){l=t}},5),a.link(\"../../../../app/utils/lib/i18n\",{t(t){r=t}},6);let c=t=>{let e=t.match(/^\\/([^\\s]+)(.*)/);if(!e)return;let[,a,n]=e,i=o.commands[a];return i?{command:i,params:n}:{command:a,params:n}},d=async(t,e)=>{console.error(e),await t.data.pushEphemeralMessage({_id:n.id(),ts:new Date,msg:e,u:{_id:\"rocket.cat\",username:\"rocket.cat\",name:\"Rocket.Cat\"},private:!0,_updatedAt:new Date})},u=async(t,e)=>{let a=c(e.msg);if(!a)return!1;let{command:n,params:o}=a;if(\"string\"==typeof n)return!m.get(\"Message_AllowUnrecognizedSlashCommand\")&&(await d(t,r(\"No_such_command\",{command:i(n)})),!0);let{permission:u,clientOnly:p,callback:g,result:h,appId:_,command:k}=n;if(u&&!s(u,e.rid))return await d(t,r(\"You_do_not_have_permission_to_execute_this_command\",{command:i(k)})),!0;if(p&&t.uid)return null==g||g({command:k,message:e,params:o,userId:t.uid}),!0;await l.rest.post(\"/v1/statistics.telemetry\",{params:[{eventName:\"slashCommandsStats\",timestamp:Date.now(),command:k}]});let w=t.ActionManager.generateTriggerId(_),f={cmd:k,params:o,msg:e,userId:t.uid};try{_&&t.ActionManager.notifyBusy();let a=await l.call(\"slashCommand\",{cmd:k,params:o,msg:e,triggerId:w});null==h||h(void 0,a,f)}catch(e){await d(t,r(\"Something_went_wrong_while_executing_command\",{command:k})),null==h||h(e,void 0,f)}return _&&t.ActionManager.notifyIdle(),!0}}","map":"{\"version\":3,\"sources\":[\"client/lib/chats/flows/processSlashCommand.ts\",\"<anon>\"],\"sourcesContent\":[\"import type { IMessage, SlashCommand } from '@rocket.chat/core-typings';\\nimport { Random } from '@rocket.chat/random';\\nimport { escapeHTML } from '@rocket.chat/string-helpers';\\n\\nimport { hasAtLeastOnePermission } from '../../../../app/authorization/client';\\nimport { settings } from '../../../../app/settings/client';\\nimport { slashCommands } from '../../../../app/utils/client';\\nimport { sdk } from '../../../../app/utils/client/lib/SDKClient';\\nimport { t } from '../../../../app/utils/lib/i18n';\\nimport type { ChatAPI } from '../ChatAPI';\\n\\nconst parse = (msg: string): { command: string; params: string } | { command: SlashCommand; params: string } | undefined => {\\n\\tconst match = msg.match(/^\\\\/([^\\\\s]+)(.*)/);\\n\\n\\tif (!match) {\\n\\t\\treturn undefined;\\n\\t}\\n\\n\\tconst [, cmd, params] = match;\\n\\tconst command = slashCommands.commands[cmd];\\n\\n\\tif (!command) {\\n\\t\\treturn { command: cmd, params };\\n\\t}\\n\\n\\treturn { command, params };\\n};\\n\\nconst warnUnrecognizedSlashCommand = async (chat: ChatAPI, message: string): Promise<void> => {\\n\\tconsole.error(message);\\n\\n\\tawait chat.data.pushEphemeralMessage({\\n\\t\\t_id: Random.id(),\\n\\t\\tts: new Date(),\\n\\t\\tmsg: message,\\n\\t\\tu: {\\n\\t\\t\\t_id: 'rocket.cat',\\n\\t\\t\\tusername: 'rocket.cat',\\n\\t\\t\\tname: 'Rocket.Cat',\\n\\t\\t},\\n\\t\\tprivate: true,\\n\\t\\t_updatedAt: new Date(),\\n\\t});\\n};\\n\\nexport const processSlashCommand = async (chat: ChatAPI, message: IMessage): Promise<boolean> => {\\n\\tconst match = parse(message.msg);\\n\\n\\tif (!match) {\\n\\t\\treturn false;\\n\\t}\\n\\n\\tconst { command, params } = match;\\n\\n\\tif (typeof command === 'string') {\\n\\t\\tif (!settings.get('Message_AllowUnrecognizedSlashCommand')) {\\n\\t\\t\\tawait warnUnrecognizedSlashCommand(chat, t('No_such_command', { command: escapeHTML(command) }));\\n\\t\\t\\treturn true;\\n\\t\\t}\\n\\n\\t\\treturn false;\\n\\t}\\n\\n\\tconst { permission, clientOnly, callback: handleOnClient, result: handleResult, appId, command: commandName } = command;\\n\\n\\tif (permission && !hasAtLeastOnePermission(permission, message.rid)) {\\n\\t\\tawait warnUnrecognizedSlashCommand(chat, t('You_do_not_have_permission_to_execute_this_command', { command: escapeHTML(commandName) }));\\n\\t\\treturn true;\\n\\t}\\n\\n\\tif (clientOnly && chat.uid) {\\n\\t\\thandleOnClient?.({ command: commandName, message, params, userId: chat.uid });\\n\\t\\treturn true;\\n\\t}\\n\\n\\tawait sdk.rest.post('/v1/statistics.telemetry', {\\n\\t\\tparams: [{ eventName: 'slashCommandsStats', timestamp: Date.now(), command: commandName }],\\n\\t});\\n\\n\\tconst triggerId = chat.ActionManager.generateTriggerId(appId);\\n\\n\\tconst data = {\\n\\t\\tcmd: commandName,\\n\\t\\tparams,\\n\\t\\tmsg: message,\\n\\t\\tuserId: chat.uid,\\n\\t} as const;\\n\\n\\ttry {\\n\\t\\tif (appId) {\\n\\t\\t\\tchat.ActionManager.notifyBusy();\\n\\t\\t}\\n\\n\\t\\tconst result = await sdk.call('slashCommand', { cmd: commandName, params, msg: message, triggerId });\\n\\n\\t\\thandleResult?.(undefined, result, data);\\n\\t} catch (error: unknown) {\\n\\t\\tawait warnUnrecognizedSlashCommand(chat, t('Something_went_wrong_while_executing_command', { command: commandName }));\\n\\t\\thandleResult?.(error, undefined, data);\\n\\t}\\n\\n\\tif (appId) {\\n\\t\\tchat.ActionManager.notifyIdle();\\n\\t}\\n\\n\\treturn true;\\n};\\n\",null],\"names\":[\"Random\",\"escapeHTML\",\"hasAtLeastOnePermission\",\"settings\",\"slashCommands\",\"sdk\",\"t\",\"module\",\"export\",\"processSlashCommand\",\"link\",\"v\",\"parse\",\"msg\",\"match\",\"cmd\",\"params\",\"command\",\"commands\",\"warnUnrecognizedSlashCommand\",\"chat\",\"message\",\"console\",\"error\",\"data\",\"pushEphemeralMessage\",\"_id\",\"id\",\"ts\",\"Date\",\"u\",\"username\",\"name\",\"private\",\"_updatedAt\",\"get\",\"permission\",\"clientOnly\",\"callback\",\"handleOnClient\",\"result\",\"handleResult\",\"appId\",\"commandName\",\"rid\",\"uid\",\"userId\",\"rest\",\"post\",\"eventName\",\"timestamp\",\"now\",\"triggerId\",\"ActionManager\",\"generateTriggerId\",\"notifyBusy\",\"call\",\"undefined\",\"notifyIdle\"],\"mappings\":\"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\"}"}