{"code":"function module(e,t,i){let n,s,d,l,a,r,o,m,u;i.link(\"meteor/meteor\",{Meteor(e){n=e}},0),i.link(\"meteor/tracker\",{Tracker(e){s=e}},1),i.link(\"moment\",{default(e){d=e}},2),i.link(\"../../app/authorization/client\",{hasAtLeastOnePermission(e){l=e},hasPermission(e){a=e}},3),i.link(\"../../app/models/client\",{ChatMessage(e){r=e}},4),i.link(\"../../app/settings/client\",{settings(e){o=e}},5),i.link(\"../../app/utils/lib/i18n\",{t(e){m=e}},6),i.link(\"../lib/toast\",{dispatchToastMessage(e){u=e}},7),n.methods({updateMessage(e){var t,i,g,c;let p=n.userId();if(!p)return;let f=r.findOne(e._id);if(!f)return;let k=l(\"edit-message\",e.rid),v=o.get(\"Message_AllowEditing\"),h=!1,_=null!==(t=null==f?void 0:null===(i=f.attachments)||void 0===i?void 0:null===(g=i[0])||void 0===g?void 0:g.description)&&void 0!==t?t:f.msg;if(_===e.msg)return;null!=f&&null!==(c=f.u)&&void 0!==c&&c._id&&(h=f.u._id===p);let M=n.users.findOne(p);if(!M)return;if(!(k||v&&h)){u({type:\"error\",message:m(\"error-action-not-allowed\",{action:m(\"Message_editing\")})});return}let y=Number(o.get(\"Message_AllowEditing_BlockEditInMinutes\")),A=a(\"bypass-time-limit-edit-and-delete\",e.rid);if(!A&&0!==y&&f.ts){let e=d(f.ts);if(e){let t=d().diff(e,\"minutes\");if(t>y){u({type:\"error\",message:m(\"error-message-editing-blocked\")});return}}}s.nonreactive(async()=>{var t;e.editedAt=new Date(Date.now()),e.editedBy={_id:p,username:M.username};let i={editedAt:e.editedAt,editedBy:e.editedBy,msg:e.msg};null!==(t=f.attachments)&&void 0!==t&&t.length&&void 0!==f.attachments[0].description&&(delete i.msg,f.attachments[0].description=e.msg),r.update({_id:e._id,\"u._id\":p},{$set:i})})}})}","map":"{\"version\":3,\"sources\":[\"client/methods/updateMessage.ts\",\"<anon>\"],\"sourcesContent\":[\"import type { IEditedMessage } from '@rocket.chat/core-typings';\\nimport type { ServerMethods } from '@rocket.chat/ddp-client';\\nimport { Meteor } from 'meteor/meteor';\\nimport { Tracker } from 'meteor/tracker';\\nimport moment from 'moment';\\n\\nimport { hasAtLeastOnePermission, hasPermission } from '../../app/authorization/client';\\nimport { ChatMessage } from '../../app/models/client';\\nimport { settings } from '../../app/settings/client';\\nimport { t } from '../../app/utils/lib/i18n';\\nimport { dispatchToastMessage } from '../lib/toast';\\n\\nMeteor.methods<ServerMethods>({\\n\\tupdateMessage(message) {\\n\\t\\tconst uid = Meteor.userId();\\n\\t\\tif (!uid) {\\n\\t\\t\\treturn;\\n\\t\\t}\\n\\n\\t\\tconst originalMessage = ChatMessage.findOne(message._id);\\n\\n\\t\\tif (!originalMessage) {\\n\\t\\t\\treturn;\\n\\t\\t}\\n\\t\\tconst canEditMessage = hasAtLeastOnePermission('edit-message', message.rid);\\n\\t\\tconst editAllowed = settings.get('Message_AllowEditing');\\n\\t\\tlet editOwn = false;\\n\\n\\t\\tconst msgText = originalMessage?.attachments?.[0]?.description ?? originalMessage.msg;\\n\\n\\t\\tif (msgText === message.msg) {\\n\\t\\t\\treturn;\\n\\t\\t}\\n\\t\\tif (originalMessage?.u?._id) {\\n\\t\\t\\teditOwn = originalMessage.u._id === uid;\\n\\t\\t}\\n\\n\\t\\tconst me = Meteor.users.findOne(uid);\\n\\n\\t\\tif (!me) {\\n\\t\\t\\treturn;\\n\\t\\t}\\n\\n\\t\\tif (!(canEditMessage || (editAllowed && editOwn))) {\\n\\t\\t\\tdispatchToastMessage({\\n\\t\\t\\t\\ttype: 'error',\\n\\t\\t\\t\\tmessage: t('error-action-not-allowed', { action: t('Message_editing') }),\\n\\t\\t\\t});\\n\\t\\t\\treturn;\\n\\t\\t}\\n\\n\\t\\tconst blockEditInMinutes = Number(settings.get('Message_AllowEditing_BlockEditInMinutes') as number | undefined);\\n\\t\\tconst bypassBlockTimeLimit = hasPermission('bypass-time-limit-edit-and-delete', message.rid);\\n\\n\\t\\tif (!bypassBlockTimeLimit && blockEditInMinutes !== 0) {\\n\\t\\t\\tif (originalMessage.ts) {\\n\\t\\t\\t\\tconst msgTs = moment(originalMessage.ts);\\n\\t\\t\\t\\tif (msgTs) {\\n\\t\\t\\t\\t\\tconst currentTsDiff = moment().diff(msgTs, 'minutes');\\n\\t\\t\\t\\t\\tif (currentTsDiff > blockEditInMinutes) {\\n\\t\\t\\t\\t\\t\\tdispatchToastMessage({ type: 'error', message: t('error-message-editing-blocked') });\\n\\t\\t\\t\\t\\t\\treturn;\\n\\t\\t\\t\\t\\t}\\n\\t\\t\\t\\t}\\n\\t\\t\\t}\\n\\t\\t}\\n\\n\\t\\tTracker.nonreactive(async () => {\\n\\t\\t\\tmessage.editedAt = new Date(Date.now());\\n\\n\\t\\t\\tmessage.editedBy = {\\n\\t\\t\\t\\t_id: uid,\\n\\t\\t\\t\\tusername: me.username,\\n\\t\\t\\t};\\n\\n\\t\\t\\tconst messageObject: Partial<IEditedMessage> = {\\n\\t\\t\\t\\teditedAt: message.editedAt,\\n\\t\\t\\t\\teditedBy: message.editedBy,\\n\\t\\t\\t\\tmsg: message.msg,\\n\\t\\t\\t};\\n\\n\\t\\t\\tif (originalMessage.attachments?.length) {\\n\\t\\t\\t\\tif (originalMessage.attachments[0].description !== undefined) {\\n\\t\\t\\t\\t\\tdelete messageObject.msg;\\n\\t\\t\\t\\t\\toriginalMessage.attachments[0].description = message.msg;\\n\\t\\t\\t\\t}\\n\\t\\t\\t}\\n\\t\\t\\tChatMessage.update(\\n\\t\\t\\t\\t{\\n\\t\\t\\t\\t\\t'_id': message._id,\\n\\t\\t\\t\\t\\t'u._id': uid,\\n\\t\\t\\t\\t},\\n\\t\\t\\t\\t{ $set: messageObject },\\n\\t\\t\\t);\\n\\t\\t});\\n\\t},\\n});\\n\",null],\"names\":[\"Meteor\",\"Tracker\",\"moment\",\"hasAtLeastOnePermission\",\"hasPermission\",\"ChatMessage\",\"settings\",\"t\",\"dispatchToastMessage\",\"module\",\"link\",\"v\",\"default\",\"methods\",\"updateMessage\",\"message\",\"_originalMessage$atta\",\"_originalMessage$atta2\",\"_originalMessage$atta3\",\"_originalMessage$u\",\"uid\",\"userId\",\"originalMessage\",\"findOne\",\"_id\",\"canEditMessage\",\"rid\",\"editAllowed\",\"get\",\"editOwn\",\"msgText\",\"attachments\",\"description\",\"msg\",\"u\",\"me\",\"users\",\"type\",\"action\",\"blockEditInMinutes\",\"Number\",\"bypassBlockTimeLimit\",\"ts\",\"msgTs\",\"currentTsDiff\",\"diff\",\"nonreactive\",\"_originalMessage$atta4\",\"editedAt\",\"Date\",\"now\",\"editedBy\",\"username\",\"messageObject\",\"length\",\"undefined\",\"update\",\"$set\"],\"mappings\":\"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\"}"}