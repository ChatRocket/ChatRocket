{"code":"function module(t,a,e){let n,s,i,r,l,o,u,d,g,c,h;e.export({AutoTranslate:()=>T,createAutoTranslateMessageStreamHandler:()=>f}),e.link(\"@rocket.chat/core-typings\",{isTranslatedMessageAttachment(t){n=t}},0),e.link(\"mem\",{default(t){s=t}},1),e.link(\"meteor/meteor\",{Meteor(t){i=t}},2),e.link(\"meteor/tracker\",{Tracker(t){r=t}},3),e.link(\"../../../../client/views/room/MessageList/lib/autoTranslate\",{hasTranslationLanguageInAttachments(t){l=t},hasTranslationLanguageInMessage(t){o=t}},4),e.link(\"../../../authorization/client\",{hasPermission(t){u=t}},5),e.link(\"../../../models/client\",{Subscriptions(t){d=t},Messages(t){g=t}},6),e.link(\"../../../settings/client\",{settings(t){c=t}},7),e.link(\"../../../utils/client/lib/SDKClient\",{sdk(t){h=t}},8);let m=\"en\",p=\"\";i.startup(()=>{r.autorun(()=>{let t=i.user();t&&(m=t.language||\"en\",p=t.username||\"\")})});let T={initialized:!1,providersMetadata:{},messageIdsToWait:{},supportedLanguages:[],findSubscriptionByRid:s(t=>d.findOne({rid:t})),getLanguage(t){var a,e,n;let s;t&&(s=this.findSubscriptionByRid(t));let i=(null===(a=s)||void 0===a?void 0:a.autoTranslateLanguage)||m||(null===(e=(n=window).defaultUserLanguage)||void 0===e?void 0:e.call(n));return -1===i.indexOf(\"-\")||(this.supportedLanguages||[]).some(t=>t.language===i)?i:i.slice(0,2)},translateAttachments(t,a,e){if(!n(t))return t;for(let n of t)n.author_name!==p&&(n.text&&n.translations&&n.translations[a]&&(n.translations.original=n.text,e?n.text=n.translations.original:n.text=n.translations[a]),n.description&&n.translations&&n.translations[a]&&(n.translations.original=n.description,e?n.description=n.translations.original:n.description=n.translations[a]),n.attachments&&n.attachments.length>0&&(n.attachments=this.translateAttachments(n.attachments,a)));return t},init(){this.initialized||(r.autorun(async t=>{let a=i.userId();if(c.get(\"AutoTranslate_Enabled\")&&a&&u(\"auto-translate\")){t.stop();try{[this.providersMetadata,this.supportedLanguages]=await Promise.all([h.call(\"autoTranslate.getProviderUiMetadata\"),h.call(\"autoTranslate.getSupportedLanguages\",\"en\")])}catch(t){console.error(t.message)}}}),d.find().observeChanges({changed:(t,a)=>{(a.hasOwnProperty(\"autoTranslate\")||a.hasOwnProperty(\"autoTranslateLanguage\"))&&s.clear(this.findSubscriptionByRid)}}),this.initialized=!0)}},f=()=>(T.init(),t=>{if(t.u&&t.u._id!==i.userId()){let a=T.findSubscriptionByRid(t.rid),e=T.getLanguage(t.rid);!a||!0!==a.autoTranslate||!t.msg||t.translations&&(o(t,e)||l(t.attachments,e))?void 0!==T.messageIdsToWait[t._id]&&a&&!0!==a.autoTranslate?(g.update({_id:t._id},{$set:{autoTranslateShowInverse:!0},$unset:{autoTranslateFetching:!0}}),delete T.messageIdsToWait[t._id]):!0===t.autoTranslateFetching&&g.update({_id:t._id},{$unset:{autoTranslateFetching:!0}}):g.update({_id:t._id},{$set:{autoTranslateFetching:!0}})}})}","map":"{\"version\":3,\"sources\":[\"app/autotranslate/client/lib/autotranslate.ts\",\"<anon>\"],\"sourcesContent\":[\"import type {\\n\\tIRoom,\\n\\tISubscription,\\n\\tISupportedLanguage,\\n\\tITranslatedMessage,\\n\\tIUser,\\n\\tMessageAttachmentDefault,\\n} from '@rocket.chat/core-typings';\\nimport { isTranslatedMessageAttachment } from '@rocket.chat/core-typings';\\nimport mem from 'mem';\\nimport { Meteor } from 'meteor/meteor';\\nimport { Tracker } from 'meteor/tracker';\\n\\nimport {\\n\\thasTranslationLanguageInAttachments,\\n\\thasTranslationLanguageInMessage,\\n} from '../../../../client/views/room/MessageList/lib/autoTranslate';\\nimport { hasPermission } from '../../../authorization/client';\\nimport { Subscriptions, Messages } from '../../../models/client';\\nimport { settings } from '../../../settings/client';\\nimport { sdk } from '../../../utils/client/lib/SDKClient';\\n\\nlet userLanguage = 'en';\\nlet username = '';\\n\\nMeteor.startup(() => {\\n\\tTracker.autorun(() => {\\n\\t\\tconst user: Pick<IUser, 'language' | 'username'> | null = Meteor.user();\\n\\t\\tif (!user) {\\n\\t\\t\\treturn;\\n\\t\\t}\\n\\t\\tuserLanguage = user.language || 'en';\\n\\t\\tusername = user.username || '';\\n\\t});\\n});\\n\\nexport const AutoTranslate = {\\n\\tinitialized: false,\\n\\tprovidersMetadata: {} as { [providerNamer: string]: { name: string; displayName: string } },\\n\\tmessageIdsToWait: {} as { [messageId: string]: string },\\n\\tsupportedLanguages: [] as ISupportedLanguage[] | undefined,\\n\\n\\tfindSubscriptionByRid: mem((rid) => Subscriptions.findOne({ rid })),\\n\\n\\tgetLanguage(rid: IRoom['_id']): string {\\n\\t\\tlet subscription: ISubscription | undefined;\\n\\t\\tif (rid) {\\n\\t\\t\\tsubscription = this.findSubscriptionByRid(rid);\\n\\t\\t}\\n\\t\\tconst language = (subscription?.autoTranslateLanguage || userLanguage || window.defaultUserLanguage?.()) as string;\\n\\t\\tif (language.indexOf('-') !== -1) {\\n\\t\\t\\tif (!(this.supportedLanguages || []).some((supportedLanguage) => supportedLanguage.language === language)) {\\n\\t\\t\\t\\treturn language.slice(0, 2);\\n\\t\\t\\t}\\n\\t\\t}\\n\\t\\treturn language;\\n\\t},\\n\\n\\ttranslateAttachments(\\n\\t\\tattachments: MessageAttachmentDefault[],\\n\\t\\tlanguage: string,\\n\\t\\tautoTranslateShowInverse: boolean,\\n\\t): MessageAttachmentDefault[] {\\n\\t\\tif (!isTranslatedMessageAttachment(attachments)) {\\n\\t\\t\\treturn attachments;\\n\\t\\t}\\n\\t\\tfor (const attachment of attachments) {\\n\\t\\t\\tif (attachment.author_name !== username) {\\n\\t\\t\\t\\tif (attachment.text && attachment.translations && attachment.translations[language]) {\\n\\t\\t\\t\\t\\tattachment.translations.original = attachment.text;\\n\\n\\t\\t\\t\\t\\tif (autoTranslateShowInverse) {\\n\\t\\t\\t\\t\\t\\tattachment.text = attachment.translations.original;\\n\\t\\t\\t\\t\\t} else {\\n\\t\\t\\t\\t\\t\\tattachment.text = attachment.translations[language];\\n\\t\\t\\t\\t\\t}\\n\\t\\t\\t\\t}\\n\\n\\t\\t\\t\\tif (attachment.description && attachment.translations && attachment.translations[language]) {\\n\\t\\t\\t\\t\\tattachment.translations.original = attachment.description;\\n\\n\\t\\t\\t\\t\\tif (autoTranslateShowInverse) {\\n\\t\\t\\t\\t\\t\\tattachment.description = attachment.translations.original;\\n\\t\\t\\t\\t\\t} else {\\n\\t\\t\\t\\t\\t\\tattachment.description = attachment.translations[language];\\n\\t\\t\\t\\t\\t}\\n\\t\\t\\t\\t}\\n\\n\\t\\t\\t\\t// @ts-expect-error - not sure what to do with this\\n\\t\\t\\t\\tif (attachment.attachments && attachment.attachments.length > 0) {\\n\\t\\t\\t\\t\\t// @ts-expect-error - not sure what to do with this\\n\\t\\t\\t\\t\\tattachment.attachments = this.translateAttachments(attachment.attachments, language);\\n\\t\\t\\t\\t}\\n\\t\\t\\t}\\n\\t\\t}\\n\\t\\treturn attachments;\\n\\t},\\n\\n\\tinit(): void {\\n\\t\\tif (this.initialized) {\\n\\t\\t\\treturn;\\n\\t\\t}\\n\\n\\t\\tTracker.autorun(async (c) => {\\n\\t\\t\\tconst uid = Meteor.userId();\\n\\t\\t\\tif (!settings.get('AutoTranslate_Enabled') || !uid || !hasPermission('auto-translate')) {\\n\\t\\t\\t\\treturn;\\n\\t\\t\\t}\\n\\n\\t\\t\\tc.stop();\\n\\n\\t\\t\\ttry {\\n\\t\\t\\t\\t[this.providersMetadata, this.supportedLanguages] = await Promise.all([\\n\\t\\t\\t\\t\\tsdk.call('autoTranslate.getProviderUiMetadata'),\\n\\t\\t\\t\\t\\tsdk.call('autoTranslate.getSupportedLanguages', 'en'),\\n\\t\\t\\t\\t]);\\n\\t\\t\\t} catch (e: unknown) {\\n\\t\\t\\t\\t// Avoid unwanted error message on UI when autotranslate is disabled while fetching data\\n\\t\\t\\t\\tconsole.error((e as Error).message);\\n\\t\\t\\t}\\n\\t\\t});\\n\\n\\t\\tSubscriptions.find().observeChanges({\\n\\t\\t\\tchanged: (_id: string, fields: ISubscription) => {\\n\\t\\t\\t\\tif (fields.hasOwnProperty('autoTranslate') || fields.hasOwnProperty('autoTranslateLanguage')) {\\n\\t\\t\\t\\t\\tmem.clear(this.findSubscriptionByRid);\\n\\t\\t\\t\\t}\\n\\t\\t\\t},\\n\\t\\t});\\n\\n\\t\\tthis.initialized = true;\\n\\t},\\n};\\n\\nexport const createAutoTranslateMessageStreamHandler = (): ((message: ITranslatedMessage) => void) => {\\n\\tAutoTranslate.init();\\n\\n\\treturn (message: ITranslatedMessage): void => {\\n\\t\\tif (message.u && message.u._id !== Meteor.userId()) {\\n\\t\\t\\tconst subscription = AutoTranslate.findSubscriptionByRid(message.rid);\\n\\t\\t\\tconst language = AutoTranslate.getLanguage(message.rid);\\n\\t\\t\\tif (\\n\\t\\t\\t\\tsubscription &&\\n\\t\\t\\t\\tsubscription.autoTranslate === true &&\\n\\t\\t\\t\\tmessage.msg &&\\n\\t\\t\\t\\t(!message.translations ||\\n\\t\\t\\t\\t\\t(!hasTranslationLanguageInMessage(message, language) && !hasTranslationLanguageInAttachments(message.attachments, language)))\\n\\t\\t\\t) {\\n\\t\\t\\t\\t// || (message.attachments && !_.find(message.attachments, attachment => { return attachment.translations && attachment.translations[language]; }))\\n\\t\\t\\t\\tMessages.update({ _id: message._id }, { $set: { autoTranslateFetching: true } });\\n\\t\\t\\t} else if (AutoTranslate.messageIdsToWait[message._id] !== undefined && subscription && subscription.autoTranslate !== true) {\\n\\t\\t\\t\\tMessages.update({ _id: message._id }, { $set: { autoTranslateShowInverse: true }, $unset: { autoTranslateFetching: true } });\\n\\t\\t\\t\\tdelete AutoTranslate.messageIdsToWait[message._id];\\n\\t\\t\\t} else if (message.autoTranslateFetching === true) {\\n\\t\\t\\t\\tMessages.update({ _id: message._id }, { $unset: { autoTranslateFetching: true } });\\n\\t\\t\\t}\\n\\t\\t}\\n\\t};\\n};\\n\",null],\"names\":[\"isTranslatedMessageAttachment\",\"mem\",\"Meteor\",\"Tracker\",\"hasTranslationLanguageInAttachments\",\"hasTranslationLanguageInMessage\",\"hasPermission\",\"Subscriptions\",\"Messages\",\"settings\",\"sdk\",\"module\",\"export\",\"AutoTranslate\",\"createAutoTranslateMessageStreamHandler\",\"link\",\"v\",\"default\",\"userLanguage\",\"username\",\"startup\",\"autorun\",\"user\",\"language\",\"initialized\",\"providersMetadata\",\"messageIdsToWait\",\"supportedLanguages\",\"findSubscriptionByRid\",\"rid\",\"findOne\",\"getLanguage\",\"_subscription\",\"_window$defaultUserLa\",\"_window\",\"subscription\",\"autoTranslateLanguage\",\"window\",\"defaultUserLanguage\",\"call\",\"indexOf\",\"some\",\"supportedLanguage\",\"slice\",\"translateAttachments\",\"attachments\",\"autoTranslateShowInverse\",\"attachment\",\"author_name\",\"text\",\"translations\",\"original\",\"description\",\"length\",\"init\",\"c\",\"uid\",\"userId\",\"get\",\"stop\",\"Promise\",\"all\",\"e\",\"console\",\"error\",\"message\",\"find\",\"observeChanges\",\"changed\",\"_id\",\"fields\",\"hasOwnProperty\",\"clear\",\"u\",\"autoTranslate\",\"msg\",\"undefined\",\"update\",\"$set\",\"$unset\",\"autoTranslateFetching\"],\"mappings\":\"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\"}"}