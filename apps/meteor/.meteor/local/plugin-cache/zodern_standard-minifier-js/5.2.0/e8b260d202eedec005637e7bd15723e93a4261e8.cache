{"code":"function module(e,t,n){n.link(\"@babel/runtime/regenerator\",{default:function(e){i=e}},0),n.export({CustomOAuth:function(){return m}}),n.link(\"@rocket.chat/random\",{Random:function(e){r=e}},0),n.link(\"@rocket.chat/string-helpers\",{capitalize:function(e){o=e}},1),n.link(\"meteor/accounts-base\",{Accounts:function(e){s=e}},2),n.link(\"meteor/check\",{Match:function(e){a=e}},3),n.link(\"meteor/meteor\",{Meteor:function(e){u=e}},4),n.link(\"meteor/oauth\",{OAuth:function(e){c=e}},5),n.link(\"../../../client/lib/2fa/overrideLoginMethod\",{overrideLoginMethod:function(e){h=e}},6),n.link(\"../../../client/lib/loginServices\",{loginServices:function(e){l=e}},7),n.link(\"../../../client/meteorOverrides/login/oauth\",{createOAuthTotpLoginMethod:function(e){d=e}},8),n.link(\"../../../lib/utils/isURL\",{isURL:function(e){p=e}},9);var i,r,o,s,a,u,c,h,l,d,p,m=function(){function e(e,t){if(this.name=void 0,this.serverURL=void 0,this.authorizePath=void 0,this.scope=void 0,this.responseType=void 0,this.name=e,this.name=e,!a.test(this.name,String))throw new u.Error(\"CustomOAuth: Name is required and must be String\");this.configure(t),s.oauth.registerService(this.name),this.configureLogin()}var t=e.prototype;return t.configure=function(e){if(!a.test(e,Object))throw new u.Error(\"CustomOAuth: Options is required and must be Object\");if(!a.test(e.serverURL,String))throw new u.Error(\"CustomOAuth: Options.serverURL is required and must be String\");a.test(e.authorizePath,String)||(e.authorizePath=\"/oauth/authorize\"),a.test(e.scope,String)||(e.scope=\"openid\"),this.serverURL=e.serverURL,this.authorizePath=e.authorizePath,this.scope=e.scope,this.responseType=e.responseType||\"code\",p(this.authorizePath)||(this.authorizePath=this.serverURL+this.authorizePath)},t.configureLogin=function(){var e=this,t=\"loginWith\"+o(String(this.name||\"\")),n=d(this),r=function(t,n){var r;return i.async(function(o){for(;;)switch(o.prev=o.next){case 0:return r=s.oauth.credentialRequestCompleteHandler(n),o.next=3,i.awrap(e.requestCredential(t,r));case 3:case\"end\":return o.stop()}},null,null,null,Promise)};u[t]=function(e,t){h(r,[e],t,n)}},t.requestCredential=function(){var e,t,n,o,a,u,h,d=arguments;return i.async(function(p){for(;;)switch(p.prev=p.next){case 0:return e=d.length>0&&void 0!==d[0]?d[0]:{},t=d.length>1?d[1]:void 0,p.next=4,i.awrap(l.loadLoginService(this.name));case 4:if(n=p.sent){p.next=8;break}return t&&t(new s.ConfigError),p.abrupt(\"return\");case 8:o=r.secret(),a=c._loginStyle(this.name,n),u=-1!==this.authorizePath.indexOf(\"?\")?\"&\":\"?\",h=\"\"+this.authorizePath+u+\"client_id=\"+n.clientId+\"&redirect_uri=\"+encodeURIComponent(c._redirectUri(this.name,n))+\"&response_type=\"+encodeURIComponent(this.responseType)+\"&state=\"+encodeURIComponent(c._stateParam(a,o,e.redirectUrl))+\"&scope=\"+encodeURIComponent(this.scope),c.launchLogin({loginService:this.name,loginStyle:a,loginUrl:h,credentialRequestCompleteCallback:t,credentialToken:o,popupOptions:{width:900,height:450}});case 13:case\"end\":return p.stop()}},null,this,null,Promise)},e}()}","map":"{\"version\":3,\"sources\":[\"app/custom-oauth/client/CustomOAuth.ts\",\"<anon>\"],\"sourcesContent\":[\"import type { OAuthConfiguration, OauthConfig } from '@rocket.chat/core-typings';\\nimport { Random } from '@rocket.chat/random';\\nimport { capitalize } from '@rocket.chat/string-helpers';\\nimport { Accounts } from 'meteor/accounts-base';\\nimport { Match } from 'meteor/check';\\nimport { Meteor } from 'meteor/meteor';\\nimport { OAuth } from 'meteor/oauth';\\n\\nimport type { IOAuthProvider } from '../../../client/definitions/IOAuthProvider';\\nimport { overrideLoginMethod, type LoginCallback } from '../../../client/lib/2fa/overrideLoginMethod';\\nimport { loginServices } from '../../../client/lib/loginServices';\\nimport { createOAuthTotpLoginMethod } from '../../../client/meteorOverrides/login/oauth';\\nimport { isURL } from '../../../lib/utils/isURL';\\n\\n// Request custom OAuth credentials for the user\\n// @param options {optional}\\n// @param credentialRequestCompleteCallback {Function} Callback function to call on\\n//   completion. Takes one argument, credentialToken on success, or Error on\\n//   error.\\n\\nexport class CustomOAuth implements IOAuthProvider {\\n\\tpublic serverURL: string;\\n\\n\\tpublic authorizePath: string;\\n\\n\\tpublic scope: string;\\n\\n\\tpublic responseType: string;\\n\\n\\tconstructor(public readonly name: string, options: OauthConfig) {\\n\\t\\tthis.name = name;\\n\\t\\tif (!Match.test(this.name, String)) {\\n\\t\\t\\tthrow new Meteor.Error('CustomOAuth: Name is required and must be String');\\n\\t\\t}\\n\\n\\t\\tthis.configure(options);\\n\\n\\t\\tAccounts.oauth.registerService(this.name);\\n\\n\\t\\tthis.configureLogin();\\n\\t}\\n\\n\\tconfigure(options: OauthConfig) {\\n\\t\\tif (!Match.test(options, Object)) {\\n\\t\\t\\tthrow new Meteor.Error('CustomOAuth: Options is required and must be Object');\\n\\t\\t}\\n\\n\\t\\tif (!Match.test(options.serverURL, String)) {\\n\\t\\t\\tthrow new Meteor.Error('CustomOAuth: Options.serverURL is required and must be String');\\n\\t\\t}\\n\\n\\t\\tif (!Match.test(options.authorizePath, String)) {\\n\\t\\t\\toptions.authorizePath = '/oauth/authorize';\\n\\t\\t}\\n\\n\\t\\tif (!Match.test(options.scope, String)) {\\n\\t\\t\\toptions.scope = 'openid';\\n\\t\\t}\\n\\n\\t\\tthis.serverURL = options.serverURL;\\n\\t\\tthis.authorizePath = options.authorizePath;\\n\\t\\tthis.scope = options.scope;\\n\\t\\tthis.responseType = options.responseType || 'code';\\n\\n\\t\\tif (!isURL(this.authorizePath)) {\\n\\t\\t\\tthis.authorizePath = this.serverURL + this.authorizePath;\\n\\t\\t}\\n\\t}\\n\\n\\tconfigureLogin() {\\n\\t\\tconst loginWithService = `loginWith${capitalize(String(this.name || ''))}` as const;\\n\\n\\t\\tconst loginWithOAuthTokenAndTOTP = createOAuthTotpLoginMethod(this);\\n\\n\\t\\tconst loginWithOAuthToken = async (options?: Meteor.LoginWithExternalServiceOptions, callback?: LoginCallback) => {\\n\\t\\t\\tconst credentialRequestCompleteCallback = Accounts.oauth.credentialRequestCompleteHandler(callback);\\n\\t\\t\\tawait this.requestCredential(options, credentialRequestCompleteCallback);\\n\\t\\t};\\n\\n\\t\\t(Meteor as any)[loginWithService] = (options: Meteor.LoginWithExternalServiceOptions, callback: LoginCallback) => {\\n\\t\\t\\toverrideLoginMethod(loginWithOAuthToken, [options], callback, loginWithOAuthTokenAndTOTP);\\n\\t\\t};\\n\\t}\\n\\n\\tasync requestCredential(\\n\\t\\toptions: Meteor.LoginWithExternalServiceOptions = {},\\n\\t\\tcredentialRequestCompleteCallback: (credentialTokenOrError?: string | Error) => void,\\n\\t) {\\n\\t\\tconst config = await loginServices.loadLoginService<OAuthConfiguration>(this.name);\\n\\t\\tif (!config) {\\n\\t\\t\\tif (credentialRequestCompleteCallback) {\\n\\t\\t\\t\\tcredentialRequestCompleteCallback(new Accounts.ConfigError());\\n\\t\\t\\t}\\n\\t\\t\\treturn;\\n\\t\\t}\\n\\n\\t\\tconst credentialToken = Random.secret();\\n\\t\\tconst loginStyle = OAuth._loginStyle(this.name, config);\\n\\n\\t\\tconst separator = this.authorizePath.indexOf('?') !== -1 ? '&' : '?';\\n\\n\\t\\tconst loginUrl =\\n\\t\\t\\t`${this.authorizePath}${separator}client_id=${config.clientId}&redirect_uri=${encodeURIComponent(\\n\\t\\t\\t\\tOAuth._redirectUri(this.name, config),\\n\\t\\t\\t)}&response_type=${encodeURIComponent(this.responseType)}` +\\n\\t\\t\\t`&state=${encodeURIComponent(OAuth._stateParam(loginStyle, credentialToken, options.redirectUrl))}&scope=${encodeURIComponent(\\n\\t\\t\\t\\tthis.scope,\\n\\t\\t\\t)}`;\\n\\n\\t\\tOAuth.launchLogin({\\n\\t\\t\\tloginService: this.name,\\n\\t\\t\\tloginStyle,\\n\\t\\t\\tloginUrl,\\n\\t\\t\\tcredentialRequestCompleteCallback,\\n\\t\\t\\tcredentialToken,\\n\\t\\t\\tpopupOptions: {\\n\\t\\t\\t\\twidth: 900,\\n\\t\\t\\t\\theight: 450,\\n\\t\\t\\t},\\n\\t\\t});\\n\\t}\\n}\\n\",null],\"names\":[\"module\",\"link\",\"default\",\"v\",\"_regeneratorRuntime\",\"export\",\"CustomOAuth\",\"Random\",\"capitalize\",\"Accounts\",\"Match\",\"Meteor\",\"OAuth\",\"overrideLoginMethod\",\"loginServices\",\"createOAuthTotpLoginMethod\",\"isURL\",\"name\",\"options\",\"serverURL\",\"authorizePath\",\"scope\",\"responseType\",\"test\",\"String\",\"Error\",\"configure\",\"oauth\",\"registerService\",\"configureLogin\",\"_proto\",\"prototype\",\"Object\",\"_this\",\"loginWithService\",\"loginWithOAuthTokenAndTOTP\",\"loginWithOAuthToken\",\"callback\",\"credentialRequestCompleteCallback\",\"async\",\"_context\",\"prev\",\"next\",\"credentialRequestCompleteHandler\",\"awrap\",\"requestCredential\",\"stop\",\"Promise\",\"config\",\"credentialToken\",\"loginStyle\",\"separator\",\"loginUrl\",\"_args2\",\"arguments\",\"_context2\",\"length\",\"undefined\",\"loadLoginService\",\"sent\",\"ConfigError\",\"abrupt\",\"secret\",\"_loginStyle\",\"indexOf\",\"clientId\",\"encodeURIComponent\",\"_redirectUri\",\"_stateParam\",\"redirectUrl\",\"launchLogin\",\"loginService\",\"popupOptions\",\"width\",\"height\"],\"mappings\":\"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\"}"}