{"code":"function module(e,t,r){let i,s,o,n,a,y,h,c,d,l,p,u,E,g,K,S,m,R,w,I,A,D,f,k,v,T,O,_,x,C,b,G,N,Y,P;let F=[\"_id\"],M=[\"msg\",\"attachments\"];r.link(\"@babel/runtime/helpers/objectWithoutProperties\",{default(e){i=e}},0),r.link(\"@babel/runtime/helpers/objectSpread2\",{default(e){s=e}},1),r.link(\"@babel/runtime/helpers/asyncIterator\",{default(e){o=e}},2),r.export({E2ERoom:()=>W}),r.link(\"@rocket.chat/base64\",{Base64(e){n=e}},0),r.link(\"@rocket.chat/emitter\",{Emitter(e){a=e}},1),r.link(\"ejson\",{default(e){y=e}},2),r.link(\"../../../client/lib/RoomManager\",{RoomManager(e){h=e}},3),r.link(\"../../../client/lib/rooms/roomCoordinator\",{roomCoordinator(e){c=e}},4),r.link(\"../../../definition/IRoomTypeConfig\",{RoomSettingsEnum(e){d=e}},5),r.link(\"../../models/client\",{ChatRoom(e){l=e},Subscriptions(e){p=e},Messages(e){u=e}},6),r.link(\"../../utils/client/lib/SDKClient\",{sdk(e){E=e}},7),r.link(\"../../utils/lib/i18n\",{t(e){g=e}},8),r.link(\"./E2ERoomState\",{E2ERoomState(e){K=e}},9),r.link(\"./helper\",{toString(e){S=e},toArrayBuffer(e){m=e},joinVectorAndEcryptedData(e){R=e},splitVectorAndEcryptedData(e){w=e},encryptRSA(e){I=e},encryptAES(e){A=e},decryptRSA(e){D=e},decryptAES(e){f=e},generateAESKey(e){k=e},exportJWKKey(e){v=e},importAESKey(e){T=e},importRSAKey(e){O=e},readFileAsArrayBuffer(e){_=e},encryptAESCTR(e){x=e},generateAESCTRKey(e){C=e},sha256HashFromArrayBuffer(e){b=e},createSha256HashFromText(e){G=e}},10),r.link(\"./logger\",{log(e){N=e},logError(e){Y=e}},11),r.link(\"./rocketchat.e2e\",{e2e(e){P=e}},12);let U=Symbol(\"keyID\"),B=Symbol(\"PAUSED\"),H={[K.NOT_STARTED]:[K.ESTABLISHING,K.DISABLED,K.KEYS_RECEIVED],[K.READY]:[K.DISABLED,K.CREATING_KEYS,K.WAITING_KEYS],[K.ERROR]:[K.KEYS_RECEIVED,K.NOT_STARTED],[K.WAITING_KEYS]:[K.KEYS_RECEIVED,K.ERROR,K.DISABLED],[K.ESTABLISHING]:[K.READY,K.KEYS_RECEIVED,K.ERROR,K.DISABLED,K.WAITING_KEYS,K.CREATING_KEYS]},V=(e,t)=>e===t?t===K.ERROR:!!(!(e in H)||H[e].includes(t))&&t;class W extends a{constructor(e,t){super(),this.state=void 0,this[B]=void 0,this[U]=void 0,this.userId=void 0,this.roomId=void 0,this.typeOfRoom=void 0,this.roomKeyId=void 0,this.groupSessionKey=void 0,this.oldKeys=void 0,this.sessionKeyExportedString=void 0,this.sessionKeyExported=void 0,this.userId=e,this.roomId=t._id,this.typeOfRoom=t.t,this.roomKeyId=t.e2eKeyId,this.once(K.READY,async()=>(await this.decryptOldRoomKeys(),this.decryptPendingMessages())),this.once(K.READY,()=>this.decryptSubscription()),this.on(\"STATE_CHANGED\",e=>{this.roomId===h.opened&&this.log(\"[PREV: \".concat(e,\"]\"),\"State CHANGED\")}),this.on(\"STATE_CHANGED\",()=>this.handshake()),this.setState(K.NOT_STARTED)}log(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];N(\"E2E ROOM { state: \".concat(this.state,\", rid: \").concat(this.roomId,\" }\"),...t)}error(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];Y(\"E2E ROOM { state: \".concat(this.state,\", rid: \").concat(this.roomId,\" }\"),...t)}hasSessionKey(){return!!this.groupSessionKey}getState(){return this.state}setState(e){let t=this.state,r=V(t,e);if(!r){this.error(\"invalid state \".concat(t,\" -> \").concat(e));return}this.state=r,this.log(t,\"->\",r),this.emit(\"STATE_CHANGED\",t),this.emit(r,this)}isReady(){return this.state===K.READY}isDisabled(){return this.state===K.DISABLED}enable(){this.state!==K.READY&&this.setState(K.READY)}disable(){this.setState(K.DISABLED)}pause(){this.log(\"PAUSED\",this[B],\"->\",!0),this[B]=!0,this.emit(\"PAUSED\",!0)}resume(){this.log(\"PAUSED\",this[B],\"->\",!1),this[B]=!1,this.emit(\"PAUSED\",!1)}keyReceived(){this.setState(K.KEYS_RECEIVED)}async shouldConvertSentMessages(e){return!!this.isReady()&&!this[B]&&(void 0===this[B]?new Promise(e=>{this.once(\"PAUSED\",e)}):\"/\"!==e.msg[0])}shouldConvertReceivedMessages(){return this.isReady()}isWaitingKeys(){return this.state===K.WAITING_KEYS}get keyID(){return this[U]}set keyID(e){this[U]=e}async decryptSubscription(){var e;let t=p.findOne({rid:this.roomId});if((null==t?void 0:null===(e=t.lastMessage)||void 0===e?void 0:e.t)!==\"e2e\"){this.log(\"decryptSubscriptions nothing to do\");return}let r=await this.decryptMessage(t.lastMessage);p.update({_id:t._id},{$set:{lastMessage:r}}),this.log(\"decryptSubscriptions Done\")}async decryptOldRoomKeys(){let e=p.findOne({rid:this.roomId});if(!(null!=e&&e.oldRoomKeys)||(null==e?void 0:e.oldRoomKeys.length)===0){this.log(\"decryptOldRoomKeys nothing to do\");return}let t=[];var r=!1,i=!1;try{for(var n,a,y=o(e.oldRoomKeys);r=!(a=await y.next()).done;r=!1){let e=a.value;try{let r=await this.decryptSessionKey(e.E2EKey);t.push(s(s({},e),{},{E2EKey:r}))}catch(r){this.error(\"Cannot decrypt old room key with id \".concat(e.e2eKeyId,\". This is likely because user private key changed or is missing. Skipping\")),t.push(s(s({},e),{},{E2EKey:null}))}}}catch(e){i=!0,n=e}finally{try{r&&null!=y.return&&await y.return()}finally{if(i)throw n}}this.oldKeys=t,this.log(\"decryptOldRoomKeys Done\")}async exportOldRoomKeys(e){if(this.log(\"exportOldRoomKeys starting\"),!e||0===e.length){this.log(\"exportOldRoomKeys nothing to do\");return}let t=[];var r=!1,i=!1;try{for(var n,a,y=o(e);r=!(a=await y.next()).done;r=!1){let e=a.value;try{if(!e.E2EKey)continue;let r=await this.exportSessionKey(e.E2EKey);t.push(s(s({},e),{},{E2EKey:r}))}catch(t){this.error(\"Cannot decrypt old room key with id \".concat(e.e2eKeyId,\". This is likely because user private key changed or is missing. Skipping\"))}}}catch(e){i=!0,n=e}finally{try{r&&null!=y.return&&await y.return()}finally{if(i)throw n}}return this.log(\"exportOldRoomKeys Done: \".concat(t.length,\" keys exported\")),t}async decryptPendingMessages(){return u.find({rid:this.roomId,t:\"e2e\",e2e:\"pending\"}).forEach(async e=>{let{_id:t}=e,r=i(e,F);u.update({_id:t},await this.decryptMessage(r))})}async handshake(){if(P.isReady()&&(this.state===K.KEYS_RECEIVED||this.state===K.NOT_STARTED)){this.setState(K.ESTABLISHING);try{var e;let t=null===(e=p.findOne({rid:this.roomId}))||void 0===e?void 0:e.E2EKey;if(t){await this.importGroupKey(t),this.setState(K.READY);return}}catch(e){this.setState(K.ERROR),this.error(\"Error fetching group key: \",e);return}try{let e=l.findOne({_id:this.roomId});if(!e.e2eKeyId&&this.userShouldCreateKeys(e)){this.setState(K.CREATING_KEYS),await this.createGroupKey(),this.setState(K.READY);return}this.setState(K.WAITING_KEYS),this.log(\"Requesting room key\"),E.publish(\"notify-room-users\",[\"\".concat(this.roomId,\"/e2ekeyRequest\"),this.roomId,e.e2eKeyId])}catch(e){this.setState(K.ERROR)}}}userShouldCreateKeys(e){return\"d\"===e.t||e.u._id===this.userId}isSupportedRoomType(e){return c.getRoomDirectives(e).allowRoomSettingChange({},d.E2E)}async decryptSessionKey(e){return T(JSON.parse(await this.exportSessionKey(e)))}async exportSessionKey(e){e=e.slice(12),e=n.decode(e);let t=await D(P.privateKey,e);return S(t)}async importGroupKey(e){this.log(\"Importing room key ->\",this.roomId),e=e.slice(12),e=n.decode(e);try{let t=await D(P.privateKey,e);this.sessionKeyExportedString=S(t)}catch(e){return this.error(\"Error decrypting group key: \",e),!1}this.keyID||(this.keyID=this.roomKeyId||(await G(this.sessionKeyExportedString)).slice(0,12));try{let e=await T(JSON.parse(this.sessionKeyExportedString));this.groupSessionKey=e}catch(e){return this.error(\"Error importing group key: \",e),!1}return!0}async createNewGroupKey(){this.groupSessionKey=await k();let e=await v(this.groupSessionKey);this.sessionKeyExportedString=JSON.stringify(e),this.keyID=(await G(this.sessionKeyExportedString)).slice(0,12)}async createGroupKey(){this.log(\"Creating room key\");try{await this.createNewGroupKey(),await E.call(\"e2e.setRoomKeyID\",this.roomId,this.keyID),await E.rest.post(\"/v1/e2e.updateGroupKey\",{rid:this.roomId,uid:this.userId,key:await this.encryptGroupKeyForParticipant(P.publicKey)}),await this.encryptKeyForOtherParticipants()}catch(e){throw this.error(\"Error exporting group key: \",e),e}}async resetRoomKey(){if(this.log(\"Resetting room key\"),!P.publicKey){this.error(\"Cannot reset room key. No public key found.\");return}this.setState(K.CREATING_KEYS);try{await this.createNewGroupKey();let e={e2eKeyId:this.keyID,e2eKey:await this.encryptGroupKeyForParticipant(P.publicKey)};return this.setState(K.READY),this.log(\"Room key reset done for room \".concat(this.roomId)),e}catch(e){throw this.error(\"Error resetting group key: \",e),e}}onRoomKeyReset(e){this.log(\"Room keyID was reset. New keyID: \".concat(e,\" Previous keyID: \").concat(this.keyID)),this.setState(K.WAITING_KEYS),this.keyID=e,this.groupSessionKey=void 0,this.sessionKeyExportedString=void 0,this.sessionKeyExported=void 0,this.oldKeys=void 0}async encryptKeyForOtherParticipants(){try{let y=p.findOne({rid:this.roomId}),h=await this.exportOldRoomKeys(null==y?void 0:y.oldRoomKeys),c=(await E.call(\"e2e.getUsersOfRoomWithoutKey\",this.roomId)).users.filter(e=>{var t;return null==e?void 0:null===(t=e.e2e)||void 0===t?void 0:t.public_key});if(!c.length)return;let d={[this.roomId]:[]};var e=!1,t=!1;try{for(var r,i,n,a=o(c);e=!(n=await a.next()).done;e=!1){let e=n.value;{let t=await this.encryptGroupKeyForParticipant(e.e2e.public_key),r=await this.encryptOldKeysForParticipant(null===(i=e.e2e)||void 0===i?void 0:i.public_key,h);d[this.roomId].push(s({_id:e._id,key:t},r&&{oldKeys:r}))}}}catch(e){t=!0,r=e}finally{try{e&&null!=a.return&&await a.return()}finally{if(t)throw r}}await E.rest.post(\"/v1/e2e.provideUsersSuggestedGroupKeys\",{usersSuggestedGroupKeys:d})}catch(e){return this.error(\"Error getting room users: \",e)}}async encryptOldKeysForParticipant(e,t){let r;if(t&&0!==t.length){try{r=await O(JSON.parse(e),[\"encrypt\"])}catch(e){return this.error(\"Error importing user key: \",e)}try{let e=[];var i=!1,a=!1;try{for(var y,h,c=o(t);i=!(h=await c.next()).done;i=!1){let t=h.value;{if(!t.E2EKey)continue;let i=await I(r,m(t.E2EKey)),o=t.e2eKeyId+n.encode(new Uint8Array(i));e.push(s(s({},t),{},{E2EKey:o}))}}}catch(e){a=!0,y=e}finally{try{i&&null!=c.return&&await c.return()}finally{if(a)throw y}}return e}catch(e){return this.error(\"Error encrypting user key: \",e)}}}async encryptGroupKeyForParticipant(e){let t;try{t=await O(JSON.parse(e),[\"encrypt\"])}catch(e){return this.error(\"Error importing user key: \",e)}try{let e=await I(t,m(this.sessionKeyExportedString)),r=this.keyID+n.encode(new Uint8Array(e));return r}catch(e){return this.error(\"Error encrypting user key: \",e)}}async encryptFile(e){let t;let r=await _(e),i=await b(new Uint8Array(r)),s=crypto.getRandomValues(new Uint8Array(16)),o=await C();try{t=await x(s,o,r)}catch(e){return console.log(e),this.error(\"Error encrypting group key: \",e)}let a=await window.crypto.subtle.exportKey(\"jwk\",o),y=await G(e.name),h=new File([m(t)],y);return{file:h,key:a,iv:n.encode(s),type:e.type,hash:i}}async decryptFile(e,t,r){let i=n.decode(r),s=await window.crypto.subtle.importKey(\"jwk\",t,{name:\"AES-CTR\"},!0,[\"encrypt\",\"decrypt\"]);return window.crypto.subtle.decrypt({name:\"AES-CTR\",counter:i,length:64},s,e)}async encryptText(e){let t=crypto.getRandomValues(new Uint8Array(16));try{let r=await A(t,this.groupSessionKey,e);return this.keyID+n.encode(R(t,r))}catch(e){throw this.error(\"Error encrypting message: \",e),e}}async encryptMessageContent(e){let t=new TextEncoder().encode(y.stringify(e));return{algorithm:\"rc.v1.aes-sha2\",ciphertext:await this.encryptText(t)}}async encryptMessage(e){let{msg:t,attachments:r}=e,o=i(e,M),n=await this.encryptMessageContent({msg:t,attachments:r});return s(s({},o),{},{content:n,t:\"e2e\",e2e:\"pending\"})}encrypt(e){if(!this.isSupportedRoomType(this.typeOfRoom))return;if(!this.groupSessionKey)throw Error(g(\"E2E_Invalid_Key\"));let t=new Date,r=new TextEncoder().encode(y.stringify({_id:e._id,text:e.msg,userId:this.userId,ts:t}));return this.encryptText(r)}async decryptContent(e){if(e.content&&\"rc.v1.aes-sha2\"===e.content.algorithm){let t=await this.decrypt(e.content.ciphertext);Object.assign(e,t)}return e}async decryptMessage(e){if(\"e2e\"!==e.t||\"done\"===e.e2e)return e;if(e.msg){let t=await this.decrypt(e.msg);null!=t&&t.text&&(e.msg=t.text)}return e=await this.decryptContent(e),s(s({},e),{},{e2e:\"done\"})}async doDecrypt(e,t,r){let i=await f(e,t,r);return y.parse(new TextDecoder(\"UTF-8\").decode(new Uint8Array(i)))}async decrypt(e){let t=e.slice(0,12);e=e.slice(12);let[r,i]=w(n.decode(e)),s=\"\";if(t!==this.keyID){var o;let n=null===(o=this.oldKeys)||void 0===o?void 0:o.find(e=>e.e2eKeyId===t);if(!n)try{return await this.doDecrypt(r,this.groupSessionKey,i)}catch(t){return this.error(\"Error decrypting message: \",t,e),{msg:g(\"E2E_indecipherable\")}}s=n.E2EKey}try{return await this.doDecrypt(r,s||this.groupSessionKey,i)}catch(t){return this.error(\"Error decrypting message: \",t,e),{msg:g(\"E2E_Key_Error\")}}}provideKeyToUser(e){this.keyID===e&&(this.encryptKeyForOtherParticipants(),this.setState(K.READY))}onStateChange(e){return this.on(\"STATE_CHANGED\",e),()=>this.off(\"STATE_CHANGED\",e)}async encryptGroupKeyForParticipantsWaitingForTheKeys(e){if(!this.isReady())return;let t=p.findOne({rid:this.roomId}),r=await this.exportOldRoomKeys(null==t?void 0:t.oldRoomKeys),i=await Promise.all(e.map(async e=>{let{_id:t,public_key:i}=e,o=await this.encryptGroupKeyForParticipant(i),n=await this.encryptOldKeysForParticipant(i,r);return s({_id:t,key:o},n&&{oldKeys:n})}));return i}}}","map":"{\"version\":3,\"sources\":[\"app/e2e/client/rocketchat.e2e.room.ts\",\"<anon>\"],\"sourcesContent\":[\"import { Base64 } from '@rocket.chat/base64';\\nimport { Emitter } from '@rocket.chat/emitter';\\nimport EJSON from 'ejson';\\n\\nimport { RoomManager } from '../../../client/lib/RoomManager';\\nimport { roomCoordinator } from '../../../client/lib/rooms/roomCoordinator';\\nimport { RoomSettingsEnum } from '../../../definition/IRoomTypeConfig';\\nimport { ChatRoom, Subscriptions, Messages } from '../../models/client';\\nimport { sdk } from '../../utils/client/lib/SDKClient';\\nimport { t } from '../../utils/lib/i18n';\\nimport { E2ERoomState } from './E2ERoomState';\\nimport {\\n\\ttoString,\\n\\ttoArrayBuffer,\\n\\tjoinVectorAndEcryptedData,\\n\\tsplitVectorAndEcryptedData,\\n\\tencryptRSA,\\n\\tencryptAES,\\n\\tdecryptRSA,\\n\\tdecryptAES,\\n\\tgenerateAESKey,\\n\\texportJWKKey,\\n\\timportAESKey,\\n\\timportRSAKey,\\n\\treadFileAsArrayBuffer,\\n\\tencryptAESCTR,\\n\\tgenerateAESCTRKey,\\n\\tsha256HashFromArrayBuffer,\\n\\tcreateSha256HashFromText,\\n} from './helper';\\nimport { log, logError } from './logger';\\nimport { e2e } from './rocketchat.e2e';\\n\\nconst KEY_ID = Symbol('keyID');\\nconst PAUSED = Symbol('PAUSED');\\n\\nconst permitedMutations: any = {\\n\\t[E2ERoomState.NOT_STARTED]: [E2ERoomState.ESTABLISHING, E2ERoomState.DISABLED, E2ERoomState.KEYS_RECEIVED],\\n\\t[E2ERoomState.READY]: [E2ERoomState.DISABLED, E2ERoomState.CREATING_KEYS, E2ERoomState.WAITING_KEYS],\\n\\t[E2ERoomState.ERROR]: [E2ERoomState.KEYS_RECEIVED, E2ERoomState.NOT_STARTED],\\n\\t[E2ERoomState.WAITING_KEYS]: [E2ERoomState.KEYS_RECEIVED, E2ERoomState.ERROR, E2ERoomState.DISABLED],\\n\\t[E2ERoomState.ESTABLISHING]: [\\n\\t\\tE2ERoomState.READY,\\n\\t\\tE2ERoomState.KEYS_RECEIVED,\\n\\t\\tE2ERoomState.ERROR,\\n\\t\\tE2ERoomState.DISABLED,\\n\\t\\tE2ERoomState.WAITING_KEYS,\\n\\t\\tE2ERoomState.CREATING_KEYS,\\n\\t],\\n};\\n\\nconst filterMutation = (currentState: any, nextState: any): any => {\\n\\tif (currentState === nextState) {\\n\\t\\treturn nextState === E2ERoomState.ERROR;\\n\\t}\\n\\n\\tif (!(currentState in permitedMutations)) {\\n\\t\\treturn nextState;\\n\\t}\\n\\n\\tif (permitedMutations[currentState].includes(nextState)) {\\n\\t\\treturn nextState;\\n\\t}\\n\\n\\treturn false;\\n};\\n\\nexport class E2ERoom extends Emitter {\\n\\tstate: any = undefined;\\n\\n\\t[PAUSED]: boolean | undefined = undefined;\\n\\n\\t[KEY_ID]: any;\\n\\n\\tuserId: any;\\n\\n\\troomId: any;\\n\\n\\ttypeOfRoom: any;\\n\\n\\troomKeyId: any;\\n\\n\\tgroupSessionKey: any;\\n\\n\\toldKeys: any;\\n\\n\\tsessionKeyExportedString: string | undefined;\\n\\n\\tsessionKeyExported: any;\\n\\n\\tconstructor(userId: any, room: any) {\\n\\t\\tsuper();\\n\\n\\t\\tthis.userId = userId;\\n\\t\\tthis.roomId = room._id;\\n\\t\\tthis.typeOfRoom = room.t;\\n\\t\\tthis.roomKeyId = room.e2eKeyId;\\n\\n\\t\\tthis.once(E2ERoomState.READY, async () => {\\n\\t\\t\\tawait this.decryptOldRoomKeys();\\n\\t\\t\\treturn this.decryptPendingMessages();\\n\\t\\t});\\n\\t\\tthis.once(E2ERoomState.READY, () => this.decryptSubscription());\\n\\t\\tthis.on('STATE_CHANGED', (prev) => {\\n\\t\\t\\tif (this.roomId === RoomManager.opened) {\\n\\t\\t\\t\\tthis.log(`[PREV: ${prev}]`, 'State CHANGED');\\n\\t\\t\\t}\\n\\t\\t});\\n\\t\\tthis.on('STATE_CHANGED', () => this.handshake());\\n\\n\\t\\tthis.setState(E2ERoomState.NOT_STARTED);\\n\\t}\\n\\n\\tlog(...msg: unknown[]) {\\n\\t\\tlog(`E2E ROOM { state: ${this.state}, rid: ${this.roomId} }`, ...msg);\\n\\t}\\n\\n\\terror(...msg: unknown[]) {\\n\\t\\tlogError(`E2E ROOM { state: ${this.state}, rid: ${this.roomId} }`, ...msg);\\n\\t}\\n\\n\\thasSessionKey() {\\n\\t\\treturn !!this.groupSessionKey;\\n\\t}\\n\\n\\tgetState() {\\n\\t\\treturn this.state;\\n\\t}\\n\\n\\tsetState(requestedState: any) {\\n\\t\\tconst currentState = this.state;\\n\\t\\tconst nextState = filterMutation(currentState, requestedState);\\n\\n\\t\\tif (!nextState) {\\n\\t\\t\\tthis.error(`invalid state ${currentState} -> ${requestedState}`);\\n\\t\\t\\treturn;\\n\\t\\t}\\n\\n\\t\\tthis.state = nextState;\\n\\t\\tthis.log(currentState, '->', nextState);\\n\\t\\tthis.emit('STATE_CHANGED', currentState);\\n\\t\\tthis.emit(nextState, this);\\n\\t}\\n\\n\\tisReady() {\\n\\t\\treturn this.state === E2ERoomState.READY;\\n\\t}\\n\\n\\tisDisabled() {\\n\\t\\treturn this.state === E2ERoomState.DISABLED;\\n\\t}\\n\\n\\tenable() {\\n\\t\\tif (this.state === E2ERoomState.READY) {\\n\\t\\t\\treturn;\\n\\t\\t}\\n\\n\\t\\tthis.setState(E2ERoomState.READY);\\n\\t}\\n\\n\\tdisable() {\\n\\t\\tthis.setState(E2ERoomState.DISABLED);\\n\\t}\\n\\n\\tpause() {\\n\\t\\tthis.log('PAUSED', this[PAUSED], '->', true);\\n\\t\\tthis[PAUSED] = true;\\n\\t\\tthis.emit('PAUSED', true);\\n\\t}\\n\\n\\tresume() {\\n\\t\\tthis.log('PAUSED', this[PAUSED], '->', false);\\n\\t\\tthis[PAUSED] = false;\\n\\t\\tthis.emit('PAUSED', false);\\n\\t}\\n\\n\\tkeyReceived() {\\n\\t\\tthis.setState(E2ERoomState.KEYS_RECEIVED);\\n\\t}\\n\\n\\tasync shouldConvertSentMessages(message: any) {\\n\\t\\tif (!this.isReady() || this[PAUSED]) {\\n\\t\\t\\treturn false;\\n\\t\\t}\\n\\n\\t\\tif (this[PAUSED] === undefined) {\\n\\t\\t\\treturn new Promise((resolve) => {\\n\\t\\t\\t\\tthis.once('PAUSED', resolve);\\n\\t\\t\\t});\\n\\t\\t}\\n\\n\\t\\tif (message.msg[0] === '/') {\\n\\t\\t\\treturn false;\\n\\t\\t}\\n\\n\\t\\treturn true;\\n\\t}\\n\\n\\tshouldConvertReceivedMessages() {\\n\\t\\treturn this.isReady();\\n\\t}\\n\\n\\tisWaitingKeys() {\\n\\t\\treturn this.state === E2ERoomState.WAITING_KEYS;\\n\\t}\\n\\n\\tget keyID() {\\n\\t\\treturn this[KEY_ID];\\n\\t}\\n\\n\\tset keyID(keyID) {\\n\\t\\tthis[KEY_ID] = keyID;\\n\\t}\\n\\n\\tasync decryptSubscription() {\\n\\t\\tconst subscription = Subscriptions.findOne({ rid: this.roomId });\\n\\n\\t\\tif (subscription?.lastMessage?.t !== 'e2e') {\\n\\t\\t\\tthis.log('decryptSubscriptions nothing to do');\\n\\t\\t\\treturn;\\n\\t\\t}\\n\\n\\t\\tconst message = await this.decryptMessage(subscription.lastMessage);\\n\\n\\t\\tSubscriptions.update(\\n\\t\\t\\t{\\n\\t\\t\\t\\t_id: subscription._id,\\n\\t\\t\\t},\\n\\t\\t\\t{\\n\\t\\t\\t\\t$set: {\\n\\t\\t\\t\\t\\tlastMessage: message,\\n\\t\\t\\t\\t},\\n\\t\\t\\t},\\n\\t\\t);\\n\\t\\tthis.log('decryptSubscriptions Done');\\n\\t}\\n\\n\\tasync decryptOldRoomKeys() {\\n\\t\\tconst sub = Subscriptions.findOne({ rid: this.roomId });\\n\\n\\t\\tif (!sub?.oldRoomKeys || sub?.oldRoomKeys.length === 0) {\\n\\t\\t\\tthis.log('decryptOldRoomKeys nothing to do');\\n\\t\\t\\treturn;\\n\\t\\t}\\n\\n\\t\\tconst keys = [];\\n\\t\\tfor await (const key of sub.oldRoomKeys) {\\n\\t\\t\\ttry {\\n\\t\\t\\t\\tconst k = await this.decryptSessionKey(key.E2EKey);\\n\\t\\t\\t\\tkeys.push({\\n\\t\\t\\t\\t\\t...key,\\n\\t\\t\\t\\t\\tE2EKey: k,\\n\\t\\t\\t\\t});\\n\\t\\t\\t} catch (e) {\\n\\t\\t\\t\\tthis.error(\\n\\t\\t\\t\\t\\t`Cannot decrypt old room key with id ${key.e2eKeyId}. This is likely because user private key changed or is missing. Skipping`,\\n\\t\\t\\t\\t);\\n\\t\\t\\t\\tkeys.push({ ...key, E2EKey: null });\\n\\t\\t\\t}\\n\\t\\t}\\n\\n\\t\\tthis.oldKeys = keys;\\n\\t\\tthis.log('decryptOldRoomKeys Done');\\n\\t}\\n\\n\\tasync exportOldRoomKeys(oldKeys: any) {\\n\\t\\tthis.log('exportOldRoomKeys starting');\\n\\t\\tif (!oldKeys || oldKeys.length === 0) {\\n\\t\\t\\tthis.log('exportOldRoomKeys nothing to do');\\n\\t\\t\\treturn;\\n\\t\\t}\\n\\n\\t\\tconst keys = [];\\n\\t\\tfor await (const key of oldKeys) {\\n\\t\\t\\ttry {\\n\\t\\t\\t\\tif (!key.E2EKey) {\\n\\t\\t\\t\\t\\tcontinue;\\n\\t\\t\\t\\t}\\n\\n\\t\\t\\t\\tconst k = await this.exportSessionKey(key.E2EKey);\\n\\t\\t\\t\\tkeys.push({\\n\\t\\t\\t\\t\\t...key,\\n\\t\\t\\t\\t\\tE2EKey: k,\\n\\t\\t\\t\\t});\\n\\t\\t\\t} catch (e) {\\n\\t\\t\\t\\tthis.error(\\n\\t\\t\\t\\t\\t`Cannot decrypt old room key with id ${key.e2eKeyId}. This is likely because user private key changed or is missing. Skipping`,\\n\\t\\t\\t\\t);\\n\\t\\t\\t}\\n\\t\\t}\\n\\n\\t\\tthis.log(`exportOldRoomKeys Done: ${keys.length} keys exported`);\\n\\t\\treturn keys;\\n\\t}\\n\\n\\tasync decryptPendingMessages() {\\n\\t\\treturn Messages.find({ rid: this.roomId, t: 'e2e', e2e: 'pending' }).forEach(async ({ _id, ...msg }) => {\\n\\t\\t\\tMessages.update({ _id }, await this.decryptMessage(msg));\\n\\t\\t});\\n\\t}\\n\\n\\t// Initiates E2E Encryption\\n\\tasync handshake() {\\n\\t\\tif (!e2e.isReady()) {\\n\\t\\t\\treturn;\\n\\t\\t}\\n\\n\\t\\tif (this.state !== E2ERoomState.KEYS_RECEIVED && this.state !== E2ERoomState.NOT_STARTED) {\\n\\t\\t\\treturn;\\n\\t\\t}\\n\\n\\t\\tthis.setState(E2ERoomState.ESTABLISHING);\\n\\n\\t\\ttry {\\n\\t\\t\\tconst groupKey = Subscriptions.findOne({ rid: this.roomId })?.E2EKey;\\n\\t\\t\\tif (groupKey) {\\n\\t\\t\\t\\tawait this.importGroupKey(groupKey);\\n\\t\\t\\t\\tthis.setState(E2ERoomState.READY);\\n\\t\\t\\t\\treturn;\\n\\t\\t\\t}\\n\\t\\t} catch (error) {\\n\\t\\t\\tthis.setState(E2ERoomState.ERROR);\\n\\t\\t\\tthis.error('Error fetching group key: ', error);\\n\\t\\t\\treturn;\\n\\t\\t}\\n\\n\\t\\ttry {\\n\\t\\t\\tconst room = ChatRoom.findOne({ _id: this.roomId })!;\\n\\t\\t\\t// Only room creator can set keys for room\\n\\t\\t\\tif (!room.e2eKeyId && this.userShouldCreateKeys(room)) {\\n\\t\\t\\t\\tthis.setState(E2ERoomState.CREATING_KEYS);\\n\\t\\t\\t\\tawait this.createGroupKey();\\n\\t\\t\\t\\tthis.setState(E2ERoomState.READY);\\n\\t\\t\\t\\treturn;\\n\\t\\t\\t}\\n\\n\\t\\t\\tthis.setState(E2ERoomState.WAITING_KEYS);\\n\\t\\t\\tthis.log('Requesting room key');\\n\\t\\t\\tsdk.publish('notify-room-users', [`${this.roomId}/e2ekeyRequest`, this.roomId, room.e2eKeyId]);\\n\\t\\t} catch (error) {\\n\\t\\t\\t// this.error = error;\\n\\t\\t\\tthis.setState(E2ERoomState.ERROR);\\n\\t\\t}\\n\\t}\\n\\n\\tuserShouldCreateKeys(room: any) {\\n\\t\\t// On DMs, we'll allow any user to set the keys\\n\\t\\tif (room.t === 'd') {\\n\\t\\t\\treturn true;\\n\\t\\t}\\n\\n\\t\\treturn room.u._id === this.userId;\\n\\t}\\n\\n\\tisSupportedRoomType(type: any) {\\n\\t\\treturn roomCoordinator.getRoomDirectives(type).allowRoomSettingChange({}, RoomSettingsEnum.E2E);\\n\\t}\\n\\n\\tasync decryptSessionKey(key: any) {\\n\\t\\treturn importAESKey(JSON.parse(await this.exportSessionKey(key)));\\n\\t}\\n\\n\\tasync exportSessionKey(key: any) {\\n\\t\\tkey = key.slice(12);\\n\\t\\tkey = Base64.decode(key);\\n\\n\\t\\tconst decryptedKey = await decryptRSA(e2e.privateKey, key);\\n\\t\\treturn toString(decryptedKey);\\n\\t}\\n\\n\\tasync importGroupKey(groupKey: any) {\\n\\t\\tthis.log('Importing room key ->', this.roomId);\\n\\t\\t// Get existing group key\\n\\t\\t// const keyID = groupKey.slice(0, 12);\\n\\t\\tgroupKey = groupKey.slice(12);\\n\\t\\tgroupKey = Base64.decode(groupKey);\\n\\n\\t\\t// Decrypt obtained encrypted session key\\n\\t\\ttry {\\n\\t\\t\\tconst decryptedKey = await decryptRSA(e2e.privateKey, groupKey);\\n\\t\\t\\tthis.sessionKeyExportedString = toString(decryptedKey);\\n\\t\\t} catch (error) {\\n\\t\\t\\tthis.error('Error decrypting group key: ', error);\\n\\t\\t\\treturn false;\\n\\t\\t}\\n\\n\\t\\t// When a new e2e room is created, it will be initialized without an e2e key id\\n\\t\\t// This will prevent new rooms from storing `undefined` as the keyid\\n\\t\\tif (!this.keyID) {\\n\\t\\t\\tthis.keyID = this.roomKeyId || (await createSha256HashFromText(this.sessionKeyExportedString)).slice(0, 12);\\n\\t\\t}\\n\\n\\t\\t// Import session key for use.\\n\\t\\ttry {\\n\\t\\t\\tconst key = await importAESKey(JSON.parse(this.sessionKeyExportedString!));\\n\\t\\t\\t// Key has been obtained. E2E is now in session.\\n\\t\\t\\tthis.groupSessionKey = key;\\n\\t\\t} catch (error) {\\n\\t\\t\\tthis.error('Error importing group key: ', error);\\n\\t\\t\\treturn false;\\n\\t\\t}\\n\\n\\t\\treturn true;\\n\\t}\\n\\n\\tasync createNewGroupKey() {\\n\\t\\tthis.groupSessionKey = await generateAESKey();\\n\\n\\t\\tconst sessionKeyExported = await exportJWKKey(this.groupSessionKey);\\n\\t\\tthis.sessionKeyExportedString = JSON.stringify(sessionKeyExported);\\n\\t\\tthis.keyID = (await createSha256HashFromText(this.sessionKeyExportedString)).slice(0, 12);\\n\\t}\\n\\n\\tasync createGroupKey() {\\n\\t\\tthis.log('Creating room key');\\n\\t\\ttry {\\n\\t\\t\\tawait this.createNewGroupKey();\\n\\n\\t\\t\\tawait sdk.call('e2e.setRoomKeyID', this.roomId, this.keyID);\\n\\t\\t\\tawait sdk.rest.post('/v1/e2e.updateGroupKey', {\\n\\t\\t\\t\\trid: this.roomId,\\n\\t\\t\\t\\tuid: this.userId,\\n\\t\\t\\t\\tkey: await this.encryptGroupKeyForParticipant(e2e.publicKey!),\\n\\t\\t\\t} as any);\\n\\t\\t\\tawait this.encryptKeyForOtherParticipants();\\n\\t\\t} catch (error) {\\n\\t\\t\\tthis.error('Error exporting group key: ', error);\\n\\t\\t\\tthrow error;\\n\\t\\t}\\n\\t}\\n\\n\\tasync resetRoomKey() {\\n\\t\\tthis.log('Resetting room key');\\n\\t\\tif (!e2e.publicKey) {\\n\\t\\t\\tthis.error('Cannot reset room key. No public key found.');\\n\\t\\t\\treturn;\\n\\t\\t}\\n\\n\\t\\tthis.setState(E2ERoomState.CREATING_KEYS);\\n\\t\\ttry {\\n\\t\\t\\tawait this.createNewGroupKey();\\n\\n\\t\\t\\tconst e2eNewKeys = { e2eKeyId: this.keyID, e2eKey: await this.encryptGroupKeyForParticipant(e2e.publicKey) };\\n\\n\\t\\t\\tthis.setState(E2ERoomState.READY);\\n\\t\\t\\tthis.log(`Room key reset done for room ${this.roomId}`);\\n\\n\\t\\t\\treturn e2eNewKeys;\\n\\t\\t} catch (error) {\\n\\t\\t\\tthis.error('Error resetting group key: ', error);\\n\\t\\t\\tthrow error;\\n\\t\\t}\\n\\t}\\n\\n\\tonRoomKeyReset(keyID: any) {\\n\\t\\tthis.log(`Room keyID was reset. New keyID: ${keyID} Previous keyID: ${this.keyID}`);\\n\\t\\tthis.setState(E2ERoomState.WAITING_KEYS);\\n\\t\\tthis.keyID = keyID;\\n\\t\\tthis.groupSessionKey = undefined;\\n\\t\\tthis.sessionKeyExportedString = undefined;\\n\\t\\tthis.sessionKeyExported = undefined;\\n\\t\\tthis.oldKeys = undefined;\\n\\t}\\n\\n\\tasync encryptKeyForOtherParticipants() {\\n\\t\\t// Encrypt generated session key for every user in room and publish to subscription model.\\n\\t\\ttry {\\n\\t\\t\\tconst mySub = Subscriptions.findOne({ rid: this.roomId });\\n\\t\\t\\tconst decryptedOldGroupKeys = await this.exportOldRoomKeys(mySub?.oldRoomKeys);\\n\\t\\t\\tconst users = (await sdk.call('e2e.getUsersOfRoomWithoutKey', this.roomId)).users.filter((user) => user?.e2e?.public_key);\\n\\n\\t\\t\\tif (!users.length) {\\n\\t\\t\\t\\treturn;\\n\\t\\t\\t}\\n\\n\\t\\t\\tconst usersSuggestedGroupKeys = { [this.roomId]: [] as any[] };\\n\\t\\t\\tfor await (const user of users) {\\n\\t\\t\\t\\tconst encryptedGroupKey = await this.encryptGroupKeyForParticipant(user.e2e!.public_key!);\\n\\t\\t\\t\\tconst oldKeys = await this.encryptOldKeysForParticipant(user.e2e?.public_key, decryptedOldGroupKeys);\\n\\n\\t\\t\\t\\tusersSuggestedGroupKeys[this.roomId].push({ _id: user._id, key: encryptedGroupKey, ...(oldKeys && { oldKeys }) });\\n\\t\\t\\t}\\n\\n\\t\\t\\tawait sdk.rest.post('/v1/e2e.provideUsersSuggestedGroupKeys', { usersSuggestedGroupKeys });\\n\\t\\t} catch (error) {\\n\\t\\t\\treturn this.error('Error getting room users: ', error);\\n\\t\\t}\\n\\t}\\n\\n\\tasync encryptOldKeysForParticipant(publicKey: any, oldRoomKeys: any) {\\n\\t\\tif (!oldRoomKeys || oldRoomKeys.length === 0) {\\n\\t\\t\\treturn;\\n\\t\\t}\\n\\n\\t\\tlet userKey;\\n\\n\\t\\ttry {\\n\\t\\t\\tuserKey = await importRSAKey(JSON.parse(publicKey), ['encrypt']);\\n\\t\\t} catch (error) {\\n\\t\\t\\treturn this.error('Error importing user key: ', error);\\n\\t\\t}\\n\\n\\t\\ttry {\\n\\t\\t\\tconst keys = [];\\n\\t\\t\\tfor await (const oldRoomKey of oldRoomKeys) {\\n\\t\\t\\t\\tif (!oldRoomKey.E2EKey) {\\n\\t\\t\\t\\t\\tcontinue;\\n\\t\\t\\t\\t}\\n\\t\\t\\t\\tconst encryptedKey = await encryptRSA(userKey, toArrayBuffer(oldRoomKey.E2EKey));\\n\\t\\t\\t\\tconst encryptedKeyToString = oldRoomKey.e2eKeyId + Base64.encode(new Uint8Array(encryptedKey));\\n\\n\\t\\t\\t\\tkeys.push({ ...oldRoomKey, E2EKey: encryptedKeyToString });\\n\\t\\t\\t}\\n\\t\\t\\treturn keys;\\n\\t\\t} catch (error) {\\n\\t\\t\\treturn this.error('Error encrypting user key: ', error);\\n\\t\\t}\\n\\t}\\n\\n\\tasync encryptGroupKeyForParticipant(publicKey: string) {\\n\\t\\tlet userKey;\\n\\t\\ttry {\\n\\t\\t\\tuserKey = await importRSAKey(JSON.parse(publicKey), ['encrypt']);\\n\\t\\t} catch (error) {\\n\\t\\t\\treturn this.error('Error importing user key: ', error);\\n\\t\\t}\\n\\t\\t// const vector = crypto.getRandomValues(new Uint8Array(16));\\n\\n\\t\\t// Encrypt session key for this user with his/her public key\\n\\t\\ttry {\\n\\t\\t\\tconst encryptedUserKey = await encryptRSA(userKey, toArrayBuffer(this.sessionKeyExportedString));\\n\\t\\t\\tconst encryptedUserKeyToString = this.keyID + Base64.encode(new Uint8Array(encryptedUserKey));\\n\\t\\t\\treturn encryptedUserKeyToString;\\n\\t\\t} catch (error) {\\n\\t\\t\\treturn this.error('Error encrypting user key: ', error);\\n\\t\\t}\\n\\t}\\n\\n\\t// Encrypts files before upload. I/O is in arraybuffers.\\n\\tasync encryptFile(file: any) {\\n\\t\\t// if (!this.isSupportedRoomType(this.typeOfRoom)) {\\n\\t\\t// \\treturn;\\n\\t\\t// }\\n\\n\\t\\tconst fileArrayBuffer = await readFileAsArrayBuffer(file);\\n\\n\\t\\tconst hash = await sha256HashFromArrayBuffer(new Uint8Array(fileArrayBuffer));\\n\\n\\t\\tconst vector = crypto.getRandomValues(new Uint8Array(16));\\n\\t\\tconst key = await generateAESCTRKey();\\n\\t\\tlet result;\\n\\t\\ttry {\\n\\t\\t\\tresult = await encryptAESCTR(vector, key, fileArrayBuffer);\\n\\t\\t} catch (error) {\\n\\t\\t\\tconsole.log(error);\\n\\t\\t\\treturn this.error('Error encrypting group key: ', error);\\n\\t\\t}\\n\\n\\t\\tconst exportedKey = await window.crypto.subtle.exportKey('jwk', key);\\n\\n\\t\\tconst fileName = await createSha256HashFromText(file.name);\\n\\n\\t\\tconst encryptedFile = new File([toArrayBuffer(result)], fileName);\\n\\n\\t\\treturn {\\n\\t\\t\\tfile: encryptedFile,\\n\\t\\t\\tkey: exportedKey,\\n\\t\\t\\tiv: Base64.encode(vector),\\n\\t\\t\\ttype: file.type,\\n\\t\\t\\thash,\\n\\t\\t};\\n\\t}\\n\\n\\t// Decrypt uploaded encrypted files. I/O is in arraybuffers.\\n\\tasync decryptFile(file: any, key: any, iv: any) {\\n\\t\\tconst ivArray = Base64.decode(iv);\\n\\t\\tconst cryptoKey = await window.crypto.subtle.importKey('jwk', key, { name: 'AES-CTR' }, true, ['encrypt', 'decrypt']);\\n\\n\\t\\treturn window.crypto.subtle.decrypt({ name: 'AES-CTR', counter: ivArray, length: 64 }, cryptoKey, file);\\n\\t}\\n\\n\\t// Encrypts messages\\n\\tasync encryptText(data: any) {\\n\\t\\tconst vector = crypto.getRandomValues(new Uint8Array(16));\\n\\n\\t\\ttry {\\n\\t\\t\\tconst result = await encryptAES(vector, this.groupSessionKey, data);\\n\\t\\t\\treturn this.keyID + Base64.encode(joinVectorAndEcryptedData(vector, result));\\n\\t\\t} catch (error) {\\n\\t\\t\\tthis.error('Error encrypting message: ', error);\\n\\t\\t\\tthrow error;\\n\\t\\t}\\n\\t}\\n\\n\\t// Helper function for encryption of content\\n\\tasync encryptMessageContent(contentToBeEncrypted: any) {\\n\\t\\tconst data = new TextEncoder().encode(EJSON.stringify(contentToBeEncrypted));\\n\\n\\t\\treturn {\\n\\t\\t\\talgorithm: 'rc.v1.aes-sha2',\\n\\t\\t\\tciphertext: await this.encryptText(data),\\n\\t\\t};\\n\\t}\\n\\n\\t// Helper function for encryption of content\\n\\tasync encryptMessage(message: any) {\\n\\t\\tconst { msg, attachments, ...rest } = message;\\n\\n\\t\\tconst content = await this.encryptMessageContent({ msg, attachments });\\n\\n\\t\\treturn {\\n\\t\\t\\t...rest,\\n\\t\\t\\tcontent,\\n\\t\\t\\tt: 'e2e',\\n\\t\\t\\te2e: 'pending',\\n\\t\\t};\\n\\t}\\n\\n\\t// Helper function for encryption of messages\\n\\tencrypt(message: any) {\\n\\t\\tif (!this.isSupportedRoomType(this.typeOfRoom)) {\\n\\t\\t\\treturn;\\n\\t\\t}\\n\\n\\t\\tif (!this.groupSessionKey) {\\n\\t\\t\\tthrow new Error(t('E2E_Invalid_Key'));\\n\\t\\t}\\n\\n\\t\\tconst ts = new Date();\\n\\n\\t\\tconst data = new TextEncoder().encode(\\n\\t\\t\\tEJSON.stringify({\\n\\t\\t\\t\\t_id: message._id,\\n\\t\\t\\t\\ttext: message.msg,\\n\\t\\t\\t\\tuserId: this.userId,\\n\\t\\t\\t\\tts,\\n\\t\\t\\t}),\\n\\t\\t);\\n\\n\\t\\treturn this.encryptText(data);\\n\\t}\\n\\n\\tasync decryptContent(data: any) {\\n\\t\\tif (data.content && data.content.algorithm === 'rc.v1.aes-sha2') {\\n\\t\\t\\tconst content = await this.decrypt(data.content.ciphertext);\\n\\t\\t\\tObject.assign(data, content);\\n\\t\\t}\\n\\n\\t\\treturn data;\\n\\t}\\n\\n\\t// Decrypt messages\\n\\tasync decryptMessage(message: any) {\\n\\t\\tif (message.t !== 'e2e' || message.e2e === 'done') {\\n\\t\\t\\treturn message;\\n\\t\\t}\\n\\n\\t\\tif (message.msg) {\\n\\t\\t\\tconst data = await this.decrypt(message.msg);\\n\\n\\t\\t\\tif (data?.text) {\\n\\t\\t\\t\\tmessage.msg = data.text;\\n\\t\\t\\t}\\n\\t\\t}\\n\\n\\t\\tmessage = await this.decryptContent(message);\\n\\n\\t\\treturn {\\n\\t\\t\\t...message,\\n\\t\\t\\te2e: 'done',\\n\\t\\t};\\n\\t}\\n\\n\\tasync doDecrypt(vector: any, key: any, cipherText: any) {\\n\\t\\tconst result = await decryptAES(vector, key, cipherText);\\n\\t\\treturn EJSON.parse(new TextDecoder('UTF-8').decode(new Uint8Array(result)));\\n\\t}\\n\\n\\tasync decrypt(message: any) {\\n\\t\\tconst keyID = message.slice(0, 12);\\n\\t\\tmessage = message.slice(12);\\n\\n\\t\\tconst [vector, cipherText] = splitVectorAndEcryptedData(Base64.decode(message));\\n\\n\\t\\tlet oldKey = '';\\n\\t\\tif (keyID !== this.keyID) {\\n\\t\\t\\tconst oldRoomKey = this.oldKeys?.find((key: any) => key.e2eKeyId === keyID);\\n\\t\\t\\t// Messages already contain a keyID stored with them\\n\\t\\t\\t// That means that if we cannot find a keyID for the key the message has preppended to\\n\\t\\t\\t// The message is indecipherable.\\n\\t\\t\\t// In these cases, we'll give a last shot using the current session key, which may not work\\n\\t\\t\\t// but will be enough to help with some mobile issues.\\n\\t\\t\\tif (!oldRoomKey) {\\n\\t\\t\\t\\ttry {\\n\\t\\t\\t\\t\\treturn await this.doDecrypt(vector, this.groupSessionKey, cipherText);\\n\\t\\t\\t\\t} catch (error) {\\n\\t\\t\\t\\t\\tthis.error('Error decrypting message: ', error, message);\\n\\t\\t\\t\\t\\treturn { msg: t('E2E_indecipherable') };\\n\\t\\t\\t\\t}\\n\\t\\t\\t}\\n\\t\\t\\toldKey = oldRoomKey.E2EKey;\\n\\t\\t}\\n\\n\\t\\ttry {\\n\\t\\t\\treturn await this.doDecrypt(vector, oldKey || this.groupSessionKey, cipherText);\\n\\t\\t} catch (error) {\\n\\t\\t\\tthis.error('Error decrypting message: ', error, message);\\n\\t\\t\\treturn { msg: t('E2E_Key_Error') };\\n\\t\\t}\\n\\t}\\n\\n\\tprovideKeyToUser(keyId: any) {\\n\\t\\tif (this.keyID !== keyId) {\\n\\t\\t\\treturn;\\n\\t\\t}\\n\\n\\t\\tvoid this.encryptKeyForOtherParticipants();\\n\\t\\tthis.setState(E2ERoomState.READY);\\n\\t}\\n\\n\\tonStateChange(cb: any) {\\n\\t\\tthis.on('STATE_CHANGED', cb);\\n\\t\\treturn () => this.off('STATE_CHANGED', cb);\\n\\t}\\n\\n\\tasync encryptGroupKeyForParticipantsWaitingForTheKeys(users: any[]) {\\n\\t\\tif (!this.isReady()) {\\n\\t\\t\\treturn;\\n\\t\\t}\\n\\n\\t\\tconst mySub = Subscriptions.findOne({ rid: this.roomId });\\n\\t\\tconst decryptedOldGroupKeys = await this.exportOldRoomKeys(mySub?.oldRoomKeys);\\n\\t\\tconst usersWithKeys = await Promise.all(\\n\\t\\t\\tusers.map(async (user) => {\\n\\t\\t\\t\\tconst { _id, public_key } = user;\\n\\t\\t\\t\\tconst key = await this.encryptGroupKeyForParticipant(public_key);\\n\\t\\t\\t\\tconst oldKeys = await this.encryptOldKeysForParticipant(public_key, decryptedOldGroupKeys);\\n\\t\\t\\t\\treturn { _id, key, ...(oldKeys && { oldKeys }) };\\n\\t\\t\\t}),\\n\\t\\t);\\n\\n\\t\\treturn usersWithKeys;\\n\\t}\\n}\\n\",null],\"names\":[\"_objectWithoutProperties\",\"_objectSpread\",\"_asyncIterator\",\"Base64\",\"Emitter\",\"EJSON\",\"RoomManager\",\"roomCoordinator\",\"RoomSettingsEnum\",\"ChatRoom\",\"Subscriptions\",\"Messages\",\"sdk\",\"t\",\"E2ERoomState\",\"toString\",\"toArrayBuffer\",\"joinVectorAndEcryptedData\",\"splitVectorAndEcryptedData\",\"encryptRSA\",\"encryptAES\",\"decryptRSA\",\"decryptAES\",\"generateAESKey\",\"exportJWKKey\",\"importAESKey\",\"importRSAKey\",\"readFileAsArrayBuffer\",\"encryptAESCTR\",\"generateAESCTRKey\",\"sha256HashFromArrayBuffer\",\"createSha256HashFromText\",\"log\",\"logError\",\"e2e\",\"module\",\"link\",\"default\",\"v\",\"export\",\"E2ERoom\",\"KEY_ID\",\"Symbol\",\"PAUSED\",\"permitedMutations\",\"NOT_STARTED\",\"ESTABLISHING\",\"DISABLED\",\"KEYS_RECEIVED\",\"READY\",\"CREATING_KEYS\",\"WAITING_KEYS\",\"ERROR\",\"filterMutation\",\"currentState\",\"nextState\",\"includes\",\"constructor\",\"userId\",\"room\",\"state\",\"undefined\",\"roomId\",\"typeOfRoom\",\"roomKeyId\",\"groupSessionKey\",\"oldKeys\",\"sessionKeyExportedString\",\"sessionKeyExported\",\"_id\",\"e2eKeyId\",\"once\",\"decryptOldRoomKeys\",\"decryptPendingMessages\",\"decryptSubscription\",\"on\",\"prev\",\"opened\",\"concat\",\"handshake\",\"setState\",\"_len\",\"arguments\",\"length\",\"msg\",\"Array\",\"_key\",\"error\",\"_len2\",\"_key2\",\"hasSessionKey\",\"getState\",\"requestedState\",\"emit\",\"isReady\",\"isDisabled\",\"enable\",\"disable\",\"pause\",\"resume\",\"keyReceived\",\"shouldConvertSentMessages\",\"message\",\"Promise\",\"resolve\",\"shouldConvertReceivedMessages\",\"isWaitingKeys\",\"keyID\",\"_subscription$lastMes\",\"subscription\",\"findOne\",\"rid\",\"lastMessage\",\"decryptMessage\",\"update\",\"$set\",\"sub\",\"oldRoomKeys\",\"keys\",\"_iteratorAbruptCompletion\",\"_didIteratorError\",\"_iteratorError\",\"_step\",\"_iterator\",\"next\",\"done\",\"key\",\"value\",\"k\",\"decryptSessionKey\",\"E2EKey\",\"push\",\"e\",\"err\",\"return\",\"exportOldRoomKeys\",\"_iteratorAbruptCompletion2\",\"_didIteratorError2\",\"_iteratorError2\",\"_step2\",\"_iterator2\",\"exportSessionKey\",\"find\",\"forEach\",\"_ref\",\"_excluded\",\"_Subscriptions$findOn\",\"groupKey\",\"importGroupKey\",\"userShouldCreateKeys\",\"createGroupKey\",\"publish\",\"u\",\"isSupportedRoomType\",\"type\",\"getRoomDirectives\",\"allowRoomSettingChange\",\"E2E\",\"JSON\",\"parse\",\"slice\",\"decode\",\"decryptedKey\",\"privateKey\",\"createNewGroupKey\",\"stringify\",\"call\",\"rest\",\"post\",\"uid\",\"encryptGroupKeyForParticipant\",\"publicKey\",\"encryptKeyForOtherParticipants\",\"resetRoomKey\",\"e2eNewKeys\",\"e2eKey\",\"onRoomKeyReset\",\"mySub\",\"decryptedOldGroupKeys\",\"users\",\"filter\",\"user\",\"_user$e2e\",\"public_key\",\"usersSuggestedGroupKeys\",\"_iteratorAbruptCompletion3\",\"_didIteratorError3\",\"_iteratorError3\",\"_user$e2e2\",\"_step3\",\"_iterator3\",\"encryptedGroupKey\",\"encryptOldKeysForParticipant\",\"userKey\",\"_iteratorAbruptCompletion4\",\"_didIteratorError4\",\"_iteratorError4\",\"_step4\",\"_iterator4\",\"oldRoomKey\",\"encryptedKey\",\"encryptedKeyToString\",\"encode\",\"Uint8Array\",\"encryptedUserKey\",\"encryptedUserKeyToString\",\"encryptFile\",\"file\",\"result\",\"fileArrayBuffer\",\"hash\",\"vector\",\"crypto\",\"getRandomValues\",\"console\",\"exportedKey\",\"window\",\"subtle\",\"exportKey\",\"fileName\",\"name\",\"encryptedFile\",\"File\",\"iv\",\"decryptFile\",\"ivArray\",\"cryptoKey\",\"importKey\",\"decrypt\",\"counter\",\"encryptText\",\"data\",\"encryptMessageContent\",\"contentToBeEncrypted\",\"TextEncoder\",\"algorithm\",\"ciphertext\",\"encryptMessage\",\"attachments\",\"_excluded2\",\"content\",\"encrypt\",\"Error\",\"ts\",\"Date\",\"text\",\"decryptContent\",\"Object\",\"assign\",\"doDecrypt\",\"cipherText\",\"TextDecoder\",\"oldKey\",\"_this$oldKeys\",\"provideKeyToUser\",\"keyId\",\"onStateChange\",\"cb\",\"off\",\"encryptGroupKeyForParticipantsWaitingForTheKeys\",\"usersWithKeys\",\"all\",\"map\"],\"mappings\":\"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\"}"}