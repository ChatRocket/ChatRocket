{"code":"function module(e,n,r){let t,a,l,u,i,d,s,o,c;r.link(\"@babel/runtime/helpers/objectSpread2\",{default(e){t=e}},0),r.link(\"@rocket.chat/favicon\",{manageFavicon(e){a=e}},0),r.link(\"meteor/meteor\",{Meteor(e){l=e}},1),r.link(\"meteor/session\",{Session(e){u=e}},2),r.link(\"meteor/tracker\",{Tracker(e){i=e}},3),r.link(\"../../app/models/client\",{ChatSubscription(e){d=e},ChatRoom(e){s=e}},4),r.link(\"../../app/utils/client\",{getUserPreference(e){o=e}},5),r.link(\"../lib/utils/fireGlobalEvent\",{fireGlobalEvent(e){c=e}},6);let f=()=>d.find({open:!0,hideUnreadStatus:{$ne:!0},archived:{$ne:!0}},{fields:{unread:1,alert:1,rid:1,t:1,name:1,ls:1,unreadAlert:1,fname:1,prid:1}}).fetch();l.startup(()=>{i.autorun(()=>{let e=o(l.userId(),\"unreadAlert\"),n=!1,r=f().reduce((r,a)=>i.nonreactive(()=>{let l=s.findOne({_id:a.rid},{fields:{usersCount:1}});return(c(\"unread-changed-by-subscription\",t(t({},a),{},{usersCount:null==l?void 0:l.usersCount})),a.alert||a.unread>0)?(!0===a.alert&&\"nothing\"!==a.unreadAlert&&(\"all\"===a.unreadAlert||!1!==e)&&(n=\"•\"),r+a.unread):r}),0);r>0?r>999?u.set(\"unread\",\"999+\"):u.set(\"unread\",r):!1!==n?u.set(\"unread\",n):u.set(\"unread\",\"\")})}),l.startup(()=>{let e=a();i.autorun(()=>{let n=u.get(\"unread\");c(\"unread-changed\",n),e(n)})})}","map":"{\"version\":3,\"sources\":[\"client/startup/unread.ts\",\"<anon>\"],\"sourcesContent\":[\"import type { ISubscription } from '@rocket.chat/core-typings';\\nimport { manageFavicon } from '@rocket.chat/favicon';\\nimport { Meteor } from 'meteor/meteor';\\nimport { Session } from 'meteor/session';\\nimport { Tracker } from 'meteor/tracker';\\n\\nimport { ChatSubscription, ChatRoom } from '../../app/models/client';\\nimport { getUserPreference } from '../../app/utils/client';\\nimport { fireGlobalEvent } from '../lib/utils/fireGlobalEvent';\\n\\nconst fetchSubscriptions = (): ISubscription[] =>\\n\\tChatSubscription.find(\\n\\t\\t{\\n\\t\\t\\topen: true,\\n\\t\\t\\thideUnreadStatus: { $ne: true },\\n\\t\\t\\tarchived: { $ne: true },\\n\\t\\t},\\n\\t\\t{\\n\\t\\t\\tfields: {\\n\\t\\t\\t\\tunread: 1,\\n\\t\\t\\t\\talert: 1,\\n\\t\\t\\t\\trid: 1,\\n\\t\\t\\t\\tt: 1,\\n\\t\\t\\t\\tname: 1,\\n\\t\\t\\t\\tls: 1,\\n\\t\\t\\t\\tunreadAlert: 1,\\n\\t\\t\\t\\tfname: 1,\\n\\t\\t\\t\\tprid: 1,\\n\\t\\t\\t},\\n\\t\\t},\\n\\t).fetch();\\n\\nMeteor.startup(() => {\\n\\tTracker.autorun(() => {\\n\\t\\tconst userUnreadAlert = getUserPreference(Meteor.userId(), 'unreadAlert');\\n\\n\\t\\tlet unreadAlert: false | '•' = false;\\n\\n\\t\\tconst unreadCount = fetchSubscriptions().reduce(\\n\\t\\t\\t(ret, subscription) =>\\n\\t\\t\\t\\tTracker.nonreactive(() => {\\n\\t\\t\\t\\t\\tconst room = ChatRoom.findOne({ _id: subscription.rid }, { fields: { usersCount: 1 } });\\n\\t\\t\\t\\t\\tfireGlobalEvent('unread-changed-by-subscription', {\\n\\t\\t\\t\\t\\t\\t...subscription,\\n\\t\\t\\t\\t\\t\\tusersCount: room?.usersCount,\\n\\t\\t\\t\\t\\t});\\n\\n\\t\\t\\t\\t\\tif (subscription.alert || subscription.unread > 0) {\\n\\t\\t\\t\\t\\t\\t// Increment the total unread count.\\n\\t\\t\\t\\t\\t\\tif (subscription.alert === true && subscription.unreadAlert !== 'nothing') {\\n\\t\\t\\t\\t\\t\\t\\tif (subscription.unreadAlert === 'all' || userUnreadAlert !== false) {\\n\\t\\t\\t\\t\\t\\t\\t\\tunreadAlert = '•';\\n\\t\\t\\t\\t\\t\\t\\t}\\n\\t\\t\\t\\t\\t\\t}\\n\\t\\t\\t\\t\\t\\treturn ret + subscription.unread;\\n\\t\\t\\t\\t\\t}\\n\\t\\t\\t\\t\\treturn ret;\\n\\t\\t\\t\\t}),\\n\\t\\t\\t0,\\n\\t\\t);\\n\\n\\t\\tif (unreadCount > 0) {\\n\\t\\t\\tif (unreadCount > 999) {\\n\\t\\t\\t\\tSession.set('unread', '999+');\\n\\t\\t\\t} else {\\n\\t\\t\\t\\tSession.set('unread', unreadCount);\\n\\t\\t\\t}\\n\\t\\t} else if (unreadAlert !== false) {\\n\\t\\t\\tSession.set('unread', unreadAlert);\\n\\t\\t} else {\\n\\t\\t\\tSession.set('unread', '');\\n\\t\\t}\\n\\t});\\n});\\n\\nMeteor.startup(() => {\\n\\tconst updateFavicon = manageFavicon();\\n\\n\\tTracker.autorun(() => {\\n\\t\\tconst unread = Session.get('unread');\\n\\t\\tfireGlobalEvent('unread-changed', unread);\\n\\n\\t\\tupdateFavicon(unread);\\n\\t});\\n});\\n\",null],\"names\":[\"_objectSpread\",\"manageFavicon\",\"Meteor\",\"Session\",\"Tracker\",\"ChatSubscription\",\"ChatRoom\",\"getUserPreference\",\"fireGlobalEvent\",\"module\",\"link\",\"default\",\"v\",\"fetchSubscriptions\",\"find\",\"open\",\"hideUnreadStatus\",\"$ne\",\"archived\",\"fields\",\"unread\",\"alert\",\"rid\",\"t\",\"name\",\"ls\",\"unreadAlert\",\"fname\",\"prid\",\"fetch\",\"startup\",\"autorun\",\"userUnreadAlert\",\"userId\",\"unreadCount\",\"reduce\",\"ret\",\"subscription\",\"nonreactive\",\"room\",\"findOne\",\"_id\",\"usersCount\",\"set\",\"updateFavicon\",\"get\"],\"mappings\":\"2BACAA,EAAAC,EAAqDC,EAAAC,EAAAC,EAAAC,EAAAC,EAAAC,EAAAC,EAA5CC,EAAeC,IAAA,CAAM,uCAAuB,CAAAC,QAAAC,CAAA,EAAAZ,EAAAY,CAAA,CAAA,EAAA,GAA5CH,EAAeC,IAAA,CAAM,uBAAuB,CAAAT,cAAAW,CAAA,EAAAX,EAAAW,CAAA,CAAA,EAAA,GAAAH,EAAAC,IAAA,CAAA,gBAAA,CAAAR,OAAAU,CAAA,EAAAV,EAAAU,CAAA,CAAA,EAAA,GAAAH,EAAAC,IAAA,CAAA,iBAAA,CAAAP,QAAAS,CAAA,EAAAT,EAAAS,CAAA,CAAA,EAAA,GAAAH,EAAAC,IAAA,CAAA,iBAAA,CAAAN,QAAAQ,CAAA,EAAAR,EAAAQ,CAAA,CAAA,EAAA,GAAAH,EAAAC,IAAA,CAAA,0BAAA,CAAAL,iBAAAO,CAAA,EAAAP,EAAAO,CAAA,EAAAN,SAAAM,CAAA,EAAAN,EAAAM,CAAA,CAAA,EAAA,GAAAH,EAAAC,IAAA,CAAA,yBAAA,CAAAH,kBAAAK,CAAA,EAAAL,EAAAK,CAAA,CAAA,EAAA,GAAAH,EAAAC,IAAA,CAAA,+BAAA,CAAAF,gBAAAI,CAAA,EAAAJ,EAAAI,CAAA,CAAA,EAAA,GASrD,IAAMC,EAAqBA,IAC1BR,EAAiBS,IAAI,CACpB,CACCC,KAAM,CAAA,EACNC,iBAAkB,CAAEC,IAAK,CAAA,CAAI,EAC7BC,SAAU,CAAED,IAAK,CAAA,CAAI,GAEtB,CACCE,OAAQ,CACPC,OAAQ,EACRC,MAAO,EACPC,IAAK,EACLC,EAAG,EACHC,KAAM,EACNC,GAAI,EACJC,YAAa,EACbC,MAAO,EACPC,KAAM,KAGPC,KAAK,GAER3B,EAAO4B,OAAO,CAAC,KACd1B,EAAQ2B,OAAO,CAAC,KACf,IAAMC,EAAkBzB,EAAkBL,EAAO+B,MAAM,GAAI,eAEvDP,EAA2B,CAAA,EAEzBQ,EAAcrB,IAAqBsB,MAAM,CAC9C,CAACC,EAAKC,IACLjC,EAAQkC,WAAW,CAAC,KACnB,IAAMC,EAAOjC,EAASkC,OAAO,CAAC,CAAEC,IAAKJ,EAAaf,GAAAA,AAAG,EAAI,CAAEH,OAAQ,CAAEuB,WAAY,CAAC,CAAE,SAMpF,CALAlC,EAAgB,iCAAgCR,EAAAA,EAAA,CAAA,EAC5CqC,GAAY,CAAA,EAAA,CACfK,WAAYH,MAAAA,EAAI,KAAA,EAAJA,EAAMG,UAAAA,AAAU,IAGzBL,EAAahB,KAAK,EAAIgB,EAAajB,MAAM,CAAG,IAEpB,CAAA,IAAvBiB,EAAahB,KAAK,EAAagB,AAA6B,YAA7BA,EAAaX,WAAW,EACtDW,CAAAA,AAA6B,QAA7BA,EAAaX,WAAW,EAAcM,AAAoB,CAAA,IAApBA,CAAoB,GAC7DN,CAAAA,EAAc,GAAA,EAGTU,EAAMC,EAAajB,MAAM,EAE1BgB,CACR,GACD,EAGGF,CAAAA,EAAc,EACbA,EAAc,IACjB/B,EAAQwC,GAAG,CAAC,SAAU,QAEtBxC,EAAQwC,GAAG,CAAC,SAAUT,GAEbR,AAAgB,CAAA,IAAhBA,EACVvB,EAAQwC,GAAG,CAAC,SAAUjB,GAEtBvB,EAAQwC,GAAG,CAAC,SAAU,GAExB,EACD,GAEAzC,EAAO4B,OAAO,CAAC,KACd,IAAMc,EAAgB3C,IAEtBG,EAAQ2B,OAAO,CAAC,KACf,IAAMX,EAASjB,EAAQ0C,GAAG,CAAC,UAC3BrC,EAAgB,iBAAkBY,GAElCwB,EAAcxB,EACf,EACD\"}"}