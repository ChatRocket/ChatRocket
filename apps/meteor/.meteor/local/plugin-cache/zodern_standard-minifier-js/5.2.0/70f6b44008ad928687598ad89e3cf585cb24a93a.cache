{"code":"function module(e,n,r){var t,i,a,s,o,u,c,l;r.link(\"@babel/runtime/regenerator\",{default:function(e){t=e}},0),r.link(\"@babel/runtime/helpers/typeof\",{default:function(e){i=e}},1),r.link(\"meteor/meteor\",{Meteor:function(e){a=e}},0),r.link(\"../../../../client/lib/rooms/roomCoordinator\",{roomCoordinator:function(e){s=e}},1),r.link(\"../../../emoji/client\",{emoji:function(e){o=e}},2),r.link(\"../../../models/client\",{Messages:function(e){u=e},ChatRoom:function(e){c=e},Subscriptions:function(e){l=e}},3),a.methods({setReaction:function(e,n){var r,d,f,m;return t.async(function(t){for(;;)switch(t.prev=t.next){case 0:if(a.userId()){t.next=2;break}throw new a.Error(203,\"User_logged_out\");case 2:if(null!=(d=a.user())&&d.username){t.next=5;break}return t.abrupt(\"return\",!1);case 5:if(f=u.findOne({_id:n})){t.next=8;break}return t.abrupt(\"return\",!1);case 8:if(m=c.findOne({_id:f.rid})){t.next=11;break}return t.abrupt(\"return\",!1);case 11:if(!f.private){t.next=13;break}return t.abrupt(\"return\",!1);case 13:if(o.list[e]){t.next=15;break}return t.abrupt(\"return\",!1);case 15:if(!s.readOnly(m._id,d)){t.next=17;break}return t.abrupt(\"return\",!1);case 17:if(l.findOne({rid:f.rid})){t.next=19;break}return t.abrupt(\"return\",!1);case 19:null!==(r=f.reactions)&&void 0!==r&&r[e]&&-1!==f.reactions[e].usernames.indexOf(d.username)?(f.reactions[e].usernames.splice(f.reactions[e].usernames.indexOf(d.username),1),0===f.reactions[e].usernames.length&&delete f.reactions[e],f.reactions&&\"object\"===i(f.reactions)&&0!==Object.keys(f.reactions).length?u.update({_id:n},{$set:{reactions:f.reactions}}):(delete f.reactions,u.update({_id:n},{$unset:{reactions:1}}))):(f.reactions||(f.reactions={}),f.reactions[e]||(f.reactions[e]={usernames:[]}),f.reactions[e].usernames.push(d.username),u.update({_id:n},{$set:{reactions:f.reactions}}));case 20:case\"end\":return t.stop()}},null,null,null,Promise)}})}","map":"{\"version\":3,\"sources\":[\"app/reactions/client/methods/setReaction.ts\",\"<anon>\"],\"sourcesContent\":[\"import type { IMessage, IRoom } from '@rocket.chat/core-typings';\\nimport type { ServerMethods } from '@rocket.chat/ddp-client';\\nimport { Meteor } from 'meteor/meteor';\\n\\nimport { roomCoordinator } from '../../../../client/lib/rooms/roomCoordinator';\\nimport { emoji } from '../../../emoji/client';\\nimport { Messages, ChatRoom, Subscriptions } from '../../../models/client';\\n\\nMeteor.methods<ServerMethods>({\\n\\tasync setReaction(reaction, messageId) {\\n\\t\\tif (!Meteor.userId()) {\\n\\t\\t\\tthrow new Meteor.Error(203, 'User_logged_out');\\n\\t\\t}\\n\\n\\t\\tconst user = Meteor.user();\\n\\n\\t\\tif (!user?.username) {\\n\\t\\t\\treturn false;\\n\\t\\t}\\n\\n\\t\\tconst message: IMessage | undefined = Messages.findOne({ _id: messageId });\\n\\t\\tif (!message) {\\n\\t\\t\\treturn false;\\n\\t\\t}\\n\\n\\t\\tconst room: IRoom | undefined = ChatRoom.findOne({ _id: message.rid });\\n\\t\\tif (!room) {\\n\\t\\t\\treturn false;\\n\\t\\t}\\n\\n\\t\\tif (message.private) {\\n\\t\\t\\treturn false;\\n\\t\\t}\\n\\n\\t\\tif (!emoji.list[reaction]) {\\n\\t\\t\\treturn false;\\n\\t\\t}\\n\\n\\t\\tif (roomCoordinator.readOnly(room._id, user)) {\\n\\t\\t\\treturn false;\\n\\t\\t}\\n\\n\\t\\tif (!Subscriptions.findOne({ rid: message.rid })) {\\n\\t\\t\\treturn false;\\n\\t\\t}\\n\\n\\t\\tif (message.reactions?.[reaction] && message.reactions[reaction].usernames.indexOf(user.username) !== -1) {\\n\\t\\t\\tmessage.reactions[reaction].usernames.splice(message.reactions[reaction].usernames.indexOf(user.username), 1);\\n\\n\\t\\t\\tif (message.reactions[reaction].usernames.length === 0) {\\n\\t\\t\\t\\tdelete message.reactions[reaction];\\n\\t\\t\\t}\\n\\n\\t\\t\\tif (!message.reactions || typeof message.reactions !== 'object' || Object.keys(message.reactions).length === 0) {\\n\\t\\t\\t\\tdelete message.reactions;\\n\\t\\t\\t\\tMessages.update({ _id: messageId }, { $unset: { reactions: 1 } });\\n\\t\\t\\t} else {\\n\\t\\t\\t\\tMessages.update({ _id: messageId }, { $set: { reactions: message.reactions } });\\n\\t\\t\\t}\\n\\t\\t} else {\\n\\t\\t\\tif (!message.reactions) {\\n\\t\\t\\t\\tmessage.reactions = {};\\n\\t\\t\\t}\\n\\t\\t\\tif (!message.reactions[reaction]) {\\n\\t\\t\\t\\tmessage.reactions[reaction] = {\\n\\t\\t\\t\\t\\tusernames: [],\\n\\t\\t\\t\\t};\\n\\t\\t\\t}\\n\\t\\t\\tmessage.reactions[reaction].usernames.push(user.username);\\n\\n\\t\\t\\tMessages.update({ _id: messageId }, { $set: { reactions: message.reactions } });\\n\\t\\t}\\n\\t},\\n});\\n\",null],\"names\":[\"_regeneratorRuntime\",\"_typeof\",\"Meteor\",\"roomCoordinator\",\"emoji\",\"Messages\",\"ChatRoom\",\"Subscriptions\",\"module\",\"link\",\"default\",\"v\",\"methods\",\"setReaction\",\"reaction\",\"messageId\",\"_message$reactions\",\"user\",\"message\",\"room\",\"async\",\"_context\",\"prev\",\"next\",\"userId\",\"Error\",\"username\",\"abrupt\",\"findOne\",\"_id\",\"rid\",\"private\",\"list\",\"readOnly\",\"reactions\",\"usernames\",\"indexOf\",\"splice\",\"length\",\"Object\",\"keys\",\"update\",\"$set\",\"$unset\",\"push\",\"stop\",\"Promise\"],\"mappings\":\"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\"}"}