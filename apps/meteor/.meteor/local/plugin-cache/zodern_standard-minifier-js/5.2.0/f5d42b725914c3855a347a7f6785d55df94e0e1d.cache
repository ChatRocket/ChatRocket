{"code":"function module(e,t,n){n.link(\"@babel/runtime/regenerator\",{default:function(e){i=e}},0),n.link(\"@babel/runtime/helpers/slicedToArray\",{default:function(e){r=e}},1),n.link(\"@babel/runtime/helpers/toConsumableArray\",{default:function(e){o=e}},2),n.export({USER_ACTIVITIES:function(){return f},UserAction:function(){return T}}),n.link(\"lodash\",{debounce:function(e){u=e}},0),n.link(\"meteor/meteor\",{Meteor:function(e){l=e}},1),n.link(\"meteor/reactive-dict\",{ReactiveDict:function(e){a=e}},2),n.link(\"../../../settings/client\",{settings:function(e){s=e}},3),n.link(\"../../../utils/client/lib/SDKClient\",{sdk:function(e){c=e}},4);var i,r,o,u,l,a,s,c,d=\"user-activity\",f={USER_RECORDING:\"user-recording\",USER_TYPING:\"user-typing\",USER_UPLOADING:\"user-uploading\",USER_PLAYING:\"user-playing\"},m=new Map,g=new Map,v=new Map,p=new Map,h=new Map,w=new a,b=function(e){return e?s.get(\"UI_Use_Real_Name\")?e.name:e.username:void 0},S=u(function(e,t){var n;return i.async(function(i){for(;;)switch(i.prev=i.next){case 0:n=p.get((null==t?void 0:t.tmid)||e)||new Set,c.publish(\"notify-room\",[e+\"/\"+d,b(l.user()),o(n),t]);case 2:case\"end\":return i.stop()}},null,null,null,Promise)},500),T=new(function(){function e(){}var t=e.prototype;return t.addStream=function(e){if(h.get(e))throw Error(\"UserAction - addStream should only be called once per room\");var t=function(t,n,i){t!==b(l.users.findOne(l.userId()||void 0,{fields:{name:1,username:1}}))&&function e(t,n,i,o){t=(null==o?void 0:o.tmid)||t;for(var u=w.get(t)||{},l=0,a=Object.entries(f);l<a.length;l++){var s=a[l],c=r(s,2)[1];u[c]=u[c]||new Map;var d=u[c],m=d[n];m&&clearTimeout(m),i.includes(c)?(i.splice(i.indexOf(c),1),d[n]=setTimeout(function(){return e(t,n,i,o)},15e3)):delete d[n]}w.set(t,u)}(e,t,n,i)};h.set(e,t);var n=c.stream(\"notify-room\",[e+\"/\"+d],t).stop;return function(){h.get(e)&&(n(),h.delete(e))}},t.performContinuously=function(e,t){var n=this,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},r=t+\"-\"+((null==i?void 0:i.tmid)||e);v.get(r)||(this.start(e,t,i),v.set(r,setInterval(function(){n.start(e,t,i)},5e3)))},t.start=function(e,t){var n=this,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},r=(null==i?void 0:i.tmid)||e,o=t+\"-\"+r;if(!g.get(o)){g.set(o,setTimeout(function(){clearTimeout(g.get(o)),g.delete(o)},5e3));var u=p.get(r)||new Set;u.add(t),p.set(r,u),S(e,i),m.get(o)&&(clearTimeout(m.get(o)),m.delete(o)),m.set(o,setTimeout(function(){return n.stop(r,t,i)},15e3)),m.get(o)}},t.stop=function(e,t,n){var i=(null==n?void 0:n.tmid)||e,r=t+\"-\"+i;m.get(r)&&(clearTimeout(m.get(r)),m.delete(r)),g.get(r)&&(clearTimeout(g.get(r)),g.delete(r)),v.get(r)&&(clearInterval(v.get(r)),v.delete(r));var o=p.get(i)||new Set;o.delete(t),p.set(i,o),S(e,n)},t.get=function(e){return w.get(e)},e}())}","map":"{\"version\":3,\"sources\":[\"app/ui/client/lib/UserAction.ts\",\"<anon>\"],\"sourcesContent\":[\"import type { IExtras, IRoomActivity, IActionsObject, IUser } from '@rocket.chat/core-typings';\\nimport { debounce } from 'lodash';\\nimport { Meteor } from 'meteor/meteor';\\nimport { ReactiveDict } from 'meteor/reactive-dict';\\n\\nimport { settings } from '../../../settings/client';\\nimport { sdk } from '../../../utils/client/lib/SDKClient';\\n\\nconst TIMEOUT = 15000;\\nconst RENEW = TIMEOUT / 3;\\n\\nconst USER_ACTIVITY = 'user-activity';\\n\\nexport const USER_ACTIVITIES = {\\n\\tUSER_RECORDING: 'user-recording',\\n\\tUSER_TYPING: 'user-typing',\\n\\tUSER_UPLOADING: 'user-uploading',\\n\\tUSER_PLAYING: 'user-playing',\\n};\\n\\nconst activityTimeouts = new Map();\\nconst activityRenews = new Map();\\nconst continuingIntervals = new Map();\\nconst roomActivities = new Map<string, Set<string>>();\\nconst rooms = new Map<string, (username: string, activityType: string[], extras?: object | undefined) => void>();\\n\\nconst performingUsers = new ReactiveDict<IActionsObject>();\\n\\nconst shownName = function (user: IUser | null | undefined): string | undefined {\\n\\tif (!user) {\\n\\t\\treturn;\\n\\t}\\n\\tif (settings.get('UI_Use_Real_Name')) {\\n\\t\\treturn user.name;\\n\\t}\\n\\treturn user.username;\\n};\\n\\nconst emitActivities = debounce(async (rid: string, extras: IExtras): Promise<void> => {\\n\\tconst activities = roomActivities.get(extras?.tmid || rid) || new Set();\\n\\tsdk.publish('notify-room', [`${rid}/${USER_ACTIVITY}`, shownName(Meteor.user() as unknown as IUser), [...activities], extras]);\\n}, 500);\\n\\nfunction handleStreamAction(rid: string, username: string, activityTypes: string[], extras?: IExtras): void {\\n\\trid = extras?.tmid || rid;\\n\\tconst roomActivities = performingUsers.get(rid) || {};\\n\\n\\tfor (const [, activity] of Object.entries(USER_ACTIVITIES)) {\\n\\t\\troomActivities[activity] = roomActivities[activity] || new Map();\\n\\t\\tconst users = roomActivities[activity];\\n\\t\\tconst timeout = users[username];\\n\\n\\t\\tif (timeout) {\\n\\t\\t\\tclearTimeout(timeout);\\n\\t\\t}\\n\\n\\t\\tif (activityTypes.includes(activity)) {\\n\\t\\t\\tactivityTypes.splice(activityTypes.indexOf(activity), 1);\\n\\t\\t\\tusers[username] = setTimeout(() => handleStreamAction(rid, username, activityTypes, extras), TIMEOUT);\\n\\t\\t} else {\\n\\t\\t\\tdelete users[username];\\n\\t\\t}\\n\\t}\\n\\n\\tperformingUsers.set(rid, roomActivities);\\n}\\nexport const UserAction = new (class {\\n\\taddStream(rid: string): () => void {\\n\\t\\tif (rooms.get(rid)) {\\n\\t\\t\\tthrow new Error('UserAction - addStream should only be called once per room');\\n\\t\\t}\\n\\n\\t\\tconst handler = function (username: string, activityType: string[], extras?: object): void {\\n\\t\\t\\tconst user = Meteor.users.findOne(Meteor.userId() || undefined, {\\n\\t\\t\\t\\tfields: { name: 1, username: 1 },\\n\\t\\t\\t}) as IUser;\\n\\t\\t\\tif (username === shownName(user)) {\\n\\t\\t\\t\\treturn;\\n\\t\\t\\t}\\n\\t\\t\\thandleStreamAction(rid, username, activityType, extras);\\n\\t\\t};\\n\\t\\trooms.set(rid, handler);\\n\\n\\t\\tconst { stop } = sdk.stream('notify-room', [`${rid}/${USER_ACTIVITY}`], handler);\\n\\t\\treturn () => {\\n\\t\\t\\tif (!rooms.get(rid)) {\\n\\t\\t\\t\\treturn;\\n\\t\\t\\t}\\n\\t\\t\\tstop();\\n\\t\\t\\trooms.delete(rid);\\n\\t\\t};\\n\\t}\\n\\n\\tperformContinuously(rid: string, activityType: string, extras: IExtras = {}): void {\\n\\t\\tconst trid = extras?.tmid || rid;\\n\\t\\tconst key = `${activityType}-${trid}`;\\n\\n\\t\\tif (continuingIntervals.get(key)) {\\n\\t\\t\\treturn;\\n\\t\\t}\\n\\t\\tthis.start(rid, activityType, extras);\\n\\n\\t\\tcontinuingIntervals.set(\\n\\t\\t\\tkey,\\n\\t\\t\\tsetInterval(() => {\\n\\t\\t\\t\\tthis.start(rid, activityType, extras);\\n\\t\\t\\t}, RENEW),\\n\\t\\t);\\n\\t}\\n\\n\\tstart(rid: string, activityType: string, extras: IExtras = {}): void {\\n\\t\\tconst trid = extras?.tmid || rid;\\n\\t\\tconst key = `${activityType}-${trid}`;\\n\\n\\t\\tif (activityRenews.get(key)) {\\n\\t\\t\\treturn;\\n\\t\\t}\\n\\n\\t\\tactivityRenews.set(\\n\\t\\t\\tkey,\\n\\t\\t\\tsetTimeout(() => {\\n\\t\\t\\t\\tclearTimeout(activityRenews.get(key));\\n\\t\\t\\t\\tactivityRenews.delete(key);\\n\\t\\t\\t}, RENEW),\\n\\t\\t);\\n\\n\\t\\tconst activities = roomActivities.get(trid) || new Set();\\n\\t\\tactivities.add(activityType);\\n\\t\\troomActivities.set(trid, activities);\\n\\n\\t\\tvoid emitActivities(rid, extras);\\n\\n\\t\\tif (activityTimeouts.get(key)) {\\n\\t\\t\\tclearTimeout(activityTimeouts.get(key));\\n\\t\\t\\tactivityTimeouts.delete(key);\\n\\t\\t}\\n\\n\\t\\tactivityTimeouts.set(\\n\\t\\t\\tkey,\\n\\t\\t\\tsetTimeout(() => this.stop(trid, activityType, extras), TIMEOUT),\\n\\t\\t);\\n\\t\\tactivityTimeouts.get(key);\\n\\t}\\n\\n\\tstop(rid: string, activityType: string, extras: IExtras): void {\\n\\t\\tconst trid = extras?.tmid || rid;\\n\\t\\tconst key = `${activityType}-${trid}`;\\n\\n\\t\\tif (activityTimeouts.get(key)) {\\n\\t\\t\\tclearTimeout(activityTimeouts.get(key));\\n\\t\\t\\tactivityTimeouts.delete(key);\\n\\t\\t}\\n\\t\\tif (activityRenews.get(key)) {\\n\\t\\t\\tclearTimeout(activityRenews.get(key));\\n\\t\\t\\tactivityRenews.delete(key);\\n\\t\\t}\\n\\t\\tif (continuingIntervals.get(key)) {\\n\\t\\t\\tclearInterval(continuingIntervals.get(key));\\n\\t\\t\\tcontinuingIntervals.delete(key);\\n\\t\\t}\\n\\n\\t\\tconst activities = roomActivities.get(trid) || new Set();\\n\\t\\tactivities.delete(activityType);\\n\\t\\troomActivities.set(trid, activities);\\n\\t\\tvoid emitActivities(rid, extras);\\n\\t}\\n\\n\\tget(roomId: string): IRoomActivity | undefined {\\n\\t\\treturn performingUsers.get(roomId);\\n\\t}\\n})();\\n\",null],\"names\":[\"module\",\"link\",\"default\",\"v\",\"_regeneratorRuntime\",\"_slicedToArray\",\"_toConsumableArray\",\"export\",\"USER_ACTIVITIES\",\"UserAction\",\"debounce\",\"Meteor\",\"ReactiveDict\",\"settings\",\"sdk\",\"USER_ACTIVITY\",\"USER_RECORDING\",\"USER_TYPING\",\"USER_UPLOADING\",\"USER_PLAYING\",\"activityTimeouts\",\"Map\",\"activityRenews\",\"continuingIntervals\",\"roomActivities\",\"rooms\",\"performingUsers\",\"shownName\",\"user\",\"get\",\"name\",\"username\",\"emitActivities\",\"rid\",\"extras\",\"activities\",\"async\",\"_context\",\"prev\",\"next\",\"tmid\",\"Set\",\"publish\",\"stop\",\"Promise\",\"_class\",\"_proto\",\"prototype\",\"addStream\",\"Error\",\"handler\",\"activityType\",\"users\",\"findOne\",\"userId\",\"undefined\",\"fields\",\"handleStreamAction\",\"activityTypes\",\"_i\",\"_Object$entries\",\"Object\",\"entries\",\"length\",\"_ref\",\"activity\",\"_ref2\",\"timeout\",\"clearTimeout\",\"includes\",\"splice\",\"indexOf\",\"setTimeout\",\"set\",\"_sdk$stream\",\"stream\",\"delete\",\"performContinuously\",\"_this\",\"arguments\",\"key\",\"start\",\"setInterval\",\"TIMEOUT\",\"_this2\",\"trid\",\"add\",\"clearInterval\",\"roomId\"],\"mappings\":\"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\"}"}