{"code":"function module(e,t,a){let i,s,n,o,r,d,l,c,g,u;a.link(\"@babel/runtime/helpers/objectSpread2\",{default(e){i=e}},0),a.export({sendMessage:()=>p}),a.link(\"../../../../app/ui/client/lib/KonchatNotification\",{KonchatNotification(e){s=e}},0),a.link(\"../../../../app/utils/client/lib/SDKClient\",{sdk(e){n=e}},1),a.link(\"../../../../app/utils/lib/i18n\",{t(e){o=e}},2),a.link(\"../../onClientBeforeSendMessage\",{onClientBeforeSendMessage(e){r=e}},3),a.link(\"../../toast\",{dispatchToastMessage(e){d=e}},4),a.link(\"./processMessageEditing\",{processMessageEditing(e){l=e}},5),a.link(\"./processSetReaction\",{processSetReaction(e){c=e}},6),a.link(\"./processSlashCommand\",{processSlashCommand(e){g=e}},7),a.link(\"./processTooLongMessage\",{processTooLongMessage(e){u=e}},8);let m=async(e,t,a,i)=>{s.removeRoomNotification(t.rid),!(await c(e,t)||await u(e,t)||i&&await g(e,t))&&(t=await r(t),delete t.e2e,await l(e,t,a)||await n.call(\"sendMessage\",t,a))},p=async(e,t)=>{var a,s,n,r;let{text:l,tshow:c,previewUrls:g,isSlashCommandAllowed:u}=t;if(!await e.data.isSubscribedToRoom())try{await e.data.joinRoom()}catch(e){return d({type:\"error\",message:e}),!1}if(e.readStateManager.clearUnreadMark(),!(l=l.trim())&&!e.currentEditing)return!1;if(l){let t=await e.data.composeMessage(l,{sendToChannel:c,quotedMessages:null!==(a=null===(s=e.composer)||void 0===s?void 0:s.quotedMessages.get())&&void 0!==a?a:[],originalMessage:e.currentEditing?await e.data.findMessageByID(e.currentEditing.mid):null});if(e.currentEditing){let a=await e.data.findMessageByID(e.currentEditing.mid);(null==a?void 0:a.t)===\"e2e\"&&a.attachments&&a.attachments.length>0&&void 0!==a.attachments[0].description&&(a.attachments[0].description=t.msg,t.attachments=a.attachments,t.msg=a.msg)}try{await m(e,t,g,u),null===(n=e.composer)||void 0===n||n.dismissAllQuotedMessages()}catch(e){d({type:\"error\",message:e})}return!0}if(e.currentEditing){let t=await e.data.findMessageByID(e.currentEditing.mid);if(!t)return d({type:\"warning\",message:o(\"Message_not_found\")}),!1;try{if(await e.flows.processMessageEditing(i(i({},t),{},{msg:\"\"}),g))return e.currentEditing.stop(),!1;await (null===(r=e.currentEditing)||void 0===r?void 0:r.reset()),await e.flows.requestMessageDeletion(t)}catch(e){d({type:\"error\",message:e})}}return!1}}","map":"{\"version\":3,\"sources\":[\"client/lib/chats/flows/sendMessage.ts\",\"<anon>\"],\"sourcesContent\":[\"import type { IMessage } from '@rocket.chat/core-typings';\\n\\nimport { KonchatNotification } from '../../../../app/ui/client/lib/KonchatNotification';\\nimport { sdk } from '../../../../app/utils/client/lib/SDKClient';\\nimport { t } from '../../../../app/utils/lib/i18n';\\nimport { onClientBeforeSendMessage } from '../../onClientBeforeSendMessage';\\nimport { dispatchToastMessage } from '../../toast';\\nimport type { ChatAPI } from '../ChatAPI';\\nimport { processMessageEditing } from './processMessageEditing';\\nimport { processSetReaction } from './processSetReaction';\\nimport { processSlashCommand } from './processSlashCommand';\\nimport { processTooLongMessage } from './processTooLongMessage';\\n\\nconst process = async (chat: ChatAPI, message: IMessage, previewUrls?: string[], isSlashCommandAllowed?: boolean): Promise<void> => {\\n\\tKonchatNotification.removeRoomNotification(message.rid);\\n\\n\\tif (await processSetReaction(chat, message)) {\\n\\t\\treturn;\\n\\t}\\n\\n\\tif (await processTooLongMessage(chat, message)) {\\n\\t\\treturn;\\n\\t}\\n\\n\\tif (isSlashCommandAllowed && (await processSlashCommand(chat, message))) {\\n\\t\\treturn;\\n\\t}\\n\\n\\tmessage = (await onClientBeforeSendMessage(message)) as IMessage;\\n\\n\\t// e2e should be a client property only\\n\\tdelete message.e2e;\\n\\n\\tif (await processMessageEditing(chat, message, previewUrls)) {\\n\\t\\treturn;\\n\\t}\\n\\n\\tawait sdk.call('sendMessage', message, previewUrls);\\n};\\n\\nexport const sendMessage = async (\\n\\tchat: ChatAPI,\\n\\t{\\n\\t\\ttext,\\n\\t\\ttshow,\\n\\t\\tpreviewUrls,\\n\\t\\tisSlashCommandAllowed,\\n\\t}: { text: string; tshow?: boolean; previewUrls?: string[]; isSlashCommandAllowed?: boolean },\\n): Promise<boolean> => {\\n\\tif (!(await chat.data.isSubscribedToRoom())) {\\n\\t\\ttry {\\n\\t\\t\\tawait chat.data.joinRoom();\\n\\t\\t} catch (error) {\\n\\t\\t\\tdispatchToastMessage({ type: 'error', message: error });\\n\\t\\t\\treturn false;\\n\\t\\t}\\n\\t}\\n\\n\\tchat.readStateManager.clearUnreadMark();\\n\\n\\ttext = text.trim();\\n\\n\\tif (!text && !chat.currentEditing) {\\n\\t\\t// Nothing to do\\n\\t\\treturn false;\\n\\t}\\n\\n\\tif (text) {\\n\\t\\tconst message = await chat.data.composeMessage(text, {\\n\\t\\t\\tsendToChannel: tshow,\\n\\t\\t\\tquotedMessages: chat.composer?.quotedMessages.get() ?? [],\\n\\t\\t\\toriginalMessage: chat.currentEditing ? await chat.data.findMessageByID(chat.currentEditing.mid) : null,\\n\\t\\t});\\n\\n\\t\\tif (chat.currentEditing) {\\n\\t\\t\\tconst originalMessage = await chat.data.findMessageByID(chat.currentEditing.mid);\\n\\n\\t\\t\\tif (\\n\\t\\t\\t\\toriginalMessage?.t === 'e2e' &&\\n\\t\\t\\t\\toriginalMessage.attachments &&\\n\\t\\t\\t\\toriginalMessage.attachments.length > 0 &&\\n\\t\\t\\t\\toriginalMessage.attachments[0].description !== undefined\\n\\t\\t\\t) {\\n\\t\\t\\t\\toriginalMessage.attachments[0].description = message.msg;\\n\\t\\t\\t\\tmessage.attachments = originalMessage.attachments;\\n\\t\\t\\t\\tmessage.msg = originalMessage.msg;\\n\\t\\t\\t}\\n\\t\\t}\\n\\n\\t\\ttry {\\n\\t\\t\\tawait process(chat, message, previewUrls, isSlashCommandAllowed);\\n\\t\\t\\tchat.composer?.dismissAllQuotedMessages();\\n\\t\\t} catch (error) {\\n\\t\\t\\tdispatchToastMessage({ type: 'error', message: error });\\n\\t\\t}\\n\\t\\treturn true;\\n\\t}\\n\\n\\tif (chat.currentEditing) {\\n\\t\\tconst originalMessage = await chat.data.findMessageByID(chat.currentEditing.mid);\\n\\n\\t\\tif (!originalMessage) {\\n\\t\\t\\tdispatchToastMessage({ type: 'warning', message: t('Message_not_found') });\\n\\t\\t\\treturn false;\\n\\t\\t}\\n\\n\\t\\ttry {\\n\\t\\t\\tif (await chat.flows.processMessageEditing({ ...originalMessage, msg: '' }, previewUrls)) {\\n\\t\\t\\t\\tchat.currentEditing.stop();\\n\\t\\t\\t\\treturn false;\\n\\t\\t\\t}\\n\\n\\t\\t\\tawait chat.currentEditing?.reset();\\n\\t\\t\\tawait chat.flows.requestMessageDeletion(originalMessage);\\n\\t\\t\\treturn false;\\n\\t\\t} catch (error) {\\n\\t\\t\\tdispatchToastMessage({ type: 'error', message: error });\\n\\t\\t}\\n\\t}\\n\\n\\treturn false;\\n};\\n\",null],\"names\":[\"_objectSpread\",\"KonchatNotification\",\"sdk\",\"t\",\"onClientBeforeSendMessage\",\"dispatchToastMessage\",\"processMessageEditing\",\"processSetReaction\",\"processSlashCommand\",\"processTooLongMessage\",\"module\",\"link\",\"default\",\"v\",\"export\",\"sendMessage\",\"process\",\"chat\",\"message\",\"previewUrls\",\"isSlashCommandAllowed\",\"removeRoomNotification\",\"rid\",\"e2e\",\"call\",\"_ref\",\"_chat$composer$quoted\",\"_chat$composer\",\"_chat$composer2\",\"_chat$currentEditing\",\"text\",\"tshow\",\"data\",\"isSubscribedToRoom\",\"joinRoom\",\"error\",\"type\",\"readStateManager\",\"clearUnreadMark\",\"trim\",\"currentEditing\",\"composeMessage\",\"sendToChannel\",\"quotedMessages\",\"composer\",\"get\",\"originalMessage\",\"findMessageByID\",\"mid\",\"attachments\",\"length\",\"undefined\",\"description\",\"msg\",\"dismissAllQuotedMessages\",\"flows\",\"stop\",\"reset\",\"requestMessageDeletion\"],\"mappings\":\"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\"}"}