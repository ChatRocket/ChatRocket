{"code":"function module(n,e,t){t.link(\"@babel/runtime/regenerator\",{default:function(n){r=n}},0),t.link(\"@babel/runtime/helpers/slicedToArray\",{default:function(n){a=n}},1),t.export({useInstallApp:function(){return A}}),t.link(\"@rocket.chat/ui-contexts\",{useRouter:function(n){u=n},useSetModal:function(n){s=n},useUpload:function(n){i=n}},0),t.link(\"@tanstack/react-query\",{useMutation:function(n){c=n}},1),t.link(\"react\",{default:function(n){o=n},useCallback:function(n){p=n},useState:function(n){l=n}},2),t.link(\"../../../apps/orchestrator\",{AppClientOrchestratorInstance:function(n){f=n}},3),t.link(\"../../../contexts/hooks/useAppsReload\",{useAppsReload:function(n){d=n}},4),t.link(\"../AppPermissionsReviewModal\",{default:function(n){m=n}},5),t.link(\"../AppUpdateModal\",{default:function(n){k=n}},6),t.link(\"../helpers/handleAPIError\",{handleAPIError:function(n){v=n}},7),t.link(\"../helpers/handleInstallError\",{handleInstallError:function(n){b=n}},8),t.link(\"../lib/getManifestFromZippedApp\",{getManifestFromZippedApp:function(n){h=n}},9),t.link(\"./useAppsCountQuery\",{useAppsCountQuery:function(n){x=n}},10);var r,a,u,s,i,c,o,p,l,f,d,m,k,v,b,h,x,A=function(n){var e=d(),t=s(),A=u(),w=x(\"private\"),y=i(\"/apps\"),P=i(\"/apps/update\"),I=l(!1),g=a(I,2),E=g[0],C=g[1],M=c([\"apps/installPrivateApp\"],function(n){var e=n.permissionsGranted,t=n.appFile,r=n.appId,a=new FormData;return(a.append(\"app\",t,t.name),a.append(\"permissions\",JSON.stringify(e)),r)?P(a):y(a)},{onSuccess:function(n){A.navigate({name:\"marketplace\",params:{context:\"private\",page:\"info\",id:n.app.id}})},onError:function(n){v(n)},onSettled:function(){C(!1),t(null),e()}}).mutate,F=p(function(){C(!1),t(null)},[C,t]),S=function(n){var e;return r.async(function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,t.next=3,r.awrap(f.getApp(n));case 3:return e=t.sent,t.abrupt(\"return\",!!e);case 7:return t.prev=7,t.t0=t.catch(0),t.abrupt(\"return\",!1);case 10:case\"end\":return t.stop()}},null,null,[[0,7]],Promise)},R=function(n,e,a){return r.async(function(r){for(;;)switch(r.prev=r.next){case 0:t(o.createElement(m,{appPermissions:n,onCancel:F,onConfirm:function(n){return M({permissionsGranted:n,appFile:e,appId:a})}}));case 1:case\"end\":return r.stop()}},null,null,null,Promise)},G=function(n,e){var a,u;return r.async(function(s){for(;;)switch(s.prev=s.next){case 0:return a=e.id,u=e.permissions,s.next=3,r.awrap(S(a));case 3:if(!s.sent){s.next=6;break}return s.abrupt(\"return\",t(o.createElement(k,{cancel:F,confirm:function(){return R(u,n,a)}})));case 6:return s.next=8,r.awrap(R(u,n));case 8:case\"end\":return s.stop()}},null,null,null,Promise)},O=function(n){return r.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.abrupt(\"return\",h(n));case 4:e.prev=4,e.t0=e.catch(0),b(e.t0);case 7:case\"end\":return e.stop()}},null,null,[[0,4]],Promise)};return{install:function(){var e,t;return r.async(function(a){for(;;)switch(a.prev=a.next){case 0:if(C(!0),w.data){a.next=3;break}return a.abrupt(\"return\",F());case 3:if(e=n){a.next=6;break}return a.abrupt(\"return\",F());case 6:return a.next=8,r.awrap(O(e));case 8:if(t=a.sent){a.next=11;break}return a.abrupt(\"return\",F());case 11:return a.abrupt(\"return\",G(e,t));case 12:case\"end\":return a.stop()}},null,null,null,Promise)},isInstalling:E}}}","map":"{\"version\":3,\"sources\":[\"client/views/marketplace/hooks/useInstallApp.tsx\",\"<anon>\"],\"sourcesContent\":[\"import type { App, AppPermission } from '@rocket.chat/core-typings';\\nimport { useRouter, useSetModal, useUpload } from '@rocket.chat/ui-contexts';\\nimport { useMutation } from '@tanstack/react-query';\\nimport React, { useCallback, useState } from 'react';\\n\\nimport { AppClientOrchestratorInstance } from '../../../apps/orchestrator';\\nimport { useAppsReload } from '../../../contexts/hooks/useAppsReload';\\nimport AppPermissionsReviewModal from '../AppPermissionsReviewModal';\\nimport AppUpdateModal from '../AppUpdateModal';\\nimport { handleAPIError } from '../helpers/handleAPIError';\\nimport { handleInstallError } from '../helpers/handleInstallError';\\nimport { getManifestFromZippedApp } from '../lib/getManifestFromZippedApp';\\nimport { useAppsCountQuery } from './useAppsCountQuery';\\n\\nexport const useInstallApp = (file: File): { install: () => void; isInstalling: boolean } => {\\n\\tconst reloadAppsList = useAppsReload();\\n\\tconst setModal = useSetModal();\\n\\n\\tconst router = useRouter();\\n\\n\\tconst appCountQuery = useAppsCountQuery('private');\\n\\n\\tconst uploadAppEndpoint = useUpload('/apps');\\n\\tconst uploadUpdateEndpoint = useUpload('/apps/update');\\n\\n\\tconst [isInstalling, setInstalling] = useState(false);\\n\\n\\tconst { mutate: sendFile } = useMutation(\\n\\t\\t['apps/installPrivateApp'],\\n\\t\\t({ permissionsGranted, appFile, appId }: { permissionsGranted: AppPermission[]; appFile: File; appId?: string }) => {\\n\\t\\t\\tconst fileData = new FormData();\\n\\t\\t\\tfileData.append('app', appFile, appFile.name);\\n\\t\\t\\tfileData.append('permissions', JSON.stringify(permissionsGranted));\\n\\n\\t\\t\\tif (appId) {\\n\\t\\t\\t\\treturn uploadUpdateEndpoint(fileData);\\n\\t\\t\\t}\\n\\n\\t\\t\\treturn uploadAppEndpoint(fileData) as any;\\n\\t\\t},\\n\\t\\t{\\n\\t\\t\\tonSuccess: (data: { app: App }) => {\\n\\t\\t\\t\\trouter.navigate({\\n\\t\\t\\t\\t\\tname: 'marketplace',\\n\\t\\t\\t\\t\\tparams: {\\n\\t\\t\\t\\t\\t\\tcontext: 'private',\\n\\t\\t\\t\\t\\t\\tpage: 'info',\\n\\t\\t\\t\\t\\t\\tid: data.app.id,\\n\\t\\t\\t\\t\\t},\\n\\t\\t\\t\\t});\\n\\t\\t\\t},\\n\\t\\t\\tonError: (e) => {\\n\\t\\t\\t\\thandleAPIError(e);\\n\\t\\t\\t},\\n\\t\\t\\tonSettled: () => {\\n\\t\\t\\t\\tsetInstalling(false);\\n\\t\\t\\t\\tsetModal(null);\\n\\t\\t\\t\\treloadAppsList();\\n\\t\\t\\t},\\n\\t\\t},\\n\\t);\\n\\n\\tconst cancelAction = useCallback(() => {\\n\\t\\tsetInstalling(false);\\n\\t\\tsetModal(null);\\n\\t}, [setInstalling, setModal]);\\n\\n\\tconst isAppInstalled = async (appId: string) => {\\n\\t\\ttry {\\n\\t\\t\\tconst app = await AppClientOrchestratorInstance.getApp(appId);\\n\\t\\t\\treturn !!app || false;\\n\\t\\t} catch (e) {\\n\\t\\t\\treturn false;\\n\\t\\t}\\n\\t};\\n\\n\\tconst handleAppPermissionsReview = async (permissions: AppPermission[], appFile: File, appId?: string) => {\\n\\t\\tsetModal(\\n\\t\\t\\t<AppPermissionsReviewModal\\n\\t\\t\\t\\tappPermissions={permissions}\\n\\t\\t\\t\\tonCancel={cancelAction}\\n\\t\\t\\t\\tonConfirm={(permissionsGranted) => sendFile({ permissionsGranted, appFile, appId })}\\n\\t\\t\\t/>,\\n\\t\\t);\\n\\t};\\n\\n\\tconst uploadFile = async (appFile: File, { id, permissions }: { id: string; permissions: AppPermission[] }) => {\\n\\t\\tconst isInstalled = await isAppInstalled(id);\\n\\n\\t\\tif (isInstalled) {\\n\\t\\t\\treturn setModal(<AppUpdateModal cancel={cancelAction} confirm={() => handleAppPermissionsReview(permissions, appFile, id)} />);\\n\\t\\t}\\n\\n\\t\\tawait handleAppPermissionsReview(permissions, appFile);\\n\\t};\\n\\n\\tconst extractManifestFromAppFile = async (appFile: File) => {\\n\\t\\ttry {\\n\\t\\t\\treturn getManifestFromZippedApp(appFile);\\n\\t\\t} catch (error) {\\n\\t\\t\\thandleInstallError(error as Error);\\n\\t\\t}\\n\\t};\\n\\n\\tconst install = async () => {\\n\\t\\tsetInstalling(true);\\n\\n\\t\\tif (!appCountQuery.data) {\\n\\t\\t\\treturn cancelAction();\\n\\t\\t}\\n\\n\\t\\tconst appFile = file;\\n\\n\\t\\tif (!appFile) {\\n\\t\\t\\treturn cancelAction();\\n\\t\\t}\\n\\n\\t\\tconst manifest = await extractManifestFromAppFile(appFile);\\n\\n\\t\\tif (!manifest) {\\n\\t\\t\\treturn cancelAction();\\n\\t\\t}\\n\\n\\t\\treturn uploadFile(appFile, manifest);\\n\\t};\\n\\n\\treturn { install, isInstalling };\\n};\\n\",null],\"names\":[\"module\",\"link\",\"default\",\"v\",\"_regeneratorRuntime\",\"_slicedToArray\",\"export\",\"useInstallApp\",\"useRouter\",\"useSetModal\",\"useUpload\",\"useMutation\",\"React\",\"useCallback\",\"useState\",\"AppClientOrchestratorInstance\",\"useAppsReload\",\"AppPermissionsReviewModal\",\"AppUpdateModal\",\"handleAPIError\",\"handleInstallError\",\"getManifestFromZippedApp\",\"useAppsCountQuery\",\"file\",\"reloadAppsList\",\"setModal\",\"router\",\"appCountQuery\",\"uploadAppEndpoint\",\"uploadUpdateEndpoint\",\"_useState\",\"_useState2\",\"isInstalling\",\"setInstalling\",\"sendFile\",\"_useMutation\",\"_ref\",\"permissionsGranted\",\"appFile\",\"appId\",\"fileData\",\"FormData\",\"append\",\"name\",\"JSON\",\"stringify\",\"onSuccess\",\"data\",\"navigate\",\"params\",\"context\",\"page\",\"id\",\"app\",\"onError\",\"e\",\"onSettled\",\"mutate\",\"cancelAction\",\"isAppInstalled\",\"async\",\"_context\",\"prev\",\"next\",\"awrap\",\"getApp\",\"sent\",\"abrupt\",\"t0\",\"stop\",\"Promise\",\"handleAppPermissionsReview\",\"permissions\",\"_context2\",\"createElement\",\"appPermissions\",\"onCancel\",\"onConfirm\",\"uploadFile\",\"_ref2\",\"_context3\",\"cancel\",\"confirm\",\"extractManifestFromAppFile\",\"_context4\",\"install\",\"manifest\",\"_context5\"],\"mappings\":\"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\"}"}