{"code":"function module(e,r,n){n.link(\"@babel/runtime/regenerator\",{default:function(e){t=e}},0),n.link(\"@babel/runtime/helpers/objectSpread2\",{default:function(e){o=e}},1),n.export({convertError:function(){return i},createOAuthTotpLoginMethod:function(){return p}}),n.link(\"meteor/accounts-base\",{Accounts:function(e){u=e}},0),n.link(\"meteor/meteor\",{Meteor:function(e){a=e}},1),n.link(\"meteor/oauth\",{OAuth:function(e){l=e}},2);var t,o,u,a,l,i=function(e){return e instanceof a.Error&&e.error===u.LoginCancelledError.numericError?new u.LoginCancelledError(e.reason):e},c=null,f=null,s=l._retrieveCredentialSecret;l._retrieveCredentialSecret=function(e){var r=s.call(l,e);if(!r){var n=\"\"+l._storageTokenPrefix+e;r=localStorage.getItem(n),localStorage.removeItem(n)}return r};var d=function(e,r,n,t){t=t||l._retrieveCredentialSecret(e)||null;var a=o({oauth:{credentialToken:e,credentialSecret:t}},\"string\"==typeof n&&!!n&&{totp:{code:n}});c=e,f=t,\"string\"==typeof n&&n&&(a.totp={code:n}),u.callLoginMethod({methodArguments:[a],userCallback:function(e){null==r||r(i(e))}})},m=function(e,r){return function(n){if(!n){null==e||e(new a.Error(\"No credential token passed\"));return}if(n instanceof Error){null==e||e(n);return}d(n,e,r)}},p=function(e){return function(r,n,t){if(c&&f)d(c,t,n,f);else{var o=m(t,n);e.requestCredential(r,o)}c=null,f=null}};u.oauth.credentialRequestCompleteHandler=m,u.onPageLoadLogin(function(e){var r,o,u,a,l,i,c;return t.async(function(f){for(;;)switch(f.prev=f.next){case 0:if(!((null==e?void 0:null===(r=e.error)||void 0===r?void 0:r.error)!==\"totp-required\")){f.next=2;break}return f.abrupt(\"return\");case 2:if(null!=(o=e.methodArguments)&&o.length){f.next=5;break}return f.abrupt(\"return\");case 5:return a=(u=o.find(function(e){return e.oauth}).oauth).credentialToken,l=u.credentialSecret,i=e.userCallback,f.next=10,t.awrap(n.dynamicImport(\"../../lib/2fa/process2faReturn\"));case 10:return c=f.sent.process2faReturn,f.next=14,t.awrap(c({error:e.error,originalCallback:i,onCode:function(e){d(a,i,e,l)},emailOrUsername:void 0,result:void 0}));case 14:case\"end\":return f.stop()}},null,null,null,Promise)})}","map":"{\"version\":3,\"sources\":[\"client/meteorOverrides/login/oauth.ts\",\"<anon>\"],\"sourcesContent\":[\"import { Accounts } from 'meteor/accounts-base';\\nimport { Meteor } from 'meteor/meteor';\\nimport { OAuth } from 'meteor/oauth';\\n\\nimport type { IOAuthProvider } from '../../definitions/IOAuthProvider';\\nimport type { LoginCallback } from '../../lib/2fa/overrideLoginMethod';\\n\\nconst isLoginCancelledError = (error: unknown): error is Meteor.Error =>\\n\\terror instanceof Meteor.Error && error.error === Accounts.LoginCancelledError.numericError;\\n\\nexport const convertError = <T>(error: T): Accounts.LoginCancelledError | T => {\\n\\tif (isLoginCancelledError(error)) {\\n\\t\\treturn new Accounts.LoginCancelledError(error.reason);\\n\\t}\\n\\n\\treturn error;\\n};\\n\\nlet lastCredentialToken: string | null = null;\\nlet lastCredentialSecret: string | null | undefined = null;\\n\\nconst meteorOAuthRetrieveCredentialSecret = OAuth._retrieveCredentialSecret;\\nOAuth._retrieveCredentialSecret = (credentialToken: string): string | null => {\\n\\tlet secret = meteorOAuthRetrieveCredentialSecret.call(OAuth, credentialToken);\\n\\tif (!secret) {\\n\\t\\tconst localStorageKey = `${OAuth._storageTokenPrefix}${credentialToken}`;\\n\\t\\tsecret = localStorage.getItem(localStorageKey);\\n\\t\\tlocalStorage.removeItem(localStorageKey);\\n\\t}\\n\\n\\treturn secret;\\n};\\n\\nconst tryLoginAfterPopupClosed = (\\n\\tcredentialToken: string,\\n\\tcallback?: (error?: globalThis.Error | Meteor.Error | Meteor.TypedError) => void,\\n\\ttotpCode?: string,\\n\\tcredentialSecret?: string | null,\\n) => {\\n\\tcredentialSecret = credentialSecret || OAuth._retrieveCredentialSecret(credentialToken) || null;\\n\\tconst methodArgument = {\\n\\t\\toauth: {\\n\\t\\t\\tcredentialToken,\\n\\t\\t\\tcredentialSecret,\\n\\t\\t},\\n\\t\\t...(typeof totpCode === 'string' &&\\n\\t\\t\\t!!totpCode && {\\n\\t\\t\\t\\ttotp: {\\n\\t\\t\\t\\t\\tcode: totpCode,\\n\\t\\t\\t\\t},\\n\\t\\t\\t}),\\n\\t};\\n\\n\\tlastCredentialToken = credentialToken;\\n\\tlastCredentialSecret = credentialSecret;\\n\\n\\tif (typeof totpCode === 'string' && !!totpCode) {\\n\\t\\tmethodArgument.totp = {\\n\\t\\t\\tcode: totpCode,\\n\\t\\t};\\n\\t}\\n\\n\\tAccounts.callLoginMethod({\\n\\t\\tmethodArguments: [methodArgument],\\n\\t\\tuserCallback: (err) => {\\n\\t\\t\\tcallback?.(convertError(err));\\n\\t\\t},\\n\\t});\\n};\\n\\nconst credentialRequestCompleteHandler =\\n\\t(callback?: (error?: globalThis.Error | Meteor.Error | Meteor.TypedError) => void, totpCode?: string) =>\\n\\t(credentialTokenOrError?: string | globalThis.Error | Meteor.Error | Meteor.TypedError) => {\\n\\t\\tif (!credentialTokenOrError) {\\n\\t\\t\\tcallback?.(new Meteor.Error('No credential token passed'));\\n\\t\\t\\treturn;\\n\\t\\t}\\n\\n\\t\\tif (credentialTokenOrError instanceof Error) {\\n\\t\\t\\tcallback?.(credentialTokenOrError);\\n\\t\\t\\treturn;\\n\\t\\t}\\n\\n\\t\\ttryLoginAfterPopupClosed(credentialTokenOrError, callback, totpCode);\\n\\t};\\n\\nexport const createOAuthTotpLoginMethod =\\n\\t(provider: IOAuthProvider) => (options: Meteor.LoginWithExternalServiceOptions | undefined, code: string, callback?: LoginCallback) => {\\n\\t\\tif (lastCredentialToken && lastCredentialSecret) {\\n\\t\\t\\ttryLoginAfterPopupClosed(lastCredentialToken, callback, code, lastCredentialSecret);\\n\\t\\t} else {\\n\\t\\t\\tconst credentialRequestCompleteCallback = credentialRequestCompleteHandler(callback, code);\\n\\t\\t\\tprovider.requestCredential(options, credentialRequestCompleteCallback);\\n\\t\\t}\\n\\n\\t\\tlastCredentialToken = null;\\n\\t\\tlastCredentialSecret = null;\\n\\t};\\n\\nAccounts.oauth.credentialRequestCompleteHandler = credentialRequestCompleteHandler;\\n\\nAccounts.onPageLoadLogin(async (loginAttempt: any) => {\\n\\tif (loginAttempt?.error?.error !== 'totp-required') {\\n\\t\\treturn;\\n\\t}\\n\\n\\tconst { methodArguments } = loginAttempt;\\n\\tif (!methodArguments?.length) {\\n\\t\\treturn;\\n\\t}\\n\\n\\tconst oAuthArgs = methodArguments.find((arg: any) => arg.oauth);\\n\\tconst { credentialToken, credentialSecret } = oAuthArgs.oauth;\\n\\tconst cb = loginAttempt.userCallback;\\n\\n\\tconst { process2faReturn } = await import('../../lib/2fa/process2faReturn');\\n\\n\\tawait process2faReturn({\\n\\t\\terror: loginAttempt.error,\\n\\t\\toriginalCallback: cb,\\n\\t\\tonCode: (code) => {\\n\\t\\t\\ttryLoginAfterPopupClosed(credentialToken, cb, code, credentialSecret);\\n\\t\\t},\\n\\t\\temailOrUsername: undefined,\\n\\t\\tresult: undefined,\\n\\t});\\n});\\n\",null],\"names\":[\"module\",\"link\",\"default\",\"v\",\"_regeneratorRuntime\",\"_objectSpread\",\"export\",\"convertError\",\"createOAuthTotpLoginMethod\",\"Accounts\",\"Meteor\",\"OAuth\",\"error\",\"Error\",\"LoginCancelledError\",\"numericError\",\"reason\",\"lastCredentialToken\",\"lastCredentialSecret\",\"meteorOAuthRetrieveCredentialSecret\",\"_retrieveCredentialSecret\",\"credentialToken\",\"secret\",\"call\",\"localStorageKey\",\"_storageTokenPrefix\",\"localStorage\",\"getItem\",\"removeItem\",\"tryLoginAfterPopupClosed\",\"callback\",\"totpCode\",\"credentialSecret\",\"methodArgument\",\"oauth\",\"totp\",\"code\",\"callLoginMethod\",\"methodArguments\",\"userCallback\",\"err\",\"credentialRequestCompleteHandler\",\"credentialTokenOrError\",\"provider\",\"options\",\"credentialRequestCompleteCallback\",\"requestCredential\",\"onPageLoadLogin\",\"loginAttempt\",\"_loginAttempt$error\",\"_oAuthArgs$oauth\",\"cb\",\"process2faReturn\",\"async\",\"_context\",\"prev\",\"next\",\"abrupt\",\"length\",\"oAuthArgs\",\"find\",\"arg\",\"awrap\",\"dynamicImport\",\"_await$module$dynamic\",\"sent\",\"originalCallback\",\"onCode\",\"emailOrUsername\",\"undefined\",\"result\",\"stop\",\"Promise\"],\"mappings\":\"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\"}"}