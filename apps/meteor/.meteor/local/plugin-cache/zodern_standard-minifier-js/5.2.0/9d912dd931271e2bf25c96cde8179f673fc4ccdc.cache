{"code":"function module(n,e,t){t.link(\"@babel/runtime/regenerator\",{default:function(n){r=n}},0),t.link(\"meteor/meteor\",{Meteor:function(n){i=n}},0),t.link(\"meteor/tracker\",{Tracker:function(n){o=n}},1),t.link(\"../../app/models/client\",{ChatMessage:function(n){a=n},ChatSubscription:function(n){s=n}},2),t.link(\"../../app/ui-utils/client\",{LegacyRoomManager:function(n){c=n},upsertMessage:function(n){u=n}},3),t.link(\"../lib/utils/callWithErrorHandling\",{callWithErrorHandling:function(n){l=n}},4);var r,i,o,a,s,c,u,l,f=function(n){var e,t,i;return r.async(function(o){for(;;)switch(o.prev=o.next){case 0:if(e=a.findOne({rid:n,_hidden:{$ne:!0},temp:{$exists:!1}},{sort:{ts:-1},limit:1})){o.next=3;break}return o.abrupt(\"return\");case 3:return o.prev=3,o.next=6,r.awrap(l(\"loadMissedMessages\",n,e.ts));case 6:if(!(t=o.sent)){o.next=11;break}return i=s.findOne({rid:n}),o.next=11,r.awrap(Promise.all(Array.from(t).map(function(n){return u({msg:n,subscription:i})})));case 11:o.next=16;break;case 13:o.prev=13,o.t0=o.catch(3),console.error(o.t0);case 16:case\"end\":return o.stop()}},null,null,[[3,13]],Promise)};i.startup(function(){var n=!0;o.autorun(function(){var e=i.connection.status().connected;!0===e&&!1===n&&c.openedRooms&&Object.keys(c.openedRooms).forEach(function(n){var e=c.openedRooms[n];e.rid&&f(e.rid)}),n=e})})}","map":"{\"version\":3,\"sources\":[\"client/startup/loadMissedMessages.ts\",\"<anon>\"],\"sourcesContent\":[\"import type { IRoom } from '@rocket.chat/core-typings';\\nimport { Meteor } from 'meteor/meteor';\\nimport { Tracker } from 'meteor/tracker';\\n\\nimport { ChatMessage, ChatSubscription } from '../../app/models/client';\\nimport { LegacyRoomManager, upsertMessage } from '../../app/ui-utils/client';\\nimport { callWithErrorHandling } from '../lib/utils/callWithErrorHandling';\\n\\nconst loadMissedMessages = async function (rid: IRoom['_id']): Promise<void> {\\n\\tconst lastMessage = ChatMessage.findOne({ rid, _hidden: { $ne: true }, temp: { $exists: false } }, { sort: { ts: -1 }, limit: 1 });\\n\\n\\tif (!lastMessage) {\\n\\t\\treturn;\\n\\t}\\n\\n\\ttry {\\n\\t\\tconst result = await callWithErrorHandling('loadMissedMessages', rid, lastMessage.ts);\\n\\t\\tif (result) {\\n\\t\\t\\tconst subscription = ChatSubscription.findOne({ rid });\\n\\t\\t\\tawait Promise.all(Array.from(result).map((msg) => upsertMessage({ msg, subscription })));\\n\\t\\t}\\n\\t} catch (error) {\\n\\t\\tconsole.error(error);\\n\\t}\\n};\\n\\nMeteor.startup(() => {\\n\\tlet connectionWasOnline = true;\\n\\tTracker.autorun(() => {\\n\\t\\tconst { connected } = Meteor.connection.status();\\n\\n\\t\\tif (connected === true && connectionWasOnline === false && LegacyRoomManager.openedRooms) {\\n\\t\\t\\tObject.keys(LegacyRoomManager.openedRooms).forEach((key) => {\\n\\t\\t\\t\\tconst value = LegacyRoomManager.openedRooms[key];\\n\\t\\t\\t\\tif (value.rid) {\\n\\t\\t\\t\\t\\tloadMissedMessages(value.rid);\\n\\t\\t\\t\\t}\\n\\t\\t\\t});\\n\\t\\t}\\n\\t\\tconnectionWasOnline = connected;\\n\\t});\\n});\\n\",null],\"names\":[\"module\",\"link\",\"default\",\"v\",\"_regeneratorRuntime\",\"Meteor\",\"Tracker\",\"ChatMessage\",\"ChatSubscription\",\"LegacyRoomManager\",\"upsertMessage\",\"callWithErrorHandling\",\"loadMissedMessages\",\"rid\",\"lastMessage\",\"result\",\"subscription\",\"async\",\"_context\",\"prev\",\"next\",\"findOne\",\"_hidden\",\"$ne\",\"temp\",\"$exists\",\"sort\",\"ts\",\"limit\",\"abrupt\",\"awrap\",\"sent\",\"Promise\",\"all\",\"Array\",\"from\",\"map\",\"msg\",\"t0\",\"console\",\"error\",\"stop\",\"startup\",\"connectionWasOnline\",\"autorun\",\"connected\",\"_Meteor$connection$st\",\"connection\",\"status\",\"openedRooms\",\"Object\",\"keys\",\"forEach\",\"key\",\"value\"],\"mappings\":\"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\"}"}