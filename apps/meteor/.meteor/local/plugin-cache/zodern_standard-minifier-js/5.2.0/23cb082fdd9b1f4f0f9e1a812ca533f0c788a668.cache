{"code":"function module(e,a,o){let t,s,c,l,n,r,i,m,u,d,g;o.link(\"@rocket.chat/fuselage\",{Box(e){t=e},Throbber(e){s=e}},0),o.link(\"@rocket.chat/fuselage-hooks\",{useMutableCallback(e){c=e}},1),o.link(\"@rocket.chat/ui-composer\",{MessageComposerAction(e){l=e}},2),o.link(\"react\",{default(e){n=e},useEffect(e){r=e},useMemo(e){i=e},useState(e){m=e}},3),o.link(\"react-i18next\",{useTranslation(e){u=e}},4),o.link(\"../../../../app/ui/client/lib/recorderjs/AudioRecorder\",{AudioRecorder(e){d=e}},5),o.link(\"../../room/contexts/ChatContext\",{useChat(e){g=e}},6);let _=new d;o.exportDefault(e=>{var a;let{rid:o,chatContext:d,isMicrophoneDenied:p}=e,{t:b}=u(),[x,k]=m(\"recording\"),[f,h]=m(\"00:00\"),[w,v]=m(null),[E,y]=m(null),C=c(async()=>{var e;w&&clearInterval(w),v(null),y(null),h(\"00:00\"),null==A||A.action.stop(\"recording\"),null==A||null===(e=A.composer)||void 0===e||e.setRecordingMode(!1);let a=await new Promise(e=>_.stop(e));return a}),M=c(async()=>{\"recording\"===x&&await C()}),N=c(async()=>{if(!E||E===o)try{await _.start(),null==A||A.action.performContinuously(\"recording\");let e=new Date;v(setInterval(()=>{let a=new Date,o=(a.getTime()-e.getTime())/1e3;h(\"\".concat(String(Math.floor(o/60)).padStart(2,\"0\"),\":\").concat(String(Math.floor(o%60)).padStart(2,\"0\")))},1e3)),y(o)}catch(a){var e;console.log(a),null==A||null===(e=A.composer)||void 0===e||e.setRecordingMode(!1)}}),S=c(async()=>{await C()}),A=null!==(a=g())&&void 0!==a?a:d,R=c(async()=>{k(\"loading\");let e=await C(),a=\"\".concat(b(\"Audio_record\"),\".mp3\"),o=new File([e],a,{type:\"audio/mpeg\"});await (null==A?void 0:A.flows.uploadFiles([o]))});r(()=>(N(),()=>{M()}),[M,N]);let T=i(()=>E&&E!==o?\"rc-message-box__audio-message--busy\":x&&\"rc-message-box__audio-message--\".concat(x),[E,o,x]);return p?null:n.createElement(t,{position:\"absolute\",pi:4,pb:12,className:\"rc-message-box__audio-message \".concat(T)},\"recording\"===x&&n.createElement(n.Fragment,null,n.createElement(l,{icon:\"circle-cross\",className:\"rc-message-box__icon rc-message-box__audio-message-cancel\",onClick:S}),n.createElement(t,{className:\"rc-message-box__audio-message-timer\",color:\"default\"},n.createElement(\"span\",{className:\"rc-message-box__audio-message-timer-dot\"}),n.createElement(\"span\",{className:\"rc-message-box__audio-message-timer-text\"},f)),n.createElement(l,{icon:\"circle-check\",className:\"rc-message-box__icon rc-message-box__audio-message-done\",onClick:R})),\"loading\"===x&&n.createElement(\"div\",{className:\"rc-message-box__icon\"},n.createElement(s,{inheritColor:!0,size:\"x12\"})))})}","map":"{\"version\":3,\"sources\":[\"client/views/composer/AudioMessageRecorder/AudioMessageRecorder.tsx\",\"<anon>\"],\"sourcesContent\":[\"import type { IRoom } from '@rocket.chat/core-typings';\\nimport { Box, Throbber } from '@rocket.chat/fuselage';\\nimport { useMutableCallback } from '@rocket.chat/fuselage-hooks';\\nimport { MessageComposerAction } from '@rocket.chat/ui-composer';\\nimport type { ReactElement } from 'react';\\nimport React, { useEffect, useMemo, useState } from 'react';\\nimport { useTranslation } from 'react-i18next';\\n\\nimport { AudioRecorder } from '../../../../app/ui/client/lib/recorderjs/AudioRecorder';\\nimport type { ChatAPI } from '../../../lib/chats/ChatAPI';\\nimport { useChat } from '../../room/contexts/ChatContext';\\n\\nconst audioRecorder = new AudioRecorder();\\n\\ntype AudioMessageRecorderProps = {\\n\\trid: IRoom['_id'];\\n\\tchatContext?: ChatAPI; // TODO: remove this when the composer is migrated to React\\n\\tisMicrophoneDenied?: boolean;\\n};\\n\\nconst AudioMessageRecorder = ({ rid, chatContext, isMicrophoneDenied }: AudioMessageRecorderProps): ReactElement | null => {\\n\\tconst { t } = useTranslation();\\n\\n\\tconst [state, setState] = useState<'loading' | 'recording'>('recording');\\n\\tconst [time, setTime] = useState('00:00');\\n\\tconst [recordingInterval, setRecordingInterval] = useState<ReturnType<typeof setInterval> | null>(null);\\n\\tconst [recordingRoomId, setRecordingRoomId] = useState<IRoom['_id'] | null>(null);\\n\\n\\tconst stopRecording = useMutableCallback(async () => {\\n\\t\\tif (recordingInterval) {\\n\\t\\t\\tclearInterval(recordingInterval);\\n\\t\\t}\\n\\t\\tsetRecordingInterval(null);\\n\\t\\tsetRecordingRoomId(null);\\n\\n\\t\\tsetTime('00:00');\\n\\n\\t\\tchat?.action.stop('recording');\\n\\n\\t\\tchat?.composer?.setRecordingMode(false);\\n\\n\\t\\tconst blob = await new Promise<Blob>((resolve) => audioRecorder.stop(resolve));\\n\\n\\t\\treturn blob;\\n\\t});\\n\\n\\tconst handleUnmount = useMutableCallback(async () => {\\n\\t\\tif (state === 'recording') {\\n\\t\\t\\tawait stopRecording();\\n\\t\\t}\\n\\t});\\n\\n\\tconst handleRecord = useMutableCallback(async () => {\\n\\t\\tif (recordingRoomId && recordingRoomId !== rid) {\\n\\t\\t\\treturn;\\n\\t\\t}\\n\\n\\t\\ttry {\\n\\t\\t\\tawait audioRecorder.start();\\n\\t\\t\\tchat?.action.performContinuously('recording');\\n\\t\\t\\tconst startTime = new Date();\\n\\t\\t\\tsetRecordingInterval(\\n\\t\\t\\t\\tsetInterval(() => {\\n\\t\\t\\t\\t\\tconst now = new Date();\\n\\t\\t\\t\\t\\tconst distance = (now.getTime() - startTime.getTime()) / 1000;\\n\\t\\t\\t\\t\\tconst minutes = Math.floor(distance / 60);\\n\\t\\t\\t\\t\\tconst seconds = Math.floor(distance % 60);\\n\\t\\t\\t\\t\\tsetTime(`${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`);\\n\\t\\t\\t\\t}, 1000),\\n\\t\\t\\t);\\n\\t\\t\\tsetRecordingRoomId(rid);\\n\\t\\t} catch (error) {\\n\\t\\t\\tconsole.log(error);\\n\\t\\t\\tchat?.composer?.setRecordingMode(false);\\n\\t\\t}\\n\\t});\\n\\n\\tconst handleCancelButtonClick = useMutableCallback(async () => {\\n\\t\\tawait stopRecording();\\n\\t});\\n\\n\\tconst chat = useChat() ?? chatContext;\\n\\n\\tconst handleDoneButtonClick = useMutableCallback(async () => {\\n\\t\\tsetState('loading');\\n\\n\\t\\tconst blob = await stopRecording();\\n\\n\\t\\tconst fileName = `${t('Audio_record')}.mp3`;\\n\\t\\tconst file = new File([blob], fileName, { type: 'audio/mpeg' });\\n\\n\\t\\tawait chat?.flows.uploadFiles([file]);\\n\\t});\\n\\n\\tuseEffect(() => {\\n\\t\\thandleRecord();\\n\\n\\t\\treturn () => {\\n\\t\\t\\thandleUnmount();\\n\\t\\t};\\n\\t}, [handleUnmount, handleRecord]);\\n\\n\\tconst stateClass = useMemo(() => {\\n\\t\\tif (recordingRoomId && recordingRoomId !== rid) {\\n\\t\\t\\treturn 'rc-message-box__audio-message--busy';\\n\\t\\t}\\n\\n\\t\\treturn state && `rc-message-box__audio-message--${state}`;\\n\\t}, [recordingRoomId, rid, state]);\\n\\n\\tif (isMicrophoneDenied) {\\n\\t\\treturn null;\\n\\t}\\n\\n\\treturn (\\n\\t\\t<Box position='absolute' pi={4} pb={12} className={`rc-message-box__audio-message ${stateClass}`}>\\n\\t\\t\\t{state === 'recording' && (\\n\\t\\t\\t\\t<>\\n\\t\\t\\t\\t\\t<MessageComposerAction\\n\\t\\t\\t\\t\\t\\ticon='circle-cross'\\n\\t\\t\\t\\t\\t\\tclassName='rc-message-box__icon rc-message-box__audio-message-cancel'\\n\\t\\t\\t\\t\\t\\tonClick={handleCancelButtonClick}\\n\\t\\t\\t\\t\\t/>\\n\\t\\t\\t\\t\\t<Box className='rc-message-box__audio-message-timer' color='default'>\\n\\t\\t\\t\\t\\t\\t<span className='rc-message-box__audio-message-timer-dot'></span>\\n\\t\\t\\t\\t\\t\\t<span className='rc-message-box__audio-message-timer-text'>{time}</span>\\n\\t\\t\\t\\t\\t</Box>\\n\\t\\t\\t\\t\\t<MessageComposerAction\\n\\t\\t\\t\\t\\t\\ticon='circle-check'\\n\\t\\t\\t\\t\\t\\tclassName='rc-message-box__icon rc-message-box__audio-message-done'\\n\\t\\t\\t\\t\\t\\tonClick={handleDoneButtonClick}\\n\\t\\t\\t\\t\\t/>\\n\\t\\t\\t\\t</>\\n\\t\\t\\t)}\\n\\t\\t\\t{state === 'loading' && (\\n\\t\\t\\t\\t<div className='rc-message-box__icon'>\\n\\t\\t\\t\\t\\t<Throbber inheritColor size='x12' />\\n\\t\\t\\t\\t</div>\\n\\t\\t\\t)}\\n\\t\\t</Box>\\n\\t);\\n};\\n\\nexport default AudioMessageRecorder;\\n\",null],\"names\":[\"Box\",\"Throbber\",\"useMutableCallback\",\"MessageComposerAction\",\"React\",\"useEffect\",\"useMemo\",\"useState\",\"useTranslation\",\"AudioRecorder\",\"useChat\",\"module\",\"link\",\"v\",\"default\",\"audioRecorder\",\"exportDefault\",\"_ref\",\"_useChat\",\"rid\",\"chatContext\",\"isMicrophoneDenied\",\"t\",\"state\",\"setState\",\"time\",\"setTime\",\"recordingInterval\",\"setRecordingInterval\",\"recordingRoomId\",\"setRecordingRoomId\",\"stopRecording\",\"_chat$composer\",\"clearInterval\",\"chat\",\"action\",\"stop\",\"composer\",\"setRecordingMode\",\"blob\",\"Promise\",\"resolve\",\"handleUnmount\",\"handleRecord\",\"start\",\"performContinuously\",\"startTime\",\"Date\",\"setInterval\",\"now\",\"distance\",\"getTime\",\"concat\",\"String\",\"Math\",\"floor\",\"padStart\",\"error\",\"_chat$composer2\",\"console\",\"log\",\"handleCancelButtonClick\",\"handleDoneButtonClick\",\"fileName\",\"file\",\"File\",\"type\",\"flows\",\"uploadFiles\",\"stateClass\",\"createElement\",\"position\",\"pi\",\"pb\",\"className\",\"Fragment\",\"icon\",\"onClick\",\"color\",\"inheritColor\",\"size\"],\"mappings\":\"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\"}"}