{"code":"function module(e,t,r){var n,a,u,s,i,c,o,l,f,p,b;r.link(\"@babel/runtime/regenerator\",{default:function(e){n=e}},0),r.link(\"@babel/runtime/helpers/objectSpread2\",{default:function(e){a=e}},1),r.link(\"@rocket.chat/core-typings\",{isOTRMessage:function(e){u=e}},0),r.link(\"meteor/meteor\",{Meteor:function(e){s=e}},1),r.link(\"meteor/tracker\",{Tracker:function(e){i=e}},2),r.link(\"../../app/otr/client/OTR\",{default:function(e){c=e}},3),r.link(\"../../app/otr/lib/OtrRoomState\",{OtrRoomState:function(e){o=e}},4),r.link(\"../../app/utils/client/lib/SDKClient\",{sdk:function(e){l=e}},5),r.link(\"../../app/utils/lib/i18n\",{t:function(e){f=e}},6),r.link(\"../lib/onClientBeforeSendMessage\",{onClientBeforeSendMessage:function(e){p=e}},7),r.link(\"../lib/onClientMessageReceived\",{onClientMessageReceived:function(e){b=e}},8),s.startup(function(){i.autorun(function(){var e=s.userId();e&&l.stream(\"notify-user\",[e+\"/otr\"],function(t,r){if(r.roomId&&r.userId&&r.userId!==e){var n=c.getInstanceByRoomId(e,r.roomId);null==n||n.onUserStream(t,r)}})}),p.use(function(e){var t,r,u;return n.async(function(i){for(;;)switch(i.prev=i.next){case 0:if(t=s.userId()){i.next=3;break}return i.abrupt(\"return\",e);case 3:if(!((r=c.getInstanceByRoomId(t,e.rid))&&r.getState()===o.ESTABLISHED)){i.next=9;break}return i.next=7,n.awrap(r.encrypt(e));case 7:return u=i.sent,i.abrupt(\"return\",a(a({},e),{},{msg:u,t:\"otr\"}));case 9:return i.abrupt(\"return\",e);case 10:case\"end\":return i.stop()}},null,null,null,Promise)}),b.use(function(e){var t,r,i,p,b,d,k,m,g,x;return n.async(function(I){for(;;)switch(I.prev=I.next){case 0:if(t=s.userId()){I.next=3;break}return I.abrupt(\"return\",e);case 3:if(u(e)){I.next=5;break}return I.abrupt(\"return\",e);case 5:if(!(\"notification\"in e)){I.next=7;break}return I.abrupt(\"return\",a(a({},e),{},{msg:f(\"Encrypted_message\")}));case 7:if(!((r=c.getInstanceByRoomId(t,e.rid))&&r.getState()===o.ESTABLISHED)){I.next=32;break}return I.next=11,n.awrap(r.decrypt(e.msg));case 11:if(\"string\"!=typeof(i=I.sent)){I.next=14;break}return I.abrupt(\"return\",a(a({},e),{},{msg:i}));case 14:if(p=i._id,b=i.text,d=i.ack,k=i.ts,m=i.userId,k&&(e.ts=k),!e.otrAck){I.next=26;break}return I.next=19,n.awrap(r.decrypt(e.otrAck));case 19:if(\"string\"!=typeof(g=I.sent)){I.next=22;break}return I.abrupt(\"return\",a(a({},e),{},{msg:g}));case 22:if(d!==g.text){I.next=24;break}return I.abrupt(\"return\",a(a({},e),{},{_id:p,t:\"otr-ack\",msg:b}));case 24:I.next=31;break;case 26:if(!(m!==s.userId())){I.next=31;break}return I.next=29,n.awrap(r.encryptText(d));case 29:x=I.sent,l.call(\"updateOTRAck\",{message:e,ack:x});case 31:return I.abrupt(\"return\",a(a({},e),{},{_id:p,msg:b}));case 32:return\"otr\"===e.t&&(e.msg=\"\"),I.abrupt(\"return\",e);case 34:case\"end\":return I.stop()}},null,null,null,Promise)})})}","map":"{\"version\":3,\"sources\":[\"client/startup/otr.ts\",\"<anon>\"],\"sourcesContent\":[\"import { isOTRMessage } from '@rocket.chat/core-typings';\\nimport { Meteor } from 'meteor/meteor';\\nimport { Tracker } from 'meteor/tracker';\\n\\nimport OTR from '../../app/otr/client/OTR';\\nimport { OtrRoomState } from '../../app/otr/lib/OtrRoomState';\\nimport { sdk } from '../../app/utils/client/lib/SDKClient';\\nimport { t } from '../../app/utils/lib/i18n';\\nimport { onClientBeforeSendMessage } from '../lib/onClientBeforeSendMessage';\\nimport { onClientMessageReceived } from '../lib/onClientMessageReceived';\\n\\nMeteor.startup(() => {\\n\\tTracker.autorun(() => {\\n\\t\\tconst uid = Meteor.userId();\\n\\n\\t\\tif (!uid) {\\n\\t\\t\\treturn;\\n\\t\\t}\\n\\n\\t\\tsdk.stream('notify-user', [`${uid}/otr`], (type, data) => {\\n\\t\\t\\tif (!data.roomId || !data.userId || data.userId === uid) {\\n\\t\\t\\t\\treturn;\\n\\t\\t\\t}\\n\\n\\t\\t\\tconst otrRoom = OTR.getInstanceByRoomId(uid, data.roomId);\\n\\t\\t\\totrRoom?.onUserStream(type, data);\\n\\t\\t});\\n\\t});\\n\\n\\tonClientBeforeSendMessage.use(async (message) => {\\n\\t\\tconst uid = Meteor.userId();\\n\\n\\t\\tif (!uid) {\\n\\t\\t\\treturn message;\\n\\t\\t}\\n\\n\\t\\tconst otrRoom = OTR.getInstanceByRoomId(uid, message.rid);\\n\\n\\t\\tif (otrRoom && otrRoom.getState() === OtrRoomState.ESTABLISHED) {\\n\\t\\t\\tconst msg = await otrRoom.encrypt(message);\\n\\t\\t\\treturn { ...message, msg, t: 'otr' };\\n\\t\\t}\\n\\t\\treturn message;\\n\\t});\\n\\n\\tonClientMessageReceived.use(async (message) => {\\n\\t\\tconst uid = Meteor.userId();\\n\\n\\t\\tif (!uid) {\\n\\t\\t\\treturn message;\\n\\t\\t}\\n\\n\\t\\tif (!isOTRMessage(message)) {\\n\\t\\t\\treturn message;\\n\\t\\t}\\n\\n\\t\\tif ('notification' in message) {\\n\\t\\t\\treturn { ...message, msg: t('Encrypted_message') };\\n\\t\\t}\\n\\n\\t\\tconst otrRoom = OTR.getInstanceByRoomId(uid, message.rid);\\n\\n\\t\\tif (otrRoom && otrRoom.getState() === OtrRoomState.ESTABLISHED) {\\n\\t\\t\\tconst decrypted = await otrRoom.decrypt(message.msg);\\n\\t\\t\\tif (typeof decrypted === 'string') {\\n\\t\\t\\t\\treturn { ...message, msg: decrypted };\\n\\t\\t\\t}\\n\\t\\t\\tconst { _id, text: msg, ack, ts, userId } = decrypted;\\n\\n\\t\\t\\tif (ts) message.ts = ts;\\n\\n\\t\\t\\tif (message.otrAck) {\\n\\t\\t\\t\\tconst otrAck = await otrRoom.decrypt(message.otrAck);\\n\\t\\t\\t\\tif (typeof otrAck === 'string') {\\n\\t\\t\\t\\t\\treturn { ...message, msg: otrAck };\\n\\t\\t\\t\\t}\\n\\n\\t\\t\\t\\tif (ack === otrAck.text) {\\n\\t\\t\\t\\t\\treturn { ...message, _id, t: 'otr-ack', msg };\\n\\t\\t\\t\\t}\\n\\t\\t\\t} else if (userId !== Meteor.userId()) {\\n\\t\\t\\t\\tconst encryptedAck = await otrRoom.encryptText(ack);\\n\\n\\t\\t\\t\\tvoid sdk.call('updateOTRAck', { message, ack: encryptedAck });\\n\\t\\t\\t}\\n\\n\\t\\t\\treturn { ...message, _id, msg };\\n\\t\\t}\\n\\t\\tif (message.t === 'otr') message.msg = '';\\n\\n\\t\\treturn message;\\n\\t});\\n});\\n\",null],\"names\":[\"_regeneratorRuntime\",\"_objectSpread\",\"isOTRMessage\",\"Meteor\",\"Tracker\",\"OTR\",\"OtrRoomState\",\"sdk\",\"t\",\"onClientBeforeSendMessage\",\"onClientMessageReceived\",\"module\",\"link\",\"default\",\"v\",\"startup\",\"autorun\",\"uid\",\"userId\",\"stream\",\"type\",\"data\",\"roomId\",\"otrRoom\",\"getInstanceByRoomId\",\"onUserStream\",\"use\",\"message\",\"msg\",\"async\",\"_context\",\"prev\",\"next\",\"abrupt\",\"rid\",\"getState\",\"ESTABLISHED\",\"awrap\",\"encrypt\",\"sent\",\"stop\",\"Promise\",\"decrypted\",\"_id\",\"ack\",\"ts\",\"otrAck\",\"encryptedAck\",\"_context2\",\"decrypt\",\"text\",\"encryptText\",\"call\"],\"mappings\":\"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\"}"}