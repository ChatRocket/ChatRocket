{"code":"function module(e,t,r){let n,a,i,l,o,c,d;r.link(\"@babel/runtime/helpers/objectSpread2\",{default(e){n=e}},0),r.export({createUploadsAPI:()=>S}),r.link(\"@rocket.chat/emitter\",{Emitter(e){a=e}},0),r.link(\"@rocket.chat/random\",{Random(e){i=e}},1),r.link(\"../../../app/ui/client/lib/UserAction\",{UserAction(e){l=e},USER_ACTIVITIES(e){o=e}},2),r.link(\"../../../app/utils/client/lib/SDKClient\",{sdk(e){c=e}},3),r.link(\"../errorHandling\",{getErrorMessage(e){d=e}},4);let s=[],p=new a,m=e=>{s=e(s),p.emit(\"update\")},u=()=>s,f=e=>p.on(\"update\",e),g=e=>{p.emit(\"cancelling-\".concat(e))},k=()=>{m(e=>e.filter(e=>!e.error))},E=async(e,t,r,a)=>{let{description:u,msg:f,rid:g,tmid:k,t:E}=t,S=i.id();m(t=>[...t,{id:S,name:(null==a?void 0:a.raw.name)||e.name,percentage:0}]);try{await new Promise((t,i)=>{let d=c.rest.upload(\"/v1/rooms.media/\".concat(g),n({file:e},a&&{content:JSON.stringify(a.encrypted)}),{load:e=>{t(e)},progress:e=>{if(!e.lengthComputable)return;let t=e.loaded/e.total*100;100!==t&&m(e=>e.map(e=>e.id!==S?e:n(n({},e),{},{percentage:Math.round(t)||0})))},error:e=>{m(e=>e.map(e=>e.id!==S?e:n(n({},e),{},{percentage:0,error:Error(d.responseText)}))),i(e)}});d.onload=async()=>{if(d.readyState===d.DONE&&200===d.status){let e;let t=JSON.parse(d.responseText);r&&(e=await r(t.file._id,t.file.url)),await c.rest.post(\"/v1/rooms.mediaConfirm/\".concat(g,\"/\").concat(t.file._id),{msg:f,tmid:k,description:u,t:E,content:e})}},s.length&&l.performContinuously(g,o.USER_UPLOADING,{tmid:k}),p.once(\"cancelling-\".concat(S),()=>{d.abort(),m(e=>e.filter(e=>e.id!==S))})}),m(e=>e.filter(e=>e.id!==S))}catch(e){m(t=>t.map(t=>t.id!==S?t:n(n({},t),{},{percentage:0,error:Error(d(e))})))}finally{s.length||l.stop(g,o.USER_UPLOADING,{tmid:k})}},S=e=>{let{rid:t,tmid:r}=e;return{get:u,subscribe:f,wipeFailedOnes:k,cancel:g,send:(e,n,a,i)=>{let{description:l,msg:o,t:c}=n;return E(e,{description:l,msg:o,rid:t,tmid:r,t:c},a,i)}}}}","map":"{\"version\":3,\"sources\":[\"client/lib/chats/uploads.ts\",\"<anon>\"],\"sourcesContent\":[\"import type { IMessage, IRoom, IE2EEMessage, IUpload } from '@rocket.chat/core-typings';\\nimport { Emitter } from '@rocket.chat/emitter';\\nimport { Random } from '@rocket.chat/random';\\n\\nimport { UserAction, USER_ACTIVITIES } from '../../../app/ui/client/lib/UserAction';\\nimport { sdk } from '../../../app/utils/client/lib/SDKClient';\\nimport { getErrorMessage } from '../errorHandling';\\nimport type { UploadsAPI } from './ChatAPI';\\nimport type { Upload } from './Upload';\\n\\nlet uploads: readonly Upload[] = [];\\n\\nconst emitter = new Emitter<{ update: void; [x: `cancelling-${Upload['id']}`]: void }>();\\n\\nconst updateUploads = (update: (uploads: readonly Upload[]) => readonly Upload[]): void => {\\n\\tuploads = update(uploads);\\n\\temitter.emit('update');\\n};\\n\\nconst get = (): readonly Upload[] => uploads;\\n\\nconst subscribe = (callback: () => void): (() => void) => emitter.on('update', callback);\\n\\nconst cancel = (id: Upload['id']): void => {\\n\\temitter.emit(`cancelling-${id}`);\\n};\\n\\nconst wipeFailedOnes = (): void => {\\n\\tupdateUploads((uploads) => uploads.filter((upload) => !upload.error));\\n};\\n\\nconst send = async (\\n\\tfile: File,\\n\\t{\\n\\t\\tdescription,\\n\\t\\tmsg,\\n\\t\\trid,\\n\\t\\ttmid,\\n\\t\\tt,\\n\\t}: {\\n\\t\\tdescription?: string;\\n\\t\\tmsg?: string;\\n\\t\\trid: string;\\n\\t\\ttmid?: string;\\n\\t\\tt?: IMessage['t'];\\n\\t},\\n\\tgetContent?: (fileId: string, fileUrl: string) => Promise<IE2EEMessage['content']>,\\n\\tfileContent?: { raw: Partial<IUpload>; encrypted: IE2EEMessage['content'] },\\n): Promise<void> => {\\n\\tconst id = Random.id();\\n\\n\\tupdateUploads((uploads) => [\\n\\t\\t...uploads,\\n\\t\\t{\\n\\t\\t\\tid,\\n\\t\\t\\tname: fileContent?.raw.name || file.name,\\n\\t\\t\\tpercentage: 0,\\n\\t\\t},\\n\\t]);\\n\\n\\ttry {\\n\\t\\tawait new Promise((resolve, reject) => {\\n\\t\\t\\tconst xhr = sdk.rest.upload(\\n\\t\\t\\t\\t`/v1/rooms.media/${rid}`,\\n\\t\\t\\t\\t{\\n\\t\\t\\t\\t\\tfile,\\n\\t\\t\\t\\t\\t...(fileContent && {\\n\\t\\t\\t\\t\\t\\tcontent: JSON.stringify(fileContent.encrypted),\\n\\t\\t\\t\\t\\t}),\\n\\t\\t\\t\\t},\\n\\t\\t\\t\\t{\\n\\t\\t\\t\\t\\tload: (event) => {\\n\\t\\t\\t\\t\\t\\tresolve(event);\\n\\t\\t\\t\\t\\t},\\n\\t\\t\\t\\t\\tprogress: (event) => {\\n\\t\\t\\t\\t\\t\\tif (!event.lengthComputable) {\\n\\t\\t\\t\\t\\t\\t\\treturn;\\n\\t\\t\\t\\t\\t\\t}\\n\\t\\t\\t\\t\\t\\tconst progress = (event.loaded / event.total) * 100;\\n\\t\\t\\t\\t\\t\\tif (progress === 100) {\\n\\t\\t\\t\\t\\t\\t\\treturn;\\n\\t\\t\\t\\t\\t\\t}\\n\\n\\t\\t\\t\\t\\t\\tupdateUploads((uploads) =>\\n\\t\\t\\t\\t\\t\\t\\tuploads.map((upload) => {\\n\\t\\t\\t\\t\\t\\t\\t\\tif (upload.id !== id) {\\n\\t\\t\\t\\t\\t\\t\\t\\t\\treturn upload;\\n\\t\\t\\t\\t\\t\\t\\t\\t}\\n\\n\\t\\t\\t\\t\\t\\t\\t\\treturn {\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t...upload,\\n\\t\\t\\t\\t\\t\\t\\t\\t\\tpercentage: Math.round(progress) || 0,\\n\\t\\t\\t\\t\\t\\t\\t\\t};\\n\\t\\t\\t\\t\\t\\t\\t}),\\n\\t\\t\\t\\t\\t\\t);\\n\\t\\t\\t\\t\\t},\\n\\t\\t\\t\\t\\terror: (event) => {\\n\\t\\t\\t\\t\\t\\tupdateUploads((uploads) =>\\n\\t\\t\\t\\t\\t\\t\\tuploads.map((upload) => {\\n\\t\\t\\t\\t\\t\\t\\t\\tif (upload.id !== id) {\\n\\t\\t\\t\\t\\t\\t\\t\\t\\treturn upload;\\n\\t\\t\\t\\t\\t\\t\\t\\t}\\n\\n\\t\\t\\t\\t\\t\\t\\t\\treturn {\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t...upload,\\n\\t\\t\\t\\t\\t\\t\\t\\t\\tpercentage: 0,\\n\\t\\t\\t\\t\\t\\t\\t\\t\\terror: new Error(xhr.responseText),\\n\\t\\t\\t\\t\\t\\t\\t\\t};\\n\\t\\t\\t\\t\\t\\t\\t}),\\n\\t\\t\\t\\t\\t\\t);\\n\\t\\t\\t\\t\\t\\treject(event);\\n\\t\\t\\t\\t\\t},\\n\\t\\t\\t\\t},\\n\\t\\t\\t);\\n\\n\\t\\t\\txhr.onload = async () => {\\n\\t\\t\\t\\tif (xhr.readyState === xhr.DONE && xhr.status === 200) {\\n\\t\\t\\t\\t\\tconst result = JSON.parse(xhr.responseText);\\n\\t\\t\\t\\t\\tlet content;\\n\\t\\t\\t\\t\\tif (getContent) {\\n\\t\\t\\t\\t\\t\\tcontent = await getContent(result.file._id, result.file.url);\\n\\t\\t\\t\\t\\t}\\n\\n\\t\\t\\t\\t\\tawait sdk.rest.post(`/v1/rooms.mediaConfirm/${rid}/${result.file._id}`, {\\n\\t\\t\\t\\t\\t\\tmsg,\\n\\t\\t\\t\\t\\t\\ttmid,\\n\\t\\t\\t\\t\\t\\tdescription,\\n\\t\\t\\t\\t\\t\\tt,\\n\\t\\t\\t\\t\\t\\tcontent,\\n\\t\\t\\t\\t\\t});\\n\\t\\t\\t\\t}\\n\\t\\t\\t};\\n\\n\\t\\t\\tif (uploads.length) {\\n\\t\\t\\t\\tUserAction.performContinuously(rid, USER_ACTIVITIES.USER_UPLOADING, { tmid });\\n\\t\\t\\t}\\n\\n\\t\\t\\temitter.once(`cancelling-${id}`, () => {\\n\\t\\t\\t\\txhr.abort();\\n\\t\\t\\t\\tupdateUploads((uploads) => uploads.filter((upload) => upload.id !== id));\\n\\t\\t\\t});\\n\\t\\t});\\n\\n\\t\\tupdateUploads((uploads) => uploads.filter((upload) => upload.id !== id));\\n\\t} catch (error: unknown) {\\n\\t\\tupdateUploads((uploads) =>\\n\\t\\t\\tuploads.map((upload) => {\\n\\t\\t\\t\\tif (upload.id !== id) {\\n\\t\\t\\t\\t\\treturn upload;\\n\\t\\t\\t\\t}\\n\\n\\t\\t\\t\\treturn {\\n\\t\\t\\t\\t\\t...upload,\\n\\t\\t\\t\\t\\tpercentage: 0,\\n\\t\\t\\t\\t\\terror: new Error(getErrorMessage(error)),\\n\\t\\t\\t\\t};\\n\\t\\t\\t}),\\n\\t\\t);\\n\\t} finally {\\n\\t\\tif (!uploads.length) {\\n\\t\\t\\tUserAction.stop(rid, USER_ACTIVITIES.USER_UPLOADING, { tmid });\\n\\t\\t}\\n\\t}\\n};\\n\\nexport const createUploadsAPI = ({ rid, tmid }: { rid: IRoom['_id']; tmid?: IMessage['_id'] }): UploadsAPI => ({\\n\\tget,\\n\\tsubscribe,\\n\\twipeFailedOnes,\\n\\tcancel,\\n\\tsend: (\\n\\t\\tfile: File,\\n\\t\\t{ description, msg, t }: { description?: string; msg?: string; t?: IMessage['t'] },\\n\\t\\tgetContent?: (fileId: string, fileUrl: string) => Promise<IE2EEMessage['content']>,\\n\\t\\tfileContent?: { raw: Partial<IUpload>; encrypted: IE2EEMessage['content'] },\\n\\t): Promise<void> => send(file, { description, msg, rid, tmid, t }, getContent, fileContent),\\n});\\n\",null],\"names\":[\"_objectSpread\",\"Emitter\",\"Random\",\"UserAction\",\"USER_ACTIVITIES\",\"sdk\",\"getErrorMessage\",\"module\",\"link\",\"default\",\"v\",\"export\",\"createUploadsAPI\",\"uploads\",\"emitter\",\"updateUploads\",\"update\",\"emit\",\"get\",\"subscribe\",\"callback\",\"on\",\"cancel\",\"id\",\"concat\",\"wipeFailedOnes\",\"filter\",\"upload\",\"error\",\"send\",\"file\",\"_ref\",\"getContent\",\"fileContent\",\"description\",\"msg\",\"rid\",\"tmid\",\"t\",\"name\",\"raw\",\"percentage\",\"Promise\",\"resolve\",\"reject\",\"xhr\",\"rest\",\"content\",\"JSON\",\"stringify\",\"encrypted\",\"load\",\"event\",\"progress\",\"lengthComputable\",\"loaded\",\"total\",\"map\",\"Math\",\"round\",\"Error\",\"responseText\",\"onload\",\"readyState\",\"DONE\",\"status\",\"result\",\"parse\",\"_id\",\"url\",\"post\",\"length\",\"performContinuously\",\"USER_UPLOADING\",\"once\",\"abort\",\"stop\",\"_ref2\",\"_ref3\"],\"mappings\":\"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\"}"}