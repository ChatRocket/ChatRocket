{"code":"function module(e,n,r){let i,t,s,o,a,c;r.link(\"meteor/meteor\",{Meteor(e){i=e}},0),r.link(\"../../../../client/lib/rooms/roomCoordinator\",{roomCoordinator(e){t=e}},1),r.link(\"../../../emoji/client\",{emoji(e){s=e}},2),r.link(\"../../../models/client\",{Messages(e){o=e},ChatRoom(e){a=e},Subscriptions(e){c=e}},3),i.methods({async setReaction(e,n){var r;if(!i.userId())throw new i.Error(203,\"User_logged_out\");let d=i.user();if(!(null!=d&&d.username))return!1;let l=o.findOne({_id:n});if(!l)return!1;let u=a.findOne({_id:l.rid});if(!u||l.private||!s.list[e]||t.readOnly(u._id,d)||!c.findOne({rid:l.rid}))return!1;null!==(r=l.reactions)&&void 0!==r&&r[e]&&-1!==l.reactions[e].usernames.indexOf(d.username)?(l.reactions[e].usernames.splice(l.reactions[e].usernames.indexOf(d.username),1),0===l.reactions[e].usernames.length&&delete l.reactions[e],l.reactions&&\"object\"==typeof l.reactions&&0!==Object.keys(l.reactions).length?o.update({_id:n},{$set:{reactions:l.reactions}}):(delete l.reactions,o.update({_id:n},{$unset:{reactions:1}}))):(l.reactions||(l.reactions={}),l.reactions[e]||(l.reactions[e]={usernames:[]}),l.reactions[e].usernames.push(d.username),o.update({_id:n},{$set:{reactions:l.reactions}}))}})}","map":"{\"version\":3,\"sources\":[\"app/reactions/client/methods/setReaction.ts\",\"<anon>\"],\"sourcesContent\":[\"import type { IMessage, IRoom } from '@rocket.chat/core-typings';\\nimport type { ServerMethods } from '@rocket.chat/ddp-client';\\nimport { Meteor } from 'meteor/meteor';\\n\\nimport { roomCoordinator } from '../../../../client/lib/rooms/roomCoordinator';\\nimport { emoji } from '../../../emoji/client';\\nimport { Messages, ChatRoom, Subscriptions } from '../../../models/client';\\n\\nMeteor.methods<ServerMethods>({\\n\\tasync setReaction(reaction, messageId) {\\n\\t\\tif (!Meteor.userId()) {\\n\\t\\t\\tthrow new Meteor.Error(203, 'User_logged_out');\\n\\t\\t}\\n\\n\\t\\tconst user = Meteor.user();\\n\\n\\t\\tif (!user?.username) {\\n\\t\\t\\treturn false;\\n\\t\\t}\\n\\n\\t\\tconst message: IMessage | undefined = Messages.findOne({ _id: messageId });\\n\\t\\tif (!message) {\\n\\t\\t\\treturn false;\\n\\t\\t}\\n\\n\\t\\tconst room: IRoom | undefined = ChatRoom.findOne({ _id: message.rid });\\n\\t\\tif (!room) {\\n\\t\\t\\treturn false;\\n\\t\\t}\\n\\n\\t\\tif (message.private) {\\n\\t\\t\\treturn false;\\n\\t\\t}\\n\\n\\t\\tif (!emoji.list[reaction]) {\\n\\t\\t\\treturn false;\\n\\t\\t}\\n\\n\\t\\tif (roomCoordinator.readOnly(room._id, user)) {\\n\\t\\t\\treturn false;\\n\\t\\t}\\n\\n\\t\\tif (!Subscriptions.findOne({ rid: message.rid })) {\\n\\t\\t\\treturn false;\\n\\t\\t}\\n\\n\\t\\tif (message.reactions?.[reaction] && message.reactions[reaction].usernames.indexOf(user.username) !== -1) {\\n\\t\\t\\tmessage.reactions[reaction].usernames.splice(message.reactions[reaction].usernames.indexOf(user.username), 1);\\n\\n\\t\\t\\tif (message.reactions[reaction].usernames.length === 0) {\\n\\t\\t\\t\\tdelete message.reactions[reaction];\\n\\t\\t\\t}\\n\\n\\t\\t\\tif (!message.reactions || typeof message.reactions !== 'object' || Object.keys(message.reactions).length === 0) {\\n\\t\\t\\t\\tdelete message.reactions;\\n\\t\\t\\t\\tMessages.update({ _id: messageId }, { $unset: { reactions: 1 } });\\n\\t\\t\\t} else {\\n\\t\\t\\t\\tMessages.update({ _id: messageId }, { $set: { reactions: message.reactions } });\\n\\t\\t\\t}\\n\\t\\t} else {\\n\\t\\t\\tif (!message.reactions) {\\n\\t\\t\\t\\tmessage.reactions = {};\\n\\t\\t\\t}\\n\\t\\t\\tif (!message.reactions[reaction]) {\\n\\t\\t\\t\\tmessage.reactions[reaction] = {\\n\\t\\t\\t\\t\\tusernames: [],\\n\\t\\t\\t\\t};\\n\\t\\t\\t}\\n\\t\\t\\tmessage.reactions[reaction].usernames.push(user.username);\\n\\n\\t\\t\\tMessages.update({ _id: messageId }, { $set: { reactions: message.reactions } });\\n\\t\\t}\\n\\t},\\n});\\n\",null],\"names\":[\"Meteor\",\"roomCoordinator\",\"emoji\",\"Messages\",\"ChatRoom\",\"Subscriptions\",\"module\",\"link\",\"v\",\"methods\",\"setReaction\",\"reaction\",\"messageId\",\"_message$reactions\",\"userId\",\"Error\",\"user\",\"username\",\"message\",\"findOne\",\"_id\",\"room\",\"rid\",\"private\",\"list\",\"readOnly\",\"reactions\",\"usernames\",\"indexOf\",\"splice\",\"length\",\"Object\",\"keys\",\"update\",\"$set\",\"$unset\",\"push\"],\"mappings\":\"2BAEAA,EAAuCC,EAAAC,EAAAC,EAAAC,EAAAC,EAA9BC,EAAQC,IAAA,CAAM,gBAAgB,CAAAP,OAAAQ,CAAA,EAAAR,EAAAQ,CAAA,CAAA,EAAA,GAAAF,EAAAC,IAAA,CAAA,+CAAA,CAAAN,gBAAAO,CAAA,EAAAP,EAAAO,CAAA,CAAA,EAAA,GAAAF,EAAAC,IAAA,CAAA,wBAAA,CAAAL,MAAAM,CAAA,EAAAN,EAAAM,CAAA,CAAA,EAAA,GAAAF,EAAAC,IAAA,CAAA,yBAAA,CAAAJ,SAAAK,CAAA,EAAAL,EAAAK,CAAA,EAAAJ,SAAAI,CAAA,EAAAJ,EAAAI,CAAA,EAAAH,cAAAG,CAAA,EAAAH,EAAAG,CAAA,CAAA,EAAA,GAMvCR,EAAOS,OAAO,CAAgB,CAC7B,MAAMC,YAAYC,CAAQ,CAAEC,CAAS,EAAA,IAAAC,EACpC,GAAI,CAACb,EAAOc,MAAM,GACjB,MAAM,IAAId,EAAOe,KAAK,CAAC,IAAK,mBAG7B,IAAMC,EAAOhB,EAAOgB,IAAI,GAExB,GAAI,CAACA,CAAAA,MAAAA,GAAAA,EAAMC,QAAQ,AAARA,EACV,MAAO,CAAA,EAGR,IAAMC,EAAgCf,EAASgB,OAAO,CAAC,CAAEC,IAAKR,CAAS,GACvE,GAAI,CAACM,EACJ,MAAO,CAAA,EAGR,IAAMG,EAA0BjB,EAASe,OAAO,CAAC,CAAEC,IAAKF,EAAQI,GAAAA,AAAG,GACnE,GAAI,CAACD,GAIDH,EAAQK,OAAO,EAIf,CAACrB,EAAMsB,IAAI,CAACb,EAAS,EAIrBV,EAAgBwB,QAAQ,CAACJ,EAAKD,GAAG,CAAEJ,IAInC,CAACX,EAAcc,OAAO,CAAC,CAAEG,IAAKJ,EAAQI,GAAAA,AAAG,GAf5C,MAAO,CAAA,CAmBJ,AAAiB,QAAjBT,CAAAA,EAAAK,EAAQQ,SAAS,AAATA,GAASb,AAAA,KAAA,IAAAA,GAAjBA,CAAA,CAAoBF,EAAS,EAAIO,AAAiE,KAAjEA,EAAQQ,SAAS,CAACf,EAAS,CAACgB,SAAS,CAACC,OAAO,CAACZ,EAAKC,QAAQ,GAC/FC,EAAQQ,SAAS,CAACf,EAAS,CAACgB,SAAS,CAACE,MAAM,CAACX,EAAQQ,SAAS,CAACf,EAAS,CAACgB,SAAS,CAACC,OAAO,CAACZ,EAAKC,QAAQ,EAAG,GAEtD,IAAjDC,EAAQQ,SAAS,CAACf,EAAS,CAACgB,SAAS,CAACG,MAAM,EAC/C,OAAOZ,EAAQQ,SAAS,CAACf,EAAS,CAG/B,AAACO,EAAQQ,SAAS,EAAI,AAA6B,UAA7B,OAAOR,EAAQQ,SAAS,EAAiBK,AAA0C,IAA1CA,OAAOC,IAAI,CAACd,EAAQQ,SAAS,EAAEI,MAAM,CAIvG3B,EAAS8B,MAAM,CAAC,CAAEb,IAAKR,CAAS,EAAI,CAAEsB,KAAM,CAAER,UAAWR,EAAQQ,SAAAA,AAAS,CAAE,IAH5E,OAAOR,EAAQQ,SAAS,CACxBvB,EAAS8B,MAAM,CAAC,CAAEb,IAAKR,CAAS,EAAI,CAAEuB,OAAQ,CAAET,UAAW,CAAC,CAAE,MAK1DR,EAAQQ,SAAS,EACrBR,CAAAA,EAAQQ,SAAS,CAAG,CAAA,CAAA,EAEhBR,EAAQQ,SAAS,CAACf,EAAS,EAC/BO,CAAAA,EAAQQ,SAAS,CAACf,EAAS,CAAG,CAC7BgB,UAAW,EAAA,GAGbT,EAAQQ,SAAS,CAACf,EAAS,CAACgB,SAAS,CAACS,IAAI,CAACpB,EAAKC,QAAQ,EAExDd,EAAS8B,MAAM,CAAC,CAAEb,IAAKR,CAAS,EAAI,CAAEsB,KAAM,CAAER,UAAWR,EAAQQ,SAAAA,AAAS,CAAE,GAE9E\"}"}