{"code":"function module(e,n,t){t.link(\"@babel/runtime/regenerator\",{default:function(e){o=e}},0),t.link(\"@babel/runtime/helpers/slicedToArray\",{default:function(e){i=e}},1),t.export({useVoipClient:function(){return w},isOutboundClient:function(){return x}}),t.link(\"@rocket.chat/core-typings\",{WorkflowTypes:function(e){r=e}},0),t.link(\"@rocket.chat/fuselage-hooks\",{useSafely:function(e){s=e}},1),t.link(\"@rocket.chat/ui-contexts\",{useUser:function(e){u=e},useSetting:function(e){c=e},useEndpoint:function(e){l=e},useStream:function(e){a=e}},2),t.link(\"jsrsasign\",{KJUR:function(e){f=e}},3),t.link(\"react\",{useEffect:function(e){p=e},useState:function(e){d=e}},4),t.link(\"../lib/voip/EEVoipClient\",{EEVoipClient:function(e){v=e}},5),t.link(\"../lib/voip/VoIPUser\",{VoIPUser:function(e){b=e}},6),t.link(\"../providers/CallProvider/hooks/useWebRtcServers\",{useWebRtcServers:function(e){k=e}},7),t.link(\"./useHasLicenseModule\",{useHasLicenseModule:function(e){g=e}},8);var o,i,r,s,u,c,l,a,f,p,d,v,b,k,g,h={},w=function(){var e=!!c(\"VoIP_Enabled\"),n=s(d(!0)),t=i(n,2),w=t[0],x=t[1],E=c(\"VoIP_Retry_Count\"),S=c(\"VoIP_Enable_Keep_Alive_For_Unstable_Networks\"),_=l(\"GET\",\"/v1/connector.extension.getRegistrationInfoByUserId\"),C=l(\"GET\",\"/v1/voip/queues.getMembershipSubscription\"),U=u(),y=a(\"notify-logged\"),R=k(),m=s(d({})),I=i(m,2),P=I[0],V=I[1],T=g(\"voip-enterprise\"),N=e&&w;return p(function(){if(U)return y(\"voip.statuschanged\",function(e){x(e)})},[V,x,y,U]),p(function(){var e,n=null==U?void 0:U._id,t=null==U?void 0:U.extension;if(!n||!t||!N){V(h);return}return _({id:n}).then(function(n){var t,i,s,u,c,l=t=\"string\"==typeof(null==n?void 0:n.result)?null===(i=f.jws.JWS.parse(n.result).payloadObj)||void 0===i?void 0:i.context:n,a=l.extensionDetails,p=a.extension,d=a.password,k=l.callServerConfig.websocketPath;o.async(function(n){for(;;)switch(n.prev=n.next){case 0:return n.prev=0,s=new URL(k),n.next=4,o.awrap(C({extension:p}));case 4:return u=n.sent,c={authUserName:p,authPassword:d,sipRegistrarHostnameOrIP:s.host,webSocketURI:k,enableVideo:!0,iceServers:R,connectionRetryCount:Number(E),enableKeepAliveUsingOptionsForUnstableNetworks:!!S},n.next=8,o.awrap(T?v.create(c):b.create(c));case 8:(e=n.sent).setWorkflowMode(r.CONTACT_CENTER_USER),e.setMembershipSubscription(u),V({voipClient:e,registrationInfo:t}),n.next=17;break;case 14:n.prev=14,n.t0=n.catch(0),V({error:n.t0});case 17:case\"end\":return n.stop()}},null,null,[[0,14]],Promise)},function(e){V({error:e})}),function(){e&&e.clear()}},[R,_,V,C,N,null==U?void 0:U._id,null==U?void 0:U.extension,E,S,T]),P},x=function(e){return e instanceof v}}","map":"{\"version\":3,\"sources\":[\"client/hooks/useVoipClient.ts\",\"<anon>\"],\"sourcesContent\":[\"import type { IRegistrationInfo } from '@rocket.chat/core-typings';\\nimport { WorkflowTypes } from '@rocket.chat/core-typings';\\nimport { useSafely } from '@rocket.chat/fuselage-hooks';\\nimport { useUser, useSetting, useEndpoint, useStream } from '@rocket.chat/ui-contexts';\\nimport { KJUR } from 'jsrsasign';\\nimport { useEffect, useState } from 'react';\\n\\nimport { EEVoipClient } from '../lib/voip/EEVoipClient';\\nimport { VoIPUser } from '../lib/voip/VoIPUser';\\nimport { useWebRtcServers } from '../providers/CallProvider/hooks/useWebRtcServers';\\nimport { useHasLicenseModule } from './useHasLicenseModule';\\n\\ntype UseVoipClientResult = {\\n\\tvoipClient?: VoIPUser;\\n\\tregistrationInfo?: IRegistrationInfo;\\n\\terror?: Error | unknown;\\n};\\n\\nconst empty = {};\\n\\nconst isSignedResponse = (data: any): data is { result: string } => typeof data?.result === 'string';\\n\\n// Currently we only support the websocket connection and the SIP proxy connection being from the same host,\\n// we need to add a new setting for SIP proxy if we want to support different hosts for them.\\nexport const useVoipClient = (): UseVoipClientResult => {\\n\\tconst settingVoipEnabled = Boolean(useSetting('VoIP_Enabled'));\\n\\n\\tconst [voipConnectorEnabled, setVoipConnectorEnabled] = useSafely(useState(true));\\n\\n\\tconst voipRetryCount = useSetting('VoIP_Retry_Count');\\n\\tconst enableKeepAlive = useSetting('VoIP_Enable_Keep_Alive_For_Unstable_Networks');\\n\\tconst registrationInfo = useEndpoint('GET', '/v1/connector.extension.getRegistrationInfoByUserId');\\n\\tconst membership = useEndpoint('GET', '/v1/voip/queues.getMembershipSubscription');\\n\\tconst user = useUser();\\n\\tconst subscribeToNotifyLoggedIn = useStream('notify-logged');\\n\\tconst iceServers = useWebRtcServers();\\n\\tconst [result, setResult] = useSafely(useState<UseVoipClientResult>({}));\\n\\n\\tconst isEE = useHasLicenseModule('voip-enterprise');\\n\\tconst voipEnabled = settingVoipEnabled && voipConnectorEnabled;\\n\\n\\tuseEffect(() => {\\n\\t\\tif (user) {\\n\\t\\t\\treturn subscribeToNotifyLoggedIn(`voip.statuschanged`, (enabled: boolean): void => {\\n\\t\\t\\t\\tsetVoipConnectorEnabled(enabled);\\n\\t\\t\\t});\\n\\t\\t}\\n\\t}, [setResult, setVoipConnectorEnabled, subscribeToNotifyLoggedIn, user]);\\n\\n\\tuseEffect(() => {\\n\\t\\tconst uid = user?._id;\\n\\t\\tconst userExtension = user?.extension;\\n\\n\\t\\tif (!uid || !userExtension || !voipEnabled) {\\n\\t\\t\\tsetResult(empty);\\n\\t\\t\\treturn;\\n\\t\\t}\\n\\t\\tlet client: VoIPUser;\\n\\t\\tregistrationInfo({ id: uid }).then(\\n\\t\\t\\t(data) => {\\n\\t\\t\\t\\tlet parsedData: IRegistrationInfo;\\n\\t\\t\\t\\tif (isSignedResponse(data)) {\\n\\t\\t\\t\\t\\tconst result = KJUR.jws.JWS.parse(data.result);\\n\\t\\t\\t\\t\\tparsedData = (result.payloadObj as any)?.context as IRegistrationInfo;\\n\\t\\t\\t\\t} else {\\n\\t\\t\\t\\t\\tparsedData = data;\\n\\t\\t\\t\\t}\\n\\n\\t\\t\\t\\tconst {\\n\\t\\t\\t\\t\\textensionDetails: { extension, password },\\n\\t\\t\\t\\t\\tcallServerConfig: { websocketPath },\\n\\t\\t\\t\\t} = parsedData;\\n\\n\\t\\t\\t\\t(async (): Promise<void> => {\\n\\t\\t\\t\\t\\ttry {\\n\\t\\t\\t\\t\\t\\tconst wsURL = new URL(websocketPath);\\n\\t\\t\\t\\t\\t\\tconst subscription = await membership({ extension });\\n\\n\\t\\t\\t\\t\\t\\tconst config = {\\n\\t\\t\\t\\t\\t\\t\\tauthUserName: extension,\\n\\t\\t\\t\\t\\t\\t\\tauthPassword: password,\\n\\t\\t\\t\\t\\t\\t\\tsipRegistrarHostnameOrIP: wsURL.host,\\n\\t\\t\\t\\t\\t\\t\\twebSocketURI: websocketPath,\\n\\t\\t\\t\\t\\t\\t\\tenableVideo: true,\\n\\t\\t\\t\\t\\t\\t\\ticeServers,\\n\\t\\t\\t\\t\\t\\t\\tconnectionRetryCount: Number(voipRetryCount),\\n\\t\\t\\t\\t\\t\\t\\tenableKeepAliveUsingOptionsForUnstableNetworks: Boolean(enableKeepAlive),\\n\\t\\t\\t\\t\\t\\t};\\n\\n\\t\\t\\t\\t\\t\\tclient = await (isEE ? EEVoipClient.create(config) : VoIPUser.create(config));\\n\\n\\t\\t\\t\\t\\t\\t// Today we are hardcoding workflow mode.\\n\\t\\t\\t\\t\\t\\t// In future, this should be ready from configuration\\n\\t\\t\\t\\t\\t\\tclient.setWorkflowMode(WorkflowTypes.CONTACT_CENTER_USER);\\n\\t\\t\\t\\t\\t\\tclient.setMembershipSubscription(subscription);\\n\\t\\t\\t\\t\\t\\tsetResult({ voipClient: client, registrationInfo: parsedData });\\n\\t\\t\\t\\t\\t} catch (error) {\\n\\t\\t\\t\\t\\t\\tsetResult({ error });\\n\\t\\t\\t\\t\\t}\\n\\t\\t\\t\\t})();\\n\\t\\t\\t},\\n\\t\\t\\t(error: Error) => {\\n\\t\\t\\t\\tsetResult({ error });\\n\\t\\t\\t},\\n\\t\\t);\\n\\t\\treturn (): void => {\\n\\t\\t\\tif (client) {\\n\\t\\t\\t\\tclient.clear();\\n\\t\\t\\t}\\n\\t\\t};\\n\\t}, [iceServers, registrationInfo, setResult, membership, voipEnabled, user?._id, user?.extension, voipRetryCount, enableKeepAlive, isEE]);\\n\\n\\treturn result;\\n};\\n\\nexport const isOutboundClient = (client: VoIPUser | undefined): client is EEVoipClient => client instanceof EEVoipClient;\\n\",null],\"names\":[\"module\",\"link\",\"default\",\"v\",\"_regeneratorRuntime\",\"_slicedToArray\",\"export\",\"useVoipClient\",\"isOutboundClient\",\"WorkflowTypes\",\"useSafely\",\"useUser\",\"useSetting\",\"useEndpoint\",\"useStream\",\"KJUR\",\"useEffect\",\"useState\",\"EEVoipClient\",\"VoIPUser\",\"useWebRtcServers\",\"useHasLicenseModule\",\"empty\",\"settingVoipEnabled\",\"Boolean\",\"_useSafely\",\"_useSafely2\",\"voipConnectorEnabled\",\"setVoipConnectorEnabled\",\"voipRetryCount\",\"enableKeepAlive\",\"registrationInfo\",\"membership\",\"user\",\"subscribeToNotifyLoggedIn\",\"iceServers\",\"_useSafely3\",\"_useSafely4\",\"result\",\"setResult\",\"isEE\",\"voipEnabled\",\"enabled\",\"client\",\"uid\",\"_id\",\"userExtension\",\"extension\",\"id\",\"then\",\"data\",\"parsedData\",\"_result$payloadObj\",\"wsURL\",\"subscription\",\"config\",\"_parsedData\",\"jws\",\"JWS\",\"parse\",\"payloadObj\",\"context\",\"_parsedData$extension\",\"extensionDetails\",\"password\",\"websocketPath\",\"callServerConfig\",\"async\",\"_context\",\"prev\",\"next\",\"URL\",\"awrap\",\"sent\",\"authUserName\",\"authPassword\",\"sipRegistrarHostnameOrIP\",\"host\",\"webSocketURI\",\"enableVideo\",\"connectionRetryCount\",\"Number\",\"enableKeepAliveUsingOptionsForUnstableNetworks\",\"create\",\"setWorkflowMode\",\"CONTACT_CENTER_USER\",\"setMembershipSubscription\",\"voipClient\",\"t0\",\"error\",\"stop\",\"Promise\",\"clear\"],\"mappings\":\"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\"}"}