{"code":"function module(e,t,n){let l,i,o,r,s;n.export({USER_ACTIVITIES:()=>c,UserAction:()=>S}),n.link(\"lodash\",{debounce(e){l=e}},0),n.link(\"meteor/meteor\",{Meteor(e){i=e}},1),n.link(\"meteor/reactive-dict\",{ReactiveDict(e){o=e}},2),n.link(\"../../../settings/client\",{settings(e){r=e}},3),n.link(\"../../../utils/client/lib/SDKClient\",{sdk(e){s=e}},4);let a=\"user-activity\",c={USER_RECORDING:\"user-recording\",USER_TYPING:\"user-typing\",USER_UPLOADING:\"user-uploading\",USER_PLAYING:\"user-playing\"},d=new Map,u=new Map,g=new Map,m=new Map,p=new Map,f=new o,v=function(e){return e?r.get(\"UI_Use_Real_Name\")?e.name:e.username:void 0},w=l(async(e,t)=>{let n=m.get((null==t?void 0:t.tmid)||e)||new Set;s.publish(\"notify-room\",[\"\".concat(e,\"/\").concat(a),v(i.user()),[...n],t])},500),S=new class{addStream(e){if(p.get(e))throw Error(\"UserAction - addStream should only be called once per room\");let t=function(t,n,l){let o=i.users.findOne(i.userId()||void 0,{fields:{name:1,username:1}});t!==v(o)&&function e(t,n,l,i){t=(null==i?void 0:i.tmid)||t;let o=f.get(t)||{};for(let[,r]of Object.entries(c)){o[r]=o[r]||new Map;let s=o[r],a=s[n];a&&clearTimeout(a),l.includes(r)?(l.splice(l.indexOf(r),1),s[n]=setTimeout(()=>e(t,n,l,i),15e3)):delete s[n]}f.set(t,o)}(e,t,n,l)};p.set(e,t);let{stop:n}=s.stream(\"notify-room\",[\"\".concat(e,\"/\").concat(a)],t);return()=>{p.get(e)&&(n(),p.delete(e))}}performContinuously(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},l=(null==n?void 0:n.tmid)||e,i=\"\".concat(t,\"-\").concat(l);g.get(i)||(this.start(e,t,n),g.set(i,setInterval(()=>{this.start(e,t,n)},5e3)))}start(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},l=(null==n?void 0:n.tmid)||e,i=\"\".concat(t,\"-\").concat(l);if(u.get(i))return;u.set(i,setTimeout(()=>{clearTimeout(u.get(i)),u.delete(i)},5e3));let o=m.get(l)||new Set;o.add(t),m.set(l,o),w(e,n),d.get(i)&&(clearTimeout(d.get(i)),d.delete(i)),d.set(i,setTimeout(()=>this.stop(l,t,n),15e3)),d.get(i)}stop(e,t,n){let l=(null==n?void 0:n.tmid)||e,i=\"\".concat(t,\"-\").concat(l);d.get(i)&&(clearTimeout(d.get(i)),d.delete(i)),u.get(i)&&(clearTimeout(u.get(i)),u.delete(i)),g.get(i)&&(clearInterval(g.get(i)),g.delete(i));let o=m.get(l)||new Set;o.delete(t),m.set(l,o),w(e,n)}get(e){return f.get(e)}}}","map":"{\"version\":3,\"sources\":[\"app/ui/client/lib/UserAction.ts\",\"<anon>\"],\"sourcesContent\":[\"import type { IExtras, IRoomActivity, IActionsObject, IUser } from '@rocket.chat/core-typings';\\nimport { debounce } from 'lodash';\\nimport { Meteor } from 'meteor/meteor';\\nimport { ReactiveDict } from 'meteor/reactive-dict';\\n\\nimport { settings } from '../../../settings/client';\\nimport { sdk } from '../../../utils/client/lib/SDKClient';\\n\\nconst TIMEOUT = 15000;\\nconst RENEW = TIMEOUT / 3;\\n\\nconst USER_ACTIVITY = 'user-activity';\\n\\nexport const USER_ACTIVITIES = {\\n\\tUSER_RECORDING: 'user-recording',\\n\\tUSER_TYPING: 'user-typing',\\n\\tUSER_UPLOADING: 'user-uploading',\\n\\tUSER_PLAYING: 'user-playing',\\n};\\n\\nconst activityTimeouts = new Map();\\nconst activityRenews = new Map();\\nconst continuingIntervals = new Map();\\nconst roomActivities = new Map<string, Set<string>>();\\nconst rooms = new Map<string, (username: string, activityType: string[], extras?: object | undefined) => void>();\\n\\nconst performingUsers = new ReactiveDict<IActionsObject>();\\n\\nconst shownName = function (user: IUser | null | undefined): string | undefined {\\n\\tif (!user) {\\n\\t\\treturn;\\n\\t}\\n\\tif (settings.get('UI_Use_Real_Name')) {\\n\\t\\treturn user.name;\\n\\t}\\n\\treturn user.username;\\n};\\n\\nconst emitActivities = debounce(async (rid: string, extras: IExtras): Promise<void> => {\\n\\tconst activities = roomActivities.get(extras?.tmid || rid) || new Set();\\n\\tsdk.publish('notify-room', [`${rid}/${USER_ACTIVITY}`, shownName(Meteor.user() as unknown as IUser), [...activities], extras]);\\n}, 500);\\n\\nfunction handleStreamAction(rid: string, username: string, activityTypes: string[], extras?: IExtras): void {\\n\\trid = extras?.tmid || rid;\\n\\tconst roomActivities = performingUsers.get(rid) || {};\\n\\n\\tfor (const [, activity] of Object.entries(USER_ACTIVITIES)) {\\n\\t\\troomActivities[activity] = roomActivities[activity] || new Map();\\n\\t\\tconst users = roomActivities[activity];\\n\\t\\tconst timeout = users[username];\\n\\n\\t\\tif (timeout) {\\n\\t\\t\\tclearTimeout(timeout);\\n\\t\\t}\\n\\n\\t\\tif (activityTypes.includes(activity)) {\\n\\t\\t\\tactivityTypes.splice(activityTypes.indexOf(activity), 1);\\n\\t\\t\\tusers[username] = setTimeout(() => handleStreamAction(rid, username, activityTypes, extras), TIMEOUT);\\n\\t\\t} else {\\n\\t\\t\\tdelete users[username];\\n\\t\\t}\\n\\t}\\n\\n\\tperformingUsers.set(rid, roomActivities);\\n}\\nexport const UserAction = new (class {\\n\\taddStream(rid: string): () => void {\\n\\t\\tif (rooms.get(rid)) {\\n\\t\\t\\tthrow new Error('UserAction - addStream should only be called once per room');\\n\\t\\t}\\n\\n\\t\\tconst handler = function (username: string, activityType: string[], extras?: object): void {\\n\\t\\t\\tconst user = Meteor.users.findOne(Meteor.userId() || undefined, {\\n\\t\\t\\t\\tfields: { name: 1, username: 1 },\\n\\t\\t\\t}) as IUser;\\n\\t\\t\\tif (username === shownName(user)) {\\n\\t\\t\\t\\treturn;\\n\\t\\t\\t}\\n\\t\\t\\thandleStreamAction(rid, username, activityType, extras);\\n\\t\\t};\\n\\t\\trooms.set(rid, handler);\\n\\n\\t\\tconst { stop } = sdk.stream('notify-room', [`${rid}/${USER_ACTIVITY}`], handler);\\n\\t\\treturn () => {\\n\\t\\t\\tif (!rooms.get(rid)) {\\n\\t\\t\\t\\treturn;\\n\\t\\t\\t}\\n\\t\\t\\tstop();\\n\\t\\t\\trooms.delete(rid);\\n\\t\\t};\\n\\t}\\n\\n\\tperformContinuously(rid: string, activityType: string, extras: IExtras = {}): void {\\n\\t\\tconst trid = extras?.tmid || rid;\\n\\t\\tconst key = `${activityType}-${trid}`;\\n\\n\\t\\tif (continuingIntervals.get(key)) {\\n\\t\\t\\treturn;\\n\\t\\t}\\n\\t\\tthis.start(rid, activityType, extras);\\n\\n\\t\\tcontinuingIntervals.set(\\n\\t\\t\\tkey,\\n\\t\\t\\tsetInterval(() => {\\n\\t\\t\\t\\tthis.start(rid, activityType, extras);\\n\\t\\t\\t}, RENEW),\\n\\t\\t);\\n\\t}\\n\\n\\tstart(rid: string, activityType: string, extras: IExtras = {}): void {\\n\\t\\tconst trid = extras?.tmid || rid;\\n\\t\\tconst key = `${activityType}-${trid}`;\\n\\n\\t\\tif (activityRenews.get(key)) {\\n\\t\\t\\treturn;\\n\\t\\t}\\n\\n\\t\\tactivityRenews.set(\\n\\t\\t\\tkey,\\n\\t\\t\\tsetTimeout(() => {\\n\\t\\t\\t\\tclearTimeout(activityRenews.get(key));\\n\\t\\t\\t\\tactivityRenews.delete(key);\\n\\t\\t\\t}, RENEW),\\n\\t\\t);\\n\\n\\t\\tconst activities = roomActivities.get(trid) || new Set();\\n\\t\\tactivities.add(activityType);\\n\\t\\troomActivities.set(trid, activities);\\n\\n\\t\\tvoid emitActivities(rid, extras);\\n\\n\\t\\tif (activityTimeouts.get(key)) {\\n\\t\\t\\tclearTimeout(activityTimeouts.get(key));\\n\\t\\t\\tactivityTimeouts.delete(key);\\n\\t\\t}\\n\\n\\t\\tactivityTimeouts.set(\\n\\t\\t\\tkey,\\n\\t\\t\\tsetTimeout(() => this.stop(trid, activityType, extras), TIMEOUT),\\n\\t\\t);\\n\\t\\tactivityTimeouts.get(key);\\n\\t}\\n\\n\\tstop(rid: string, activityType: string, extras: IExtras): void {\\n\\t\\tconst trid = extras?.tmid || rid;\\n\\t\\tconst key = `${activityType}-${trid}`;\\n\\n\\t\\tif (activityTimeouts.get(key)) {\\n\\t\\t\\tclearTimeout(activityTimeouts.get(key));\\n\\t\\t\\tactivityTimeouts.delete(key);\\n\\t\\t}\\n\\t\\tif (activityRenews.get(key)) {\\n\\t\\t\\tclearTimeout(activityRenews.get(key));\\n\\t\\t\\tactivityRenews.delete(key);\\n\\t\\t}\\n\\t\\tif (continuingIntervals.get(key)) {\\n\\t\\t\\tclearInterval(continuingIntervals.get(key));\\n\\t\\t\\tcontinuingIntervals.delete(key);\\n\\t\\t}\\n\\n\\t\\tconst activities = roomActivities.get(trid) || new Set();\\n\\t\\tactivities.delete(activityType);\\n\\t\\troomActivities.set(trid, activities);\\n\\t\\tvoid emitActivities(rid, extras);\\n\\t}\\n\\n\\tget(roomId: string): IRoomActivity | undefined {\\n\\t\\treturn performingUsers.get(roomId);\\n\\t}\\n})();\\n\",null],\"names\":[\"debounce\",\"Meteor\",\"ReactiveDict\",\"settings\",\"sdk\",\"module\",\"export\",\"USER_ACTIVITIES\",\"UserAction\",\"link\",\"v\",\"USER_ACTIVITY\",\"USER_RECORDING\",\"USER_TYPING\",\"USER_UPLOADING\",\"USER_PLAYING\",\"activityTimeouts\",\"Map\",\"activityRenews\",\"continuingIntervals\",\"roomActivities\",\"rooms\",\"performingUsers\",\"shownName\",\"user\",\"get\",\"name\",\"username\",\"emitActivities\",\"rid\",\"extras\",\"activities\",\"tmid\",\"Set\",\"publish\",\"concat\",\"addStream\",\"Error\",\"handler\",\"activityType\",\"users\",\"findOne\",\"userId\",\"undefined\",\"fields\",\"handleStreamAction\",\"activityTypes\",\"activity\",\"Object\",\"entries\",\"timeout\",\"clearTimeout\",\"includes\",\"splice\",\"indexOf\",\"setTimeout\",\"set\",\"stop\",\"stream\",\"delete\",\"performContinuously\",\"arguments\",\"length\",\"trid\",\"key\",\"start\",\"setInterval\",\"TIMEOUT\",\"add\",\"clearInterval\",\"roomId\"],\"mappings\":\"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\"}"}