{"code":"function module(e,t,i){let s,n,r,o,a,h,c,d,l,u,g,m;i.link(\"@rocket.chat/emitter\",{Emitter(e){s=e}},0),i.link(\"sip.js\",{Registerer(e){n=e},RequestPendingError(e){r=e},SessionState(e){o=e},UserAgent(e){a=e},Invitation(e){h=e},Inviter(e){c=e},RegistererState(e){d=e},UserAgentState(e){l=e}},1),i.link(\"sip.js/lib/platform/web\",{SessionDescriptionHandler(e){u=e}},2),i.link(\"./LocalStream\",{default(e){g=e}},3),i.link(\"./RemoteStream\",{default(e){m=e}},4);var f=this&&this.__awaiter||function(e,t,i,s){return new(i||(i=Promise))(function(n,r){function o(e){try{h(s.next(e))}catch(e){r(e)}}function a(e){try{h(s.throw(e))}catch(e){r(e)}}function h(e){var t;e.done?n(e.value):((t=e.value)instanceof i?t:new i(function(e){e(t)})).then(o,a)}h((s=s.apply(e,t||[])).next())})},v=this&&this.__rest||function(e,t){var i={};for(var s in e)Object.prototype.hasOwnProperty.call(e,s)&&0>t.indexOf(s)&&(i[s]=e[s]);if(null!=e&&\"function\"==typeof Object.getOwnPropertySymbols)for(var n=0,s=Object.getOwnPropertySymbols(e);n<s.length;n++)0>t.indexOf(s[n])&&Object.prototype.propertyIsEnumerable.call(e,s[n])&&(i[s[n]]=e[s[n]]);return i};class p extends s{constructor(e,t){super(),this.config=e,this.held=!1,this.muted=!1,this.online=!0,this.error=null,this.contactInfo=null,this.register=()=>f(this,void 0,void 0,function*(){var e;yield null===(e=this.registerer)||void 0===e?void 0:e.register({requestDelegate:{onAccept:this.onRegistrationAccepted,onReject:this.onRegistrationRejected}})}),this.unregister=()=>f(this,void 0,void 0,function*(){var e;yield null===(e=this.registerer)||void 0===e?void 0:e.unregister({all:!0,requestDelegate:{onAccept:this.onUnregistrationAccepted,onReject:this.onUnregistrationRejected}})}),this.call=(e,t)=>f(this,void 0,void 0,function*(){if(!e)throw Error(\"Invalid URI\");if(this.session)throw Error(\"Session already exists\");if(!this.userAgent)throw Error(\"No User Agent.\");t&&this.switchMediaRenderer(t);let i=this.makeURI(e);if(!i)throw Error(`Failed to create valid URI ${e}`);let s=new c(this.userAgent,i,{sessionDescriptionHandlerOptions:{constraints:{audio:!0,video:!1}}});yield this.sendInvite(s)}),this.transfer=e=>f(this,void 0,void 0,function*(){if(!e)throw Error(\"Invalid URI\");if(!this.session)throw Error(\"No active call\");if(!this.userAgent)throw Error(\"No User Agent.\");let t=this.makeURI(e);if(!t)throw Error(`Failed to create valid URI ${e}`);yield this.session.refer(t,{requestDelegate:{onAccept:()=>this.sendContactUpdateMessage(t)}})}),this.answer=()=>{if(!(this.session instanceof h))throw Error(\"Session not instance of Invitation.\");return this.session.accept({sessionDescriptionHandlerOptions:{constraints:{audio:!0,video:!1}}})},this.reject=()=>this.session?this.session instanceof h?this.session.reject():Promise.reject(Error(\"Session not instance of Invitation.\")):Promise.reject(Error(\"No active call.\")),this.endCall=()=>f(this,void 0,void 0,function*(){if(!this.session)return Promise.reject(Error(\"No active call.\"));switch(this.session.state){case o.Initial:case o.Establishing:if(this.session instanceof c)return this.session.cancel();if(this.session instanceof h)return this.session.reject();throw Error(\"Unknown session type.\");case o.Established:return this.session.bye();case o.Terminating:case o.Terminated:break;default:throw Error(\"Unknown state\")}return Promise.resolve()}),this.setMute=e=>f(this,void 0,void 0,function*(){var t;if(this.muted===e)return Promise.resolve();if(!this.session)throw Error(\"No active call.\");let{peerConnection:i}=this.sessionDescriptionHandler;if(!i)throw Error(\"Peer connection closed.\");try{yield this.session.invite({requestDelegate:{onAccept:()=>{this.muted=e,this.toggleMediaStreamTracks(\"sender\",!this.muted),this.toggleMediaStreamTracks(\"receiver\",!this.muted),this.emit(\"stateChanged\")},onReject:()=>{this.toggleMediaStreamTracks(\"sender\",!this.muted),this.toggleMediaStreamTracks(\"receiver\",!this.muted),this.emit(\"muteerror\")}}}),this.toggleMediaStreamTracks(\"sender\",!this.muted),this.toggleMediaStreamTracks(\"receiver\",!this.muted)}catch(e){throw e instanceof r&&console.error(`[${null===(t=this.session)||void 0===t?void 0:t.id}] A mute request is already in progress.`),this.emit(\"muteerror\"),e}}),this.setHold=e=>f(this,void 0,void 0,function*(){var t;if(this.held===e)return Promise.resolve();if(!this.session)throw Error(\"Session not found\");let{sessionDescriptionHandler:i}=this,s=this.session.sessionDescriptionHandlerOptionsReInvite;s.hold=e,this.session.sessionDescriptionHandlerOptionsReInvite=s;let{peerConnection:n}=i;if(!n)throw Error(\"Peer connection closed.\");try{yield this.session.invite({requestDelegate:{onAccept:()=>{this.held=e,this.toggleMediaStreamTracks(\"receiver\",!this.held),this.toggleMediaStreamTracks(\"sender\",!this.held),this.held?this.emit(\"hold\"):this.emit(\"unhold\"),this.emit(\"stateChanged\")},onReject:()=>{this.toggleMediaStreamTracks(\"receiver\",!this.held),this.toggleMediaStreamTracks(\"sender\",!this.held),this.emit(\"holderror\")}}}),this.toggleMediaStreamTracks(\"receiver\",!e),this.toggleMediaStreamTracks(\"sender\",!e)}catch(e){throw e instanceof r&&console.error(`[${null===(t=this.session)||void 0===t?void 0:t.id}] A hold request is already in progress.`),this.emit(\"holderror\"),e}}),this.sendDTMF=e=>{if(!e||!/^[0-9A-D#*,]$/.exec(e))return Promise.reject(Error(\"Invalid DTMF tone.\"));if(!this.session)return Promise.reject(Error(\"Session does not exist.\"));let t={contentDisposition:\"render\",contentType:\"application/dtmf-relay\",content:`Signal=${e}\\r\nDuration=2000`};return this.session.info({requestOptions:{body:t}}).then(()=>void 0)},this.clearErrors=()=>{this.setError(null)},this.onUserAgentConnected=()=>{this.networkEmitter.emit(\"connected\"),this.emit(\"stateChanged\")},this.onUserAgentDisconnected=e=>{this.networkEmitter.emit(\"disconnected\"),this.emit(\"stateChanged\"),e&&(this.networkEmitter.emit(\"connectionerror\",e),this.attemptReconnection())},this.onRegistrationAccepted=()=>{this.emit(\"registered\"),this.emit(\"stateChanged\")},this.onRegistrationRejected=e=>{this.emit(\"registrationerror\",e)},this.onUnregistrationAccepted=()=>{this.emit(\"unregistered\"),this.emit(\"stateChanged\")},this.onUnregistrationRejected=e=>{this.emit(\"unregistrationerror\",e)},this.onIncomingCall=e=>f(this,void 0,void 0,function*(){if(!this.isRegistered()||this.session){yield e.reject();return}this.initSession(e),this.emit(\"incomingcall\",this.getContactInfo()),this.emit(\"stateChanged\")}),this.onTransferedCall=e=>f(this,void 0,void 0,function*(){yield e.accept(),this.sendInvite(e.makeInviter())}),this.onMessageReceived=e=>f(this,void 0,void 0,function*(){if(!e.request.hasHeader(\"X-Message-Type\")){e.reject();return}let t=e.request.getHeader(\"X-Message-Type\");if(\"contactUpdate\"===t)return this.updateContactInfoFromMessage(e)}),this.onSessionStablishing=()=>{this.emit(\"outgoingcall\",this.getContactInfo())},this.onSessionStablished=()=>{this.setupRemoteMedia(),this.emit(\"callestablished\",this.getContactInfo()),this.emit(\"stateChanged\")},this.onInviteRejected=e=>{var t;let{statusCode:i,reasonPhrase:s,to:n}=e.message;s&&487!==i&&(this.setError({status:i,reason:s,contact:{id:null!==(t=n.uri.user)&&void 0!==t?t:\"\",host:n.uri.host}}),this.emit(\"callfailed\",e.message.reasonPhrase||\"unknown\"))},this.onSessionTerminated=()=>{var e;this.session=void 0,this.muted=!1,this.held=!1,null===(e=this.remoteStream)||void 0===e||e.clear(),this.emit(\"callterminated\"),this.emit(\"stateChanged\")},this.onNetworkRestored=()=>{this.online=!0,this.networkEmitter.emit(\"localnetworkonline\"),this.emit(\"stateChanged\"),this.attemptReconnection()},this.onNetworkLost=()=>{this.online=!1,this.networkEmitter.emit(\"localnetworkoffline\"),this.emit(\"stateChanged\")},this.mediaStreamRendered=t,this.networkEmitter=new s}init(){return f(this,void 0,void 0,function*(){let{authPassword:e,authUserName:t,sipRegistrarHostnameOrIP:i,iceServers:s,webSocketURI:r}=this.config;this.userAgent=new a({authorizationPassword:e,authorizationUsername:t,uri:a.makeURI(`sip:${t}@${i}`),transportOptions:{server:r,connectionTimeout:100,keepAliveInterval:20},sessionDescriptionHandlerFactoryOptions:{iceGatheringTimeout:10,peerConnectionConfiguration:{iceServers:s}},logConfiguration:!1,logLevel:\"error\",delegate:{onInvite:this.onIncomingCall,onRefer:this.onTransferedCall,onMessage:this.onMessageReceived}}),this.userAgent.transport.isConnected();try{this.registerer=new n(this.userAgent),this.userAgent.transport.onConnect=this.onUserAgentConnected,this.userAgent.transport.onDisconnect=this.onUserAgentDisconnected,yield this.userAgent.start(),window.addEventListener(\"online\",this.onNetworkRestored),window.addEventListener(\"offline\",this.onNetworkLost)}catch(e){throw e}})}static create(e,t){return f(this,void 0,void 0,function*(){let i=new p(e,t);return yield i.init(),i})}initSession(e){var t;this.session=e,this.updateContactInfoFromSession(e),null===(t=this.session)||void 0===t||t.stateChange.addListener(t=>{if(this.session!==e)return;let i={[o.Initial]:()=>void 0,[o.Establishing]:this.onSessionStablishing,[o.Established]:this.onSessionStablished,[o.Terminating]:this.onSessionTerminated,[o.Terminated]:this.onSessionTerminated},s=i[t];if(!s)throw Error(\"Unknown session state.\");s()})}attemptReconnection(){return f(this,arguments,void 0,function*(e=0,t=!1){let{connectionRetryCount:i}=this.config;if(!this.userAgent||-1!==i&&e>i)return;let s=Math.pow(2,e%4);console.error(`Attempting to reconnect with backoff due to network loss. Backoff time [${s}]`),setTimeout(()=>{var i;null===(i=this.userAgent)||void 0===i||i.reconnect().catch(()=>{this.attemptReconnection(++e,t)})},1e3*s)})}changeAudioInputDevice(e){return f(this,void 0,void 0,function*(){if(!this.session)return console.warn(\"changeAudioInputDevice() : No session.\"),!1;let t=yield g.requestNewStream(e,this.session);if(!t)return console.warn(\"changeAudioInputDevice() : Unable to get local stream.\"),!1;let{peerConnection:i}=this.sessionDescriptionHandler;return i?(g.replaceTrack(i,t,\"audio\"),!0):(console.warn(\"changeAudioInputDevice() : No peer connection.\"),!1)})}switchMediaRenderer(e){this.remoteStream&&(this.mediaStreamRendered=e,this.remoteStream.init(e.remoteMediaElement),this.remoteStream.play())}setContactInfo(e){this.contactInfo=e,this.emit(\"stateChanged\")}getContactInfo(){return this.error?this.error.contact:this.session instanceof h||this.session instanceof c?this.contactInfo:null}getReferredBy(){var e;if(!(this.session instanceof h))return null;let t=this.session.request.getHeader(\"Referred-By\");if(!t)return null;let i=a.makeURI(t.slice(1,-1));return i?{id:null!==(e=i.user)&&void 0!==e?e:\"\",host:i.host}:null}isRegistered(){var e;return(null===(e=this.registerer)||void 0===e?void 0:e.state)===d.Registered}isReady(){var e;return(null===(e=this.userAgent)||void 0===e?void 0:e.state)===l.Started}isCaller(){return this.session instanceof c}isCallee(){return this.session instanceof h}isIncoming(){return\"INCOMING\"===this.getSessionType()}isOngoing(){return\"ONGOING\"===this.getSessionType()}isOutgoing(){return\"OUTGOING\"===this.getSessionType()}isInCall(){return null!==this.getSessionType()}isError(){return!!this.error}isOnline(){return this.online}isMuted(){return this.muted}isHeld(){return this.held}getError(){var e;return null!==(e=this.error)&&void 0!==e?e:null}getSessionType(){var e;return this.error?\"ERROR\":(null===(e=this.session)||void 0===e?void 0:e.state)===o.Established?\"ONGOING\":this.session instanceof h?\"INCOMING\":this.session instanceof c?\"OUTGOING\":null}getSession(){let e=this.getSessionType();switch(e){case\"ERROR\":{let e=this.getError(),{contact:t}=e,i=v(e,[\"contact\"]);return{type:\"ERROR\",error:i,contact:t,end:this.clearErrors}}case\"INCOMING\":case\"ONGOING\":case\"OUTGOING\":return{type:e,contact:this.getContactInfo(),transferedBy:this.getReferredBy(),isMuted:this.isMuted(),isHeld:this.isHeld(),mute:this.setMute,hold:this.setHold,accept:this.answer,end:this.endCall,dtmf:this.sendDTMF};default:return null}}getState(){return{isRegistered:this.isRegistered(),isReady:this.isReady(),isOnline:this.isOnline(),isIncoming:this.isIncoming(),isOngoing:this.isOngoing(),isOutgoing:this.isOutgoing(),isInCall:this.isInCall(),isError:this.isError()}}notifyDialer(e){this.emit(\"dialer\",e)}clear(){var e,t;null===(e=this.userAgent)||void 0===e||e.stop(),null===(t=this.registerer)||void 0===t||t.dispose(),this.userAgent&&(this.userAgent.transport.onConnect=void 0,this.userAgent.transport.onDisconnect=void 0,window.removeEventListener(\"online\",this.onNetworkRestored),window.removeEventListener(\"offline\",this.onNetworkLost))}setupRemoteMedia(){var e;let{remoteMediaStream:t}=this.sessionDescriptionHandler;this.remoteStream=new m(t);let i=null===(e=this.mediaStreamRendered)||void 0===e?void 0:e.remoteMediaElement;i&&(this.remoteStream.init(i),this.remoteStream.play())}makeURI(e){let t=e.includes(\"+\");return a.makeURI(`sip:${t?\"*\":\"\"}${e}@${this.config.sipRegistrarHostnameOrIP}`)}toggleMediaStreamTracks(e,t){let{peerConnection:i}=this.sessionDescriptionHandler;if(!i)throw Error(\"Peer connection closed.\");let s=\"sender\"===e?i.getSenders():i.getReceivers();null==s||s.forEach(e=>{e.track&&(e.track.enabled=t)})}sendInvite(e){return f(this,void 0,void 0,function*(){this.initSession(e),yield e.invite({requestDelegate:{onReject:this.onInviteRejected}}),this.emit(\"stateChanged\")})}updateContactInfoFromMessage(e){var t;let i=e.request.getHeader(\"Content-Type\"),s=e.request.getHeader(\"X-Message-Type\");try{if(\"contactUpdate\"!==s||\"application/json\"!==i)throw Error(\"Failed to parse contact update message\");let n=JSON.parse(e.request.body),r=a.makeURI(n.uri);if(!r)throw Error(\"Failed to parse contact update message\");this.setContactInfo({id:null!==(t=r.user)&&void 0!==t?t:\"\",host:r.host,name:r.user})}catch(e){console.warn(e.message)}}updateContactInfoFromSession(e){var t;if(!e)return;let{remoteIdentity:i}=e;this.setContactInfo({id:null!==(t=i.uri.user)&&void 0!==t?t:\"\",name:i.displayName,host:i.uri.host})}sendContactUpdateMessage(e){this.session&&this.session.message({requestOptions:{extraHeaders:[\"X-Message-Type: contactUpdate\"],body:{contentDisposition:\"render\",contentType:\"application/json\",content:JSON.stringify({uri:e.toString()})}}})}get sessionDescriptionHandler(){if(!this.session)throw Error(\"No active call.\");let{sessionDescriptionHandler:e}=this.session;if(!(e instanceof u))throw Error(\"Session's session description handler not instance of SessionDescriptionHandler.\");return e}setError(e){this.error=e,this.emit(\"stateChanged\")}}i.exportDefault(p)}","map":"{\"version\":3,\"sources\":[\"<anon>\"],\"names\":[],\"mappings\":\"\"}"}