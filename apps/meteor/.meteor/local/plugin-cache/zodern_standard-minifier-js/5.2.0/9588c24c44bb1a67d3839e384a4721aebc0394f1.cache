{"code":"function module(e,t,i){let o,n,s,l,r,a,u,c,p,d,v,k,b;i.export({useVoipClient:()=>h,isOutboundClient:()=>E}),i.link(\"@rocket.chat/core-typings\",{WorkflowTypes(e){o=e}},0),i.link(\"@rocket.chat/fuselage-hooks\",{useSafely(e){n=e}},1),i.link(\"@rocket.chat/ui-contexts\",{useUser(e){s=e},useSetting(e){l=e},useEndpoint(e){r=e},useStream(e){a=e}},2),i.link(\"jsrsasign\",{KJUR(e){u=e}},3),i.link(\"react\",{useEffect(e){c=e},useState(e){p=e}},4),i.link(\"../lib/voip/EEVoipClient\",{EEVoipClient(e){d=e}},5),i.link(\"../lib/voip/VoIPUser\",{VoIPUser(e){v=e}},6),i.link(\"../providers/CallProvider/hooks/useWebRtcServers\",{useWebRtcServers(e){k=e}},7),i.link(\"./useHasLicenseModule\",{useHasLicenseModule(e){b=e}},8);let f={},g=e=>\"string\"==typeof(null==e?void 0:e.result),h=()=>{let e=!!l(\"VoIP_Enabled\"),[t,i]=n(p(!0)),h=l(\"VoIP_Retry_Count\"),E=l(\"VoIP_Enable_Keep_Alive_For_Unstable_Networks\"),_=r(\"GET\",\"/v1/connector.extension.getRegistrationInfoByUserId\"),C=r(\"GET\",\"/v1/voip/queues.getMembershipSubscription\"),S=s(),U=a(\"notify-logged\"),y=k(),[R,w]=n(p({})),I=b(\"voip-enterprise\"),V=e&&t;return c(()=>{if(S)return U(\"voip.statuschanged\",e=>{i(e)})},[w,i,U,S]),c(()=>{let e;let t=null==S?void 0:S._id,i=null==S?void 0:S.extension;if(!t||!i||!V){w(f);return}return _({id:t}).then(t=>{let i;if(g(t)){var n;let e=u.jws.JWS.parse(t.result);i=null===(n=e.payloadObj)||void 0===n?void 0:n.context}else i=t;let{extensionDetails:{extension:s,password:l},callServerConfig:{websocketPath:r}}=i;(async()=>{try{let t=new URL(r),n=await C({extension:s}),a={authUserName:s,authPassword:l,sipRegistrarHostnameOrIP:t.host,webSocketURI:r,enableVideo:!0,iceServers:y,connectionRetryCount:Number(h),enableKeepAliveUsingOptionsForUnstableNetworks:!!E};(e=await (I?d.create(a):v.create(a))).setWorkflowMode(o.CONTACT_CENTER_USER),e.setMembershipSubscription(n),w({voipClient:e,registrationInfo:i})}catch(e){w({error:e})}})()},e=>{w({error:e})}),()=>{e&&e.clear()}},[y,_,w,C,V,null==S?void 0:S._id,null==S?void 0:S.extension,h,E,I]),R},E=e=>e instanceof d}","map":"{\"version\":3,\"sources\":[\"client/hooks/useVoipClient.ts\",\"<anon>\"],\"sourcesContent\":[\"import type { IRegistrationInfo } from '@rocket.chat/core-typings';\\nimport { WorkflowTypes } from '@rocket.chat/core-typings';\\nimport { useSafely } from '@rocket.chat/fuselage-hooks';\\nimport { useUser, useSetting, useEndpoint, useStream } from '@rocket.chat/ui-contexts';\\nimport { KJUR } from 'jsrsasign';\\nimport { useEffect, useState } from 'react';\\n\\nimport { EEVoipClient } from '../lib/voip/EEVoipClient';\\nimport { VoIPUser } from '../lib/voip/VoIPUser';\\nimport { useWebRtcServers } from '../providers/CallProvider/hooks/useWebRtcServers';\\nimport { useHasLicenseModule } from './useHasLicenseModule';\\n\\ntype UseVoipClientResult = {\\n\\tvoipClient?: VoIPUser;\\n\\tregistrationInfo?: IRegistrationInfo;\\n\\terror?: Error | unknown;\\n};\\n\\nconst empty = {};\\n\\nconst isSignedResponse = (data: any): data is { result: string } => typeof data?.result === 'string';\\n\\n// Currently we only support the websocket connection and the SIP proxy connection being from the same host,\\n// we need to add a new setting for SIP proxy if we want to support different hosts for them.\\nexport const useVoipClient = (): UseVoipClientResult => {\\n\\tconst settingVoipEnabled = Boolean(useSetting('VoIP_Enabled'));\\n\\n\\tconst [voipConnectorEnabled, setVoipConnectorEnabled] = useSafely(useState(true));\\n\\n\\tconst voipRetryCount = useSetting('VoIP_Retry_Count');\\n\\tconst enableKeepAlive = useSetting('VoIP_Enable_Keep_Alive_For_Unstable_Networks');\\n\\tconst registrationInfo = useEndpoint('GET', '/v1/connector.extension.getRegistrationInfoByUserId');\\n\\tconst membership = useEndpoint('GET', '/v1/voip/queues.getMembershipSubscription');\\n\\tconst user = useUser();\\n\\tconst subscribeToNotifyLoggedIn = useStream('notify-logged');\\n\\tconst iceServers = useWebRtcServers();\\n\\tconst [result, setResult] = useSafely(useState<UseVoipClientResult>({}));\\n\\n\\tconst isEE = useHasLicenseModule('voip-enterprise');\\n\\tconst voipEnabled = settingVoipEnabled && voipConnectorEnabled;\\n\\n\\tuseEffect(() => {\\n\\t\\tif (user) {\\n\\t\\t\\treturn subscribeToNotifyLoggedIn(`voip.statuschanged`, (enabled: boolean): void => {\\n\\t\\t\\t\\tsetVoipConnectorEnabled(enabled);\\n\\t\\t\\t});\\n\\t\\t}\\n\\t}, [setResult, setVoipConnectorEnabled, subscribeToNotifyLoggedIn, user]);\\n\\n\\tuseEffect(() => {\\n\\t\\tconst uid = user?._id;\\n\\t\\tconst userExtension = user?.extension;\\n\\n\\t\\tif (!uid || !userExtension || !voipEnabled) {\\n\\t\\t\\tsetResult(empty);\\n\\t\\t\\treturn;\\n\\t\\t}\\n\\t\\tlet client: VoIPUser;\\n\\t\\tregistrationInfo({ id: uid }).then(\\n\\t\\t\\t(data) => {\\n\\t\\t\\t\\tlet parsedData: IRegistrationInfo;\\n\\t\\t\\t\\tif (isSignedResponse(data)) {\\n\\t\\t\\t\\t\\tconst result = KJUR.jws.JWS.parse(data.result);\\n\\t\\t\\t\\t\\tparsedData = (result.payloadObj as any)?.context as IRegistrationInfo;\\n\\t\\t\\t\\t} else {\\n\\t\\t\\t\\t\\tparsedData = data;\\n\\t\\t\\t\\t}\\n\\n\\t\\t\\t\\tconst {\\n\\t\\t\\t\\t\\textensionDetails: { extension, password },\\n\\t\\t\\t\\t\\tcallServerConfig: { websocketPath },\\n\\t\\t\\t\\t} = parsedData;\\n\\n\\t\\t\\t\\t(async (): Promise<void> => {\\n\\t\\t\\t\\t\\ttry {\\n\\t\\t\\t\\t\\t\\tconst wsURL = new URL(websocketPath);\\n\\t\\t\\t\\t\\t\\tconst subscription = await membership({ extension });\\n\\n\\t\\t\\t\\t\\t\\tconst config = {\\n\\t\\t\\t\\t\\t\\t\\tauthUserName: extension,\\n\\t\\t\\t\\t\\t\\t\\tauthPassword: password,\\n\\t\\t\\t\\t\\t\\t\\tsipRegistrarHostnameOrIP: wsURL.host,\\n\\t\\t\\t\\t\\t\\t\\twebSocketURI: websocketPath,\\n\\t\\t\\t\\t\\t\\t\\tenableVideo: true,\\n\\t\\t\\t\\t\\t\\t\\ticeServers,\\n\\t\\t\\t\\t\\t\\t\\tconnectionRetryCount: Number(voipRetryCount),\\n\\t\\t\\t\\t\\t\\t\\tenableKeepAliveUsingOptionsForUnstableNetworks: Boolean(enableKeepAlive),\\n\\t\\t\\t\\t\\t\\t};\\n\\n\\t\\t\\t\\t\\t\\tclient = await (isEE ? EEVoipClient.create(config) : VoIPUser.create(config));\\n\\n\\t\\t\\t\\t\\t\\t// Today we are hardcoding workflow mode.\\n\\t\\t\\t\\t\\t\\t// In future, this should be ready from configuration\\n\\t\\t\\t\\t\\t\\tclient.setWorkflowMode(WorkflowTypes.CONTACT_CENTER_USER);\\n\\t\\t\\t\\t\\t\\tclient.setMembershipSubscription(subscription);\\n\\t\\t\\t\\t\\t\\tsetResult({ voipClient: client, registrationInfo: parsedData });\\n\\t\\t\\t\\t\\t} catch (error) {\\n\\t\\t\\t\\t\\t\\tsetResult({ error });\\n\\t\\t\\t\\t\\t}\\n\\t\\t\\t\\t})();\\n\\t\\t\\t},\\n\\t\\t\\t(error: Error) => {\\n\\t\\t\\t\\tsetResult({ error });\\n\\t\\t\\t},\\n\\t\\t);\\n\\t\\treturn (): void => {\\n\\t\\t\\tif (client) {\\n\\t\\t\\t\\tclient.clear();\\n\\t\\t\\t}\\n\\t\\t};\\n\\t}, [iceServers, registrationInfo, setResult, membership, voipEnabled, user?._id, user?.extension, voipRetryCount, enableKeepAlive, isEE]);\\n\\n\\treturn result;\\n};\\n\\nexport const isOutboundClient = (client: VoIPUser | undefined): client is EEVoipClient => client instanceof EEVoipClient;\\n\",null],\"names\":[\"WorkflowTypes\",\"useSafely\",\"useUser\",\"useSetting\",\"useEndpoint\",\"useStream\",\"KJUR\",\"useEffect\",\"useState\",\"EEVoipClient\",\"VoIPUser\",\"useWebRtcServers\",\"useHasLicenseModule\",\"module\",\"export\",\"useVoipClient\",\"isOutboundClient\",\"link\",\"v\",\"empty\",\"isSignedResponse\",\"data\",\"result\",\"settingVoipEnabled\",\"Boolean\",\"voipConnectorEnabled\",\"setVoipConnectorEnabled\",\"voipRetryCount\",\"enableKeepAlive\",\"registrationInfo\",\"membership\",\"user\",\"subscribeToNotifyLoggedIn\",\"iceServers\",\"setResult\",\"isEE\",\"voipEnabled\",\"enabled\",\"client\",\"uid\",\"_id\",\"userExtension\",\"extension\",\"id\",\"then\",\"parsedData\",\"_result$payloadObj\",\"jws\",\"JWS\",\"parse\",\"payloadObj\",\"context\",\"extensionDetails\",\"password\",\"callServerConfig\",\"websocketPath\",\"wsURL\",\"URL\",\"subscription\",\"config\",\"authUserName\",\"authPassword\",\"sipRegistrarHostnameOrIP\",\"host\",\"webSocketURI\",\"enableVideo\",\"connectionRetryCount\",\"Number\",\"enableKeepAliveUsingOptionsForUnstableNetworks\",\"create\",\"setWorkflowMode\",\"CONTACT_CENTER_USER\",\"setMembershipSubscription\",\"voipClient\",\"error\",\"clear\"],\"mappings\":\"2BAC0DA,EAAAC,EAAAC,EAAAC,EAAAC,EAAAC,EAAAC,EAAAC,EAAAC,EAAAC,EAAAC,EAAAC,EAAAC,EAA1DC,EAAOC,MAAE,CAAA,CAAAC,cAAeA,IAAMA,EAAAC,iBAA4BA,IAAAA,CAAA,GAAAH,EAAAI,IAAA,CAAA,4BAAA,CAAAjB,cAAAkB,CAAA,EAAAlB,EAAAkB,CAAA,CAAA,EAAA,GAAAL,EAAAI,IAAA,CAAA,8BAAA,CAAAhB,UAAAiB,CAAA,EAAAjB,EAAAiB,CAAA,CAAA,EAAA,GAAAL,EAAAI,IAAA,CAAA,2BAAA,CAAAf,QAAAgB,CAAA,EAAAhB,EAAAgB,CAAA,EAAAf,WAAAe,CAAA,EAAAf,EAAAe,CAAA,EAAAd,YAAAc,CAAA,EAAAd,EAAAc,CAAA,EAAAb,UAAAa,CAAA,EAAAb,EAAAa,CAAA,CAAA,EAAA,GAAAL,EAAAI,IAAA,CAAA,YAAA,CAAAX,KAAAY,CAAA,EAAAZ,EAAAY,CAAA,CAAA,EAAA,GAAAL,EAAAI,IAAA,CAAA,QAAA,CAAAV,UAAAW,CAAA,EAAAX,EAAAW,CAAA,EAAAV,SAAAU,CAAA,EAAAV,EAAAU,CAAA,CAAA,EAAA,GAAAL,EAAAI,IAAA,CAAA,2BAAA,CAAAR,aAAAS,CAAA,EAAAT,EAAAS,CAAA,CAAA,EAAA,GAAAL,EAAAI,IAAA,CAAA,uBAAA,CAAAP,SAAAQ,CAAA,EAAAR,EAAAQ,CAAA,CAAA,EAAA,GAAAL,EAAAI,IAAA,CAAA,mDAAA,CAAAN,iBAAAO,CAAA,EAAAP,EAAAO,CAAA,CAAA,EAAA,GAAAL,EAAAI,IAAA,CAAA,wBAAA,CAAAL,oBAAAM,CAAA,EAAAN,EAAAM,CAAA,CAAA,EAAA,GAiB1D,IAAMC,EAAQ,CAAA,EAERC,EAAoBC,GAA0C,AAAwB,UAAxB,MAAOA,CAAAA,MAAAA,EAAI,KAAA,EAAJA,EAAMC,MAAM,AAANA,EAIpEP,EAAgBA,KAC5B,IAAMQ,EAAqBC,CAAAA,CAAQrB,EAAW,gBAExC,CAACsB,EAAsBC,EAAwB,CAAGzB,EAAUO,EAAS,CAAA,IAErEmB,EAAiBxB,EAAW,oBAC5ByB,EAAkBzB,EAAW,gDAC7B0B,EAAmBzB,EAAY,MAAO,uDACtC0B,EAAa1B,EAAY,MAAO,6CAChC2B,EAAO7B,IACP8B,EAA4B3B,EAAU,iBACtC4B,EAAatB,IACb,CAACW,EAAQY,EAAU,CAAGjC,EAAUO,EAA8B,CAAA,IAE9D2B,EAAOvB,EAAoB,mBAC3BwB,EAAcb,GAAsBE,EAyE1C,OAvEAlB,EAAU,KACT,GAAIwB,EACH,OAAOC,EAAyB,qBAAwBK,IACvDX,EAAwBW,EACzB,EAEF,EAAG,CAACH,EAAWR,EAAyBM,EAA2BD,EAAK,EAExExB,EAAU,SAQL+B,EAPJ,IAAMC,EAAMR,MAAAA,EAAI,KAAA,EAAJA,EAAMS,GAAG,CACfC,EAAgBV,MAAAA,EAAI,KAAA,EAAJA,EAAMW,SAAS,CAErC,GAAI,CAACH,GAAO,CAACE,GAAiB,CAACL,EAAa,CAC3CF,EAAUf,GACV,MACD,CAiDA,OA/CAU,EAAiB,CAAEc,GAAIJ,CAAG,GAAIK,IAAI,CAChCvB,QACIwB,EACJ,GAAIzB,EAAiBC,GAAO,CAAA,IAAAyB,EAC3B,IAAMxB,EAAShB,EAAKyC,GAAG,CAACC,GAAG,CAACC,KAAK,CAAC5B,EAAKC,MAAM,EAC7CuB,EAAU,AAA6B,OAA7BC,CAAAA,EAAIxB,EAAO4B,UAAkB,AAAlBA,GAAkBJ,AAAA,KAAA,IAAAA,EAAA,KAAA,EAAzBA,EAA2BK,OAA4B,AACtE,MACCN,EAAaxB,EAGd,GAAM,CACL+B,iBAAkB,CAAEV,UAAAA,CAAS,CAAEW,SAAAA,CAAAA,CAAU,CACzCC,iBAAkB,CAAEC,cAAAA,CAAAA,CAAa,CACjC,CAAGV,EAEJ,AAAC,CAAA,UACA,GAAI,CACH,IAAMW,EAAQ,IAAIC,IAAIF,GAChBG,EAAe,MAAM5B,EAAW,CAAEY,UAAAA,CAAS,GAE3CiB,EAAS,CACdC,aAAclB,EACdmB,aAAcR,EACdS,yBAA0BN,EAAMO,IAAI,CACpCC,aAAcT,EACdU,YAAa,CAAA,EACbhC,WAAAA,EACAiC,qBAAsBC,OAAOxC,GAC7ByC,+CAAgD5C,CAAAA,CAAQI,GAOzDU,AAJAA,CAAAA,EAAS,MAAOH,CAAAA,EAAO1B,EAAa4D,MAAM,CAACV,GAAUjD,EAAS2D,MAAM,CAACV,EAAM,CAAC,EAIrEW,eAAe,CAACtE,EAAcuE,mBAAmB,EACxDjC,EAAOkC,yBAAyB,CAACd,GACjCxB,EAAU,CAAEuC,WAAYnC,EAAQT,iBAAkBgB,CAAU,EAC7D,CAAE,MAAO6B,EAAO,CACfxC,EAAU,CAAEwC,MAAAA,CAAK,EAClB,CACD,CAAA,GACD,EACCA,IACAxC,EAAU,CAAEwC,MAAAA,CAAK,EAClB,GAEM,KACFpC,GACHA,EAAOqC,KAAK,EAEd,CACD,EAAG,CAAC1C,EAAYJ,EAAkBK,EAAWJ,EAAYM,EAAaL,MAAAA,EAAI,KAAA,EAAJA,EAAMS,GAAG,CAAET,MAAAA,EAAI,KAAA,EAAJA,EAAMW,SAAS,CAAEf,EAAgBC,EAAiBO,EAAK,EAEjIb,CACR,EAEaN,EAAoBsB,GAAyDA,aAAkB7B\"}"}