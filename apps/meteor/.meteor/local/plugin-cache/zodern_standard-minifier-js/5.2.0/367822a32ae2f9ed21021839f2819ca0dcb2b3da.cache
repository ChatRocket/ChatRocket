{"code":"function module(e,t,i){var n,s,a,d,o,r,l,u,c,m;i.link(\"@babel/runtime/regenerator\",{default:function(e){n=e}},0),i.link(\"meteor/meteor\",{Meteor:function(e){s=e}},0),i.link(\"meteor/tracker\",{Tracker:function(e){a=e}},1),i.link(\"moment\",{default:function(e){d=e}},2),i.link(\"../../app/authorization/client\",{hasAtLeastOnePermission:function(e){o=e},hasPermission:function(e){r=e}},3),i.link(\"../../app/models/client\",{ChatMessage:function(e){l=e}},4),i.link(\"../../app/settings/client\",{settings:function(e){u=e}},5),i.link(\"../../app/utils/lib/i18n\",{t:function(e){c=e}},6),i.link(\"../lib/toast\",{dispatchToastMessage:function(e){m=e}},7),s.methods({updateMessage:function(e){var t,i,f,g,p=s.userId();if(p){var v=l.findOne(e._id);if(v){var k=o(\"edit-message\",e.rid),h=u.get(\"Message_AllowEditing\"),_=!1;if((null!==(t=null==v?void 0:null===(i=v.attachments)||void 0===i?void 0:null===(f=i[0])||void 0===f?void 0:f.description)&&void 0!==t?t:v.msg)!==e.msg){null!=v&&null!==(g=v.u)&&void 0!==g&&g._id&&(_=v.u._id===p);var M=s.users.findOne(p);if(M){if(!(k||h&&_)){m({type:\"error\",message:c(\"error-action-not-allowed\",{action:c(\"Message_editing\")})});return}var b=Number(u.get(\"Message_AllowEditing_BlockEditInMinutes\"));if(!r(\"bypass-time-limit-edit-and-delete\",e.rid)&&0!==b&&v.ts){var y=d(v.ts);if(y&&d().diff(y,\"minutes\")>b){m({type:\"error\",message:c(\"error-message-editing-blocked\")});return}}a.nonreactive(function(){var t,i;return n.async(function(n){for(;;)switch(n.prev=n.next){case 0:e.editedAt=new Date(Date.now()),e.editedBy={_id:p,username:M.username},i={editedAt:e.editedAt,editedBy:e.editedBy,msg:e.msg},null!==(t=v.attachments)&&void 0!==t&&t.length&&void 0!==v.attachments[0].description&&(delete i.msg,v.attachments[0].description=e.msg),l.update({_id:e._id,\"u._id\":p},{$set:i});case 5:case\"end\":return n.stop()}},null,null,null,Promise)})}}}}}})}","map":"{\"version\":3,\"sources\":[\"client/methods/updateMessage.ts\",\"<anon>\"],\"sourcesContent\":[\"import type { IEditedMessage } from '@rocket.chat/core-typings';\\nimport type { ServerMethods } from '@rocket.chat/ddp-client';\\nimport { Meteor } from 'meteor/meteor';\\nimport { Tracker } from 'meteor/tracker';\\nimport moment from 'moment';\\n\\nimport { hasAtLeastOnePermission, hasPermission } from '../../app/authorization/client';\\nimport { ChatMessage } from '../../app/models/client';\\nimport { settings } from '../../app/settings/client';\\nimport { t } from '../../app/utils/lib/i18n';\\nimport { dispatchToastMessage } from '../lib/toast';\\n\\nMeteor.methods<ServerMethods>({\\n\\tupdateMessage(message) {\\n\\t\\tconst uid = Meteor.userId();\\n\\t\\tif (!uid) {\\n\\t\\t\\treturn;\\n\\t\\t}\\n\\n\\t\\tconst originalMessage = ChatMessage.findOne(message._id);\\n\\n\\t\\tif (!originalMessage) {\\n\\t\\t\\treturn;\\n\\t\\t}\\n\\t\\tconst canEditMessage = hasAtLeastOnePermission('edit-message', message.rid);\\n\\t\\tconst editAllowed = settings.get('Message_AllowEditing');\\n\\t\\tlet editOwn = false;\\n\\n\\t\\tconst msgText = originalMessage?.attachments?.[0]?.description ?? originalMessage.msg;\\n\\n\\t\\tif (msgText === message.msg) {\\n\\t\\t\\treturn;\\n\\t\\t}\\n\\t\\tif (originalMessage?.u?._id) {\\n\\t\\t\\teditOwn = originalMessage.u._id === uid;\\n\\t\\t}\\n\\n\\t\\tconst me = Meteor.users.findOne(uid);\\n\\n\\t\\tif (!me) {\\n\\t\\t\\treturn;\\n\\t\\t}\\n\\n\\t\\tif (!(canEditMessage || (editAllowed && editOwn))) {\\n\\t\\t\\tdispatchToastMessage({\\n\\t\\t\\t\\ttype: 'error',\\n\\t\\t\\t\\tmessage: t('error-action-not-allowed', { action: t('Message_editing') }),\\n\\t\\t\\t});\\n\\t\\t\\treturn;\\n\\t\\t}\\n\\n\\t\\tconst blockEditInMinutes = Number(settings.get('Message_AllowEditing_BlockEditInMinutes') as number | undefined);\\n\\t\\tconst bypassBlockTimeLimit = hasPermission('bypass-time-limit-edit-and-delete', message.rid);\\n\\n\\t\\tif (!bypassBlockTimeLimit && blockEditInMinutes !== 0) {\\n\\t\\t\\tif (originalMessage.ts) {\\n\\t\\t\\t\\tconst msgTs = moment(originalMessage.ts);\\n\\t\\t\\t\\tif (msgTs) {\\n\\t\\t\\t\\t\\tconst currentTsDiff = moment().diff(msgTs, 'minutes');\\n\\t\\t\\t\\t\\tif (currentTsDiff > blockEditInMinutes) {\\n\\t\\t\\t\\t\\t\\tdispatchToastMessage({ type: 'error', message: t('error-message-editing-blocked') });\\n\\t\\t\\t\\t\\t\\treturn;\\n\\t\\t\\t\\t\\t}\\n\\t\\t\\t\\t}\\n\\t\\t\\t}\\n\\t\\t}\\n\\n\\t\\tTracker.nonreactive(async () => {\\n\\t\\t\\tmessage.editedAt = new Date(Date.now());\\n\\n\\t\\t\\tmessage.editedBy = {\\n\\t\\t\\t\\t_id: uid,\\n\\t\\t\\t\\tusername: me.username,\\n\\t\\t\\t};\\n\\n\\t\\t\\tconst messageObject: Partial<IEditedMessage> = {\\n\\t\\t\\t\\teditedAt: message.editedAt,\\n\\t\\t\\t\\teditedBy: message.editedBy,\\n\\t\\t\\t\\tmsg: message.msg,\\n\\t\\t\\t};\\n\\n\\t\\t\\tif (originalMessage.attachments?.length) {\\n\\t\\t\\t\\tif (originalMessage.attachments[0].description !== undefined) {\\n\\t\\t\\t\\t\\tdelete messageObject.msg;\\n\\t\\t\\t\\t\\toriginalMessage.attachments[0].description = message.msg;\\n\\t\\t\\t\\t}\\n\\t\\t\\t}\\n\\t\\t\\tChatMessage.update(\\n\\t\\t\\t\\t{\\n\\t\\t\\t\\t\\t'_id': message._id,\\n\\t\\t\\t\\t\\t'u._id': uid,\\n\\t\\t\\t\\t},\\n\\t\\t\\t\\t{ $set: messageObject },\\n\\t\\t\\t);\\n\\t\\t});\\n\\t},\\n});\\n\",null],\"names\":[\"_regeneratorRuntime\",\"Meteor\",\"Tracker\",\"moment\",\"hasAtLeastOnePermission\",\"hasPermission\",\"ChatMessage\",\"settings\",\"t\",\"dispatchToastMessage\",\"module\",\"link\",\"default\",\"v\",\"methods\",\"updateMessage\",\"message\",\"_originalMessage$atta\",\"_originalMessage$atta2\",\"_originalMessage$atta3\",\"_originalMessage$u\",\"uid\",\"userId\",\"originalMessage\",\"findOne\",\"_id\",\"canEditMessage\",\"rid\",\"editAllowed\",\"get\",\"editOwn\",\"msgText\",\"attachments\",\"description\",\"msg\",\"u\",\"me\",\"users\",\"type\",\"action\",\"blockEditInMinutes\",\"Number\",\"ts\",\"msgTs\",\"currentTsDiff\",\"diff\",\"nonreactive\",\"_originalMessage$atta4\",\"messageObject\",\"async\",\"_context\",\"prev\",\"next\",\"editedAt\",\"Date\",\"now\",\"editedBy\",\"username\",\"length\",\"undefined\",\"update\",\"$set\",\"stop\",\"Promise\"],\"mappings\":\"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\"}"}