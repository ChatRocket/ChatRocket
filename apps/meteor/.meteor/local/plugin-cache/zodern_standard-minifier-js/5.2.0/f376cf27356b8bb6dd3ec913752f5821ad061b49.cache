{"code":"function module(n,e,t){var r,u,i,a,o,l,c,d,s;t.link(\"@babel/runtime/helpers/objectSpread2\",{default:function(n){r=n}},0),t.link(\"@rocket.chat/favicon\",{manageFavicon:function(n){u=n}},0),t.link(\"meteor/meteor\",{Meteor:function(n){i=n}},1),t.link(\"meteor/session\",{Session:function(n){a=n}},2),t.link(\"meteor/tracker\",{Tracker:function(n){o=n}},3),t.link(\"../../app/models/client\",{ChatSubscription:function(n){l=n},ChatRoom:function(n){c=n}},4),t.link(\"../../app/utils/client\",{getUserPreference:function(n){d=n}},5),t.link(\"../lib/utils/fireGlobalEvent\",{fireGlobalEvent:function(n){s=n}},6),i.startup(function(){o.autorun(function(){var n=d(i.userId(),\"unreadAlert\"),e=!1,t=l.find({open:!0,hideUnreadStatus:{$ne:!0},archived:{$ne:!0}},{fields:{unread:1,alert:1,rid:1,t:1,name:1,ls:1,unreadAlert:1,fname:1,prid:1}}).fetch().reduce(function(t,u){return o.nonreactive(function(){var i=c.findOne({_id:u.rid},{fields:{usersCount:1}});return(s(\"unread-changed-by-subscription\",r(r({},u),{},{usersCount:null==i?void 0:i.usersCount})),u.alert||u.unread>0)?(!0===u.alert&&\"nothing\"!==u.unreadAlert&&(\"all\"===u.unreadAlert||!1!==n)&&(e=\"•\"),t+u.unread):t})},0);t>0?t>999?a.set(\"unread\",\"999+\"):a.set(\"unread\",t):!1!==e?a.set(\"unread\",e):a.set(\"unread\",\"\")})}),i.startup(function(){var n=u();o.autorun(function(){var e=a.get(\"unread\");s(\"unread-changed\",e),n(e)})})}","map":"{\"version\":3,\"sources\":[\"client/startup/unread.ts\",\"<anon>\"],\"sourcesContent\":[\"import type { ISubscription } from '@rocket.chat/core-typings';\\nimport { manageFavicon } from '@rocket.chat/favicon';\\nimport { Meteor } from 'meteor/meteor';\\nimport { Session } from 'meteor/session';\\nimport { Tracker } from 'meteor/tracker';\\n\\nimport { ChatSubscription, ChatRoom } from '../../app/models/client';\\nimport { getUserPreference } from '../../app/utils/client';\\nimport { fireGlobalEvent } from '../lib/utils/fireGlobalEvent';\\n\\nconst fetchSubscriptions = (): ISubscription[] =>\\n\\tChatSubscription.find(\\n\\t\\t{\\n\\t\\t\\topen: true,\\n\\t\\t\\thideUnreadStatus: { $ne: true },\\n\\t\\t\\tarchived: { $ne: true },\\n\\t\\t},\\n\\t\\t{\\n\\t\\t\\tfields: {\\n\\t\\t\\t\\tunread: 1,\\n\\t\\t\\t\\talert: 1,\\n\\t\\t\\t\\trid: 1,\\n\\t\\t\\t\\tt: 1,\\n\\t\\t\\t\\tname: 1,\\n\\t\\t\\t\\tls: 1,\\n\\t\\t\\t\\tunreadAlert: 1,\\n\\t\\t\\t\\tfname: 1,\\n\\t\\t\\t\\tprid: 1,\\n\\t\\t\\t},\\n\\t\\t},\\n\\t).fetch();\\n\\nMeteor.startup(() => {\\n\\tTracker.autorun(() => {\\n\\t\\tconst userUnreadAlert = getUserPreference(Meteor.userId(), 'unreadAlert');\\n\\n\\t\\tlet unreadAlert: false | '•' = false;\\n\\n\\t\\tconst unreadCount = fetchSubscriptions().reduce(\\n\\t\\t\\t(ret, subscription) =>\\n\\t\\t\\t\\tTracker.nonreactive(() => {\\n\\t\\t\\t\\t\\tconst room = ChatRoom.findOne({ _id: subscription.rid }, { fields: { usersCount: 1 } });\\n\\t\\t\\t\\t\\tfireGlobalEvent('unread-changed-by-subscription', {\\n\\t\\t\\t\\t\\t\\t...subscription,\\n\\t\\t\\t\\t\\t\\tusersCount: room?.usersCount,\\n\\t\\t\\t\\t\\t});\\n\\n\\t\\t\\t\\t\\tif (subscription.alert || subscription.unread > 0) {\\n\\t\\t\\t\\t\\t\\t// Increment the total unread count.\\n\\t\\t\\t\\t\\t\\tif (subscription.alert === true && subscription.unreadAlert !== 'nothing') {\\n\\t\\t\\t\\t\\t\\t\\tif (subscription.unreadAlert === 'all' || userUnreadAlert !== false) {\\n\\t\\t\\t\\t\\t\\t\\t\\tunreadAlert = '•';\\n\\t\\t\\t\\t\\t\\t\\t}\\n\\t\\t\\t\\t\\t\\t}\\n\\t\\t\\t\\t\\t\\treturn ret + subscription.unread;\\n\\t\\t\\t\\t\\t}\\n\\t\\t\\t\\t\\treturn ret;\\n\\t\\t\\t\\t}),\\n\\t\\t\\t0,\\n\\t\\t);\\n\\n\\t\\tif (unreadCount > 0) {\\n\\t\\t\\tif (unreadCount > 999) {\\n\\t\\t\\t\\tSession.set('unread', '999+');\\n\\t\\t\\t} else {\\n\\t\\t\\t\\tSession.set('unread', unreadCount);\\n\\t\\t\\t}\\n\\t\\t} else if (unreadAlert !== false) {\\n\\t\\t\\tSession.set('unread', unreadAlert);\\n\\t\\t} else {\\n\\t\\t\\tSession.set('unread', '');\\n\\t\\t}\\n\\t});\\n});\\n\\nMeteor.startup(() => {\\n\\tconst updateFavicon = manageFavicon();\\n\\n\\tTracker.autorun(() => {\\n\\t\\tconst unread = Session.get('unread');\\n\\t\\tfireGlobalEvent('unread-changed', unread);\\n\\n\\t\\tupdateFavicon(unread);\\n\\t});\\n});\\n\",null],\"names\":[\"_objectSpread\",\"manageFavicon\",\"Meteor\",\"Session\",\"Tracker\",\"ChatSubscription\",\"ChatRoom\",\"getUserPreference\",\"fireGlobalEvent\",\"module\",\"link\",\"default\",\"v\",\"startup\",\"autorun\",\"userUnreadAlert\",\"userId\",\"unreadAlert\",\"unreadCount\",\"fetchSubscriptions\",\"find\",\"open\",\"hideUnreadStatus\",\"$ne\",\"archived\",\"fields\",\"unread\",\"alert\",\"rid\",\"t\",\"name\",\"ls\",\"fname\",\"prid\",\"fetch\",\"reduce\",\"ret\",\"subscription\",\"nonreactive\",\"room\",\"findOne\",\"_id\",\"usersCount\",\"set\",\"updateFavicon\",\"get\"],\"mappings\":\"uBAUA,IATAA,EAAAC,EAAqDC,EAAAC,EAAAC,EAAAC,EAAAC,EAAAC,EAAAC,EAA5CC,EAAeC,IAAA,CAAM,uCAAuB,CAAAC,QAAA,SAAAC,CAAA,EAAAZ,EAAAY,CAAA,CAAA,EAAA,GAA5CH,EAAeC,IAAA,CAAM,uBAAuB,CAAAT,cAAA,SAAAW,CAAA,EAAAX,EAAAW,CAAA,CAAA,EAAA,GAAAH,EAAAC,IAAA,CAAA,gBAAA,CAAAR,OAAA,SAAAU,CAAA,EAAAV,EAAAU,CAAA,CAAA,EAAA,GAAAH,EAAAC,IAAA,CAAA,iBAAA,CAAAP,QAAA,SAAAS,CAAA,EAAAT,EAAAS,CAAA,CAAA,EAAA,GAAAH,EAAAC,IAAA,CAAA,iBAAA,CAAAN,QAAA,SAAAQ,CAAA,EAAAR,EAAAQ,CAAA,CAAA,EAAA,GAAAH,EAAAC,IAAA,CAAA,0BAAA,CAAAL,iBAAA,SAAAO,CAAA,EAAAP,EAAAO,CAAA,EAAAN,SAAA,SAAAM,CAAA,EAAAN,EAAAM,CAAA,CAAA,EAAA,GAAAH,EAAAC,IAAA,CAAA,yBAAA,CAAAH,kBAAA,SAAAK,CAAA,EAAAL,EAAAK,CAAA,CAAA,EAAA,GAAAH,EAAAC,IAAA,CAAA,+BAAA,CAAAF,gBAAA,SAAAI,CAAA,EAAAJ,EAAAI,CAAA,CAAA,EAAA,GA+BrDV,EAAOW,OAAO,CAAC,WACdT,EAAQU,OAAO,CAAC,WACf,IAAMC,EAAkBR,EAAkBL,EAAOc,MAAM,GAAI,eAEvDC,EAA2B,CAAA,EAEzBC,EAAcC,AA3BrBd,EAAiBe,IAAI,CACpB,CACCC,KAAM,CAAA,EACNC,iBAAkB,CAAEC,IAAK,CAAA,CAAI,EAC7BC,SAAU,CAAED,IAAK,CAAA,CAAI,GAEtB,CACCE,OAAQ,CACPC,OAAQ,EACRC,MAAO,EACPC,IAAK,EACLC,EAAG,EACHC,KAAM,EACNC,GAAI,EACJd,YAAa,EACbe,MAAO,EACPC,KAAM,KAGPC,KAAK,GAQmCC,MAAM,CAC9C,SAACC,CAAG,CAAEC,CAAY,EAAA,OACjBjC,EAAQkC,WAAW,CAAC,WACnB,IAAMC,EAAOjC,EAASkC,OAAO,CAAC,CAAEC,IAAKJ,EAAaT,GAAAA,AAAG,EAAI,CAAEH,OAAQ,CAAEiB,WAAY,CAAC,CAAE,SAMpF,CALAlC,EAAgB,iCAAgCR,EAAAA,EAAA,CAAA,EAC5CqC,GAAY,CAAA,EAAA,CACfK,WAAYH,MAAAA,EAAI,KAAA,EAAJA,EAAMG,UAAAA,AAAU,IAGzBL,EAAaV,KAAK,EAAIU,EAAaX,MAAM,CAAG,IAEpB,CAAA,IAAvBW,EAAaV,KAAK,EAAaU,AAA6B,YAA7BA,EAAapB,WAAW,EACtDoB,CAAAA,AAA6B,QAA7BA,EAAapB,WAAW,EAAcF,AAAoB,CAAA,IAApBA,CAAoB,GAC7DE,CAAAA,EAAc,GAAA,EAGTmB,EAAMC,EAAaX,MAAM,EAE1BU,CACR,EAAE,EACH,EAGGlB,CAAAA,EAAc,EACbA,EAAc,IACjBf,EAAQwC,GAAG,CAAC,SAAU,QAEtBxC,EAAQwC,GAAG,CAAC,SAAUzB,GAEbD,AAAgB,CAAA,IAAhBA,EACVd,EAAQwC,GAAG,CAAC,SAAU1B,GAEtBd,EAAQwC,GAAG,CAAC,SAAU,GAExB,EACD,GAEAzC,EAAOW,OAAO,CAAC,WACd,IAAM+B,EAAgB3C,IAEtBG,EAAQU,OAAO,CAAC,WACf,IAAMY,EAASvB,EAAQ0C,GAAG,CAAC,UAC3BrC,EAAgB,iBAAkBkB,GAElCkB,EAAclB,EACf,EACD\"}"}