{"code":"function module(e,a,t){let n,l,s,r,i,p,o,u,c,d,m,h,k,f,A,b;function y(e){let{app:a,action:t,isAppPurchased:y,onDismiss:E,onSuccess:g,setIsPurchased:x}=e,C=r(),I=s(),M=String(l(\"context\")),O=h(M)?M:\"explore\",w=k(O),P=n(\"POST\",\"/apps/notify-admins\"),R=b(),U=o(),v=u()({target:\"user-page\",action:\"buy_more\"}),T=p(()=>{I(null),E()},[E,I]),q=p(e=>{I(null),g(t,e)},[t,g,I]),S=A({app:a,onCancel:T,onConfirm:q}),H=f();if(!H)throw Error(\"Apps orchestrator is not available\");let L=p(async()=>{if(\"purchase\"===t&&!y){try{let e=await H.buildExternalUrl(a.id,a.purchaseType,!1);I(i.createElement(c,{url:e.url,cancel:E,confirm:()=>{x(!0),S()}}))}catch(e){m(e)}return}S()},[t,y,S,H,a.id,a.purchaseType,I,E,x]);return p(async()=>{if(null!=a&&a.versionIncompatible){R(a,t,T);return}if(\"request\"===t){try{let e=await H.buildExternalAppRequest(a.id);I(i.createElement(c,{url:e.url,wrapperHeight:\"x460\",cancel:E,confirm:e=>{I(null),C({type:\"success\",message:\"App request submitted\"}),P({appId:a.id,appName:a.name,appVersion:a.marketplaceVersion,message:\"string\"==typeof e.message?e.message:\"\"}),q()}}))}catch(e){m(e)}return}if(w.data){if(w.data.hasUnlimitedApps)return L();I(i.createElement(d,{enabled:w.data.enabled,limit:w.data.limit,appName:a.name,handleClose:T,handleConfirm:L,handleEnableUnlimitedApps:()=>{U(v),I(null)}}))}},[a,t,w.data,I,T,L,R,C,P,q,H,E,U,v])}t.export({useAppInstallationHandler:()=>y}),t.link(\"@rocket.chat/ui-contexts\",{useEndpoint(e){n=e},useRouteParameter(e){l=e},useSetModal(e){s=e},useToastMessageDispatch(e){r=e}},0),t.link(\"react\",{default(e){i=e},useCallback(e){p=e}},1),t.link(\"../../../hooks/useExternalLink\",{useExternalLink(e){o=e}},2),t.link(\"../../admin/subscription/hooks/useCheckoutUrl\",{useCheckoutUrl(e){u=e}},3),t.link(\"../IframeModal\",{default(e){c=e}},4),t.link(\"../components/AppInstallModal/AppInstallModal\",{default(e){d=e}},5),t.link(\"../helpers/handleAPIError\",{handleAPIError(e){m=e}},6),t.link(\"./useAppsCountQuery\",{isMarketplaceRouteContext(e){h=e},useAppsCountQuery(e){k=e}},7),t.link(\"./useAppsOrchestration\",{useAppsOrchestration(e){f=e}},8),t.link(\"./useOpenAppPermissionsReviewModal\",{useOpenAppPermissionsReviewModal(e){A=e}},9),t.link(\"./useOpenIncompatibleModal\",{useOpenIncompatibleModal(e){b=e}},10)}","map":"{\"version\":3,\"sources\":[\"client/views/marketplace/hooks/useAppInstallationHandler.tsx\",\"<anon>\"],\"sourcesContent\":[\"import type { App } from '@rocket.chat/core-typings';\\nimport { useEndpoint, useRouteParameter, useSetModal, useToastMessageDispatch } from '@rocket.chat/ui-contexts';\\nimport React, { useCallback } from 'react';\\n\\nimport { useExternalLink } from '../../../hooks/useExternalLink';\\nimport { useCheckoutUrl } from '../../admin/subscription/hooks/useCheckoutUrl';\\nimport IframeModal from '../IframeModal';\\nimport AppInstallModal from '../components/AppInstallModal/AppInstallModal';\\nimport type { Actions } from '../helpers';\\nimport { handleAPIError } from '../helpers/handleAPIError';\\nimport { isMarketplaceRouteContext, useAppsCountQuery } from './useAppsCountQuery';\\nimport { useAppsOrchestration } from './useAppsOrchestration';\\nimport { useOpenAppPermissionsReviewModal } from './useOpenAppPermissionsReviewModal';\\nimport { useOpenIncompatibleModal } from './useOpenIncompatibleModal';\\n\\nexport type AppInstallationHandlerParams = {\\n\\tapp: App;\\n\\taction: Actions | '';\\n\\tisAppPurchased?: boolean;\\n\\tonDismiss: () => void;\\n\\tonSuccess: (action: Actions | '', appPermissions?: App['permissions']) => void;\\n\\tsetIsPurchased: (purchased: boolean) => void;\\n};\\n\\nexport function useAppInstallationHandler({\\n\\tapp,\\n\\taction,\\n\\tisAppPurchased,\\n\\tonDismiss,\\n\\tonSuccess,\\n\\tsetIsPurchased,\\n}: AppInstallationHandlerParams) {\\n\\tconst dispatchToastMessage = useToastMessageDispatch();\\n\\tconst setModal = useSetModal();\\n\\n\\tconst routeContext = String(useRouteParameter('context'));\\n\\tconst context = isMarketplaceRouteContext(routeContext) ? routeContext : 'explore';\\n\\n\\tconst appCountQuery = useAppsCountQuery(context);\\n\\n\\tconst notifyAdmins = useEndpoint('POST', `/apps/notify-admins`);\\n\\n\\tconst openIncompatibleModal = useOpenIncompatibleModal();\\n\\n\\tconst openExternalLink = useExternalLink();\\n\\tconst manageSubscriptionUrl = useCheckoutUrl()({ target: 'user-page', action: 'buy_more' });\\n\\n\\tconst closeModal = useCallback(() => {\\n\\t\\tsetModal(null);\\n\\t\\tonDismiss();\\n\\t}, [onDismiss, setModal]);\\n\\n\\tconst success = useCallback(\\n\\t\\t(appPermissions?: App['permissions']) => {\\n\\t\\t\\tsetModal(null);\\n\\t\\t\\tonSuccess(action, appPermissions);\\n\\t\\t},\\n\\t\\t[action, onSuccess, setModal],\\n\\t);\\n\\n\\tconst openPermissionModal = useOpenAppPermissionsReviewModal({ app, onCancel: closeModal, onConfirm: success });\\n\\n\\tconst appsOrchestrator = useAppsOrchestration();\\n\\n\\tif (!appsOrchestrator) {\\n\\t\\tthrow new Error('Apps orchestrator is not available');\\n\\t}\\n\\n\\tconst acquireApp = useCallback(async () => {\\n\\t\\tif (action === 'purchase' && !isAppPurchased) {\\n\\t\\t\\ttry {\\n\\t\\t\\t\\tconst data = await appsOrchestrator.buildExternalUrl(app.id, app.purchaseType, false);\\n\\t\\t\\t\\tsetModal(\\n\\t\\t\\t\\t\\t<IframeModal\\n\\t\\t\\t\\t\\t\\turl={data.url}\\n\\t\\t\\t\\t\\t\\tcancel={onDismiss}\\n\\t\\t\\t\\t\\t\\tconfirm={() => {\\n\\t\\t\\t\\t\\t\\t\\tsetIsPurchased(true);\\n\\t\\t\\t\\t\\t\\t\\topenPermissionModal();\\n\\t\\t\\t\\t\\t\\t}}\\n\\t\\t\\t\\t\\t/>,\\n\\t\\t\\t\\t);\\n\\t\\t\\t} catch (error) {\\n\\t\\t\\t\\thandleAPIError(error);\\n\\t\\t\\t}\\n\\t\\t\\treturn;\\n\\t\\t}\\n\\n\\t\\topenPermissionModal();\\n\\t}, [action, isAppPurchased, openPermissionModal, appsOrchestrator, app.id, app.purchaseType, setModal, onDismiss, setIsPurchased]);\\n\\n\\treturn useCallback(async () => {\\n\\t\\tif (app?.versionIncompatible) {\\n\\t\\t\\topenIncompatibleModal(app, action, closeModal);\\n\\t\\t\\treturn;\\n\\t\\t}\\n\\n\\t\\tif (action === 'request') {\\n\\t\\t\\tconst requestConfirmAction = (postMessage: Record<string, unknown>) => {\\n\\t\\t\\t\\tsetModal(null);\\n\\t\\t\\t\\tdispatchToastMessage({ type: 'success', message: 'App request submitted' });\\n\\n\\t\\t\\t\\tnotifyAdmins({\\n\\t\\t\\t\\t\\tappId: app.id,\\n\\t\\t\\t\\t\\tappName: app.name,\\n\\t\\t\\t\\t\\tappVersion: app.marketplaceVersion,\\n\\t\\t\\t\\t\\tmessage: typeof postMessage.message === 'string' ? postMessage.message : '',\\n\\t\\t\\t\\t});\\n\\n\\t\\t\\t\\tsuccess();\\n\\t\\t\\t};\\n\\n\\t\\t\\ttry {\\n\\t\\t\\t\\tconst data = await appsOrchestrator.buildExternalAppRequest(app.id);\\n\\t\\t\\t\\tsetModal(<IframeModal url={data.url} wrapperHeight='x460' cancel={onDismiss} confirm={requestConfirmAction} />);\\n\\t\\t\\t} catch (error) {\\n\\t\\t\\t\\thandleAPIError(error);\\n\\t\\t\\t}\\n\\t\\t\\treturn;\\n\\t\\t}\\n\\n\\t\\tif (!appCountQuery.data) {\\n\\t\\t\\treturn;\\n\\t\\t}\\n\\n\\t\\tif (appCountQuery.data.hasUnlimitedApps) {\\n\\t\\t\\treturn acquireApp();\\n\\t\\t}\\n\\n\\t\\tsetModal(\\n\\t\\t\\t<AppInstallModal\\n\\t\\t\\t\\tenabled={appCountQuery.data.enabled}\\n\\t\\t\\t\\tlimit={appCountQuery.data.limit}\\n\\t\\t\\t\\tappName={app.name}\\n\\t\\t\\t\\thandleClose={closeModal}\\n\\t\\t\\t\\thandleConfirm={acquireApp}\\n\\t\\t\\t\\thandleEnableUnlimitedApps={() => {\\n\\t\\t\\t\\t\\topenExternalLink(manageSubscriptionUrl);\\n\\t\\t\\t\\t\\tsetModal(null);\\n\\t\\t\\t\\t}}\\n\\t\\t\\t/>,\\n\\t\\t);\\n\\t}, [\\n\\t\\tapp,\\n\\t\\taction,\\n\\t\\tappCountQuery.data,\\n\\t\\tsetModal,\\n\\t\\tcloseModal,\\n\\t\\tacquireApp,\\n\\t\\topenIncompatibleModal,\\n\\t\\tdispatchToastMessage,\\n\\t\\tnotifyAdmins,\\n\\t\\tsuccess,\\n\\t\\tappsOrchestrator,\\n\\t\\tonDismiss,\\n\\t\\topenExternalLink,\\n\\t\\tmanageSubscriptionUrl,\\n\\t]);\\n}\\n\",null],\"names\":[\"useEndpoint\",\"useRouteParameter\",\"useSetModal\",\"useToastMessageDispatch\",\"React\",\"useCallback\",\"useExternalLink\",\"useCheckoutUrl\",\"IframeModal\",\"AppInstallModal\",\"handleAPIError\",\"isMarketplaceRouteContext\",\"useAppsCountQuery\",\"useAppsOrchestration\",\"useOpenAppPermissionsReviewModal\",\"useOpenIncompatibleModal\",\"useAppInstallationHandler\",\"_ref\",\"app\",\"action\",\"isAppPurchased\",\"onDismiss\",\"onSuccess\",\"setIsPurchased\",\"dispatchToastMessage\",\"setModal\",\"routeContext\",\"String\",\"context\",\"appCountQuery\",\"notifyAdmins\",\"openIncompatibleModal\",\"openExternalLink\",\"manageSubscriptionUrl\",\"target\",\"closeModal\",\"success\",\"appPermissions\",\"openPermissionModal\",\"onCancel\",\"onConfirm\",\"appsOrchestrator\",\"Error\",\"acquireApp\",\"data\",\"buildExternalUrl\",\"id\",\"purchaseType\",\"createElement\",\"url\",\"cancel\",\"confirm\",\"error\",\"versionIncompatible\",\"buildExternalAppRequest\",\"wrapperHeight\",\"postMessage\",\"type\",\"message\",\"appId\",\"appName\",\"name\",\"appVersion\",\"marketplaceVersion\",\"hasUnlimitedApps\",\"enabled\",\"limit\",\"handleClose\",\"handleConfirm\",\"handleEnableUnlimitedApps\",\"module\",\"export\",\"link\",\"v\",\"default\"],\"mappings\":\"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\"}"}