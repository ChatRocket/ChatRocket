{"code":"function module(e,t,n){let i,s,a,r,l,o,d,u,g,c,p,E,m;n.link(\"@rocket.chat/core-typings\",{isE2EEPinnedMessage(e){i=e}},0),n.link(\"meteor/meteor\",{Meteor(e){s=e}},1),n.link(\"meteor/tracker\",{Tracker(e){a=e}},2),n.link(\"../../app/e2e/client/E2EEState\",{E2EEState(e){r=e}},3),n.link(\"../../app/e2e/client/rocketchat.e2e\",{e2e(e){l=e}},4),n.link(\"../../app/mentions/lib/MentionsParser\",{MentionsParser(e){o=e}},5),n.link(\"../../app/models/client\",{ChatRoom(e){d=e}},6),n.link(\"../../app/settings/client\",{settings(e){u=e}},7),n.link(\"../lib/onClientBeforeSendMessage\",{onClientBeforeSendMessage(e){g=e}},8),n.link(\"../lib/onClientMessageReceived\",{onClientMessageReceived(e){c=e}},9),n.link(\"../lib/utils/isLayoutEmbedded\",{isLayoutEmbedded(e){p=e}},10),n.link(\"../lib/utils/waitUntilFind\",{waitUntilFind(e){E=e}},11),n.link(\"../providers/RouterProvider\",{router(e){m=e}},12),s.startup(()=>{let e,t;a.autorun(()=>{if(!s.userId()){l.log(\"Not logged in\");return}if(!window.crypto){l.error(\"No crypto support\");return}let e=u.get(\"E2E_Enable\"),t=p()&&m.getLocationPathname().startsWith(\"/admin\");e&&!t?(l.log(\"E2E enabled starting client\"),l.startClient()):(l.log(\"E2E disabled\"),l.setState(r.DISABLED),l.closeAlert())});let n=!1;a.autorun(()=>{if(!l.isReady()){var a,r;l.log(\"Not ready\"),null===(a=e)||void 0===a||a(),null===(r=t)||void 0===r||r(),n=!1;return}if(n){l.log(\"Listeners already attached\");return}e=c.use(async e=>{let t=await l.getInstanceByRoomId(e.rid);return null!=t&&t.shouldConvertReceivedMessages()?i(e)?l.decryptPinnedMessage(e):l.decryptMessage(e):e}),t=g.use(async e=>{let t=await l.getInstanceByRoomId(e.rid);if(!t)return e;let n=await E(()=>d.findOne({_id:e.rid}));n.encrypted?t.resume():t.pause();let i=await t.shouldConvertSentMessages(e);if(!i)return e;let a=u.get(\"E2E_Enabled_Mentions\");if(a){var r;let t=(null===(r=s.user())||void 0===r?void 0:r.username)||\"\",n=u.get(\"UTF8_User_Names_Validation\"),i=u.get(\"UI_Use_Real_Name\"),a=new o({pattern:()=>n,useRealName:()=>i,me:()=>t}),l={e2eUserMentions:a.getUserMentions(e.msg),e2eChannelMentions:a.getChannelMentions(e.msg)};e.e2eMentions=l}return t.encryptMessage(e)}),n=!0,l.log(\"Listeners attached\",n)})})}","map":"{\"version\":3,\"sources\":[\"client/startup/e2e.ts\",\"<anon>\"],\"sourcesContent\":[\"import type { IMessage } from '@rocket.chat/core-typings';\\nimport { isE2EEPinnedMessage } from '@rocket.chat/core-typings';\\nimport { Meteor } from 'meteor/meteor';\\nimport { Tracker } from 'meteor/tracker';\\n\\nimport { E2EEState } from '../../app/e2e/client/E2EEState';\\nimport { e2e } from '../../app/e2e/client/rocketchat.e2e';\\nimport { MentionsParser } from '../../app/mentions/lib/MentionsParser';\\nimport { ChatRoom } from '../../app/models/client';\\nimport { settings } from '../../app/settings/client';\\nimport { onClientBeforeSendMessage } from '../lib/onClientBeforeSendMessage';\\nimport { onClientMessageReceived } from '../lib/onClientMessageReceived';\\nimport { isLayoutEmbedded } from '../lib/utils/isLayoutEmbedded';\\nimport { waitUntilFind } from '../lib/utils/waitUntilFind';\\nimport { router } from '../providers/RouterProvider';\\n\\nMeteor.startup(() => {\\n\\tTracker.autorun(() => {\\n\\t\\tif (!Meteor.userId()) {\\n\\t\\t\\te2e.log('Not logged in');\\n\\t\\t\\treturn;\\n\\t\\t}\\n\\n\\t\\tif (!window.crypto) {\\n\\t\\t\\te2e.error('No crypto support');\\n\\t\\t\\treturn;\\n\\t\\t}\\n\\n\\t\\tconst enabled = settings.get('E2E_Enable');\\n\\t\\t// we don't care about the reactivity of this boolean\\n\\t\\tconst adminEmbedded = isLayoutEmbedded() && router.getLocationPathname().startsWith('/admin');\\n\\n\\t\\tif (enabled && !adminEmbedded) {\\n\\t\\t\\te2e.log('E2E enabled starting client');\\n\\t\\t\\te2e.startClient();\\n\\t\\t} else {\\n\\t\\t\\te2e.log('E2E disabled');\\n\\t\\t\\te2e.setState(E2EEState.DISABLED);\\n\\t\\t\\te2e.closeAlert();\\n\\t\\t}\\n\\t});\\n\\n\\tlet offClientMessageReceived: undefined | (() => void);\\n\\tlet offClientBeforeSendMessage: undefined | (() => void);\\n\\tlet listenersAttached = false;\\n\\n\\tTracker.autorun(() => {\\n\\t\\tif (!e2e.isReady()) {\\n\\t\\t\\te2e.log('Not ready');\\n\\t\\t\\toffClientMessageReceived?.();\\n\\t\\t\\toffClientBeforeSendMessage?.();\\n\\t\\t\\tlistenersAttached = false;\\n\\t\\t\\treturn;\\n\\t\\t}\\n\\n\\t\\tif (listenersAttached) {\\n\\t\\t\\te2e.log('Listeners already attached');\\n\\t\\t\\treturn;\\n\\t\\t}\\n\\n\\t\\toffClientMessageReceived = onClientMessageReceived.use(async (msg: IMessage) => {\\n\\t\\t\\tconst e2eRoom = await e2e.getInstanceByRoomId(msg.rid);\\n\\t\\t\\tif (!e2eRoom?.shouldConvertReceivedMessages()) {\\n\\t\\t\\t\\treturn msg;\\n\\t\\t\\t}\\n\\n\\t\\t\\tif (isE2EEPinnedMessage(msg)) {\\n\\t\\t\\t\\treturn e2e.decryptPinnedMessage(msg);\\n\\t\\t\\t}\\n\\n\\t\\t\\treturn e2e.decryptMessage(msg);\\n\\t\\t});\\n\\n\\t\\t// Encrypt messages before sending\\n\\t\\toffClientBeforeSendMessage = onClientBeforeSendMessage.use(async (message) => {\\n\\t\\t\\tconst e2eRoom = await e2e.getInstanceByRoomId(message.rid);\\n\\n\\t\\t\\tif (!e2eRoom) {\\n\\t\\t\\t\\treturn message;\\n\\t\\t\\t}\\n\\n\\t\\t\\tconst subscription = await waitUntilFind(() => ChatRoom.findOne({ _id: message.rid }));\\n\\n\\t\\t\\tsubscription.encrypted ? e2eRoom.resume() : e2eRoom.pause();\\n\\n\\t\\t\\tconst shouldConvertSentMessages = await e2eRoom.shouldConvertSentMessages(message);\\n\\n\\t\\t\\tif (!shouldConvertSentMessages) {\\n\\t\\t\\t\\treturn message;\\n\\t\\t\\t}\\n\\n\\t\\t\\tconst mentionsEnabled = settings.get<boolean>('E2E_Enabled_Mentions');\\n\\n\\t\\t\\tif (mentionsEnabled) {\\n\\t\\t\\t\\tconst me = Meteor.user()?.username || '';\\n\\t\\t\\t\\tconst pattern = settings.get('UTF8_User_Names_Validation');\\n\\t\\t\\t\\tconst useRealName = settings.get('UI_Use_Real_Name');\\n\\n\\t\\t\\t\\tconst mentions = new MentionsParser({\\n\\t\\t\\t\\t\\tpattern: () => pattern,\\n\\t\\t\\t\\t\\tuseRealName: () => useRealName,\\n\\t\\t\\t\\t\\tme: () => me,\\n\\t\\t\\t\\t});\\n\\n\\t\\t\\t\\tconst e2eMentions: IMessage['e2eMentions'] = {\\n\\t\\t\\t\\t\\te2eUserMentions: mentions.getUserMentions(message.msg),\\n\\t\\t\\t\\t\\te2eChannelMentions: mentions.getChannelMentions(message.msg),\\n\\t\\t\\t\\t};\\n\\n\\t\\t\\t\\tmessage.e2eMentions = e2eMentions;\\n\\t\\t\\t}\\n\\n\\t\\t\\t// Should encrypt this message.\\n\\t\\t\\treturn e2eRoom.encryptMessage(message);\\n\\t\\t});\\n\\n\\t\\tlistenersAttached = true;\\n\\t\\te2e.log('Listeners attached', listenersAttached);\\n\\t});\\n});\\n\",null],\"names\":[\"isE2EEPinnedMessage\",\"Meteor\",\"Tracker\",\"E2EEState\",\"e2e\",\"MentionsParser\",\"ChatRoom\",\"settings\",\"onClientBeforeSendMessage\",\"onClientMessageReceived\",\"isLayoutEmbedded\",\"waitUntilFind\",\"router\",\"module\",\"link\",\"v\",\"startup\",\"offClientMessageReceived\",\"offClientBeforeSendMessage\",\"autorun\",\"userId\",\"log\",\"window\",\"crypto\",\"error\",\"enabled\",\"get\",\"adminEmbedded\",\"getLocationPathname\",\"startsWith\",\"startClient\",\"setState\",\"DISABLED\",\"closeAlert\",\"listenersAttached\",\"isReady\",\"_offClientMessageRece\",\"_offClientBeforeSendM\",\"use\",\"msg\",\"e2eRoom\",\"getInstanceByRoomId\",\"rid\",\"shouldConvertReceivedMessages\",\"decryptPinnedMessage\",\"decryptMessage\",\"message\",\"subscription\",\"findOne\",\"_id\",\"encrypted\",\"resume\",\"pause\",\"shouldConvertSentMessages\",\"mentionsEnabled\",\"_Meteor$user\",\"me\",\"user\",\"username\",\"pattern\",\"useRealName\",\"mentions\",\"e2eMentions\",\"e2eUserMentions\",\"getUserMentions\",\"e2eChannelMentions\",\"getChannelMentions\",\"encryptMessage\"],\"mappings\":\"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\"}"}