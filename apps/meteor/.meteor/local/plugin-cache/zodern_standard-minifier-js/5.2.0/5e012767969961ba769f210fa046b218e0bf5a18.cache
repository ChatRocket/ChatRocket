{"code":"function module(e,t,s){let r,i,a,n,o;s.export({EEVoipClient:()=>l}),s.link(\"@rocket.chat/core-typings\",{Operation(e){r=e},UserState(e){i=e}},0),s.link(\"sip.js\",{Inviter(e){a=e},UserAgent(e){n=e}},1),s.link(\"./VoIPUser\",{VoIPUser(e){o=e}},2);class l extends o{constructor(e,t){super(e,t)}async makeCallURI(e,t){if(t&&(this.mediaStreamRendered=t),this.session)throw Error(\"Session exists\");if(!this.userAgent)throw Error(\"No User Agent.\");if(\"REGISTERED\"!==this.callState)throw Error(\"Incorrect UA state\");let s=n.makeURI(e);if(!s)throw Error(\"Failed to create valid URI \".concat(e));let o=new a(this.userAgent,s,{sessionDescriptionHandlerOptions:{constraints:{audio:!0,video:!1}}});this.session=o,this.setupSessionEventHandlers(o),this._opInProgress=r.OP_SEND_INVITE,await o.invite({requestDelegate:{onReject:e=>{e.message.reasonPhrase&&this.emit(\"callfailed\",e.message.reasonPhrase||\"unknown\")}}}),this._callState=\"OFFER_SENT\";let l={callerId:o.remoteIdentity.uri.user?o.remoteIdentity.uri.user:\"\",callerName:o.remoteIdentity.displayName,host:o.remoteIdentity.uri.host};this._callerInfo=l,this._userState=i.UAC,this.emit(\"stateChanged\")}async makeCall(e){let t=e.includes(\"+\"),s=e.replace(\"+\",\"\");this.makeCallURI(\"sip:\".concat(t?\"*\":\"\").concat(s,\"@\").concat(this.userConfig.sipRegistrarHostnameOrIP))}static async create(e,t){let s=new l(e,t);return await s.init(),s}}}","map":"{\"version\":3,\"sources\":[\"client/lib/voip/EEVoipClient.ts\",\"<anon>\"],\"sourcesContent\":[\"import type { ICallerInfo, IMediaStreamRenderer, VoIPUserConfiguration } from '@rocket.chat/core-typings';\\nimport { Operation, UserState } from '@rocket.chat/core-typings';\\nimport { Inviter, UserAgent } from 'sip.js';\\nimport type { IncomingResponse } from 'sip.js/lib/core';\\n\\nimport { VoIPUser } from './VoIPUser';\\n\\nexport class EEVoipClient extends VoIPUser {\\n\\tconstructor(config: VoIPUserConfiguration, mediaRenderer?: IMediaStreamRenderer) {\\n\\t\\tsuper(config, mediaRenderer);\\n\\t}\\n\\n\\tasync makeCallURI(calleeURI: string, mediaRenderer?: IMediaStreamRenderer): Promise<void> {\\n\\t\\tif (mediaRenderer) {\\n\\t\\t\\tthis.mediaStreamRendered = mediaRenderer;\\n\\t\\t}\\n\\t\\tif (this.session) {\\n\\t\\t\\tthrow new Error('Session exists');\\n\\t\\t}\\n\\t\\tif (!this.userAgent) {\\n\\t\\t\\tthrow new Error('No User Agent.');\\n\\t\\t}\\n\\t\\tif (this.callState !== 'REGISTERED') {\\n\\t\\t\\tthrow new Error('Incorrect UA state');\\n\\t\\t}\\n\\t\\tconst target = UserAgent.makeURI(calleeURI);\\n\\t\\tif (!target) {\\n\\t\\t\\tthrow new Error(`Failed to create valid URI ${calleeURI}`);\\n\\t\\t}\\n\\t\\t// Replace this when device manager code is ready.\\n\\t\\tconst constraints = {\\n\\t\\t\\taudio: true,\\n\\t\\t\\tvideo: false,\\n\\t\\t};\\n\\t\\tconst inviterOptions = {\\n\\t\\t\\tsessionDescriptionHandlerOptions: { constraints },\\n\\t\\t};\\n\\t\\t// Create a new Inviter for the outgoing Session\\n\\t\\tconst inviter = new Inviter(this.userAgent, target, inviterOptions);\\n\\t\\tthis.session = inviter;\\n\\t\\tthis.setupSessionEventHandlers(inviter);\\n\\t\\tthis._opInProgress = Operation.OP_SEND_INVITE;\\n\\n\\t\\tawait inviter.invite({\\n\\t\\t\\trequestDelegate: {\\n\\t\\t\\t\\tonReject: (response: IncomingResponse): void => {\\n\\t\\t\\t\\t\\tif (response.message.reasonPhrase) {\\n\\t\\t\\t\\t\\t\\tthis.emit('callfailed', response.message.reasonPhrase || 'unknown');\\n\\t\\t\\t\\t\\t}\\n\\t\\t\\t\\t},\\n\\t\\t\\t},\\n\\t\\t});\\n\\n\\t\\tthis._callState = 'OFFER_SENT';\\n\\t\\tconst callerInfo: ICallerInfo = {\\n\\t\\t\\tcallerId: inviter.remoteIdentity.uri.user ? inviter.remoteIdentity.uri.user : '',\\n\\t\\t\\tcallerName: inviter.remoteIdentity.displayName,\\n\\t\\t\\thost: inviter.remoteIdentity.uri.host,\\n\\t\\t};\\n\\t\\tthis._callerInfo = callerInfo;\\n\\t\\tthis._userState = UserState.UAC;\\n\\t\\tthis.emit('stateChanged');\\n\\t}\\n\\n\\tasync makeCall(calleeNumber: string): Promise<void> {\\n\\t\\tconst hasPlusChar = calleeNumber.includes('+');\\n\\n\\t\\tconst digits = calleeNumber.replace('+', '');\\n\\t\\tthis.makeCallURI(`sip:${hasPlusChar ? '*' : ''}${digits}@${this.userConfig.sipRegistrarHostnameOrIP}`);\\n\\t}\\n\\n\\tstatic async create(config: VoIPUserConfiguration, mediaRenderer?: IMediaStreamRenderer): Promise<VoIPUser> {\\n\\t\\tconst voip = new EEVoipClient(config, mediaRenderer);\\n\\t\\tawait voip.init();\\n\\t\\treturn voip;\\n\\t}\\n}\\n\",null],\"names\":[\"Operation\",\"UserState\",\"Inviter\",\"UserAgent\",\"VoIPUser\",\"module\",\"export\",\"EEVoipClient\",\"link\",\"v\",\"constructor\",\"config\",\"mediaRenderer\",\"makeCallURI\",\"calleeURI\",\"mediaStreamRendered\",\"session\",\"Error\",\"userAgent\",\"callState\",\"target\",\"makeURI\",\"concat\",\"inviter\",\"sessionDescriptionHandlerOptions\",\"constraints\",\"audio\",\"video\",\"setupSessionEventHandlers\",\"_opInProgress\",\"OP_SEND_INVITE\",\"invite\",\"requestDelegate\",\"onReject\",\"response\",\"message\",\"reasonPhrase\",\"emit\",\"_callState\",\"callerInfo\",\"callerId\",\"remoteIdentity\",\"uri\",\"user\",\"callerName\",\"displayName\",\"host\",\"_callerInfo\",\"_userState\",\"UAC\",\"makeCall\",\"calleeNumber\",\"hasPlusChar\",\"includes\",\"digits\",\"replace\",\"userConfig\",\"sipRegistrarHostnameOrIP\",\"create\",\"voip\",\"init\"],\"mappings\":\"2BACqCA,EAAAC,EAA4BC,EAAAC,EAAAC,EAAjEC,EAAOC,MAAE,CAAA,CAAAC,aAAWA,IAAWA,CAAM,GAA4BF,EAAAG,IAAA,CAAA,4BAAA,CAAAR,UAAAS,CAAA,EAAAT,EAAAS,CAAA,EAAAR,UAAAQ,CAAA,EAAAR,EAAAQ,CAAA,CAAA,EAAA,GAAAJ,EAAAG,IAAA,CAAA,SAAA,CAAAN,QAAAO,CAAA,EAAAP,EAAAO,CAAA,EAAAN,UAAAM,CAAA,EAAAN,EAAAM,CAAA,CAAA,EAAA,GAAAJ,EAAAG,IAAA,CAAA,aAAA,CAAAJ,SAAAK,CAAA,EAAAL,EAAAK,CAAA,CAAA,EAAA,EAM3D,OAAOF,UAAqBH,EACjCM,YAAYC,CAA6B,CAAEC,CAAoC,CAAA,CAC9E,KAAK,CAACD,EAAQC,EACf,CAEA,MAAMC,YAAYC,CAAiB,CAAEF,CAAoC,CAAA,CAIxE,GAHIA,GACH,CAAA,IAAI,CAACG,mBAAmB,CAAGH,CAAAA,EAExB,IAAI,CAACI,OAAO,CACf,MAAM,AAAIC,MAAM,kBAEjB,GAAI,CAAC,IAAI,CAACC,SAAS,CAClB,MAAM,AAAID,MAAM,kBAEjB,GAAI,AAAmB,eAAnB,IAAI,CAACE,SAAS,CACjB,MAAM,AAAIF,MAAM,sBAEjB,IAAMG,EAASjB,EAAUkB,OAAO,CAACP,GACjC,GAAI,CAACM,EACJ,MAAM,AAAIH,MAAK,8BAAAK,MAAA,CAA+BR,IAW/C,IAAMS,EAAU,IAAIrB,EAAQ,IAAI,CAACgB,SAAS,CAAEE,EAJrB,CACtBI,iCAAkC,CAAEC,YALjB,CACnBC,MAAO,CAAA,EACPC,MAAO,CAAA,EAGwC,GAIhD,CAAA,IAAI,CAACX,OAAO,CAAGO,EACf,IAAI,CAACK,yBAAyB,CAACL,GAC/B,IAAI,CAACM,aAAa,CAAG7B,EAAU8B,cAAc,CAE7C,MAAMP,EAAQQ,MAAM,CAAC,CACpBC,gBAAiB,CAChBC,SAAWC,IACNA,EAASC,OAAO,CAACC,YAAY,EAChC,IAAI,CAACC,IAAI,CAAC,aAAcH,EAASC,OAAO,CAACC,YAAY,EAAI,UAE3D,KAIF,IAAI,CAACE,UAAU,CAAG,aAClB,IAAMC,EAA0B,CAC/BC,SAAUjB,EAAQkB,cAAc,CAACC,GAAG,CAACC,IAAI,CAAGpB,EAAQkB,cAAc,CAACC,GAAG,CAACC,IAAI,CAAG,GAC9EC,WAAYrB,EAAQkB,cAAc,CAACI,WAAW,CAC9CC,KAAMvB,EAAQkB,cAAc,CAACC,GAAG,CAACI,IAAAA,CAElC,CAAA,IAAI,CAACC,WAAW,CAAGR,EACnB,IAAI,CAACS,UAAU,CAAG/C,EAAUgD,GAAG,CAC/B,IAAI,CAACZ,IAAI,CAAC,eACX,CAEA,MAAMa,SAASC,CAAoB,CAAA,CAClC,IAAMC,EAAcD,EAAaE,QAAQ,CAAC,KAEpCC,EAASH,EAAaI,OAAO,CAAC,IAAK,IACzC,IAAI,CAAC1C,WAAW,CAAA,OAAAS,MAAA,CAAQ8B,EAAc,IAAM,IAAE9B,MAAA,CAAGgC,EAAM,KAAAhC,MAAA,CAAI,IAAI,CAACkC,UAAU,CAACC,wBAAwB,EACpG,CAEA,aAAaC,OAAO/C,CAA6B,CAAEC,CAAoC,CAAA,CACtF,IAAM+C,EAAO,IAAIpD,EAAaI,EAAQC,GAEtC,OADA,MAAM+C,EAAKC,IAAI,GACRD,CACR\"}"}