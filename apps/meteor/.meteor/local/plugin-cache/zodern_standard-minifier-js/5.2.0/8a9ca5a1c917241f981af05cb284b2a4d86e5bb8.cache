{"code":"function module(e,n,t){t.link(\"@babel/runtime/regenerator\",{default:function(e){o=e}},0),t.link(\"meteor/meteor\",{Meteor:function(e){i=e}},0),t.link(\"meteor/tracker\",{Tracker:function(e){r=e}},1),t.link(\"react\",{lazy:function(e){a=e}},2),t.link(\"../../../app/models/client\",{CachedChatSubscription:function(e){u=e}},3),t.link(\"../../../app/settings/client\",{settings:function(e){s=e}},4),t.link(\"../../../app/ui/client/lib/KonchatNotification\",{KonchatNotification:function(e){c=e}},5),t.link(\"../../../app/utils/client\",{getUserPreference:function(e){l=e}},6),t.link(\"../../../app/utils/client/lib/SDKClient\",{sdk:function(e){d=e}},7),t.link(\"../../lib/RoomManager\",{RoomManager:function(e){f=e}},8),t.link(\"../../lib/imperativeModal\",{imperativeModal:function(e){p=e}},9),t.link(\"../../lib/utils/fireGlobalEvent\",{fireGlobalEvent:function(e){m=e}},10),t.link(\"../../lib/utils/isLayoutEmbedded\",{isLayoutEmbedded:function(e){k=e}},11),t.link(\"../../providers/RouterProvider\",{router:function(e){b=e}},12);var o,i,r,a,u,s,c,l,d,f,p,m,k,b,v=a(function(){return t.dynamicImport(\"../../views/outlookCalendar/OutlookCalendarEventModal\")}),y=function(e){var n;return o.async(function(t){for(;;)switch(t.prev=t.next){case 0:if(!(!(n=i.user())||\"busy\"===n.status)){t.next=3;break}return t.abrupt(\"return\");case 3:b.getRouteParameters().name&&b.getRouteParameters().name===e.name||e.ls||!0!==e.alert||c.newRoom(e.rid);case 4:case\"end\":return t.stop()}},null,null,null,Promise)};i.startup(function(){var e=function(e){var n,t;return o.async(function(o){for(;;)switch(o.prev=o.next){case 0:if(!(!(n=i.user())||\"busy\"===n.status)){o.next=3;break}return o.abrupt(\"return\");case 3:t=l(i.userId(),\"desktopNotificationRequireInteraction\"),new Notification(e.title,{body:e.text,tag:e.payload._id,silent:!0,requireInteraction:t}).onclick=function(){this.close(),window.focus(),p.open({component:v,props:{id:e.payload._id,onClose:p.close,onCancel:p.close}})};case 6:case\"end\":return o.stop()}},null,null,null,Promise)};r.autorun(function(){if(!i.userId()||!s.get(\"Outlook_Calendar_Enabled\")){d.stop(\"notify-user\",i.userId()+\"/calendar\");return}d.stream(\"notify-user\",[i.userId()+\"/calendar\"],e)}),r.autorun(function(){i.userId()&&(d.stream(\"notify-user\",[i.userId()+\"/notification\"],function(e){var n,t,o,r,a=[\"channel\",\"group\",\"direct\"].includes(b.getRouteName())?f.opened:void 0,u=document.hasFocus(),s=a===e.payload.rid;m(\"notification\",{notification:e,fromOpenedRoom:s,hasFocus:u}),k()?!u&&s&&c.showDesktop(e):u&&s||c.showDesktop(e),n=e.payload.rid,t=document.hasFocus(),o=f.opened===n,r=l(i.userId(),\"muteFocusedConversations\"),k()?!t&&o&&c.newMessage(n):t&&o&&r||c.newMessage(n)}),u.on(\"changed\",function(e){y(e)}),d.stream(\"notify-user\",[i.userId()+\"/subscriptions-changed\"],function(e,n){\"removed\"!==e&&y(n)}))})})}","map":"{\"version\":3,\"sources\":[\"client/startup/notifications/konchatNotifications.ts\",\"<anon>\"],\"sourcesContent\":[\"import type { AtLeast, ISubscription, IUser, ICalendarNotification } from '@rocket.chat/core-typings';\\nimport { Meteor } from 'meteor/meteor';\\nimport { Tracker } from 'meteor/tracker';\\nimport { lazy } from 'react';\\n\\nimport { CachedChatSubscription } from '../../../app/models/client';\\nimport { settings } from '../../../app/settings/client';\\nimport { KonchatNotification } from '../../../app/ui/client/lib/KonchatNotification';\\nimport { getUserPreference } from '../../../app/utils/client';\\nimport { sdk } from '../../../app/utils/client/lib/SDKClient';\\nimport { RoomManager } from '../../lib/RoomManager';\\nimport { imperativeModal } from '../../lib/imperativeModal';\\nimport { fireGlobalEvent } from '../../lib/utils/fireGlobalEvent';\\nimport { isLayoutEmbedded } from '../../lib/utils/isLayoutEmbedded';\\nimport { router } from '../../providers/RouterProvider';\\n\\nconst OutlookCalendarEventModal = lazy(() => import('../../views/outlookCalendar/OutlookCalendarEventModal'));\\n\\nconst notifyNewRoom = async (sub: AtLeast<ISubscription, 'rid'>): Promise<void> => {\\n\\tconst user = Meteor.user() as IUser | null;\\n\\tif (!user || user.status === 'busy') {\\n\\t\\treturn;\\n\\t}\\n\\n\\tif ((!router.getRouteParameters().name || router.getRouteParameters().name !== sub.name) && !sub.ls && sub.alert === true) {\\n\\t\\tKonchatNotification.newRoom(sub.rid);\\n\\t}\\n};\\n\\nfunction notifyNewMessageAudio(rid?: string): void {\\n\\t// This logic is duplicated in /client/startup/unread.coffee.\\n\\tconst hasFocus = document.hasFocus();\\n\\tconst messageIsInOpenedRoom = RoomManager.opened === rid;\\n\\tconst muteFocusedConversations = getUserPreference(Meteor.userId(), 'muteFocusedConversations');\\n\\n\\tif (isLayoutEmbedded()) {\\n\\t\\tif (!hasFocus && messageIsInOpenedRoom) {\\n\\t\\t\\t// Play a notification sound\\n\\t\\t\\tvoid KonchatNotification.newMessage(rid);\\n\\t\\t}\\n\\t} else if (!hasFocus || !messageIsInOpenedRoom || !muteFocusedConversations) {\\n\\t\\t// Play a notification sound\\n\\t\\tvoid KonchatNotification.newMessage(rid);\\n\\t}\\n}\\n\\nMeteor.startup(() => {\\n\\tconst notifyUserCalendar = async function (notification: ICalendarNotification): Promise<void> {\\n\\t\\tconst user = Meteor.user() as IUser | null;\\n\\t\\tif (!user || user.status === 'busy') {\\n\\t\\t\\treturn;\\n\\t\\t}\\n\\n\\t\\tconst requireInteraction = getUserPreference<boolean>(Meteor.userId(), 'desktopNotificationRequireInteraction');\\n\\n\\t\\tconst n = new Notification(notification.title, {\\n\\t\\t\\tbody: notification.text,\\n\\t\\t\\ttag: notification.payload._id,\\n\\t\\t\\tsilent: true,\\n\\t\\t\\trequireInteraction,\\n\\t\\t} as NotificationOptions);\\n\\n\\t\\tn.onclick = function () {\\n\\t\\t\\tthis.close();\\n\\t\\t\\twindow.focus();\\n\\t\\t\\timperativeModal.open({\\n\\t\\t\\t\\tcomponent: OutlookCalendarEventModal,\\n\\t\\t\\t\\tprops: { id: notification.payload._id, onClose: imperativeModal.close, onCancel: imperativeModal.close },\\n\\t\\t\\t});\\n\\t\\t};\\n\\t};\\n\\tTracker.autorun(() => {\\n\\t\\tif (!Meteor.userId() || !settings.get('Outlook_Calendar_Enabled')) {\\n\\t\\t\\tsdk.stop('notify-user', `${Meteor.userId()}/calendar`);\\n\\t\\t\\treturn;\\n\\t\\t}\\n\\n\\t\\tsdk.stream('notify-user', [`${Meteor.userId()}/calendar`], notifyUserCalendar);\\n\\t});\\n\\n\\tTracker.autorun(() => {\\n\\t\\tif (!Meteor.userId()) {\\n\\t\\t\\treturn;\\n\\t\\t}\\n\\n\\t\\tsdk.stream('notify-user', [`${Meteor.userId()}/notification`], (notification) => {\\n\\t\\t\\tconst openedRoomId = ['channel', 'group', 'direct'].includes(router.getRouteName()!) ? RoomManager.opened : undefined;\\n\\n\\t\\t\\t// This logic is duplicated in /client/startup/unread.coffee.\\n\\t\\t\\tconst hasFocus = document.hasFocus();\\n\\t\\t\\tconst messageIsInOpenedRoom = openedRoomId === notification.payload.rid;\\n\\n\\t\\t\\tfireGlobalEvent('notification', {\\n\\t\\t\\t\\tnotification,\\n\\t\\t\\t\\tfromOpenedRoom: messageIsInOpenedRoom,\\n\\t\\t\\t\\thasFocus,\\n\\t\\t\\t});\\n\\n\\t\\t\\tif (isLayoutEmbedded()) {\\n\\t\\t\\t\\tif (!hasFocus && messageIsInOpenedRoom) {\\n\\t\\t\\t\\t\\t// Show a notification.\\n\\t\\t\\t\\t\\tKonchatNotification.showDesktop(notification);\\n\\t\\t\\t\\t}\\n\\t\\t\\t} else if (!hasFocus || !messageIsInOpenedRoom) {\\n\\t\\t\\t\\t// Show a notification.\\n\\t\\t\\t\\tKonchatNotification.showDesktop(notification);\\n\\t\\t\\t}\\n\\n\\t\\t\\tnotifyNewMessageAudio(notification.payload.rid);\\n\\t\\t});\\n\\n\\t\\tCachedChatSubscription.on('changed', (sub): void => {\\n\\t\\t\\tvoid notifyNewRoom(sub);\\n\\t\\t});\\n\\n\\t\\tsdk.stream('notify-user', [`${Meteor.userId()}/subscriptions-changed`], (action, sub) => {\\n\\t\\t\\tif (action === 'removed') {\\n\\t\\t\\t\\treturn;\\n\\t\\t\\t}\\n\\t\\t\\tvoid notifyNewRoom(sub);\\n\\t\\t});\\n\\t});\\n});\\n\",null],\"names\":[\"module\",\"link\",\"default\",\"v\",\"_regeneratorRuntime\",\"Meteor\",\"Tracker\",\"lazy\",\"CachedChatSubscription\",\"settings\",\"KonchatNotification\",\"getUserPreference\",\"sdk\",\"RoomManager\",\"imperativeModal\",\"fireGlobalEvent\",\"isLayoutEmbedded\",\"router\",\"OutlookCalendarEventModal\",\"dynamicImport\",\"notifyNewRoom\",\"sub\",\"user\",\"async\",\"_context\",\"prev\",\"next\",\"status\",\"abrupt\",\"getRouteParameters\",\"name\",\"ls\",\"alert\",\"newRoom\",\"rid\",\"stop\",\"Promise\",\"startup\",\"notifyUserCalendar\",\"notification\",\"requireInteraction\",\"_context2\",\"userId\",\"n\",\"Notification\",\"title\",\"body\",\"text\",\"tag\",\"payload\",\"_id\",\"silent\",\"onclick\",\"close\",\"window\",\"focus\",\"open\",\"component\",\"props\",\"id\",\"onClose\",\"onCancel\",\"autorun\",\"get\",\"stream\",\"hasFocus\",\"messageIsInOpenedRoom\",\"muteFocusedConversations\",\"openedRoomId\",\"includes\",\"getRouteName\",\"opened\",\"undefined\",\"document\",\"fromOpenedRoom\",\"showDesktop\",\"newMessage\",\"on\",\"action\"],\"mappings\":\"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\"}"}