{"code":"function module(e,n,t){var r,i,a,s,o,u,l,c,d,f,p,g,m,b;t.link(\"@babel/runtime/regenerator\",{default:function(e){r=e}},0),t.link(\"@rocket.chat/core-typings\",{isE2EEPinnedMessage:function(e){i=e}},0),t.link(\"meteor/meteor\",{Meteor:function(e){a=e}},1),t.link(\"meteor/tracker\",{Tracker:function(e){s=e}},2),t.link(\"../../app/e2e/client/E2EEState\",{E2EEState:function(e){o=e}},3),t.link(\"../../app/e2e/client/rocketchat.e2e\",{e2e:function(e){u=e}},4),t.link(\"../../app/mentions/lib/MentionsParser\",{MentionsParser:function(e){l=e}},5),t.link(\"../../app/models/client\",{ChatRoom:function(e){c=e}},6),t.link(\"../../app/settings/client\",{settings:function(e){d=e}},7),t.link(\"../lib/onClientBeforeSendMessage\",{onClientBeforeSendMessage:function(e){f=e}},8),t.link(\"../lib/onClientMessageReceived\",{onClientMessageReceived:function(e){p=e}},9),t.link(\"../lib/utils/isLayoutEmbedded\",{isLayoutEmbedded:function(e){g=e}},10),t.link(\"../lib/utils/waitUntilFind\",{waitUntilFind:function(e){m=e}},11),t.link(\"../providers/RouterProvider\",{router:function(e){b=e}},12),a.startup(function(){s.autorun(function(){if(!a.userId()){u.log(\"Not logged in\");return}if(!window.crypto){u.error(\"No crypto support\");return}var e=d.get(\"E2E_Enable\"),n=g()&&b.getLocationPathname().startsWith(\"/admin\");e&&!n?(u.log(\"E2E enabled starting client\"),u.startClient()):(u.log(\"E2E disabled\"),u.setState(o.DISABLED),u.closeAlert())});var e,n,t=!1;s.autorun(function(){if(!u.isReady()){var s,o;u.log(\"Not ready\"),null===(s=e)||void 0===s||s(),null===(o=n)||void 0===o||o(),t=!1;return}if(t){u.log(\"Listeners already attached\");return}e=p.use(function(e){var n;return r.async(function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,r.awrap(u.getInstanceByRoomId(e.rid));case 2:if(null!=(n=t.sent)&&n.shouldConvertReceivedMessages()){t.next=5;break}return t.abrupt(\"return\",e);case 5:if(!i(e)){t.next=7;break}return t.abrupt(\"return\",u.decryptPinnedMessage(e));case 7:return t.abrupt(\"return\",u.decryptMessage(e));case 8:case\"end\":return t.stop()}},null,null,null,Promise)}),n=f.use(function(e){var n,t,i,s,o,f,p;return r.async(function(g){for(;;)switch(g.prev=g.next){case 0:return g.next=2,r.awrap(u.getInstanceByRoomId(e.rid));case 2:if(n=g.sent){g.next=5;break}return g.abrupt(\"return\",e);case 5:return g.next=7,r.awrap(m(function(){return c.findOne({_id:e.rid})}));case 7:return g.sent.encrypted?n.resume():n.pause(),g.next=11,r.awrap(n.shouldConvertSentMessages(e));case 11:if(g.sent){g.next=14;break}return g.abrupt(\"return\",e);case 14:return d.get(\"E2E_Enabled_Mentions\")&&(i=(null===(t=a.user())||void 0===t?void 0:t.username)||\"\",s=d.get(\"UTF8_User_Names_Validation\"),o=d.get(\"UI_Use_Real_Name\"),p={e2eUserMentions:(f=new l({pattern:function(){return s},useRealName:function(){return o},me:function(){return i}})).getUserMentions(e.msg),e2eChannelMentions:f.getChannelMentions(e.msg)},e.e2eMentions=p),g.abrupt(\"return\",n.encryptMessage(e));case 17:case\"end\":return g.stop()}},null,null,null,Promise)}),t=!0,u.log(\"Listeners attached\",t)})})}","map":"{\"version\":3,\"sources\":[\"client/startup/e2e.ts\",\"<anon>\"],\"sourcesContent\":[\"import type { IMessage } from '@rocket.chat/core-typings';\\nimport { isE2EEPinnedMessage } from '@rocket.chat/core-typings';\\nimport { Meteor } from 'meteor/meteor';\\nimport { Tracker } from 'meteor/tracker';\\n\\nimport { E2EEState } from '../../app/e2e/client/E2EEState';\\nimport { e2e } from '../../app/e2e/client/rocketchat.e2e';\\nimport { MentionsParser } from '../../app/mentions/lib/MentionsParser';\\nimport { ChatRoom } from '../../app/models/client';\\nimport { settings } from '../../app/settings/client';\\nimport { onClientBeforeSendMessage } from '../lib/onClientBeforeSendMessage';\\nimport { onClientMessageReceived } from '../lib/onClientMessageReceived';\\nimport { isLayoutEmbedded } from '../lib/utils/isLayoutEmbedded';\\nimport { waitUntilFind } from '../lib/utils/waitUntilFind';\\nimport { router } from '../providers/RouterProvider';\\n\\nMeteor.startup(() => {\\n\\tTracker.autorun(() => {\\n\\t\\tif (!Meteor.userId()) {\\n\\t\\t\\te2e.log('Not logged in');\\n\\t\\t\\treturn;\\n\\t\\t}\\n\\n\\t\\tif (!window.crypto) {\\n\\t\\t\\te2e.error('No crypto support');\\n\\t\\t\\treturn;\\n\\t\\t}\\n\\n\\t\\tconst enabled = settings.get('E2E_Enable');\\n\\t\\t// we don't care about the reactivity of this boolean\\n\\t\\tconst adminEmbedded = isLayoutEmbedded() && router.getLocationPathname().startsWith('/admin');\\n\\n\\t\\tif (enabled && !adminEmbedded) {\\n\\t\\t\\te2e.log('E2E enabled starting client');\\n\\t\\t\\te2e.startClient();\\n\\t\\t} else {\\n\\t\\t\\te2e.log('E2E disabled');\\n\\t\\t\\te2e.setState(E2EEState.DISABLED);\\n\\t\\t\\te2e.closeAlert();\\n\\t\\t}\\n\\t});\\n\\n\\tlet offClientMessageReceived: undefined | (() => void);\\n\\tlet offClientBeforeSendMessage: undefined | (() => void);\\n\\tlet listenersAttached = false;\\n\\n\\tTracker.autorun(() => {\\n\\t\\tif (!e2e.isReady()) {\\n\\t\\t\\te2e.log('Not ready');\\n\\t\\t\\toffClientMessageReceived?.();\\n\\t\\t\\toffClientBeforeSendMessage?.();\\n\\t\\t\\tlistenersAttached = false;\\n\\t\\t\\treturn;\\n\\t\\t}\\n\\n\\t\\tif (listenersAttached) {\\n\\t\\t\\te2e.log('Listeners already attached');\\n\\t\\t\\treturn;\\n\\t\\t}\\n\\n\\t\\toffClientMessageReceived = onClientMessageReceived.use(async (msg: IMessage) => {\\n\\t\\t\\tconst e2eRoom = await e2e.getInstanceByRoomId(msg.rid);\\n\\t\\t\\tif (!e2eRoom?.shouldConvertReceivedMessages()) {\\n\\t\\t\\t\\treturn msg;\\n\\t\\t\\t}\\n\\n\\t\\t\\tif (isE2EEPinnedMessage(msg)) {\\n\\t\\t\\t\\treturn e2e.decryptPinnedMessage(msg);\\n\\t\\t\\t}\\n\\n\\t\\t\\treturn e2e.decryptMessage(msg);\\n\\t\\t});\\n\\n\\t\\t// Encrypt messages before sending\\n\\t\\toffClientBeforeSendMessage = onClientBeforeSendMessage.use(async (message) => {\\n\\t\\t\\tconst e2eRoom = await e2e.getInstanceByRoomId(message.rid);\\n\\n\\t\\t\\tif (!e2eRoom) {\\n\\t\\t\\t\\treturn message;\\n\\t\\t\\t}\\n\\n\\t\\t\\tconst subscription = await waitUntilFind(() => ChatRoom.findOne({ _id: message.rid }));\\n\\n\\t\\t\\tsubscription.encrypted ? e2eRoom.resume() : e2eRoom.pause();\\n\\n\\t\\t\\tconst shouldConvertSentMessages = await e2eRoom.shouldConvertSentMessages(message);\\n\\n\\t\\t\\tif (!shouldConvertSentMessages) {\\n\\t\\t\\t\\treturn message;\\n\\t\\t\\t}\\n\\n\\t\\t\\tconst mentionsEnabled = settings.get<boolean>('E2E_Enabled_Mentions');\\n\\n\\t\\t\\tif (mentionsEnabled) {\\n\\t\\t\\t\\tconst me = Meteor.user()?.username || '';\\n\\t\\t\\t\\tconst pattern = settings.get('UTF8_User_Names_Validation');\\n\\t\\t\\t\\tconst useRealName = settings.get('UI_Use_Real_Name');\\n\\n\\t\\t\\t\\tconst mentions = new MentionsParser({\\n\\t\\t\\t\\t\\tpattern: () => pattern,\\n\\t\\t\\t\\t\\tuseRealName: () => useRealName,\\n\\t\\t\\t\\t\\tme: () => me,\\n\\t\\t\\t\\t});\\n\\n\\t\\t\\t\\tconst e2eMentions: IMessage['e2eMentions'] = {\\n\\t\\t\\t\\t\\te2eUserMentions: mentions.getUserMentions(message.msg),\\n\\t\\t\\t\\t\\te2eChannelMentions: mentions.getChannelMentions(message.msg),\\n\\t\\t\\t\\t};\\n\\n\\t\\t\\t\\tmessage.e2eMentions = e2eMentions;\\n\\t\\t\\t}\\n\\n\\t\\t\\t// Should encrypt this message.\\n\\t\\t\\treturn e2eRoom.encryptMessage(message);\\n\\t\\t});\\n\\n\\t\\tlistenersAttached = true;\\n\\t\\te2e.log('Listeners attached', listenersAttached);\\n\\t});\\n});\\n\",null],\"names\":[\"_regeneratorRuntime\",\"isE2EEPinnedMessage\",\"Meteor\",\"Tracker\",\"E2EEState\",\"e2e\",\"MentionsParser\",\"ChatRoom\",\"settings\",\"onClientBeforeSendMessage\",\"onClientMessageReceived\",\"isLayoutEmbedded\",\"waitUntilFind\",\"router\",\"module\",\"link\",\"default\",\"v\",\"startup\",\"autorun\",\"userId\",\"log\",\"window\",\"crypto\",\"error\",\"enabled\",\"get\",\"adminEmbedded\",\"getLocationPathname\",\"startsWith\",\"startClient\",\"setState\",\"DISABLED\",\"closeAlert\",\"offClientMessageReceived\",\"offClientBeforeSendMessage\",\"listenersAttached\",\"isReady\",\"_offClientMessageRece\",\"_offClientBeforeSendM\",\"use\",\"msg\",\"e2eRoom\",\"async\",\"_context\",\"prev\",\"next\",\"awrap\",\"getInstanceByRoomId\",\"rid\",\"sent\",\"shouldConvertReceivedMessages\",\"abrupt\",\"decryptPinnedMessage\",\"decryptMessage\",\"stop\",\"Promise\",\"message\",\"_Meteor$user\",\"me\",\"pattern\",\"useRealName\",\"mentions\",\"e2eMentions\",\"_context2\",\"findOne\",\"_id\",\"subscription\",\"encrypted\",\"resume\",\"pause\",\"shouldConvertSentMessages\",\"user\",\"username\",\"e2eUserMentions\",\"getUserMentions\",\"e2eChannelMentions\",\"getChannelMentions\",\"encryptMessage\"],\"mappings\":\"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\"}"}